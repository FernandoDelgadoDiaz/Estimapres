<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EstimaPres ¬∑ Pr√©stamos personales</title>

  <!-- √çcono: usa /assets/ping.png -->
  <link rel="icon" href="/assets/ping.png" />
  <link rel="apple-touch-icon" href="/assets/ping.png" />
  <link rel="manifest" href="manifest.webmanifest" />

  <style>
    :root{
      --brand:#0d5df3; --brand2:#1162ff;
      --ink:#0b1220; --muted:#6b7280;
      --ok:#16a34a; --warn:#eab308; --bad:#e11d48;
      --bg:#f6f7fb; --card:#fff; --shadow:0 10px 30px rgba(2,16,60,.08);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    a{color:inherit}
    .container{max-width:980px;margin:0 auto;padding:0 16px}

    /* ======= HERO ======= */
    .hero{
      background:radial-gradient(1200px 420px at 20% -10%,#4c7dff 0%,var(--brand) 44%,#073eb8 100%);
      color:#fff;
      padding:28px 0 22px;
      box-shadow:var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{width:54px;height:54px;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.18)}
    .brand h1{margin:0;font-size:44px;font-weight:800;letter-spacing:.3px}
    .slogan{display:inline-block;margin-top:10px;background:rgba(255,255,255,.16);padding:10px 16px;border-radius:14px;font-size:18px}
    .slogan em{font-style:normal;text-decoration:underline}
    .top-actions{margin-top:16px;display:flex;gap:14px;flex-wrap:wrap}
    .btn{
      appearance:none;border:0;cursor:pointer;
      padding:12px 18px;border-radius:14px;font-size:16px;font-weight:600;
      display:inline-flex;align-items:center;gap:10px;box-shadow:0 6px 16px rgba(0,0,0,.08)
    }
    .btn-outline{background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.3)}
    .btn-plain{background:rgba(255,255,255,.12);color:#fff}
    .btn-danger{background:#ff4b6a;color:#fff}

    /* ======= CARDS ======= */
    .card{background:var(--card);border-radius:var(--r);padding:22px;margin:22px 0;box-shadow:var(--shadow)}
    .card h2{margin:0 0 12px;font-size:40px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .field{display:flex;flex-direction:column;gap:8px}
    .input{width:100%;border:1px solid #e5e7eb;border-radius:14px;padding:14px 16px;font-size:18px}
    .input:focus{border-color:#c7d2fe;box-shadow:0 0 0 4px rgba(59,130,246,.12)}
    .muted{color:var(--muted)} .note{font-size:14px;color:var(--muted)}
    .cta{background:var(--ok);color:#fff}
    .cta-danger{background:var(--bad);color:#fff}
    .cta-secondary{background:#0b1220;color:#fff}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    thead th{font-size:14px;color:#596173;text-align:left;border-bottom:1px solid #eef2ff;padding:10px}
    tbody td{padding:12px 10px;border-bottom:1px solid #f1f5f9;font-size:16px}
    .right{text-align:right}.center{text-align:center}.hidden{display:none}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;font-size:13px;font-weight:700}
    .chip-green{background:#dcfce7;color:#065f46}
    .chip-yellow{background:#fef9c3;color:#854d0e}
    .chip-gray{background:#eef2ff;color:#4338ca}
    .sep{height:1px;background:#eef2ff;margin:14px 0}
    .badge{display:inline-block;padding:6px 10px;border-radius:10px;background:#ecfeff;color:#075985;font-weight:700;font-size:13px}

    @media (max-width:720px){
      .brand h1{font-size:36px}
      .brand img{width:46px;height:46px;border-radius:10px}
      .row{grid-template-columns:1fr}
      .card h2{font-size:34px}
    }
  </style>
</head>
<body>
  <!-- ======================== HERO ======================== -->
  <header class="hero">
    <div class="container">
      <div class="brand">
        <!-- √çcono cerdito EXACTAMENTE antes de la ‚ÄúE‚Äù -->
        <img src="/assets/ping.png" alt="EstimaPres" />
        <h1>EstimaPres</h1>
      </div>
      <div class="slogan">Pr√©stamos personales ¬∑ <em>simple y claro</em></div>
      <div class="top-actions">
        <button id="btnOpenMyLoan" class="btn btn-outline">üîé Ver mi pr√©stamo</button>
        <button id="btnAdmin" class="btn btn-plain">üõ°Ô∏è Admin</button>
        <button id="btnLogout" class="btn btn-danger hidden">‚Ü™ Salir</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- =================== SIMULADOR =================== -->
    <section class="card">
      <h2>Simulador</h2>
      <div class="row">
        <div class="field"><label class="muted">Monto</label><input id="inpAmount" class="input" inputmode="numeric" placeholder="$ 1.000.000" /></div>
        <div class="field"><label class="muted">Meses</label><input id="inpMonths" class="input" inputmode="numeric" placeholder="Ej: 12" /></div>
      </div>
      <div class="note" style="margin-top:10px">TNA vigente: <b id="lblTna">‚Äî%</b> ¬∑ Vencimiento: d√≠a <b id="lblDue">‚Äî</b></div>
      <div style="margin-top:14px"><button id="btnSim" class="btn cta">Simular</button></div>
      <div id="simResult" class="hidden">
        <div class="sep"></div>
        <table>
          <thead><tr><th>#</th><th>Vencimiento</th><th class="right">Cuota</th><th class="center">Estado</th></tr></thead>
          <tbody id="simRows"></tbody>
        </table>
        <div class="note" style="margin-top:8px">* No se muestra el total, s√≥lo el detalle de cuotas.</div>
      </div>
    </section>

    <!-- =================== SOLICITUD =================== -->
    <section class="card">
      <h2>Solicitar pr√©stamo</h2>
      <div class="row">
        <div class="field"><label class="muted">Tu nombre</label><input id="fName" class="input" placeholder="Juan P√©rez" /></div>
        <div class="field"><label class="muted">DNI</label><input id="fDni" class="input" inputmode="numeric" placeholder="30123456" /></div>
        <div class="field"><label class="muted">Email</label><input id="fEmail" class="input" placeholder="tucorreo@mail.com" /></div>
        <div class="field"><label class="muted">Tel√©fono</label><input id="fPhone" class="input" placeholder="11 2345 6789" /></div>
        <div class="field" style="grid-column:1 / -1"><label class="muted">alias o CBU/CVU</label><input id="fCbu" class="input" placeholder="alias o CBU/CVU" /></div>
      </div>
      <div style="margin-top:14px"><button id="btnApply" class="btn cta">Enviar solicitud</button></div>
      <div class="note" style="margin-top:8px">Al enviar acept√°s ser contactado por EstimaPres.</div>
    </section>

    <!-- =================== ADMIN =================== -->
    <section id="adminArea" class="hidden">
      <div class="card">
        <h2>Panel administrador</h2>
        <div class="row">
          <input id="admTna" class="input" placeholder="150" />
          <button id="btnSaveTna" class="btn cta-secondary">Guardar TNA</button>
        </div>
      </div>

      <div class="card">
        <div class="section-title">Solicitudes pendientes</div>
        <button id="btnReloadPend" class="btn">Recargar</button>
        <div id="listPend" class="note" style="margin-top:8px">Sin pendientes</div>
      </div>

      <div class="card">
        <div class="section-title">Preaprobados</div>
        <button id="btnReloadPre" class="btn">Recargar</button>
        <div id="listPre" class="note" style="margin-top:8px">Sin preaprobados</div>
      </div>

      <div class="card">
        <div class="section-title">Activos</div>
        <button id="btnReloadAct" class="btn">Recargar</button>
        <div id="listAct" class="note" style="margin-top:8px">Sin activos</div>
      </div>

      <div class="card">
        <div class="section-title">Inactivos (finalizados / incobrables)</div>
        <div class="row" style="grid-template-columns:auto auto auto">
          <button id="btnShowFinished" class="btn">Cancelados</button>
          <button id="btnShowCharged" class="btn">Incobrables</button>
          <button id="btnReloadInac" class="btn">Recargar</button>
        </div>
        <div id="listInac" class="note" style="margin-top:8px">Sin inactivos</div>
      </div>
    </section>

    <!-- =================== MI PR√âSTAMO =================== -->
    <section class="card">
      <h2>Ver mi pr√©stamo</h2>
      <div class="row">
        <input id="myDni" class="input" placeholder="Ingres√° tu DNI" />
        <button id="btnFindMyLoan" class="btn cta-secondary">Consultar</button>
      </div>
      <div id="myLoanResult" style="margin-top:12px"></div>
    </section>

    <div class="container" style="color:#64748b;font-size:12px;padding:30px 0 60px">
      <span class="badge">EstimaPres</span> ¬∑ ¬© <span id="yy"></span>
    </div>
  </main>

  <!-- =================== APP (Firebase v10 modular) =================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection,
      serverTimestamp, query, where, orderBy, limit, getDocs
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

    /* ========== PEG√Å TU CONFIG REAL AC√Å ========== */
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_PROYECTO.firebaseapp.com",
      projectId: "TU_PROYECTO",
      storageBucket: "TU_PROYECTO.appspot.com",
      messagingSenderId: "TU_SENDER_ID",
      appId: "TU_APP_ID"
    };
    /* ============================================= */

    const ADMIN_EMAILS = [
      "fernandogastondelgado81@gmail.com"  // ‚Üê admin habilitado
    ];

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    /* ===== Helpers ===== */
    const $ = s=>document.querySelector(s);
    const money = n => (isFinite(n)? new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n):'‚Äî');
    const onlyDigits = v => (v||'').toString().replace(/\D+/g,'');
    const ymd = d => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
    const addMonths = (d,m)=>{const x=new Date(d); x.setMonth(x.getMonth()+m); return x;};
    const nowTS = ()=> serverTimestamp();
    const toast = msg => alert(msg);

    const state = { tna:null, dueDay:10, user:null, isAdmin:false };
    $("#yy").textContent = new Date().getFullYear();

    /* ===== Auth & header ===== */
    $("#btnAdmin").onclick = async ()=>{
      if(!auth.currentUser){
        try{ await signInWithPopup(auth,provider); }catch{}
      }
    };
    $("#btnLogout").onclick = ()=> signOut(auth);
    $("#btnOpenMyLoan").onclick = ()=> { $("#myDni").focus(); $("#myDni").scrollIntoView({behavior:'smooth',block:'center'}); };

    onAuthStateChanged(auth, (u)=>{
      state.user = u||null;
      state.isAdmin = !!(u && ADMIN_EMAILS.includes((u.email||"").toLowerCase()));
      $("#btnLogout").classList.toggle("hidden", !u);
      $("#adminArea").classList.toggle("hidden", !state.isAdmin);
      if(state.isAdmin) loadAllAdmin();
    });

    /* ===== Settings (settings/global) ===== */
    async function loadSettings(){
      try{
        const s = await getDoc(doc(db,"settings","global"));
        if(s.exists()){
          const d = s.data();
          state.tna = Number(d.tna||0);
          state.dueDay = Number(d.dueDay||10);
        }else{
          state.tna = 0; state.dueDay = 10;
        }
      }catch{ state.tna = 0; state.dueDay = 10; }
      $("#lblTna").textContent = `${state.tna}%`;
      $("#lblDue").textContent = state.dueDay;
      $("#admTna").value = state.tna || "";
    }
    async function saveTna(){
      const v = Number(onlyDigits($("#admTna").value));
      if(!v){ toast("Ingres√° una TNA v√°lida."); return; }
      await setDoc(doc(db,"settings","global"), { tna:v, dueDay: state.dueDay||10, updatedAt: nowTS() }, {merge:true});
      state.tna = v; $("#lblTna").textContent = `${v}%`;
      toast("TNA actualizada.");
    }
    $("#btnSaveTna").onclick = saveTna;

    /* ===== Simulador ===== */
    function cuota(amt, months, tna){
      const A = Number(amt)||0, M = Math.max(1, Number(months)||0);
      const T = Number(tna); const r = (isFinite(T) && T>0) ? (T/100)/12 : 0;
      return r>0 ? (A*r)/(1-Math.pow(1+r,-M)) : (A/M);
    }
    $("#btnSim").onclick = ()=>{
      const amt = Number(onlyDigits($("#inpAmount").value));
      const months = Number(onlyDigits($("#inpMonths").value));
      if(!amt || !months){ toast("Ingres√° monto y meses."); return; }
      if(!isFinite(state.tna) || state.tna<=0){ toast("Configur√° la TNA desde Admin antes de simular."); return; }
      const pmt = cuota(amt, months, state.tna);
      const base = new Date(); base.setDate(state.dueDay||10);
      const tbody = $("#simRows"); tbody.innerHTML="";
      for(let i=1;i<=months;i++){
        const d = addMonths(base,i);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i}</td><td>${ymd(d)}</td><td class="right">${money(pmt)}</td><td class="center"><span class="chip chip-yellow">Pendiente</span></td>`;
        tbody.appendChild(tr);
      }
      $("#simResult").classList.remove("hidden");
    };

    /* ===== Solicitud ===== */
    $("#btnApply").onclick = async ()=>{
      const borrower = {
        name: $("#fName").value.trim(),
        dni:  onlyDigits($("#fDni").value),
        email:$("#fEmail").value.trim(),
        phone:$("#fPhone").value.trim(),
        cbu:  $("#fCbu").value.trim()
      };
      const amount = Number(onlyDigits($("#inpAmount").value));
      const months = Number(onlyDigits($("#inpMonths").value));
      if(!borrower.name || !borrower.dni || !borrower.email || !amount || !months){
        toast("Complet√° nombre, DNI, email, monto y meses."); return;
      }
      try{
        await addDoc(collection(db,"loans"),{
          amount, months, tna: state.tna||0, dueDay: state.dueDay||10,
          borrower, status:"pending", createdAt: nowTS(), updatedAt: nowTS()
        });
        toast("Solicitud enviada. ¬°Gracias!");
      }catch(e){ console.error(e); toast("No se pudo enviar la solicitud."); }
    };

    /* ===== Usuario: Ver mi pr√©stamo por DNI ===== */
    $("#btnFindMyLoan").onclick = async ()=>{
      const dni = onlyDigits($("#myDni").value);
      if(!dni){ $("#myLoanResult").innerHTML='<div class="note">Ingres√° tu DNI.</div>'; return; }
      $("#myLoanResult").innerHTML='<div class="note">Buscando‚Ä¶</div>';
      const q = await getDocs(query(collection(db,"loans"), orderBy("createdAt","desc"), limit(80)));
      const list = [];
      q.forEach(d=>{ const L=d.data(); if((L?.borrower?.dni||"")===dni) list.push({id:d.id,...L}); });
      if(!list.length){ $("#myLoanResult").innerHTML='<div class="note">No encontramos pr√©stamos activos o preaprobados para ese DNI.</div>'; return; }
      const L = list[0];
      const M = Math.max(1, Number(L.months)||0);
      const pmt = cuota(L.amount, M, L.tna);
      const base = new Date(); base.setDate(L.dueDay||10);
      let rows=""; const paid = Number(L.paidCount||0);
      for(let n=1;n<=M;n++){
        const d = addMonths(base,n);
        rows += `<tr>
          <td>${n}</td><td>${ymd(d)}</td><td class="right">${money(pmt)}</td>
          <td class="center">${n<=paid?'<span class="chip chip-green">Pagada</span>':'<span class="chip chip-yellow">Pendiente</span>'}</td>
        </tr>`;
      }
      $("#myLoanResult").innerHTML = `
        <div class="badge">Estado: ${L.status}</div>
        <div class="note" style="margin-top:6px">Monto: <b>${money(L.amount)}</b> ¬∑ Cuotas: <b>${L.months}</b> ¬∑ TNA: <b>${L.tna}%</b> ¬∑ Progreso: <b>${paid}/${M}</b></div>
        ${L?.contractPdf? `<div style="margin:10px 0"><a class="btn" href="${L.contractPdf}" target="_blank">Contrato PDF</a></div>`:''}
        <table><thead><tr><th>#</th><th>Vencimiento</th><th class="right">Cuota</th><th class="center">Estado</th></tr></thead><tbody>${rows}</tbody></table>`;
    };

    /* ===== Admin: listas y acciones ===== */
    async function loadPend(){
      const box=$("#listPend"); box.innerHTML="";
      try{
        const q = await getDocs(query(collection(db,"loans"), where("status","==","pending"), orderBy("createdAt","desc"), limit(50)));
        if(q.empty){ box.textContent="Sin pendientes"; return; }
        q.forEach(docx=>{
          const d=docx.data(), id=docx.id;
          const el=document.createElement("div"); el.className="card";
          el.innerHTML=`
            <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
              <div><b>${d.borrower?.name||"‚Äî"}</b> ¬∑ DNI ${d.borrower?.dni||"‚Äî"}
                <div class="note">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna||0}%</div>
              </div>
              <div class="row" style="grid-template-columns:auto auto">
                <button class="btn cta-secondary" data-pre>Preaprobar</button>
                <button class="btn cta-danger" data-del>Eliminar</button>
              </div>
            </div>`;
          el.querySelector('[data-pre]').onclick = async ()=>{
            if(!confirm("¬øPreaprobar y generar contrato (firma por link)?")) return;
            await updateDoc(doc(db,"loans",id), { status:"preapproved", signed:false, updatedAt: nowTS() });
            loadAllAdmin();
          };
          el.querySelector('[data-del]').onclick = async ()=>{
            if(!confirm("¬øEliminar solicitud?")) return;
            await updateDoc(doc(db,"loans",id), { status:"deleted", updatedAt: nowTS() });
            loadAllAdmin();
          };
          box.appendChild(el);
        });
      }catch(e){ box.textContent="No se pudieron leer las solicitudes (reglas/√≠ndices)."; }
    }

    async function loadPre(){
      const box=$("#listPre"); box.innerHTML="";
      try{
        const q = await getDocs(query(collection(db,"loans"), where("status","==","preapproved"), orderBy("updatedAt","desc"), limit(50)));
        if(q.empty){ box.textContent="Sin preaprobados"; return; }
        q.forEach(docx=>{
          const d=docx.data(), id=docx.id;
          const el=document.createElement("div"); el.className="card";
          el.innerHTML=`
            <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
              <div>
                <b>${d.borrower?.name||"‚Äî"}</b> ¬∑ DNI ${d.borrower?.dni||"‚Äî"} ¬∑
                <span class="chip ${d.signed?'chip-green':'chip-gray'}">${d.signed?'Firmado':'Esperando firma'}</span>
                <div class="note">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna||0}%</div>
              </div>
              <div class="row" style="grid-template-columns:auto auto">
                <button class="btn" data-share>Compartir contrato</button>
                <button class="btn cta-secondary" data-approve ${d.signed?'':'disabled'}>Aprobar y depositar</button>
              </div>
            </div>`;
          el.querySelector('[data-share]').onclick = ()=>{
            const url = `${location.origin}${location.pathname}#sign-${id}`;
            navigator.clipboard?.writeText(url);
            toast("Enlace de firma copiado. Pegalo en WhatsApp.");
          };
          el.querySelector('[data-approve]').onclick = async ()=>{
            if(!confirm("¬øAprobar y pasar a activo?")) return;
            await updateDoc(doc(db,"loans",id), { status:"active", activeAt: nowTS(), updatedAt: nowTS(), paidCount: Number(d.paidCount||0) });
            loadAllAdmin();
          };
          box.appendChild(el);
        });
      }catch{ box.textContent="No se pudo cargar preaprobados."; }
    }

    function cuotaTabla(L){ return cuota(L.amount, Math.max(1,Number(L.months)||0), L.tna); }
    function scheduleHTML(L,id){
      const months=Math.max(1,Number(L.months)||0), pmt=cuotaTabla(L), base=new Date(); base.setDate(L.dueDay||10);
      const paid=Number(L.paidCount||0);
      let rows=""; for(let n=1;n<=months;n++){ const d=addMonths(base,n);
        rows += `<tr>
          <td>${n}</td><td>${ymd(d)}</td><td class="right">${money(pmt)}</td>
          <td class="center">${n<=paid?'<span class="chip chip-green">Pagada</span>':'<span class="chip chip-yellow">Pendiente</span>'}</td>
          <td class="right">${n<=paid?'':`<button class="btn" data-n="${n}" data-id="${id}">Marcar pagada</button>`}</td>
        </tr>`;
      }
      return `<div class="sep"></div><table><thead><tr><th>#</th><th>Vencimiento</th><th class="right">Cuota</th><th class="center">Estado</th><th></th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    async function loadAct(){
      const box=$("#listAct"); box.innerHTML="";
      try{
        const q = await getDocs(query(collection(db,"loans"), where("status","==","active"), orderBy("activeAt","desc"), limit(50)));
        if(q.empty){ box.textContent="Sin activos"; return; }
        q.forEach(docx=>{
          const d=docx.data(), id=docx.id, months=Math.max(1,Number(d.months)||0), paid=Number(d.paidCount||0);
          const el=document.createElement("div"); el.className="card";
          el.innerHTML=`
            <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
              <div><span class="chip chip-green">Activo</span> <b>${d.borrower?.name||"‚Äî"}</b> ¬∑ DNI ${d.borrower?.dni||"‚Äî"}
                <div class="note">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}% ¬∑ Progreso <b>${paid}/${months}</b></div>
              </div>
              <div class="row" style="grid-template-columns:auto auto auto">
                <button class="btn" data-view>Ver cuotas</button>
                <button class="btn cta" data-finish>Pagado total</button>
                <button class="btn cta-danger" data-inc>Incobrables</button>
              </div>
            </div>
            <div class="hidden" id="sch-${id}"></div>`;
          el.querySelector('[data-view]').onclick=()=>{
            const host=$("#sch-"+id); host.classList.toggle("hidden");
            if(!host.innerHTML){
              host.innerHTML = scheduleHTML(d,id);
              host.querySelectorAll('button[data-n]').forEach(b=>{
                b.onclick = async ()=>{
                  const n = Number(b.getAttribute('data-n'));
                  await updateDoc(doc(db,"loans",id), { paidCount:n, updatedAt: nowTS() });
                  toast("Cuota marcada como pagada.");
                  loadAllAdmin();
                };
              });
            }
          };
          el.querySelector('[data-finish]').onclick=async()=>{
            if(!confirm("¬øMarcar como pagado total?")) return;
            await updateDoc(doc(db,"loans",id), { status:"finished", updatedAt: nowTS() });
            loadAllAdmin();
          };
          el.querySelector('[data-inc]').onclick=async()=>{
            if(!confirm("¬øPasar a incobrables?")) return;
            await updateDoc(doc(db,"loans",id), { status:"charged_off", updatedAt: nowTS() });
            loadAllAdmin();
          };
          box.appendChild(el);
        });
      }catch{ box.textContent="No se pudieron leer activos."; }
    }

    async function loadInac(kind="finished"){
      const box=$("#listInac"); box.innerHTML="";
      try{
        const q = await getDocs(query(collection(db,"loans"), where("status","==",kind), orderBy("updatedAt","desc"), limit(50)));
        if(q.empty){ box.textContent="Sin inactivos"; return; }
        q.forEach(docx=>{
          const d=docx.data(), el=document.createElement("div"); el.className="card";
          el.innerHTML=`<div>
            <span class="chip ${kind==='finished'?'chip-green':'chip-yellow'}">${kind}</span>
            <b>${d.borrower?.name||"‚Äî"}</b> ¬∑ DNI ${d.borrower?.dni||"‚Äî"}
            <div class="note">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}% ¬∑ Contrato ${d.contractId||'-'}</div>
          </div>`;
          box.appendChild(el);
        });
      }catch{ box.textContent="No se pudo cargar."; }
    }

    function loadAllAdmin(){ loadPend(); loadPre(); loadAct(); loadInac("finished"); }

    /* ===== Firma: hash #sign-<id> ===== */
    function openSign(id){
      const w=window.open("about:blank","_blank");
      const html = `<!doctype html><html lang="es"><meta charset="utf-8">
        <title>Firma de contrato</title>
        <style>
          @page{size:A4;margin:20mm}
          body{font-family:system-ui,Arial;margin:22px}
          .box{max-width:760px;margin:0 auto}
          textarea{width:100%;height:320px;border:1px solid #e5e7eb;border-radius:8px;padding:10px}
          input{padding:10px;border-radius:8px;border:1px solid #e5e7eb;width:100%}
          button{padding:10px 14px;border-radius:10px;background:#0b1220;color:#fff;font-weight:700}
        </style>
        <div class="box">
          <h2>Contrato EstimaPres</h2>
          <textarea>Contrato est√°ndar EstimaPres (formato A4 para imprimir)‚Ä¶</textarea>
          <div style="margin:10px 0"><input id="signName" placeholder="Nombre y apellido" /></div>
          <button id="btnAccept">Aceptar contrato</button>
        </div>
        <script>
          document.getElementById('btnAccept').onclick=()=>{
            const v=document.getElementById('signName').value.trim();
            if(!v){ alert('Escrib√≠ tu nombre y apellido'); return; }
            window.opener?.postMessage({type:'signed',id:'${id}',value:v},'*');
            alert('¬°Contrato aceptado!');
            close();
          };
        <\/script></html>`;
      w.document.write(html); w.document.close();
    }
    function tryOpenSignFromHash(){
      if(!location.hash.startsWith("#sign-")) return;
      const id = location.hash.replace("#sign-","").trim();
      if(id) openSign(id);
    }
    window.addEventListener("message", async (ev)=>{
      if(ev?.data?.type!=="signed") return;
      try{
        await updateDoc(doc(db,"loans",ev.data.id), { signed:true, signedName:ev.data.value, signedAt: nowTS(), updatedAt: nowTS() });
        alert("Firma registrada. Pod√©s aprobar desde el panel.");
        loadAllAdmin();
      }catch{ alert("No se pudo guardar la firma."); }
    });

    /* ===== Botones admin ===== */
    $("#btnReloadPend").onclick = loadPend;
    $("#btnReloadPre").onclick  = loadPre;
    $("#btnReloadAct").onclick  = loadAct;
    $("#btnReloadInac").onclick = ()=>loadInac("finished");
    $("#btnShowFinished").onclick = ()=>loadInac("finished");
    $("#btnShowCharged").onclick  = ()=>loadInac("charged_off");

    /* ===== Init ===== */
    window.addEventListener("load", async ()=>{
      await loadSettings();
      tryOpenSignFromHash();
    });
  </script>
</body>
</html>