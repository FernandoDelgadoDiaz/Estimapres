<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>EstimaPres</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--blue:#0b63f6;--green:#16a34a;--red:#dc2626;--amber:#d97706;--gray:#64748b;--bg:#f8fafc}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#0f172a}
  .nav{background:#0b4fc7;color:#fff;position:sticky;top:0;z-index:20}
  .container{max-width:960px;margin:0 auto;padding:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .btn{border:0;border-radius:10px;padding:10px 16px;font-weight:600;cursor:pointer}
  .btn-primary{background:var(--blue);color:#fff} .btn-outline{background:#fff;color:#0b4fc7;border:1px solid #c7d2fe}
  .btn-green{background:var(--green);color:#fff} .btn-red{background:var(--red);color:#fff}
  .btn-amber{background:var(--amber);color:#fff} .btn-ghost{background:#e2e8f0;color:#0f172a}
  .card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 4px 12px rgb(15 23 42 / 8%)}
  input,select{width:100%;padding:12px;border-radius:10px;border:1px solid #cbd5e1;background:#fff}
  label{font-size:.9rem;color:#334155;font-weight:600;margin-top:10px;display:block}
  h1{font-size:1.9rem;margin:14px 0 8px} h2{font-size:1.4rem;margin:18px 0 8px}
  small{color:var(--gray)} .hidden{display:none}
  table{width:100%;border-collapse:collapse;border-radius:10px;overflow:hidden;margin-top:8px}
  th,td{padding:8px;border-bottom:1px solid #e2e8f0;text-align:left}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.8rem;font-weight:700}
  .b-green{background:#dcfce7;color:#166534} .b-red{background:#fee2e2;color:#991b1b} .b-amber{background:#fef3c7;color:#92400e}
  .muted{color:#64748b}
  .list{display:grid;gap:10px}
  .tags{font-size:.9rem;color:#334155}
  a{color:#0b4fc7;text-decoration:none}
</style>
</head>
<body>

<!-- NAV -->
<div class="nav">
  <div class="container row" style="align-items:center;justify-content:space-between;">
    <div class="row" style="align-items:center;gap:10px">
      <div class="badge" style="background:#1e40af;color:#fff">E</div>
      <strong>EstimaPres</strong>
    </div>
    <div class="row">
      <button id="btnMyLoan" class="btn btn-outline">Ver mi pr√©stamo</button>
      <button id="btnAdmin" class="btn btn-outline">Admin</button>
      <button id="btnLogout" class="btn btn-outline hidden">Salir</button>
    </div>
  </div>
</div>

<div class="container" id="app">
  <!-- SIMULADOR + SOLICITUD -->
  <div class="card">
    <h1>Simulador (pesos argentinos)</h1>
    <div class="row">
      <div style="flex:1 1 220px">
        <label>Monto</label>
        <input id="inAmount" type="number" placeholder="Ej: 200000"/>
      </div>
      <div style="flex:1 1 140px">
        <label>Meses</label>
        <input id="inMonths" type="number" placeholder="Ej: 12"/>
      </div>
    </div>
    <p class="tags">TNA vigente: <b id="tnaLbl">‚Äî</b> ¬∑ Vencimiento: d√≠a <b id="dueDayLbl">10</b></p>
    <div class="row">
      <button id="btnSim" class="btn btn-green">Simular</button>
      <div id="simResult" class="tags"></div>
    </div>
    <hr style="margin:18px 0;border:0;border-top:1px solid #e2e8f0">
    <h2>Solicitar pr√©stamo</h2>
    <div class="row">
      <div style="flex:1 1 260px"><label>Tu nombre</label><input id="name"/></div>
      <div style="flex:1 1 160px"><label>DNI</label><input id="dni" inputmode="numeric"/></div>
    </div>
    <div class="row">
      <div style="flex:1 1 260px"><label>Email</label><input id="email" type="email"/></div>
      <div style="flex:1 1 200px"><label>Tel√©fono</label><input id="phone" inputmode="tel"/></div>
    </div>
    <div class="row">
      <div style="flex:1 1 260px"><label>alias o CBU/CVU</label><input id="cbu"/></div>
    </div>
    <div class="row">
      <button id="btnSend" class="btn btn-primary">Enviar solicitud</button>
    </div>
    <small>Al enviar acept√°s ser contactado por EstimaPres.</small>
  </div>

  <!-- FIRMA DE CONTRATO (modo p√∫blico con ?sign=XXXX) -->
  <div id="signBox" class="card hidden">
    <h1>Firma de contrato</h1>
    <p class="tags">Contrato N¬∞ <b id="signNo"></b> ‚Äî <span id="signNameBorrower"></span></p>
    <label>Escrib√≠ tu nombre y apellido para firmar</label>
    <input id="signNameInput" placeholder="Nombre y Apellido"/>
    <div class="row" style="margin-top:10px">
      <button id="btnAcceptContract" class="btn btn-primary">Contrato aceptado</button>
      <button id="btnContractPdf" class="btn btn-ghost">Descargar PDF</button>
    </div>
  </div>

  <!-- PANEL ADMIN -->
  <div id="adminPanel" class="card hidden">
    <h1>Panel administrador</h1>

    <!-- TNA -->
    <h2>TNA</h2>
    <div class="row">
      <div style="flex:1 1 auto"><input id="inTna"/></div>
      <button id="btnSaveTna" class="btn btn-primary">Guardar</button>
    </div>

    <!-- PENDIENTES -->
    <h2>Solicitudes pendientes</h2>
    <div class="row"><button id="btnReloadPending" class="btn btn-ghost">Recargar</button></div>
    <div id="pendingList" class="list"><div class="muted">Cargando‚Ä¶</div></div>

    <!-- PREAPROBADOS -->
    <h2>Preaprobados</h2>
    <div class="row"><button id="btnReloadPre" class="btn btn-ghost">Recargar</button></div>
    <div id="preList" class="list"><div class="muted">Cargando‚Ä¶</div></div>

    <!-- ACTIVOS -->
    <h2>Activos</h2>
    <p class="tags">‚Ä¢ <span class="badge b-green">Verde: al d√≠a</span> ‚Ä¢ <span class="badge b-amber">Amarillo: 6‚Äì10 d√≠as de mora</span> ‚Ä¢ <span class="badge b-red">Rojo: &gt;10 d√≠as</span></p>
    <div class="row"><button id="btnReloadActive" class="btn btn-ghost">Recargar</button></div>
    <div id="activeList" class="list"><div class="muted">Cargando‚Ä¶</div></div>

    <!-- INACTIVOS -->
    <h2>Inactivos (finalizados / incobrables)</h2>
    <div class="row">
      <button data-f="finished" class="btn btn-green btnFilterInact">Cancelados</button>
      <button data-f="charged_off" class="btn btn-red btnFilterInact">Incobrables</button>
      <button id="btnReloadInactive" class="btn btn-ghost">Recargar</button>
    </div>
    <div id="inactiveList" class="list"><div class="muted">Cargando‚Ä¶</div></div>
  </div>

  <!-- MODAL ‚ÄúVER MI PR√âSTAMO‚Äù -->
  <div id="myLoanBox" class="card hidden">
    <h1>Mi pr√©stamo</h1>
    <div id="myLoanBody"></div>
  </div>
</div>

<!-- jsPDF (PDF al vuelo, no sube a Storage) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<!-- Firebase v10 (modular) -->
<script type="module">
/*** 1) Firebase ***/
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, serverTimestamp,
  query, where, orderBy, limit, writeBatch
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/*  üëâ Usa tu config real. Si ya la ten√≠as, dej√° igual.  */
const firebaseConfig = {
  apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
  authDomain: "estimapres.firebaseapp.com",
  projectId: "estimapres",
  storageBucket: "estimapres.firebasestorage.app",
  messagingSenderId: "578516597437",
  appId: "1:578516597437:web:f59994b87729aa1cd655d4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/*** 2) Helpers UI ***/
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const money = n => n.toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
const toast = m => alert(m);
const today = () => new Date();
const monthRate = tna => (tna/100)/12;

/*** 3) Config / TNA ***/
let SETTINGS = { tna: 100, dueDay: 10 };
async function loadSettings(){
  const snap = await getDoc(doc(db,"settings","global"));
  if (snap.exists()){
    const d = snap.data();
    SETTINGS.tna = Number(d.tna||100);
    SETTINGS.dueDay = Number(d.dueDay||10);
  }
  $("#tnaLbl").textContent = SETTINGS.tna+"%";
  $("#dueDayLbl").textContent = SETTINGS.dueDay;
  $("#inTna").value = SETTINGS.tna;
}
$("#btnSaveTna").onclick = async ()=>{
  const v = Number($("#inTna").value||0);
  if(!v) return toast("Ingres√° una TNA v√°lida");
  await setDoc(doc(db,"settings","global"),{tna:v,updatedAt:serverTimestamp()},{merge:true});
  SETTINGS.tna = v; $("#tnaLbl").textContent = v+"%";
  toast("TNA actualizada");
};

/*** 4) Simulador (sin mostrar total) ***/
$("#btnSim").onclick = ()=>{
  const P = Number($("#inAmount").value||0);
  const n = Number($("#inMonths").value||0);
  if(!P||!n) return toast("Complet√° monto y meses");
  const i = monthRate(SETTINGS.tna);
  const cuota = Math.round(P * i / (1-Math.pow(1+i,-n)));
  $("#simResult").innerHTML = `Cuota estimada: <b>${money(cuota)}</b> (no incluye gastos)`;
};

/*** 5) Enviar solicitud ***/
$("#btnSend").onclick = async ()=>{
  const amount = Number($("#inAmount").value||0);
  const months = Number($("#inMonths").value||0);
  const borrower = {
    name: $("#name").value.trim(),
    dni: $("#dni").value.trim(),
    email: $("#email").value.trim(),
    phone: $("#phone").value.trim(),
    cbu: $("#cbu").value.trim()
  };
  if(!amount||!months||!borrower.name||!borrower.dni) return toast("Complet√° simulaci√≥n y tus datos");
  await addDoc(collection(db,"loans"),{
    status:"pending", createdAt:serverTimestamp(),
    amount, months, tna: SETTINGS.tna, dueDay: SETTINGS.dueDay, borrower
  });
  toast("Solicitud enviada. En 48 hs un administrador la revisar√°.");
};

/*** 6) Admin (whitelist por emails) ***/
let IS_ADMIN = false;
let ADMIN_EMAIL = "";
async function isWhitelisted(email){
  const snap = await getDoc(doc(db,"admins","admins"));
  const list = snap.exists() ? (snap.data().emails||[]) : [];
  return list.includes(email);
}
$("#btnAdmin").onclick = async ()=>{
  const email = prompt("Ingres√° tu email de administrador:");
  if(!email) return;
  if(await isWhitelisted(email)){
    IS_ADMIN = true; ADMIN_EMAIL = email;
    $("#btnLogout").classList.remove("hidden");
    $("#adminPanel").classList.remove("hidden");
    await loadSettings();
    await Promise.all([loadPending(), loadPre(), loadActive(), loadInactive()]);
    toast("Sesi√≥n iniciada como admin.");
  }else{
    toast("No est√°s autorizado.");
  }
};
$("#btnLogout").onclick = ()=>{
  IS_ADMIN=false; ADMIN_EMAIL=""; $("#adminPanel").classList.add("hidden");
  toast("Sesi√≥n cerrada.");
};

/*** 7) C√°lculo de cuotas y helpers de estado ***/
function buildSchedule(P,tna,n,startDay){
  const i = monthRate(tna);
  const cuota = Math.round(P * i / (1-Math.pow(1+i,-n)));
  const list = [];
  const base = new Date();
  for(let k=1;k<=n;k++){
    const d = new Date(base.getFullYear(), base.getMonth()+k, startDay);
    list.push({ n:k, amount:cuota, dueDate:d.getTime(), paidAt:null });
  }
  return list;
}
function semaforo(loan){
  // 0 verde si no hay mora; 1 amarillo 6-10; 2 rojo >10
  const next = loan.installments.find(x=>!x.paidAt);
  if(!next) return "green";
  const todayMid = new Date(); todayMid.setHours(0,0,0,0);
  const due = new Date(next.dueDate); due.setHours(0,0,0,0);
  const diff = Math.floor((todayMid-due)/(1000*60*60*24));
  if(diff<=0) return "green";
  if(diff<=10) return "amber";
  return "red";
}
const fmtDate = ts => {
  const d = new Date(ts); return String(d.getDate()).padStart(2,"0")+"/"+String(d.getMonth()+1).padStart(2,"0")+"/"+d.getFullYear();
};

/*** 8) Contrato (c√≥digo, link, PDF) ***/
function makeContractNo(){ return Math.random().toString(36).slice(2,10).toUpperCase(); }
function signLink(contractNo){
  const base = location.origin + location.pathname;
  return `${base}?sign=${contractNo}`;
}
function whatsappLink(msg){
  return `https://wa.me/?text=${encodeURIComponent(msg)}`;
}
function pdfContract(loan){
  const { jsPDF } = window.jspdf;
  const docp = new jsPDF();
  const L = loan;
  docp.setFontSize(14);
  docp.text("CONTRATO DE PR√âSTAMO",14,16);
  docp.setFontSize(11);
  docp.text(`Contrato N¬∞ ${L.contractNo}`,14,26);
  docp.text(`Solicitante: ${L.borrower.name} - DNI ${L.borrower.dni}`,14,34);
  docp.text(`Monto: ${money(L.amount)}  ¬∑  TNA: ${L.tna}%  ¬∑  Meses: ${L.months}`,14,42);
  docp.text(`Vencimiento de cuotas: d√≠a ${L.dueDay}`,14,50);
  let y=60;
  docp.text("Cronograma de cuotas:",14,y); y+=6;
  L.installments.forEach(it=>{
    docp.text(`#${String(it.n).padStart(2,"0")}  ${fmtDate(it.dueDate)}  ${money(it.amount)}`,16,y); y+=6;
    if(y>280){ docp.addPage(); y=20; }
  });
  if(L.signName) { y+=6; docp.text(`Firmado por: ${L.signName} (${fmtDate(L.signedAt)})`,14,y); }
  docp.save(`Contrato_${L.contractNo}.pdf`);
}

/*** 9) PENDIENTES ***/
async function loadPending(){
  const box = $("#pendingList"); box.innerHTML = `<div class="muted">Cargando...</div>`;
  try{
    const q = query(collection(db,"loans"), where("status","==","pending"), orderBy("createdAt","desc"), limit(100));
    const snap = await getDocs(q);
    if(snap.empty){ box.innerHTML = `<div class="muted">Sin pendientes</div>`; return; }
    box.innerHTML = "";
    snap.forEach(d=>{
      const l = {id:d.id, ...d.data()};
      const el = document.createElement("div"); el.className="card";
      el.innerHTML = `
        <div class="tags"><b>${l.borrower.name}</b> ¬∑ DNI ${l.borrower.dni}</div>
        <div class="tags">Principal ${money(l.amount)} ¬∑ ${l.months} cuotas ¬∑ TNA ${l.tna}%</div>
        <div class="row" style="margin-top:8px">
          <button class="btn btn-amber" data-act="pre" data-id="${l.id}">Generar contrato</button>
          <button class="btn btn-ghost" data-act="del" data-id="${l.id}">Eliminar</button>
        </div>`;
      box.appendChild(el);
    });
  }catch(e){ box.innerHTML = `<div class="muted">No se pudieron leer las solicitudes.</div>`; }
}
$("#btnReloadPending").onclick = loadPending;

async function actionPending(e){
  const b = e.target.closest("button"); if(!b||!b.dataset.act) return;
  const id = b.dataset.id; const ref = doc(db,"loans",id);
  const snap = await getDoc(ref); if(!snap.exists()) return;
  const l = snap.data();
  if(b.dataset.act==="del"){
    await updateDoc(ref,{status:"deleted",updatedAt:serverTimestamp()});
    await loadPending(); return;
  }
  if(b.dataset.act==="pre"){
    // Preaprobar => generar contrato + cuotas
    const contractNo = makeContractNo();
    const installments = buildSchedule(l.amount,l.tna,l.months,l.dueDay||SETTINGS.dueDay);
    const payload = {
      status:"preapproved", contractNo, installments, paidCount:0,
      updatedAt:serverTimestamp()
    };
    await updateDoc(ref,payload);
    const link = signLink(contractNo);
    const msg = `Hola ${l.borrower.name}. Te enviamos el contrato EstimaPres.\nContrato: ${contractNo}\nMonto: ${money(l.amount)}\nCuotas: ${l.months}\nTNA: ${l.tna}%\nFirm√° ac√°: ${link}`;
    const w = whatsappLink(msg);
    toast("Contrato generado. Se abrir√° WhatsApp para compartir.");
    open(w,"_blank");
    await loadPre(); await loadPending();
  }
}
$("#pendingList").addEventListener("click",actionPending);

/*** 10) PREAPROBADOS (espera de firma / firmados) ***/
async function loadPre(){
  const box = $("#preList"); box.innerHTML = `<div class="muted">Cargando...</div>`;
  try{
    const q = query(collection(db,"loans"), where("status","in",["preapproved","signed"]), orderBy("createdAt","desc"), limit(100));
    const snap = await getDocs(q);
    if(snap.empty){ box.innerHTML = `<div class="muted">Sin preaprobados</div>`; return; }
    box.innerHTML="";
    snap.forEach(d=>{
      const l = {id:d.id, ...d.data()};
      const signed = l.status==="signed";
      const el = document.createElement("div"); el.className="card";
      el.innerHTML = `
        <div class="tags"><b>${l.borrower.name}</b> ¬∑ DNI ${l.borrower.dni} ¬∑ Contrato <b>${l.contractNo}</b>
          ${signed?`¬∑ <span class="badge b-green">Firmado</span>`:`¬∑ <span class="badge b-amber">Esperando firma</span>`}
        </div>
        <div class="tags">Principal ${money(l.amount)} ¬∑ ${l.months} cuotas ¬∑ TNA ${l.tna}%</div>
        <div class="row" style="margin-top:8px">
          <button class="btn btn-ghost" data-act="share" data-id="${l.id}">Compartir contrato</button>
          <button class="btn btn-ghost" data-act="pdf" data-id="${l.id}">Contrato PDF</button>
          <button class="btn btn-primary" ${signed?"":"disabled"} data-act="approve" data-id="${l.id}">Aprobar & Depositar</button>
        </div>`;
      box.appendChild(el);
    });
  }catch(e){ box.innerHTML = `<div class="muted">No se pudo leer preaprobados.</div>`; }
}
$("#btnReloadPre").onclick = loadPre;

$("#preList").addEventListener("click", async (e)=>{
  const b = e.target.closest("button"); if(!b) return;
  const id = b.dataset.id; const ref = doc(db,"loans",id); const snap = await getDoc(ref);
  if(!snap.exists()) return; const l = {id:snap.id, ...snap.data()};
  if(b.dataset.act==="share"){
    const msg = `Contrato EstimaPres ${l.contractNo} ‚Äì ${l.borrower.name}\nFirm√° ac√°: ${signLink(l.contractNo)}`;
    open(whatsappLink(msg),"_blank");
  }
  if(b.dataset.act==="pdf"){ pdfContract(l); }
  if(b.dataset.act==="approve"){
    await updateDoc(ref,{status:"active",activeAt:serverTimestamp(),updatedAt:serverTimestamp()});
    toast("Aprobado y depositado.");
    await loadActive(); await loadPre();
  }
});

/*** 11) ACTIVOS (cuotas, marcar pagada, finalizar / incobrables) ***/
function scheduleHTML(l){
  return `
    <table>
      <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th><th></th></tr></thead>
      <tbody>
        ${l.installments.map(it=>`
          <tr>
            <td>${it.n}</td>
            <td>${fmtDate(it.dueDate)}</td>
            <td>${money(it.amount)}</td>
            <td>${it.paidAt?'<span class="badge b-green">Pagada</span>':'Pendiente'}</td>
            <td>${it.paidAt?'':`<button class="btn btn-ghost" data-act="pay" data-id="${l.id}" data-n="${it.n}">Marcar pagada</button>`}</td>
          </tr>`).join("")}
      </tbody>
    </table>`;
}
function activeCard(l){
  const color = semaforo(l);
  const chip = color==="green" ? "b-green" : color==="amber" ? "b-amber" : "b-red";
  const allPaid = l.installments.every(x=>x.paidAt);
  return `
    <div class="card">
      <div class="tags"><span class="badge ${chip}">Activo</span> <b>${l.borrower.name}</b> ¬∑ DNI ${l.borrower.dni}</div>
      <div class="tags">Principal ${money(l.amount)} ¬∑ ${l.months} cuotas ¬∑ TNA ${l.tna}%</div>
      <div class="row" style="margin-top:8px">
        <button class="btn btn-ghost" data-act="toggle" data-id="${l.id}">Ver cuotas</button>
        <button class="btn btn-green" ${allPaid?'':'disabled'} data-act="finish" data-id="${l.id}">Pagado total</button>
        <button class="btn btn-red" data-act="inc" data-id="${l.id}">A incobrables</button>
      </div>
      <div id="sch-${l.id}" class="hidden" style="margin-top:8px">${scheduleHTML(l)}</div>
    </div>`;
}
async function loadActive(){
  const box=$("#activeList"); box.innerHTML=`<div class="muted">Cargando‚Ä¶</div>`;
  try{
    const q = query(collection(db,"loans"), where("status","==","active"), orderBy("activeAt","desc"), limit(100));
    const snap = await getDocs(q); if(snap.empty){ box.innerHTML=`<div class="muted">Sin activos</div>`; return; }
    box.innerHTML=""; snap.forEach(d=>{ const l={id:d.id,...d.data()}; const card=document.createElement("div"); card.innerHTML=activeCard(l); box.appendChild(card.firstElementChild); });
  }catch(e){ box.innerHTML=`<div class="muted">No se pudieron leer activos.</div>`; }
}
$("#btnReloadActive").onclick = loadActive;

$("#activeList").addEventListener("click", async (e)=>{
  const b = e.target.closest("button"); if(!b) return;
  const id = b.dataset.id; const act = b.dataset.act;
  const ref = doc(db,"loans",id); const snap = await getDoc(ref); if(!snap.exists()) return; const l={id:snap.id,...snap.data()};
  if(act==="toggle"){ $("#sch-"+id).classList.toggle("hidden"); return; }
  if(act==="pay"){
    const n = Number(b.dataset.n);
    const list = l.installments.map(it=> it.n===n ? {...it, paidAt: Date.now()} : it);
    const paidCount = list.filter(x=>x.paidAt).length;
    await updateDoc(ref,{installments:list,paidCount,updatedAt:serverTimestamp()});
    await loadActive(); return;
  }
  if(act==="finish"){
    if(!l.installments.every(x=>x.paidAt)) return toast("A√∫n hay cuotas pendientes.");
    await updateDoc(ref,{status:"finished",updatedAt:serverTimestamp()});
    await Promise.all([loadActive(), loadInactive()]);
  }
  if(act==="inc"){
    await updateDoc(ref,{status:"charged_off",updatedAt:serverTimestamp()});
    await Promise.all([loadActive(), loadInactive()]);
  }
});

/*** 12) INACTIVOS (filtro) ***/
let INACT_FILTER="finished";
async function loadInactive(){
  const box=$("#inactiveList"); box.innerHTML=`<div class="muted">Cargando‚Ä¶</div>`;
  try{
    const q = query(collection(db,"loans"), where("status","==",INACT_FILTER), orderBy("updatedAt","desc"), limit(100));
    const snap = await getDocs(q); if(snap.empty){ box.innerHTML=`<div class="muted">Sin inactivos</div>`; return; }
    box.innerHTML="";
    snap.forEach(d=>{
      const l={id:d.id,...d.data()};
      const badge = INACT_FILTER==="finished" ? `<span class="badge b-green">cancelado</span>` : `<span class="badge b-red">incobrable</span>`;
      const el=document.createElement("div"); el.className="card";
      el.innerHTML = `
        <div class="tags">${badge} <b>${l.borrower.name}</b> ¬∑ DNI ${l.borrower.dni}</div>
        <div class="tags">Principal ${money(l.amount)} ¬∑ ${l.months} cuotas ¬∑ TNA ${l.tna}% ¬∑ Contrato ${l.contractNo||'-'}</div>`;
      box.appendChild(el);
    });
  }catch(e){ box.innerHTML=`<div class="muted">No se pudieron leer inactivos.</div>`; }
}
$("#btnReloadInactive").onclick = loadInactive;
$$(".btnFilterInact").forEach(b=>b.onclick = async ()=>{ INACT_FILTER=b.dataset.f; await loadInactive(); });

/*** 13) Ver mi pr√©stamo (usuario por DNI) ***/
$("#btnMyLoan").onclick = async ()=>{
  const dni = prompt("Ingres√° tu DNI para consultar tu pr√©stamo:"); if(!dni) return;
  const q = query(collection(db,"loans"), orderBy("createdAt","desc"), limit(200));
  const snap = await getDocs(q);
  const list=[]; snap.forEach(d=>{ const l={id:d.id,...d.data()}; if(l.borrower?.dni==dni) list.push(l); });
  if(!list.length) return toast("No encontramos pr√©stamos para ese DNI.");
  const l = list[0];
  const el=$("#myLoanBody");
  const cuotas = `
    <table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead>
    <tbody>${(l.installments||[]).map(it=>`
      <tr><td>${it.n}</td><td>${fmtDate(it.dueDate)}</td><td>${money(it.amount)}</td>
      <td>${it.paidAt?'<span class="badge b-green">Pagada</span>':'Pendiente'}</td></tr>`).join("")}</tbody>
    </table>`;
  el.innerHTML = `
    <div class="tags"><b>Estado:</b> ${l.status} ¬∑ <b>Monto:</b> ${money(l.amount)} ¬∑ <b>Cuotas:</b> ${l.months} ¬∑ <b>TNA:</b> ${l.tna}%</div>
    <div class="row"><button id="btnPdfUser" class="btn btn-ghost">Contrato PDF</button></div>
    ${cuotas}`;
  $("#myLoanBox").classList.remove("hidden");
  $("#btnPdfUser").onclick = ()=> pdfContract(l);
};

/*** 14) Firma p√∫blica (?sign=XXXX) ***/
async function checkSignMode(){
  const u = new URL(location.href);
  const code = u.searchParams.get("sign"); if(!code) return;
  // buscar por contractNo
  const q = query(collection(db,"loans"), where("contractNo","==",code), limit(1));
  const snap = await getDocs(q);
  if(snap.empty){ toast("Contrato no encontrado."); return; }
  const d=snap.docs[0]; const l={id:d.id,...d.data()};
  $("#signBox").classList.remove("hidden");
  $("#signNo").textContent = l.contractNo;
  $("#signNameBorrower").textContent = `${l.borrower.name} ‚Äî DNI ${l.borrower.dni}`;
  $("#btnContractPdf").onclick = ()=> pdfContract(l);
  $("#btnAcceptContract").onclick = async ()=>{
    const name = $("#signNameInput").value.trim();
    if(!name) return toast("Escrib√≠ tu nombre y apellido para firmar.");
    await updateDoc(doc(db,"loans",l.id),{status:"signed",signName:name,signedAt:Date.now(),updatedAt:serverTimestamp()});
    toast("Contrato firmado. ¬°Gracias!");
  };
}

/*** 15) Boot ***/
await loadSettings();
checkSignMode();

</script>
</body>
</html>