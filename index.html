<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EstimaPres ¬∑ Pr√©stamos en ARS</title>
  <meta name="theme-color" content="#0f3d7a" />
  <style>
    :root{--primary:#0f3d7a;--primary-2:#113b6a;--bg:#f4f6fb;--card:#ffffff;--ok:#14805e;--warn:#b68a00;--err:#c03b38}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;color:#111;background:var(--bg)}
    header{background:var(--primary);color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:5}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:20px}
    .brand-badge{width:34px;height:34px;border-radius:8px;background:#e9f0ff;color:#0f3d7a;display:grid;place-items:center;font-weight:900}
    .btn{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#e9eef9;color:#223} .btn.light{background:#f1f3f9;color:#111}
    .btn.ok{background:var(--ok)} .btn.warn{background:#efb400} .btn.err{background:var(--err)}
    .btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.3)}
    .container{max-width:980px;margin:16px auto;padding:0 14px}
    .card{background:var(--card);border-radius:16px;padding:18px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    h2{margin:0 0 10px;font-size:22px} h3{margin:16px 0 10px;font-size:18px}
    label{font-weight:700;font-size:14px;margin-bottom:6px;display:block}
    input,select{width:100%;padding:12px;border-radius:10px;border:1px solid #d7dbe6;background:#fff;font-size:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .muted{color:#5b6378} .err{color:var(--err);font-weight:700}
    table{border-collapse:collapse;width:100%;overflow:auto}
    th,td{border-bottom:1px solid #eceff6;padding:10px;text-align:left;font-size:14px}
    th{background:#f7f9ff;font-weight:800}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .pill.green{background:#eaf8f0;color:#106e4e} .pill.yellow{background:#fff7df;color:#8a6a00} .pill.red{background:#fdeeee;color:#a12522}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .hidden{display:none}
    .accordion{border-radius:16px;overflow:hidden}
    .ac-h{background:#fff;padding:16px 18px;cursor:pointer;border-bottom:1px solid #eef2fb;display:flex;align-items:center;gap:10px}
    .ac-h strong{font-size:18px} .ac-c{padding:0 18px 16px;background:#fff}
    .badge{width:12px;height:12px;border-radius:999px;background:#c5cde1}
    .b-green{background:#26c281} .b-yellow{background:#ffc31a} .b-red{background:#ff3b30}
    .kpi{font-weight:800}
    @media (max-width:720px){.row,.row3{grid-template-columns:1fr}}
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="brand-badge">E</div>
    <div>EstimaPres</div>
  </div>
  <div class="flex">
    <button class="btn ghost" id="btn-user-loan">Ver mi pr√©stamo</button>
    <button class="btn secondary" id="btn-admin">Admin</button>
    <button class="btn secondary hidden" id="btn-logout">Salir</button>
  </div>
</header>

<div class="container">

  <!-- SIMULADOR -->
  <div class="card">
    <h2>Simulador (pesos argentinos)</h2>
    <div class="row">
      <div>
        <label>Monto (ARS)</label>
        <input id="monto" type="number" min="1" placeholder="Ej: 200000" />
      </div>
      <div>
        <label>Cuotas (meses)</label>
        <input id="meses" type="number" min="1" placeholder="Ej: 12" />
      </div>
    </div>
    <p class="muted" id="tnaLabel">TNA vigente: ‚Äî% ¬∑ Vencimiento: d√≠a 10</p>
    <div class="flex">
      <button class="btn" id="btn-simular">Simular</button>
      <div class="pill" id="sim-pill" style="display:none"></div>
    </div>

    <div id="sim-res" class="card" style="margin:16px 0 0;display:none">
      <h3>Cuota estimada: <span id="sim-cuota">$ ‚Äî</span></h3>
      <div class="muted">Detalle cuota por cuota</div>
      <div style="overflow:auto"><table id="sim-tabla"></table></div>
    </div>

    <h3 style="margin-top:16px">Solicitar pr√©stamo</h3>
    <div class="row">
      <div>
        <label>Nombre y apellido</label>
        <input id="in-nombre" placeholder="Tu nombre" />
      </div>
      <div>
        <label>DNI</label>
        <input id="in-dni" placeholder="30123456" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Email</label>
        <input id="in-email" placeholder="tucorreo@dominio.com" />
      </div>
      <div>
        <label>Celular</label>
        <input id="in-phone" placeholder="11 2345 6789" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>CBU / CVU o Alias (dep√≥sito)</label>
        <input id="in-cbu" placeholder="alias o CBU/CVU" />
      </div>
      <div class="flex" style="align-items:flex-end">
        <button class="btn" id="btn-solicitar">Enviar solicitud</button>
        <span class="muted">Al enviar, un administrador la revisar√° en &lt; 48 h.</span>
      </div>
    </div>
  </div>

  <!-- MI PR√âSTAMO (usuario) -->
  <div class="card">
    <h2>Mi pr√©stamo</h2>
    <div class="row">
      <div>
        <label>DNI</label>
        <input id="my-dni" placeholder="Tu DNI" />
      </div>
      <div>
        <label>C√≥digo de firma (OTP de 6 d√≠gitos)</label>
        <input id="my-otp" placeholder="######" maxlength="6" />
      </div>
    </div>
    <div class="flex" style="margin-top:10px">
      <button class="btn light" id="btn-ver-mi">Ver mi pr√©stamo</button>
    </div>
    <div id="my-loan-box" class="card hidden">
      <div id="my-loan-head"></div>
      <div style="overflow:auto"><table id="my-loan-table"></table></div>
    </div>
  </div>

  <!-- PANEL ADMIN -->
  <div id="admin-panel" class="hidden">

    <!-- ACCORDE√ìN -->
    <div class="accordion card">

      <!-- 1) TNA -->
      <div class="ac-h" data-ac="ac-tna"><strong>1) Tasa centralizada (TNA %)</strong></div>
      <div id="ac-tna" class="ac-c hidden">
        <div class="row">
          <div>
            <label>TNA actual (%)</label>
            <input id="tna-input" type="number" step="0.01" />
          </div>
          <div class="flex" style="align-items:flex-end">
            <button class="btn" id="btn-save-tna">Guardar</button>
            <span class="muted">Impacta en el simulador; los pr√©stamos conservan la TNA al aprobar.</span>
          </div>
        </div>
      </div>

      <!-- 2) Solicitudes -->
      <div class="ac-h" data-ac="ac-req"><strong>2) Solicitudes pendientes</strong></div>
      <div id="ac-req" class="ac-c hidden">
        <div id="requestsList" class="muted">Cargando‚Ä¶</div>
      </div>

      <!-- 3) Preaprobados -->
      <div class="ac-h" data-ac="ac-pre"><strong>3) Preaprobados (Contrato / Firma OTP / Dep√≥sito)</strong></div>
      <div id="ac-pre" class="ac-c hidden">
        <div id="preList" class="muted">Cargando‚Ä¶</div>
      </div>

      <!-- 4) Pr√©stamos -->
      <div class="ac-h" data-ac="ac-live"><strong>4) Pr√©stamos</strong></div>
      <div id="ac-live" class="ac-c hidden">
        <h3>Activos (agrupados por sem√°foro)</h3>
        <div id="live-green"></div>
        <div id="live-yellow"></div>
        <div id="live-red"></div>
        <h3 style="margin-top:16px">Finalizados (pagados)</h3>
        <div id="live-finished"></div>
        <h3 style="margin-top:16px">Incobrables</h3>
        <div id="live-charged"></div>
        <div id="loan-detail" class="card hidden"></div>
      </div>

    </div>
  </div>
</div>

<!-- SDKs Firebase (compat) + jsPDF -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* --------- Firebase config (tu proyecto) --------- */
firebase.initializeApp({
  apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
  authDomain: "estimapres.firebaseapp.com",
  projectId: "estimapres",
  storageBucket: "estimapres.firebasestorage.app",
  messagingSenderId: "578516597437",
  appId: "1:578516597437:web:f59994b87729aa1cd655d4"
});
const db   = firebase.firestore();
const auth = firebase.auth();
</script><script>
/* ============== UTILIDADES ============== */
const $ = s => document.querySelector(s);
const fmtARS = n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Math.round(n||0));
const today = () => new Date();
const serverTs = firebase.firestore.FieldValue.serverTimestamp;

function nextDay10(d=new Date()){
  const x = new Date(d.getFullYear(), d.getMonth(), 10, 12, 0, 0, 0);
  if (d.getDate() >= 10) x.setMonth(x.getMonth()+1);
  return x;
}
function addMonths(d, m){ const x = new Date(d); x.setMonth(x.getMonth()+m); return x; }

function frenchSchedule(P, n, tna){
  const i = (tna/100)/12;
  const cuota = i>0 ? P * (i / (1 - Math.pow(1+i, -n))) : P/n;
  const start = nextDay10(today());
  const rows = [];
  let saldo = P;
  for(let k=1;k<=n;k++){
    const interes = saldo * i;
    const capital = cuota - interes;
    saldo = Math.max(0, saldo - capital);
    rows.push({
      k, due: addMonths(start, k-1).toISOString(),
      cuota: Math.round(cuota), capital: Math.round(capital),
      interes: Math.round(interes), paid: false, paidAt: null
    });
  }
  return {cuota: Math.round(cuota), rows};
}

function semaforo(schedule, status){
  if (status === 'charged_off') return 'red';
  const now = today();
  let overdueMax = 0;
  for(const r of schedule){
    if(!r.paid){
      const due = new Date(r.due);
      const diff = Math.floor((now - due)/(1000*60*60*24)); // d√≠as
      overdueMax = Math.max(overdueMax, diff);
    }
  }
  if (overdueMax <= 0) return 'green';
  if (overdueMax <= 10) return 'yellow';
  return 'red';
}
const badge = c => c==='green'?'üü¢':c==='yellow'?'üü°':'üî¥';

/* ============== SIMULADOR ============== */
let currentTNA = 100;
async function loadTNA(){
  const doc = await db.collection('settings').doc('general').get();
  const tna = (doc.exists && typeof doc.data().tna === 'number') ? doc.data().tna : 100;
  currentTNA = tna;
  $('#tnaLabel').textContent = `TNA vigente: ${tna}% ¬∑ Vencimiento: d√≠a 10`;
  $('#tna-input').value = tna;
}
loadTNA();

$('#btn-simular').onclick = () => {
  const P = parseFloat($('#monto').value||'0');
  const n = parseInt($('#meses').value||'0',10);
  if(!P || !n){ alert('Ingres√° monto y meses'); return; }
  const sim = frenchSchedule(P, n, currentTNA);
  $('#sim-cuota').textContent = fmtARS(sim.cuota);
  const t = $('#sim-tabla'); t.innerHTML='';
  const head = `<tr><th>#</th><th>Vencimiento</th><th>Cuota</th></tr>`;
  let body = '';
  for(const r of sim.rows){
    const d = new Date(r.due); const dS = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
    body += `<tr><td>${r.k}</td><td>${dS}</td><td>${fmtARS(r.cuota)}</td></tr>`;
  }
  t.innerHTML = head + body;
  $('#sim-res').style.display='block';
  $('#sim-pill').style.display='inline-flex'; $('#sim-pill').className='pill'; $('#sim-pill').textContent='Sistema franc√©s ¬∑ Valores orientativos';
};

/* Enviar solicitud (con validaci√≥n de campos obligatorios) */
$('#btn-solicitar').onclick = async () => {
  const P = parseFloat($('#monto').value||'0');
  const n = parseInt($('#meses').value||'0',10);
  if(!P || !n){ alert('Primero simul√°: monto y meses.'); return; }

  const name = $('#in-nombre').value.trim();
  const dni  = $('#in-dni').value.trim();
  const email= $('#in-email').value.trim();
  const phone= $('#in-phone').value.trim();
  const cbu  = $('#in-cbu').value.trim();

  if(!name || !dni || !email || !phone || !cbu){
    alert('Complet√° TODOS los campos (nombre, DNI, email, celular y CBU/Alias).');
    return;
  }

  const sim = frenchSchedule(P, n, currentTNA);

  await db.collection('loan_requests').add({
    amount:P, months:n, installment:sim.cuota, tna:currentTNA,
    borrower:{name, dni, email, phone, cbu},
    createdAt: serverTs(), status:'pending'
  });
  alert('¬°Solicitud enviada! Un administrador la revisar√° dentro de 48 h.');
};

/* ============== VER MI PR√âSTAMO (usuario con DNI + OTP) ============== */
$('#btn-ver-mi').onclick = async () => {
  const dni = $('#my-dni').value.trim();
  const otp = $('#my-otp').value.trim();
  if(!dni || !otp){ alert('Ingres√° DNI y OTP.'); return; }

  const q = await db.collection('public_loans').where('borrower.dni','==',dni).get();
  let found = null;
  q.forEach(doc => { const L=doc.data(); if((L.otp||'')===otp) found = {id:doc.id, ...L}; });

  const box = $('#my-loan-box'), head=$('#my-loan-head'), tab=$('#my-loan-table');
  if(!found){ box.classList.add('hidden'); alert('No se encontr√≥ pr√©stamo para ese DNI/OTP.'); return; }

  const color = semaforo(found.schedule, found.status);
  head.innerHTML = `<div style="font-weight:800">${badge(color)} ${found.borrower.name} ¬∑ DNI ${found.borrower.dni}</div>
  <div class="muted">Principal ${fmtARS(found.principal)} ¬∑ ${found.months} cuotas ¬∑ TNA ${found.tna}%</div>`;
  let h = `<tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Capital</th><th>Inter√©s</th><th>Estado</th></tr>`;
  let b = '';
  for(const r of found.schedule){
    const d=new Date(r.due), ds=`${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
    b += `<tr><td>${r.k}</td><td>${ds}</td><td>${fmtARS(r.cuota)}</td><td>${fmtARS(r.capital)}</td><td>${fmtARS(r.interes)}</td><td>${r.paid?'Pagada':'Pendiente'}</td></tr>`;
  }
  tab.innerHTML = h+b;
  box.classList.remove('hidden');
};

/* ============== LOGIN ADMIN ============== */
const adminPanel = $('#admin-panel');
$('#btn-admin').onclick = async () => {
  const email = prompt('Email admin:');
  if(!email) return;
  const pass  = prompt('Password:');
  if(!pass) return;
  try{
    await auth.signInWithEmailAndPassword(email, pass);
  }catch(e){ alert('Login inv√°lido: '+e.message); }
};
$('#btn-logout').onclick = async () => { await auth.signOut(); };

auth.onAuthStateChanged(u=>{
  if(u){ adminPanel.classList.remove('hidden'); $('#btn-logout').classList.remove('hidden'); }
  else { adminPanel.classList.add('hidden'); $('#btn-logout').classList.add('hidden'); }
});

/* ============== TNA guardar ============== */
$('#btn-save-tna').onclick = async ()=>{
  const t = parseFloat($('#tna-input').value||'0'); if(!t){alert('TNA inv√°lida');return;}
  await db.collection('settings').doc('general').set({tna:t},{merge:true});
  currentTNA = t; $('#tnaLabel').textContent = `TNA vigente: ${t}% ¬∑ Vencimiento: d√≠a 10`;
  alert('TNA actualizada');
};

/* ============== Acordeones ============== */
document.querySelectorAll('.ac-h').forEach(h=>{
  h.addEventListener('click', ()=>{
    const id = h.getAttribute('data-ac'); const c = document.getElementById(id);
    c.classList.toggle('hidden');
  });
});

/* ============== SOLICITUDES ‚Äî listener en tiempo real (sin orderBy) ============== */
function cardReq(id, r){
  const d = document.createElement('div');
  d.className='card';
  const cuota = fmtARS(r.installment);
  d.innerHTML = `
    <div style="font-weight:800">${r.borrower.name} ¬∑ DNI ${r.borrower.dni}</div>
    <div class="muted">\$ ${r.amount.toLocaleString('es-AR')} ¬∑ ${r.months} cuotas ¬∑ TNA ${r.tna}% ¬∑ Cuota ${cuota}</div>
    <div class="muted">${r.borrower.email} ¬∑ ${r.borrower.phone}</div>
    <div class="flex" style="margin-top:10px">
      <button class="btn ok"   data-ok="${id}">Preaprobar</button>
      <button class="btn err"  data-ko="${id}">Rechazar</button>
    </div>`;
  return d;
}

let unsubReq = null;
async function loadRequests(){
  const box = $('#requestsList');
  box.innerHTML = 'Cargando‚Ä¶';
  if (unsubReq) { unsubReq(); unsubReq=null; }

  unsubReq = db.collection('loan_requests').onSnapshot(snap=>{
    const arr=[];
    snap.forEach(doc=>{
      const r = doc.data()||{};
      const st=(r.status||'pending').toLowerCase();
      if(st==='pending'||st==='new') arr.push({id:doc.id,r});
    });
    arr.sort((a,b)=>(b.r.createdAt?.toMillis?.()||0)-(a.r.createdAt?.toMillis?.()||0));
    box.innerHTML='';
    if(!arr.length){ box.textContent='Sin solicitudes pendientes'; return; }
    arr.forEach(it=>box.appendChild(cardReq(it.id,it.r)));
    box.querySelectorAll('[data-ok]').forEach(b=>{
      b.onclick = async () => {
        const id=b.getAttribute('data-ok');
        const rd = await db.collection('loan_requests').doc(id).get();
        if(!rd.exists){ alert('La solicitud ya no existe'); return; }
        await approveRequest(id, rd.data());
      };
    });
    box.querySelectorAll('[data-ko]').forEach(b=>{
      b.onclick = async () => { const id=b.getAttribute('data-ko'); await rejectRequest(id); };
    });
  }, err=>{ box.innerHTML=`<span class="err">Error: ${err.message}</span>`; });
}
loadRequests();

/* ============== PREAPROBAR / RECHAZAR ============== */
function randOTP(){ return (''+Math.floor(100000+Math.random()*900000)); }

async function approveRequest(id, r){
  const otp = randOTP();
  const sim = frenchSchedule(r.amount, r.months, r.tna);
  await db.collection('preapproved_loans').doc(id).set({
    ...r,
    principal:r.amount, schedule: sim.rows, months:r.months, tna:r.tna,
    otp, status:'preapproved', installment:sim.cuota, createdAt: serverTs(),
    signed:false, deposited:false
  });
  await db.collection('loan_requests').doc(id).delete();
  alert('Preaprobado creado. OTP: '+otp);
}

async function rejectRequest(id){
  await db.collection('loan_requests').doc(id).delete();
  alert('Solicitud rechazada');
}

/* Listar PREAPROBADOS */
let unsubPre=null;
function preCard(id, L){
  const d = document.createElement('div'); d.className='card';
  d.innerHTML = `
   <div style="font-weight:800">${L.borrower.name} ¬∑ DNI ${L.borrower.dni}</div>
   <div class="muted">Principal ${fmtARS(L.principal)} ¬∑ ${L.months} cuotas ¬∑ TNA ${L.tna}% ¬∑ OTP ${L.otp}</div>
   <div class="flex" style="margin-top:8px">
     <button class="btn light" data-contract="${id}">Contrato PDF</button>
     <button class="btn ok" data-sign="${id}">${L.signed?'Firmado':'Marcar firmado OTP'}</button>
     <button class="btn warn" data-dep="${id}">${L.deposited?'Depositado':'Registrar dep√≥sito'}</button>
     <button class="btn" data-approve="${id}">Aprobar</button>
     <button class="btn err right" data-cancel="${id}">Cancelar</button>
   </div>`;
  return d;
}
async function genContractPDF(L){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(14); doc.text("CONTRATO DE MUTUO ‚Äî EstimaPres", 14, 18);
  doc.setFontSize(10);
  doc.text(`Prestatario: ${L.borrower.name} (DNI ${L.borrower.dni}) ‚Äî Email ${L.borrower.email}`,14,26);
  doc.text(`Capital: ${fmtARS(L.principal)} ‚Äî Plazo: ${L.months} meses (franc√©s) ‚Äî TNA: ${L.tna}%`,14,32);
  doc.text(`OTP de aceptaci√≥n: ${L.otp}`,14,38);
  doc.text(`Anexo ‚Äî Cronograma`,14,46);
  let y=52;
  doc.setFont("courier","normal");
  doc.text(`#  VENC        CUOTA    CAP.     INT.    ESTADO`,14,y); y+=6;
  L.schedule.forEach(r=>{
    const d=new Date(r.due); const ds=`${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
    const line = `${r.k.toString().padStart(2,' ')} ${ds.padEnd(10,' ')} ${fmtARS(r.cuota).padStart(9,' ')} ${fmtARS(r.capital).padStart(9,' ')} ${fmtARS(r.interes).padStart(9,' ')}  ${r.paid?'Pagada':'Pendiente'}`;
    if(y>280){ doc.addPage(); y=20; }
    doc.text(line,14,y); y+=6;
  });
  doc.save(`Contrato_EstimaPres_${L.borrower.dni}.pdf`);
}

function loadPre(){
  const box=$('#preList'); box.innerHTML='Cargando‚Ä¶';
  if(unsubPre){unsubPre();unsubPre=null;}
  unsubPre = db.collection('preapproved_loans').onSnapshot(snap=>{
    const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
    box.innerHTML=''; if(!arr.length){box.textContent='Sin preaprobados'; return;}
    arr.sort((a,b)=>(b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0));
    arr.forEach(L=>box.appendChild(preCard(L.id,L)));

    box.querySelectorAll('[data-contract]').forEach(b=>b.onclick=async()=>{ const id=b.getAttribute('data-contract'); const d=await db.collection('preapproved_loans').doc(id).get(); if(d.exists) await genContractPDF(d.data()); });
    box.querySelectorAll('[data-sign]').forEach(b=>b.onclick=async()=>{ const id=b.getAttribute('data-sign'); await db.collection('preapproved_loans').doc(id).set({signed:true},{merge:true}); alert('Marcado como firmado'); });
    box.querySelectorAll('[data-dep]').forEach(b=>b.onclick=async()=>{ const id=b.getAttribute('data-dep'); const tx=prompt('ID/Referencia de dep√≥sito (opcional)'); await db.collection('preapproved_loans').doc(id).set({deposited:true, depositRef:tx||null},{merge:true}); alert('Dep√≥sito registrado'); });
    box.querySelectorAll('[data-approve]').forEach(b=>b.onclick=async()=>{
      const id=b.getAttribute('data-approve'); const d=await db.collection('preapproved_loans').doc(id).get(); if(!d.exists) return;
      const L=d.data(); if(!L.signed || !L.deposited){ alert('Falta firma OTP y/o dep√≥sito.'); return; }
      await db.collection('public_loans').add({
        borrower:L.borrower, principal:L.principal, months:L.months, tna:L.tna,
        otp:L.otp, schedule:L.schedule, status:'active', createdAt: serverTs(), installment:L.installment
      });
      await db.collection('preapproved_loans').doc(id).delete();
      alert('Pr√©stamo aprobado y movido a Activos.');
    });
    box.querySelectorAll('[data-cancel]').forEach(b=>b.onclick=async()=>{ const id=b.getAttribute('data-cancel'); await db.collection('preapproved_loans').doc(id).delete(); alert('Preaprobado eliminado'); });
  }, err=> box.innerHTML=`<span class="err">Error: ${err.message}</span>`);
}
loadPre();
</script><script>
/* ============== LISTAR PR√âSTAMOS ============== */
let unsubLive=null;

function cardLoan(id, L){
  const c = semaforo(L.schedule, L.status);
  const el = document.createElement('div'); el.className='card';
  el.innerHTML = `
   <div class="flex">
     <div class="badge ${c==='green'?'b-green':c==='yellow'?'b-yellow':'b-red'}"></div>
     <div style="font-weight:800">${L.borrower.name} ¬∑ DNI ${L.borrower.dni} ¬∑ <span class="muted">Estado: ${L.status}</span></div>
   </div>
   <div class="muted">Principal ${fmtARS(L.principal)} ¬∑ ${L.months} cuotas ¬∑ TNA ${L.tna}%</div>
   <div class="muted">Total ${fmtARS(L.schedule.reduce((s,r)=>s+r.cuota,0))} ¬∑ Pagado ${fmtARS(L.schedule.filter(x=>x.paid).reduce((s,r)=>s+r.cuota,0))} ¬∑ Restante ${fmtARS(L.schedule.filter(x=>!x.paid).reduce((s,r)=>s+r.cuota,0))}</div>
   <div class="flex" style="margin-top:8px">
     <button class="btn light" data-ver="${id}">Ver</button>
     ${L.status==='active'?`<button class="btn warn" data-charged="${id}">A incobrables</button>
     <button class="btn ok" data-finish="${id}">Finalizar</button>`:''}
     ${L.status==='charged_off'?`<button class="btn light" data-legal="${id}">PDF legal</button>`:''}
     <button class="btn err right" data-del="${id}">Eliminar</button>
   </div>`;
  return el;
}

function renderGroups(loans){
  const G = $('#live-green'), Y=$('#live-yellow'), R=$('#live-red'),
        F = $('#live-finished'), C=$('#live-charged');
  G.innerHTML=Y.innerHTML=R.innerHTML=F.innerHTML=C.innerHTML='';

  const act = loans.filter(l=>l.status==='active');
  act.sort((a,b)=> (b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0));
  for(const L of act){
    const c = semaforo(L.schedule, L.status);
    if(c==='green') G.appendChild(cardLoan(L.id,L));
    else if(c==='yellow') Y.appendChild(cardLoan(L.id,L));
    else R.appendChild(cardLoan(L.id,L));
  }

  const fin = loans.filter(l=>l.status==='finished'); fin.forEach(L=>F.appendChild(cardLoan(L.id,L)));
  const bad = loans.filter(l=>l.status==='charged_off'); bad.forEach(L=>C.appendChild(cardLoan(L.id,L)));

  // wire buttons
  document.querySelectorAll('[data-ver]').forEach(b=>b.onclick=()=>showDetail(b.getAttribute('data-ver'), loans));
  document.querySelectorAll('[data-charged]').forEach(b=>b.onclick=()=>moveStatus(b.getAttribute('data-charged'),'charged_off'));
  document.querySelectorAll('[data-finish]').forEach(b=>b.onclick=()=>moveStatus(b.getAttribute('data-finish'),'finished'));
  document.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>delLoan(b.getAttribute('data-del')));
  document.querySelectorAll('[data-legal]').forEach(b=>b.onclick=()=>genLegalPDF(loans.find(x=>x.id===b.getAttribute('data-legal'))));
}

function loadLive(){
  if(unsubLive){unsubLive();unsubLive=null;}
  unsubLive = db.collection('public_loans').onSnapshot(snap=>{
    const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
    renderGroups(arr);
  });
}
loadLive();

/* ============== DETALLE (con rojo forzado si charged_off) ============== */
async function showDetail(id, loans){
  const L = loans.find(x=>x.id===id); if(!L) return;
  const box = $('#loan-detail'); box.classList.remove('hidden'); box.innerHTML='';

  const color = L.status==='charged_off' ? 'red' : semaforo(L.schedule, L.status);
  const total = L.schedule.reduce((s,r)=>s+r.cuota,0);
  const pago  = L.schedule.filter(r=>r.paid).reduce((s,r)=>s+r.cuota,0);
  const rest  = total - pago;

  box.innerHTML = `
    <div style="font-weight:800">${badge(color)} ${L.borrower.name} ¬∑ DNI ${L.borrower.dni} ¬∑ <span class="muted">Estado: ${L.status}</span></div>
    <div class="muted">Principal ${fmtARS(L.principal)} ¬∑ ${L.months} cuotas ¬∑ TNA ${L.tna}%</div>
    <div class="muted">Total ${fmtARS(total)} ¬∑ Pagado ${fmtARS(pago)} ¬∑ Restante ${fmtARS(rest)}</div>
    <div style="overflow:auto"><table id="det-tab"></table></div>
  `;

  const t = $('#det-tab'); t.innerHTML='';
  let h=`<tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Capital</th><th>Inter√©s</th><th>Estado</th></tr>`;
  let b='';
  L.schedule.forEach((r,idx)=>{
    const d=new Date(r.due), ds=`${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
    const chk = `<input type="checkbox" data-pay="${id}" data-row="${idx}" ${r.paid?'checked':''} ${L.status!=='active'?'disabled':''} />`;
    b += `<tr><td>${r.k}</td><td>${ds}</td><td>${fmtARS(r.cuota)}</td><td>${fmtARS(r.capital)}</td><td>${fmtARS(r.interes)}</td><td>${chk} ${r.paid?'Pagada':'Pendiente'}</td></tr>`;
  });
  t.innerHTML=h+b;

  // toggles de pago
  t.querySelectorAll('[data-pay]').forEach(c=>{
    c.onchange = async ()=>{
      const row = parseInt(c.getAttribute('data-row'),10);
      const paid = c.checked;
      const ref = db.collection('public_loans').doc(id);
      const d = await ref.get(); if(!d.exists) return;
      const S = d.data().schedule; S[row].paid = paid; S[row].paidAt = paid? new Date().toISOString(): null;
      await ref.update({schedule:S});
      showDetail(id, [{id, ...d.data(), schedule:S}]); // refresco local
    };
  });
}

/* ============== MOVIMIENTOS / LEGAL / DELETE ============== */
async function moveStatus(id, to){
  const ref = db.collection('public_loans').doc(id);
  const d = await ref.get(); if(!d.exists) return;
  const L = d.data();
  if(to==='finished'){
    const todoPagado = L.schedule.every(x=>x.paid);
    if(!todoPagado && !confirm('Hay cuotas pendientes. Marcar como FINALIZADO igual?')) return;
  }
  if(to==='charged_off'){
    if(!confirm('Mover a INCOBRABLES?')) return;
  }
  await ref.update({status:to});
  alert('Estado actualizado');
}

async function delLoan(id){
  if(!confirm('Eliminar definitivamente este registro?')) return;
  await db.collection('public_loans').doc(id).delete();
  alert('Eliminado');
}

async function genLegalPDF(L){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(14); doc.text("GESTI√ìN LEGAL ‚Äî EstimaPres", 14, 18);
  doc.setFontSize(10);
  doc.text(`Deudor: ${L.borrower.name} (DNI ${L.borrower.dni}) ‚Äî Email ${L.borrower.email} ‚Äî Tel ${L.borrower.phone}`,14,26);
  doc.text(`Estado: ${L.status} ‚Äî OTP: ${L.otp}`,14,32);
  doc.text(`Capital: ${fmtARS(L.principal)} ‚Äî Plazo: ${L.months} meses ‚Äî TNA: ${L.tna}%`,14,38);
  const total = L.schedule.reduce((s,r)=>s+r.cuota,0);
  const pago  = L.schedule.filter(x=>x.paid).reduce((s,r)=>s+r.cuota,0);
  const rest  = total - pago;
  doc.text(`Total: ${fmtARS(total)} ‚Äî Pagado: ${fmtARS(pago)} ‚Äî Restante: ${fmtARS(rest)}`,14,44);

  let y=54; doc.setFont("courier","normal");
  doc.text(`#  VENC        CUOTA    CAP.     INT.    ESTADO`,14,y); y+=6;
  L.schedule.forEach(r=>{
    const d=new Date(r.due), ds=`${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
    const line = `${r.k.toString().padStart(2,' ')} ${ds.padEnd(10,' ')} ${fmtARS(r.cuota).padStart(9,' ')} ${fmtARS(r.capital).padStart(9,' ')} ${fmtARS(r.interes).padStart(9,' ')}  ${r.paid?'Pagada':'Pendiente'}`;
    if(y>280){ doc.addPage(); y=20; }
    doc.text(line,14,y); y+=6;
  });
  doc.save(`Legal_EstimaPres_${L.borrower.dni}.pdf`);
}

/* ============== BOTONES HEADER R√ÅPIDOS ============== */
$('#btn-user-loan').onclick = () => {
  window.scrollTo({top: document.body.scrollHeight*0.15, behavior:'smooth'});
  $('#my-dni').focus();
};
</script>

</body>
</html>
```Ó®Å0Ó®Ç