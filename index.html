<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
    <title>EstimaF ¬∑ Plataforma de Gesti√≥n Financiera Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>

    <style>
        :root {
            --brand-blue: #0e48c7;
            --brand-gradient: linear-gradient(135deg, #0e48c7 0%, #08215e 100%);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --glass: rgba(255, 255, 255, 0.98);
            --border: rgba(226, 232, 240, 0.8);
        }

        /* --- RESET Y BASE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #f1f5f9;
            color: #1e293b;
            min-height: 100vh;
        }

        .bg-gradient {
            position: fixed; top: 0; left: 0; right: 0; height: 350px;
            background: var(--brand-gradient);
            z-index: -1;
            border-radius: 0 0 50px 50px;
        }

        .container { max-width: 1000px; margin: 0 auto; padding: 20px 20px 100px; }

        /* --- COMPONENTES GLASS --- */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 35px;
            border: 1px solid white;
            box-shadow: 0 20px 40px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        /* --- TIPOGRAF√çA --- */
        h1 { color: white; font-weight: 800; font-size: 32px; letter-spacing: -1px; margin: 0; }
        h2, h3 { color: var(--brand-blue); font-weight: 800; margin-top: 0; }
        p.subtitle { color: rgba(255,255,255,0.8); font-size: 14px; margin: 5px 0 20px; }

        /* --- FORMULARIOS --- */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }

        .field { margin-bottom: 20px; }
        label { display: block; font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
        
        input, select {
            width: 100%; padding: 16px; border-radius: 16px; border: 1.5px solid #e2e8f0;
            background: #f8fafc; font-size: 15px; font-weight: 600; transition: all 0.3s ease;
        }
        input:focus { outline: none; border-color: var(--brand-blue); background: white; box-shadow: 0 0 0 4px rgba(14, 72, 199, 0.1); }

        /* --- BOTONES --- */
        .btn-main {
            width: 100%; background: var(--brand-blue); color: white; border: none; padding: 18px;
            border-radius: 20px; font-size: 16px; font-weight: 800; cursor: pointer;
            box-shadow: 0 10px 20px rgba(14, 72, 199, 0.3); transition: 0.3s;
        }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 15px 25px rgba(14, 72, 199, 0.4); }
        .btn-main:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; }

        .btn-sec {
            background: white; border: 1.5px solid #e2e8f0; padding: 10px 20px; border-radius: 14px;
            font-size: 13px; font-weight: 700; cursor: pointer; transition: 0.2s;
        }

        .btn-wa {
            background: #25d366; color: white; border: none; padding: 12px; border-radius: 15px;
            font-weight: 800; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        /* --- ELEMENTOS DE LISTA (DASHBOARD) --- */
        .loan-card {
            background: white; border-radius: 24px; padding: 25px; border: 1px solid #f1f5f9;
            margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }
        .status-badge {
            padding: 6px 12px; border-radius: 10px; font-size: 10px; font-weight: 800; text-transform: uppercase;
        }
        .status-pending { background: #fff7ed; color: #9a3412; }
        .status-signed { background: #eff6ff; color: #1e40af; }
        .status-active { background: #dcfce7; color: #166534; }

        /* --- TABLA DE CUOTAS --- */
        .quota-table { margin-top: 20px; border-top: 2px solid #f8fafc; }
        .quota-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; border-bottom: 1px solid #f8fafc;
        }
        .quota-num { font-weight: 800; color: #64748b; font-size: 13px; }
        .quota-val { font-weight: 700; color: #1e293b; }

        .hidden { display: none !important; }

        /* --- FIRMA BOX --- */
        .signature-box {
            border: 2px dashed #cbd5e1; border-radius: 20px; padding: 30px;
            text-align: center; background: #f8fafc; margin: 20px 0;
        }

        /* --- NOTIFICACIONES --- */
        #toast {
            position: fixed; bottom: 20px; right: 20px; padding: 15px 25px;
            border-radius: 15px; color: white; font-weight: 700; transform: translateY(100px);
            transition: 0.5s; z-index: 9999;
        }
    </style>
</head>
<body>

<div class="bg-gradient"></div>

<header class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>EstimaF</h1>
            <p class="subtitle">Gesti√≥n Inteligente de Cr√©ditos</p>
        </div>
        <div id="authHeader">
            <button id="btnStaff" class="btn-sec">Acceso Staff</button>
            <button id="btnLogout" class="btn-sec hidden" style="color:var(--danger)">Salir</button>
        </div>
    </div>
</header>

<main class="container">

    <div id="sectionClient">
        <div class="glass-card">
            <h3>üìä Simulador de Cuotas</h3>
            <div class="grid">
                <div class="field">
                    <label>Monto del Pr√©stamo</label>
                    <input type="number" id="simMonto" placeholder="Ej: 50000">
                </div>
                <div class="field">
                    <label>Plazo de Devoluci√≥n</label>
                    <select id="simCuotas">
                        <option value="6">6 Meses</option>
                        <option value="12" selected>12 Meses</option>
                        <option value="18">18 Meses</option>
                        <option value="24">24 Meses</option>
                    </select>
                </div>
            </div>
            <button id="btnCalcular" class="btn-main">Calcular Mi Cuota</button>
            <div id="simResult" class="hidden" style="margin-top: 25px; padding: 20px; background: #eff6ff; border-radius: 20px; text-align: center;">
                <label>Tu cuota fija mensual ser√° de:</label>
                <div id="valCuota" style="font-size: 32px; font-weight: 800; color: var(--brand-blue);"></div>
            </div>
        </div>

        <div class="glass-card">
            <h3>üìù Iniciar Solicitud</h3>
            <div class="field"><label>Nombre y Apellido</label><input id="cName" placeholder="Completo"></div>
            <div class="grid">
                <div class="field"><label>DNI (Sin puntos)</label><input id="cDni" type="number"></div>
                <div class="field"><label>WhatsApp (Cod. Area)</label><input id="cPhone" type="tel" placeholder="11..."></div>
            </div>
            <div class="field"><label>CBU / CVU / Alias</label><input id="cAlias" placeholder="Donde recibes el dinero"></div>
            <button id="btnEnviar" class="btn-main" style="background: var(--success);">Enviar Solicitud</button>
        </div>
    </div>

    <div id="sectionSign" class="hidden">
        <div class="glass-card">
            <h3>üñãÔ∏è Firma de Contrato Digital</h3>
            <div id="legalText" style="height: 250px; overflow-y: auto; background: #f8fafc; padding: 20px; border-radius: 15px; font-size: 13px; line-height: 1.6; border: 1px solid #e2e8f0;">
                </div>
            <div class="signature-box">
                <label>Escribe tu nombre completo para firmar electr√≥nicamente</label>
                <input id="signInput" style="text-align: center; font-family: 'Courier New', Courier, monospace; font-size: 24px;" placeholder="Tu Nombre Aqu√≠">
            </div>
            <button id="btnConfirmSign" class="btn-main">Firmar y Aceptar Pr√©stamo</button>
        </div>
    </div>

    <div id="sectionAdmin" class="hidden">
        <div class="glass-card">
            <h3>üì• Solicitudes Entrantes</h3>
            <div id="inboxList"></div>
        </div>
        <div class="glass-card">
            <h3>üöÄ Cartera Activa</h3>
            <div id="activeList"></div>
        </div>
    </div>

</main>

<div id="toast"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, doc, getDoc, getDocs, updateDoc, collection, query, where, orderBy, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // Configuraci√≥n Firebase (Original del usuario)
    const firebaseConfig = {
        apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
        authDomain: "estimapres.firebaseapp.com",
        projectId: "estimapres",
        storageBucket: "estimapres.firebasestorage.app",
        messagingSenderId: "578516597437",
        appId: "1:578516597437:web:f59994b87729aa1cd655d4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const ADMIN_MAIL = "fernandogastondelgado81@gmail.com";

    // --- UTILIDADES ---
    const $ = s => document.querySelector(s);
    const formatMoney = n => "$ " + Number(n).toLocaleString("es-AR");
    
    function showToast(msg, color = "#10b981") {
        const t = $("#toast");
        t.innerText = msg;
        t.style.background = color;
        t.style.transform = "translateY(0)";
        setTimeout(() => t.style.transform = "translateY(100px)", 3000);
    }

    // --- L√ìGICA FINANCIERA (ROBUSTA) ---
    function calcularCuotaMensual(monto, meses) {
        const TNA = 120; // 120% anual
        const i = (TNA / 100) / 12;
        const cuota = monto * (i * Math.pow(1 + i, meses)) / (Math.pow(1 + i, meses) - 1);
        return Math.round(cuota);
    }

    // --- MANEJO DE VISTAS Y RUTAS ---
    onAuthStateChanged(auth, user => {
        const h = window.location.hash;
        if (user && user.email === ADMIN_MAIL) {
            switchView("admin");
            loadAdminData();
        } else if (h.startsWith("#sign-")) {
            switchView("sign");
            setupSignatureView(h.replace("#sign-", ""));
        } else {
            switchView("client");
        }
    });

    function switchView(v) {
        $("#sectionClient").classList.toggle("hidden", v !== "client");
        $("#sectionAdmin").classList.toggle("hidden", v !== "admin");
        $("#sectionSign").classList.toggle("hidden", v !== "sign");
        $("#btnLogout").classList.toggle("hidden", v !== "admin");
        $("#btnStaff").classList.toggle("hidden", v === "admin");
    }

    // --- FUNCIONES DE CLIENTE ---
    $("#btnCalcular").onclick = () => {
        const m = $("#simMonto").value;
        const c = $("#simCuotas").value;
        if (!m) return showToast("Ingresa un monto", "#ef4444");
        const val = calcularCuotaMensual(m, c);
        $("#simResult").classList.remove("hidden");
        $("#valCuota").innerText = formatMoney(val);
    };

    $("#btnEnviar").onclick = async () => {
        const monto = $("#simMonto").value;
        const cuotas = $("#simCuotas").value;
        if (!monto || !$("#cName").value) return showToast("Faltan datos", "#ef4444");

        try {
            const data = {
                name: $("#cName").value,
                dni: $("#cDni").value,
                phone: $("#cPhone").value,
                alias: $("#cAlias").value,
                amount: Number(monto),
                months: Number(cuotas),
                installment: calcularCuotaMensual(monto, cuotas),
                status: "pending",
                createdAt: serverTimestamp()
            };
            await addDoc(collection(db, "loans"), data);
            showToast("Solicitud enviada con √©xito");
            setTimeout(() => location.reload(), 2000);
        } catch (e) { showToast("Error al enviar", "#ef4444"); }
    };

    // --- FUNCIONES DE FIRMA ---
    async function setupSignatureView(id) {
        const snap = await getDoc(doc(db, "loans", id));
        if (!snap.exists()) return;
        const d = snap.data();

        $("#legalText").innerHTML = `
            <strong>CONTRATO DE PR√âSTAMO DE DINERO (MUTUO)</strong><br><br>
            Entre ESTIMAF y el Sr/Sra <b>${d.name}</b>, DNI <b>${d.dni}</b>...<br>
            1. El prestador entrega la suma de ${formatMoney(d.amount)}.<br>
            2. La devoluci√≥n ser√° en ${d.months} cuotas de ${formatMoney(d.installment)}.<br>
            3. El vencimiento opera el d√≠a 10 de cada mes.<br>
            4. En caso de mora, se aplicar√°n intereses punitorios...
        `;

        $("#btnConfirmSign").onclick = async () => {
            const signature = $("#signInput").value;
            if (signature.length < 5) return showToast("Escribe tu nombre completo", "#ef4444");

            await updateDoc(doc(db, "loans", id), {
                status: "signed",
                signatureName: signature,
                signedAt: serverTimestamp()
            });
            showToast("Contrato Firmado Correctamente");
            window.location.hash = "";
            setTimeout(() => location.reload(), 2000);
        };
    }

    // --- FUNCIONES DE ADMIN (GESTI√ìN OCTAVIO) ---
    async function loadAdminData() {
        const q = query(collection(db, "loans"), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);
        $("#inboxList").innerHTML = "";
        $("#activeList").innerHTML = "";

        snap.forEach(docu => {
            const d = { id: docu.id, ...docu.data() };
            const link = window.location.origin + window.location.pathname + "#sign-" + d.id;

            const card = `
                <div class="loan-card">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <span class="status-badge status-${d.status}">${d.status}</span>
                            <div style="font-weight:800; font-size:18px; margin-top:5px;">${d.name}</div>
                            <div style="font-size:12px; color:#64748b;">DNI: ${d.dni} | Alias: ${d.alias}</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-weight:800; color:var(--brand-blue)">${formatMoney(d.amount)}</div>
                            <div style="font-size:11px;">${d.months} cuotas de ${formatMoney(d.installment)}</div>
                        </div>
                    </div>

                    <div style="margin-top:20px;">
                        ${d.status === 'pending' ? `
                            <button class="btn-wa" onclick="window.sendWhatsApp('${d.phone}', '${link}')">
                                Enviar Link de Firma
                            </button>
                            <button class="btn-sec" style="width:100%; margin-top:10px" onclick="window.updateStatus('${d.id}', 'rejected')">Rechazar</button>
                        ` : ''}

                        ${d.status === 'signed' ? `
                            <div style="background:#f0fdf4; padding:15px; border-radius:15px; margin-bottom:10px; font-size:12px;">
                                <b>Firmado por:</b> ${d.signatureName}
                            </div>
                            <button class="btn-main" onclick="window.activarPrestamo('${d.id}')">ACTIVAR Y ENTREGAR DINERO</button>
                        ` : ''}

                        ${d.status === 'active' ? renderCuotasDetalle(d) : ''}
                    </div>
                </div>
            `;

            if (d.status === 'active') $("#activeList").innerHTML += card;
            else $("#inboxList").innerHTML += card;
        });
    }

    function renderCuotasDetalle(d) {
        let rows = '<div class="quota-table">';
        for (let i = 1; i <= d.months; i++) {
            const pagada = (d.paidCount || 0) >= i;
            rows += `
                <div class="quota-row">
                    <span class="quota-num">CUOTA ${i}</span>
                    <span class="quota-val">${formatMoney(d.installment)}</span>
                    ${pagada ? '<span class="status-badge status-active">PAGADO</span>' : 
                    `<button class="btn-sec" style="padding:5px 10px" onclick="window.registrarPago('${d.id}', ${i})">Cobrar</button>`}
                </div>
            `;
        }
        return rows + '</div><button class="btn-sec" style="width:100%; margin-top:15px" onclick="window.generarPDF(\''+d.id+'\')">Descargar Contrato PDF</button>';
    }

    // --- ACCIONES WINDOW (ADMIN) ---
    window.sendWhatsApp = (phone, link) => {
        const msg = encodeURIComponent("Hola! Tu pr√©stamo en EstimaF ha sido preaprobado. Por favor, firma el contrato aqu√≠ para recibir el dinero: " + link);
        window.open(`https://wa.me/${phone}?text=${msg}`);
    };

    window.updateStatus = async (id, status) => {
        await updateDoc(doc(db, "loans", id), { status });
        loadAdminData();
    };

    window.activarPrestamo = async (id) => {
        if (!confirm("¬øYa transferiste el dinero al cliente?")) return;
        await updateDoc(doc(db, "loans", id), { status: "active", paidCount: 0, startDate: serverTimestamp() });
        showToast("Pr√©stamo Activado");
        loadAdminData();
    };

    window.registrarPago = async (id, n) => {
        await updateDoc(doc(db, "loans", id), { paidCount: n, lastPayment: serverTimestamp() });
        showToast("Pago registrado");
        loadAdminData();
    };

    window.generarPDF = async (id) => {
        const snap = await getDoc(doc(db, "loans", id));
        const d = snap.data();
        const { jsPDF } = window.jspdf;
        const docPDF = new jsPDF();
        
        docPDF.setFontSize(22); docPDF.text("EstimaF - Comprobante de Cr√©dito", 20, 30);
        docPDF.setFontSize(12);
        docPDF.text(`Cliente: ${d.name}`, 20, 50);
        docPDF.text(`DNI: ${d.dni}`, 20, 60);
        docPDF.text(`Monto Total: ${formatMoney(d.amount)}`, 20, 70);
        docPDF.text(`Plan: ${d.months} cuotas de ${formatMoney(d.installment)}`, 20, 80);
        docPDF.text(`Firma Digital: ${d.signatureName}`, 20, 100);
        docPDF.text(`ID Transacci√≥n: ${id}`, 20, 110);
        
        docPDF.save(`Contrato_${d.dni}.pdf`);
    };

    // --- AUTH STAFF ---
    $("#btnStaff").onclick = () => {
        const pass = prompt("Contrase√±a de Administrador:");
        if (pass) signInWithEmailAndPassword(auth, ADMIN_MAIL, pass).catch(() => showToast("Acceso Denegado", "#ef4444"));
    };
    $("#btnLogout").onclick = () => signOut(auth).then(() => location.reload());

</script>
</body>
</html>
