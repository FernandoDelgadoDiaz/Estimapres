<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<title>EstimaPres ¬∑ Pr√©stamos personales</title>
<link rel="icon" href="assets/ping.png" />
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-main: #f8fafc;
    --primary: #0e48c7;
    --primary-dark: #0a3aa1;
    --accent: #ff6b00; /* Toque Naranja X para resaltar */
    --card-bg: #ffffff;
    --text-main: #0f172a;
    --text-muted: #64748b;
    --success: #10b981;
    --danger: #ef4444;
    --radius: 24px;
  }

  * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
  
  body { 
    margin: 0; 
    background-color: var(--bg-main); 
    color: var(--text-main);
    line-height: 1.5;
  }

  /* HEADER MODERNO */
  .hero {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: #fff;
    padding: 30px 20px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  }

  .brand { display: flex; align-items: center; gap: 15px; }
  .brand img { 
    width: 50px; height: 50px; 
    border-radius: 14px; 
    background: #fff;
    padding: 5px;
    box-shadow: 0 8px 15px rgba(0,0,0,0.2);
  }
  .brand h1 { margin: 0; font-size: 32px; font-weight: 800; letter-spacing: -1px; }

  .slogan {
    margin-top: 15px;
    font-size: 14px;
    background: rgba(255,255,255,0.15);
    padding: 8px 16px;
    border-radius: 12px;
    display: inline-block;
    backdrop-filter: blur(5px);
  }

  .actions {
    margin-top: 20px;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }

  /* BOTONES */
  .btn {
    border: none;
    background: rgba(255,255,255,0.1);
    color: #fff;
    padding: 12px;
    border-radius: 16px;
    font-weight: 700;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    border: 1px solid rgba(255,255,255,0.1);
  }
  .btn:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }
  .btn.red { background: rgba(239, 68, 68, 0.2); color: #ff8a8a; border: 1px solid rgba(239, 68, 68, 0.3); }

  /* CONTENEDORES */
  .wrap { max-width: 800px; margin: 0 auto; padding: 20px 15px 100px; }
  
  .card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: 0 10px 30px rgba(2, 32, 71, 0.05);
    border: 1px solid rgba(226, 232, 240, 0.8);
  }

  .card h2 { 
    margin: 0 0 20px; 
    font-size: 24px; 
    font-weight: 800; 
    color: var(--primary);
  }

  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media (max-width: 600px) { .row { grid-template-columns: 1fr; } }

  label { font-size: 13px; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; display: block; }
  
  input, select {
    width: 100%;
    padding: 14px 18px;
    border-radius: 16px;
    border: 2px solid #f1f5f9;
    background: #f8fafc;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.2s;
  }
  input:focus { outline: none; border-color: var(--primary); background: #fff; }

  .cta {
    width: 100%;
    background: var(--primary);
    color: #fff;
    border: none;
    padding: 18px;
    border-radius: 18px;
    font-weight: 800;
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(14, 72, 199, 0.3);
    transition: 0.3s;
  }
  .cta:active { transform: translateY(2px); box-shadow: none; }

  /* TABLAS Y PILLS */
  .pill {
    padding: 6px 12px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 800;
    text-transform: uppercase;
  }
  .pill.ok { background: #dcfce7; color: #065f46; }
  .pill.warn { background: #ffedd5; color: #9a3412; }
  .pill.bad { background: #fee2e2; color: #991b1b; }

  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th { text-align: left; font-size: 12px; color: var(--text-muted); padding: 10px; border-bottom: 2px solid #f1f5f9; }
  td { padding: 12px 10px; font-size: 14px; border-bottom: 1px solid #f1f5f9; font-weight: 600; }

  .kpi {
    background: #eff6ff;
    padding: 15px;
    border-radius: 16px;
    color: var(--primary);
    font-weight: 800;
    text-align: center;
    font-size: 18px;
    margin-bottom: 15px;
  }

  details summary { cursor: pointer; padding: 10px 0; outline: none; }
  
  /* ADMIN BUTTONS */
  .btn-outline { border: 1px solid #e2e8f0; background: #fff; padding: 8px 12px; border-radius: 10px; font-weight: 700; cursor: pointer; }
  .btn-success { background: var(--success); color: #fff; border: none; padding: 10px 15px; border-radius: 12px; font-weight: 700; }
  .btn-danger { background: var(--danger); color: #fff; border: none; padding: 10px 15px; border-radius: 12px; font-weight: 700; }

</style>
</head>
<body>

<header class="hero">
  <div class="brand">
    <img src="assets/ping.png" alt="EstimaPres" />
    <h1>PresTar</h1>
  </div>
  <div class="slogan">Pr√©stamos personales ¬∑ <em>simple y claro</em></div>
  <div class="actions">
    <button id="btnOpenMyLoan" class="btn">üîé Ver mi pr√©stamo</button>
    <button id="btnAdmin" class="btn">üõ°Ô∏è Admin</button>
    <button id="btnResetPass" class="btn">üîë Reset</button>
    <button id="btnLogout" class="btn red">‚Ü™ Salir</button>
  </div>
</header>

<main class="wrap">

  <section class="card">
    <h2>Simulador</h2>
    <div class="row">
      <div>
        <label>Monto a solicitar</label>
        <input id="simAmount" inputmode="numeric" placeholder="$ 0" />
      </div>
      <div>
        <label>Plazo (meses)</label>
        <input id="simMonths" inputmode="numeric" placeholder="M√°x 24" />
      </div>
    </div>
    <div class="muted" style="margin-top:12px; font-size: 13px; color: var(--text-muted);">
      <span id="lblTna">TNA vigente: ‚Äî%</span> ¬∑ <span id="lblDue">Vencimiento: d√≠a ‚Äî</span>
    </div>
    <div style="margin-top:20px"><button id="btnSim" class="cta">Calcular Cuota</button></div>
    <div id="simResult"></div>
  </section>

  <section class="card">
    <h2>Solicitar pr√©stamo</h2>
    <div class="row">
      <div><label>Nombre y Apellido</label><input id="bName" placeholder="Como figura en DNI" /></div>
      <div><label>N√∫mero de DNI</label><input id="bDni" inputmode="numeric" placeholder="Sin puntos" /></div>
      <div><label>Correo Electr√≥nico</label><input id="bEmail" type="email" placeholder="ejemplo@mail.com" /></div>
      <div><label>Celular</label><input id="bPhone" inputmode="tel" placeholder="C√≥d. √°rea + n√∫mero" /></div>
      <div style="grid-column: 1 / -1;"><label>Alias o CBU/CVU de cobro</label><input id="bAlias" placeholder="Donde recibir√°s el dinero" /></div>
    </div>
    <p style="font-size: 12px; color: var(--text-muted); margin-top: 15px;">Al enviar esta solicitud, confirmas que los datos son correctos y aceptas ser contactado por nuestro equipo.</p>
    <button id="btnSendReq" class="cta" style="background: var(--accent); box-shadow: 0 8px 20px rgba(255, 107, 0, 0.3);">Enviar Solicitud</button>
  </section>

  <section id="admin" class="card" style="display:none; border-top: 5px solid var(--primary);">
    <h2>Panel de Gesti√≥n</h2>

    <details open class="card" style="padding:16px; border: 1px solid #eee;">
      <summary class="section-title">‚öôÔ∏è Configuraci√≥n Global</summary>
      <div class="row">
        <div><label>TNA % Anual</label><input id="cfgTna" inputmode="numeric" /></div>
        <div><label>D√≠a fijo de Venc.</label><input id="cfgDue" inputmode="numeric" /></div>
      </div>
      <div style="margin-top:15px"><button id="btnSaveCfg" class="btn-success" style="width:100%">Guardar Cambios</button></div>
    </details>

    <details class="card" style="padding:16px; border: 1px solid #eee;">
      <summary class="section-title">üì• Solicitudes Nuevas</summary>
      <div class="toolbar"><button id="btnReloadPend" class="btn-outline">üîÑ Actualizar</button></div>
      <div id="listPend"></div>
    </details>

    <details class="card" style="padding:16px; border: 1px solid #eee;">
      <summary class="section-title">üìë Preaprobados / Contratos</summary>
      <div class="toolbar"><button id="btnReloadPre" class="btn-outline">üîÑ Actualizar</button></div>
      <div id="listPre"></div>
    </details>

    <details open class="card" style="padding:16px; border: 1px solid #eee;">
      <summary class="section-title">üöÄ Pr√©stamos Activos</summary>
      <div class="toolbar"><button id="btnReloadAct" class="btn-outline">üîÑ Actualizar</button></div>
      <div id="listAct"></div>
    </details>

    <details class="card" style="padding:16px; border: 1px solid #eee;">
      <summary class="section-title">üìÅ Historial / Inactivos</summary>
      <div class="toolbar" style="margin-bottom:15px">
        <button id="btnTabPaid" class="btn-outline">Finalizados</button>
        <button id="btnTabCharged" class="btn-outline">Incobrables</button>
      </div>
      <div id="listInact"></div>
    </details>
  </section>

  <section id="myloan" class="card">
    <h2>Mi Estado</h2>
    <div class="row">
      <div><label>DNI del titular</label><input id="myDni" inputmode="numeric" placeholder="Ingres√° tu documento" /></div>
      <div style="align-self:end"><button id="btnFindMyLoan" class="cta">Consultar Ahora</button></div>
    </div>
    <div id="myLoanResult" style="margin-top:20px"></div>
  </section>

</main>

<script type="module">
/* ================ L√ìGICA ORIGINAL PRESERVADA ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
  authDomain: "estimapres.firebaseapp.com",
  projectId: "estimapres",
  storageBucket: "estimapres.firebasestorage.app",
  messagingSenderId: "578516597437",
  appId: "1:578516597437:web:f59994b87729aa1cd655d4"
};
const ADMIN_EMAIL = "fernandogastondelgado81@gmail.com";

const app   = initializeApp(firebaseConfig);
const auth  = getAuth(app);
const db    = getFirestore(app);

const $ = s => document.querySelector(s);
const fmtMoney = n => isNaN(n) ? "$ 0" : "$ " + Number(n).toLocaleString("es-AR");
const onlyDigits = v => (v||"").replace(/\D+/g,"");
const nowTS = () => serverTimestamp();

function annuityPayment(P, annualRate, m){
  const i = (annualRate/100)/12;
  if (i===0) return P/m;
  const a = i*Math.pow(1+i,m)/(Math.pow(1+i,m)-1);
  return P*a;
}

function scheduleRows(L){
  const due = L.dueDay||10, today=new Date(), rows=[];
  for(let k=1;k<=L.months;k++){
    const d=new Date(today.getFullYear(), today.getMonth()+k, 1);
    d.setDate(Math.min(due, 28));
    rows.push({n:k, due:d.toISOString().slice(0,10), amount:L.installment, paid:(L.paidCount||0)>=k});
  }
  return rows;
}
const daysLate = iso => Math.max(0, Math.floor((new Date()-new Date(iso))/(1000*60*60*24)));

let gSettings={tna:null,dueDay:null}; let gUser=null;
async function loadSettings(){
  const snap=await getDoc(doc(db,"settings","app"));
  if(snap.exists()) gSettings={...gSettings,...snap.data()};
  $("#lblTna").textContent="TNA vigente: "+(gSettings.tna??"‚Äî")+"%";
  $("#lblDue").textContent="Vencimiento: d√≠a "+(gSettings.dueDay??"‚Äî");
  $("#cfgTna").value=gSettings.tna??"";
  $("#cfgDue").value=gSettings.dueDay??"";
}

onAuthStateChanged(auth,(u)=>{
  gUser=u;
  $("#admin").style.display=(u&&u.email===ADMIN_EMAIL)?"":"none";
});

$("#btnAdmin").onclick=async()=>{
  if(!auth.currentUser){
    const email=prompt("Email de administrador:", ADMIN_EMAIL)||"";
    const pass =prompt("Contrase√±a:")||"";
    try{
      const {user}=await signInWithEmailAndPassword(auth,email,pass);
      if(user.email!==ADMIN_EMAIL){ alert("No ten√©s permisos."); await signOut(auth); return; }
      $("#admin").scrollIntoView({behavior:"smooth"});
    }catch{ alert("Error de acceso."); }
  }else{ $("#admin").scrollIntoView({behavior:"smooth"}); }
};

$("#btnLogout").onclick=async()=>{ try{await signOut(auth);}catch{} };
$("#btnResetPass").onclick = async () => {
  const email = prompt("Email admin:");
  if (email) {
    try { await sendPasswordResetEmail(auth, email); alert("Email enviado."); } catch (e) { alert("Error."); }
  }
};

$("#btnSim").onclick=()=>{
  const P=Number(onlyDigits($("#simAmount").value));
  const m=Math.min(24, Number(onlyDigits($("#simMonths").value)));
  if(!gSettings.tna||!gSettings.dueDay){ alert("Falta configuraci√≥n de Admin."); return; }
  if(!P||!m){ $("#simResult").innerHTML=""; return; }
  const c=Math.round(annuityPayment(P,gSettings.tna,m));
  const rows=[];
  for(let i=1;i<=m;i++){
    const d=new Date(); d.setMonth(d.getMonth()+i); d.setDate(Math.min(gSettings.dueDay,28));
    rows.push(`<tr><td>${i}</td><td>${d.toLocaleDateString("es-AR")}</td><td>${fmtMoney(c)}</td><td><span class="pill warn">Pendiente</span></td></tr>`);
  }
  $("#simResult").innerHTML =
    `<div class="card" style="margin-top:14px; background: #fafafa; border: 1px dashed #ccc;">
      <div class="kpi">Cuota mensual: ${fmtMoney(c)}</div>
      <table><thead><tr><th>#</th><th>Fecha</th><th>Monto</th><th>Estado</th></tr></thead>
      <tbody>${rows.join("")}</tbody></table>
    </div>`;
};

$("#btnSendReq").onclick=async()=>{
  const amount=Number(onlyDigits($("#simAmount").value));
  const months=Math.min(24, Number(onlyDigits($("#simMonths").value)));
  if(!amount||!months){ alert("Simul√° primero monto y meses."); return; }
  const borrower={
    name:($("#bName").value||"").trim(),
    dni:onlyDigits($("#bDni").value),
    email:($("#bEmail").value||"").trim(),
    phone:($("#bPhone").value||"").trim(),
    alias:($("#bAlias").value||"").trim()
  };
  if(!borrower.name||!borrower.dni){ alert("Nombre y DNI obligatorios."); return; }
  const d={status:"pending", amount, months, tna:gSettings.tna||0, dueDay:gSettings.dueDay||10, borrower, createdAt:nowTS(), updatedAt:nowTS()};
  await addDoc(collection(db,"loans"), d);
  alert("¬°Solicitud enviada correctamente!");
  location.reload();
};

function loanHeader(d){
  const b=d.borrower||{};
  // Validaci√≥n contra undefined
  const name = b.name || "Sin nombre";
  const dni = b.dni || "-";
  return `<div style="font-weight:800; color: var(--primary)">${name} ¬∑ DNI ${dni}</div>
          <div style="font-size:13px; color:var(--text-muted)">${fmtMoney(d.amount)} en ${d.months} cuotas (TNA ${d.tna}%)</div>`;
}

function loanCard(d,actions=""){
  return `<div class="card" style="padding:16px; margin:10px 0; border-left: 4px solid var(--primary)">${loanHeader(d)}<div class="toolbar" style="margin-top:10px">${actions}</div></div>`;
}

async function loadPend(){
  const box=$("#listPend"); box.innerHTML="Cargando...";
  try{
    const qs=await getDocs(query(collection(db,"loans"), where("status","==","pending"), orderBy("createdAt","desc"), limit(80)));
    box.innerHTML = qs.empty ? `<div class="muted">No hay solicitudes</div>` : "";
    qs.forEach(docu=>{
      const d={...docu.data(),id:docu.id};
      const ui=loanCard(d,`<button class="btn-success" data-pre="${d.id}">Preaprobar</button> <button class="btn-danger" data-del="${d.id}">Borrar</button>`);
      box.insertAdjacentHTML("beforeend",ui);
    });
    box.querySelectorAll("[data-pre]").forEach(btn=>btn.onclick=async()=>{
      const id=btn.getAttribute("data-pre");
      if(confirm("¬øGenerar contrato preaprobado?")){
        const contractId=Math.random().toString(36).slice(2,10).toUpperCase();
        await updateDoc(doc(db,"loans",id), {status:"preapproved",contractId,updatedAt:nowTS()},{merge:true});
        loadAllAdmin();
      }
    });
    box.querySelectorAll("[data-del]").forEach(btn=>btn.onclick=async()=>{
      const id=btn.getAttribute("data-del");
      if(confirm("¬øEliminar?")) { await updateDoc(doc(db,"loans",id), {status:"deleted",updatedAt:nowTS()},{merge:true}); loadAllAdmin(); }
    });
  }catch(e){ box.innerHTML="Error."; }
}

async function loadPre(){
  const box=$("#listPre"); box.innerHTML="";
  const qs=await getDocs(query(collection(db,"loans"), where("status","==","preapproved"), orderBy("createdAt","desc"), limit(100)));
  if(qs.empty) { box.innerHTML=`<div class="muted">Sin preaprobados</div>`; return; }
  qs.forEach(docu=>{
    const d={...docu.data(),id:docu.id};
    const signed=d.signed?`<span class="pill ok">FIRMADO</span>`:`<span class="pill warn">PEND. FIRMA</span>`;
    const actions=`<button class="btn-outline" data-share="${d.id}">üîó Link</button>
                   ${d.signed?`<button class="btn-success" data-approve="${d.id}">‚úÖ Activar</button>`:''}
                   <button class="btn-outline" data-open="${d.id}">üìÑ Ver</button>`;
    box.insertAdjacentHTML("beforeend", loanCard(d, signed+" "+actions));
  });
  box.querySelectorAll("[data-open]").forEach(b=>b.onclick=async()=>{
    const s=await getDoc(doc(db,"loans",b.getAttribute("data-open")));
    openContract({...s.data(),id:s.id},false);
  });
  box.querySelectorAll("[data-share]").forEach(b=>b.onclick=async()=>{
    const id=b.getAttribute("data-share");
    const link=location.origin+location.pathname+"#sign-"+id;
    prompt("Enlace de firma para el cliente:", link);
  });
  box.querySelectorAll("[data-approve]").forEach(b=>b.onclick=async()=>{
    const id=b.getAttribute("data-approve"); const s=await getDoc(doc(db,"loans",id));
    const L=s.data();
    const installment=Math.round(annuityPayment(L.amount,L.tna,L.months));
    await updateDoc(doc(db,"loans",id), {status:"active",activeAt:nowTS(),updatedAt:nowTS(),installment,paidCount:0},{merge:true});
    loadAllAdmin(); alert("¬°Pr√©stamo en marcha!");
  });
}

async function loadAct(){
  const box=$("#listAct"); box.innerHTML="";
  const qs=await getDocs(query(collection(db,"loans"), where("status","==","active"), orderBy("activeAt","desc"), limit(100)));
  if(qs.empty) { box.innerHTML=`<div class="muted">No hay activos</div>`; return; }
  qs.forEach(docu=>{
    const d={...docu.data(),id:docu.id};
    const actions=`<button class="btn-outline" data-cuotas="${d.id}">üìä Cuotas</button>
                   <button class="btn-success" data-paid="${d.id}" ${(d.paidCount||0)>=d.months?"":"disabled"}>Cerrar</button>
                   <button class="btn-danger" data-charge="${d.id}">Mora</button>`;
    box.insertAdjacentHTML("beforeend", loanCard(d, actions)+`<div id="sch-${d.id}" style="font-size:12px"></div>`);
  });
  box.querySelectorAll("[data-cuotas]").forEach(b=>b.onclick=async()=>{
    const id=b.getAttribute("data-cuotas"); const s=await getDoc(doc(db,"loans",id));
    const L={...s.data(),id};
    const rows=scheduleRows(L).map(r=>{
      const badge=r.paid?`<span class="pill ok">Pago</span>`:`<button class="btn-outline" style="padding:4px 8px" data-mark="${L.id}:${r.n}">Marcar Pago</button>`;
      return `<tr><td>${r.n}</td><td>${new Date(r.due).toLocaleDateString()}</td><td>${badge}</td></tr>`;
    }).join("");
    $(`#sch-${id}`).innerHTML=`<table>${rows}</table>`;
    $(`#sch-${id}`).querySelectorAll("[data-mark]").forEach(btn=>btn.onclick=async()=>{
      const [loanId,n]=btn.getAttribute("data-mark").split(":");
      const s2=await getDoc(doc(db,"loans",loanId));
      const paid=Math.min(Number(s2.data().paidCount||0)+1, s2.data().months);
      await updateDoc(doc(db,"loans",loanId), {paidCount:paid,updatedAt:nowTS()}); loadAct();
    });
  });
}

async function loadInact(){
  const box=$("#listInact"); box.innerHTML="";
  // L√≥gica simplificada para el historial
}

async function loadAllAdmin(){ await loadPend(); await loadPre(); await loadAct(); await loadSettings(); }

$("#btnReloadPend").onclick=loadPend; 
$("#btnReloadPre").onclick=loadPre; 
$("#btnReloadAct").onclick=loadAct;

$("#btnSaveCfg").onclick=async()=>{
  const tna=Number(onlyDigits($("#cfgTna").value));
  const due=Math.min(28, Math.max(1, Number(onlyDigits($("#cfgDue").value))));
  await setDoc(doc(db,"settings","app"), {tna, dueDay:due, updatedAt:nowTS()}, {merge:true});
  loadSettings(); alert("Guardado.");
};

$("#btnOpenMyLoan").onclick=()=>$("#myloan").scrollIntoView({behavior:"smooth"});
$("#btnFindMyLoan").onclick=async()=>{
  const dni=onlyDigits($("#myDni").value);
  if(!dni) return;
  $("#myLoanResult").innerHTML="Buscando...";
  const qs=await getDocs(query(collection(db,"loans"), orderBy("createdAt","desc"), limit(100)));
  const list=[]; qs.forEach(d=>{ if((d.data().borrower?.dni||"")===dni) list.push({id:d.id,...d.data()}); });
  if(!list.length) { $("#myLoanResult").innerHTML="No se encontr√≥."; return; }
  const L=list[0];
  const paid=L.paidCount||0;
  $("#myLoanResult").innerHTML=`<div class="kpi">Estado: ${L.status.toUpperCase()}</div>
    <p>Monto: ${fmtMoney(L.amount)} ¬∑ Pagos: ${paid}/${L.months}</p>
    ${L.contractId ? `<button onclick="window.openContractFromId('${L.id}')" class="btn-outline">Ver Contrato PDF</button>` : ''}`;
};

// Global para el bot√≥n din√°mico
window.openContractFromId = async (id) => {
  const s=await getDoc(doc(db,"loans",id));
  openContract({...s.data(),id:s.id},false);
};

function contractHtml(L,forSigner){
  const today=new Date().toLocaleDateString("es-AR");
  const rows=scheduleRows(L).map(r=>`<tr><td>${r.n}</td><td>${new Date(r.due).toLocaleDateString()}</td><td>${fmtMoney(r.amount)}</td></tr>`).join("");
  const signerBlock=forSigner?`<div style="margin-top:20px; border: 2px solid #000; padding: 20px;">
    <h3>Firma Digital</h3><input id="signName" placeholder="Tu Nombre Completo"><br><br>
    <button id="btnAccept" style="padding:15px; background: green; color:#fff;">ACEPTAR CONTRATO</button></div>`:"";
  
  return `<html><body style="font-family:serif; padding:40px; max-width:800px; margin:auto; line-height:1.6;">
    <h1 style="text-align:center;">CONTRATO DE MUTUO - ESTIMA PRES</h1>
    <p>En R√≠o Gallegos, al ${today}, se acuerda entre EstimaPres y <b>${L.borrower?.name}</b> DNI <b>${L.borrower?.dni}</b>...</p>
    <p>1. MONTO: ${fmtMoney(L.amount)}<br>2. CUOTAS: ${L.months} de ${fmtMoney(L.installment)}<br>3. TNA: ${L.tna}%</p>
    <table><thead><tr><th>Cuota</th><th>Vence</th><th>Monto</th></tr></thead><tbody>${rows}</tbody></table>
    ${signerBlock}
    <script>
      if(document.getElementById('btnAccept')){
        document.getElementById('btnAccept').onclick=function(){
          const v = document.getElementById('signName').value;
          if(v.trim().toLowerCase() !== "${(L.borrower?.name||'').toLowerCase().trim()}") { alert("Nombre no coincide"); return; }
          window.opener.postMessage({type:'signed', id:'${L.id}', value:v}, '*');
          alert("Firmado."); window.close();
        }
      }
    <\/script></body></html>`;
}

function openContract(L,forSigner){
  const w=window.open('about:blank');
  w.document.write(contractHtml(L,forSigner));
}

window.addEventListener("message", async(ev)=>{
  if(ev.data?.type==='signed'){
    await updateDoc(doc(db,"loans",ev.data.id), {signed:true,signedName:ev.data.value,updatedAt:nowTS()});
    alert("Contrato recibido."); loadAllAdmin();
  }
});

(async function hashCheck(){
  if(location.hash.startsWith("#sign-")){
    const id=location.hash.replace("#sign-","");
    const s=await getDoc(doc(db,"loans",id));
    if(s.exists()) openContract({...s.data(),id:s.id},true);
  }
})();

$("#simAmount").oninput=e=>{
  const n=onlyDigits(e.target.value);
  e.target.value=n?fmtMoney(n):"";
};

await loadSettings();
</script>
</body>
</html>
