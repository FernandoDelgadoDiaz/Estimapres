<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EstimaPres · Préstamos en ARS</title>
  <style>
    :root{--blue:#0b62d6;--green:#169c46;--red:#d43d3d;--bg:#f6f7fb}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:var(--bg);color:#111}
    .nav{position:sticky;top:0;z-index:10;display:flex;gap:12px;align-items:center;padding:12px 16px;background:#0d47a1;color:#fff}
    .brand{font-weight:700}
    .chip{border-radius:999px;padding:10px 14px;background:#0b63d61a;border:1px solid #ffffff26;color:#fff;cursor:pointer}
    .chip:hover{background:#0b63d633}
    .btn{cursor:pointer;border-radius:12px;border:0;padding:12px 16px;font-weight:600}
    .btn-primary{background:var(--blue);color:#fff}
    .btn-outline{background:#fff;border:1px solid #ccd3e0}
    .btn-success{background:var(--green);color:#fff}
    .btn-danger{background:var(--red);color:#fff}
    .container{max-width:980px;margin:18px auto;padding:0 14px}
    .card{background:#fff;border:1px solid #e6e9f2;border-radius:18px;padding:18px}
    .grid{display:grid;gap:14px}
    .grid-2{grid-template-columns:1fr}
    @media(min-width:860px){.grid-2{grid-template-columns:1fr 1fr}}
    input,select{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #ccd3e0;font-size:16px}
    .muted{color:#6b7280}
    .section-title{font-size:26px;font-weight:800;margin:8px 0 12px}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;background:#e8f5e9;color:#1b5e20}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .list{display:grid;gap:10px}
    .hidden{display:none !important}
    .mb-2{margin-bottom:8px}
    .mb-3{margin-bottom:12px}
    .mb-4{margin-bottom:16px}
    .mt-2{margin-top:8px}
    .mt-3{margin-top:12px}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #e0e4ef;background:#fafbff}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .2s ease,transform .2s ease}
    .toast.show{opacity:1;transform:translate(-50%,0)}
  </style>
</head>
<body>
  <div class="nav">
    <div class="brand">EstimaPres</div>
    <div style="flex:1"></div>
    <button id="btnMyLoan" class="chip">Ver mi préstamo</button>
    <button id="btnAdmin" class="chip">Admin</button>
    <button id="btnLogout" class="chip hidden">Salir</button>
  </div>

  <div class="container grid grid-2">
    <!-- Columna 1: simulador + solicitud -->
    <div class="grid">
      <div class="card">
        <div class="section-title">Simulador (pesos argentinos)</div>
        <div class="grid">
          <input id="inAmount" type="number" placeholder="Ej: 200000" />
          <input id="inMonths" type="number" placeholder="Ej: 12" />
          <div class="muted" id="tnaLabel">TNA vigente: —%</div>
          <button id="btnSim" class="btn btn-outline">Simular</button>
          <div id="simOut" class="muted"></div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">Solicitar préstamo</div>
        <div class="grid">
          <input id="brName"   placeholder="Tu nombre" />
          <input id="brDni"    placeholder="DNI" />
          <input id="brEmail"  placeholder="tucorreo@dominio.com" />
          <input id="brPhone"  placeholder="11 2345 6789" />
          <input id="brCbu"    placeholder="alias o CBU/CVU" />
          <button id="btnSend" class="btn btn-primary">Enviar solicitud</button>
          <div class="muted">Al enviar aceptás ser contactado por EstimaPres.</div>
        </div>
      </div>
    </div>

    <!-- Columna 2: Panel admin -->
    <div id="adminBox" class="card hidden">
      <div class="section-title">Panel administrador</div>

      <div class="mb-4">
        <div class="muted mb-2">TNA</div>
        <div class="row">
          <input id="inTna" type="number" />
          <button id="btnSaveTna" class="btn btn-primary">Guardar</button>
        </div>
      </div>

      <div class="mb-4">
        <div class="row mb-2"><div class="muted">Solicitudes pendientes</div><button id="btnReloadPend" class="btn btn-outline">Recargar</button></div>
        <div id="pendList" class="list muted">Cargando…</div>
      </div>

      <div class="mb-4">
        <div class="row mb-2"><div class="muted">Preaprobados</div><button id="btnReloadPre" class="btn btn-outline">Recargar</button></div>
        <div id="preList" class="list muted">Cargando…</div>
      </div>

      <div class="mb-4">
        <div class="row mb-2">
          <div class="muted">Activos</div>
          <div class="muted" style="font-size:12px">● Verde: al día · ● Amarillo: 6–10 días de mora · ● Rojo: &gt;10 días</div>
          <button id="btnReloadActive" class="btn btn-outline">Recargar</button>
        </div>
        <div id="activeList" class="list muted">Cargando…</div>
      </div>

      <div>
        <div class="row mb-2"><div class="muted">Inactivos (finalizados / incobrables)</div><button id="btnReloadInactive" class="btn btn-outline">Recargar</button></div>
        <div id="inactiveList" class="list muted">Cargando…</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase -->
  <script type="module">
    // --- Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc,
      query, where, orderBy, limit, serverTimestamp, increment
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ========= 1) CONFIG FIREBASE =========
    const firebaseConfig = {
      apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
      authDomain: "estimapres.firebaseapp.com",
      projectId: "estimapres",
      storageBucket: "estimapres.firebasestorage.app",
      messagingSenderId: "578516597437",
      appId: "1:578516597437:web:f59994b87729aa1cd655d4"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ========= 2) HELPERs =========
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    const toast = (msg) => {
      const t = $("#toast"); t.textContent = msg; t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 2200);
    };
    const money = n => new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0}).format(Number(n||0));
    const escapeHTML = s => (s??"").toString().replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));

    const genContractNo = ()=> Math.random().toString(36).slice(2,6).toUpperCase()
                          + Math.random().toString(36).slice(2,6).toUpperCase();

    // ========= 3) ESTADO LOCAL =========
    let ADMIN = null; // email del admin logueado
    let TNA   = 0;

    // ========= 4) INICIO =========
    (async function init(){
      await loadTNA();
      bindUI();
      // restaurar admin si quedó
      const saved = localStorage.getItem("adminEmail");
      if(saved){ ADMIN = saved; $("#btnLogout").classList.remove("hidden"); $("#adminBox").classList.remove("hidden"); await reloadAllAdmin(); }
    })();

    // ========= 5) UI =========
    function bindUI(){
      $("#btnSim").onclick = doSim;
      $("#btnSend").onclick = sendRequest;
      $("#btnMyLoan").onclick = viewMyLoan;
      $("#btnAdmin").onclick  = adminLogin;
      $("#btnLogout").onclick = adminLogout;

      $("#btnSaveTna").onclick = saveTNA;

      $("#btnReloadPend").onclick    = loadPend;
      $("#btnReloadPre").onclick     = loadPre;
      $("#btnReloadActive").onclick  = loadActive;
      $("#btnReloadInactive").onclick= loadInactive;

      // Delegación de clicks en listas
      $("#pendList").addEventListener("click", onClickPend);
      $("#preList").addEventListener("click", onClickPre);
      $("#activeList").addEventListener("click", onClickActive);
    }

    // ========= 6) TNA =========
    async function loadTNA(){
      try{
        const ref = doc(db,"settings","global");
        const s = await getDoc(ref);
        TNA = Number(s.data()?.tna || 0);
        $("#tnaLabel").textContent = `TNA vigente: ${TNA}%`;
        $("#inTna").value = TNA;
      }catch(e){ console.error(e); toast("No se pudo leer TNA"); }
    }

    async function saveTNA(){
      if(!isAdmin()) return;
      try{
        const t = Number($("#inTna").value||0);
        await setDoc(doc(db,"settings","global"), { tna: t, updatedAt: serverTimestamp() }, { merge:true });
        TNA = t;
        $("#tnaLabel").textContent = `TNA vigente: ${TNA}%`;
        toast("TNA guardada");
      }catch(e){ console.error(e); toast("No se pudo guardar TNA"); }
    }

    // ========= 7) SIMULADOR (sin total a pagar) =========
    function cuota(P,tna,meses){
      // sistema francés (aprox): i = tna/12/100
      const i = (Number(tna)/12)/100;
      if(!i||!meses) return Math.round(P/Math.max(1,meses));
      const c = P * (i / (1 - Math.pow(1+i, -meses)));
      return Math.round(c);
    }
    function doSim(){
      const P = Number($("#inAmount").value||0);
      const n = Number($("#inMonths").value||0);
      if(P<=0||n<=0){ toast("Completá monto y meses"); return; }
      const c = cuota(P,TNA,n);
      // NO mostramos total, solo detalle de cuotas
      const items = Array.from({length:n},(_,k)=>`#${k+1} — ${money(c)}`).join("<br>");
      $("#simOut").innerHTML = `Cuota estimada: <b>${money(c)}</b><br><div class="mt-2">${items}</div>`;
    }

    // ========= 8) SOLICITUD =========
    async function sendRequest(){
      const amount = Number($("#inAmount").value||0);
      const months = Number($("#inMonths").value||0);
      const name   = $("#brName").value.trim();
      const dni    = $("#brDni").value.trim();
      const email  = $("#brEmail").value.trim();
      const phone  = $("#brPhone").value.trim();
      const cbu    = $("#brCbu").value.trim();
      if(amount<=0||months<=0||!name||!dni){ toast("Completá simulador y datos"); return; }
      try{
        await addDoc(collection(db,"loans"),{
          amount, months, tna:TNA,
          borrower:{name,dni,email,phone,cbu},
          status:"pending",
          createdAt:serverTimestamp()
        });
        toast("Solicitud enviada. Un admin la revisará.");
        // limpio algunos campos
        $("#brName").value=$("#brDni").value=$("#brEmail").value=$("#brPhone").value=$("#brCbu").value="";
      }catch(e){ console.error(e); toast("No se pudo enviar"); }
    }

    // ========= 9) VER MI PRÉSTAMO =========
    async function viewMyLoan(){
      const dni = prompt("Ingresá tu DNI para consultar tu préstamo:");
      if(!dni) return;
      try{
        const snap = await getDocs(query(collection(db,"loans"), orderBy("createdAt","desc"), limit(80)));
        const list = [];
        snap.forEach(d=>{
          const l = d.data(); if(l?.borrower?.dni==dni) list.push({id:d.id, ...l});
        });
        if(!list.length){ alert("No encontramos préstamos para ese DNI."); return; }
        const l = list[0];
        alert(`Estado: ${l.status}\nMonto: ${money(l.amount)}\nCuotas: ${l.months}\nTNA: ${l.tna}%\nContrato:\n${l.contractNo||"(pendiente)"}`);
      }catch(e){ console.error(e); alert("No se pudo consultar."); }
    }

    // ========= 10) ADMIN LOGIN (por lista de emails) =========
    async function adminLogin(){
      try{
        const email = (prompt("Ingresá tu email de administrador:")||"").trim().toLowerCase();
        if(!email) return;
        const ref = doc(db,"admins","admins");
        const a = await getDoc(ref);
        const ok = (a.data()?.emails||[]).some(x=>(x||"").toLowerCase()===email);
        if(!ok){ alert("Ese email no está autorizado."); return; }
        ADMIN=email; localStorage.setItem("adminEmail",email);
        $("#btnLogout").classList.remove("hidden");
        $("#adminBox").classList.remove("hidden");
        toast("Sesión iniciada");
        await reloadAllAdmin();
      }catch(e){ console.error(e); toast("No se pudo iniciar sesión"); }
    }
    function adminLogout(){
      ADMIN=null; localStorage.removeItem("adminEmail");
      $("#btnLogout").classList.add("hidden");
      $("#adminBox").classList.add("hidden");
      toast("Sesión cerrada");
    }
    const isAdmin = ()=> !!ADMIN;

    async function reloadAllAdmin(){ await loadPend(); await loadPre(); await loadActive(); await loadInactive(); }

    // ========= 11) LISTAS ADMIN =========

    // --- 11.a Pendientes (status == "pending", ordenado por fecha)
    async function loadPend(){
      if(!isAdmin()) return;
      const box = $("#pendList"); box.textContent="Cargando…";
      try{
        const qy = query(collection(db,"loans"), where("status","==","pending"), orderBy("createdAt","desc"), limit(40));
        const snap = await getDocs(qy);
        if(snap.empty){ box.textContent="Sin pendientes"; return; }
        box.innerHTML = "";
        snap.forEach(d=>{
          const l = d.data(); l.id=d.id;
          box.append(cardPend(l));
        });
      }catch(e){ console.error(e); box.textContent="No se pudieron leer las solicitudes (revisá reglas/índices)."; }
    }
    function cardPend(l){
      const div = document.createElement("div"); div.className="card";
      div.innerHTML = `
        <div><span class="pill">Pendiente</span> <b>${escapeHTML(l.borrower?.name||"")}</b> · DNI ${escapeHTML(l.borrower?.dni||"")}</div>
        <div class="muted">Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%</div>
        <div class="mt-3" style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-outline" data-act="ver" data-id="${l.id}">Ver</button>
          <button class="btn btn-primary" data-act="pre" data-id="${l.id}">Preaprobar</button>
          <button class="btn btn-danger" data-act="rej" data-id="${l.id}">Rechazar</button>
        </div>`;
      return div;
    }
    async function onClickPend(ev){
      const b = ev.target.closest("[data-act]"); if(!b) return;
      const ref = doc(db,"loans",b.dataset.id);
      if(b.dataset.act==="pre"){
        await updateDoc(ref,{status:"preapproved"});
        toast("Preaprobado"); await loadPend(); await loadPre();
      }else if(b.dataset.act==="rej"){
        if(!confirm("¿Rechazar solicitud?")) return;
        await updateDoc(ref,{status:"rejected"});
        toast("Rechazado"); await loadPend();
      }else if(b.dataset.act==="ver"){
        const s = await getDoc(ref); const l=s.data();
        alert(`${l.borrower?.name}\nDNI ${l.borrower?.dni}\nMonto ${money(l.amount)}\nCuotas ${l.months}\nTNA ${l.tna}%`);
      }
    }

    // --- 11.b Preaprobados (status in ["preapproved","signed"])
    async function loadPre(){
      if(!isAdmin()) return;
      const box = $("#preList"); box.textContent="Cargando…";
      try{
        // SIN orderBy para no exigir índice. Traemos hasta 60.
        const snap = await getDocs(query(collection(db,"loans"), where("status","in",["preapproved","signed"]), limit(60)));
        if(snap.empty){ box.textContent="Sin preaprobados"; return; }
        box.innerHTML="";
        snap.forEach(d=>{ const l=d.data(); l.id=d.id; box.append(cardPre(l)); });
      }catch(e){ console.error(e); box.textContent="No se pudieron leer (revisá reglas/índices)."; }
    }
    function cardPre(l){
      const div = document.createElement("div"); div.className="card";
      div.innerHTML = `
        <div><span class="tag">${escapeHTML(l.status)}</span> <b>${escapeHTML(l.borrower?.name||"")}</b> · DNI ${escapeHTML(l.borrower?.dni||"")}</div>
        <div class="muted">Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%${l.contractNo?` · Contrato ${l.contractNo}`:""}</div>
        <div class="mt-3" style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-outline" data-act="contrato" data-id="${l.id}">Contrato / Firmar</button>
          <button class="btn btn-outline" data-act="share" data-id="${l.id}">Compartir</button>
          <button class="btn btn-success" data-act="activar" data-id="${l.id}">Aprobar y activar</button>
        </div>`;
      return div;
    }

    async function firmarContrato(loanId){
      const ref = doc(db,"loans",loanId);
      const s = await getDoc(ref); const l = { id:s.id, ...s.data() };
      const nombre = (prompt("Para firmar, escribí tu nombre y apellido:")||"").trim();
      if(!nombre){ alert("Firma cancelada"); return; }
      // contrato #
      let contractNo = l.contractNo || genContractNo();
      await updateDoc(ref,{ status:"signed", signedBy:nombre, signedAt:serverTimestamp(), contractNo });
      // abrir contrato
      const html = contratoHTML({ ...l, contractNo }, nombre);
      const w = window.open("about:blank","_blank"); w.document.write(html); w.document.close();
      toast("Contrato firmado"); await loadPre();
    }

    function contratoHTML(l, firmante){
      const fecha = new Date().toLocaleDateString("es-AR",{timeZone:"America/Argentina/Buenos_Aires"});
      // HTML simple imprimible
      return `
<!doctype html><html lang="es"><head><meta charset="utf-8">
<title>Contrato ${l.contractNo||""}</title>
<style>body{font-family:Arial,Helvetica,sans-serif;line-height:1.5;padding:24px} h1{font-size:18px} .muted{color:#666}</style>
</head><body>
  <h1>Contrato N° ${escapeHTML(l.contractNo||"")}</h1>
  <div class="muted">${fecha}</div>
  <p>Entre <b>EstimaPres</b> y <b>${escapeHTML(l.borrower?.name||"")}</b> (DNI ${escapeHTML(l.borrower?.dni||"")}) se celebra el siguiente contrato de mutuo:</p>
  <p>Monto: <b>${money(l.amount)}</b> · Cuotas: <b>${l.months}</b> · TNA: <b>${l.tna}%</b></p>
  <p>El firmante declara aceptar los términos y condiciones. Firma digital: <b>${escapeHTML(firmante)}</b>.</p>
  <hr/>
  <p class="muted">Este documento puede imprimirse o guardarse en PDF.</p>
</body></html>`;
    }

    async function shareContrato(loanId){
      const ref = doc(db,"loans",loanId);
      const s = await getDoc(ref); const l = { id:s.id, ...s.data() };
      const text = `Contrato ${l.contractNo||""} - ${l.borrower?.name||""} - Monto ${money(l.amount)} - Cuotas ${l.months} - TNA ${l.tna}%`;
      if(navigator.share){
        try{ await navigator.share({ text, title:"Contrato EstimaPres" }); }catch{}
      }else{
        const url = "https://wa.me/?text="+encodeURIComponent(text);
        window.open(url,"_blank");
      }
    }

    async function onClickPre(ev){
      const b = ev.target.closest("[data-act]"); if(!b) return;
      const id = b.dataset.id; const ref = doc(db,"loans",id);
      if(b.dataset.act==="contrato") { await firmarContrato(id); return; }
      if(b.dataset.act==="share")    { await shareContrato(id); return; }
      if(b.dataset.act==="activar"){
        await updateDoc(ref,{ status:"active", activeAt:serverTimestamp() });
        toast("Préstamo activado"); await loadPre(); await loadActive();
      }
    }

    // --- 11.c Activos (status == "active", ordenado por activeAt)
    async function loadActive(){
      if(!isAdmin()) return;
      const box = $("#activeList"); box.textContent="Cargando…";
      try{
        const snap = await getDocs(query(collection(db,"loans"), where("status","==","active"), orderBy("activeAt","desc"), limit(60)));
        if(snap.empty){ box.textContent="Sin activos"; return; }
        box.innerHTML="";
        snap.forEach(d=>{ const l=d.data(); l.id=d.id; box.append(cardActive(l)); });
      }catch(e){ console.error(e); box.textContent="No se pudieron leer (revisá reglas/índices)."; }
    }
    function cardActive(l){
      const pagadas = Number(l.paidCount||0), total = Number(l.months||0);
      const div = document.createElement("div"); div.className="card";
      div.innerHTML = `
        <div><span class="pill">Activo</span> <b>${escapeHTML(l.borrower?.name||"")}</b> · DNI ${escapeHTML(l.borrower?.dni||"")}</div>
        <div class="muted">Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%</div>
        <div class="muted mt-2">Cuotas pagadas: <b>${pagadas}</b> / ${total}</div>
        <div class="mt-3" style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-outline" data-act="pay1" data-id="${l.id}">Marcar 1 cuota</button>
          <button class="btn btn-success" data-act="fin" data-id="${l.id}">Pagado total</button>
          <button class="btn btn-danger" data-act="inc" data-id="${l.id}">A incobrables</button>
        </div>`;
      return div;
    }
    async function onClickActive(ev){
      const b = ev.target.closest("[data-act]"); if(!b) return;
      const id = b.dataset.id; const ref = doc(db,"loans",id);
      try{
        if(b.dataset.act==="pay1"){
          const snap = await getDoc(ref); const l=snap.data();
          const pagadas=Number(l.paidCount||0), total=Number(l.months||0);
          if(pagadas>=total){ alert("Todas las cuotas ya están pagadas."); return; }
          await updateDoc(ref,{ paidCount: increment(1), lastPaymentAt: serverTimestamp() });
          toast("Se marcó una cuota."); await loadActive(); return;
        }
        if(b.dataset.act==="fin"){
          if(!confirm("¿Finalizar (pagado total)?")) return;
          await updateDoc(ref,{ status:"finished" }); toast("Finalizado"); await loadActive(); await loadInactive(); return;
        }
        if(b.dataset.act==="inc"){
          if(!confirm("¿Pasar a incobrables?")) return;
          await updateDoc(ref,{ status:"charged_off" }); toast("Marcado incobrable"); await loadActive(); await loadInactive(); return;
        }
      }catch(e){ console.error(e); toast("No se pudo actualizar el préstamo."); }
    }

    // --- 11.d Inactivos (status in ["finished","charged_off"])
    async function loadInactive(){
      if(!isAdmin()) return;
      const box = $("#inactiveList"); box.textContent="Cargando…";
      try{
        const snap = await getDocs(query(collection(db,"loans"), where("status","in",["finished","charged_off"]), limit(80)));
        if(snap.empty){ box.textContent="Sin inactivos"; return; }
        box.innerHTML="";
        snap.forEach(d=>{
          const l=d.data(); l.id=d.id;
          const div=document.createElement("div"); div.className="card";
          div.innerHTML = `
            <div><span class="tag">${escapeHTML(l.status)}</span> <b>${escapeHTML(l.borrower?.name||"")}</b> · DNI ${escapeHTML(l.borrower?.dni||"")}</div>
            <div class="muted">Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}% · Contrato ${escapeHTML(l.contractNo||"-")}</div>`;
          box.append(div);
        });
      }catch(e){ console.error(e); box.textContent="No se pudieron leer (revisá reglas/índices)."; }
    }
  </script>
</body>
</html>