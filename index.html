<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<title>Prestify ¬∑ Tu financiera, digitalizada</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg-dark:#0B1120;
  --bg-card:#151F2F;
  --bg-input:#1E2A3A;
  --border-light:#2A3A4A;
  --border-glow:#3B7CF6;
  --text-primary:#F0F4FA;
  --text-secondary:#9BB5D4;
  --text-muted:#6B85A0;
  --accent-primary:#1A56DB;
  --accent-glow:#3B7CF6;
  --accent-success:#10B981;
  --accent-warning:#F59E0B;
  --accent-danger:#EF4444;
  --accent-purple:#A78BFA;
  --radius-md:12px;
  --radius-lg:20px;
  --shadow-card:0 8px 32px rgba(0,0,0,0.4), 0 1px 2px rgba(255,255,255,0.05) inset;
  --shadow-glow:0 4px 20px rgba(26,86,219,0.4);
  --font-main:'Inter',system-ui,-apple-system,sans-serif;
  --font-mono:'JetBrains Mono',monospace;
}
body{font-family:var(--font-main);background:var(--bg-dark);color:var(--text-primary);min-height:100vh;line-height:1.5;-webkit-font-smoothing:antialiased}
/* Scrollbar */
::-webkit-scrollbar{width:5px;height:5px;background:var(--bg-dark)}
::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:20px}
::-webkit-scrollbar-thumb:hover{background:var(--accent-primary)}
/* Layout */
.app{max-width:1400px;margin:0 auto;padding:0 16px}@media(min-width:768px){.app{padding:0 24px}}
/* Topbar */
.topbar{position:sticky;top:0;z-index:100;background:rgba(11,17,32,0.9);backdrop-filter:blur(16px);border-bottom:1px solid var(--border-light);margin-bottom:24px}
.topbar-inner{display:flex;align-items:center;justify-content:space-between;height:64px;flex-wrap:wrap;gap:12px}
.logo{display:flex;align-items:center;gap:10px;cursor:pointer}
.logo-mark{width:36px;height:36px;border-radius:10px;background:linear-gradient(145deg,var(--accent-primary),var(--accent-glow));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:16px;color:white;box-shadow:var(--shadow-glow)}
.logo-name{font-weight:700;font-size:18px;letter-spacing:-0.3px}
.logo-name span{color:var(--accent-glow)}
.nav-group{display:flex;align-items:center;gap:4px;flex-wrap:wrap}
.nav-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:10px;border:1px solid transparent;background:transparent;color:var(--text-secondary);font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s;white-space:nowrap}
.nav-btn svg{width:16px;height:16px;stroke:currentColor;stroke-width:2;fill:none}
.nav-btn:hover{background:rgba(59,124,246,0.1);border-color:var(--border-light);color:white}
.nav-btn.active{background:rgba(26,86,219,0.2);border-color:var(--accent-glow);color:white}
.nav-btn.danger{color:var(--accent-danger)}.nav-btn.danger:hover{background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.3)}
.nav-sep{width:1px;height:24px;background:var(--border-light);margin:0 6px}
/* Notificaciones */
.notif-wrap{position:relative}
.notif-bell{position:relative;width:38px;height:38px;border-radius:10px;border:1px solid var(--border-light);background:transparent;color:var(--text-secondary);cursor:pointer;transition:all 0.2s}
.notif-bell:hover{background:rgba(59,124,246,0.1);border-color:var(--accent-glow);color:white}
.notif-badge{position:absolute;top:-4px;right:-4px;min-width:18px;height:18px;padding:0 4px;background:var(--accent-danger);border-radius:20px;border:2px solid var(--bg-dark);font-size:10px;font-weight:700;color:white;display:flex;align-items:center;justify-content:center}
.notif-dropdown{display:none;position:absolute;top:calc(100% + 8px);right:0;width:320px;background:var(--bg-card);border:1px solid var(--border-light);border-radius:var(--radius-lg);box-shadow:var(--shadow-card);z-index:200;overflow:hidden}
.notif-dropdown.open{display:block}
.notif-header{padding:14px 16px;border-bottom:1px solid var(--border-light);font-size:12px;font-weight:600;color:var(--accent-glow);display:flex;justify-content:space-between}
.notif-list{max-height:320px;overflow-y:auto}
.notif-item{padding:12px 16px;border-bottom:1px solid rgba(59,124,246,0.1);cursor:pointer;transition:background 0.15s}
.notif-item:hover{background:rgba(59,124,246,0.08)}
.notif-item.unread{border-left:3px solid var(--accent-glow)}
.notif-item-title{font-size:13px;font-weight:600;color:white;margin-bottom:2px}
.notif-item-sub{font-size:11px;color:var(--text-muted)}
/* Alert banner */
.alert-banner{display:none;position:fixed;top:80px;left:50%;transform:translateX(-50%);z-index:150;padding:14px 20px;background:linear-gradient(145deg,var(--accent-primary),var(--accent-glow));border-radius:var(--radius-lg);color:white;font-weight:600;box-shadow:var(--shadow-glow);gap:12px;align-items:center;max-width:90vw}
.alert-banner.show{display:flex;animation:slideDown 0.3s}
@keyframes slideDown{from{opacity:0;transform:translateX(-50%) translateY(-20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.alert-banner-close{background:rgba(255,255,255,0.2);border:none;color:white;width:24px;height:24px;border-radius:8px;cursor:pointer}
/* Hero */
.hero{display:grid;grid-template-columns:1fr auto;gap:30px;margin-bottom:32px;padding:20px 0}
@media(max-width:768px){.hero{grid-template-columns:1fr}}
.hero-title{font-size:clamp(28px,4vw,44px);font-weight:800;line-height:1.2;letter-spacing:-1px;margin-bottom:12px}
.hero-title em{font-style:normal;background:linear-gradient(145deg,var(--accent-glow),#A78BFA);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hero-sub{color:var(--text-secondary);font-size:15px;max-width:500px;margin-bottom:20px}
.hero-badges{display:flex;gap:10px;flex-wrap:wrap}
.badge{display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--bg-card);border:1px solid var(--border-light);border-radius:30px;font-size:12px;font-weight:500;color:var(--text-secondary)}
.hero-kpis{display:flex;flex-direction:column;gap:12px}
.kpi-box{background:var(--bg-card);border:1px solid var(--border-light);border-radius:var(--radius-lg);padding:20px 24px;text-align:right}
.kpi-label{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
.kpi-value{font-size:32px;font-weight:700;font-family:var(--font-mono);color:white}
.kpi-value small{font-size:14px;color:var(--accent-glow);margin-left:4px}
/* Cards */
.card{background:var(--bg-card);border:1px solid var(--border-light);border-radius:var(--radius-lg);padding:24px;margin-bottom:20px;box-shadow:var(--shadow-card)}
.card-title{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--accent-glow);margin-bottom:20px;display:flex;align-items:center;gap:8px}
.card-title svg{width:16px;height:16px;stroke:currentColor;stroke-width:2}
/* Grids */
.dashboard-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:24px}@media(max-width:1024px){.dashboard-grid{grid-template-columns:repeat(3,1fr)}}@media(max-width:768px){.dashboard-grid{grid-template-columns:repeat(2,1fr)}}@media(max-width:480px){.dashboard-grid{grid-template-columns:1fr}}
.dash-card{background:var(--bg-card);border:1px solid var(--border-light);border-radius:var(--radius-lg);padding:20px;transition:all 0.2s}
.dash-card:hover{transform:translateY(-2px);border-color:var(--accent-glow)}
.dash-icon{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:14px}
.dash-icon.blue{background:rgba(26,86,219,0.2);color:var(--accent-glow)}
.dash-icon.green{background:rgba(16,185,129,0.2);color:var(--accent-success)}
.dash-icon.red{background:rgba(239,68,68,0.2);color:var(--accent-danger)}
.dash-label{font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px}
.dash-value{font-family:var(--font-mono);font-size:22px;font-weight:700;color:white}
.client-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}@media(max-width:768px){.client-grid{grid-template-columns:1fr}}
.full-width{grid-column:1/-1}
/* Forms */
.field{margin-bottom:16px}
.field label{display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px}
.field input,.field select,.field textarea{width:100%;background:var(--bg-input);border:1px solid var(--border-light);border-radius:var(--radius-md);padding:12px 16px;color:white;font-family:var(--font-main);font-size:14px;transition:all 0.2s}
.field input:focus,.field select:focus,.field textarea:focus{outline:none;border-color:var(--accent-glow);box-shadow:0 0 0 3px rgba(59,124,246,0.2)}
.field input::placeholder{color:var(--text-muted)}
.input-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}@media(max-width:480px){.input-row{grid-template-columns:1fr}}
/* Buttons */
.btn-primary{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 24px;background:linear-gradient(145deg,var(--accent-primary),var(--accent-glow));border:none;border-radius:var(--radius-md);color:white;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.2s;box-shadow:var(--shadow-glow);width:100%}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(26,86,219,0.6)}
.btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.btn-success{background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);color:var(--accent-success);padding:8px 16px;border-radius:var(--radius-md);font-weight:600;font-size:13px;cursor:pointer}
.btn-danger{background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);color:var(--accent-danger);padding:8px 16px;border-radius:var(--radius-md);font-weight:600;font-size:13px;cursor:pointer}
.btn-outline{background:transparent;border:1px solid var(--border-light);color:var(--text-secondary);padding:8px 16px;border-radius:var(--radius-md);font-weight:500;font-size:13px;cursor:pointer}
.btn-outline:hover{border-color:var(--accent-glow);color:white}
.btn-sm{padding:6px 12px!important;font-size:12px!important}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
/* Pills */
.pill{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:30px;font-size:11px;font-weight:600}
.pill::before{content:'';width:6px;height:6px;border-radius:50%}
.pill.ok{background:rgba(16,185,129,0.15);color:var(--accent-success)}.pill.ok::before{background:var(--accent-success)}
.pill.warn{background:rgba(245,158,11,0.15);color:var(--accent-warning)}.pill.warn::before{background:var(--accent-warning)}
.pill.bad{background:rgba(239,68,68,0.15);color:var(--accent-danger)}.pill.bad::before{background:var(--accent-danger)}
/* Schedule */
.schedule-wrap{border:1px solid var(--border-light);border-radius:var(--radius-md);overflow:hidden;margin-top:16px}
.schedule-header{display:grid;grid-template-columns:40px 1fr 120px 1fr;gap:8px;padding:10px 16px;background:rgba(0,0,0,0.3);border-bottom:1px solid var(--border-light);font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase}
.schedule-row{display:grid;grid-template-columns:40px 1fr 120px 1fr;gap:8px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border-light)}
.schedule-row:last-child{border-bottom:none}
.schedule-row.is-paid{opacity:0.6}
.schedule-row.is-late{background:rgba(239,68,68,0.08)}
.schedule-row .num{font-family:var(--font-mono);font-size:12px;color:var(--text-muted)}
.schedule-row .date{font-size:13px;color:var(--text-secondary)}
.schedule-row .amount{font-family:var(--font-mono);font-size:14px;color:white}
.schedule-row .action-col{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
/* Tabs */
.admin-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px;overflow-x:auto;padding-bottom:4px}
.tab-btn{padding:8px 16px;border-radius:30px;border:1px solid var(--border-light);background:transparent;color:var(--text-secondary);font-size:13px;font-weight:500;cursor:pointer;white-space:nowrap}
.tab-btn:hover{border-color:var(--accent-glow);color:white}
.tab-btn.active{background:rgba(26,86,219,0.2);border-color:var(--accent-glow);color:white}
.tab-content{display:none}
.tab-content.visible{display:block}
/* Tabla superadmin */
.sa-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:16px}
.sa-title{font-size:24px;font-weight:700;display:flex;align-items:center;gap:12px}
.sa-badge{padding:4px 10px;background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);border-radius:30px;font-size:11px;color:var(--accent-danger)}
.sa-metrics{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:24px}@media(max-width:1024px){.sa-metrics{grid-template-columns:repeat(3,1fr)}}@media(max-width:768px){.sa-metrics{grid-template-columns:repeat(2,1fr)}}@media(max-width:480px){.sa-metrics{grid-template-columns:1fr}}
.sa-metric-card{background:var(--bg-card);border:1px solid var(--border-light);border-radius:var(--radius-lg);padding:20px}
.sa-metric-label{font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px}
.sa-metric-val{font-family:var(--font-mono);font-size:28px;font-weight:700;color:white}
.sa-lenders-table{background:var(--bg-card);border:1px solid var(--border-light);border-radius:var(--radius-lg);overflow:hidden}
.sa-row{display:grid;grid-template-columns:2fr 1fr 1fr 1.5fr;gap:16px;align-items:center;padding:20px 24px;border-bottom:1px solid var(--border-light)}@media(max-width:768px){.sa-row{grid-template-columns:1fr;gap:12px}}
.sa-row:last-child{border-bottom:none}
.sa-row-head{background:rgba(0,0,0,0.3);font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase}
.sa-lender-name{font-size:16px;font-weight:600;color:white}
.sa-lender-email{font-size:12px;color:var(--text-secondary);margin-top:2px}
.sa-status-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:30px;font-size:12px;font-weight:600}
.sa-status-pill.activo{background:rgba(16,185,129,0.15);color:var(--accent-success)}
.sa-status-pill.pendiente{background:rgba(245,158,11,0.15);color:var(--accent-warning)}
.sa-status-pill.pausado{background:rgba(239,68,68,0.15);color:var(--accent-danger)}
.sa-action-btn{padding:6px 12px;border-radius:var(--radius-md);font-weight:600;font-size:12px;cursor:pointer;border:1px solid;background:transparent}
.sa-btn-activate{border-color:rgba(16,185,129,0.3);color:var(--accent-success)}.sa-btn-activate:hover{background:rgba(16,185,129,0.1)}
.sa-btn-suspend{border-color:rgba(239,68,68,0.3);color:var(--accent-danger)}.sa-btn-suspend:hover{background:rgba(239,68,68,0.1)}
/* Simulador */
.sim-meta{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:20px;padding:10px 16px;background:rgba(0,0,0,0.3);border-radius:var(--radius-md)}
.sim-meta-item{font-size:13px;color:var(--text-secondary)}.sim-meta-item strong{color:var(--accent-glow);font-family:var(--font-mono)}
.breakdown-box{background:rgba(0,0,0,0.3);border-radius:var(--radius-md);padding:16px;margin:16px 0}
.breakdown-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border-light);font-size:13px}
.breakdown-row:last-child{border-bottom:none;font-weight:700;color:white}
.breakdown-row .bl{color:var(--text-secondary)}
.breakdown-row .bv{font-family:var(--font-mono)}
/* Modals */
.modal-overlay{display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:20px}
.modal-overlay.open{display:flex}
.modal-box{background:var(--bg-card);border:1px solid var(--border-light);border-radius:var(--radius-lg);padding:28px;max-width:480px;width:100%;max-height:90vh;overflow-y:auto}
.modal-title{font-size:20px;font-weight:700;color:white;margin-bottom:6px}
.modal-sub{color:var(--text-secondary);font-size:14px;margin-bottom:20px}
.sig-canvas-wrap{border:2px dashed var(--border-light);border-radius:var(--radius-md);overflow:hidden;touch-action:none;margin-bottom:16px}
#sigCanvas,#obSigCanvas{display:block;width:100%;height:180px;cursor:crosshair;background:var(--bg-input)}
.sig-actions{display:flex;gap:12px;margin-bottom:12px}
/* Onboarding */
.onboarding-overlay{display:none;position:fixed;inset:0;z-index:900;background:rgba(0,0,0,0.95);backdrop-filter:blur(16px);align-items:center;justify-content:center;padding:20px}
.onboarding-overlay.show{display:flex}
.onboarding-box{background:var(--bg-card);border:1px solid var(--border-light);border-radius:var(--radius-lg);padding:32px;max-width:560px;width:100%;max-height:90vh;overflow-y:auto}
.ob-steps{display:flex;gap:0;margin-bottom:32px;position:relative}
.ob-steps::before{content:'';position:absolute;top:16px;left:30px;right:30px;height:2px;background:var(--border-light);z-index:0}
.ob-step{display:flex;flex-direction:column;align-items:center;flex:1;position:relative;z-index:1}
.ob-step-dot{width:32px;height:32px;border-radius:50%;border:2px solid var(--border-light);background:var(--bg-dark);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:var(--text-secondary)}
.ob-step.active .ob-step-dot{border-color:var(--accent-glow);color:var(--accent-glow)}
.ob-step.done .ob-step-dot{border-color:var(--accent-success);color:var(--accent-success)}
.ob-step-label{font-size:10px;font-weight:600;color:var(--text-muted);margin-top:6px}
.ob-content{display:none}
.ob-content.active{display:block}
.ob-title{font-size:20px;font-weight:700;color:white;margin-bottom:6px}
.ob-subtitle{color:var(--text-secondary);font-size:13px;margin-bottom:24px}
/* Pending overlay */
.pending-overlay{display:none;position:fixed;inset:0;z-index:950;background:rgba(0,0,0,0.98);backdrop-filter:blur(20px);align-items:center;justify-content:center;flex-direction:column;gap:24px;padding:30px;text-align:center}
.pending-overlay.show{display:flex}
.pending-logo-mark{width:80px;height:80px;border-radius:20px;background:linear-gradient(145deg,var(--accent-primary),var(--accent-glow));display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:800;color:white}
.pending-badge{background:rgba(245,158,11,0.2);border:1px solid rgba(245,158,11,0.3);color:var(--accent-warning);padding:8px 20px;border-radius:30px;font-weight:600;font-size:13px}
/* Suspended overlay */
.suspended-overlay{display:none;position:fixed;inset:0;z-index:960;background:rgba(0,0,0,0.98);backdrop-filter:blur(20px);align-items:center;justify-content:center;flex-direction:column;gap:24px;padding:30px;text-align:center}
.suspended-overlay.show{display:flex}
.suspended-icon{width:80px;height:80px;border-radius:20px;background:rgba(239,68,68,0.2);border:2px solid rgba(239,68,68,0.3);display:flex;align-items:center;justify-content:center}
.suspended-icon svg{width:40px;height:40px;stroke:var(--accent-danger)}
.suspended-title{font-size:24px;font-weight:800;color:var(--accent-danger)}
/* Landing page */
.landing-view{display:none;max-width:1200px;margin:0 auto;padding:40px 20px}
.landing-view.show{display:block}
.landing-hero{text-align:center;margin-bottom:60px}
.landing-eyebrow{display:inline-flex;align-items:center;gap:8px;padding:6px 16px;background:rgba(26,86,219,0.2);border:1px solid rgba(59,124,246,0.3);border-radius:30px;color:var(--accent-glow);font-size:12px;font-weight:600;margin-bottom:24px}
.landing-title{font-size:clamp(32px,6vw,56px);font-weight:800;line-height:1.1;letter-spacing:-1.5px;color:white;margin-bottom:20px}
.landing-title em{font-style:normal;background:linear-gradient(145deg,var(--accent-glow),#A78BFA);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.landing-sub{font-size:16px;color:var(--text-secondary);max-width:600px;margin:0 auto 32px}
.landing-cta{display:inline-flex;align-items:center;gap:12px;padding:16px 32px;background:linear-gradient(145deg,var(--accent-primary),var(--accent-glow));border:none;border-radius:var(--radius-lg);color:white;font-weight:700;font-size:16px;cursor:pointer;box-shadow:var(--shadow-glow)}
.landing-features{display:grid;grid-template-columns:repeat(3,1fr);gap:24px;margin:60px 0}@media(max-width:768px){.landing-features{grid-template-columns:1fr}}
.feature-card{background:var(--bg-card);border:1px solid var(--border-light);border-radius:var(--radius-lg);padding:28px}
.feature-icon{font-size:32px;margin-bottom:16px}
.feature-title{font-size:18px;font-weight:700;color:white;margin-bottom:8px}
.feature-desc{color:var(--text-secondary);font-size:14px;line-height:1.6}
/* Estilo MONI para clientes */
body.client-mode{background:#F5F8FF}
body.client-mode .topbar{background:white;border-bottom:1px solid #E2E8F0}
body.client-mode .logo-name{color:#1E293B}
body.client-mode .nav-btn{color:#64748B}
body.client-mode .nav-btn:hover{background:#F1F5F9;color:#0F172A}
body.client-mode .card{background:white;border:1px solid #E2E8F0;box-shadow:0 4px 16px rgba(0,0,0,0.05);border-radius:24px}
body.client-mode .card-title{color:#1A56DB}
body.client-mode .field label{color:#475569}
body.client-mode .field input,body.client-mode .field select{background:#F8FAFC;border:2px solid #E2E8F0;color:#0F172A}
body.client-mode .client-amount-display{font-size:36px;font-weight:800;color:var(--brand-color,#1A56DB);text-align:center;margin:10px 0}
body.client-mode .client-amount-slider{-webkit-appearance:none;width:100%;height:8px;background:#E2E8F0;border-radius:20px;margin:20px 0}
body.client-mode .client-amount-slider::-webkit-slider-thumb{-webkit-appearance:none;width:28px;height:28px;border-radius:50%;background:var(--brand-color,#1A56DB);box-shadow:0 2px 8px rgba(26,86,219,0.3);cursor:pointer;border:3px solid white}
body.client-mode .client-pill{padding:12px 16px;border:2px solid #E2E8F0;border-radius:40px;background:white;color:#64748B;font-weight:600;cursor:pointer}
body.client-mode .client-pill.active{background:var(--brand-color,#1A56DB);border-color:var(--brand-color,#1A56DB);color:white}
body.client-mode .btn-primary{background:var(--brand-color,#1A56DB)!important;box-shadow:0 4px 16px rgba(26,86,219,0.3);border-radius:40px}
/* Toasts */
.toast-container{position:fixed;bottom:24px;right:24px;z-index:1000;display:flex;flex-direction:column;gap:8px}
.toast{padding:14px 20px;border-radius:var(--radius-md);font-weight:500;animation:slideIn 0.3s;max-width:360px}
.toast.ok{background:#0C2E1F;border:1px solid rgba(16,185,129,0.3);color:#34D399}
.toast.err{background:#2A0C0C;border:1px solid rgba(239,68,68,0.3);color:#F87171}
@keyframes slideIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
/* Responsive utilities */
@media(max-width:640px){
  .card{padding:18px}
  .schedule-header,.schedule-row{grid-template-columns:30px 1fr 90px auto;gap:4px;padding:10px;font-size:11px}
  .modal-box{padding:20px}
  .btn-primary{padding:14px}
  .hero-kpis{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- SUPERADMIN PANEL -->
<div class="superadmin-view" id="superadminView" style="display:none">
  <div class="app">
    <div class="sa-header">
      <div class="sa-title">
        üõ°Ô∏è Panel SuperAdmin
        <span class="sa-badge">Acceso total</span>
      </div>
      <button class="btn-outline btn-sm" id="btnSaLogout">Cerrar sesi√≥n</button>
    </div>
    
    <div class="sa-metrics" id="saMetrics">
      <div class="sa-metric-card"><div class="sa-metric-label">Total prestamistas</div><div class="sa-metric-val" id="saCountLenders">‚Äî</div></div>
      <div class="sa-metric-card"><div class="sa-metric-label">Activos</div><div class="sa-metric-val" id="saCountActive">‚Äî</div></div>
      <div class="sa-metric-card"><div class="sa-metric-label">Pendientes</div><div class="sa-metric-val" id="saCountPending">‚Äî</div></div>
      <div class="sa-metric-card"><div class="sa-metric-label">Pausados</div><div class="sa-metric-val" id="saCountPaused">‚Äî</div></div>
      <div class="sa-metric-card"><div class="sa-metric-label">Pr√©stamos totales</div><div class="sa-metric-val" id="saCountLoans">‚Äî</div></div>
    </div>

    <div class="sa-lenders-table">
      <div class="sa-row sa-row-head">
        <div>Prestamista</div>
        <div>Contacto</div>
        <div>Estado</div>
        <div>Acciones</div>
      </div>
      <div id="saLendersList"><div class="sa-loading" style="padding:40px;text-align:center">Cargando prestamistas...</div></div>
    </div>
  </div>
</div>

<!-- LANDING PAGE -->
<div class="landing-view" id="landingView">
  <div class="landing-hero">
    <div class="landing-eyebrow">‚ú® Para prestamistas profesionales</div>
    <h1 class="landing-title">Tu financiera digital,<br><em>lista en minutos</em></h1>
    <p class="landing-sub">Gestion√° pr√©stamos, cobr√° cuotas y escal√° tu negocio sin c√≥digo ni papeles.</p>
    <button class="landing-cta" id="btnLandingRegister">
      <svg viewBox="0 0 24 24" width="20" height="20" stroke="white" fill="none"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
      Crear mi financiera
    </button>
  </div>

  <div class="landing-features">
    <div class="feature-card"><div class="feature-icon">üè¶</div><div class="feature-title">Marca blanca</div><div class="feature-desc">Personaliz√° con tu nombre, logo y colores.</div></div>
    <div class="feature-card"><div class="feature-icon">üì±</div><div class="feature-title">Link de cliente</div><div class="feature-desc">Compart√≠ un link √∫nico para que soliciten pr√©stamos.</div></div>
    <div class="feature-card"><div class="feature-icon">‚ö°</div><div class="feature-title">Panel en tiempo real</div><div class="feature-desc">Solicitudes al instante, aprobaciones y gesti√≥n.</div></div>
    <div class="feature-card"><div class="feature-icon">üìä</div><div class="feature-title">Motor financiero</div><div class="feature-desc">Sistema franc√©s, TNA configurable, mora automatizada.</div></div>
    <div class="feature-card"><div class="feature-icon">üí≥</div><div class="feature-title">Cobro online</div><div class="feature-desc">Mercado Pago o transferencia manual con comprobante.</div></div>
    <div class="feature-card"><div class="feature-icon">üìù</div><div class="feature-title">Contratos digitales</div><div class="feature-desc">Firma electr√≥nica con validez legal (Ley 25.506).</div></div>
  </div>
</div>

<!-- PENDING OVERLAY (prestamista en espera) -->
<div class="pending-overlay" id="pendingOverlay">
  <div class="pending-logo-mark">P</div>
  <div class="pending-badge">‚è≥ Validaci√≥n pendiente</div>
  <div style="font-size:20px;font-weight:700">Tu financiera est√° siendo validada</div>
  <div style="color:var(--text-secondary);max-width:400px">En breve te contactaremos para activar tu cuenta.</div>
  <button id="btnPendingLogout" class="btn-outline">Cerrar sesi√≥n</button>
</div>

<!-- SUSPENDED OVERLAY -->
<div class="suspended-overlay" id="suspendedOverlay">
  <div class="suspended-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg></div>
  <div class="suspended-title">Cuenta suspendida</div>
  <div style="color:var(--text-secondary)">Contact√° a soporte para reactivarla.</div>
</div>

<!-- MODAL REGISTRO PRESTAMISTA -->
<div class="modal-overlay" id="registerModalOverlay">
  <div class="modal-box">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
      <div class="logo-mark">P</div>
      <span class="logo-name">Presti<span>fy</span></span>
    </div>
    <div class="modal-title">Cre√° tu financiera</div>
    <div class="modal-sub">Ingres√° tus datos para comenzar.</div>
    <div class="field"><label>Email</label><input type="email" id="regEmail" placeholder="tucorreo@ejemplo.com"></div>
    <div class="field"><label>Contrase√±a</label><input type="password" id="regPassword" placeholder="M√≠nimo 6 caracteres"></div>
    <div class="field"><label>Confirmar contrase√±a</label><input type="password" id="regPasswordConfirm"></div>
    <button class="btn-primary" id="btnDoRegister">Crear cuenta y continuar</button>
    <div style="text-align:center;margin-top:16px;font-size:13px;color:var(--text-muted)">
      ¬øYa ten√©s cuenta? <a href="#" id="btnSwitchToLogin" style="color:var(--accent-glow);text-decoration:none">Iniciar sesi√≥n</a>
    </div>
  </div>
</div>

<!-- ONBOARDING 3 PASOS -->
<div class="onboarding-overlay" id="onboardingOverlay">
  <div class="onboarding-box">
    <div class="ob-steps">
      <div class="ob-step active" id="obStep1"><div class="ob-step-dot">1</div><div class="ob-step-label">Datos</div></div>
      <div class="ob-step" id="obStep2"><div class="ob-step-dot">2</div><div class="ob-step-label">Tu financiera</div></div>
      <div class="ob-step" id="obStep3"><div class="ob-step-dot">3</div><div class="ob-step-label">Tasas</div></div>
    </div>

    <!-- PASO 1 -->
    <div class="ob-content active" id="obContent1">
      <div class="ob-title">Tus datos personales</div>
      <div class="ob-subtitle">Complet√° tu informaci√≥n y acept√° los t√©rminos.</div>
      <div class="input-row">
        <div class="field"><label>Nombre completo</label><input id="obName" placeholder="Juan P√©rez"></div>
        <div class="field"><label>DNI</label><input id="obDni" inputmode="numeric" placeholder="30123456"></div>
      </div>
      <div class="field"><label>Email</label><input id="obEmail" type="email"></div>
      <div style="background:rgba(0,0,0,0.3);border-radius:var(--radius-md);padding:16px;margin:16px 0;max-height:120px;overflow-y:auto;font-size:12px;color:var(--text-muted)">
        <strong>T√©rminos de uso:</strong> Al registrarte acept√°s que la plataforma puede pausar o eliminar tu cuenta por incumplimiento. Firma digital v√°lida Ley 25.506.
      </div>
      <label style="display:flex;align-items:center;gap:10px;margin:16px 0;cursor:pointer">
        <input type="checkbox" id="obConsentCheck" style="width:16px;height:16px"> <span style="font-size:13px">Acepto los t√©rminos y condiciones</span>
      </label>
      <div style="margin-bottom:16px">
        <div style="font-size:13px;font-weight:600;margin-bottom:8px">Firma digital (Ley 25.506)</div>
        <div class="sig-canvas-wrap"><canvas id="obSigCanvas"></canvas></div>
        <button id="btnObClearSig" class="btn-outline btn-sm" style="margin-top:8px">Borrar firma</button>
      </div>
      <button id="btnObStep1" class="btn-primary">Continuar ‚Üí</button>
    </div>

    <!-- PASO 2 -->
    <div class="ob-content" id="obContent2">
      <div class="ob-title">Nombre de tu financiera</div>
      <div class="field"><label>Nombre</label><input id="obAppName" placeholder="Ej: Financiera P√©rez"></div>
      <div class="field"><label>Ciudad</label><input id="obCity" placeholder="R√≠o Gallegos"></div>
      <div class="field"><label>WhatsApp</label><input id="obWa" placeholder="5492966123456"></div>
      <div style="display:flex;gap:10px;margin-top:24px">
        <button id="btnObBack1" class="btn-outline" style="flex:1">‚Üê Atr√°s</button>
        <button id="btnObStep2" class="btn-primary" style="flex:2">Continuar ‚Üí</button>
      </div>
    </div>

    <!-- PASO 3 -->
    <div class="ob-content" id="obContent3">
      <div class="ob-title">Configuraci√≥n financiera</div>
      <div class="input-row">
        <div class="field"><label>TNA %</label><input id="obTna" inputmode="numeric" value="90"></div>
        <div class="field"><label>D√≠a vto. (1-28)</label><input id="obDueDay" inputmode="numeric" value="10"></div>
      </div>
      <div class="input-row">
        <div class="field"><label>Monto m√≠nimo</label><input id="obMinAmount" value="10000"></div>
        <div class="field"><label>Monto m√°ximo</label><input id="obMaxAmount" value="5000000"></div>
      </div>
      <div class="field"><label>% Gasto otorgamiento</label><input id="obExpenses" value="3"></div>
      <div style="display:flex;gap:12px;margin:16px 0">
        <div style="flex:1;padding:16px;border:2px solid var(--accent-glow);border-radius:var(--radius-md);background:rgba(26,86,219,0.1);cursor:pointer;text-align:center" id="pmOptMP" onclick="selectPayMethod('mp')">
          <div style="font-size:20px">üí≥</div><div style="font-weight:600">Mercado Pago</div>
        </div>
        <div style="flex:1;padding:16px;border:2px solid var(--border-light);border-radius:var(--radius-md);cursor:pointer;text-align:center" id="pmOptManual" onclick="selectPayMethod('manual')">
          <div style="font-size:20px">üè¶</div><div style="font-weight:600">Transferencia</div>
        </div>
      </div>
      <div id="obMpFields">
        <div class="field"><label>Access Token</label><input id="obMpToken" type="password"></div>
        <div class="field"><label>Public Key</label><input id="obMpPublicKey"></div>
      </div>
      <div style="display:flex;gap:10px;margin-top:24px">
        <button id="btnObBack2" class="btn-outline" style="flex:1">‚Üê Atr√°s</button>
        <button id="btnObFinish" class="btn-primary" style="flex:2">‚úì Crear mi cuenta</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL FIRMA (para clientes) -->
<div class="modal-overlay" id="sigModal">
  <div class="modal-box">
    <div class="modal-title">Firma digital del contrato</div>
    <div class="modal-sub">Firm√° con el dedo. Validez legal Ley 25.506.</div>
    <div class="sig-canvas-wrap"><canvas id="sigCanvas"></canvas></div>
    <div class="sig-actions">
      <button id="btnClearSig" class="btn-outline">Borrar</button>
      <button id="btnConfirmSig" class="btn-success" style="flex:2">Confirmar firma</button>
    </div>
    <button id="btnCancelSig" class="btn-outline" style="width:100%">Cancelar</button>
  </div>
</div>

<!-- MODAL ACTIVAR PR√âSTAMO -->
<div class="modal-overlay" id="activateModal">
  <div class="modal-box">
    <div class="modal-title">Activar pr√©stamo</div>
    <div class="modal-sub">Revis√° el resumen antes de activar.</div>
    <div id="activateSummary" class="breakdown-box" style="margin-bottom:20px"></div>
    <div style="display:flex;gap:10px">
      <button id="btnCancelActivate" class="btn-outline" style="flex:1">Cancelar</button>
      <button id="btnConfirmActivate" class="btn-success" style="flex:2">Confirmar activaci√≥n</button>
    </div>
  </div>
</div>

<!-- TOPBAR -->
<header class="topbar">
  <div class="app">
    <div class="topbar-inner">
      <div class="logo" id="logoLink">
        <div class="logo-mark" id="logoMark">P</div>
        <span class="logo-name" id="logoName">Presti<span>fy</span></span>
      </div>
      <nav class="nav-group">
        <button id="btnViewClient" class="nav-btn active">
          <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          <span>Cliente</span>
        </button>
        <button id="btnViewAdmin" class="nav-btn">
          <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          <span>Admin</span>
        </button>
        <button id="btnViewSuperAdmin" class="nav-btn" style="display:none">
          <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><circle cx="12" cy="12" r="3" fill="currentColor"/></svg>
          <span>SuperAdmin</span>
        </button>
        <div class="nav-sep"></div>
        <div class="notif-wrap" id="notifWrap" style="display:none">
          <button class="notif-bell" id="notifBell">
            <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            <span class="notif-badge" id="notifBadge" style="display:none">0</span>
          </button>
          <div class="notif-dropdown" id="notifDropdown">
            <div class="notif-header"><span>Notificaciones</span><button id="btnClearNotifs" class="btn-outline btn-sm">Limpiar</button></div>
            <div class="notif-list" id="notifList"><div class="notif-empty">Sin notificaciones</div></div>
          </div>
        </div>
        <button id="btnResetPass" class="nav-btn">
          <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          <span>Llave</span>
        </button>
        <button id="btnLogout" class="nav-btn danger" style="display:none">
          <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
          <span>Salir</span>
        </button>
      </nav>
    </div>
  </div>
</header>

<!-- ALERT BANNER -->
<div class="alert-banner" id="alertBanner">
  <span>üîî</span>
  <span id="alertBannerText">Nueva solicitud</span>
  <button class="alert-banner-close" id="alertBannerClose">‚úï</button>
</div>

<!-- HERO SECTION -->
<section class="hero" id="heroSection">
  <div>
    <div class="hero-eyebrow" id="heroEyebrow">Prestify ¬∑ Tu financiera, digitalizada</div>
    <h1 class="hero-title">Pr√©stamos personales<br><em>r√°pidos y seguros</em></h1>
    <p class="hero-sub">Simul√°, solicit√° y gestion√° tu pr√©stamo en minutos.</p>
    <div class="hero-badges">
      <div class="badge"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>SSL Seguro</div>
      <div class="badge"><svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Datos protegidos</div>
    </div>
  </div>
  <div class="hero-kpis">
    <div class="kpi-box"><div class="kpi-label">TNA vigente</div><div class="kpi-value" id="heroTna">‚Äî<small>%</small></div></div>
    <div class="kpi-box"><div class="kpi-label">D√≠a de pago</div><div class="kpi-value" id="heroDue">‚Äî<small>del mes</small></div></div>
  </div>
</section>

<!-- MAIN CONTENT -->
<main class="app">

  <!-- CLIENT VIEW -->
  <div id="clientView">
    <div class="lender-brand-header" id="lenderBrandHeader" style="display:none;text-align:center;margin-bottom:20px">
      <div class="lender-brand-name" id="lenderBrandName" style="font-size:32px;font-weight:800;color:var(--brand-color)">Mi Financiera</div>
    </div>

    <div class="client-grid">
      <!-- SIMULADOR -->
      <div class="card">
        <div class="card-title"><svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>Simulador</div>
        <div class="sim-meta">
          <div class="sim-meta-item">TNA <strong id="lblTna">--%</strong></div>
          <div class="sim-meta-item">Vence d√≠a <strong id="lblDue">--</strong></div>
        </div>

        <!-- Modo cliente: slider -->
        <div id="clientAmountWrap" style="display:none">
          <div class="client-amount-display" id="clientAmountDisplay">$50.000</div>
          <input type="range" id="clientAmountSlider" class="client-amount-slider" min="5000" max="1000000" step="5000" value="50000">
          <div class="field"><input id="clientAmountManual" placeholder="$ 50.000"></div>
          <input type="hidden" id="simAmount" value="50000">
        </div>

        <!-- Modo admin: input normal -->
        <div id="adminAmountWrap">
          <div class="field"><label>Monto</label><input id="simAmountInput" class="mono" placeholder="$ 500.000"></div>
        </div>

        <!-- Plazo selector -->
        <div id="adminPlazoWrap"><div class="field"><label>Plazo (meses)</label><select id="simMonths"></select></div></div>
        <div id="clientPillsWrap" style="display:none">
          <div style="margin-bottom:10px;font-weight:600">Eleg√≠ el plazo</div>
          <div class="client-pills-wrap" id="clientPillsContainer"></div>
          <input type="hidden" id="simMonthsHidden">
        </div>

        <button id="btnSim" class="btn-primary" style="margin:16px 0">Calcular cuota</button>
        <div id="simResult"></div>
      </div>

      <!-- SOLICITUD -->
      <div class="card">
        <div class="card-title"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Solicitar</div>
        <div class="input-row">
          <div class="field"><label>Nombre</label><input id="bName"></div>
          <div class="field"><label>DNI</label><input id="bDni" inputmode="numeric"></div>
        </div>
        <div class="input-row">
          <div class="field"><label>Email</label><input id="bEmail" type="email"></div>
          <div class="field"><label>Tel√©fono</label><input id="bPhone" inputmode="tel"></div>
        </div>
        <div class="field"><label>Alias/CBU</label><input id="bAlias"></div>
        <p id="simHintText" style="font-size:12px;color:var(--text-muted);margin:16px 0">Us√° el simulador primero.</p>
        <button id="btnSendReq" class="btn-primary">Enviar solicitud</button>
      </div>

      <!-- MI PR√âSTAMO -->
      <div class="card full-width" id="myloan">
        <div class="card-title"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>Consultar mi pr√©stamo</div>
        <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
          <div class="field" style="flex:1"><label>Ingres√° tu DNI</label><input id="myDni" inputmode="numeric"></div>
          <button id="btnFindMyLoan" class="btn-primary" style="width:auto;padding:12px 24px">Buscar</button>
        </div>
        <div id="myLoanResult"></div>
      </div>
    </div>
  </div>

  <!-- ADMIN VIEW -->
  <div id="adminView" class="admin-wrap" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap">
      <div>
        <h2 style="font-size:20px;font-weight:700">Panel de Administraci√≥n <span id="adminDashTitle" style="color:var(--accent-glow)"></span></h2>
        <p id="adminUserLabel" style="font-size:13px;color:var(--text-muted)"></p>
      </div>
      <button id="btnAdminLogin" class="btn-outline">Iniciar sesi√≥n</button>
    </div>

    <div id="adminGate">
      <div style="text-align:center;padding:40px;background:var(--bg-card);border-radius:var(--radius-lg)">
        <div style="font-size:48px;margin-bottom:16px">üîí</div>
        <h3 style="margin-bottom:8px">Acceso restringido</h3>
        <p style="color:var(--text-muted);margin-bottom:20px">Inici√° sesi√≥n para acceder al panel.</p>
        <button id="btnAdminLogin2" class="btn-primary" style="width:auto;padding:12px 32px">Iniciar sesi√≥n</button>
      </div>
    </div>

    <div id="adminContent" style="display:none">
      <!-- KPIs -->
      <div class="dashboard-grid">
        <div class="dash-card"><div class="dash-icon blue"><svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg></div><div class="dash-label">Capital prestado</div><div class="dash-value" id="kpiInvested">$0</div></div>
        <div class="dash-card"><div class="dash-icon green"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="dash-label">Recuperado</div><div class="dash-value" id="kpiRecovered">$0</div></div>
        <div class="dash-card"><div class="dash-icon red"><svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div><div class="dash-label">En mora</div><div class="dash-value" id="kpiMora">$0</div></div>
        <div class="dash-card"><div class="dash-icon orange"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div><div class="dash-label">Tasa mora</div><div class="dash-value" id="kpiMoraRate">0%</div></div>
        <div class="dash-card"><div class="dash-icon purple"><svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div><div class="dash-label">Rentabilidad</div><div class="dash-value" id="kpiProfit">$0</div></div>
      </div>

      <!-- Tabs -->
      <div class="admin-tabs">
        <button class="tab-btn active" data-tab="Cfg">‚öôÔ∏è Configuraci√≥n</button>
        <button class="tab-btn" data-tab="Pending">‚è≥ Pendientes <span class="pill warn" id="badgePend">0</span></button>
        <button class="tab-btn" data-tab="Pre">üìÑ Preaprobados <span id="badgePre">0</span></button>
        <button class="tab-btn" data-tab="Active">‚úÖ Activos <span id="badgeAct">0</span></button>
        <button class="tab-btn" data-tab="Mora">‚ö†Ô∏è Mora <span class="pill bad" id="badgeMora">0</span></button>
        <button class="tab-btn" data-tab="Comprobantes">üßæ Comprobantes <span id="badgeComp">0</span></button>
        <button class="tab-btn" data-tab="History">üìú Hist√≥rico</button>
      </div>

      <!-- CONTENIDO DE TABS (se llena con JS) -->
      <div class="tab-content visible" id="tabCfg"><div class="card">Cargando configuraci√≥n...</div></div>
      <div class="tab-content" id="tabPending"><div class="card" id="listPend"></div></div>
      <div class="tab-content" id="tabPre"><div class="card" id="listPre"></div></div>
      <div class="tab-content" id="tabActive"><div class="card" id="listAct"></div></div>
      <div class="tab-content" id="tabMora"><div class="card" id="listMora"></div></div>
      <div class="tab-content" id="tabComprobantes"><div class="card" id="listComp"></div></div>
      <div class="tab-content" id="tabHistory"><div class="card" id="listInact"></div></div>
    </div>
  </div>
</main>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<script type="module">
// ========== IMPORTACIONES FIREBASE ==========
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, query, where, orderBy, limit, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import { getStorage, ref as sRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

// ========== CONFIG FIREBASE ==========
const firebaseConfig = {
  apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
  authDomain: "estimapres.firebaseapp.com",
  projectId: "estimapres",
  storageBucket: "estimapres.firebasestorage.app",
  messagingSenderId: "578516597437",
  appId: "1:578516597437:web:f59994b87729aa1cd655d4"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// ========== CONSTANTES ==========
const SUPER_ADMIN_UID = "CuQqbuHWkTWdFPdknVTUAkx5Xri2";
const GASTO_OTORGAMIENTO = 3;
const fmtMoney = n => isNaN(n) || n == null ? "$0" : "$" + Math.round(n).toLocaleString("es-AR");
const digits = v => (v || "").replace(/\D+/g, "");
const nowTS = () => serverTimestamp();
const daysLate = iso => Math.max(0, Math.floor((Date.now() - new Date(iso).getTime()) / 86400000));
const el = id => document.getElementById(id);
function toast(msg, type = "info", dur = 4000) {
  const c = el("toastContainer");
  const t = document.createElement("div");
  t.className = `toast ${type}`;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => t.remove(), dur);
}
function annuity(P, rate, m) {
  const i = (rate / 100) / 12;
  if (i === 0) return P / m;
  return P * i * Math.pow(1 + i, m) / (Math.pow(1 + i, m) - 1);
}
function scheduleRows(L) {
  const due = L.dueDay || 10;
  const base = L.activeAt?.toDate ? L.activeAt.toDate() : new Date();
  const gasto = L.gastoOtorgAmt || Math.round((L.amount || 0) * GASTO_OTORGAMIENTO / 100);
  const capFin = L.capitalFinanciar || (L.amount || 0) + gasto;
  const inst = (L.installment && L.installment > 0) ? L.installment : Math.round(annuity(capFin, L.tna, L.months));
  return Array.from({ length: L.months }, (_, k) => {
    const d = new Date(base.getFullYear(), base.getMonth() + k + 1, 1);
    d.setDate(Math.min(due, 28));
    return { n: k + 1, due: d.toISOString().slice(0, 10), amount: inst, paid: (L.paidCount || 0) > k };
  });
}

// ========== ESTADO GLOBAL ==========
let gUser = null, gLenderId = null, gRefLenderId = null;
let gSettings = { tna: null, dueDay: null, appName: "Prestify", city: "", expenses: 0, wa: "", logoBase64: "", mpToken: "", mpPublicKey: "", status: "activo", plazos: [3, 6, 9, 12, 18, 24], brandColor: "#1A56DB", maxAmount: 1000000 };
let gActivateLoan = null, inactTab = "paid";
let gNotifications = [], gSnapshotUnsub = null, gStatusUnsub = null, knownPendingIds = new Set();
let gObSigData = null, gObPayMethod = "mp";

// ========== DETECTAR ?ref= ==========
(() => {
  const params = new URLSearchParams(location.search);
  gRefLenderId = params.get("ref") || null;
  if (gRefLenderId) sessionStorage.setItem("prestify_ref", gRefLenderId);
  else {
    const stored = sessionStorage.getItem("prestify_ref");
    if (stored) gRefLenderId = stored;
  }
})();

// ========== UTILIDADES ==========
const effectiveLid = () => gLenderId || gRefLenderId;
const loanQ = (...c) => query(collection(db, "loans"), where("lenderId", "==", effectiveLid()), ...c);
const settRef = () => doc(db, "settings", effectiveLid());
const lenderRef = id => doc(db, "lenders", id);
const hasMpToken = () => !!(gSettings.mpToken && gSettings.mpToken.length > 10);

function applyBranding() {
  const name = gSettings.appName || "Prestify";
  document.title = name + " ¬∑ Tu financiera";
  const mark = el("logoMark");
  if (mark) {
    if (gSettings.logoBase64) mark.innerHTML = `<img src="${gSettings.logoBase64}" style="width:100%;height:100%;object-fit:cover">`;
    else mark.textContent = name.charAt(0).toUpperCase();
  }
  const ln = el("logoName");
  if (ln) ln.innerHTML = name.slice(0, Math.ceil(name.length / 2)) + "<span>" + name.slice(Math.ceil(name.length / 2)) + "</span>";
  document.documentElement.style.setProperty("--brand-color", gSettings.brandColor || "#1A56DB");
  
  if (gRefLenderId && !gLenderId) {
    document.body.classList.add("client-mode");
    el("lenderBrandHeader").style.display = "";
    el("lenderBrandName").textContent = name;
    el("clientAmountWrap").style.display = "";
    el("adminAmountWrap").style.display = "none";
    el("adminPlazoWrap").style.display = "none";
    el("clientPillsWrap").style.display = "";
    el("heroSection").style.display = "none";
    const slider = el("clientAmountSlider");
    if (slider) {
      slider.max = gSettings.maxAmount || 1000000;
      slider.value = Math.min(slider.value, slider.max);
      el("clientAmountDisplay").textContent = "$" + Number(slider.value).toLocaleString("es-AR");
    }
  }
}

async function loadSettings() {
  if (!effectiveLid()) return;
  try {
    const s = await getDoc(settRef());
    if (s.exists()) gSettings = { ...gSettings, ...s.data() };
  } catch { }
  if (gRefLenderId && !gLenderId) {
    const snap = await getDoc(lenderRef(gRefLenderId));
    if (snap.exists()) gSettings = { ...gSettings, ...snap.data() };
  }
  applyBranding();
  
  // Actualizar UI
  const sv = (id, v) => { const e = el(id); if (e) e.value = v || ""; };
  sv("cfgTna", gSettings.tna); sv("cfgDue", gSettings.dueDay); sv("cfgAppName", gSettings.appName);
  sv("cfgCity", gSettings.city); sv("cfgExpenses", gSettings.expenses); sv("cfgWa", gSettings.wa);
  sv("cfgMaxAmount", gSettings.maxAmount);
  el("lblTna").textContent = (gSettings.tna || "--") + "%";
  el("lblDue").textContent = gSettings.dueDay || "--";
  el("heroTna").innerHTML = gSettings.tna ? gSettings.tna + "<small>%</small>" : "‚Äî<small>%</small>";
  el("heroDue").innerHTML = gSettings.dueDay ? gSettings.dueDay + "<small>del mes</small>" : "‚Äî<small>del mes</small>";
  
  // Plazos checkboxes
  if (Array.isArray(gSettings.plazos)) {
    for (let n = 1; n <= 24; n++) {
      const cb = el(`plazo${n}`);
      if (cb) cb.checked = gSettings.plazos.includes(n);
    }
  }
  // Select de plazos
  const sel = el("simMonths");
  if (sel) {
    const plazos = (gSettings.plazos?.length ? gSettings.plazos : [3, 6, 9, 12, 18, 24]).sort((a, b) => a - b);
    sel.innerHTML = "<option value=''>Seleccion√° un plazo</option>";
    plazos.forEach(n => sel.innerHTML += `<option value="${n}">${n} ${n === 1 ? "mes" : "meses"}</option>`);
  }
}

// ========== SUSPENDIDO / PENDIENTE ==========
function checkSuspended() {
  if (gSettings.status === "pausado") {
    el("suspendedOverlay").classList.add("show");
    el("pendingOverlay").classList.remove("show");
    return true;
  }
  el("suspendedOverlay").classList.remove("show");
  return false;
}
function checkPending() {
  if (gSettings.status === "pendiente") {
    el("pendingOverlay").classList.add("show");
    el("suspendedOverlay").classList.remove("show");
    return true;
  }
  el("pendingOverlay").classList.remove("show");
  return false;
}

// ========== ONBOARDING ==========
function initObCanvas() {
  const canvas = el("obSigCanvas");
  if (!canvas) return;
  canvas.width = canvas.parentElement.clientWidth || 460;
  canvas.height = 150;
  const ctx = canvas.getContext("2d");
  ctx.strokeStyle = "#3B7CF6";
  ctx.lineWidth = 2.5;
  let drawing = false, lx = 0, ly = 0;
  const pos = e => {
    const r = canvas.getBoundingClientRect();
    const s = e.touches ? e.touches[0] : e;
    return { x: s.clientX - r.left, y: s.clientY - r.top };
  };
  canvas.onmousedown = e => { drawing = true; const p = pos(e); lx = p.x; ly = p.y; };
  canvas.onmousemove = e => {
    if (!drawing) return;
    const p = pos(e);
    ctx.beginPath();
    ctx.moveTo(lx, ly);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    lx = p.x; ly = p.y;
  };
  canvas.onmouseup = canvas.onmouseleave = () => drawing = false;
  canvas.ontouchstart = e => { e.preventDefault(); drawing = true; const p = pos(e); lx = p.x; ly = p.y; };
  canvas.ontouchmove = e => { e.preventDefault(); if (!drawing) return; const p = pos(e); ctx.beginPath(); ctx.moveTo(lx, ly); ctx.lineTo(p.x, p.y); ctx.stroke(); lx = p.x; ly = p.y; };
  canvas.ontouchend = e => { e.preventDefault(); drawing = false; };
}
function setObStep(step) {
  [1, 2, 3].forEach(i => {
    el(`obStep${i}`).className = "ob-step" + (i < step ? " done" : i === step ? " active" : "");
    el(`obContent${i}`).className = "ob-content" + (i === step ? " active" : "");
  });
}
window.selectPayMethod = function (method) {
  gObPayMethod = method;
  el("pmOptMP").style.borderColor = method === "mp" ? "var(--accent-glow)" : "var(--border-light)";
  el("pmOptManual").style.borderColor = method === "manual" ? "var(--accent-glow)" : "var(--border-light)";
  el("obMpFields").style.display = method === "mp" ? "" : "none";
};
el("btnObClearSig")?.addEventListener("click", () => {
  const c = el("obSigCanvas");
  c.getContext("2d").clearRect(0, 0, c.width, c.height);
  gObSigData = null;
});
el("btnObStep1")?.addEventListener("click", () => {
  const name = (el("obName").value || "").trim();
  const dni = digits(el("obDni").value);
  const email = (el("obEmail").value || "").trim();
  if (!name || !dni || !email) return toast("Complet√° todos los campos", "err");
  if (!el("obConsentCheck").checked) return toast("Deb√©s aceptar los t√©rminos", "err");
  const canvas = el("obSigCanvas");
  const data = canvas.getContext("2d").getImageData(0, 0, canvas.width, canvas.height).data;
  if (!Array.from(data).some((v, i) => i % 4 === 3 && v > 0)) return toast("Dibuj√° tu firma", "err");
  gObSigData = canvas.toDataURL("image/png");
  setObStep(2);
});
el("btnObBack1")?.addEventListener("click", () => setObStep(1));
el("btnObStep2")?.addEventListener("click", () => {
  if (!(el("obAppName").value || "").trim()) return toast("Ingres√° el nombre de tu financiera", "err");
  setObStep(3);
});
el("btnObBack2")?.addEventListener("click", () => setObStep(2));
el("btnObFinish")?.addEventListener("click", async () => {
  if (!gLenderId) return toast("Error de sesi√≥n", "err");
  const btn = el("btnObFinish");
  btn.disabled = true; btn.textContent = "Guardando...";
  try {
    const cfg = {
      lenderId: gLenderId,
      appName: (el("obAppName").value || "Prestify").trim(),
      city: (el("obCity").value || "").trim(),
      tna: Number(digits(el("obTna").value)),
      dueDay: Math.min(28, Math.max(1, Number(digits(el("obDueDay").value)))),
      expenses: Number(el("obExpenses").value || 3),
      wa: (el("obWa").value || "").trim(),
      status: "pendiente",
      plazos: [3, 6, 9, 12, 18, 24],
      onboardingDone: true,
      operator: { name: (el("obName").value || "").trim(), dni: digits(el("obDni").value), email: (el("obEmail").value || "").trim(), signatureImg: gObSigData },
      updatedAt: nowTS()
    };
    if (gObPayMethod === "mp") {
      const tok = (el("obMpToken").value || "").trim();
      const pub = (el("obMpPublicKey").value || "").trim();
      if (tok) cfg.mpToken = tok;
      if (pub) cfg.mpPublicKey = pub;
    }
    await Promise.all([setDoc(settRef(), cfg, { merge: true }), setDoc(lenderRef(gLenderId), cfg, { merge: true })]);
    Object.assign(gSettings, cfg);
    applyBranding();
    el("onboardingOverlay").classList.remove("show");
    toast("‚úÖ Registro completado. En espera de activaci√≥n.", "ok", 6000);
    checkPending();
  } catch (e) {
    toast("Error al guardar", "err");
    console.error(e);
    btn.disabled = false; btn.textContent = "‚úì Crear mi cuenta";
  }
});

// ========== AUTH ==========
function showView(v) {
  el("landingView").classList.remove("show");
  el("superadminView").style.display = "none";
  el("clientView").style.display = v === "client" ? "" : "none";
  el("heroSection").style.display = v === "client" ? "" : "none";
  el("adminView").style.display = v === "admin" ? "" : "none";
  if (v === "superadmin") el("superadminView").style.display = "";
  document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
  if (v === "client") el("btnViewClient").classList.add("active");
  if (v === "admin") el("btnViewAdmin").classList.add("active");
  if (v === "superadmin") el("btnViewSuperAdmin")?.classList.add("active");
}
el("btnViewClient").onclick = () => showView("client");
el("btnViewAdmin").onclick = () => showView("admin");
el("btnViewSuperAdmin")?.addEventListener("click", () => { showView("superadmin"); loadSuperAdmin(); });

async function doLogin() {
  const email = prompt("Email de administrador:") || "";
  const pass = prompt("Contrase√±a:") || "";
  if (!email || !pass) return;
  try {
    await signInWithEmailAndPassword(auth, email, pass);
    toast("Sesi√≥n iniciada", "ok");
  } catch { toast("Credenciales incorrectas", "err"); }
}
el("btnAdminLogin").onclick = doLogin;
el("btnAdminLogin2").onclick = doLogin;
el("btnLogout").onclick = () => { signOut(auth); };
el("btnPendingLogout").onclick = () => { signOut(auth); };
el("btnResetPass").onclick = async () => {
  const email = prompt("Ingres√° tu email:");
  if (!email) return;
  try { await sendPasswordResetEmail(auth, email); toast("Email de recuperaci√≥n enviado", "ok"); }
  catch { toast("No se pudo enviar", "err"); }
};

// ========== SUPERADMIN ==========
async function loadSuperAdmin() {
  const listEl = el("saLendersList");
  if (!listEl) return;
  listEl.innerHTML = "<div class='sa-loading'>Cargando prestamistas...</div>";
  try {
    const lendersSnap = await getDocs(collection(db, "lenders"));
    const lenders = [];
    lendersSnap.forEach(d => lenders.push({ id: d.id, ...d.data() }));
    
    const loansSnap = await getDocs(collection(db, "loans"));
    const totalLoans = loansSnap.size;
    const loansByLender = {};
    loansSnap.forEach(d => { const ld = d.data().lenderId; if (ld) loansByLender[ld] = (loansByLender[ld] || 0) + 1; });

    const total = lenders.length;
    const activos = lenders.filter(l => l.status === "activo").length;
    const pendientes = lenders.filter(l => l.status === "pendiente").length;
    const pausados = lenders.filter(l => l.status === "pausado").length;
    
    el("saCountLenders").textContent = total;
    el("saCountActive").textContent = activos;
    el("saCountPending").textContent = pendientes;
    el("saCountPaused").textContent = pausados;
    el("saCountLoans").textContent = totalLoans;

    if (!lenders.length) {
      listEl.innerHTML = "<div class='empty'>No hay prestamistas</div>";
      return;
    }

    lenders.sort((a, b) => {
      const order = { pendiente: 0, activo: 1, pausado: 2 };
      return (order[a.status] ?? 3) - (order[b.status] ?? 3);
    });

    listEl.innerHTML = lenders.map(l => {
      const status = l.status || "pendiente";
      const pillClass = status === "activo" ? "activo" : status === "pendiente" ? "pendiente" : "pausado";
      const pillLabel = status === "activo" ? "‚úì Activo" : status === "pendiente" ? "‚è≥ Pendiente" : "‚õî Pausado";
      const operatorName = l.operator?.name || l.appName || "‚Äî";
      const operatorEmail = l.operator?.email || l.email || "‚Äî";
      const prestamos = loansByLender[l.id] || 0;
      let botones = "";
      if (status === "pendiente") {
        botones = `<button class="sa-action-btn sa-btn-activate" onclick="saSetStatus('${l.id}','activo')">‚úì Aprobar</button>`;
      } else if (status === "activo") {
        botones = `<button class="sa-action-btn sa-btn-suspend" onclick="saSetStatus('${l.id}','pausado')">‚õî Pausar</button>`;
      } else if (status === "pausado") {
        botones = `<button class="sa-action-btn sa-btn-activate" onclick="saSetStatus('${l.id}','activo')">‚Ü© Reactivar</button>`;
      }
      botones += `<button class="sa-action-btn sa-btn-suspend" style="border-color:rgba(239,68,68,0.3)" onclick="saEliminar('${l.id}')">‚úï Eliminar</button>`;
      return `
        <div class="sa-row">
          <div><span class="sa-lender-name">${operatorName}</span><div class="sa-lender-email">${operatorEmail}</div></div>
          <div><div>üìû ${l.wa || "‚Äî"}</div><div>üí∞ ${prestamos} pr√©stamos</div></div>
          <div><span class="sa-status-pill ${pillClass}">${pillLabel}</span></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">${botones}</div>
        </div>
      `;
    }).join("");
  } catch (e) {
    listEl.innerHTML = `<div class='empty'>Error: ${e.message}</div>`;
    console.error(e);
  }
}
window.saSetStatus = async (lenderId, newStatus) => {
  try {
    await setDoc(doc(db, "lenders", lenderId), { status: newStatus, updatedAt: nowTS() }, { merge: true });
    await setDoc(doc(db, "settings", lenderId), { status: newStatus, updatedAt: nowTS() }, { merge: true });
    toast(`Prestamista ${newStatus === "activo" ? "activado" : "suspendido"}`, newStatus === "activo" ? "ok" : "warn");
    loadSuperAdmin();
  } catch (e) { toast("Error: " + e.message, "err"); }
};
window.saEliminar = async (lenderId) => {
  if (!confirm("¬øEliminar PERMANENTEMENTE este prestamista y todos sus pr√©stamos?")) return;
  try {
    const loansSnap = await getDocs(query(collection(db, "loans"), where("lenderId", "==", lenderId)));
    const batch = writeBatch(db);
    loansSnap.docs.forEach(d => batch.delete(d.ref));
    batch.delete(doc(db, "settings", lenderId));
    batch.delete(doc(db, "lenders", lenderId));
    await batch.commit();
    toast("Prestamista eliminado", "ok");
    loadSuperAdmin();
  } catch (e) { toast("Error: " + e.message, "err"); }
};
el("btnSaLogout")?.addEventListener("click", () => signOut(auth));

// ========== ON AUTH STATE CHANGE ==========
onAuthStateChanged(auth, async u => {
  gUser = u;
  gLenderId = u ? u.uid : null;
  
  if (u && u.uid === SUPER_ADMIN_UID) {
    showView("superadmin");
    loadSuperAdmin();
    return;
  }

  if (u) {
    el("adminGate").style.display = "none";
    el("adminContent").style.display = "";
    el("btnLogout").style.display = "";
    el("notifWrap").style.display = "";
    el("adminUserLabel").textContent = `Sesi√≥n: ${u.email}`;
    await loadSettings();
    if (checkSuspended() || checkPending()) return;
    const lenderSnap = await getDoc(lenderRef(gLenderId));
    if (!lenderSnap.exists() || !lenderSnap.data().onboardingDone) {
      el("onboardingOverlay").classList.add("show");
      setTimeout(initObCanvas, 200);
    } else {
      showView("admin");
      // Cargar tabs (simplificado)
      el("tabCfg").innerHTML = "<div class='card'>Configuraci√≥n cargada</div>";
      el("listPend").innerHTML = "<div class='empty'>Sin pendientes</div>";
    }
  } else {
    el("adminGate").style.display = "";
    el("adminContent").style.display = "none";
    el("btnLogout").style.display = "none";
    el("notifWrap").style.display = "none";
    if (!gRefLenderId) showLandingPage();
    else { showView("client"); await loadSettings(); }
  }
});

function showLandingPage() {
  el("landingView").classList.add("show");
  el("heroSection").style.display = "none";
  el("clientView").style.display = "none";
  el("adminView").style.display = "none";
}
el("btnLandingRegister")?.addEventListener("click", () => el("registerModalOverlay").classList.add("show"));
el("btnLandingRegister2")?.addEventListener("click", () => el("registerModalOverlay").classList.add("show"));
el("btnCloseRegisterModal")?.addEventListener("click", () => el("registerModalOverlay").classList.remove("show"));
el("btnSwitchToLogin")?.addEventListener("click", (e) => {
  e.preventDefault();
  el("registerModalOverlay").classList.remove("show");
  showView("admin");
});
el("btnDoRegister")?.addEventListener("click", async () => {
  const email = (el("regEmail").value || "").trim();
  const pass = (el("regPassword").value || "").trim();
  const passC = (el("regPasswordConfirm").value || "").trim();
  if (!email || !pass) return toast("Complet√° email y contrase√±a", "err");
  if (pass.length < 6) return toast("M√≠nimo 6 caracteres", "err");
  if (pass !== passC) return toast("Las contrase√±as no coinciden", "err");
  try {
    await createUserWithEmailAndPassword(auth, email, pass);
    el("registerModalOverlay").classList.remove("show");
    toast("‚úÖ Cuenta creada. Complet√° el onboarding.", "ok");
  } catch (e) {
    let msg = "Error al crear cuenta";
    if (e.code === "auth/email-already-in-use") msg = "Email ya registrado";
    toast(msg, "err");
  }
});

// ========== SIMULADOR ==========
el("btnSim").onclick = () => {
  const monto = Number(digits(el("simAmountInput")?.value || el("simAmount")?.value || ""));
  const meses = Number(el("simMonths")?.value || el("simMonthsHidden")?.value || 0);
  if (!monto || !meses) return toast("Complet√° monto y plazo", "err");
  const gasto = Math.round(monto * GASTO_OTORGAMIENTO / 100);
  const capital = monto + gasto;
  const cuota = Math.round(annuity(capital, gSettings.tna, meses));
  const total = cuota * meses;
  const neto = monto - Math.round(monto * (gSettings.expenses || 0) / 100);
  let rows = "";
  for (let i = 1; i <= meses; i++) {
    const d = new Date();
    d.setMonth(d.getMonth() + i);
    d.setDate(Math.min(gSettings.dueDay || 10, 28));
    rows += `<div class="schedule-row"><span class="num">${i}</span><span class="date">${d.toLocaleDateString("es-AR")}</span><span class="amount">${fmtMoney(cuota)}</span><span class="action-col"><span class="pill warn">Pendiente</span></span></div>`;
  }
  el("simResult").innerHTML = `
    <div class="breakdown-box">
      <div class="breakdown-row"><span class="bl">Monto solicitado</span><span class="bv">${fmtMoney(monto)}</span></div>
      <div class="breakdown-row"><span class="bl">Gasto otorg. (${GASTO_OTORGAMIENTO}%)</span><span class="bv">+${fmtMoney(gasto)}</span></div>
      <div class="breakdown-row"><span class="bl">Capital a financiar</span><span class="bv">${fmtMoney(capital)}</span></div>
      <div class="breakdown-row"><span class="bl">Cuota mensual</span><span class="bv" style="color:var(--accent-glow)">${fmtMoney(cuota)}</span></div>
      <div class="breakdown-row"><span class="bl">Neto a recibir</span><span class="bv">${fmtMoney(neto)}</span></div>
      <div class="breakdown-row"><span class="bl">Total a pagar</span><span class="bv">${fmtMoney(total)}</span></div>
    </div>
    <div class="schedule-wrap"><div class="schedule-header"><span>#</span><span>Vencimiento</span><span>Importe</span><span>Estado</span></div>${rows}</div>
  `;
};

// ========== INICIALIZACI√ìN ==========
await loadSettings();

// ========== EVENTOS ADICIONALES ==========
el("clientAmountSlider")?.addEventListener("input", e => {
  const v = e.target.value;
  el("clientAmountDisplay").textContent = "$" + Number(v).toLocaleString("es-AR");
  el("simAmount").value = v;
  el("clientAmountManual").value = "$" + Number(v).toLocaleString("es-AR");
});
el("clientAmountManual")?.addEventListener("input", e => {
  const raw = digits(e.target.value);
  e.target.value = raw ? "$" + Number(raw).toLocaleString("es-AR") : "";
  el("clientAmountSlider").value = raw || 0;
  el("simAmount").value = raw || 0;
  el("clientAmountDisplay").textContent = raw ? "$" + Number(raw).toLocaleString("es-AR") : "$0";
});
</script>
</body>
</html>