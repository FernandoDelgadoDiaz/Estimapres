<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, interactive-widget=resizes-content" />
  <meta name="theme-color" content="#0a2f73" />
  <title>EstimaPres ¬∑ Pr√©stamos en ARS</title>
  <meta name="description" content="Simul√° y solicit√° pr√©stamos en pesos argentinos. Panel admin con TNA centralizada, pr√©stamos y control de cuotas." />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/icons/estimapres-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <style>
    :root{--brand:#0a2f73;--bg:#f6f8fc;--card:#fff;--text:#0f172a}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .app{display:flex;justify-content:center}
    .phone{width:100%;max-width:420px;min-height:100dvh;background:var(--bg)}
    header{position:sticky;top:0;background:var(--brand);color:#fff;padding:12px 14px;display:flex;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0;font-weight:700}
    button{cursor:pointer}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:12px 14px;font-weight:600}
    .btn.alt{background:#0ea5e9}
    .btn.ghost{background:#e2e8f0;color:#0f172a}
    .btn.danger{background:#dc2626;color:#fff}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,.06);padding:14px;margin:12px}
    .label{font-size:13px;color:#475569}
    .input{width:100%;padding:12px 12px;border:1px solid #e2e8f0;border-radius:10px;margin-top:6px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .muted{color:#64748b;font-size:12px}
    .result span{font-weight:700}
    .adminbar{display:flex;gap:8px;align-items:center}
    dialog{border:0;border-radius:12px;padding:0}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #e2e8f0;padding:6px;font-size:12px}
    thead th{background:#f1f5f9;text-align:left}
    .hidden{display:none}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:28px;height:28px;border-radius:8px;background:#fff;display:grid;place-items:center;color:var(--brand);font-weight:900}
    .ok{color:#047857}
    .err{color:#b91c1c}
    details>summary{list-style:none;cursor:pointer;font-weight:600}
    details>summary::-webkit-details-marker{display:none}
  </style>
</head>
<body>
  <div class="app">
    <div class="phone">
      <header>
        <div class="brand"><div class="logo">E</div><h1>EstimaPres</h1></div>
        <div class="adminbar">
          <span id="authStatus" class="muted">No admin</span>
          <button id="btnShowLogin" class="btn ghost" style="padding:8px 10px">Admin</button>
          <button id="btnLogout" class="btn ghost hidden" style="padding:8px 10px">Salir</button>
        </div>
      </header>

      <main>
        <!-- Simulador -->
        <section class="card">
          <h2 style="margin:0 0 8px 0;font-size:16px">Simulador (pesos argentinos)</h2>
          <div class="row">
            <label>
              <div class="label">Monto (ARS)</div>
              <input id="simAmount" type="number" min="1000" step="500" class="input" placeholder="Ej: 200000" />
            </label>
            <label>
              <div class="label">Cuotas (meses)</div>
              <input id="simMonths" type="number" min="1" max="60" class="input" placeholder="Ej: 12" />
            </label>
          </div>
          <div class="muted" style="margin-top:6px">TNA vigente: <b><span id="tnaSpan">‚Äî</span>%</b> ¬∑ Vencimiento: d√≠a 10</div>
          <button id="btnSimulate" class="btn" style="width:100%;margin-top:10px">Simular</button>
        </section>

        <section class="card result">
          <h3 style="margin:0 0 8px 0;font-size:15px">Resultado</h3>
          <div>Monto: <span id="rMonto">‚Äî</span></div>
          <div>Cuotas: <span id="rCuotas">‚Äî</span></div>
          <div>Cuota estimada: <span id="rCuota">‚Äî</span></div>
          <div id="tablaCuotasWrap" class="hidden" style="margin-top:8px">
            <div class="muted" style="margin-bottom:6px">Detalle cuota por cuota</div>
            <div style="overflow:auto">
              <table>
                <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th></tr></thead>
                <tbody id="tablaCuotas"></tbody>
              </table>
            </div>
          </div>
          <div class="muted" style="margin-top:6px">Sistema franc√©s. Valores orientativos. La tasa puede cambiar hasta la aprobaci√≥n.</div>
        </section>

        <!-- Solicitud -->
        <section class="card">
          <h2 style="margin:0 0 8px 0;font-size:16px">Solicitar pr√©stamo</h2>
          <div class="row">
            <label>
              <div class="label">Nombre y apellido</div>
              <input id="rqName" class="input" placeholder="Tu nombre" />
            </label>
            <label>
              <div class="label">DNI</div>
              <input id="rqDni" class="input" placeholder="30123456" />
            </label>
          </div>
          <div class="row">
            <label>
              <div class="label">Email</div>
              <input id="rqEmail" type="email" class="input" placeholder="tucorreo@dominio.com" />
            </label>
            <label>
              <div class="label">Tel√©fono</div>
              <input id="rqPhone" class="input" placeholder="Celular" />
            </label>
          </div>
          <button id="btnSendRequest" class="btn alt" style="width:100%;margin-top:10px">Enviar solicitud</button>
          <div id="rqMsg" class="muted" style="margin-top:8px"></div>
        </section>

        <!-- Panel Admin -->
        <section id="adminPanel" class="hidden">
          <div class="card">
            <h2 style="margin:0 0 8px 0;font-size:16px">Tasa centralizada (TNA %)</h2>
            <div class="row">
              <label>
                <div class="label">TNA actual (%)</div>
                <input id="tnaInput" type="number" step="0.01" class="input" />
              </label>
              <div style="display:flex;align-items:end"><button id="btnSaveTna" class="btn" style="width:100%">Guardar</button></div>
            </div>
            <div class="muted" style="margin-top:6px">Impacta inmediato en el simulador. Los pr√©stamos aprobados conservan la tasa al momento de aprobaci√≥n.</div>
          </div>

          <div class="card">
            <h2 style="margin:0 0 8px 0;font-size:16px">Solicitudes</h2>
            <div id="requestsList" class="muted"></div>
          </div>

          <div class="card">
            <h2 style="margin:0 0 8px 0;font-size:16px">Pr√©stamos</h2>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
              <input id="searchDni" class="input" placeholder="Buscar por DNI" />
              <button id="btnSearchLoans" class="btn ghost">Buscar</button>
            </div>
            <details open>
              <summary>Activos (agrupados por sem√°foro)</summary>
              <div id="loansListActive" class="muted"></div>
            </details>
            <details>
              <summary>Inactivos (terminados/incobrables)</summary>
              <div id="loansListInactive" class="muted"></div>
            </details>
            <div id="loanDetail" class="card hidden" style="margin-top:8px"></div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Login Admin -->
  <dialog id="loginDlg">
    <form method="dialog" style="background:#fff;border-radius:12px;padding:16px;min-width:300px">
      <h3 style="margin:0 0 10px 0">Ingreso Admin</h3>
      <label class="label">Email
        <input id="lgEmail" type="email" class="input" />
      </label>
      <label class="label" style="display:block;margin-top:8px">Password
        <input id="lgPass" type="password" class="input" />
      </label>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="btnLogin" type="button" class="btn">Ingresar</button>
        <button class="btn ghost">Cerrar</button>
      </div>
      <div id="lgMsg" class="muted err"></div>
    </form>
  </dialog><script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
  // ===== PWA (opcional) =====
  if('serviceWorker' in navigator){ window.addEventListener('load',()=> navigator.serviceWorker.register('/sw.js').catch(console.error)); }

  // ===== Firebase =====
  const firebaseConfig={apiKey:"AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",authDomain:"estimapres.firebaseapp.com",projectId:"estimapres",storageBucket:"estimapres.appspot.com",messagingSenderId:"578516597437",appId:"1:578516597437:web:f59994b87729aa1cd655d4"};
  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth(); const db=firebase.firestore();

  // ===== Utils =====
  const $=s=>document.querySelector(s);
  const fmtARS=n=> new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n||0);
  const TNA_FALLBACK = 120;

  function frenchSchedule(principal, months, tna){
    const r=(tna/100)/12; if(r<=0||months<=0) return {installment:0,total:0,schedule:[]};
    const A= principal*r / (1-Math.pow(1+r,-months));
    let balance=principal; const schedule=[];
    for(let k=1;k<=months;k++){
      const interest=balance*r; const capital=A-interest; balance=Math.max(0,balance-capital);
      const due=new Date(); due.setMonth(due.getMonth()+k); due.setDate(10);
      schedule.push({k,installment:+A.toFixed(2),capital:+capital.toFixed(2),interest:+interest.toFixed(2),dueDate:due.toISOString(),paid:false});
    }
    return {installment:+A.toFixed(2), total:+(A*months).toFixed(2), schedule};
  }

  function computeTotals(schedule){
    const total=schedule.reduce((a,b)=>a+(b.installment||0),0);
    const pagado=schedule.filter(x=>x.paid).reduce((a,b)=>a+(b.installment||0),0);
    return {total,pagado,restante: total-pagado};
  }

  function loanStatusColor(schedule){
    const today=new Date(); let maxDelay=0;
    schedule.forEach(c=>{ if(!c.paid){ const due=new Date(c.dueDate); const diff=Math.floor((today-due)/(1000*60*60*24)); if(diff>maxDelay) maxDelay=diff; } });
    if(maxDelay<=5) return 'üü¢'; if(maxDelay<=10) return 'üü°'; return 'üî¥';
  }
  function statusKey(s){return s==='üü¢'?'green':s==='üü°'?'yellow':'red';}
  function colorEmoji(k){return k==='green'?'üü¢':k==='yellow'?'üü°':'üî¥';}
  function colorTitle(k){return k==='green'?'Al d√≠a':k==='yellow'?'Mora 6‚Äì10 d√≠as':'Mora >10 d√≠as';}

  // ===== TNA realtime =====
  const tnaSpan=$('#tnaSpan'); const tnaInput=$('#tnaInput');
  db.doc('settings/global').onSnapshot(doc=>{
    const tna = doc.data()?.tna ?? TNA_FALLBACK; tnaSpan.textContent=tna; if(tnaInput) tnaInput.value=tna;
  }, _=>{ tnaSpan.textContent=TNA_FALLBACK; if(tnaInput) tnaInput.value=TNA_FALLBACK; });

  // ===== Simular =====
  $('#btnSimulate').addEventListener('click', async ()=>{
    const amount=+$('#simAmount').value; const months=+$('#simMonths').value;
    if(!amount||!months) return alert('Complet√° monto y cuotas');
    let tna=TNA_FALLBACK; try{ const d=await db.doc('settings/global').get(); tna=d.data()?.tna??TNA_FALLBACK; }catch(e){}
    const {installment, schedule}=frenchSchedule(amount,months,tna);
    $('#rMonto').textContent=fmtARS(amount); $('#rCuotas').textContent=months; $('#rCuota').textContent=installment?fmtARS(installment):'‚Äî';
    const tbody=$('#tablaCuotas'); tbody.innerHTML='';
    schedule.forEach(it=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.k}</td><td>${new Date(it.dueDate).toLocaleDateString('es-AR')}</td><td>${fmtARS(it.installment)}</td>`; tbody.appendChild(tr); });
    $('#tablaCuotasWrap').classList.remove('hidden');
  });

  // ===== Enviar solicitud =====
  $('#btnSendRequest').addEventListener('click', async ()=>{
    const name=$('#rqName').value.trim(), dni=$('#rqDni').value.trim(), email=$('#rqEmail').value.trim(), phone=$('#rqPhone').value.trim();
    const amount=+$('#simAmount').value, months=+$('#simMonths').value; const msg=$('#rqMsg'); msg.textContent='';
    if(!name||!dni||!email||!amount||!months){ msg.textContent='Complet√° datos y simulaci√≥n.'; msg.className='muted err'; return; }
    let tna=TNA_FALLBACK; try{ const d=await db.doc('settings/global').get(); tna=d.data()?.tna??TNA_FALLBACK; }catch(e){}
    const {installment}=frenchSchedule(amount,months,tna);
    try{
      await db.collection('loan_requests').add({name,dni,email,phone,amount,months,tnaSnapshot:tna,installment,status:'pending',createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      msg.textContent='Solicitud enviada. Un admin la revisar√°.'; msg.className='muted ok';
    }catch(e){ msg.textContent='No se pudo enviar: '+(e.message||e); msg.className='muted err'; }
  });

  // ===== Admin auth =====
  const loginDlg=$('#loginDlg');
  $('#btnShowLogin').addEventListener('click',()=>loginDlg.showModal());
  $('#btnLogin').addEventListener('click', async ()=>{ $('#lgMsg').textContent=''; try{ await auth.signInWithEmailAndPassword($('#lgEmail').value,$('#lgPass').value); loginDlg.close(); }catch(e){ $('#lgMsg').textContent=e.message; } });
  $('#btnLogout').addEventListener('click',()=> auth.signOut().then(()=>location.reload()));

  auth.onAuthStateChanged(user=>{
    const adminPanel=$('#adminPanel'); const authStatus=$('#authStatus'); const btnLogout=$('#btnLogout');
    if(user){ adminPanel.classList.remove('hidden'); authStatus.textContent='Admin'; btnLogout.classList.remove('hidden'); mountAdminData(); }
    else { adminPanel.classList.add('hidden'); authStatus.textContent='No admin'; btnLogout.classList.add('hidden'); }
  });

  // ===== Admin data =====
  function renderRequest(id,r){
    const div=document.createElement('div');
    div.style.cssText='display:flex;justify-content:space-between;align-items:center;border:1px solid #e2e8f0;border-radius:10px;padding:8px;margin:6px 0;';
    div.innerHTML=`<div>
      <div style="font-weight:700">${r.name} ¬∑ DNI ${r.dni}</div>
      <div class="muted">${fmtARS(r.amount)} ¬∑ ${r.months} cuotas ¬∑ TNA ${r.tnaSnapshot}% ¬∑ Cuota ${fmtARS(r.installment)}</div>
      <div class="muted">${r.email}${r.phone? ' ¬∑ '+r.phone:''}</div>
    </div>
    <div style="display:flex;gap:8px">
      <button data-approve="${id}" class="btn" style="padding:8px 10px">Aprobar</button>
      <button data-reject="${id}" class="btn danger" style="padding:8px 10px">Rechazar</button>
    </div>`;
    return div;
  }

  async function approveRequest(id,r){
    const {schedule}=frenchSchedule(r.amount,r.months,r.tnaSnapshot);
    const loan={
      borrower:{name:r.name,dni:r.dni,email:r.email,phone:r.phone||''},
      principal:r.amount, months:r.months, tna:r.tnaSnapshot,
      status:'active', schedule,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    };
    const batch=db.batch(); const loanRef=db.collection('loans').doc();
    batch.set(loanRef,loan);
    batch.update(db.collection('loan_requests').doc(id),{status:'approved',approvedLoanId:loanRef.id,decidedAt:firebase.firestore.FieldValue.serverTimestamp()});
    await batch.commit(); alert('Pr√©stamo aprobado'); loadLoans();
  }
  async function rejectRequest(id){ await db.collection('loan_requests').doc(id).update({status:'rejected',decidedAt:firebase.firestore.FieldValue.serverTimestamp()}); }

  function renderLoanRow(it,loanId){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.k}</td>
      <td>${new Date(it.dueDate).toLocaleDateString('es-AR')}</td>
      <td>${fmtARS(it.installment)}</td>
      <td>${fmtARS(it.capital)}</td>
      <td>${fmtARS(it.interest)}</td>
      <td><label style="display:inline-flex;gap:6px;align-items:center"><input type="checkbox" data-loan="${loanId}" data-k="${it.k}" ${it.paid?'checked':''} /><span>${it.paid?'Pagada':'Pendiente'}</span></label></td>`;
    return tr;
  }

  function renderLoanDetail(loanId,L){
    const box=$('#loanDetail'); box.classList.remove('hidden');
    const head=`<div style="font-weight:700">${loanStatusColor(L.schedule)} ${L.borrower.name} ¬∑ DNI ${L.borrower.dni} ¬∑ Estado: ${L.status}</div>
      <div class="muted">Principal ${fmtARS(L.principal)} ¬∑ ${L.months} cuotas ¬∑ TNA ${L.tna}%</div>`;
    const {total,pagado,restante}=computeTotals(L.schedule);
    const tot=`<div class="muted" style="margin:6px 0 10px 0">Total pr√©stamo: ${fmtARS(total)} ¬∑ Pagado: ${fmtARS(pagado)} ¬∑ Restante: ${fmtARS(restante)}</div>`;
    const table=`<div style="overflow:auto"><table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Capital</th><th>Inter√©s</th><th>Estado</th></tr></thead><tbody id="loanRows"></tbody></table></div>`;
    const actions = L.status==='active' ? `<div style="margin-top:8px"><button id="btnMarkInactive" class="btn ghost">Marcar como inactivo</button></div>` : '';
    box.innerHTML = head + tot + table + actions;

    const tbody=box.querySelector('#loanRows'); tbody.innerHTML='';
    L.schedule.forEach(it=> tbody.appendChild(renderLoanRow(it,loanId)) );

    // toggle pago
    tbody.querySelectorAll('input[type="checkbox"]').forEach(chk=>{
      chk.onchange = async ()=>{
        const k=+chk.getAttribute('data-k'); const ref=db.collection('loans').doc(loanId);
        const snap=await ref.get(); const C=snap.data();
        const schedule=C.schedule.map(x=> x.k===k ? ({...x,paid:chk.checked,paidAt: chk.checked? new Date().toISOString(): null}) : x);
        await ref.update({schedule});
        const t=computeTotals(schedule); box.querySelector('.muted').nextElementSibling?.remove; // no-op
        box.querySelectorAll('.muted')[1].textContent = `Total pr√©stamo: ${fmtARS(t.total)} ¬∑ Pagado: ${fmtARS(t.pagado)} ¬∑ Restante: ${fmtARS(t.restante)}`;
        chk.nextElementSibling.textContent = chk.checked? 'Pagada' : 'Pendiente';
      };
    });

    // marcar inactivo
    if(L.status==='active'){
      box.querySelector('#btnMarkInactive').onclick = async ()=>{
        await db.collection('loans').doc(loanId).update({status:'inactive',inactivatedAt:firebase.firestore.FieldValue.serverTimestamp()});
        alert('Pr√©stamo marcado como inactivo'); loadLoans(); box.classList.add('hidden');
      };
    }
  }

  async function loadLoans(){
    const activeBox=$('#loansListActive'); const inactiveBox=$('#loansListInactive'); const detail=$('#loanDetail');
    activeBox.innerHTML='Cargando‚Ä¶'; inactiveBox.innerHTML=''; detail.classList.add('hidden'); detail.innerHTML='';

    const snap=await db.collection('loans').orderBy('createdAt','desc').get();
    const groups={green:[],yellow:[],red:[]};

    snap.docs.forEach(doc=>{
      const L=doc.data();
      if(L.status==='active'){
        const k=statusKey(loanStatusColor(L.schedule));
        groups[k].push({id:doc.id,L});
      } else {
        const item=document.createElement('div'); item.className='card';
        item.innerHTML=`<div style="font-weight:700">üü¶ ${L.borrower.name} ¬∑ DNI ${L.borrower.dni}</div>
          <div class="muted">Principal ${fmtARS(L.principal)} ¬∑ ${L.months} cuotas ¬∑ TNA ${L.tna}%</div>
          <div><button class="btn ghost" data-open="${doc.id}">Ver</button></div>`;
        inactiveBox.appendChild(item);
      }
    });

    activeBox.innerHTML='';
    ;['green','yellow','red'].forEach(k=>{
      const arr=groups[k]; if(!arr.length) return;
      const sec=document.createElement('div');
      sec.innerHTML=`<div style="font-weight:700;margin:6px 0">${colorEmoji(k)} ${colorTitle(k)}</div>`;
      arr.forEach(({id,L})=>{
        const item=document.createElement('div'); item.className='card';
        item.innerHTML=`<div style="font-weight:700">${colorEmoji(k)} ${L.borrower.name} ¬∑ DNI ${L.borrower.dni}</div>
          <div class="muted">Principal ${fmtARS(L.principal)} ¬∑ ${L.months} cuotas ¬∑ TNA ${L.tna}%</div>
          <div><button class="btn ghost" data-open="${id}">Ver</button></div>`;
        sec.appendChild(item);
      });
      activeBox.appendChild(sec);
    });

    if(!activeBox.innerHTML) activeBox.textContent='Sin pr√©stamos activos';
    if(!inactiveBox.innerHTML) inactiveBox.textContent='Sin pr√©stamos inactivos';

    // abrir detalle
    document.querySelectorAll('[data-open]').forEach(btn=>{
      btn.onclick = async ()=>{ const id=btn.getAttribute('data-open'); const d=await db.collection('loans').doc(id).get(); renderLoanDetail(id,d.data()); };
    });
  }

  function mountAdminData(){
    // Solicitudes pendientes
    db.collection('loan_requests').orderBy('createdAt','desc').onSnapshot(snap=>{
      const box=$('#requestsList'); box.innerHTML='';
      snap.docs.forEach(d=>{ const r=d.data(); if(r.status==='pending') box.appendChild(renderRequest(d.id,r)); });
      if(!box.innerHTML) box.textContent='Sin solicitudes pendientes';
      box.querySelectorAll('[data-approve]').forEach(b=>{ b.onclick=async()=>{ const id=b.getAttribute('data-approve'); const doc=await db.collection('loan_requests').doc(id).get(); await approveRequest(id,doc.data()); }; });
      box.querySelectorAll('[data-reject]').forEach(b=> b.onclick=()=>rejectRequest(b.getAttribute('data-reject')));
    });

    // Buscar por DNI (detalle directo)
    $('#btnSearchLoans').onclick = async ()=>{
      const dni=$('#searchDni').value.trim(); if(!dni) return;
      const snap=await db.collection('loans').where('borrower.dni','==',dni).get();
      if(snap.empty){ alert('Sin resultados'); return; }
      const doc=snap.docs[0]; renderLoanDetail(doc.id, doc.data());
    };

    // Cargar listado al entrar
    loadLoans();
  }

  // ===== Guardar TNA =====
  $('#btnSaveTna').addEventListener('click', async ()=>{
    const tna=+$('#tnaInput').value; if(isNaN(tna)||tna<0) return alert('TNA inv√°lida');
    await db.doc('settings/global').set({tna,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
    alert('TNA actualizada');
  });
  </script>
</body>
</html>
```Ó®Å0Ó®Ç