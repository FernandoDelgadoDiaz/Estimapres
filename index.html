<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>EstimaPres ¬∑ Pr√©stamos personales</title>
<link rel="icon" href="assets/ping.png"/>
<style>
  :root{
    --bg1:#0a43c6; --bg2:#0b63f6; --ink:#0b2769;
    --card:#ffffff; --muted:#6b7a99; --ok:#10b981; --bad:#e23a3a; --soft:#eef4ff;
    --ring:#dbe3f5; --ring2:#cfe0ff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#0b1b43;background:#f5f7fb}
  .container{max-width:980px;margin:0 auto;padding:0 16px}
  .hero{
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    color:#fff; padding:26px 0 24px; position:relative;
    box-shadow:0 2px 0 rgba(0,0,0,.04) inset,0 -1px 0 rgba(255,255,255,.08) inset;
  }
  .brand-line{display:flex;align-items:center;gap:14px}
  .brand-logo{width:58px;height:58px;border-radius:14px;object-fit:cover;background:#fff;box-shadow:0 6px 16px rgba(0,0,0,.18)}
  .brand-title{font-size:48px;line-height:1;font-weight:900;letter-spacing:.4px}
  .tagline{margin-top:12px;display:inline-block;padding:8px 14px;border-radius:12px;background:rgba(255,255,255,.14)}
  .tagline em{font-style:italic;text-decoration:underline}
  .cta-tight{margin-top:10px}
  .cta-row{display:flex;gap:12px;align-items:center;flex-wrap:nowrap;overflow-x:auto;scrollbar-width:none}
  .cta-row::-webkit-scrollbar{display:none}
  .btn{
    display:inline-flex;align-items:center;gap:8px;font-weight:700;text-decoration:none;cursor:pointer;
    padding:10px 14px;border-radius:14px;border:1.5px solid rgba(255,255,255,.25);color:#fff;background:rgba(255,255,255,.08);
    transition:.15s border-color ease,.15s transform ease
  }
  .btn:hover{border-color:#fff;transform:translateY(-1px)}
  .btn-danger{background:#e23a3a;border-color:#e23a3a}
  .section{margin:22px 0}
  .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(2,19,79,.06);border:1px solid #eef1f8}
  h2{margin:0 0 14px;font-size:40px;letter-spacing:.3px}
  label{display:block;font-weight:800;margin:12px 0 6px;color:var(--ink)}
  input[type=text],input[type=number],input[type=email],input[type=tel]{
    width:100%;padding:14px 14px;border-radius:12px;border:1px solid #e6eaf4;background:#fff;
    font-size:16px;outline:none
  }
  .btn-primary{
    background:var(--ok);border:none;color:#fff;border-radius:14px;padding:12px 18px;font-weight:800;cursor:pointer
  }
  .muted{color:#6e7aa8}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px;border-bottom:1px solid #eef1f6;text-align:left}
  th{color:#0b1b43;font-size:14px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800;font-size:13px}
  .pill.warn{background:#fff4d6;color:#8a5a00;border:1px solid #ffe8a3}
  .pill.ok{background:#e8fff4;color:#065f46;border:1px solid #b6f3da}
  .pill.late{background:#ffe6e6;color:#7f1d1d;border:1px solid #ffc2c2}

  /* Admin est√©tico */
  details > summary{
    list-style:none;cursor:pointer;user-select:none;background:#f7f9ff;border:1px solid var(--ring);
    padding:10px 14px;border-radius:12px;font-weight:800;color:var(--ink);display:flex;align-items:center;gap:8px;margin:10px 0
  }
  details[open] > summary{background:#eef4ff;border-color:var(--ring2)}
  .section-toolbar{display:flex;gap:10px;align-items:center;margin:10px 0}
  .segment{display:inline-flex;gap:6px;padding:4px;border-radius:999px;background:#fff;border:1px solid var(--ring)}
  .segment .seg{border:none;background:transparent;padding:8px 12px;border-radius:999px;font-weight:700;cursor:pointer;color:var(--ink)}
  .segment .seg.active{background:var(--ink);color:#fff}
  .btn-sm{padding:9px 12px;border-radius:12px;border:1px solid #dde3f2;background:#fff;font-weight:700;cursor:pointer}
  .btn-green{background:#10b981;color:#fff;border-color:#10b981}
  .btn-red-ghost{border-color:#fecaca;color:#b91c1c;background:#fff}

  .note{color:#6b7a99}
  .item{border:1px solid #eef1f6;border-radius:12px;padding:12px;margin:10px 0;background:#fff}
  .item .line{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .hidden{display:none !important}
  .right{margin-left:auto}
</style>
</head>
<body>

<header class="hero">
  <div class="container">
    <div class="brand-line">
      <img src="assets/ping.png" alt="EstimaPres" class="brand-logo"/>
      <div class="brand-title">EstimaPres</div>
    </div>

    <!-- Botonera en una sola l√≠nea, justo debajo -->
    <nav class="cta-row cta-tight">
      <a id="btnOpenMyLoan" href="#myloan" class="btn">üîé Ver mi pr√©stamo</a>
      <a id="btnAdmin" href="#admin" class="btn">üõ°Ô∏è Admin</a>
      <a id="btnLogout" href="#" class="btn btn-danger hidden">‚Ü™ Salir</a>
    </nav>

    <div class="tagline">Pr√©stamos personales ¬∑ <em>simple y claro</em></div>
  </div>
</header>

<main class="container">

  <!-- SIMULADOR -->
  <section class="section">
    <div class="card">
      <h2>Simulador</h2>
      <label>Monto</label>
      <input id="simAmount" type="text" inputmode="numeric" placeholder="$ 1.000.000"/>
      <label>Meses</label>
      <input id="simMonths" type="number" placeholder="Ej: 12" min="1" max="60"/>
      <div class="muted" id="simMeta">TNA vigente: ‚Äî% ¬∑ Vencimiento: d√≠a ‚Äî</div>
      <div style="margin-top:10px"><button id="btnSim" class="btn-primary">Simular</button></div>
      <div id="simResult" class="section"></div>
    </div>
  </section>

  <!-- SOLICITAR -->
  <section class="section">
    <div class="card">
      <h2>Solicitar pr√©stamo</h2>
      <label>Tu nombre</label>
      <input id="bName" type="text" placeholder="Juan P√©rez"/>
      <label>DNI</label>
      <input id="bDni" type="text" inputmode="numeric" placeholder="30123456"/>
      <label>Email</label>
      <input id="bMail" type="email" placeholder="tucorreo@mail.com"/>
      <label>Tel√©fono</label>
      <input id="bPhone" type="tel" placeholder="11 2345 6789"/>
      <label>alias o CBU/CVU</label>
      <input id="bCbu" type="text" placeholder="alias o CBU/CVU"/>
      <div style="margin-top:14px"><button id="btnRequest" class="btn-primary">Enviar solicitud</button></div>
      <div class="muted" style="margin-top:8px">Al enviar acept√°s ser contactado por EstimaPres.</div>
    </div>
  </section>

  <!-- ADMIN -->
  <section class="section" id="adminPanel" class="hidden">
    <div class="card">
      <h2>Panel administrador</h2>

      <details open>
        <summary>Configuraci√≥n (TNA y vencimiento)</summary>
        <label>TNA %</label>
        <input id="tnaInput" type="number" min="0" max="500" step="0.01" placeholder="150"/>
        <label>Vencimiento (d√≠a del mes)</label>
        <input id="dueInput" type="number" min="1" max="28" placeholder="10"/>
        <div style="margin-top:10px"><button id="btnSaveSettings" class="btn-primary">Guardar</button></div>
      </details>

      <details>
        <summary>Solicitudes pendientes</summary>
        <div class="section-toolbar">
          <button id="btnReloadPend" class="btn-sm">Recargar</button>
        </div>
        <div id="listPend" class="note">Sin pendientes</div>
      </details>

      <details>
        <summary>Preaprobados</summary>
        <div class="section-toolbar">
          <button id="btnReloadPre" class="btn-sm">Recargar</button>
        </div>
        <div id="listPre" class="note">Sin preaprobados</div>
      </details>

      <details open>
        <summary>Activos</summary>
        <div class="section-toolbar">
          <div class="muted">‚óè Verde: al d√≠a ¬∑ ‚óè Amarillo: 6‚Äì10 d√≠as de mora ¬∑ ‚óè Rojo: &gt;10 d√≠as</div>
          <button id="btnReloadAct" class="btn-sm right">Recargar</button>
        </div>
        <div id="listAct" class="note">Sin activos</div>
      </details>

      <details>
        <summary>Inactivos (finalizados / incobrables)</summary>
        <div class="section-toolbar">
          <div class="segment">
            <button id="btnShowClosed" class="seg active">Cancelados</button>
            <button id="btnShowCharged" class="seg">Incobrables</button>
          </div>
          <button id="btnReloadInac" class="btn-sm right">Recargar</button>
        </div>
        <div id="listInac" class="note">Sin inactivos</div>
      </details>
    </div>
  </section>

  <!-- MI PR√âSTAMO -->
  <section class="section" id="myloan">
    <div class="card">
      <h2>Ver mi pr√©stamo</h2>
      <label>Ingres√° tu DNI</label>
      <input id="myDni" type="text" inputmode="numeric" placeholder="Ej: 30123456"/>
      <div style="margin-top:10px"><button id="btnFindMyLoan" class="btn" style="background:#0b2769;border-color:#0b2769">Consultar</button></div>
      <div id="myLoanResult" class="section"></div>
    </div>
  </section>
</main>

<!-- Firebase SDK (compat para simplicidad) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>

<script>
/* ===========================
   Firebase (CONFIG REAL)
=========================== */
const firebaseConfig = {
  apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
  authDomain: "estimapres.firebaseapp.com",
  projectId: "estimapres",
  storageBucket: "estimapres.firebasestorage.app",
  messagingSenderId: "578516597437",
  appId: "1:578516597437:web:f59994b87729aa1cd655d4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* ===========================
   Utilidades UI / dinero
=========================== */
const $ = s=>document.querySelector(s);
const nowTS = ()=>firebase.firestore.Timestamp.now();
const onlyDigits = v => (v||'').toString().replace(/\D+/g,'');
const money = n => {
  if(Number.isNaN(+n)) n = 0;
  return "$ "+(+n).toLocaleString('es-AR');
};
function maskMoneyInput(inp){
  inp.addEventListener('input', e=>{
    const num = onlyDigits(inp.value);
    inp.value = num ? ("$ "+Number(num).toLocaleString('es-AR')) : "";
  });
}
maskMoneyInput($('#simAmount'));

/* ===========================
   Estado global
=========================== */
const ADMINS = ["fernandogastondelgado81@gmail.com"];
let SETTINGS = { tna: null, dueDay: null };

/* ===========================
   Auth (magic link)
=========================== */
async function ensureAdmin(){
  const u = auth.currentUser;
  if(u && ADMINS.includes((u.email||"").toLowerCase())){
    $('#btnLogout').classList.remove('hidden');
    $('#adminPanel').classList.remove('hidden');
    await loadSettings();
    await loadAllAdmin();
    return true;
  }
  // no logueado -> pedir email
  const email = window.prompt("Ingres√° tu email de administrador:");
  if(!email) return false;
  if(!ADMINS.includes(email.trim().toLowerCase())){
    alert("Email no autorizado."); return false;
  }
  // magic link
  const actionSettings = {
    url: window.location.origin + window.location.pathname + "#admin",
    handleCodeInApp: true
  };
  try{
    window.localStorage.setItem('adminEmail', email);
    await auth.sendSignInLinkToEmail(email, actionSettings);
    alert("Te enviamos un link de acceso. Abrilo desde este dispositivo.");
  }catch(e){ console.error(e); alert("No se pudo iniciar sesi√≥n."); }
  return false;
}
async function checkEmailLink(){
  if(auth.isSignInWithEmailLink(window.location.href)){
    let email = window.localStorage.getItem('adminEmail');
    if(!email){ email = window.prompt("Confirm√° tu email:"); }
    try{
      await auth.signInWithEmailLink(email, window.location.href);
      window.history.replaceState({}, document.title, window.location.pathname);
      $('#btnLogout').classList.remove('hidden');
      $('#adminPanel').classList.remove('hidden');
      await loadSettings(); await loadAllAdmin();
    }catch(e){ console.error(e); alert("No se pudo iniciar sesi√≥n."); }
  }
}
$('#btnAdmin').onclick = async (e)=>{
  e.preventDefault();
  if(!(await ensureAdmin())) return;
};
$('#btnLogout').onclick = async (e)=>{
  e.preventDefault(); await auth.signOut();
  $('#adminPanel').classList.add('hidden');
  $('#btnLogout').classList.add('hidden');
  alert("Sesi√≥n cerrada.");
};
checkEmailLink();

/* ===========================
   Settings (TNA y vencimiento)
=========================== */
async function loadSettings(){
  try{
    const docRef = db.collection('settings').doc('general');
    const snap = await docRef.get();
    if(snap.exists){
      SETTINGS = snap.data();
      $('#tnaInput').value = (SETTINGS.tna ?? "");
      $('#dueInput').value = (SETTINGS.dueDay ?? "");
      $('#simMeta').textContent = `TNA vigente: ${SETTINGS.tna ?? '‚Äî'}% ¬∑ Vencimiento: d√≠a ${SETTINGS.dueDay ?? '‚Äî'}`;
    }else{
      $('#simMeta').textContent = `TNA vigente: ‚Äî% ¬∑ Vencimiento: d√≠a ‚Äî`;
    }
  }catch(e){ console.error(e); }
}
$('#btnSaveSettings').onclick = async ()=>{
  const tna = Number($('#tnaInput').value);
  const due = Number($('#dueInput').value);
  if(!tna || !due){ alert("Complet√° TNA y d√≠a de vencimiento."); return; }
  await db.collection('settings').doc('general').set({ tna, dueDay: due, updatedAt: nowTS() }, {merge:true});
  await loadSettings();
  alert("Configuraci√≥n guardada.");
};
loadSettings();

/* ===========================
   Simulador
=========================== */
function monthlyFromTNA(tna){ // tasa efectiva mensual desde TNA
  const r = Math.pow(1 + (tna/100), 1/12) - 1;
  return r;
}
function buildSchedule(amount, months, tna, dueDay){
  const r = monthlyFromTNA(tna);
  // cuota fija (sistema franc√©s)
  const pay = amount * ( r * Math.pow(1+r, months) ) / ( Math.pow(1+r, months) - 1 );
  const today = new Date();
  const rows = [];
  for(let i=1;i<=months;i++){
    const d = new Date(today);
    d.setMonth(d.getMonth()+i);
    d.setDate(Math.min(dueDay, 28)); // por seguridad hasta 28
    rows.push({ n:i, due: firebase.firestore.Timestamp.fromDate(d), amount: Math.round(pay), paid:false });
  }
  return { rows, pay: Math.round(pay) };
}
$('#btnSim').onclick = ()=>{
  if(!SETTINGS.tna || !SETTINGS.dueDay){ alert("Configur√° la TNA desde Admin antes de simular."); return; }
  const amount = Number(onlyDigits($('#simAmount').value)||0);
  const months = Number($('#simMonths').value||0);
  if(!amount || !months){ alert("Ingres√° monto y meses."); return; }
  const { rows, pay } = buildSchedule(amount, months, SETTINGS.tna, SETTINGS.dueDay);
  let html = `<table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead><tbody>`;
  rows.forEach(r=>{
    const dt = r.due.toDate(); const dd = dt.toLocaleDateString('es-AR',{day:'2-digit',month:'2-digit',year:'numeric'});
    html += `<tr><td>${r.n}</td><td>${dd}</td><td>${money(r.amount)}</td><td><span class="pill warn">Pendiente</span></td></tr>`;
  });
  html += `</tbody></table>`;
  $('#simResult').innerHTML = html;
};

/* ===========================
   Solicitud
=========================== */
$('#btnRequest').onclick = async ()=>{
  const name = $('#bName').value.trim();
  const dni  = onlyDigits($('#bDni').value);
  const email= $('#bMail').value.trim();
  const phone= $('#bPhone').value.trim();
  const cbu  = $('#bCbu').value.trim();
  const amount = Number(onlyDigits($('#simAmount').value)||0);
  const months = Number($('#simMonths').value||0);
  if(!name || !dni || !email || !phone || !cbu || !amount || !months){
    alert("Complet√° todos los campos y simulaci√≥n previa."); return;
  }
  const data = {
    status:'pending',
    createdAt: nowTS(), updatedAt: nowTS(),
    amount, months, tna: SETTINGS.tna,
    borrower:{ name, dni, email, phone, cbu }
  };
  await db.collection('loans').add(data);
  alert("Solicitud enviada con √©xito. ¬°Gracias!");
};

/* ===========================
   ADMIN ‚Äì Listados y acciones
=========================== */
async function loadPend(){
  const box = $('#listPend'); box.innerHTML=""; 
  try{
    const q = await db.collection('loans').where('status','==','pending').orderBy('createdAt','desc').limit(40).get();
    if(q.empty){ box.innerHTML = '<span class="note">Sin pendientes</span>'; return; }
    q.forEach(doc=>{
      const d = doc.data(); d.id=doc.id;
      const el = document.createElement('div'); el.className='item';
      el.innerHTML = `
        <div class="line">
          <div><strong>${d.borrower?.name||''}</strong> ¬∑ DNI ${d.borrower?.dni||''}</div>
          <div class="muted">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}%</div>
        </div>
        <div class="actions">
          <button class="btn-sm btn-green" data-act="pre" data-id="${d.id}">Preaprobar</button>
          <button class="btn-sm btn-red-ghost" data-act="del" data-id="${d.id}">Eliminar</button>
        </div>`;
      el.querySelector('[data-act="pre"]').onclick = async ()=>{
        if(!confirm('¬øPreaprobar y generar contrato?')) return;
        await db.collection('loans').doc(d.id).set({
          status:'preapproved', contractId: Math.random().toString(36).slice(2,10).toUpperCase(),
          updatedAt: nowTS()
        },{merge:true});
        await loadAllAdmin();
      };
      el.querySelector('[data-act="del"]').onclick = async ()=>{
        if(!confirm('¬øEliminar solicitud?')) return;
        await db.collection('loans').doc(d.id).set({ status:'deleted', updatedAt: nowTS() },{merge:true});
        await loadAllAdmin();
      };
      box.appendChild(el);
    });
  }catch(e){ box.innerHTML='No se pudieron leer las solicitudes (revis√° reglas/√≠ndices).';}
}
async function loadPre(){
  const box = $('#listPre'); box.innerHTML="";
  try{
    const q = await db.collection('loans').where('status','==','preapproved').orderBy('updatedAt','desc').limit(40).get();
    if(q.empty){ box.innerHTML='<span class="note">Sin preaprobados</span>'; return; }
    q.forEach(doc=>{
      const d = doc.data(); d.id=doc.id;
      const signed = d.signed ? '<span class="pill ok">Firmado</span>' : '<span class="pill warn">Esperando firma</span>';
      const el = document.createElement('div'); el.className='item';
      el.innerHTML = `
        <div class="line">
          <div><strong>${d.borrower?.name||''}</strong> ¬∑ DNI ${d.borrower?.dni||''}</div>
          <div class="muted">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}% ¬∑ Contrato ${d.contractId||''}</div>
          <div>${signed}</div>
        </div>
        <div class="actions">
          <button class="btn-sm" data-act="share" data-id="${d.id}">Compartir contrato</button>
          <button class="btn-sm btn-green" data-act="approve" data-id="${d.id}" ${d.signed? "":"disabled"}>Aprobar y depositar</button>
          <button class="btn-sm btn-red-ghost" data-act="del" data-id="${d.id}">Eliminar</button>
        </div>`;
      el.querySelector('[data-act="share"]').onclick = ()=>{
        const url = `${location.origin}${location.pathname}#sign-${d.id}`;
        const msg = `Hola ${d.borrower?.name||""}, por favor firm√° tu contrato (${d.contractId}). ${url}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,'_blank');
      };
      el.querySelector('[data-act="approve"]').onclick = async ()=>{
        if(!d.signed){ alert("A√∫n no firmado."); return; }
        const sched = buildSchedule(d.amount, d.months, d.tna, SETTINGS.dueDay).rows;
        await db.collection('loans').doc(d.id).set({
          status:'active', activeAt: nowTS(), updatedAt: nowTS(),
          schedule: sched, paidCount: 0
        },{merge:true});
        await loadAllAdmin();
      };
      el.querySelector('[data-act="del"]').onclick = async ()=>{
        if(!confirm('¬øEliminar preaprobado?')) return;
        await db.collection('loans').doc(d.id).set({ status:'deleted', updatedAt: nowTS() },{merge:true});
        await loadAllAdmin();
      };
      box.appendChild(el);
    });
  }catch(e){ box.innerHTML='No se pudo leer preaprobados.'; }
}
function daysLate(ts){
  const d = ts.toDate(); const today = new Date();
  const diff = Math.floor((today - d)/(1000*60*60*24));
  return diff;
}
async function loadAct(){
  const box = $('#listAct'); box.innerHTML="";
  try{
    const q = await db.collection('loans').where('status','==','active').orderBy('activeAt','desc').limit(80).get();
    if(q.empty){ box.innerHTML='<span class="note">Sin activos</span>'; return; }
    q.forEach(doc=>{
      const d = doc.data(); d.id=doc.id;
      const el = document.createElement('div'); el.className='item';
      const late = (d.schedule||[]).some(r=>!r.paid && daysLate(r.due)>10) ? 'üî¥' :
                   (d.schedule||[]).some(r=>!r.paid && daysLate(r.due)>=6) ? 'üü°' : 'üü¢';
      el.innerHTML = `
        <div class="line">
          <div>${late} <strong>${d.borrower?.name||''}</strong> ¬∑ DNI ${d.borrower?.dni||''}</div>
          <div class="muted">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}%</div>
        </div>
        <div class="actions">
          <button class="btn-sm" data-act="view" data-id="${d.id}">Ver cuotas</button>
          <button class="btn-sm btn-green" data-act="paid" data-id="${d.id}">Pagado total</button>
          <button class="btn-sm btn-red-ghost" data-act="charge" data-id="${d.id}">A incobrables</button>
        </div>
        <div class="hidden" id="sched-${d.id}"></div>`;
      el.querySelector('[data-act="view"]').onclick = ()=> renderSchedule(d);
      el.querySelector('[data-act="paid"]').onclick = async ()=>{
        const allPaid = (d.schedule||[]).every(r=>r.paid);
        if(!allPaid){ alert("No pod√©s cerrar si hay cuotas pendientes."); return; }
        await db.collection('loans').doc(d.id).set({ status:'paid_off', updatedAt: nowTS() },{merge:true});
        await loadAllAdmin();
      };
      el.querySelector('[data-act="charge"]').onclick = async ()=>{
        if(!confirm('¬øMarcar como incobrable?')) return;
        await db.collection('loans').doc(d.id).set({ status:'charged_off', updatedAt: nowTS() },{merge:true});
        await loadAllAdmin();
      };
      box.appendChild(el);
    });
  }catch(e){ box.innerHTML='No se pudieron leer activos.'; }
}
function renderSchedule(d){
  const box = $(`#sched-${d.id}`);
  const rows = d.schedule||[];
  let html = `<div class="section"><table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th><th></th></tr></thead><tbody>`;
  rows.forEach((r,i)=>{
    const dd = r.due.toDate().toLocaleDateString('es-AR',{day:'2-digit',month:'2-digit',year:'numeric'});
    const pill = r.paid ? '<span class="pill ok">Pagada</span>' : '<span class="pill warn">Pendiente</span>';
    html += `<tr>
      <td>${r.n}</td><td>${dd}</td><td>${money(r.amount)}</td><td>${pill}</td>
      <td>${r.paid? '' : `<button class="btn-sm" data-pay="${i}">Marcar pagada</button>`}</td>
    </tr>`;
  });
  html += `</tbody></table></div>`;
  box.innerHTML = html; box.classList.remove('hidden');
  box.querySelectorAll('[data-pay]').forEach(btn=>{
    btn.onclick = async ()=>{
      const i = Number(btn.dataset.pay);
      const snap = await db.collection('loans').doc(d.id).get();
      const data = snap.data();
      if(!data.schedule[i].paid){
        data.schedule[i].paid = true; data.schedule[i].paidAt = nowTS();
        data.paidCount = (data.paidCount||0)+1;
        await db.collection('loans').doc(d.id).set({ schedule:data.schedule, paidCount:data.paidCount, updatedAt:nowTS() },{merge:true});
        renderSchedule({id:d.id, schedule:data.schedule}); // refresco local
      }
    };
  });
}
async function loadInac(show='closed'){
  const box = $('#listInac'); box.innerHTML="";
  let statuses = show==='closed' ? ['paid_off'] : ['charged_off'];
  const q = await db.collection('loans').where('status','in',statuses).orderBy('updatedAt','desc').limit(60).get();
  if(q.empty){ box.innerHTML='<span class="note">Sin inactivos</span>'; return; }
  q.forEach(doc=>{
    const d = doc.data();
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `<div class="line">
      <div><strong>${d.borrower?.name||''}</strong> ¬∑ DNI ${d.borrower?.dni||''}</div>
      <div class="muted">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}% ¬∑ Contrato ${d.contractId||''}</div>
      <div class="pill ${doc.data().status==='paid_off'?'ok':'late'}">${doc.data().status==='paid_off'?'Cancelado':'Incobrable'}</div>
    </div>`;
    box.appendChild(el);
  });
}
async function loadAllAdmin(){ await loadPend(); await loadPre(); await loadAct(); await loadInac('closed'); }
$('#btnReloadPend').onclick=loadPend;
$('#btnReloadPre').onclick=loadPre;
$('#btnReloadAct').onclick=loadAct;
$('#btnReloadInac').onclick=()=>loadInac($('.segment .seg.active')?.id==='btnShowCharged'?'charged':'closed');
$('#btnShowClosed').onclick=()=>{ $('#btnShowClosed').classList.add('active'); $('#btnShowCharged').classList.remove('active'); loadInac('closed'); };
$('#btnShowCharged').onclick=()=>{ $('#btnShowCharged').classList.add('active'); $('#btnShowClosed').classList.remove('active'); loadInac('charged'); };

/* ===========================
   Firma de contrato (modo hash #sign-<id>)
=========================== */
async function openSignIfHash(){
  if(!location.hash.startsWith('#sign-')) return;
  const id = location.hash.replace('#sign-','').trim();
  const snap = await db.collection('loans').doc(id).get();
  if(!snap.exists){ document.body.innerHTML='<div class="container"><p>No encontramos el contrato.</p></div>'; return; }
  const L = snap.data();
  document.body.innerHTML = `
    <div class="container" style="padding:24px 16px">
      <div class="card">
        <h2>Firma de contrato</h2>
        <p>Contrato N¬∞ <strong>${L.contractId||''}</strong> ‚Äî ${L.borrower?.name||''} ‚Äî DNI ${L.borrower?.dni||''}</p>
        <div style="border:1px dashed #cfd7ee;border-radius:12px;padding:14px;margin:10px 0;height:220px;display:flex;align-items:center;justify-content:center;color:#6b7a99">
          (Aqu√≠ va el cuerpo del contrato ‚Äì versi√≥n A4 al imprimir)
        </div>
        <label>Escrib√≠ tu nombre y apellido como firma</label>
        <input id="signName" type="text" placeholder="Nombre y apellido"/>
        <div style="margin-top:12px;display:flex;gap:10px">
          <button id="btnAccept" class="btn-primary">Contrato aceptado</button>
          <button id="btnPdf" class="btn">Descargar PDF</button>
        </div>
      </div>
    </div>`;
  $('#btnPdf').onclick = ()=>{
    const w = window.open('','_blank'); 
    const html = `
      <html><head><title>Contrato ${L.contractId||''}</title>
      <style>@page{size:A4;margin:25mm}body{font-family:Arial;padding:10mm}</style></head>
      <body>
      <h2>Contrato de pr√©stamo ‚Äì EstimaPres</h2>
      <p><strong>Contrato:</strong> ${L.contractId||''}</p>
      <p><strong>Solicitante:</strong> ${L.borrower?.name||''} ‚Äì DNI ${L.borrower?.dni||''}</p>
      <p><strong>Monto:</strong> ${money(L.amount)} ¬∑ <strong>Cuotas:</strong> ${L.months} ¬∑ <strong>TNA:</strong> ${L.tna}%</p>
      <hr><p>(Texto completo del contrato...)</p>
      </body></html>`;
    w.document.write(html); w.document.close(); w.print();
  };
  $('#btnAccept').onclick = async ()=>{
    const v = $('#signName').value.trim();
    if(!v){ alert('Escrib√≠ tu nombre y apellido'); return; }
    try{
      await db.collection('loans').doc(id).set({ signed:true, signedName:v, signedAt: nowTS(), updatedAt: nowTS() },{merge:true});
      alert("¬°Contrato aceptado! Pod√©s cerrar esta ventana.");
      location.href = location.origin+location.pathname; // volver a home
    }catch(e){ alert('No se pudo registrar la firma.'); }
  };
}
openSignIfHash();

/* ===========================
   MI PR√âSTAMO (por DNI)
=========================== */
$('#btnOpenMyLoan').onclick = (e)=>{ e.preventDefault(); document.querySelector('#myloan').scrollIntoView({behavior:'smooth'}); };
$('#btnFindMyLoan').onclick = async ()=>{
  const dni = onlyDigits($('#myDni').value);
  if(!dni){ $('#myLoanResult').innerHTML='<span class="note">Ingres√° un DNI.</span>'; return; }
  $('#myLoanResult').innerHTML = 'Buscando...';
  const qs = await db.collection('loans').orderBy('createdAt','desc').limit(80).get();
  const list=[]; qs.forEach(d=>{ const L=d.data(); if((L.borrower?.dni||"")==dni) list.push({id:d.id,...L});});
  if(!list.length){ $('#myLoanResult').innerHTML='No encontramos pr√©stamos activos o preaprobados para ese DNI.'; return; }
  const L = list[0];
  const rows = (L.schedule||[]).map(r=>{
    const dd = r.due.toDate().toLocaleDateString('es-AR',{day:'2-digit',month:'2-digit',year:'numeric'});
    return `<tr><td>${r.n}</td><td>${dd}</td><td>${money(r.amount)}</td><td>${r.paid?'<span class="pill ok">Pagada</span>':'<span class="pill warn">Pendiente</span>'}</td></tr>`;
  }).join('');
  const paid = L.paidCount||0;
  $('#myLoanResult').innerHTML = `
    <div class="item">
      <div class="line"><div><strong>Estado: ${L.status}</strong></div>
      <div class="muted">Monto: ${money(L.amount)} ¬∑ Cuotas: ${L.months} ¬∑ TNA: ${L.tna}% ¬∑ Progreso: <strong style="color:#10b981">${paid}/${L.months}</strong></div></div>
      ${L.contractId? `<div style="margin-top:8px"><button id="btnMyPdf" class="btn-sm">Contrato PDF</button></div>`:``}
      <div class="section"><table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead><tbody>${rows}</tbody></table></div>
    </div>`;
  $('#btnMyPdf')?.addEventListener('click', ()=>{
    const url = `${location.origin}${location.pathname}#sign-${L.id}`;
    window.open(url,'_blank');
  });
};

/* Arranque suave */
document.addEventListener('DOMContentLoaded', ()=>{
  // meta inicial si hab√≠a settings ya guardados
  loadSettings();
});
</script>
</body>
</html>