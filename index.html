<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>EstimaPres • Préstamos personales</title>

  <!-- ÍCONOS / PWA (usa tu imagen en assets/ping.png) -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/ping.png?v=5">
  <link rel="apple-touch-icon" href="assets/ping.png?v=5">
  <meta name="theme-color" content="#0B5ED7" />

  <!-- Tipografía y estilos básicos -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#0B5ED7; --primary-600:#0a50b8; --success:#16a34a; --danger:#dc2626;
      --bg:#F1F5F9; --card:#ffffff; --muted:#64748b; --text:#0f172a; --ring:#dbeafe;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .container{max-width:960px;margin:0 auto;padding:16px}
    .header{background:linear-gradient(135deg,#0b5ed7 0%,#2563eb 100%);padding:28px 0 18px;color:#fff;position:relative}
    .brandRow{display:flex;align-items:center;justify-content:space-between;gap:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 6px 14px rgba(0,0,0,.25))}
    .brand h1{margin:0;font-size:34px;font-weight:800;letter-spacing:.2px}
    .tag{margin:6px 0 0;font-style:italic;color:#dfe9ff;background:rgba(255,255,255,.08);display:inline-block;padding:8px 14px;border-radius:12px}
    .topBtns{display:flex;gap:10px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:10px;border:0;border-radius:12px;padding:12px 16px;font-weight:600;background:#fff;color:#0b5ed7}
    .btn svg{width:18px;height:18px}
    .btn-secondary{background:#1e3a8a;color:#fff;border:1px solid rgba(255,255,255,.2)}
    .btn-danger{background:#ef4444;color:#fff;border:1px solid rgba(255,255,255,.2)}
    .card{background:var(--card);border-radius:16px;padding:18px;margin:16px 0;box-shadow:0 8px 24px rgba(2,8,23,.06);border:1px solid #e5e7eb}
    .card h2{margin:4px 0 14px;font-size:28px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .input{width:100%;padding:14px 16px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;font-size:16px}
    .input:focus{outline:none;box-shadow:0 0 0 4px var(--ring)}
    .helper{color:var(--muted);font-size:14px;margin:10px 0 0}
    .btn-primary{background:var(--success);color:#fff;border-radius:12px;border:0;padding:14px 16px;font-weight:700}
    .btn-gray{background:#e5e7eb;color:#111827;border-radius:10px;border:0;padding:10px 12px;font-weight:600}
    .btn-outline{background:#fff;border:1px solid #cbd5e1;color:#0f172a}
    .pill{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .pill-green{background:#dcfce7;color:#166534}
    .pill-yellow{background:#fef9c3;color:#854d0e}
    .pill-red{background:#fee2e2;color:#991b1b}
    .list{display:flex;flex-direction:column;gap:12px}
    .item{border:1px solid #e5e7eb;border-radius:14px;padding:14px;background:#fff}
    .item h4{margin:0 0 6px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .right{margin-left:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left}
    th{background:#f8fafc;color:#334155}
    .kpi{font-weight:800}
    .hide{display:none}
    .center{text-align:center}
    .muted{color:var(--muted)}
    .link{color:var(--primary)}
    .progress{font-weight:700;color:#16a34a}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="container">
      <div class="brandRow">
        <div class="brand">
          <img src="assets/ping.png" alt="EstimaPres" />
          <div>
            <h1>EstimaPres</h1>
            <div class="tag">Préstamos personales · <span style="text-decoration:underline dotted">simple y claro</span></div>
          </div>
        </div>
        <div class="topBtns">
          <button id="btnMyLoan" class="btn" title="Ver mi préstamo">
            <svg viewBox="0 0 24 24" fill="none"><path d="M10 4v2m0 12v2m8-10h2M4 12H2m15.536-7.536 1.414 1.414M6.05 17.95l-1.414 1.414m0-12.728L6.05 6.05M18.364 18.364l-1.414-1.414" stroke="currentColor" stroke-width="1.5"/></svg>
            Ver mi préstamo
          </button>
          <button id="btnAdmin" class="btn btn-secondary" title="Acceso administrador">
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4 0-7 2-7 4v2h14v-2c0-2-3-4-7-4Z" stroke="#fff" stroke-width="1.5"/></svg>
            Admin
          </button>
          <button id="btnLogout" class="btn btn-danger" title="Cerrar sesión">
            <svg viewBox="0 0 24 24" fill="none"><path d="M15 12H3m6-6-6 6 6 6m4-12h4a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-4" stroke="#fff" stroke-width="1.5"/></svg>
            Salir
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- SIMULADOR -->
    <section class="card" id="cardSim">
      <h2>Simulador</h2>
      <div class="grid2">
        <div>
          <label class="muted">Monto</label>
          <input id="simAmount" class="input" inputmode="numeric" placeholder="$ 1.000.000">
        </div>
        <div>
          <label class="muted">Meses</label>
          <input id="simMonths" class="input" inputmode="numeric" placeholder="Ej: 12">
        </div>
      </div>
      <div class="helper">TNA vigente: <span id="lblTna" class="kpi">—</span> · Vencimiento: día <span id="lblDue" class="kpi">—</span></div>
      <div style="margin-top:14px" class="row">
        <button id="btnSimulate" class="btn-primary">Simular</button>
        <div id="simResult" class="helper"></div>
      </div>
    </section>

    <!-- SOLICITUD -->
    <section class="card" id="cardRequest">
      <h2>Solicitar préstamo</h2>
      <div class="grid2">
        <div>
          <label class="muted">Tu nombre</label>
          <input id="rqName" class="input" placeholder="Juan Pérez">
        </div>
        <div>
          <label class="muted">DNI</label>
          <input id="rqDni" class="input" inputmode="numeric" placeholder="30123456">
        </div>
        <div>
          <label class="muted">Email</label>
          <input id="rqEmail" class="input" inputmode="email" placeholder="tucorreo@mail.com">
        </div>
        <div>
          <label class="muted">Teléfono</label>
          <input id="rqPhone" class="input" inputmode="tel" placeholder="11 2345 6789">
        </div>
        <div class="grid2" style="grid-column:1/-1">
          <div style="grid-column:1/-1">
            <label class="muted">alias o CBU/CVU</label>
            <input id="rqCbu" class="input" placeholder="alias o CBU/CVU">
          </div>
        </div>
      </div>
      <div class="helper">Al enviar aceptás ser contactado por EstimaPres.</div>
      <div style="margin-top:12px">
        <button id="btnSendRequest" class="btn-primary">Enviar solicitud</button>
        <span id="rqMsg" class="helper"></span>
      </div>
    </section>

    <!-- PANEL ADMIN -->
    <section class="card hide" id="cardAdmin">
      <h2>Panel administrador</h2>

      <!-- TNA -->
      <div class="grid2">
        <div>
          <label class="muted">TNA</label>
          <input id="admTna" class="input" inputmode="numeric" placeholder="100">
        </div>
        <div>
          <label class="muted">Día de vencimiento</label>
          <input id="admDue" class="input" inputmode="numeric" placeholder="10">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnSaveSettings" class="btn-primary">Guardar</button>
        <span id="admMsg" class="helper"></span>
      </div>

      <!-- PENDIENTES -->
      <div class="row" style="margin-top:18px;align-items:center">
        <h3 style="margin:0">Solicitudes pendientes</h3>
        <button id="btnReloadPend" class="btn-gray right">Recargar</button>
      </div>
      <div id="pendList" class="list"><div class="muted">Sin pendientes</div></div>

      <!-- PREAPROBADOS -->
      <div class="row" style="margin-top:18px;align-items:center">
        <h3 style="margin:0">Preaprobados</h3>
        <button id="btnReloadPre" class="btn-gray right">Recargar</button>
      </div>
      <div id="preList" class="list"><div class="muted">Sin preaprobados</div></div>

      <!-- ACTIVOS -->
      <div class="row" style="margin-top:18px;align-items:center">
        <h3 style="margin:0">Activos</h3>
        <button id="btnReloadActive" class="btn-gray right">Recargar</button>
      </div>
      <div id="activeLegend" class="helper" style="display:none">
        <span class="pill pill-green">● al día</span>
        <span class="pill pill-yellow">● 6–10 días</span>
        <span class="pill pill-red">● &gt;10 días</span>
      </div>
      <div id="activeList" class="list"><div class="muted">Sin activos</div></div>

      <!-- INACTIVOS -->
      <div class="row" style="margin-top:18px;align-items:center">
        <h3 style="margin:0">Inactivos (finalizados / incobrables)</h3>
        <div class="right row">
          <button id="btnFilterFinished" class="btn-gray">Cancelados</button>
          <button id="btnFilterCharged" class="btn-danger btn-outline" style="color:#fff;background:#ef4444;border:0">Incobrables</button>
          <button id="btnReloadInactive" class="btn-gray">Recargar</button>
        </div>
      </div>
      <div id="inactiveList" class="list"><div class="muted">Sin inactivos</div></div>
    </section>

    <!-- CONTRATO / FIRMA (overlay simple) -->
    <section id="signOverlay" class="hide card" style="position:fixed;inset:0;z-index:50;max-width:680px;margin:auto;height:max-content">
      <h2>Firma de contrato</h2>
      <div id="signInfo" class="helper"></div>
      <div style="margin:12px 0">
        <label class="muted">Escribí tu nombre completo para aceptar</label>
        <input id="signName" class="input" placeholder="Nombre y Apellido">
      </div>
      <div class="row">
        <button id="btnAcceptContract" class="btn-primary">Contrato aceptado</button>
        <button id="btnCloseSign" class="btn-gray">Cerrar</button>
        <button id="btnDownloadContract" class="btn-gray right">Descargar PDF</button>
      </div>
    </section>

    <!-- MI PRÉSTAMO -->
    <section id="myLoanOverlay" class="hide card" style="position:fixed;inset:0;z-index:40;max-width:820px;margin:auto;height:max-content">
      <h2>Ver mi préstamo</h2>
      <div class="row">
        <input id="myDni" class="input" placeholder="Ingresá tu DNI para consultar" style="flex:1">
        <button id="btnFindMyLoan" class="btn-primary">Consultar</button>
        <button id="btnCloseMyLoan" class="btn-gray">Cerrar</button>
      </div>
      <div id="myLoanResult" style="margin-top:12px"></div>
    </section>

  </main>

  <!-- LIBRERÍAS FIREBASE (modular CDN v10) -->
  <script type="module">
    // ======= Firebase init =======
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, getDoc, getDocs, setDoc, updateDoc,
      query, where, orderBy, limit, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // >>> REEMPLAZA por tu config (dejé la que veníamos usando)
    const firebaseConfig = {
      apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
      authDomain: "estimapres.firebaseapp.com",
      projectId: "estimapres",
      storageBucket: "estimapres.firebasestorage.app",
      messagingSenderId: "578516597437",
      appId: "1:578516597437:web:f59994b87729aa1cd655d4"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth= getAuth(app);
    const provider = new GoogleAuthProvider();

    // ======= Utils =======
    const $ = (sel)=>document.querySelector(sel);
    const nf = new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0});
    const money = (n)=> nf.format(Math.round(Number(n||0)));
    const onlyDigits = (s)=> (s||'').replace(/[^\d]/g,'');
    const toast = (msg)=>{ alert(msg); };

    function formatInputMoney(el){
      const raw = onlyDigits(el.value);
      if(!raw){ el.value=''; return 0; }
      const num = Number(raw);
      el.value = nf.format(num);
      return num;
    }

    function cuota(P, tna, n){
      const r = (tna/100)/12;
      if(r===0) return Math.round(P/n);
      return Math.round(P * (r*Math.pow(1+r,n)) / (Math.pow(1+r,n)-1));
    }

    // ======= Estado global =======
    let settings = { tna:150, dueDay:10 };
    let user = null;
    let isAdmin = false;
    let currentSignLoanId = null;

    // ======= DOM refs =======
    const simAmount = $("#simAmount");
    const simMonths = $("#simMonths");
    const lblTna    = $("#lblTna");
    const lblDue    = $("#lblDue");
    const simResult = $("#simResult");

    const btnSimulate = $("#btnSimulate");
    const btnSendRequest = $("#btnSendRequest");
    const rqName = $("#rqName"), rqDni=$("#rqDni"), rqEmail=$("#rqEmail"), rqPhone=$("#rqPhone"), rqCbu=$("#rqCbu");
    const rqMsg  = $("#rqMsg");

    const cardAdmin = $("#cardAdmin");
    const admTna=$("#admTna"), admDue=$("#admDue"), btnSaveSettings=$("#btnSaveSettings"), admMsg=$("#admMsg");

    const pendList=$("#pendList"), preList=$("#preList"), activeList=$("#activeList"), inactiveList=$("#inactiveList");
    const btnReloadPend=$("#btnReloadPend"), btnReloadPre=$("#btnReloadPre"), btnReloadActive=$("#btnReloadActive"), btnReloadInactive=$("#btnReloadInactive");
    const btnFilterFinished=$("#btnFilterFinished"), btnFilterCharged=$("#btnFilterCharged");

    const signOverlay=$("#signOverlay"), signInfo=$("#signInfo"), signName=$("#signName"),
          btnAcceptContract=$("#btnAcceptContract"), btnCloseSign=$("#btnCloseSign"), btnDownloadContract=$("#btnDownloadContract");

    const myLoanOverlay=$("#myLoanOverlay"), myDni=$("#myDni"), btnFindMyLoan=$("#btnFindMyLoan"), btnCloseMyLoan=$("#btnCloseMyLoan"), myLoanResult=$("#myLoanResult");

    const btnMyLoan=$("#btnMyLoan"), btnAdmin=$("#btnAdmin"), btnLogout=$("#btnLogout");

    // ======= Inicio =======
    async function loadSettings(){
      const snap = await getDoc(doc(db,'settings','global'));
      if(snap.exists()){
        const d = snap.data();
        settings.tna = Number(d.tna||settings.tna);
        settings.dueDay = Number(d.dueDay||settings.dueDay||10);
      }else{
        await setDoc(doc(db,'settings','global'),{ tna:settings.tna, dueDay:settings.dueDay, updatedAt:serverTimestamp() });
      }
      lblTna.textContent = `${settings.tna}%`;
      lblDue.textContent = settings.dueDay;
      admTna.value = settings.tna;
      admDue.value = settings.dueDay;
    }

    onAuthStateChanged(auth, async (u)=>{
      user = u;
      if(!u){ isAdmin=false; cardAdmin.classList.add('hide'); return; }
      // check admin email
      try{
        const a = await getDoc(doc(db,'admins','admins'));
        const arr = (a.exists() && Array.isArray(a.data().emails)) ? a.data().emails : [];
        isAdmin = arr.includes(u.email);
        if(isAdmin){
          cardAdmin.classList.remove('hide');
          await reloadAll();
        }else{
          cardAdmin.classList.add('hide');
        }
      }catch(e){ console.error(e); }
    });

    // ======= Botones header =======
    btnAdmin.onclick = async ()=>{
      if(user){ 
        // si ya está logueado, mostrar panel (si es admin)
        if(!isAdmin) toast("Sesión iniciada pero tu email no es admin.");
        else cardAdmin.scrollIntoView({behavior:'smooth'});
        return;
      }
      try{ await signInWithPopup(auth, provider); }catch(e){ toast("No se pudo iniciar sesión."); }
    };
    btnLogout.onclick = async ()=>{ try{ await signOut(auth); toast("Sesión cerrada."); }catch{} };
    btnMyLoan.onclick = ()=>{ myLoanOverlay.classList.remove('hide'); myDni.focus(); };
    btnCloseMyLoan.onclick = ()=> myLoanOverlay.classList.add('hide');

    // ======= Simulador =======
    simAmount.addEventListener('input', ()=> formatInputMoney(simAmount));
    btnSimulate.onclick = ()=>{
      const P = formatInputMoney(simAmount);
      const n = Number(onlyDigits(simMonths.value));
      if(!P || !n){ simResult.textContent="Ingresá monto y meses."; return; }
      const c = cuota(P, settings.tna, n);
      simResult.innerHTML = `Cuota estimada: <b>${money(c)}</b> x ${n} meses (TNA ${settings.tna}%).`;
    };

    // ======= Solicitud =======
    btnSendRequest.onclick = async ()=>{
      const name=rqName.value.trim(), dni=onlyDigits(rqDni.value), email=rqEmail.value.trim(), phone=rqPhone.value.trim(), cbu=rqCbu.value.trim();
      const P = formatInputMoney(simAmount);
      const n = Number(onlyDigits(simMonths.value));
      if(!name||!dni||!email||!phone||!cbu){ rqMsg.textContent="Completá todos los datos."; return; }
      if(!P||!n){ rqMsg.textContent="Primero simulá monto y meses."; return; }
      rqMsg.textContent="Enviando...";
      try{
        await addDoc(collection(db,'public_loans'),{
          amount:P, months:n, tna:settings.tna,
          borrower:{ name,dni,email,phone,cbu },
          createdAt:serverTimestamp()
        });
        rqMsg.textContent="¡Listo! Un administrador revisará tu solicitud (dentro de 48 h).";
        rqName.value=rqDni.value=rqEmail.value=rqPhone.value=rqCbu.value="";
      }catch(e){ rqMsg.textContent="No se pudo enviar."; console.error(e); }
    };

    // ======= Guardar TNA/DueDay =======
    btnSaveSettings.onclick = async ()=>{
      const t = Number(onlyDigits(admTna.value)||settings.tna);
      const d = Number(onlyDigits(admDue.value)||settings.dueDay);
      try{
        await setDoc(doc(db,'settings','global'),{ tna:t, dueDay:d, updatedAt:serverTimestamp() });
        settings.tna=t; settings.dueDay=d;
        lblTna.textContent=`${t}%`; lblDue.textContent=d;
        admMsg.textContent="Guardado ✓";
        setTimeout(()=>admMsg.textContent="", 1500);
      }catch(e){ toast("No se pudo guardar."); }
    };

    // ======= Listados =======
    async function loadPend(){
      pendList.innerHTML = '<div class="muted">Cargando…</div>';
      const q = query(collection(db,'public_loans'), orderBy('createdAt','desc'), limit(50));
      const s = await getDocs(q);
      if(s.empty){ pendList.innerHTML='<div class="muted">Sin pendientes</div>'; return; }
      pendList.innerHTML='';
      s.forEach(d=>{
        const l = d.data();
        const el = document.createElement('div');
        el.className='item';
        el.innerHTML = `
          <h4>${l.borrower?.name||''} · DNI ${l.borrower?.dni||''}</h4>
          <div class="helper">Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%</div>
          <div class="row" style="margin-top:8px">
            <button class="btn-primary" data-act="pre" data-id="${d.id}">Preaprobar</button>
            <button class="btn-gray" data-act="del" data-id="${d.id}">Descartar</button>
          </div>
        `;
        pendList.appendChild(el);
      });
    }

    async function loadPre(){
      preList.innerHTML = '<div class="muted">Cargando…</div>';
      const qy = query(collection(db,'loans'), where('status','==','preapproved'), orderBy('updatedAt','desc'), limit(50));
      const s = await getDocs(qy);
      if(s.empty){ preList.innerHTML='<div class="muted">Sin preaprobados</div>'; return; }
      preList.innerHTML='';
      s.forEach(d=>{
        const l = d.data();
        const el = document.createElement('div');
        el.className='item';
        el.innerHTML = `
          <h4>${l.borrower?.name} · DNI ${l.borrower?.dni}</h4>
          <div class="helper">Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%</div>
          <div class="row" style="margin-top:8px">
            <button class="btn-gray" data-act="pdf" data-id="${d.id}">Contrato PDF</button>
            <button class="btn-gray" data-act="share" data-id="${d.id}">Compartir firma</button>
            <button class="btn-primary" data-act="sign" data-id="${d.id}">Abrir para firmar</button>
            <button class="btn-primary" data-act="activate" data-id="${d.id}" ${l.signedAt?'':'disabled style="opacity:.5;cursor:not-allowed"'}>Aprobar y depositar</button>
          </div>
          <div class="helper">${l.signedAt?`Cliente firmó: ${new Date(l.signedAt.seconds*1000).toLocaleString()}`:`Esperando firma del solicitante…`}</div>
        `;
        preList.appendChild(el);
      });
    }

    function dueColor(nextDue){
      const today = new Date();
      const diff = Math.floor((today - nextDue) / (1000*60*60*24));
      if(diff<=0) return 'pill-green';
      if(diff<=10) return 'pill-yellow';
      return 'pill-red';
    }

    function computeNextDue(l){
      // fecha de próxima cuota según dueDay
      const today = new Date();
      let m = today.getMonth();
      let y = today.getFullYear();
      const day = settings.dueDay||10;
      let next = new Date(y, m, day);
      if(today.getDate() >= day) next = new Date(y, m+1, day);
      return next;
    }

    function scheduleRows(l){
      const c = cuota(l.amount, l.tna, l.months);
      const paid = Number(l.paidCount||0);
      const rows = [];
      let y = new Date().getFullYear(), m = new Date().getMonth();
      for(let i=1;i<=l.months;i++){
        const d = new Date(y, m + i, settings.dueDay||10);
        const status = i<=paid ? 'Pagada' : 'Pendiente';
        const btn = i<=paid ? '' : `<button class="btn-gray" data-act="pay" data-id="${l.id}" data-n="${i}">Marcar pagada</button>`;
        rows.push(`<tr>
          <td>${i}</td>
          <td>${d.toLocaleDateString()}</td>
          <td>${money(c)}</td>
          <td>${i<=paid?'<span class="pill pill-green">Pagada</span>':'Pendiente'}</td>
          <td class="right">${btn}</td>
        </tr>`);
      }
      return rows.join('');
    }

    function renderActiveItem(l){
      const next = computeNextDue(l);
      const color = dueColor(next);
      const progress = `${Number(l.paidCount||0)}/${l.months}`;
      return `
        <div class="item" id="card-${l.id}">
          <div class="row" style="align-items:center">
            <span class="pill ${color}">Activo</span>
            <h4 style="margin:0 0 0 8px">${l.borrower?.name} · DNI ${l.borrower?.dni}</h4>
            <span class="right helper">Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}% · <span class="progress">${progress}</span></span>
          </div>
          <div class="row" style="margin-top:10px;gap:8px">
            <button class="btn-gray" data-act="view" data-id="${l.id}">Ver cuotas</button>
            <button class="btn-primary" data-act="finish" data-id="${l.id}" ${Number(l.paidCount||0)>=l.months?'':'disabled style="opacity:.5;cursor:not-allowed"'}>Pagado total</button>
            <button class="btn-danger" data-act="chargeoff" data-id="${l.id}">A incobrables</button>
          </div>
          <div id="detail-${l.id}" class="hide" style="margin-top:12px;overflow:auto">
            <table>
              <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th><th></th></tr></thead>
              <tbody>${scheduleRows(l)}</tbody>
            </table>
          </div>
        </div>
      `;
    }

    async function loadActive(){
      activeList.innerHTML='<div class="muted">Cargando…</div>';
      const qy = query(collection(db,'loans'), where('status','==','active'), orderBy('activeAt','desc'), limit(80));
      const s = await getDocs(qy);
      if(s.empty){ activeList.innerHTML='<div class="muted">Sin activos</div>'; return; }
      activeList.innerHTML='';
      const arr=[];
      s.forEach(d=> arr.push({ id:d.id, ...d.data() }));
      arr.forEach(l=>{
        l.id = l.id; // keep
        const el = document.createElement('div');
        el.innerHTML = renderActiveItem(l);
        activeList.appendChild(el.firstElementChild);
      });
    }

    let inactiveFilter='finished';
    async function loadInactive(){
      inactiveList.innerHTML='<div class="muted">Cargando…</div>';
      const qy = query(collection(db,'loans'), where('status','==',inactiveFilter), orderBy('updatedAt','desc'), limit(80));
      const s = await getDocs(qy);
      if(s.empty){ inactiveList.innerHTML='<div class="muted">Sin inactivos</div>'; return; }
      inactiveList.innerHTML='';
      s.forEach(d=>{
        const l = d.data();
        const el = document.createElement('div');
        el.className='item';
        el.innerHTML = `
          <div class="row" style="align-items:center">
            <span class="pill ${inactiveFilter==='finished'?'pill-green':'pill-red'}">${inactiveFilter==='finished'?'cancelado':'incobrable'}</span>
            <h4 style="margin:0 0 0 8px">${l.borrower?.name} · DNI ${l.borrower?.dni}</h4>
            <span class="right helper">Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}% · Contrato ${l.contractCode||'-'}</span>
          </div>
        `;
        inactiveList.appendChild(el);
      });
    }

    async function reloadAll(){
      await loadSettings();
      await Promise.all([loadPend(), loadPre(), loadActive(), loadInactive()]);
    }

    // ======= Eventos listas =======
    pendList.onclick = async (e)=>{
      const b = e.target.closest('button'); if(!b) return;
      const id = b.dataset.id; const act=b.dataset.act;
      if(act==='del'){ /* opcional: borrar solicitud */ toast('Solicitud descartada (pendiente implementar eliminación si querés).'); return; }
      if(act==='pre'){
        // Crear loan preaprobado
        const d = await getDoc(doc(db,'public_loans',id));
        if(!d.exists()){ toast("Solicitud no encontrada."); return; }
        const s = d.data();
        const ref = await addDoc(collection(db,'loans'),{
          amount:s.amount, months:s.months, tna:s.tna||settings.tna,
          borrower:s.borrower,
          status:'preapproved',
          paidCount:0,
          contractCode: (Math.random().toString(36).slice(2,6)+Math.random().toString(36).slice(2,6)).toUpperCase(),
          createdAt:serverTimestamp(), updatedAt:serverTimestamp()
        });
        toast("Preaprobado ✓");
        await loadPre();
      }
    };

    preList.onclick = async (e)=>{
      const b = e.target.closest('button'); if(!b) return;
      const id=b.dataset.id; const act=b.dataset.act;
      if(act==='sign'){ openSignFor(id); }
      if(act==='pdf'){ const l = await getDoc(doc(db,'loans',id)); if(l.exists()) openPdfContract({id, ...l.data()}); }
      if(act==='share'){
        const link = location.origin + location.pathname + `#firmar=${id}`;
        if(navigator.share){
          try{ await navigator.share({title:'Firma de contrato',text:'Firmá tu contrato EstimaPres',url:link}); }
          catch{}
        }else{
          navigator.clipboard.writeText(link);
          toast("Enlace copiado para compartir.");
        }
      }
      if(act==='activate'){
        if(!confirm("¿Confirmás depositar y activar el préstamo?")) return;
        await updateDoc(doc(db,'loans',id),{ status:'active', activeAt:serverTimestamp(), updatedAt:serverTimestamp() });
        await loadPre(); await loadActive();
      }
    };

    activeList.onclick = async (e)=>{
      const b = e.target.closest('button'); if(!b) return;
      const id=b.dataset.id; const act=b.dataset.act;
      if(act==='view'){ $("#detail-"+id).classList.toggle('hide'); return; }
      if(act==='pay'){
        // incrementar paidCount si corresponde
        const l = await getDoc(doc(db,'loans',id)); if(!l.exists()) return;
        const cur = Number(l.data().paidCount||0);
        const n = Number(b.dataset.n||0);
        if(n<=cur) return;
        await updateDoc(doc(db,'loans',id),{ paidCount: cur+1, updatedAt:serverTimestamp() });
        await loadActive();
      }
      if(act==='finish'){
        if(!confirm("¿Marcar como pagado total?")) return;
        await updateDoc(doc(db,'loans',id),{ status:'finished', updatedAt:serverTimestamp() });
        await loadActive(); await loadInactive();
      }
      if(act==='chargeoff'){
        if(!confirm("¿Enviar a incobrables?")) return;
        await updateDoc(doc(db,'loans',id),{ status:'charged_off', updatedAt:serverTimestamp() });
        await loadActive(); await loadInactive();
      }
    };

    btnReloadPend.onclick = loadPend;
    btnReloadPre.onclick = loadPre;
    btnReloadActive.onclick = loadActive;
    btnReloadInactive.onclick = loadInactive;
    btnFilterFinished.onclick = ()=>{ inactiveFilter='finished'; loadInactive(); };
    btnFilterCharged.onclick = ()=>{ inactiveFilter='charged_off'; loadInactive(); };

    // ======= Firma =======
    async function openSignFor(loanId){
      currentSignLoanId = loanId;
      const l = await getDoc(doc(db,'loans',loanId));
      if(!l.exists()){ toast("Préstamo no encontrado."); return; }
      const d = l.data();
      signInfo.innerHTML = `Contrato N° <b>${d.contractCode||'—'}</b> — ${d.borrower?.name} — DNI ${d.borrower?.dni}<br> Principal ${money(d.amount)} · ${d.months} cuotas · TNA ${d.tna}%`;
      signName.value = d.borrower?.name || "";
      signOverlay.classList.remove('hide');
      btnDownloadContract.onclick = ()=> openPdfContract({id:loanId, ...d});
    }
    btnCloseSign.onclick = ()=> signOverlay.classList.add('hide');

    btnAcceptContract.onclick = async ()=>{
      const name = signName.value.trim();
      if(!name){ toast("Escribí tu nombre para aceptar."); return; }
      try{
        await updateDoc(doc(db,'loans',currentSignLoanId),{
          signedName:name, signedAt:serverTimestamp(), updatedAt:serverTimestamp()
        });
        toast("Contrato aceptado ✓");
        signOverlay.classList.add('hide');
        await loadPre();
      }catch(e){ toast("No se pudo firmar."); }
    };

    // ======= Contrato PDF (A4 print) =======
    function openPdfContract(l){
      const w = window.open('about:blank','_blank');
      const css = `
        <style>
          @page{ size:A4; margin:20mm; }
          body{ font-family:Inter,Arial,sans-serif; line-height:1.45; color:#111827; }
          h1{ margin:0 0 8px; font-size:22px }
          .muted{ color:#6b7280 }
          .box{ border:1px solid #e5e7eb; padding:12px; border-radius:8px; }
        </style>
      `;
      const html = `
        <html><head><meta charset="utf-8">${css}<title>Contrato ${l.contractCode||''}</title></head>
        <body>
          <h1>Contrato de Préstamo — EstimaPres</h1>
          <div class="muted">Contrato N° ${l.contractCode||'—'} — ${l.borrower?.name} — DNI ${l.borrower?.dni}</div>
          <p>En la ciudad de __________ a los ____ días del mes de __________ del ${new Date().getFullYear()}, entre <b>EstimaPres</b>, en adelante “EL PRESTAMISTA”; y <b>${l.borrower?.name}</b>, DNI <b>${l.borrower?.dni}</b>, alias/CBU <b>${l.borrower?.cbu||''}</b>, en adelante “EL PRESTATARIO”, se conviene lo siguiente:</p>
          <ol>
            <li>EL PRESTAMISTA otorga a EL PRESTATARIO un préstamo por la suma de <b>${money(l.amount)}</b>, a devolver en <b>${l.months}</b> cuotas mensuales iguales de <b>${money(cuota(l.amount,l.tna,l.months))}</b> cada una, con una TNA del <b>${l.tna}%</b>. Vencimiento día <b>${settings.dueDay}</b> de cada mes.</li>
            <li>El incumplimiento en tiempo y forma habilita a EL PRESTAMISTA a aplicar recargos y a iniciar las acciones de recupero correspondientes.</li>
            <li>Jurisdicción: tribunales ordinarios de la Ciudad Autónoma de Buenos Aires.</li>
          </ol>
          <div class="box">
            <p>Declaro haber leído y aceptado las condiciones del presente contrato.</p>
            <p>Firma del prestatario: ____________________________</p>
            <p>Nombre: <b>${l.signedName||'(pendiente)'}</b> · Fecha: ${l.signedAt?new Date(l.signedAt.seconds*1000).toLocaleString():'(pendiente)'}</p>
          </div>
          <p class="muted">Generado por EstimaPres — ${new Date().toLocaleString()}</p>
          <script>window.onload=()=>setTimeout(()=>window.print(),300)</script>
        </body></html>
      `;
      w.document.write(html); w.document.close();
    }

    // ======= Mi Préstamo (usuario) =======
    btnFindMyLoan.onclick = async ()=>{
      const dni = onlyDigits(myDni.value);
      if(!dni){ myLoanResult.innerHTML='<div class="muted">Ingresá un DNI.</div>'; return; }
      myLoanResult.innerHTML='<div class="muted">Buscando…</div>';
      const qy = query(collection(db,'loans'), orderBy('createdAt','desc'), limit(80));
      const s = await getDocs(qy);
      const list=[];
      s.forEach(d=>{ const L=d.data(); if(L?.borrower?.dni===dni) list.push({id:d.id, ...L}) });
      if(!list.length){ myLoanResult.innerHTML='<div class="muted">No encontramos préstamos activos o preaprobados para ese DNI.</div>'; return; }
      const L = list[0];
      const c = cuota(L.amount,L.tna,L.months);
      const paid = Number(L.paidCount||0);
      const rows = scheduleRows(L);
      myLoanResult.innerHTML = `
        <div class="item">
          <h4>Estado: <b>${L.status}</b></h4>
          <div class="helper">Monto: ${money(L.amount)} · Cuotas: ${L.months} · TNA: ${L.tna}% · Progreso: <span class="progress">${paid}/${L.months}</span></div>
          <div class="row" style="margin-top:10px">
            <button class="btn-gray" id="btnUserPdf">Contrato PDF</button>
          </div>
          <div style="margin-top:12px;overflow:auto">
            <table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead><tbody>${rows.replace(/<td class="right">.*?<\/td>/g,'')}</tbody></table>
          </div>
        </div>
      `;
      $("#btnUserPdf").onclick = ()=> openPdfContract(L);
    };

    // ======= Enlace directo para firmar (compartible) =======
    window.addEventListener('hashchange',()=>{
      const m = location.hash.match(/#firmar=([A-Za-z0-9_-]+)/);
      if(m) openSignFor(m[1]);
    });
    if(location.hash.startsWith('#firmar=')){
      const m = location.hash.match(/#firmar=([A-Za-z0-9_-]+)/);
      if(m) openSignFor(m[1]);
    }

    // ======= Arranque =======
    await loadSettings();
  </script>
</body>
</html>
```0