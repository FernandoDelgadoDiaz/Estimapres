<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
    <title>EstimaPres 路 Sistema Integral</title>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy: #050d1f; --navy-mid: #0b1a35; --navy-card: #0f2245;
            --blue: #1a56db; --sky: #60a5fa; --white: #f8faff; --muted: #7a9cc6;
            --ok: #10b981; --danger: #ef4444; --border: rgba(96,165,250,0.15);
        }
        body { font-family: 'Sora', sans-serif; background: var(--navy); color: var(--white); margin: 0; min-height: 100vh; }
        body::before { content: ''; position: fixed; inset: 0; background: radial-gradient(ellipse at 70% -10%, rgba(26,86,219,0.15) 0%, transparent 70%); z-index: -1; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        .card { background: var(--navy-card); border: 1px solid var(--border); border-radius: 24px; padding: 25px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        h1, h2, h3 { margin: 0 0 15px 0; letter-spacing: -1px; }
        input, select { width: 100%; background: rgba(5,13,31,0.6); border: 1px solid var(--border); border-radius: 12px; padding: 14px; color: var(--white); font-family: inherit; margin-bottom: 15px; box-sizing: border-box; }
        .btn { width: 100%; padding: 16px; border-radius: 14px; border: none; font-weight: 800; cursor: pointer; transition: 0.2s; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, var(--blue), #0b43bc); color: white; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--muted); margin-top: 10px; }
        .grid { display: grid; gap: 20px; }
        @media (min-width: 800px) { .grid-2 { grid-template-columns: 1fr 1fr; } .grid-3 { grid-template-columns: 1fr 1fr 1fr; } }
        .pill { padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
        .status-pending { background: rgba(245,158,11,0.2); color: #f59e0b; }
        .status-active { background: rgba(16,185,129,0.2); color: #10b981; }
        canvas { background: white; border-radius: 12px; width: 100%; height: 150px; touch-action: none; margin: 10px 0; }
        .hidden { display: none !important; }
        .loan-row { border-bottom: 1px solid var(--border); padding: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .loan-row:last-child { border: none; }
    </style>
</head>
<body>

<header style="padding: 40px 20px; text-align: center;">
    <h1 id="brandName">Cargando...</h1>
    <p id="brandLoc" style="color: var(--sky); font-size: 14px;"></p>
</header>

<div class="container">
    <div id="viewClient">
        <div class="grid grid-2">
            <div class="card">
                <h3> Simulador</h3>
                <input type="number" id="sMonto" placeholder="Monto a solicitar">
                <select id="sCuotas"><option value="6">6 Cuotas</option><option value="12">12 Cuotas</option></select>
                <button class="btn btn-primary" onclick="simular()">CALCULAR</button>
                <div id="resSim" class="hidden" style="margin-top:15px; text-align:center;">
                    <small style="color:var(--muted)">CUOTA ESTIMADA:</small>
                    <div id="txtCuota" style="font-size:28px; color:var(--sky); font-weight:800;"></div>
                </div>
            </div>
            <div class="card">
                <h3> Mi Estado</h3>
                <input type="number" id="searchDni" placeholder="Tu DNI">
                <button class="btn btn-ghost" onclick="buscarPrestamo()">CONSULTAR</button>
                <div id="searchRes" style="margin-top:15px;"></div>
            </div>
        </div>
        <div class="card">
            <h3> Solicitar Cr茅dito</h3>
            <div class="grid grid-2">
                <input id="fName" placeholder="Nombre y Apellido">
                <input id="fDni" type="number" placeholder="DNI">
                <input id="fTel" placeholder="WhatsApp">
                <input id="fAlias" placeholder="Tu Alias/CBU">
            </div>
            <button class="btn btn-primary" style="background:var(--ok)" onclick="enviarSolicitud()">ENVIAR SOLICITUD</button>
        </div>
        <center><button class="btn btn-ghost" style="width:auto; border:none;" onclick="loginAdmin()">Acceso Staff</button></center>
    </div>

    <div id="viewAdmin" class="hidden">
        <div class="card" style="background: var(--navy-mid);">
            <h3>锔 Configuraci贸n del Negocio</h3>
            <div class="grid grid-3">
                <div><label><small>Nombre</small></label><input id="cfgName"></div>
                <div><label><small>Ciudad</small></label><input id="cfgLoc"></div>
                <div><label><small>TNA %</small></label><input type="number" id="cfgTna"></div>
            </div>
            <input id="cfgAlias" placeholder="Alias para recibir pagos">
            <button class="btn btn-primary" onclick="guardarConfig()">ACTUALIZAR SISTEMA</button>
        </div>

        <div class="card">
            <h3> Gesti贸n de Pr茅stamos</h3>
            <div id="adminList">Cargando solicitudes...</div>
        </div>
        <button class="btn btn-ghost" onclick="location.reload()">CERRAR SESIN</button>
    </div>
</div>

<div id="modalFirma" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; display:flex; align-items:center; justify-content:center; padding:20px;">
    <div class="card" style="max-width:400px; width:100%;">
        <h3>Firma Digital</h3>
        <p id="legalTxt" style="font-size:11px; color:var(--muted); line-height:1.4;"></p>
        <canvas id="sig-canvas"></canvas>
        <button class="btn btn-primary" onclick="confirmarFirma()">FIRMAR AHORA</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, doc, getDoc, getDocs, updateDoc, setDoc, collection, query, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
        authDomain: "estimapres.firebaseapp.com",
        projectId: "estimapres",
        storageBucket: "estimapres.firebasestorage.app",
        messagingSenderId: "578516597437",
        appId: "1:578516597437:web:f59994b87729aa1cd655d4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let CONFIG = { name: "EstimaPres", location: "R铆o Gallegos", tasa: 120, alias: "pago.mp" };
    let currentLoanId = null;

    async function loadApp() {
        const d = await getDoc(doc(db, "settings", "main"));
        if(d.exists()) CONFIG = d.data();
        document.getElementById("brandName").innerText = CONFIG.name;
        document.getElementById("brandLoc").innerText = CONFIG.location;
        document.getElementById("cfgName").value = CONFIG.name;
        document.getElementById("cfgLoc").value = CONFIG.location;
        document.getElementById("cfgTna").value = CONFIG.tasa;
        document.getElementById("cfgAlias").value = CONFIG.alias;
    }

    // --- FUNCIONES CLIENTE ---
    window.simular = () => {
        const m = Number(document.getElementById("sMonto").value);
        const q = Number(document.getElementById("sCuotas").value);
        if(!m) return;
        const cuota = (m * (1 + (CONFIG.tasa/100))) / q;
        document.getElementById("resSim").classList.remove("hidden");
        document.getElementById("txtCuota").innerText = "$" + Math.round(cuota).toLocaleString();
    };

    window.enviarSolicitud = async () => {
        const data = {
            name: document.getElementById("fName").value,
            dni: document.getElementById("fDni").value,
            phone: document.getElementById("fTel").value,
            alias: document.getElementById("fAlias").value,
            amount: Number(document.getElementById("sMonto").value),
            months: Number(document.getElementById("sCuotas").value),
            status: "pendiente",
            date: serverTimestamp()
        };
        if(!data.name || !data.amount) return alert("Completa los datos");
        await addDoc(collection(db, "loans"), data);
        alert("Solicitud enviada");
        location.reload();
    };

    window.buscarPrestamo = async () => {
        const dni = document.getElementById("searchDni").value;
        const q = query(collection(db, "loans"), where("dni", "==", dni));
        const snap = await getDocs(q);
        const res = document.getElementById("searchRes");
        if(snap.empty) return res.innerHTML = "No se encontr贸 nada";
        
        const d = snap.docs[0].data();
        currentLoanId = snap.docs[0].id;
        let html = `<div style='padding:15px; background:rgba(255,255,255,0.05); border-radius:12px;'>
            <span class="pill status-pending">${d.status}</span>
            <h4>${d.name}</h4>`;
        
        if(d.status === 'aprobado') {
            html += `<button class="btn btn-primary" onclick="abrirFirma('${d.name}', '${d.amount}')">FIRMAR CONTRATO</button>`;
        } else if(d.status === 'activo') {
            html += `<p style='color:var(--ok)'>Pagar al Alias: <b>${CONFIG.alias}</b></p>`;
        }
        res.innerHTML = html + `</div>`;
    };

    // --- FUNCIONES ADMIN ---
    window.loginAdmin = () => {
        const pass = prompt("Contrase帽a:");
        if(pass === "1234") { // Cambiar por tu seguridad
            document.getElementById("viewClient").classList.add("hidden");
            document.getElementById("viewAdmin").classList.remove("hidden");
            loadAdminList();
        }
    };

    async function loadAdminList() {
        const snap = await getDocs(collection(db, "loans"));
        const list = document.getElementById("adminList");
        list.innerHTML = "";
        snap.forEach(docu => {
            const d = docu.data();
            const id = docu.id;
            list.innerHTML += `
                <div class="loan-row">
                    <div>
                        <b>${d.name}</b> <small>($${d.amount})</small><br>
                        <span class="pill status-pending">${d.status}</span>
                    </div>
                    <div>
                        ${d.status === 'pendiente' ? `<button onclick="actualizar('${id}', 'aprobado')">Aprobar</button>` : ''}
                        <button onclick="borrar('${id}')" style="color:red">X</button>
                    </div>
                </div>`;
        });
    }

    window.actualizar = async (id, s) => { await updateDoc(doc(db, "loans", id), {status: s}); loadAdminList(); };
    window.guardarConfig = async () => {
        const nc = { 
            name: document.getElementById("cfgName").value, 
            location: document.getElementById("cfgLoc").value,
            tasa: Number(document.getElementById("cfgTna").value),
            alias: document.getElementById("cfgAlias").value
        };
        await setDoc(doc(db, "settings", "main"), nc);
        alert("Sistema Actualizado");
        location.reload();
    };

    // --- LGICA DE FIRMA ---
    window.abrirFirma = (n, m) => {
        document.getElementById("legalTxt").innerText = `Yo ${n}, acepto el pr茅stamo de $${m} de la firma ${CONFIG.name} en ${CONFIG.location}.`;
        document.getElementById("modalFirma").classList.remove("hidden");
        const canvas = document.getElementById("sig-canvas");
        const ctx = canvas.getContext("2d");
        let drawing = false;
        canvas.onmousedown = canvas.ontouchstart = (e) => { drawing = true; ctx.beginPath(); };
        canvas.onmousemove = canvas.ontouchmove = (e) => { 
            if(!drawing) return;
            const r = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - r.left;
            const y = (e.clientY || e.touches[0].clientY) - r.top;
            ctx.lineTo(x, y); ctx.stroke();
        };
        window.onmouseup = window.ontouchend = () => drawing = false;
    };

    window.confirmarFirma = async () => {
        await updateDoc(doc(db, "loans", currentLoanId), { status: "activo" });
        alert("隆Contrato firmado!");
        location.reload();
    };

    loadApp();
</script>
</body>
</html>
