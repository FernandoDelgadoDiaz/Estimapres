<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EstimaPres ¬∑ Pr√©stamos personales</title>
<link rel="icon" href="assets/ping.png" />
<link rel="apple-touch-icon" href="assets/ping.png" />
<style>
  :root{
    --brand:#0e5bd7; --brand2:#0a45a7; --ink:#0b1220; --muted:#57607a;
    --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626; --bg:#f6f7fb; --chip:#0b2769;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .container{max-width:980px;margin:0 auto;padding:0 16px}
  /* ===== Header validado ===== */
  .hero{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:28px 0 18px}
  .brand-line{display:flex;align-items:center;gap:12px}
  .brand-logo{width:56px;height:56px;border-radius:14px;display:block}
  .brand-title{font-weight:800;letter-spacing:.5px;font-size:44px;line-height:1}
  .tagline{margin-top:14px;display:inline-block;background:rgba(255,255,255,.14);
           padding:12px 18px;border-radius:16px;font-size:18px;backdrop-filter:blur(2px)}
  .cta-row{display:flex;gap:14px;margin-top:16px;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:8px;border:2px solid rgba(255,255,255,.2);
       color:#fff;padding:12px 18px;border-radius:16px;font-weight:700;text-decoration:none;cursor:pointer}
  .btn:hover{border-color:#fff}
  .btn-red{background:#e23a3a;border-color:#e23a3a}
  /* ===== Cards ===== */
  .card{background:#fff;border-radius:18px;padding:22px;box-shadow:0 8px 24px rgba(2,8,20,.06);margin:16px 0}
  .card h2{margin:0 0 14px 0;font-size:40px}
  label{display:block;margin:14px 0 6px 4px;color:var(--muted);font-weight:600}
  input,button,select,textarea{font:inherit}
  .input{width:100%;padding:14px 16px;border-radius:12px;border:1px solid #d7dbe7;background:#fff}
  .primary{background:var(--ok);border:none;color:#fff;padding:12px 18px;border-radius:14px;font-weight:800;cursor:pointer}
  .primary:disabled{opacity:.6}
  .chip{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef4ff;color:var(--chip);font-weight:700}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row > *{flex:1 1 220px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px;border-bottom:1px solid #eef1f6;text-align:left}
  th{color:#223;opacity:.9}
  .pill{padding:6px 10px;border-radius:999px;font-weight:700}
  .paid{background:#dcfce7;color:#166534}
  .pend{background:#fff3d2;color:#8a5800}
  .btn-sm{padding:8px 12px;border-radius:10px;border:1px solid #dfe5f2;background:#fff;font-weight:700;cursor:pointer}
  .btn-green{background:#10b981;color:#fff;border-color:#10b981}
  .btn-red-ghost{border-color:#fecaca;color:#b91c1c;background:#fff}
  .note{color:var(--muted);font-size:14px}
  details summary{cursor:pointer;font-weight:800;margin:8px 0}
  .kpi{font-weight:800}
  /* ===== Modal login ===== */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:1000}
  .modal.show{display:flex}
  .modal-box{background:#fff;border-radius:16px;padding:20px;max-width:420px;width:calc(100% - 32px);box-shadow:0 10px 30px rgba(0,0,0,.15)}
  .modal h3{margin:0 0 10px 0}
</style>
</head>
<body>

<!-- ======= HEADER VALIDADO ======= -->
<header class="hero">
  <div class="container">
    <div class="brand-line">
      <img src="assets/ping.png" alt="EstimaPres" class="brand-logo" />
      <div class="brand-title">EstimaPres</div>
    </div>
    <div class="tagline">Pr√©stamos personales ¬∑ <em>simple y claro</em></div>
    <div class="cta-row">
      <a id="btnOpenMyLoan" href="#myloan" class="btn">üîé Ver mi pr√©stamo</a>
      <a id="btnAdmin" href="#admin" class="btn">üõ°Ô∏è Admin</a>
      <a id="btnLogout" href="#" class="btn btn-red" style="display:none">‚Ü™ Salir</a>
    </div>
  </div>
</header>

<main class="container">

  <!-- ===== Simulador ===== -->
  <section class="card">
    <h2>Simulador</h2>
    <div class="row">
      <div>
        <label>Monto</label>
        <input id="simAmount" class="input" placeholder="$ 1.000.000" inputmode="numeric">
      </div>
      <div>
        <label>Meses</label>
        <input id="simMonths" class="input" placeholder="Ej: 12" inputmode="numeric">
      </div>
    </div>
    <p class="note">TNA vigente: <span id="lblTna">‚Äî%</span> ¬∑ Vencimiento: d√≠a <span id="lblDue">‚Äî</span></p>
    <button id="btnSim" class="primary">Simular</button>
    <div id="simTable" class="card" style="display:none;margin-top:16px"></div>
  </section>

  <!-- ===== Solicitud ===== -->
  <section class="card">
    <h2>Solicitar pr√©stamo</h2>
    <div class="row">
      <div><label>Tu nombre</label><input id="rqName" class="input" placeholder="Juan P√©rez"></div>
      <div><label>DNI</label><input id="rqDni" class="input" placeholder="30123456" inputmode="numeric"></div>
    </div>
    <div class="row">
      <div><label>Email</label><input id="rqEmail" class="input" placeholder="tucorreo@mail.com"></div>
      <div><label>Tel√©fono</label><input id="rqPhone" class="input" placeholder="11 2345 6789"></div>
    </div>
    <div class="row">
      <div><label>alias o CBU/CVU</label><input id="rqCbu" class="input" placeholder="alias o CBU/CVU"></div>
      <div><label>Monto solicitado</label><input id="rqAmount" class="input" placeholder="$ 200.000" inputmode="numeric"></div>
    </div>
    <div class="row">
      <div><label>Cuotas (meses)</label><input id="rqMonths" class="input" placeholder="12" inputmode="numeric"></div>
    </div>
    <button id="btnRequest" class="primary">Enviar solicitud</button>
    <p class="note">Al enviar acept√°s ser contactado por EstimaPres.</p>
  </section>

  <!-- ===== Panel ADMIN ===== -->
  <section id="adminPanel" class="card" style="display:none">
    <h2>Panel administrador</h2>

    <details open>
      <summary>Configuraci√≥n (TNA y vencimiento)</summary>
      <div class="row">
        <div><label>TNA %</label><input id="admTna" class="input" placeholder="150" inputmode="numeric"></div>
        <div><label>Vencimiento (d√≠a del mes)</label><input id="admDue" class="input" placeholder="10" inputmode="numeric"></div>
      </div>
      <button id="btnSaveCfg" class="primary" style="margin-top:8px">Guardar</button>
      <span id="cfgSaved" class="note" style="margin-left:10px;display:none">Guardado ‚úì</span>
    </details>

    <details>
      <summary>Solicitudes pendientes</summary>
      <div id="listPend" class="note">Cargando‚Ä¶</div>
      <button id="btnReloadPend" class="btn-sm" style="margin-top:8px">Recargar</button>
    </details>

    <details>
      <summary>Preaprobados</summary>
      <div id="listPre" class="note">Cargando‚Ä¶</div>
      <button id="btnReloadPre" class="btn-sm" style="margin-top:8px">Recargar</button>
    </details>

    <details>
      <summary>Activos</summary>
      <div id="listAct" class="note">Cargando‚Ä¶</div>
      <button id="btnReloadAct" class="btn-sm" style="margin-top:8px">Recargar</button>
    </details>

    <details>
      <summary>Inactivos (finalizados / incobrables)</summary>
      <div class="row" style="margin:6px 0">
        <button id="btnShowClosed" class="btn-sm">Cancelados</button>
        <button id="btnShowCharged" class="btn-sm">Incobrables</button>
        <button id="btnReloadInac" class="btn-sm" style="margin-left:auto">Recargar</button>
      </div>
      <div id="listInac" class="note">Cargando‚Ä¶</div>
    </details>
  </section>

  <!-- ===== Ver mi pr√©stamo ===== -->
  <section id="myloan" class="card">
    <h2>Ver mi pr√©stamo</h2>
    <div class="row">
      <div><label>Ingres√° tu DNI</label><input id="myDni" class="input" placeholder="Ej: 30123456" inputmode="numeric"></div>
    </div>
    <button id="btnFindMyLoan" class="primary" style="margin-top:8px">Consultar</button>
    <div id="myLoanResult" class="card" style="display:none;margin-top:16px"></div>
  </section>

</main>

<!-- ===== Modal de login admin (Email/Password) ===== -->
<div id="loginModal" class="modal">
  <div class="modal-box">
    <h3>Acceso administrador</h3>
    <label>Email</label>
    <input id="admEmail" class="input" placeholder="tu@mail.com" />
    <label>Contrase√±a</label>
    <input id="admPass" class="input" type="password" placeholder="********" />
    <div class="row" style="margin-top:10px">
      <button id="btnDoLogin" class="primary">Entrar</button>
      <button id="btnCancelLogin" class="btn-sm">Cancelar</button>
    </div>
    <p class="note">Debe ser una cuenta autorizada.</p>
  </div>
</div>

<!-- =================== APP SCRIPT =================== -->
<script type="module">
/* ---------------- Firebase (CDN m√≥dulos) ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import {
  getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc,
  serverTimestamp, query, where, limit, getDocs
} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
import {
  getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

/* === TU CONFIG REAL (incrustada) === */
const firebaseConfig = {
  apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
  authDomain: "estimapres.firebaseapp.com",
  projectId: "estimapres",
  storageBucket: "estimapres.firebasestorage.app",
  messagingSenderId: "578516597437",
  appId: "1:578516597437:web:f59994b87729aa1cd655d4"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);

/* ---------------- Constantes ---------------- */
const ADMIN_EMAILS = ["fernandogastondelgado81@gmail.com"]; // whitelist
const nowTS = serverTimestamp;

/* ---------------- Utilidades UI ---------------- */
const $ = sel => document.querySelector(sel);
const moneyFmt = n => new Intl.NumberFormat('es-AR').format(Math.round(n||0));
const money = n => '$ ' + moneyFmt(n||0);
const onlyDigits = s => (s||'').replace(/[^\d]/g,'');
const parseMoney = s => Number(onlyDigits(String(s))||0);
function setMoneyInput(el){
  el.addEventListener('input', ()=>{
    const pos = el.selectionStart;
    const val = parseMoney(el.value);
    el.value = val ? money(val) : '';
    try{ el.setSelectionRange(pos,pos);}catch{}
  });
}

/* ---------------- Settings (TNA / dueDay) ---------------- */
let CFG = { tna:null, dueDay:10 };
async function loadSettings(show=true){
  try{
    const snap = await getDoc(doc(db,'settings','config'));
    if(snap.exists()){
      const d = snap.data();
      CFG.tna = Number(d.tna||0);
      CFG.dueDay = Number(d.dueDay||10);
    }
  }catch{}
  if(show){
    $('#lblTna').textContent = (CFG.tna!=null? CFG.tna : '‚Äî') + '%';
    $('#lblDue').textContent = CFG.dueDay||'‚Äî';
    $('#admTna').value = (CFG.tna!=null? CFG.tna : '');
    $('#admDue').value = (CFG.dueDay||'');
  }
}
$('#btnSaveCfg').onclick = async ()=>{
  const tna = Number(onlyDigits($('#admTna').value));
  const due = Number(onlyDigits($('#admDue').value||'10'))||10;
  if(!tna){ alert('Ingres√° una TNA v√°lida.'); return; }
  await setDoc(doc(db,'settings','config'), { tna, dueDay: due, updatedAt: nowTS() }, { merge:true });
  await loadSettings(true);
  $('#cfgSaved').style.display='inline';
  setTimeout(()=>$('#cfgSaved').style.display='none', 1500);
};

/* ---------------- Simulador ---------------- */
setMoneyInput($('#simAmount'));
function buildSchedule(amount,tna,months,firstDueDay){
  amount = Number(amount); months = Number(months); tna = Number(tna);
  const r = (tna/100)/12;
  const quota = r>0 ? amount * (r / (1 - Math.pow(1+r,-months))) : amount/months;
  const out = [];
  const base = new Date();
  base.setMonth(base.getMonth()+1);
  base.setDate(Math.min(firstDueDay,28));
  for(let i=1;i<=months;i++){
    const dt = new Date(base); dt.setMonth(base.getMonth()+ (i-1));
    out.push({ n:i, due: `${String(firstDueDay).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()}`, amount: Math.round(quota) });
  }
  return out;
}
$('#btnSim').onclick = ()=>{
  if(!CFG.tna){ alert('Configur√° la TNA desde Admin antes de simular.'); return; }
  const amount = parseMoney($('#simAmount').value);
  const months = Number(onlyDigits($('#simMonths').value||''));
  if(!amount||!months){ alert('Indic√° monto y meses.'); return; }
  const sched = buildSchedule(amount, CFG.tna, months, CFG.dueDay||10);
  $('#simTable').style.display='block';
  $('#simTable').innerHTML =
    `<div class="note">TNA ${CFG.tna}% ¬∑ Vencimiento d√≠a ${CFG.dueDay}</div>`+
    `<table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead>
     <tbody>${sched.map(r=>`<tr><td>${r.n}</td><td>${r.due}</td><td>${money(r.amount)}</td><td><span class="pill pend">Pendiente</span></td></tr>`).join('')}</tbody></table>`;
};

/* ---------------- Solicitud ---------------- */
setMoneyInput($('#rqAmount'));
$('#btnRequest').onclick = async ()=>{
  const name = $('#rqName').value.trim();
  const dni  = onlyDigits($('#rqDni').value);
  const email= $('#rqEmail').value.trim();
  const phone= $('#rqPhone').value.trim();
  const cbu  = $('#rqCbu').value.trim();
  const amount = parseMoney($('#rqAmount').value);
  const months = Number(onlyDigits($('#rqMonths').value));
  if(!name||!dni||!email||!amount||!months){ alert('Complet√° todos los datos.'); return; }
  try{
    await addDoc(collection(db,'loans'),{
      status:'pending',
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
      borrower:{ name, dni, email, phone, cbu },
      amount, months, tna: CFG.tna||null, dueDay: CFG.dueDay||10
    });
    alert('Solicitud enviada. La revisaremos a la brevedad.');
  }catch(e){ alert('No se pudo enviar la solicitud.'); }
};

/* ---------------- Admin: Email/Password ---------------- */
const adminAllowed = () => !!auth.currentUser && ADMIN_EMAILS.includes(auth.currentUser.email||'');
function showLoginModal(show){ $('#loginModal').classList.toggle('show', !!show); }
$('#btnAdmin').onclick = async (e)=>{
  e.preventDefault();
  if(adminAllowed()){
    $('#adminPanel').style.display='block';
    loadAllAdmin();
    window.scrollTo({top:$('#adminPanel').offsetTop-10,behavior:'smooth'});
    return;
  }
  showLoginModal(true);
};
$('#btnCancelLogin').onclick = ()=> showLoginModal(false);
$('#btnDoLogin').onclick = async ()=>{
  const email = $('#admEmail').value.trim();
  const pass  = $('#admPass').value;
  if(!email||!pass){ alert('Ingres√° email y contrase√±a.'); return; }
  try{
    await signInWithEmailAndPassword(auth, email, pass);
    if(!ADMIN_EMAILS.includes(email)){
      await signOut(auth);
      alert('Esta cuenta no est√° autorizada como admin.');
      return;
    }
    showLoginModal(false);
    $('#btnLogout').style.display='inline-flex';
    $('#adminPanel').style.display='block';
    await loadAllAdmin();
    window.scrollTo({top:$('#adminPanel').offsetTop-10,behavior:'smooth'});
  }catch(err){
    alert('Login inv√°lido. Verific√° email/contrase√±a del admin.');
  }
};
$('#btnLogout').onclick = async (ev)=>{ ev.preventDefault(); await signOut(auth); $('#btnLogout').style.display='none'; $('#adminPanel').style.display='none'; alert('Sesi√≥n cerrada.'); };

onAuthStateChanged(auth,(u)=>{
  const isAdmin = !!u && ADMIN_EMAILS.includes(u.email||'');
  $('#btnLogout').style.display  = isAdmin ? 'inline-flex' : 'none';
  $('#adminPanel').style.display = isAdmin ? 'block' : 'none';
  if(isAdmin) loadAllAdmin();
});

/* ---------------- Listados ADMIN (sin √≠ndices compuestos) ---------------- */
function tsToMs(ts){ if(!ts) return 0; if(typeof ts.toMillis==='function') return ts.toMillis(); if(ts.seconds) return ts.seconds*1000; return 0; }

async function loadPend(){
  const box = $('#listPend'); box.textContent="Cargando‚Ä¶";
  try{
    const ss = await getDocs(query(collection(db,'loans'), where('status','==','pending'), limit(200)));
    const arr=[]; ss.forEach(d=>arr.push({id:d.id, ...d.data()}));
    arr.sort((a,b)=>tsToMs(b.createdAt)-tsToMs(a.createdAt));
    if(!arr.length){ box.textContent='Sin pendientes'; return; }
    box.innerHTML='';
    arr.forEach(d=>{
      const el = document.createElement('div');
      el.className='card';
      el.innerHTML = `
        <div class="kpi">${d.borrower?.name||''} ¬∑ DNI ${d.borrower?.dni||''}</div>
        Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna||CFG.tna||'‚Äî'}%
        <div style="margin-top:10px" class="row">
          <button class="btn-sm btn-green" data-pre>Preaprobar</button>
          <button class="btn-sm btn-red-ghost" data-del>Eliminar</button>
        </div>`;
      el.querySelector('[data-pre]').onclick = async ()=>{
        if(!confirm('¬øPreaprobar y generar contrato?')) return;
        await updateDoc(doc(db,'loans',d.id),{
          status:'preapproved',
          contractId:(Math.random().toString(36).slice(2,10)).toUpperCase(),
          signed:false, updatedAt: serverTimestamp()
        });
        loadAllAdmin();
      };
      el.querySelector('[data-del]').onclick = async ()=>{
        if(!confirm('¬øEliminar solicitud?')) return;
        await updateDoc(doc(db,'loans',d.id),{ status:'deleted', updatedAt: serverTimestamp() });
        loadAllAdmin();
      };
      box.appendChild(el);
    });
  }catch(e){ box.textContent='No se pudieron leer las solicitudes (revis√° reglas).'; }
}
async function loadPre(){
  const box = $('#listPre'); box.textContent="Cargando‚Ä¶";
  try{
    const ss = await getDocs(query(collection(db,'loans'), where('status','==','preapproved'), limit(200)));
    const arr=[]; ss.forEach(d=>arr.push({id:d.id, ...d.data()}));
    arr.sort((a,b)=>tsToMs(b.updatedAt)-tsToMs(a.updatedAt));
    if(!arr.length){ box.textContent='Sin preaprobados'; return; }
    box.innerHTML='';
    arr.forEach(d=>{
      const signed = d.signed ? '<span class="pill paid">Firmado</span>' : '<span class="pill pend">Esperando firma</span>';
      const el=document.createElement('div');
      el.className='card';
      const link = location.origin+location.pathname+`#sign-${d.id}`;
      el.innerHTML = `
        <div class="kpi">${d.borrower?.name||''} ¬∑ DNI ${d.borrower?.dni||''} ¬∑ Contrato ${d.contractId||'-'} ¬∑ ${signed}</div>
        <div class="row" style="margin-top:10px">
          <button class="btn-sm" data-share>Compartir contrato</button>
          <button class="btn-sm" data-open>Abrir contrato</button>
          <button class="btn-sm btn-green" data-approve ${!d.signed?'disabled':''}>Aprobar & depositar</button>
        </div>`;
      el.querySelector('[data-share]').onclick = async ()=>{
        try{ await navigator.clipboard.writeText(link); alert('Link copiado. Pegalo en WhatsApp:\n'+link); }
        catch{ prompt('Copi√° el enlace:', link); }
      };
      el.querySelector('[data-open]').onclick = ()=> openContractWindow(d);
      el.querySelector('[data-approve]').onclick = async ()=>{
        if(!d.signed){ alert('A√∫n no est√° firmado.'); return; }
        await updateDoc(doc(db,'loans',d.id),{ status:'active', activeAt: serverTimestamp(), paidCount: d.paidCount||0, updatedAt: serverTimestamp() });
        loadAllAdmin();
      };
      box.appendChild(el);
    });
  }catch(e){ box.textContent='Error cargando preaprobados.'; }
}
async function loadAct(){
  const box = $('#listAct'); box.textContent="Cargando‚Ä¶";
  try{
    const ss = await getDocs(query(collection(db,'loans'), where('status','==','active'), limit(200)));
    const arr=[]; ss.forEach(d=>arr.push({id:d.id, ...d.data()}));
    arr.sort((a,b)=>tsToMs(b.activeAt)-tsToMs(a.activeAt));
    if(!arr.length){ box.textContent='Sin activos'; return; }
    box.innerHTML='';
    arr.forEach(d=>{
      const el=document.createElement('div');
      el.className='card';
      el.innerHTML = `
        <div class="kpi">${d.borrower?.name||''} ¬∑ DNI ${d.borrower?.dni||''}</div>
        Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna||CFG.tna}%
        <div class="row" style="margin-top:10px">
          <button class="btn-sm" data-view>Ver cuotas</button>
          <button class="btn-sm btn-green" data-paid>Pagado total</button>
          <button class="btn-sm btn-red-ghost" data-bad>A incobrables</button>
        </div>
        <div class="card" data-box style="display:none;margin-top:10px"></div>`;
      const boxRows = el.querySelector('[data-box]');
      el.querySelector('[data-view]').onclick = ()=>{
        boxRows.style.display='block';
        boxRows.innerHTML = renderScheduleAdmin(d);
      };
      el.querySelector('[data-paid]').onclick = async ()=>{
        if(Number(d.paidCount||0) < Number(d.months)){ alert('A√∫n hay cuotas pendientes.'); return; }
        await updateDoc(doc(db,'loans',d.id),{ status:'closed', updatedAt: serverTimestamp() });
        loadAllAdmin();
      };
      el.querySelector('[data-bad]').onclick = async ()=>{
        if(!confirm('¬øMover a incobrables?')) return;
        await updateDoc(doc(db,'loans',d.id),{ status:'charged_off', updatedAt: serverTimestamp() });
        loadAllAdmin();
      };
      box.appendChild(el);
    });
  }catch(e){ box.textContent='Error cargando activos.'; }
}
async function loadInac(kind='closed'){
  const box = $('#listInac'); box.textContent="Cargando‚Ä¶";
  try{
    const ss = await getDocs(query(collection(db,'loans'), where('status','==',kind), limit(200)));
    const arr=[]; ss.forEach(d=>arr.push({id:d.id, ...d.data()}));
    arr.sort((a,b)=>tsToMs(b.updatedAt)-tsToMs(a.updatedAt));
    if(!arr.length){ box.textContent='Sin inactivos'; return; }
    box.innerHTML='';
    arr.forEach(d=>{
      const el=document.createElement('div');
      el.className='card';
      el.innerHTML = `<div class="kpi">${d.borrower?.name||''} ¬∑ DNI ${d.borrower?.dni||''}</div>
        Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna||CFG.tna}% ¬∑ Contrato ${d.contractId||'-'}`;
      box.appendChild(el);
    });
  }catch(e){ box.textContent='Error cargando inactivos.'; }
}
function loadAllAdmin(){ loadPend(); loadPre(); loadAct(); loadInac('closed'); }
$('#btnReloadPend').onclick=loadPend;
$('#btnReloadPre').onclick=loadPre;
$('#btnReloadAct').onclick=loadAct;
$('#btnReloadInac').onclick=()=>loadInac('closed');
$('#btnShowClosed').onclick=()=>loadInac('closed');
$('#btnShowCharged').onclick=()=>loadInac('charged_off');

/* ----------- Cuotas (Admin marca en orden) ----------- */
function renderScheduleAdmin(L){
  const rows = buildSchedule(L.amount, L.tna, L.months, L.dueDay||CFG.dueDay||10);
  const paid = Number(L.paidCount||0);
  return `<table>
    <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th><th></th></tr></thead>
    <tbody>
      ${rows.map((r,i)=>`<tr>
        <td>${r.n}</td><td>${r.due}</td><td>${money(r.amount)}</td>
        <td>${i<paid?'<span class="pill paid">Pagada</span>':'<span class="pill pend">Pendiente</span>'}</td>
        <td>${i===paid?`<button class="btn-sm btn-green" data-mark="${r.n}" data-id="${L.id}">Marcar pagada</button>`:''}</td>
      </tr>`).join('')}
    </tbody></table>`;
}
document.addEventListener('click', async (ev)=>{
  const btn = ev.target.closest('[data-mark]');
  if(!btn) return;
  const n = Number(btn.getAttribute('data-mark'));
  const id = btn.getAttribute('data-id');
  try{
    const snap = await getDoc(doc(db,'loans',id));
    const d = snap.data(); const paid = Number(d.paidCount||0);
    if(n !== paid+1){ alert('Deb√©s marcar en orden.'); return; }
    await updateDoc(doc(db,'loans',id),{ paidCount: paid+1, updatedAt: serverTimestamp() });
    // refresco la tarjeta donde estoy
    const cont = btn.closest('.card').querySelector('[data-box]');
    cont.innerHTML = renderScheduleAdmin({id, ...d, paidCount:paid+1});
  }catch{ alert('No se pudo guardar el cambio.'); }
});

/* ---------------- Contrato / Firma ---------------- */
function contractA4(L){
  const rows = buildSchedule(L.amount, L.tna, L.months, L.dueDay||CFG.dueDay||10)
    .map(r=>`<tr><td>${r.n}</td><td>${r.due}</td><td style='text-align:right'>${money(r.amount)}</td></tr>`).join('');
  return `
  <style>
    @page{size:A4;margin:20mm}
    body{font-family:system-ui,Segoe UI,Inter;color:#111}
    h1{font-size:20px;margin:0 0 8px 0}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #999;padding:6px}
  </style>
  <h1>Contrato de pr√©stamo ‚Äî EstimaPres</h1>
  <p><b>Contrato:</b> ${L.contractId||'-'} ‚Äî <b>Cliente:</b> ${L.borrower?.name||''} ‚Äî <b>DNI:</b> ${L.borrower?.dni||''}</p>
  <p><b>Monto:</b> ${money(L.amount)} ‚Äî <b>TNA:</b> ${L.tna}% ‚Äî <b>Cuotas:</b> ${L.months} ‚Äî <b>Vencimiento:</b> d√≠a ${L.dueDay||CFG.dueDay||10}</p>
  <table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th></tr></thead><tbody>${rows}</tbody></table>
  <p style="margin-top:18px">Firma: __________________________ &nbsp;&nbsp; Aclaraci√≥n: _______________________</p>`;
}
function openContractWindow(L){
  const html = `
  <html lang="es"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Firma de contrato</title>
  <style>
    body{font-family:system-ui,Segoe UI,Inter;padding:18px}
    .box{max-width:760px;margin:0 auto;border:1px solid #e5e7eb;border-radius:14px;padding:22px}
    h1{margin-top:0}
    .input{width:100%;padding:12px;border-radius:10px;border:1px solid #dfe3ec}
    .primary{background:#0ea5e9;color:#fff;border:none;padding:12px 16px;border-radius:12px;font-weight:800}
  </style></head><body>
    <div class="box">
      <h1>Firma de contrato</h1>
      <p>Contrato N¬∞ <b>${L.contractId||''}</b> ‚Äî ${L.borrower?.name||''} ‚Äî DNI ${L.borrower?.dni||''}</p>
      <iframe style="width:100%;height:420px;border:1px solid #e5e7eb;border-radius:12px" srcdoc="${contractA4(L).replaceAll('"','&quot;')}"></iframe>
      <p>Escrib√≠ tu nombre y apellido para aceptar:</p>
      <input id="signName" class="input" placeholder="Nombre y apellido" />
      <div style="margin-top:10px"><button id="btnAccept" class="primary">Contrato aceptado</button></div>
    </div>
    <script>
      document.getElementById('btnAccept').onclick = ()=>{
        const v = (document.getElementById('signName').value||'').trim();
        if(!v){ alert('Escrib√≠ tu nombre y apellido'); return; }
        window.opener && window.opener.postMessage({type:'signed', id:'${L.id}', value:v}, '*');
        alert('¬°Contrato aceptado!');
        window.close();
      };
    <\/script>
  </body></html>`;
  const w = window.open('about:blank','_blank');
  w.document.write(html); w.document.close();
}
window.addEventListener('message', async (ev)=>{
  if(ev.data?.type==='signed' && ev.data?.id){
    try{
      await updateDoc(doc(db,'loans',ev.data.id),{ signed:true, signedName:ev.data.value, signedAt: serverTimestamp(), updatedAt: serverTimestamp() });
      alert('Firma registrada. Pod√©s aprobar desde el panel.');
      loadAllAdmin();
    }catch{ alert('No se pudo guardar la firma.'); }
  }
});
// abrir firma directo si llega por link #sign-<id>
async function tryOpenSignFromHash(){
  if(!location.hash.startsWith('#sign-')) return;
  const id = location.hash.replace('#sign-','').trim();
  const snap = await getDoc(doc(db,'loans',id));
  if(!snap.exists()) return;
  const L = {id, ...snap.data()};
  openContractWindow(L);
}

/* ---------------- Ver mi pr√©stamo (DNI) ---------------- */
$('#btnOpenMyLoan').onclick = (e)=>{ e.preventDefault(); const y=$('#myloan').offsetTop-8; window.scrollTo({top:y,behavior:'smooth'}); };
$('#btnFindMyLoan').onclick = async ()=>{
  const dni = onlyDigits($('#myDni').value);
  if(!dni){ $('#myLoanResult').style.display='block'; $('#myLoanResult').innerHTML='<span class="note">Ingres√° un DNI.</span>'; return; }
  $('#myLoanResult').style.display='block';
  $('#myLoanResult').innerHTML = '<span class="note">Buscando‚Ä¶</span>';
  try{
    const ss = await getDocs(query(collection(db,'loans'), limit(200))); // filtro client-side para evitar √≠ndice por campo anidado
    const list=[]; ss.forEach(d=>{ const L=d.data(); if((L.borrower?.dni||'')===dni) list.push({id:d.id,...L}); });
    if(!list.length){ $('#myLoanResult').innerHTML='No encontramos pr√©stamos para ese DNI.'; return; }
    const L = list[0];
    const paid = Number(L.paidCount||0);
    const rows = buildSchedule(L.amount, L.tna, L.months, L.dueDay||CFG.dueDay||10)
      .map((r,i)=>`<tr><td>${r.n}</td><td>${r.due}</td><td>${money(r.amount)}</td><td>${i<paid?'<span class="pill paid">Pagada</span>':'<span class="pill pend">Pendiente</span>'}</td></tr>`).join('');
    $('#myLoanResult').innerHTML = `
      <div class="kpi">Estado: ${L.status}</div>
      Monto: ${money(L.amount)} ¬∑ Cuotas: ${L.months} ¬∑ TNA: ${L.tna}% ¬∑ Progreso: <b class="kpi">${paid}/${L.months}</b>
      <div style="margin:10px 0"><button class="btn-sm" id="btnOpenPdf">Contrato PDF</button></div>
      <table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead><tbody>${rows}</tbody></table>`;
    $('#btnOpenPdf').onclick = ()=>{
      const w = window.open('about:blank','_blank');
      w.document.write(`<html><head><meta charset="utf-8"><title>Contrato</title></head><body>${contractA4(L)}</body></html>`);
      w.document.close();
    };
  }catch(e){ $('#myLoanResult').innerHTML='Error consultando tu pr√©stamo.'; }
};

/* ---------------- Init ---------------- */
await loadSettings(true);
tryOpenSignFromHash();
['#simAmount','#rqAmount'].forEach(sel=>{ const el=$(sel); if(el && !el.value) el.value='$ '; });
</script>
</body>
</html>