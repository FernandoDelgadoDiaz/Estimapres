<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
    <title>EstimaF ¬∑ Gesti√≥n Profesional</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --brand: #0e48c7; --success: #10b981; --danger: #ef4444; --bg: #08215e; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: #1e293b; padding-bottom: 40px; }
        .container { max-width: 550px; margin: 0 auto; padding: 15px; }
        .glass-card { background: white; border-radius: 24px; padding: 25px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        h3 { color: var(--brand); font-weight: 800; margin: 0 0 15px 0; }
        label { display: block; font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 16px; margin-bottom: 15px; box-sizing: border-box; }
        .btn-main { width: 100%; background: var(--brand); color: white; border: none; padding: 15px; border-radius: 15px; font-weight: 800; cursor: pointer; }
        .btn-tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        .tab { background: rgba(255,255,255,0.1); color: white; border: 1px solid white; padding: 8px 15px; border-radius: 20px; font-size: 12px; cursor: pointer; white-space: nowrap; }
        .tab.active { background: white; color: var(--brand); }
        .loan-card { background: #f8fafc; padding: 15px; border-radius: 15px; margin-bottom: 10px; border: 1px solid #e2e8f0; }
        .quota-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 13px; }
        .hidden { display: none !important; }
        header { text-align: center; color: white; padding: 30px 0; }
    </style>
</head>
<body>

<header>
    <h1>EstimaF</h1>
    <button id="btnStaff" style="background:none; border:1px solid white; color:white; padding:5px 15px; border-radius:20px;">Acceso Staff</button>
</header>

<div class="container">
    <div id="viewClient">
        <div class="glass-card">
            <h3>üìä Simulador</h3>
            <label>Monto ($)</label><input type="number" id="sMonto" placeholder="Ej: 100000">
            <label>Plazo</label><select id="sCuotas"><option value="12">12 Meses</option><option value="18">18 Meses</option></select>
            <button id="btnSim" class="btn-main">Calcular</button>
            <div id="resSim" class="hidden" style="text-align:center; font-size:20px; font-weight:800; margin-top:10px; color:var(--brand)"></div>
        </div>

        <div class="glass-card">
            <h3>üìù Solicitud</h3>
            <input id="fName" placeholder="Nombre y Apellido">
            <input id="fDni" type="number" placeholder="DNI">
            <input id="fTel" type="tel" placeholder="WhatsApp">
            <button id="btnSend" class="btn-main" style="background:var(--success)">Enviar Solicitud</button>
        </div>

        <div class="glass-card">
            <h3>üîç Mi Estado</h3>
            <div style="display:flex; gap:5px;"><input id="searchDni" type="number" placeholder="DNI"><button id="btnSearch" class="btn-main" style="width:100px;">Buscar</button></div>
            <div id="searchRes" class="hidden" style="margin-top:15px;"></div>
        </div>
    </div>

    <div id="viewAdmin" class="hidden">
        <div class="glass-card" style="padding:15px; background:#f1f5f9;">
            <h4 style="margin:0 0 10px 0">Configuraci√≥n Global</h4>
            <div style="display:flex; gap:10px;">
                <div><label>Inter√©s %</label><input type="number" id="cfgInteres" value="65" style="margin:0"></div>
                <div><label>D√≠a Vencimiento</label><input type="number" id="cfgVence" value="10" style="margin:0"></div>
            </div>
        </div>

        <div class="btn-tabs">
            <div class="tab active" onclick="filterAdmin('pending')">Solicitudes</div>
            <div class="tab" onclick="filterAdmin('waiting_signature')">Por Firmar</div>
            <div class="tab" onclick="filterAdmin('active')">Activos</div>
            <div class="tab" onclick="filterAdmin('finished')">Finalizados</div>
            <div id="btnLogout" class="tab" style="background:var(--danger)">Cerrar</div>
        </div>
        <div id="adminContent"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, doc, getDoc, getDocs, updateDoc, deleteDoc, collection, query, where, orderBy, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
        authDomain: "estimapres.firebaseapp.com",
        projectId: "estimapres",
        storageBucket: "estimapres.firebasestorage.app",
        messagingSenderId: "578516597437",
        appId: "1:578516597437:web:f59994b87729aa1cd655d4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const $ = s => document.querySelector(s);
    const fmt = n => "$ " + (Number(n) || 0).toLocaleString("es-AR");

    // --- LOGICA DE FECHAS ---
    const getVencimiento = (mesOffset, diaVence) => {
        let d = new Date();
        d.setMonth(d.getMonth() + mesOffset);
        return `${diaVence}/${d.getMonth() + 1}/${d.getFullYear()}`;
    };

    // --- SIMULADOR ---
    $("#btnSim").onclick = () => {
        const monto = Number($("#sMonto").value);
        const interes = Number($("#cfgInteres")?.value || 65) / 100;
        const cuota = Math.round((monto * (1 + interes)) / $("#sCuotas").value);
        $("#resSim").classList.remove("hidden");
        $("#resSim").innerText = "Cuota: " + fmt(cuota);
    };

    // --- ENVIAR SOLICITUD ---
    $("#btnSend").onclick = async () => {
        const monto = Number($("#sMonto").value);
        const interes = Number($("#cfgInteres")?.value || 65);
        if(!monto || !$("#fName").value) return alert("Faltan datos");
        await addDoc(collection(db, "loans"), {
            name: $("#fName").value,
            dni: $("#fDni").value,
            phone: $("#fTel").value,
            amount: monto,
            months: Number($("#sCuotas").value),
            rate: interes,
            diaVence: Number($("#cfgVence")?.value || 10),
            quota: Math.round((monto * (1 + (interes/100))) / $("#sCuotas").value),
            status: "pending",
            paidCount: 0,
            createdAt: serverTimestamp()
        });
        alert("Solicitud enviada.");
        location.reload();
    };

    // --- BUSCAR Y FIRMAR ---
    $("#btnSearch").onclick = async () => {
        const q = query(collection(db, "loans"), where("dni", "==", $("#searchDni").value));
        const snap = await getDocs(q);
        const res = $("#searchRes");
        res.classList.remove("hidden");
        if(snap.empty) return res.innerHTML = "No encontrado.";
        const d = snap.docs[0].data();
        const id = snap.docs[0].id;
        
        let html = `<div class="loan-card"><b>${d.name}</b><br>Estado: ${d.status}`;
        if(d.status === 'waiting_signature') {
            html += `<br><button class="btn-main" style="margin-top:10px; background:orange" onclick="window.firmarContrato('${id}')">LEER Y FIRMAR CONTRATO</button>`;
        }
        if(d.status === 'active') {
            html += `<br>Cuota: ${fmt(d.quota)}<br>Vence: d√≠a ${d.diaVence}`;
        }
        res.innerHTML = html + `</div>`;
    };

    window.firmarContrato = async (id) => {
        if(confirm("Al aceptar, declaras haber le√≠do el contrato y te comprometes al pago en R√≠o Gallegos, Santa Cruz. ¬øFirmar digitalmente?")) {
            await updateDoc(doc(db, "loans", id), { status: "active", fechaFirma: new Date().toLocaleDateString() });
            alert("Contrato firmado. Tu cr√©dito ya est√° activo.");
            location.reload();
        }
    };

    // --- ADMIN ---
    async function loadAdmin(statusFilter = 'pending') {
        const snap = await getDocs(query(collection(db, "loans"), orderBy("createdAt", "desc")));
        const cont = $("#adminContent");
        cont.innerHTML = "";
        snap.forEach(docu => {
            const d = { id: docu.id, ...docu.data() };
            if(d.status !== statusFilter) return;
            const card = document.createElement("div");
            card.className = "loan-card";
            card.innerHTML = `
                <b>${d.name}</b> <small>(${d.dni})</small>
                <br>Monto: ${fmt(d.amount)} | Tasa: ${d.rate}%
                <div style="margin-top:10px;">
                    ${d.status === 'pending' ? `<button onclick="window.pasarAFirma('${d.id}')">Generar Contrato</button>` : renderDetalle(d)}
                </div>
            `;
            cont.appendChild(card);
        });
    }

    function renderDetalle(d) {
        if(d.status === 'waiting_signature') return `<span style="color:orange">Esperando que el cliente firme...</span>`;
        let h = `<div style="margin-top:10px; border-top:1px solid #ddd;">`;
        for(let i=1; i<=d.months; i++) {
            const isPagado = d.paidCount >= i;
            h += `<div class="quota-item">
                    <span>Cuota ${i} (${getVencimiento(i, d.diaVence)})</span>
                    <b>${fmt(d.quota)}</b>
                    ${isPagado ? '<span style="color:green">PAGADO</span>' : `<button onclick="window.cobrar('${d.id}',${i})">Cobrar</button>`}
                  </div>`;
        }
        return h + `</div><button class="btn-main" style="margin-top:10px;" onclick="window.pdf('${d.id}')">Descargar Contrato PDF</button>`;
    }

    window.pasarAFirma = async id => { await updateDoc(doc(db,"loans",id), {status:"waiting_signature"}); loadAdmin('pending'); };
    window.cobrar = async (id, n) => { 
        const s = await getDoc(doc(db,"loans",id));
        const nStatus = n >= s.data().months ? "finished" : "active";
        await updateDoc(doc(db,"loans",id), {paidCount: n, status: nStatus}); 
        loadAdmin('active'); 
    };

    window.pdf = async (id) => {
        const s = await getDoc(doc(db,"loans",id));
        const d = s.data();
        const docPDF = new jspdf.jsPDF();
        const fecha = new Date().toLocaleDateString();
        
        docPDF.setFontSize(18); docPDF.text("CONTRATO DE PR√âSTAMO DE DINERO", 105, 20, {align:"center"});
        docPDF.setFontSize(11);
        let texto = `En la ciudad de R√≠o Gallegos, Provincia de Santa Cruz, Argentina, a los ${fecha}, se celebra el presente contrato entre EstimaF (el PRESTAMISTA) y ${d.name} DNI ${d.dni} (el PRESTATARIO).\n\n`;
        texto += `1. MONTO: El PRESTAMISTA entrega la suma de ${fmt(d.amount)}.\n`;
        texto += `2. INTER√âS: Se pacta una tasa de inter√©s del ${d.rate}% total sobre el capital.\n`;
        texto += `3. DEVOLUCI√ìN: El PRESTATARIO se obliga a devolver la suma de ${fmt(d.amount * (1+(d.rate/100)))} en ${d.months} cuotas de ${fmt(d.quota)}.\n`;
        texto += `4. VENCIMIENTO: Las cuotas vencen el d√≠a ${d.diaVence} de cada mes.\n`;
        texto += `5. MORA: Se establece un punitorio diario del 1.5% ante el incumplimiento.\n`;
        texto += `6. FIRMA DIGITAL: El presente contrato fue aceptado digitalmente el d√≠a ${d.fechaFirma || fecha}.`;
        
        docPDF.text(docPDF.splitTextToSize(texto, 170), 20, 40);
        docPDF.save(`Contrato_${d.dni}.pdf`);
    };

    window.filterAdmin = (s) => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        loadAdmin(s);
    };

    $("#btnStaff").onclick = () => { const p = prompt("Clave:"); if(p) signInWithEmailAndPassword(auth, "fernandogastondelgado81@gmail.com", p); };
    onAuthStateChanged(auth, user => { if(user) { $("#viewClient").classList.add("hidden"); $("#viewAdmin").classList.remove("hidden"); loadAdmin(); } });
    $("#btnLogout").onclick = () => signOut(auth).then(() => location.reload());
</script>
</body>
</html>
