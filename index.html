<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
    <title>EstimaF ¬∑ Sistema Integral de Gesti√≥n Financiera</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --brand: #0e48c7;
            --brand-dark: #08215e;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --glass: rgba(255, 255, 255, 0.98);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Plus Jakarta Sans', sans-serif; }
        
        body { 
            margin: 0; 
            background: radial-gradient(circle at top right, #1e52d5, #08215e); 
            background-attachment: fixed;
            min-height: 100vh;
            color: #1e293b;
            padding-bottom: 50px;
        }

        .container { max-width: 650px; margin: 0 auto; padding: 20px; }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-radius: 32px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            margin-bottom: 25px;
        }

        h1, h2, h3 { color: var(--brand); font-weight: 800; margin-top: 0; }

        .field { margin-bottom: 20px; }
        label { display: block; font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 8px; }
        
        input, select {
            width: 100%; padding: 16px; border-radius: 18px; border: 1.5px solid #e2e8f0;
            background: #f8fafc; font-size: 16px; font-weight: 600; color: #1e293b;
        }

        .btn-main {
            width: 100%; background: var(--brand); color: white; border: none; padding: 18px;
            border-radius: 20px; font-size: 17px; font-weight: 800; cursor: pointer;
            box-shadow: 0 10px 20px rgba(14, 72, 199, 0.3); transition: 0.3s;
        }
        .btn-main:active { transform: scale(0.98); }

        .btn-sec { 
            background: #f1f5f9; border: none; padding: 12px 20px; border-radius: 14px;
            font-size: 13px; font-weight: 700; color: #475569; cursor: pointer;
        }

        .btn-del { 
            background: #fee2e2; color: #ef4444; border: none; padding: 8px 12px; 
            border-radius: 10px; font-weight: 800; font-size: 11px; cursor: pointer; 
        }

        .status-badge { padding: 6px 12px; border-radius: 10px; font-size: 10px; font-weight: 800; text-transform: uppercase; display: inline-block; }
        .tag-pending { background: #fff7ed; color: #9a3412; }
        .tag-active { background: #dcfce7; color: #166534; }
        .tag-signed { background: #eff6ff; color: #1e40af; }

        .quota-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .hidden { display: none !important; }
        header { text-align: center; padding: 40px 0; color: white; }
    </style>
</head>
<body>

<header>
    <h1 style="margin:0; font-weight:800; font-size:38px; color:white;">EstimaF</h1>
    <div style="margin-top:10px;">
        <button id="btnStaff" class="btn-sec" style="background:rgba(255,255,255,0.2); color:white;">Acceso Staff</button>
        <button id="btnLogout" class="btn-sec hidden" style="color:var(--danger)">Cerrar Sesi√≥n</button>
    </div>
</header>

<main class="container">
    
    <div id="viewClient">
        <section class="glass-card">
            <h3>üìä Simulador</h3>
            <div class="field"><label>Monto</label><input type="number" id="sMonto" placeholder="Ej: 150.000"></div>
            <div class="field">
                <label>Plazo</label>
                <select id="sMeses"><option value="12">12 Cuotas</option><option value="18">18 Cuotas</option><option value="24">24 Cuotas</option></select>
            </div>
            <button id="btnSim" class="btn-main">Calcular Cuota</button>
            <div id="resSim" class="hidden" style="margin-top:20px; text-align:center; background:#eff6ff; padding:20px; border-radius:20px;">
                <label>Cuota Mensual:</label>
                <div id="valCuota" style="font-size:32px; font-weight:800; color:var(--brand);"></div>
            </div>
        </section>

        <section class="glass-card">
            <h3>üìù Solicitud</h3>
            <div class="field"><label>Nombre y Apellido</label><input id="fName" placeholder="Completo"></div>
            <div class="field"><label>DNI</label><input id="fDni" type="number" placeholder="Sin puntos"></div>
            <div class="field"><label>WhatsApp</label><input id="fTel" type="tel" placeholder="11..."></div>
            <button id="btnSend" class="btn-main" style="background:var(--success)">Enviar Datos</button>
        </section>

        <section class="glass-card">
            <h3>üîç Mi Estado</h3>
            <div style="display:flex; gap:10px;">
                <input id="searchDni" type="number" placeholder="Ingres√° DNI">
                <button id="btnSearch" class="btn-sec" style="height:55px;">Buscar</button>
            </div>
            <div id="searchBox" class="hidden" style="margin-top:15px; padding:15px; background:#f8fafc; border-radius:15px; text-align:center;"></div>
        </section>
    </div>

    <div id="viewSign" class="hidden">
        <section class="glass-card">
            <h3>üñãÔ∏è Firma de Contrato</h3>
            <div id="legalText" style="height:250px; overflow-y:auto; background:#f8fafc; padding:20px; border-radius:15px; font-size:13px; border:1px solid #e2e8f0; margin-bottom:20px; line-height:1.5;"></div>
            <div class="field"><label>Escrib√≠ tu nombre completo para firmar</label><input id="signInput" style="text-align:center; font-family:serif; font-size:22px;"></div>
            <button id="btnConfirmSign" class="btn-main">Firmar Contrato Digital</button>
        </section>
    </div>

    <div id="viewAdmin" class="hidden">
        <section class="glass-card">
            <h3>üì• Panel Administrativo</h3>
            <div id="loanList"></div>
        </section>
    </div>

</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, doc, getDoc, getDocs, updateDoc, deleteDoc, collection, query, where, orderBy, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
        authDomain: "estimapres.firebaseapp.com",
        projectId: "estimapres",
        storageBucket: "estimapres.firebasestorage.app",
        messagingSenderId: "578516597437",
        appId: "1:578516597437:web:f59994b87729aa1cd655d4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const ADMIN = "fernandogastondelgado81@gmail.com";

    const $ = s => document.querySelector(s);
    const fmt = n => "$ " + new Intl.NumberFormat('es-AR').format(n);

    // --- SESI√ìN Y VISTAS ---
    onAuthStateChanged(auth, user => {
        const hash = window.location.hash;
        if(user && user.email === ADMIN) {
            switchView("admin");
            loadAdmin();
        } else if(hash.startsWith("#sign-")) {
            switchView("sign");
            setupSign(hash.replace("#sign-", ""));
        } else {
            switchView("client");
        }
    });

    function switchView(v) {
        $("#viewClient").classList.toggle("hidden", v !== "client");
        $("#viewAdmin").classList.toggle("hidden", v !== "admin");
        $("#viewSign").classList.toggle("hidden", v !== "sign");
        $("#btnLogout").classList.toggle("hidden", v !== "admin");
        $("#btnStaff").classList.toggle("hidden", v === "admin");
    }

    // --- CLIENTE ---
    $("#btnSim").onclick = () => {
        const m = Number($("#sMonto").value);
        const q = Math.round((m * 1.6) / Number($("#sMeses").value));
        $("#resSim").classList.remove("hidden");
        $("#valCuota").innerText = fmt(q);
    };

    $("#btnSend").onclick = async () => {
        const m = Number($("#sMonto").value);
        if(!m || !$("#fName").value) return alert("Faltan datos");
        await addDoc(collection(db, "loans"), {
            name: $("#fName").value, dni: $("#fDni").value, phone: $("#fTel").value,
            amount: m, months: Number($("#sMeses").value), quota: Math.round((m * 1.6)/Number($("#sMeses").value)),
            status: "pending", createdAt: serverTimestamp()
        });
        alert("Enviado."); location.reload();
    };

    $("#btnSearch").onclick = async () => {
        const q = query(collection(db, "loans"), where("dni", "==", $("#searchDni").value));
        const snap = await getDocs(q);
        $("#searchBox").classList.remove("hidden");
        if(snap.empty) return $("#searchBox").innerText = "No encontrado.";
        const d = snap.docs[0].data();
        $("#searchBox").innerHTML = `<b>${d.name}</b><br>Estado: ${d.status.toUpperCase()}<br>Monto: ${fmt(d.amount)}`;
    };

    // --- FIRMA ---
    async function setupSign(id) {
        const snap = await getDoc(doc(db, "loans", id));
        const d = snap.data();
        $("#legalText").innerHTML = `<strong>CONTRATO DE MUTUO</strong><br><br>Yo, ${d.name}, DNI ${d.dni}, acepto el pr√©stamo de ${fmt(d.amount)} en ${d.months} cuotas de ${fmt(d.quota)}. El pago vence el 10 de cada mes. La mora es autom√°tica.`;
        $("#btnConfirmSign").onclick = async () => {
            if($("#signInput").value.length < 5) return alert("Nombre completo requerido");
            await updateDoc(doc(db, "loans", id), { status: "signed", signatureName: $("#signInput").value, signedAt: serverTimestamp() });
            alert("Firmado."); window.location.hash = ""; location.reload();
        };
    }

    // --- ADMIN ---
    async function loadAdmin() {
        const snap = await getDocs(query(collection(db, "loans"), orderBy("createdAt", "desc")));
        $("#loanList").innerHTML = "";
        snap.forEach(docu => {
            const d = { id: docu.id, ...docu.data() };
            const link = window.location.origin + window.location.pathname + "#sign-" + d.id;
            const item = document.createElement("div");
            item.className = "loan-item";
            item.style = "background:white; border-radius:20px; padding:20px; border:1px solid #f1f5f9; margin-bottom:15px;";
            item.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <div>
                        <span class="status-badge tag-${d.status}">${d.status}</span>
                        <div style="font-weight:800; font-size:18px; margin-top:5px;">${d.name || 'Sin Nombre'}</div>
                        <small>DNI: ${d.dni} | ${fmt(d.amount)}</small>
                    </div>
                    <button class="btn-del" onclick="window.eliminar('${d.id}')">Borrar</button>
                </div>
                <div style="margin-top:15px;">
                    ${d.status === 'pending' ? `<button class="btn-main" style="font-size:13px; padding:10px;" onclick="window.sendWA('${d.phone}', '${link}')">Enviar Link Firma (WhatsApp)</button>` : ''}
                    ${d.status === 'signed' ? `<button class="btn-main" style="background:var(--success)" onclick="window.activar('${d.id}')">Activar Pr√©stamo</button>` : ''}
                    ${d.status === 'active' ? renderCobranza(d) : ''}
                </div>`;
            $("#loanList").appendChild(item);
        });
    }

    function renderCobranza(d) {
        let h = '<div style="margin-top:15px; border-top:1px solid #f1f5f9;">';
        for(let i=1; i<=d.months; i++){
            const p = (d.paidCount || 0) >= i;
            h += `<div class="quota-item">Cuota ${i} (${fmt(d.quota)}) ${p ? '<b style="color:var(--success)">PAGADO</b>' : `<button class="btn-sec" onclick="window.cobrar('${d.id}',${i})">Cobrar</button>`}</div>`;
        }
        return h + `</div><button class="btn-sec" style="width:100%; margin-top:10px" onclick="window.descargarPDF('${d.id}')">Descargar Contrato PDF</button>`;
    }

    // --- ACCIONES GLOBALES ---
    window.eliminar = async id => { if(confirm("¬øEliminar?")) { await deleteDoc(doc(db, "loans", id)); loadAdmin(); } };
    window.activar = async id => { await updateDoc(doc(db, "loans", id), { status: "active", paidCount: 0 }); loadAdmin(); };
    window.cobrar = async (id, n) => { await updateDoc(doc(db, "loans", id), { paidCount: n }); loadAdmin(); };
    window.sendWA = (t, l) => window.open(`https://wa.me/${t}?text=Hola! Firma tu contrato aqu√≠: ${encodeURIComponent(l)}`);

    window.descargarPDF = async (id) => {
        const s = await getDoc(doc(db, "loans", id));
        const d = s.data();
        const { jsPDF } = window.jspdf;
        const docPDF = new jsPDF();
        docPDF.setFontSize(18); docPDF.text("CONTRATO DE MUTUO - ESTAMAF", 105, 20, {align:"center"});
        docPDF.setFontSize(10);
        const texto = [
            `PRIMERA: El Sr/Sra ${d.name.toUpperCase()}, DNI ${d.dni}, recibe la suma de ${fmt(d.amount)}.`,
            `SEGUNDA: La devoluci√≥n ser√° en ${d.months} cuotas de ${fmt(d.quota)}.`,
            `TERCERA: El vencimiento es el d√≠a 10 de cada mes. La mora genera inter√©s del 1% diario.`,
            `CUARTA: Las notificaciones enviadas al WhatsApp ${d.phone} se consideran v√°lidas.`,
            `QUINTA: El mutuario acepta que su firma digital tiene validez de declaraci√≥n jurada.`
        ];
        let y = 40;
        texto.forEach(t => { docPDF.text(t, 20, y); y += 10; });
        docPDF.line(20, 100, 90, 100); docPDF.text("FIRMA PRESTADOR", 35, 105);
        docPDF.line(120, 100, 190, 100); docPDF.text("FIRMA MUTUARIO", 140, 105);
        docPDF.setFont("courier","italic"); docPDF.text(d.signatureName || d.name, 140, 115);
        docPDF.save(`Contrato_${d.dni}.pdf`);
    };

    $("#btnStaff").onclick = () => { const p = prompt("Clave:"); if(p) signInWithEmailAndPassword(auth, ADMIN, p); };
    $("#btnLogout").onclick = () => signOut(auth).then(()=>location.reload());
</script>
</body>
</html>
