<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EstimaPres ¬∑ Pr√©stamos personales</title>
<link rel="icon" href="assets/ping.png"/>
<style>
  :root{
    --bg:#0b61ff; --bg2:#0a4fd6; --ink:#0b1324; --muted:#6b7280;
    --card:#fff; --border:#e5e7eb; --shadow:0 10px 24px #0b132409;
    --green:#16a34a; --red:#dc2626; --deep:#0f172a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:#f6f7fb;color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  .container{max-width:980px;margin:0 auto;padding:0 18px}

  /* ======= ENCABEZADO VALIDADO ======= */
  .hero{background:linear-gradient(135deg,var(--bg),var(--bg2));color:#fff;padding:26px 0 18px}
  .brand{display:flex;align-items:center;gap:14px}
  .brand img{width:56px;height:56px;border-radius:14px;background:#fff;box-shadow:0 6px 18px #00000025;object-fit:cover}
  .brand h1{font-size:44px;line-height:1;margin:0;font-weight:800;letter-spacing:.2px}
  .tagline{display:inline-block;margin-top:14px;background:#ffffff30;color:#eef2ff;border:1px solid #ffffff44;
    padding:10px 16px;border-radius:16px;font-weight:600}
  .navrow{display:flex;gap:14px;margin-top:18px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid #ffffff40;background:#ffffff18;color:#fff;border-radius:14px;padding:12px 18px;
    font-weight:700;display:inline-flex;align-items:center;gap:8px;backdrop-filter:blur(4px);cursor:pointer}
  .btn:hover{background:#ffffff28}
  .btn.danger{background:#ff4d4d;color:#fff;border:none}

  /* ======= Tarjetas / layout ======= */
  .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:20px;margin:20px 0;box-shadow:var(--shadow)}
  .card h2{margin:0 0 14px;font-size:40px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:760px){.row{grid-template-columns:1fr}.brand h1{font-size:38px}}
  label{font-weight:700;display:block;margin:8px 0 6px}
  input[type="text"],input[type="number"],input[type="email"],input[type="tel"],input[type="password"]{
    width:100%;padding:14px 16px;border:1px solid var(--border);border-radius:12px;font-size:16px;background:#fff}
  .muted{color:var(--muted)}
  .btn-cta{background:var(--green);color:#fff;border:none;border-radius:14px;padding:12px 18px;font-weight:800;cursor:pointer}
  .btn-ghost{background:#eef2ff;border:1px solid #e2e8f0;border-radius:12px;padding:9px 14px;font-weight:700;cursor:pointer}
  .right{margin-left:auto}
  table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left;font-size:15px}
  th{background:#f8fafc;font-weight:800}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px}
  .b-green{background:#dcfce7;color:#166534}
  .b-red{background:#fee2e2;color:#991b1b}
  .b-amber{background:#fef3c7;color:#92400e}
  .item{padding:14px;border:1px solid var(--border);border-radius:14px;margin:10px 0;background:#fff}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn-mini{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;font-weight:700;cursor:pointer}
  .btn-mini.green{background:#10b98122;border-color:#10b98144}
  .btn-mini.red{background:#ef444422;border-color:#ef444444}
  .group{border:1px dashed #e5e7eb;border-radius:14px;padding:12px 14px;margin:10px 0}
  .section-title{font-size:24px;margin:8px 0 10px}
  .tabs{display:flex;gap:10px;margin:8px 0 0}
  .tabs .tab{padding:10px 14px;border-radius:999px;border:1px solid var(--border);background:#fff;font-weight:700;cursor:pointer}
  .tabs .tab.active{background:#0f172a;color:#fff;border-color:#0f172a}
  .empty{color:var(--muted);padding:6px 0}

  /* Modal login */
  .modal{position:fixed;inset:0;background:#0007;display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{background:#fff;border-radius:16px;padding:18px;max-width:420px;width:92%;box-shadow:var(--shadow)}
  .modal .box h3{margin:0 0 10px}
  .modal .row2{display:grid;grid-template-columns:1fr;gap:10px}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
</style>
</head>
<body>

<header class="hero">
  <div class="container">
    <div class="brand">
      <img src="assets/ping.png" alt="EstimaPres"/>
      <h1>EstimaPres</h1>
    </div>
    <div class="tagline">Pr√©stamos personales ¬∑ <em>simple y claro</em></div>
    <div class="navrow">
      <button id="btnOpenMyLoan" class="btn">üîé Ver mi pr√©stamo</button>
      <button id="btnAdmin" class="btn">üõ°Ô∏è Admin</button>
      <button id="btnSignOut" class="btn danger">‚Ü™ Salir</button>
    </div>
  </div>
</header>

<main class="container">

  <!-- Simulador -->
  <section class="card" id="sim">
    <h2>Simulador</h2>
    <div class="row">
      <div>
        <label>Monto</label>
        <input id="simAmount" type="text" inputmode="numeric" placeholder="$ 1.000.000"/>
      </div>
      <div>
        <label>Meses</label>
        <input id="simMonths" type="number" placeholder="Ej: 12"/>
      </div>
    </div>
    <div class="muted" id="simMeta">TNA vigente: ‚Äî% ¬∑ Vencimiento: d√≠a ‚Äî</div>
    <div style="margin-top:12px;">
      <button id="btnSim" class="btn-cta">Simular</button>
    </div>
    <div id="simTable" style="margin-top:14px;"></div>
  </section>

  <!-- Solicitud -->
  <section class="card" id="req">
    <h2>Solicitar pr√©stamo</h2>
    <div class="row">
      <div>
        <label>Tu nombre</label>
        <input id="rName" type="text" placeholder="Juan P√©rez"/>
      </div>
      <div>
        <label>DNI</label>
        <input id="rDni" type="text" inputmode="numeric" placeholder="30123456"/>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Email</label>
        <input id="rEmail" type="email" placeholder="tucorreo@mail.com"/>
      </div>
      <div>
        <label>Tel√©fono</label>
        <input id="rPhone" type="tel" placeholder="11 2345 6789"/>
      </div>
    </div>
    <div>
      <label>alias o CBU/CVU</label>
      <input id="rCbu" type="text" placeholder="alias o CBU/CVU"/>
    </div>
    <div style="margin-top:12px;">
      <button id="btnSendReq" class="btn-cta">Enviar solicitud</button>
    </div>
    <div class="muted" style="margin-top:8px;">Al enviar acept√°s ser contactado por EstimaPres.</div>
  </section>

  <!-- Admin -->
  <section class="card" id="admin" style="display:none">
    <h2>Panel administrador</h2>

    <details open class="group">
      <summary class="section-title">Configuraci√≥n (TNA y vencimiento)</summary>
      <div class="row">
        <div>
          <label>TNA %</label>
          <input id="setTna" type="number" step="1" placeholder="Ej: 120"/>
        </div>
        <div>
          <label>Vencimiento (d√≠a del mes)</label>
          <input id="setDue" type="number" step="1" min="1" max="28" placeholder="Ej: 10"/>
        </div>
      </div>
      <div style="margin-top:12px;">
        <button id="btnSaveSettings" class="btn-cta">Guardar</button>
      </div>
    </details>

    <details class="group" id="blkPend">
      <summary class="section-title">Solicitudes pendientes</summary>
      <button class="btn-ghost" id="btnReloadPend">Recargar</button>
      <div id="listPend" class="empty">Sin pendientes</div>
    </details>

    <details class="group" id="blkPre">
      <summary class="section-title">Preaprobados</summary>
      <button class="btn-ghost" id="btnReloadPre">Recargar</button>
      <div id="listPre" class="empty">Sin preaprobados</div>
    </details>

    <details class="group" id="blkAct" open>
      <summary class="section-title">Activos</summary>
      <div class="muted" style="margin-bottom:8px;">‚óè Verde: al d√≠a ¬∑ ‚óè Amarillo: 6‚Äì10 d√≠as de mora ¬∑ ‚óè Rojo: &gt;10 d√≠as</div>
      <button class="btn-ghost" id="btnReloadAct">Recargar</button>
      <div id="listAct" class="empty">Sin activos</div>
    </details>

    <details class="group" id="blkInact" open>
      <summary class="section-title">Inactivos (finalizados / incobrables)</summary>
      <div class="tabs">
        <button class="tab active" id="tabDone">Cancelados</button>
        <button class="tab" id="tabBad">Incobrables</button>
        <button class="tab" id="btnReloadInact" style="margin-left:auto">Recargar</button>
      </div>
      <div id="listInact" class="empty">Sin inactivos</div>
    </details>
  </section>

  <!-- Mi pr√©stamo -->
  <section class="card" id="myloan">
    <h2>Ver mi pr√©stamo</h2>
    <div class="row">
      <div>
        <label>Ingres√° tu DNI</label>
        <input id="myDni" type="text" inputmode="numeric" placeholder="Ej: 30123456"/>
      </div>
    </div>
    <div style="margin-top:12px;">
      <button id="btnFindMyLoan" class="btn-cta">Consultar</button>
    </div>
    <div id="myLoanResult" style="margin-top:12px;"></div>
  </section>

</main>

<!-- Modal de login (email + contrase√±a) -->
<div id="loginModal" class="modal">
  <div class="box">
    <h3>Acceso administrador</h3>
    <div class="row2">
      <div>
        <label>Email</label>
        <input id="loginEmail" type="email" placeholder="tuemail@gmail.com"/>
      </div>
      <div>
        <label>Contrase√±a</label>
        <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
      </div>
    </div>
    <div class="actions">
      <button id="btnCancelLogin" class="btn-ghost">Cancelar</button>
      <button id="btnDoLogin" class="btn-cta">Ingresar</button>
    </div>
  </div>
</div>

<!-- Firebase + App -->
<script type="module">
/* ---------------- Firebase (config real) ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import {
  getFirestore, collection, doc, getDoc, setDoc, addDoc, getDocs,
  query, where, orderBy, limit, updateDoc, deleteDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
import {
  getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
  authDomain: "estimapres.firebaseapp.com",
  projectId: "estimapres",
  storageBucket: "estimapres.firebasestorage.app",
  messagingSenderId: "578516597437",
  appId: "1:578516597437:web:f59994b87729aa1cd655d4"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);

/* ---------------- Utilidades ---------------- */
const ADMIN_EMAIL = "fernandogastondelgado81@gmail.com";
const $ = s => document.querySelector(s);
const nowTS = () => serverTimestamp();
const onlyDigits = v => String(v||'').replace(/\D+/g,'');
const fmtMoney = n => '$ ' + new Intl.NumberFormat('es-AR',{maximumFractionDigits:0}).format(Math.round(Number(n||0)));
const parseMoney = s => Number(String(s||'').replace(/[^\d]/g,'')||0);
const NORM = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim().toUpperCase();

function formatCurrencyInput(el){
  const format = () => {
    const d = onlyDigits(el.value);
    el.value = d ? ('$ ' + new Intl.NumberFormat('es-AR').format(Number(d))) : '$ ';
  };
  el.addEventListener('input', format);
  if(!el.value) el.value = '$ ';
}
formatCurrencyInput($('#simAmount'));

/* ---------------- Settings (TNA / vencimiento) ---------------- */
async function loadSettings(){
  const snap = await getDoc(doc(db,'settings','config'));
  let tna=0, dueDay=10;
  if(snap.exists()){ const d=snap.data(); tna=Number(d.tna||0); dueDay=Number(d.dueDay||10); }
  $('#simMeta').textContent = `TNA vigente: ${tna||'‚Äî'}% ¬∑ Vencimiento: d√≠a ${tna?dueDay:'‚Äî'}`;
  $('#setTna').value = tna||''; $('#setDue').value = dueDay||'';
  return {tna,dueDay};
}
$('#btnSaveSettings').onclick = async ()=>{
  const t = Number($('#setTna').value||0);
  const d = Number($('#setDue').value||10);
  await setDoc(doc(db,'settings','config'), { tna:t, dueDay:d, updatedAt: nowTS() }, {merge:true});
  alert('Configuraci√≥n guardada.');
  await loadSettings();
};

/* ---------------- Simulador (m√°x. 24 cuotas) ---------------- */
function monthlyPayment(amount, months, tna){
  amount = Number(amount||0);
  months = Number(months||0);
  const i = Number(tna||0)/12/100;
  if(amount<=0 || months<=0 || !i) return 0;
  const c = i/ (1 - Math.pow(1+i, -months));
  return amount * c;
}
function scheduleRows(L){
  const rows=[];
  const amount = Number(L.amount);
  const months = Math.min(24, Number(L.months));   // l√≠mite duro
  const tna = Number(L.tna||0);
  const dueDay = Number(L.dueDay||10);
  const cuota = Math.round(monthlyPayment(amount, months, tna));
  const start = new Date();
  const baseMonth = start.getMonth();
  for(let n=1;n<=months;n++){
    const d = new Date(start.getFullYear(), baseMonth+n, 1);
    d.setMonth(baseMonth + n);
    d.setDate(Math.min(dueDay, 28));
    rows.push({ n,
      due: d.toLocaleDateString('es-AR',{day:'2-digit',month:'2-digit',year:'numeric'}),
      amount: cuota, paid: (n<=Number(L.paidCount||0)) });
  }
  return rows;
}
$('#btnSim').onclick = async ()=>{
  const {tna,dueDay} = await loadSettings();
  if(!tna){ alert('Configur√° la TNA desde Admin antes de simular.'); return; }
  const amount = parseMoney($('#simAmount').value);
  let months = Number($('#simMonths').value||0);
  if(months>24){ months=24; $('#simMonths').value=24; alert('El m√°ximo permitido es 24 cuotas.'); }
  if(!amount || !months){ $('#simTable').innerHTML=''; return; }

  const L = {amount, months, tna, dueDay, paidCount:0};
  const rows = scheduleRows(L);
  const tbody = rows.map(r=>
    `<tr><td>${r.n}</td><td>${r.due}</td><td>${fmtMoney(r.amount)}</td><td><span class="badge b-amber">Pendiente</span></td></tr>`
  ).join('');
  $('#simTable').innerHTML =
    '<table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead>'+
    '<tbody>'+tbody+'</tbody></table>';
};

/* ---------------- Solicitud (respeta m√°ximo 24) ---------------- */
$('#btnSendReq').onclick = async ()=>{
  const name = ($('#rName').value||'').trim();
  const dni  = onlyDigits($('#rDni').value);
  const email= ($('#rEmail').value||'').trim();
  const phone= ($('#rPhone').value||'').trim();
  const cbu  = ($('#rCbu').value||'').trim();
  if(!name || !dni || !email){ alert('Complet√° nombre, DNI y email.'); return; }
  const {tna,dueDay} = await loadSettings();
  if(!tna){ alert('A√∫n no hay TNA configurada.'); return; }

  const amount = parseMoney($('#simAmount').value) || 150000;
  let months = Number($('#simMonths').value||6);
  if(months>24){ months=24; $('#simMonths').value=24; alert('El m√°ximo permitido es 24 cuotas.'); }

  const borrower = { name, dni, email, phone, cbu };
  await addDoc(collection(db,'loans'),{
    amount, months, tna, dueDay, createdAt: nowTS(), updatedAt: nowTS(),
    status:'pending', borrower
  });
  alert('Solicitud enviada.');
  $('#rName').value=''; $('#rDni').value=''; $('#rEmail').value=''; $('#rPhone').value=''; $('#rCbu').value='';
  await loadPend();
};

/* ---------------- Auth (email + contrase√±a) ---------------- */
let currentUser=null, isAdmin=false;
const modal = $('#loginModal');
const openModal = ()=> modal.style.display='flex';
const closeModal = ()=> modal.style.display='none';

onAuthStateChanged(auth, async (u)=>{
  currentUser=u||null;
  isAdmin = !!(u && u.email===ADMIN_EMAIL);
  $('#admin').style.display = isAdmin ? 'block' : 'none';
});

$('#btnAdmin').onclick = async ()=>{
  if(isAdmin){ document.getElementById('admin').scrollIntoView({behavior:'smooth'}); return; }
  openModal();
};
$('#btnCancelLogin').onclick = closeModal;
$('#btnDoLogin').onclick = async ()=>{
  const email = ($('#loginEmail').value||'').trim();
  const pass  = $('#loginPass').value||'';
  if(!email || !pass){ alert('Complet√° email y contrase√±a'); return; }
  try{
    const cred = await signInWithEmailAndPassword(auth, email, pass);
    if(cred?.user?.email !== ADMIN_EMAIL){
      await signOut(auth);
      alert('No ten√©s permisos de administrador.');
      return;
    }
    closeModal();
    alert('Sesi√≥n iniciada.');
    await loadSettings(); await loadAllAdmin();
    document.getElementById('admin').scrollIntoView({behavior:'smooth'});
  }catch(e){ console.error(e); alert('No se pudo iniciar sesi√≥n.'); }
};

$('#btnSignOut').onclick = async ()=>{ try{ await signOut(auth); alert('Sesi√≥n cerrada.'); }catch(e){} };

/* ---------------- ADMIN LISTADOS ---------------- */
const ref = (c,id)=>doc(db,c,id);

async function loadPend(){
  const box = $('#listPend'); box.innerHTML="";
  try{
    const q = await getDocs(query(collection(db,'loans'), where('status','==','pending'), orderBy('createdAt','desc'), limit(50)));
    if(q.empty){ box.innerHTML='<div class="empty">Sin pendientes</div>'; return; }
    q.forEach(s=>{
      const d = s.data(); d.id=s.id;
      const el = document.createElement('div'); el.className='item';
      el.innerHTML =
        '<div class="flex"><div><b>'+ (d.borrower?.name||'') +
        '</b> ¬∑ DNI '+ (d.borrower?.dni||'') +'</div>'+
        '<div class="right muted">Principal '+fmtMoney(d.amount)+' ¬∑ '+d.months+' cuotas ¬∑ TNA '+d.tna+'%</div></div>'+
        '<div class="actions" style="margin-top:8px">'+
        '<button class="btn-mini green" data-act="pre">Preaprobar</button>'+
        '<button class="btn-mini red" data-act="del">Eliminar</button></div>';
      el.querySelector('[data-act="pre"]').onclick = async ()=>{
        if(!confirm('¬øPreaprobar y generar contrato?')) return;
        await updateDoc(ref('loans',d.id),{ status:'preapproved', contractId:(Math.random().toString(36).slice(2,10)).toUpperCase(), updatedAt: nowTS() });
        await loadAllAdmin();
      };
      el.querySelector('[data-act="del"]').onclick = async ()=>{
        if(!confirm('¬øEliminar solicitud?')) return;
        await deleteDoc(ref('loans',d.id));
        await loadAllAdmin();
      };
      box.appendChild(el);
    });
  }catch(e){ box.innerHTML='<div class="empty">No se pudieron leer las solicitudes.</div>'; }
}

async function loadPre(){
  const box = $('#listPre'); box.innerHTML="";
  try{
    const q = await getDocs(query(collection(db,'loans'), where('status','==','preapproved'), orderBy('createdAt','desc'), limit(50)));
    if(q.empty){ box.innerHTML='<div class="empty">Sin preaprobados</div>'; return; }
    q.forEach(s=>{
      const d = s.data(); d.id=s.id;
      const el = document.createElement('div'); el.className='item';
      const signed = d.signed ? '<span class="badge b-green">Firmado</span>' : '<span class="badge b-amber">Esperando firma</span>';
      el.innerHTML =
        '<div class="flex"><div><b>'+ (d.borrower?.name||'') +
        '</b> ¬∑ DNI '+ (d.borrower?.dni||'') +'</div><div class="right">'+signed+'</div></div>'+
        '<div class="muted" style="margin:6px 0">Contrato '+(d.contractId||'-')+'</div>'+
        '<div class="actions">'+
          '<button class="btn-mini" data-act="share">Compartir contrato</button>'+
          '<button class="btn-mini" data-act="pdf">Ver PDF</button>'+
          '<button class="btn-mini green" data-act="approve">Aprobar y depositar</button>'+
        '</div>';
      el.querySelector('[data-act="share"]').onclick = ()=>{
        const url = location.origin+location.pathname+'#sign-'+d.id;
        navigator.clipboard.writeText(url); alert('Enlace copiado:\n'+url);
      };
      el.querySelector('[data-act="pdf"]').onclick = ()=> openContract(d,false);
      el.querySelector('[data-act="approve"]').onclick = async ()=>{
        if(!d.signed){ alert('No pod√©s aprobar sin firma.'); return; }
        await updateDoc(ref('loans',d.id), { status:'active', activeAt: nowTS(), updatedAt: nowTS() });
        await loadAllAdmin();
      };
      box.appendChild(el);
    });
  }catch(e){ box.innerHTML='<div class="empty">Error leyendo preaprobados.</div>'; }
}

function moraDot(L){
  const rows = scheduleRows(L);
  const idx = rows.findIndex(r=>!r.paid);
  if(idx===-1) return 'üü¢';
  const nxt = rows[idx];
  const [dd,mm,yy] = nxt.due.split('/');
  const d = new Date(+yy, +mm-1, +dd);
  const delay = Math.floor((Date.now()-d.getTime())/86400000);
  if(delay>10) return 'üî¥';
  if(delay>=6) return 'üü°';
  return 'üü¢';
}

async function loadAct(){
  const box = $('#listAct'); box.innerHTML="";
  try{
    const q = await getDocs(query(collection(db,'loans'), where('status','==','active'), orderBy('activeAt','desc'), limit(80)));
    if(q.empty){ box.innerHTML='<div class="empty">Sin activos</div>'; return; }
    q.forEach(s=>{
      const L = s.data(); L.id=s.id;
      const el = document.createElement('div'); el.className='item';
      el.innerHTML =
        '<div class="flex"><div><b>'+(L.borrower?.name||'')+
        '</b> ¬∑ DNI '+(L.borrower?.dni||'')+' ¬∑ '+moraDot(L)+'</div>'+
        '<div class="right muted">Principal '+fmtMoney(L.amount)+' ¬∑ '+L.months+' cuotas ¬∑ TNA '+L.tna+'%</div></div>'+
        '<div class="actions" style="margin-top:8px">'+
          '<button class="btn-mini" data-act="cuotas">Ver cuotas</button>'+
          '<button class="btn-mini green" data-act="paidall">Pagado total</button>'+
          '<button class="btn-mini red" data-act="bad">A incobrables</button>'+
        '</div>'+
        '<div class="hide" data-box="cuotas"></div>';
      el.querySelector('[data-act="cuotas"]').onclick = ()=>{
        const rows = scheduleRows(L);
        const box2 = el.querySelector('[data-box="cuotas"]');
        const body = rows.map(r=>{
          const action = r.paid
            ? '<span class="badge b-green">Pagada</span>'
            : '<button class="btn-mini" data-n="'+r.n+'">Marcar pagada</button>';
          return '<tr><td>'+r.n+'</td><td>'+r.due+'</td><td>'+fmtMoney(r.amount)+'</td><td>'+action+'</td></tr>';
        }).join('');
        box2.innerHTML =
          '<div style="margin-top:10px">'+
            '<div class="muted" style="margin-bottom:6px">Progreso: <b>'+(L.paidCount||0)+'/'+L.months+'</b></div>'+
            '<table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead>'+
            '<tbody>'+body+'</tbody></table></div>';
        box2.classList.toggle('hide');
        box2.querySelectorAll('[data-n]')?.forEach(btn=>{
          btn.onclick = async ()=>{
            const n = Number(btn.getAttribute('data-n'));
            if(n!==Number(L.paidCount||0)+1){ alert('Pagos en orden: marc√° la pr√≥xima cuota pendiente.'); return; }
            await updateDoc(ref('loans',L.id), { paidCount:(Number(L.paidCount||0)+1), updatedAt: nowTS() });
            await loadAct();
          };
        });
      };
      el.querySelector('[data-act="paidall"]').onclick = async ()=>{
        if(Number(L.paidCount||0) < Number(L.months||0)){ alert('Quedan cuotas pendientes.'); return; }
        if(!confirm('Marcar como cancelado?')) return;
        await updateDoc(ref('loans',L.id), { status:'paid_off', finishedAt: nowTS(), updatedAt: nowTS() });
        await loadAllAdmin();
      };
      el.querySelector('[data-act="bad"]').onclick = async ()=>{
        const reason = prompt('Motivo o detalle del incumplimiento (obligatorio):','Mora prolongada');
        if(!reason || !reason.trim()) return;
        await updateDoc(ref('loans',L.id), { status:'charged_off', defaultAt: nowTS(), defaultNote: reason.trim(), updatedAt: nowTS() });
        await loadAllAdmin();
      };
      box.appendChild(el);
    });
  }catch(e){ box.innerHTML='<div class="empty">Error leyendo activos.</div>'; }
}

async function loadInact(which='paid_off'){
  const box = $('#listInact'); box.innerHTML="";
  try{
    const q = await getDocs(query(collection(db,'loans'), where('status','==',which), orderBy('updatedAt','desc'), limit(80)));
    if(q.empty){ box.innerHTML='<div class="empty">Sin inactivos</div>'; return; }
    q.forEach(s=>{
      const d = s.data(); d.id=s.id;
      const el = document.createElement('div'); el.className='item';
      const extra = (which==='charged_off' && d.defaultNote)
        ? `<div class="muted" style="margin:6px 0"><b>Incumplimiento:</b> ${d.defaultNote}</div>`
        : '';
      const buttons = (which==='charged_off')
        ? `<button class="btn-mini" data-act="pdf">Contrato PDF</button>
           <button class="btn-mini" data-act="share">Compartir</button>
           <button class="btn-mini red" data-act="del">Eliminar</button>`
        : `<button class="btn-mini red" data-act="del">Eliminar</button>`;
      el.innerHTML =
        '<div class="flex"><div><b>'+(d.borrower?.name||'')+
        '</b> ¬∑ DNI '+(d.borrower?.dni||'')+'</div>'+
        '<div class="right muted">Principal '+fmtMoney(d.amount)+' ¬∑ '+d.months+' cuotas ¬∑ TNA '+d.tna+'% ¬∑ Contrato '+(d.contractId||'-')+'</div></div>'+
        extra+
        '<div class="actions" style="margin-top:8px">'+
          buttons+
        '</div>';
      if(which==='charged_off'){
        el.querySelector('[data-act="pdf"]').onclick = ()=> openContract(d,false);
        el.querySelector('[data-act="share"]').onclick = ()=>{
          const text = `Deudor: ${d.borrower?.name||'-'} ¬∑ DNI ${d.borrower?.dni||'-'}%0A`+
                       `Contrato: ${d.contractId||'-'} ¬∑ Principal ${fmtMoney(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}%0A`+
                       `Incumplimiento: ${d.defaultNote||'-'}`;
          const urlWa = `https://wa.me/?text=${text}`;
          const mail = `mailto:?subject=Gesti√≥n legal - Incumplimiento EstimaPres&body=${text}`;
          if(navigator.share){
            navigator.share({title:'Incumplimiento EstimaPres', text:decodeURIComponent(text)}).catch(()=>{});
          }else{
            window.open(urlWa,'_blank'); setTimeout(()=>window.location.href=mail,200);
          }
        };
      }
      el.querySelector('[data-act="del"]').onclick = async ()=>{
        if(!confirm('Eliminar definitivamente este registro?')) return;
        await deleteDoc(ref('loans',d.id));
        await loadInact(which);
      };
      box.appendChild(el);
    });
  }catch(e){ box.innerHTML='<div class="empty">Error leyendo inactivos.</div>'; }
}

async function loadAllAdmin(){ await Promise.all([loadSettings(), loadPend(), loadPre(), loadAct(), loadInact(currentInactTab)]); }
let currentInactTab='paid_off';
$('#tabDone').onclick = ()=>{ currentInactTab='paid_off'; $('#tabDone').classList.add('active'); $('#tabBad').classList.remove('active'); loadInact('paid_off'); };
$('#tabBad').onclick  = ()=>{ currentInactTab='charged_off'; $('#tabBad').classList.add('active'); $('#tabDone').classList.remove('active'); loadInact('charged_off'); };
$('#btnReloadPend').onclick = loadPend;
$('#btnReloadPre').onclick  = loadPre;
$('#btnReloadAct').onclick  = loadAct;
$('#btnReloadInact').onclick= ()=>loadInact(currentInactTab);

/* ---------------- Contrato (PDF / Firma) ---------------- */
function contractHtml(L, forSigner){
  const rows = scheduleRows(L).map(r=>
    `<tr><td>${r.n}</td><td>${r.due}</td><td>${fmtMoney(r.amount)}</td><td>${r.paid?'Pagada':'Pendiente'}</td></tr>`
  ).join('');

  const today = new Date();
  const fecha = today.toLocaleDateString('es-AR',{day:'2-digit',month:'long',year:'numeric'});

  const legal = `
  <div class="box">
    <h2 style="margin:0 0 6px;font-size:18px">Contrato de Pr√©stamo Personal</h2>
    <p>Entre <b>ESTIMAPRES</b>, en adelante <b>EL PRESTAMISTA</b>, y <b>${(L.borrower?.name||'-')}</b>, DNI ${(L.borrower?.dni||'-')}, con email ${(L.borrower?.email||'-')} y tel√©fono ${(L.borrower?.phone||'-')}, en adelante <b>EL PRESTATARIO</b>, se celebra el presente contrato en la ciudad de <b>R√≠o Gallegos, Santa Cruz, Argentina</b>, a los <b>${fecha}</b>.</p>
    <ol style="padding-left:18px;line-height:1.5">
      <li><b>Monto y destino:</b> EL PRESTAMISTA entrega a EL PRESTATARIO la suma de <b>${fmtMoney(L.amount)}</b>, que este declara recibir a su entera satisfacci√≥n.</li>
      <li><b>Tasa y sistema:</b> La TNA aplicable es del <b>${L.tna}%</b>. El c√°lculo de cuotas se efect√∫a por sistema franc√©s. Cantidad de cuotas: <b>${L.months}</b>. Vencimiento mensual el d√≠a <b>${L.dueDay}</b>.</li>
      <li><b>Pago:</b> Las cuotas deben abonarse en t√©rmino. La falta de pago de una cuota habilita el devengamiento de intereses compensatorios hasta la fecha de pago efectivo.</li>
      <li><b>Mora:</b> Verificado el atraso, EL PRESTATARIO incurre en mora autom√°tica, pudiendo EL PRESTAMISTA exigir la <b>aceleraci√≥n</b> del saldo y gestionar el cobro por las v√≠as correspondientes.</li>
      <li><b>Medios de pago:</b> Transferencia a CBU/CVU/alias informado por EL PRESTAMISTA. EL PRESTATARIO declara su CBU/alias: ${(L.borrower?.cbu||'-')}.</li>
      <li><b>Gastos:</b> Todo gasto y/o honorario derivado de la gesti√≥n de cobro ser√° a cargo de EL PRESTATARIO.</li>
      <li><b>Cesi√≥n:</b> EL PRESTAMISTA podr√° ceder o endosar el cr√©dito sin necesidad de autorizaci√≥n.</li>
      <li><b>Jurisdicci√≥n:</b> Las partes se someten a los tribunales ordinarios de la ciudad de <b>R√≠o Gallegos</b>, renunciando a cualquier otro fuero y/o jurisdicci√≥n.</li>
      <li><b>Datos personales:</b> EL PRESTATARIO autoriza el tratamiento de sus datos a efectos del presente contrato y la eventual gesti√≥n de cobro.</li>
    </ol>
  </div>`;

  const incumpl = (L.status==='charged_off')
    ? `<div class="box" style="border-color:#fca5a5;background:#fff7f7">
         <h2 style="margin:0 0 6px;font-size:18px;color:#b91c1c">Incumplimiento</h2>
         <p>El presente cr√©dito se encuentra en estado <b>INCOBRABLE</b>. Detalle informado por el √°rea de cobranzas:</p>
         <p style="white-space:pre-wrap"><b>${(L.defaultNote||'Sin detalle')}</b></p>
         <p>Se autoriza su uso para gesti√≥n extrajudicial y/o judicial.</p>
       </div>`
    : '';

  const accionesAdmin = forSigner
    ? ''
    : `<div class="box">
        <button id="btnPrint" style="margin-right:8px;padding:10px 16px;background:#0f172a;color:#fff;border:none;border-radius:10px;font-weight:800">Imprimir / Guardar PDF</button>
        <button id="btnShareWa" style="margin-right:8px;padding:10px 16px;border:1px solid #25d366;color:#075e54;background:#e8fff1;border-radius:10px;font-weight:800">WhatsApp</button>
        <button id="btnShareMail" style="padding:10px 16px;border:1px solid #0ea5e9;color:#0ea5e9;background:#f0f9ff;border-radius:10px;font-weight:800">Email</button>
      </div>`;

  const signerBlock = forSigner
    ? `<div class="box">
        <div class="muted" style="margin-bottom:6px">Titular: <b>${(L.borrower?.name||'-')}</b> ¬∑ DNI ${(L.borrower?.dni||'-')}</div>
        <label>Escrib√≠ tu nombre y apellido exactamente como figura arriba</label>
        <input id="signName" style="width:100%;padding:10px;margin-top:8px" placeholder="${(L.borrower?.name||'')}"/>
        <button id="btnAccept" style="margin-top:10px;padding:10px 16px;background:#16a34a;color:#fff;border:none;border-radius:10px;font-weight:800">Acepto contrato</button>
      </div>`
    : '';

  return '<!doctype html><html><head><meta charset="utf-8"><title>Contrato '+(L.contractId||'')+'</title>'+
  '<style>@page{size:A4;margin:18mm}body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:18px;color:#111}h1{margin:0 0 6px}h2{font-size:16px}.muted{color:#666}.box{border:1px solid #ddd;padding:12px;border-radius:10px;margin-top:10px}table{width:100%;border-collapse:collapse;margin-top:10px}th,td{border:1px solid #ccc;padding:6px 8px;font-size:12px;text-align:left}th{background:#f2f2f2}</style></head>'+
  '<body>'+
    '<h1>Contrato de pr√©stamo ‚Äî EstimaPres</h1>'+
    '<div class="muted">N¬∫ '+(L.contractId||'-')+' ¬∑ '+(L.borrower?.name||'')+' ¬∑ DNI '+(L.borrower?.dni||'')+'</div>'+
    legal+
    '<div class="box"><b>Plan de pagos</b></div>'+
    '<table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead><tbody>'+rows+'</tbody></table>'+
    incumpl+
    accionesAdmin+
    signerBlock+
  '<script>(function(){function N(s){return String(s||"").normalize("NFD").replace(/[\\u0300-\\u036f]/g,"").replace(/\\s+/g," ").trim().toUpperCase()}var p=document.getElementById("btnPrint");if(p){p.addEventListener("click",function(){window.print()})}var wa=document.getElementById("btnShareWa"), em=document.getElementById("btnShareMail");if(wa||em){var txt="Contrato EstimaPres%0ADeudor: '+(L.borrower?.name||'-')+' ¬∑ DNI '+(L.borrower?.dni||'-')+'%0AN¬∫ '+(L.contractId||'-')+' ¬∑ Principal '+(''+'+fmtMoney(L.amount)+'').replace('$ ','$')+' ¬∑ '+(L.months)+' cuotas ¬∑ TNA '+(L.tna)+'%";if(wa){wa.addEventListener("click",function(){var u=\'https://wa.me/?text=\'+txt;window.open(u,"_blank")})}if(em){em.addEventListener("click",function(){var u=\'mailto:?subject=Contrato EstimaPres&body=\'+txt;location.href=u})}}var a=document.getElementById("btnAccept");if(a){var expected=N("'+(L.borrower?.name||'')+'");a.addEventListener("click",function(){var n=(document.getElementById("signName").value||"").trim();if(!n){alert("Escrib√≠ tu nombre y apellido");return}if(N(n)!==expected){alert("El nombre no coincide con el titular. Verific√° y volv√© a intentar.");return}window.opener&&window.opener.postMessage({type:"signed",id:"'+(L.id||'')+'",value:n},"*");alert("Contrato aceptado!");window.close()})}})();<\/script>'+
  '</body></html>';
}
function openContract(L, forSigner){
  const w = window.open('about:blank','_blank');
  w.document.open(); w.document.write(contractHtml(L,forSigner)); w.document.close();
}

/* Revalida nombre del lado del panel antes de grabar */
window.addEventListener('message', async (ev)=>{
  try{
    if(!ev?.data || ev.data.type!=='signed') return;
    const id = ev.data.id, signName = ev.data.value;
    const snap = await getDoc(doc(db,'loans',id));
    if(!snap.exists()){ alert('No se encontr√≥ el pr√©stamo para registrar firma.'); return; }
    const d = snap.data();
    const expected = NORM(d?.borrower?.name||'');
    if(NORM(signName)!==expected){
      alert('Firma rechazada: el nombre no coincide con el titular.');
      try{ ev.source && ev.source.postMessage({type:'sign_error'},'*'); }catch(_){}
      return;
    }
    await updateDoc(doc(db,'loans',id), { signed:true, signedName: signName, signedAt: nowTS(), updatedAt: nowTS() });
    alert('Firma registrada. Pod√©s aprobar desde el panel.');
    await loadAllAdmin();
  }catch(e){ console.error(e); alert('No se pudo guardar la firma.'); }
});

/* Abrir contrato para firmar si viene con #sign- */
(async function tryOpenSignFromHash(){
  if(!location.hash.startsWith('#sign-')) return;
  const id = location.hash.replace('#sign-','').trim();
  const snap = await getDoc(doc(db,'loans',id));
  if(!snap.exists()) return;
  const L = snap.data(); L.id=id; openContract(L,true);
})();

/* ---------------- Mi pr√©stamo (usuario) ‚Äî DOM seguro ---------------- */
$('#btnOpenMyLoan').onclick = ()=>$('#myloan').scrollIntoView({behavior:'smooth'});

$('#btnFindMyLoan').onclick = async ()=>{
  const dni = onlyDigits($('#myDni').value);
  const box = $('#myLoanResult');
  if(!dni){ box.textContent='Ingres√° un DNI.'; return; }
  box.textContent='Buscando‚Ä¶';
  try{
    const qs = await getDocs(query(collection(db,'loans'), orderBy('createdAt','desc'), limit(100)));
    const list=[]; qs.forEach(d=>{ const L=d.data(); if((L?.borrower?.dni||'')===dni) list.push({id:d.id,...L}); });
    if(!list.length){ box.textContent='No encontramos pr√©stamos activos o preaprobados para ese DNI.'; return; }

    const L = list[0];
    const rows = scheduleRows(L);
    const paid = Number(L.paidCount||0);

    box.innerHTML='';
    const wrapper = document.createElement('div'); wrapper.className='item';

    const top = document.createElement('div'); top.className='flex';
    const strong = document.createElement('strong');
    strong.textContent = 'Estado: '+L.status;
    const meta = document.createElement('span'); meta.className='right muted';
    meta.innerHTML = ' Monto: '+fmtMoney(L.amount)+' ¬∑ Cuotas: '+L.months+' ¬∑ TNA: '+L.tna+'% ¬∑ Progreso: <b>'+paid+'/'+L.months+'</b>';
    top.appendChild(strong); top.appendChild(meta);
    wrapper.appendChild(top);

    if(L.contractId){
      const btn = document.createElement('button');
      btn.className='btn-cta'; btn.textContent='Contrato PDF';
      btn.style.marginTop='8px';
      btn.addEventListener('click', ()=>openContract(L,false));
      wrapper.appendChild(btn);
    }

    const table = document.createElement('table'); table.style.marginTop='10px';
    const thead = document.createElement('thead');
    thead.innerHTML = '<tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr>';
    table.appendChild(thead);
    const tbody = document.createElement('tbody');
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML =
        '<td>'+r.n+'</td>'+
        '<td>'+r.due+'</td>'+
        '<td>'+fmtMoney(r.amount)+'</td>'+
        '<td>'+(r.paid?'<span class="badge b-green">Pagada</span>':'<span class="badge b-amber">Pendiente</span>')+'</td>';
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    wrapper.appendChild(table);

    box.appendChild(wrapper);

  }catch(e){
    console.error(e);
    box.textContent='Error consultando.';
  }
};

/* ---------------- Init ---------------- */
await loadSettings();
</script>
</body>
</html>