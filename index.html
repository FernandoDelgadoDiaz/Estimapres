<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<title>EstimaF ¬∑ Premium Management System</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root {
    --brand-blue: #0e48c7;
    --brand-gradient: radial-gradient(circle at top right, #1e52d5, #08215e);
    --glass: rgba(255, 255, 255, 0.96);
    --glass-border: rgba(255, 255, 255, 0.6);
    --text-main: #1e293b;
    --text-muted: #64748b;
    --success: #10b981;
    --danger: #ef4444;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body { 
    margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; 
    background: var(--brand-gradient); background-attachment: fixed;
    min-height: 100vh; color: var(--text-main); line-height: 1.5;
  }

  /* --- HEADER & NAVIGATION --- */
  header { padding: 30px 20px; max-width: 1000px; margin: 0 auto; color: white; }
  .nav-top { display: flex; justify-content: space-between; align-items: center; }
  .logo-box { display: flex; align-items: center; gap: 12px; }
  .logo-box img { width: 50px; height: 50px; border-radius: 15px; background: white; padding: 7px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
  .logo-box h1 { margin: 0; font-size: 28px; font-weight: 800; letter-spacing: -1px; }

  /* --- CONTAINERS & GLASS --- */
  .container { max-width: 1000px; margin: 0 auto; padding: 0 20px 100px; }
  
  .glass-card {
    background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: 35px; padding: 30px; border: 1px solid var(--glass-border);
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); margin-bottom: 30px;
    transition: transform 0.3s ease;
  }

  h3 { font-size: 22px; font-weight: 800; color: var(--brand-blue); margin: 0 0 25px; display: flex; align-items: center; gap: 10px; }

  /* --- FORMS & UI ELEMENTS --- */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  @media (max-width: 650px) { .grid-2 { grid-template-columns: 1fr; } }

  .field { margin-bottom: 20px; }
  label { display: block; font-size: 12px; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
  
  input, select {
    width: 100%; padding: 16px 20px; border-radius: 18px; border: 1px solid #e2e8f0;
    background: #f8fafc; font-size: 16px; font-weight: 600; font-family: inherit; transition: 0.3s;
  }
  input:focus { outline: none; border-color: var(--brand-blue); background: white; box-shadow: 0 0 0 4px rgba(14, 72, 199, 0.1); }

  /* --- BUTTONS --- */
  .btn-main {
    width: 100%; background: var(--brand-blue); color: white; border: none; padding: 18px;
    border-radius: 20px; font-size: 17px; font-weight: 800; cursor: pointer;
    box-shadow: 0 10px 25px rgba(14, 72, 199, 0.4); transition: 0.3s;
  }
  .btn-main:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(14, 72, 199, 0.5); }
  
  .btn-sec { 
    background: white; border: 1.5px solid #e2e8f0; padding: 10px 20px; border-radius: 14px;
    font-size: 13px; font-weight: 700; cursor: pointer; color: var(--text-main); transition: 0.2s;
  }
  .btn-sec:hover { background: #f1f5f9; border-color: #cbd5e1; }

  .btn-wa {
    background: #25d366; color: white; border: none; padding: 12px 20px; border-radius: 15px;
    font-weight: 800; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 15px;
  }

  /* --- ADMIN CARDS (TABLERO DE CUOTAS) --- */
  .loan-card { 
    background: white; border-radius: 28px; padding: 25px; margin-bottom: 20px;
    border: 1px solid #f1f5f9; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
  }
  .loan-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
  .user-info b { font-size: 19px; color: var(--brand-blue); display: block; }
  .user-info span { font-size: 13px; color: var(--text-muted); font-weight: 500; }

  .quota-grid { margin-top: 15px; border-top: 1px solid #f1f5f9; }
  .quota-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 14px 0; border-bottom: 1px solid #f8fafc; font-size: 14px; font-weight: 600;
  }
  
  .badge { padding: 6px 12px; border-radius: 10px; font-size: 11px; font-weight: 800; text-transform: uppercase; }
  .badge-paid { background: #dcfce7; color: #166534; }
  .badge-pend { background: #fff7ed; color: #9a3412; }
  .badge-status { background: #eff6ff; color: #1e40af; }

  .hidden { display: none !important; }
  
  /* --- PDF PREVIEW --- */
  .contract-box {
    background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 20px;
    padding: 25px; font-size: 14px; color: #334155; line-height: 1.7;
    margin-bottom: 20px; max-height: 400px; overflow-y: auto;
  }
</style>
</head>
<body>

<header>
  <div class="nav-top">
    <div class="logo-box">
      <img src="assets/ping.png" alt="Logo">
      <h1>EstimaF</h1>
    </div>
    <div id="topNavActions">
      <button id="btnAdminLogin" class="btn-sec">Acceso Staff</button>
      <button id="btnLogout" class="btn-sec hidden" style="color:var(--danger)">Cerrar Sesi√≥n</button>
    </div>
  </div>
</header>

<main class="container">

  <div id="viewClient">
    <section class="glass-card">
      <h3>üìä Simulador de Cuotas</h3>
      <div class="grid-2">
        <div class="field">
          <label>Monto del cr√©dito</label>
          <input id="simAmount" inputmode="numeric" placeholder="$ 0">
        </div>
        <div class="field">
          <label>Plazo de devoluci√≥n</label>
          <select id="simMonths">
            <option value="6">6 Meses</option>
            <option value="12" selected>12 Meses</option>
            <option value="18">18 Meses</option>
            <option value="24">24 Meses</option>
          </select>
        </div>
      </div>
      <button id="btnSimulate" class="btn-main">Calcular Cuota Mensual</button>
      <div id="simDisplay"></div>
    </section>

    <section id="reqSection" class="glass-card">
      <h3>üìù Formulario de Solicitud</h3>
      <div class="field">
        <label>Nombre y Apellido completo</label>
        <input id="formName" placeholder="Como figura en tu DNI">
      </div>
      <div class="grid-2">
        <div class="field"><label>DNI</label><input id="formDni" inputmode="numeric"></div>
        <div class="field"><label>Tel√©fono / WhatsApp</label><input id="formPhone" type="tel"></div>
      </div>
      <div class="field"><label>CBU / CVU o Alias de cobro</label><input id="formAlias"></div>
      <button id="btnSubmitReq" class="btn-main" style="background: linear-gradient(to right, #0e48c7, #10b981);">Enviar mi Solicitud</button>
    </section>
  </div>

  <div id="viewSign" class="hidden">
    <section class="glass-card">
      <h3>üñãÔ∏è Firma de Contrato Digital</h3>
      <div id="contractContent" class="contract-box">
        </div>
      <div class="field">
        <label>Escribe tu nombre completo para confirmar la firma</label>
        <input id="signatureInput" placeholder="Firma electr√≥nica">
      </div>
      <button id="btnConfirmSign" class="btn-main">Firmar y Confirmar Cr√©dito</button>
    </section>
  </div>

  <div id="viewAdmin" class="hidden">
    <section class="glass-card">
      <h3>‚öôÔ∏è Par√°metros del D√≠a</h3>
      <div class="grid-2">
        <div class="field"><label>TNA (%)</label><input id="cfgTna" value="120"></div>
        <div class="field"><label>D√≠a de Vencimiento</label><input id="cfgDue" value="10"></div>
      </div>
      <button id="btnUpdateSettings" class="btn-sec" style="width:100%">Guardar Cambios</button>
    </section>

    <section class="glass-card">
      <h3>üì• Bandeja de Entrada</h3>
      <div id="adminSolicitudes"></div>
    </section>

    <section class="glass-card">
      <h3>üöÄ Cartera de Pr√©stamos Activos</h3>
      <div id="adminActivos"></div>
    </section>
  </div>

  <section class="glass-card" style="background: rgba(255,255,255,0.8);">
    <h3 style="font-size: 16px;">üîé Mi Pr√©stamo</h3>
    <div style="display: flex; gap: 10px;">
      <input id="searchDni" placeholder="Ingresa tu DNI">
      <button id="btnSearch" class="btn-sec">Consultar</button>
    </div>
    <div id="searchResult" style="margin-top:20px"></div>
  </section>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, getDoc, getDocs, setDoc, updateDoc, collection, query, where, orderBy, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
  authDomain: "estimapres.firebaseapp.com",
  projectId: "estimapres",
  storageBucket: "estimapres.firebasestorage.app",
  messagingSenderId: "578516597437",
  appId: "1:578516597437:web:f59994b87729aa1cd655d4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const ADMIN_EMAIL = "fernandogastondelgado81@gmail.com";

const $ = s => document.querySelector(s);
const fmt = n => "$ " + Number(n).toLocaleString("es-AR");

// --- MATEM√ÅTICA FINANCIERA ---
function calcCuota(monto, meses, tna) {
  const i = (tna/100)/12;
  return Math.round(monto * (i * Math.pow(1+i, meses)) / (Math.pow(1+i, meses) - 1));
}

// --- MANEJO DE VISTAS (CLIENTE/ADMIN/FIRMA) ---
onAuthStateChanged(auth, async (user) => {
  const hash = window.location.hash;
  
  if (user && user.email === ADMIN_EMAIL) {
    toggleView("admin");
    loadAdminData();
  } else if (hash.startsWith("#firmar-")) {
    toggleView("sign");
    initSignatureProcess(hash.replace("#firmar-", ""));
  } else {
    toggleView("client");
  }
});

function toggleView(v) {
  $("#viewClient").classList.toggle("hidden", v !== "client");
  $("#viewAdmin").classList.toggle("hidden", v !== "admin");
  $("#viewSign").classList.toggle("hidden", v !== "sign");
  $("#btnLogout").classList.toggle("hidden", v !== "admin");
  $("#btnAdminLogin").classList.toggle("hidden", v === "admin");
}

// --- L√ìGICA DE FIRMA (PROCESO MICAELA SOTO) ---
async function initSignatureProcess(id) {
  const snap = await getDoc(doc(db, "loans", id));
  if (!snap.exists()) return;
  const d = snap.data();
  
  $("#contractContent").innerHTML = `
    <strong>CONTRATO DE MUTUO - ESTIFAMF</strong><br><br>
    Por la presente, el Sr./Sra. <b>${d.client.name}</b>, DNI <b>${d.client.dni}</b>, en adelante EL MUTUARIO,
    acepta un pr√©stamo de <b>${fmt(d.amount)}</b> pagadero en <b>${d.months}</b> cuotas mensuales fijas de <b>${fmt(d.installment)}</b>.
    El incumplimiento de pago habilitar√° las acciones legales correspondientes...
  `;

  $("#btnConfirmSign").onclick = async () => {
    const sign = $("#signatureInput").value;
    if (sign.length < 5) return alert("Firma inv√°lida");
    await updateDoc(doc(db, "loans", id), { 
      signed: true, 
      status: "signed", 
      signName: sign, 
      signedAt: serverTimestamp() 
    });
    alert("¬°Contrato firmado con √©xito! El dinero ser√° enviado a tu cuenta.");
    window.location.hash = "";
    location.reload();
  };
}

// --- PANEL ADMIN (ESTILO OCTAVIO DELGADO) ---
async function loadAdminData() {
  const snap = await getDocs(query(collection(db, "loans"), orderBy("createdAt", "desc")));
  $("#adminSolicitudes").innerHTML = "";
  $("#adminActivos").innerHTML = "";

  snap.forEach(docu => {
    const d = { id: docu.id, ...docu.data() };
    if (d.status === "pending" || d.status === "signed") {
      renderSolicitud(d);
    } else if (d.status === "active") {
      renderActivo(d);
    }
  });
}

function renderSolicitud(d) {
  const isSigned = d.status === "signed";
  const link = `${window.location.origin}${window.location.pathname}#firmar-${d.id}`;
  
  $("#adminSolicitudes").innerHTML += `
    <div class="loan-card">
      <div class="loan-header">
        <div class="user-info"><b>${d.client.name}</b><span>DNI: ${d.client.dni}</span></div>
        <span class="badge badge-status">${d.status.toUpperCase()}</span>
      </div>
      <div>Solicita: ${fmt(d.amount)} en ${d.months} meses</div>
      
      ${d.status === "pending" ? `
        <button class="btn-main" style="padding:10px; margin-top:10px" onclick="window.preAprobar('${d.id}')">Preaprobar y Enviar Link</button>
      ` : ""}

      ${d.status === "preapproved" || d.status === "pending" ? `
        <button class="btn-wa" onclick="window.open('https://wa.me/${d.client.phone}?text=Hola! Firma tu contrato aqu√≠: ${encodeURIComponent(link)}')">Enviar por WhatsApp</button>
      ` : ""}

      ${isSigned ? `
        <div style="margin-top:15px; background:#f0fdf4; padding:15px; border-radius:15px">
          <div style="font-size:12px"><b>FIRMADO POR:</b> ${d.signName}</div>
          <button class="btn-main" style="background:var(--success); margin-top:10px" onclick="window.activarLoan('${d.id}')">ENTREGAR DINERO Y ACTIVAR</button>
        </div>
      ` : ""}
    </div>
  `;
}

function renderActivo(d) {
  let cuotasList = "";
  for(let i=1; i<=d.months; i++) {
    const pagada = (d.payments || 0) >= i;
    cuotasList += `
      <div class="quota-row">
        <span>Cuota ${i}</span>
        <span>${fmt(d.installment)}</span>
        ${pagada ? '<span class="badge badge-paid">PAGADO</span>' : `<button class="btn-sec" onclick="window.cobrarCuota('${d.id}', ${i})">COBRAR</button>`}
      </div>
    `;
  }

  $("#adminActivos").innerHTML += `
    <div class="loan-card">
      <div class="loan-header">
        <div class="user-info"><b>${d.client.name}</b><span>DNI: ${d.client.dni}</span></div>
        <div align="right"><small>Faltan: ${d.months - (d.payments||0)}</small></div>
      </div>
      <div class="quota-grid">${cuotasList}</div>
    </div>
  `;
}

// --- WINDOW ACTIONS ---
window.preAprobar = async (id) => {
  await updateDoc(doc(db, "loans", id), { status: "preapproved" });
  loadAdminData();
};

window.activarLoan = async (id) => {
  await updateDoc(doc(db, "loans", id), { status: "active", payments: 0, activatedAt: serverTimestamp() });
  loadAdminData();
};

window.cobrarCuota = async (id, n) => {
  await updateDoc(doc(db, "loans", id), { payments: n, updatedAt: serverTimestamp() });
  loadAdminData();
};

// --- SIMULADOR ---
$("#btnSimulate").onclick = () => {
  const m = Number($("#simAmount").value.replace(/\D/g,''));
  const t = Number($("#simMonths").value);
  const cuota = calcCuota(m, t, 120);
  $("#simDisplay").innerHTML = `
    <div style="margin-top:20px; text-align:center; background:#eff6ff; padding:20px; border-radius:20px">
      <label>Valor Cuota Mensual</label>
      <div style="font-size:32px; font-weight:800; color:var(--brand-blue)">${fmt(cuota)}</div>
    </div>
  `;
};

// --- ENVIO SOLICITUD ---
$("#btnSubmitReq").onclick = async () => {
  const monto = Number($("#simAmount").value.replace(/\D/g,''));
  const meses = Number($("#simMonths").value);
  const data = {
    amount: monto, months: meses, installment: calcCuota(monto, meses, 120),
    status: "pending", signed: false,
    client: {
      name: $("#formName").value,
      dni: $("#formDni").value,
      phone: $("#formPhone").value,
      alias: $("#formAlias").value
    },
    createdAt: serverTimestamp()
  };
  await addDoc(collection(db, "loans"), data);
  alert("Solicitud enviada. Recibir√°s un WhatsApp pronto.");
  location.reload();
};

// --- LOGIN ---
$("#btnAdminLogin").onclick = async () => {
  const pass = prompt("Password Staff:");
  if(pass) signInWithEmailAndPassword(auth, ADMIN_EMAIL, pass).catch(()=>alert("Error"));
};
$("#btnLogout").onclick = () => signOut(auth);

// --- BUSCADOR ---
$("#btnSearch").onclick = async () => {
  const dni = $("#searchDni").value;
  const q = query(collection(db, "loans"), where("client.dni", "==", dni));
  const snap = await getDocs(q);
  if(snap.empty) return $("#searchResult").innerHTML = "No se encontraron registros.";
  const d = snap.docs[0].data();
  $("#searchResult").innerHTML = `
    <div class="loan-card" style="background:#f1f5f9">
      <b>Estado: ${d.status.toUpperCase()}</b><br>
      Cr√©dito por: ${fmt(d.amount)}<br>
      Pagos realizados: ${d.payments || 0} / ${d.months}
    </div>
  `;
};
</script>
</body>
</html>
