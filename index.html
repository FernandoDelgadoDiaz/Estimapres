<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EstimaPres · Préstamos en ARS</title>
  <style>
    body{font-family:system-ui,sans-serif;margin:0;background:#f5f6fa;color:#222}
    header{background:#0a2f73;color:#fff;padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
    header h1{font-size:18px;margin:0}
    .btn{padding:6px 12px;border:none;border-radius:4px;cursor:pointer}
    .btn.primary{background:#0a2f73;color:#fff}
    .btn.ok{background:#2ecc71;color:#fff}
    .btn.warn{background:#f39c12;color:#fff}
    .btn.bad{background:#e74c3c;color:#fff}
    .btn.light{background:#ecf0f1;color:#333}
    .container{padding:16px}
    .card{background:#fff;border-radius:8px;padding:16px;margin-bottom:16px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .row{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
    .cardlet{background:#fff;border:1px solid #ddd;border-radius:6px;padding:12px;margin:6px 0}
    .actions-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .tag{display:inline-flex;align-items:center;gap:4px;font-size:13px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.green{background:#2ecc71}
    .dot.yellow{background:#f1c40f}
    .dot.red{background:#e74c3c}
    .hidden{display:none}
    .badge-sm{background:#eee;padding:2px 6px;border-radius:4px;font-size:12px}
    .table{width:100%;border-collapse:collapse;margin-top:8px}
    .table th,.table td{border:1px solid #ddd;padding:6px;font-size:13px}
    .table th{background:#f9f9f9}
    .small{font-size:12px;color:#666}
    .hr{border-top:1px solid #ccc;margin:10px 0}
  </style>
</head>
<body>
  <header>
    <h1>EstimaPres</h1>
    <div>
      <button class="btn light" id="btnMyLoan">Ver mi préstamo</button>
      <button class="btn light" id="btnAdmin">Admin</button>
      <button class="btn bad" id="btnSignOut" hidden>Salir</button>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <h3>Simulador (pesos argentinos)</h3>
      <div class="row">
        <input id="simAmount" type="number" placeholder="Ej: 200000"> 
        <input id="simMonths" type="number" placeholder="Ej: 12">
      </div>
      <p>TNA vigente: <span id="tnaLabel">--</span> · Vencimiento: día <span id="dueDayLabel">10</span></p>
      <button class="btn primary" id="btnSimulate">Simular</button>
      <div id="simResult">–</div>
    </div>

    <div class="card">
      <h3>Solicitar préstamo</h3>
      <input id="rqName" placeholder="Tu nombre">
      <input id="rqDni" placeholder="DNI">
      <input id="rqEmail" placeholder="tucorreo@dominio.com">
      <input id="rqPhone" placeholder="11 2345 6789">
      <input id="rqCbu" placeholder="alias o CBU/CVU">
      <button class="btn primary" id="btnSendRequest">Enviar solicitud</button>
    </div>

    <div class="card" id="adminPanel" hidden>
      <h2>Panel de administrador</h2>

      <h3>1) Tasa (TNA %)</h3>
      <input id="adminTna" type="number" placeholder="TNA (%)">
      <button class="btn primary" id="btnSaveTna">Guardar</button>

      <h3>2) Solicitudes pendientes</h3>
      <div id="pendingList">–</div>

      <h3>3) Preaprobados</h3>
      <div id="preList">–</div>

      <h3>4) Préstamos activos</h3>
      <div id="activeList">–</div>

      <h3>5) Inactivos</h3>
      <div><b>Finalizados:</b><div id="finishedList">–</div></div>
      <div><b>Incobrables:</b><div id="chargedList">–</div></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
      authDomain: "estimapres.firebaseapp.com",
      projectId: "estimapres",
      storageBucket: "estimapres.firebasestorage.app",
      messagingSenderId: "578516597437",
      appId: "1:578516597437:web:f59994b87729aa1cd655d4"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const $=id=>document.getElementById(id);
    const money=n=>n.toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const dueDay=10;$("dueDayLabel").textContent=dueDay;
    const admins=["fernandogastondelgado81@gmail.com"];

    async function loadTna(){const ref=doc(db,"config","general");const s=await getDoc(ref);let tna=100;if(s.exists())tna=Number(s.data().tna)||tna;else await setDoc(ref,{tna});$("tnaLabel").textContent=`${tna}%`;$("adminTna").value=tna;}
    $("btnSaveTna").onclick=async()=>{const v=Number($("adminTna").value||0);await setDoc(doc(db,"config","general"),{tna:v},{merge:true});$("tnaLabel").textContent=`${v}%`;alert("TNA guardada");};

    $("btnSimulate").onclick=()=>{const P=Number($("simAmount").value),n=Number($("simMonths").value);const tna=Number($("adminTna").value||$("tnaLabel").textContent.replace("%",""));if(!P||!n)return alert("Completá monto y cuotas");const c=Math.round(P*((tna/100)/12)/(1-Math.pow(1+(tna/100)/12,-n)));$("simResult").innerHTML=`<b>Cuota:</b> ${money(c)} · Total: ${money(c*n)}`;};

    $("btnSendRequest").onclick=async()=>{const a=Number($("simAmount").value),m=Number($("simMonths").value);const b={name:$("rqName").value,dni:$("rqDni").value,email:$("rqEmail").value,phone:$("rqPhone").value,cbu:$("rqCbu").value};if(!a||!m||!b.name||!b.dni||!b.email||!b.phone||!b.cbu)return alert("Completá todo");const t=await getDoc(doc(db,"config","general"));const tna=t.exists()?Number(t.data().tna):100;await addDoc(collection(db,"loan_requests"),{borrower:b,amount:a,months:m,tna,createdAt:serverTimestamp()});alert("Solicitud enviada");};

    $("btnAdmin").onclick=async()=>{if(!auth.currentUser)await signInWithPopup(auth,provider).catch(e=>alert(e.message));else $("adminPanel").hidden=!$("adminPanel").hidden;};
    $("btnSignOut").onclick=()=>signOut(auth);

    onAuthStateChanged(auth,async u=>{const isAdmin=u&&admins.includes(u.email);$("btnSignOut").hidden=!u;$("btnAdmin").textContent=u?"Admin":"Ingresar";$("adminPanel").hidden=!isAdmin;if(isAdmin){await loadTna();loadPending();loadPre();loadActive();loadInactive();}});

    async function loadPending(){const box=$("pendingList");const s=await getDocs(collection(db,"loan_requests"));if(s.empty)return box.textContent="Sin solicitudes";box.innerHTML="";s.forEach(d=>{const v=d.data();const el=document.createElement("div");el.className="cardlet";el.innerHTML=`<b>${v.borrower.name}</b> · ${money(v.amount)}<div class="actions-row"><button class="btn primary">Preaprobar</button><button class="btn bad">Rechazar</button></div>`;el.querySelector(".primary").onclick=()=>preapprove(d.id,v);el.querySelector(".bad").onclick=async()=>{await deleteDoc(doc(db,"loan_requests",d.id));loadPending();};box.appendChild(el);});}
    const otp6=()=>String(Math.floor(100000+Math.random()*900000));
    async function preapprove(id,v){const code=otp6();await addDoc(collection(db,"loans"),{...v,status:"preapproved",otp:code,contractAccepted:false,depositDone:false,paidCount:0,dueDay,createdAt:serverTimestamp()});await deleteDoc(doc(db,"loan_requests",id));loadPending();loadPre();}

    async function loadPre(){const box=$("preList");const s=await getDocs(query(collection(db,"loans"),where("status","==","preapproved")));if(s.empty)return box.textContent="Sin preaprobados";box.innerHTML="";s.forEach(d=>{const l=d.data(),id=d.id;const el=document.createElement("div");el.className="cardlet";el.innerHTML=`<b>${l.borrower.name}</b> (${money(l.amount)})<div class="actions-row"><button class="btn">Contrato</button><button class="btn light">OTP</button><button class="btn warn">Depósito</button><button class="btn ok">Aprobar</button></div>`;el.querySelectorAll("button")[0].onclick=()=>openContract(id,l);el.querySelectorAll("button")[1].onclick=()=>alert("OTP:"+l.otp);el.querySelectorAll("button")[2].onclick=async()=>{await updateDoc(doc(db,"loans",id),{depositDone:true});loadPre();};el.querySelectorAll("button")[3].onclick=async()=>{await updateDoc(doc(db,"loans",id),{status:"active",activeAt:serverTimestamp()});loadPre();loadActive();};box.appendChild(el);});}
    function openContract(id,l){const w=window.open("about:blank");w.document.write(`<h1>Contrato</h1><p>${l.borrower.name} DNI ${l.borrower.dni}</p><p>Monto ${money(l.amount)} TNA ${l.tna}%</p><p>OTP ${l.otp}</p>`);w.document.close();}

    function cuota(P,tna,n){return Math.round(P*((tna/100)/12)/(1-Math.pow(1+(tna/100)/12,-n)));}
    function renderSchedule(l){const c=cuota(l.amount,l.tna,l.months);const p=Number(l.paidCount||0);return `<table class="table"><tr><th>#</th><th>Venc</th><th>Monto</th><th>Estado</th></tr>${Array.from({length:l.months},(_,i)=>`<tr><td>${i+1}</td><td>${l.dueDay}/${i+1}</td><td>${money(c)}</td><td>${i<p?"Pagada ✅":`<button data-pay="${i+1}" data-id="${l.id}" class="btn light">Marcar</button>`}</td></tr>`).join("")}</table>`;}
    async function loadActive(){const box=$("activeList");const s=await getDocs(query(collection(db,"loans"),where("status","==","active")));if(s.empty)return box.textContent="Sin activos";box.innerHTML="";s.forEach(d=>{const l={id:d.id,...d.data()};const el=document.createElement("div");el.className="cardlet";el.innerHTML=`<b>${l.borrower.name}</b> (${money(l.amount)})<div>${renderSchedule(l)}</div>`;box.appendChild(el);});}
    document.addEventListener("click",async e=>{if(e.target.dataset.pay){const id=e.target.dataset.id;const s=await getDoc(doc(db,"loans",id));const paid=Number(s.data().paidCount||0);await updateDoc(doc(db,"loans",id),{paidCount:paid+1});loadActive();}});

    async function loadInactive(){$("finishedList").textContent="–";$("chargedList").textContent="–";}

    $("btnMyLoan").onclick=async()=>{const code=prompt("OTP?");const s=await getDocs(query(collection(db,"loans"),where("otp","==",code)));if(s.empty)return alert("No encontrado");const l=s.docs[0].data();const w=window.open("about:blank");w.document.write(`<h2>Mi préstamo</h2><p>${l.borrower.name}</p>${renderSchedule({...l,id:s.docs[0].id})}`);w.document.close();};

    loadTna();
  </script>
</body>
</html>