<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EstimaPres</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#0b62ff; --brand-2:#003ea8; --ok:#20b36a; --warn:#f1b83a; --bad:#e23d3d;
      --ink:#0b1220; --muted:#6b7280; --bg:#f3f5f7; --card:#ffffff; --line:#e5e7eb;
      --pill:#eef2ff;
    }
    *{box-sizing:border-box} html,body{margin:0;padding:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}
    .container{max-width:960px;margin:0 auto;padding:0 16px}
    .hero{background:linear-gradient(120deg,var(--brand),var(--brand-2));color:#fff;padding:28px 0 18px}
    .brand{font-weight:800;letter-spacing:0.2px;font-size:34px;margin:0 0 8px}
    .slogan{display:inline-block;padding:10px 14px;background:rgba(255,255,255,.12);border-radius:14px;font-size:14px;font-weight:600}
    .slogan em{font-style:italic;opacity:.9}
    .nav{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
    .btn{appearance:none;border:0;border-radius:14px;padding:12px 18px;font-weight:700;cursor:pointer;transition:.15s;display:inline-flex;align-items:center;gap:8px}
    .btn-outline{background:transparent;border:2px solid rgba(255,255,255,.6);color:#fff}
    .btn-outline:hover{border-color:#fff}
    .btn-danger{background:#ef4444;color:#fff}
    .btn-danger:hover{filter:brightness(1.05)}
    .btn-ghost{background:rgba(255,255,255,.12);color:#fff}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:0 6px 18px rgba(11,18,32,.05);padding:22px;margin:16px 0}
    .h1{font-size:28px;margin:0 0 12px;font-weight:800}
    .h2{font-size:20px;margin:18px 0 8px;font-weight:800}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.row2{grid-template-columns:1fr 1fr}}
    .input{width:100%;border:1.5px solid var(--line);border-radius:12px;padding:14px 14px;font-size:16px;background:#fff}
    .input:focus{outline:none;border-color:#c9d6ff;box-shadow:0 0 0 4px #e9efff}
    .btn-primary{background:var(--ok);color:#fff;border-radius:12px;padding:14px 18px;font-weight:800;border:none;cursor:pointer}
    .btn-primary:hover{filter:brightness(1.05)}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--pill);font-weight:700;font-size:12px}
    .pill.ok{background:#e9fbf2;color:#11633f}
    .pill.warn{background:#fff6e6;color:#8a5a02}
    .pill.bad{background:#ffecec;color:#8a0c0c}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#1d4ed8;font-weight:700;font-size:12px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{font-size:12px;text-transform:uppercase;color:var(--muted);text-align:left}
    td{background:#fff;padding:10px 12px;border-top:1px solid var(--line);border-bottom:1px solid var(--line)}
    td:first-child{border-left:1px solid var(--line);border-top-left-radius:10px;border-bottom-left-radius:10px}
    td:last-child{border-right:1px solid var(--line);border-top-right-radius:10px;border-bottom-right-radius:10px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px;background:rgba(10,15,25,.55);backdrop-filter:blur(3px);z-index:60}
    .modal.open{display:flex}
    .modal .sheet{width:min(900px,96vw);max-height:90vh;overflow:auto;background:#fff;border-radius:16px;padding:18px;border:1px solid var(--line);box-shadow:0 14px 40px rgba(0,0,0,.18)}
    .sheet .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .link{color:#1d4ed8;text-decoration:none;font-weight:700}
    /* A4 for printable contract window */
  </style>
</head>
<body>

  <!-- HERO / BRAND -->
  <section class="hero">
    <div class="container">
      <h1 class="brand">EstimaPres</h1>
      <div class="slogan"><em>Pr√©stamos personales ¬∑ simple y claro</em></div>

      <div class="nav">
        <button id="btnMyLoan" class="btn btn-outline">üîé Ver mi pr√©stamo</button>
        <button id="btnAdmin" class="btn btn-ghost">üõ°Ô∏è Admin</button>
        <button id="btnLogout" class="btn btn-danger">üö™ Salir</button>
      </div>
    </div>
  </section>

  <main class="container" style="margin-top:-12px">
    <!-- SIMULADOR -->
    <section class="card">
      <h2 class="h1">Simulador</h2>
      <div class="row row2">
        <div>
          <label class="muted">Monto</label>
          <input id="inpAmount" class="input" placeholder="$ 1.000.000" inputmode="numeric" />
        </div>
        <div>
          <label class="muted">Meses</label>
          <input id="inpMonths" class="input" placeholder="Ej: 12" inputmode="numeric" />
        </div>
      </div>
      <p class="muted" id="tnaLabel">TNA vigente: <b id="tnaNow">150%</b> ¬∑ Vencimiento: d√≠a <b id="dueDayNow">10</b></p>
      <button id="btnSim" class="btn-primary">Simular</button>
      <div id="simResult" style="margin-top:12px"></div>
    </section>

    <!-- SOLICITAR PR√âSTAMO -->
    <section class="card">
      <h2 class="h1">Solicitar pr√©stamo</h2>
      <div class="row">
        <input id="rqName" class="input" placeholder="Tu nombre" />
        <input id="rqDni" class="input" placeholder="DNI" inputmode="numeric" />
        <input id="rqEmail" class="input" placeholder="Email" />
        <input id="rqPhone" class="input" placeholder="Tel√©fono" />
        <input id="rqCbu" class="input" placeholder="alias o CBU/CVU" />
      </div>
      <button id="btnSendReq" class="btn-primary" style="margin-top:12px">Enviar solicitud</button>
      <p class="muted" style="margin-top:6px">Al enviar acept√°s ser contactado por EstimaPres.</p>
    </section>

    <!-- PANEL ADMIN (se muestra s√≥lo a admins) -->
    <section id="adminPanel" class="card" style="display:none">
      <h2 class="h1">Panel administrador</h2>

      <div class="row row2" style="align-items:end">
        <div>
          <label class="muted">TNA</label>
          <input id="inpTna" class="input" placeholder="150" />
        </div>
        <div><button id="btnSaveTna" class="btn-primary">Guardar</button></div>
      </div>

      <h3 class="h2">Solicitudes pendientes</h3>
      <div class="toolbar"><button id="btnReloadPending" class="btn">Recargar</button></div>
      <div id="pendingBox" class="muted">Sin pendientes</div>

      <h3 class="h2" style="margin-top:16px">Preaprobados</h3>
      <div class="toolbar"><button id="btnReloadPre" class="btn">Recargar</button></div>
      <div id="preBox" class="muted">Sin preaprobados</div>

      <h3 class="h2" style="margin-top:16px">Activos</h3>
      <div class="toolbar"><button id="btnReloadActive" class="btn">Recargar</button></div>
      <div id="activeBox" class="muted">Sin activos</div>

      <h3 class="h2" style="margin-top:16px">Inactivos (finalizados / incobrables)</h3>
      <div class="toolbar">
        <button id="btnReloadFinished" class="btn">Cancelados</button>
        <button id="btnReloadCharged" class="btn btn-danger">Incobrables</button>
      </div>
      <div id="inactiveBox" class="muted">Sin inactivos</div>
    </section>
  </main>

  <!-- MODAL: Ver mi pr√©stamo -->
  <div id="myLoanModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="myLoanTitle">
    <div class="sheet">
      <div class="top">
        <h3 id="myLoanTitle" class="h2" style="margin:0">Mi pr√©stamo</h3>
        <div class="toolbar">
          <button id="btnMyLoanPDF" class="btn">Contrato (PDF A4)</button>
          <button id="btnCloseMyLoan" class="btn btn-danger">Cerrar</button>
        </div>
      </div>
      <div id="myLoanInfo" class="muted" style="margin-bottom:8px"></div>
      <div id="myLoanProg" style="margin-bottom:8px"></div>
      <div id="myLoanTable"></div>
    </div>
  </div>

  <!-- Firebase (modular) -->
  <script type="module">
    // ---------- Firebase ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc,
      getDocs, query, where, orderBy, limit, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
      authDomain: "estimapres.firebaseapp.com",
      projectId: "estimapres",
      storageBucket: "estimapres.firebasestorage.app",
      messagingSenderId: "578516597437",
      appId: "1:578516597437:web:f59994b87729aa1cd655d4"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ---------- Utils ----------
    const $ = s => document.querySelector(s);
    const money = n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Number(n||0));
    const num = v => Number(String(v||"").replace(/\D/g,"")||0);
    const pad = n=>String(n).padStart(2,'0');

    // Amount live formatting
    const inpAmount = $("#inpAmount");
    inpAmount.addEventListener("input", ()=> {
      const val = num(inpAmount.value);
      if(val===0){ inpAmount.value=""; return; }
      inpAmount.value = money(val);
    });

    function cuota(P,tna,months){
      const i = (tna/100)/12;
      if(i<=0) return Math.round(P/months);
      const c = P*i/(1-Math.pow(1+i,-months));
      return Math.round(c);
    }
    function nextScheduleDates(dueDay, months){
      const out=[];
      const d = new Date();
      let y=d.getFullYear(), m=d.getMonth();
      // primera vence el pr√≥ximo dueDay
      let next = new Date(y,m,dueDay);
      if(d.getDate()>dueDay) next = new Date(y,m+1,dueDay);
      for(let i=0;i<months;i++){
        const x = new Date(next.getFullYear(), next.getMonth()+i, dueDay);
        out.push(`${pad(dueDay)}/${pad(((x.getMonth())%12)+1)}/${x.getFullYear()}`);
      }
      return out;
    }

    // ---------- Settings (TNA/dueDay) ----------
    const tnaLabel=$("#tnaNow"), dueDayLabel=$("#dueDayNow"), inpTna=$("#inpTna");
    let SETTINGS={tna:150,dueDay:10};
    async function loadSettings(){
      const sdoc = await getDoc(doc(db,"settings","global"));
      if(sdoc.exists()){
        SETTINGS = {...SETTINGS, ...sdoc.data()};
      }
      tnaLabel.textContent = `${SETTINGS.tna}%`;
      dueDayLabel.textContent = SETTINGS.dueDay;
      inpTna.value = SETTINGS.tna;
    }
    $("#btnSaveTna").onclick = async()=>{
      const tna = Number(num(inpTna.value));
      await setDoc(doc(db,"settings","global"), {tna, updatedAt: serverTimestamp()}, {merge:true});
      SETTINGS.tna=tna; tnaLabel.textContent=`${tna}%`;
      toast("TNA actualizada");
    };

    // ---------- Simulador ----------
    $("#btnSim").onclick = ()=>{
      const P = num($("#inpAmount").value);
      const n = Number($("#inpMonths").value||0);
      if(!P||!n) return toast("Complet√° monto y meses");
      const c = cuota(P, SETTINGS.tna, n);
      const venc = nextScheduleDates(SETTINGS.dueDay,n);
      const rows = venc.map((d,i)=>`<tr>
          <td style="width:60px">${i+1}</td>
          <td>${d}</td>
          <td>${money(c)}</td>
          <td><span class="badge">Pendiente</span></td>
        </tr>`).join("");
      $("#simResult").innerHTML = `
        <div class="card" style="margin-top:12px">
          <div class="h2" style="margin-top:0">Detalle de cuotas</div>
          <table>
            <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
    };

    // ---------- Enviar solicitud ----------
    $("#btnSendReq").onclick = async()=>{
      const name=$("#rqName").value.trim();
      const dni=$("#rqDni").value.trim();
      const email=$("#rqEmail").value.trim();
      const phone=$("#rqPhone").value.trim();
      const cbu=$("#rqCbu").value.trim();
      const P = num($("#inpAmount").value);
      const n = Number($("#inpMonths").value||0);
      if(!name||!dni||!email||!phone||!cbu||!P||!n) return toast("Complet√° todos los campos + simulaci√≥n.");
      await addDoc(collection(db,"loans"),{
        amount:P, months:n, tna:SETTINGS.tna, status:"requested",
        borrower:{name,dni,email,phone,cbu},
        createdAt: serverTimestamp()
      });
      toast("¬°Listo! En 48 hs un administrador lo revisar√°.");
      $("#rqName").value=$("#rqDni").value=$("#rqEmail").value=$("#rqPhone").value=$("#rqCbu").value="";
    };

    // ---------- Auth/Admin toggle ----------
    const adminPanel=$("#adminPanel");
    $("#btnAdmin").onclick = async()=>{
      // simple login prompt (email+pass)
      const email = prompt("Admin - email:");
      if(!email) return;
      const pass = prompt("Admin - contrase√±a:");
      if(!pass) return;
      try{
        await signInWithEmailAndPassword(auth,email,pass);
      }catch(e){ alert("No se pudo iniciar sesi√≥n"); }
    };
    $("#btnLogout").onclick = ()=> signOut(auth);

    onAuthStateChanged(auth, async user=>{
      const isInAdmins = await isAdmin(user?.email||"");
      adminPanel.style.display = (user && isInAdmins) ? "block":"none";
      if(user && isInAdmins){
        loadSettings();
        loadPending();
        loadPre();
        loadActive();
        loadInactive("finished");
      }
    });

    async function isAdmin(email){
      if(!email) return false;
      const ad = await getDoc(doc(db,"admins","admins"));
      const list = ad.exists() ? (ad.data().emails||[]) : [];
      return list.includes(email);
    }

    // ---------- Admin Lists ----------
    $("#btnReloadPending").onclick=loadPending;
    $("#btnReloadPre").onclick=loadPre;
    $("#btnReloadActive").onclick=loadActive;
    $("#btnReloadFinished").onclick=()=>loadInactive("finished");
    $("#btnReloadCharged").onclick=()=>loadInactive("charged_off");

    function cardRequested(l, id){
      const b=l.borrower||{};
      return `<div class="card">
        <div class="h2" style="margin:0 0 6px">${b.name||'‚Äì'} ¬∑ DNI ${b.dni||'‚Äì'}</div>
        <div class="muted">Principal ${money(l.amount)} ¬∑ ${l.months} cuotas ¬∑ TNA ${l.tna}%</div>
        <div class="toolbar" style="margin-top:10px">
          <button class="btn" data-act="pre" data-id="${id}">Preaprobar</button>
          <button class="btn btn-danger" data-act="del" data-id="${id}">Descartar</button>
        </div>
      </div>`;
    }
    function cardPre(l,id){
      const b=l.borrower||{};
      const signed = !!l.contractSigned;
      return `<div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <div class="h2" style="margin:0 0 6px">${b.name} ¬∑ DNI ${b.dni}</div>
            <div class="muted">Principal ${money(l.amount)} ¬∑ ${l.months} cuotas ¬∑ TNA ${l.tna}%</div>
            <div style="margin-top:6px">
              <span class="pill ${signed?'ok':'warn'}">${signed?'Contrato firmado':'Contrato pendiente'}</span>
              ${l.contractId?`<span class="pill"># ${l.contractId}</span>`:''}
            </div>
          </div>
          <div class="toolbar">
            <button class="btn" data-act="contract" data-id="${id}">Contrato PDF</button>
            <button class="btn" data-act="share" data-id="${id}">Compartir</button>
            <button class="btn" data-act="otp" data-id="${id}">Marcar ‚ÄúFirmado‚Äù</button>
            <button class="btn" data-act="approve" data-id="${id}" ${signed?'':'disabled'}>Aprobar / Depositar</button>
          </div>
        </div>
      </div>`;
    }
    function cardActive(l,id){
      const b=l.borrower||{};
      const paid = Number(l.paidCount||0);
      const prog = `${paid}/${l.months}`;
      return `<div class="card">
        <div class="h2" style="margin:0 0 6px"><span class="pill ok">Activo</span> ${b.name} ¬∑ DNI ${b.dni}</div>
        <div class="muted">Principal ${money(l.amount)} ¬∑ ${l.months} cuotas ¬∑ TNA ${l.tna}% ¬∑ Pagadas ${prog}</div>
        <div class="toolbar" style="margin-top:10px">
          <button class="btn" data-act="view" data-id="${id}">Ver cuotas</button>
          <button class="btn" data-act="finish" data-id="${id}">Pagado total</button>
          <button class="btn btn-danger" data-act="chargeoff" data-id="${id}">A incobrables</button>
        </div>
      </div>`;
    }
    function cardInactive(l){
      const b=l.borrower||{}; const tag=l.status==="finished"?"badge":"pill bad";
      const label=l.status==="finished"?"Cancelado":"incobrable";
      return `<div class="card">
        <div class="h2" style="margin:0 0 6px"><span class="${tag}">${label}</span> ${b.name} ¬∑ DNI ${b.dni}</div>
        <div class="muted">Principal ${money(l.amount)} ¬∑ ${l.months} cuotas ¬∑ TNA ${l.tna}% ${l.contractId?`¬∑ Contrato ${l.contractId}`:''}</div>
      </div>`;
    }

    async function loadPending(){
      $("#pendingBox").textContent="Cargando‚Ä¶";
      const snap = await getDocs(query(collection(db,"loans"),where("status","==","requested"),orderBy("createdAt","desc"),limit(50)));
      if(snap.empty){ $("#pendingBox").textContent="Sin pendientes"; return;}
      $("#pendingBox").innerHTML=[...snap.docs].map(d=>cardRequested(d.data(),d.id)).join("");
      $("#pendingBox").onclick = async ev=>{
        const b=ev.target.closest("button"); if(!b) return;
        const id=b.dataset.id, act=b.dataset.act;
        if(act==="pre"){
          await updateDoc(doc(db,"loans",id),{status:"preapproved",updatedAt:serverTimestamp(),contractSigned:false,contractId:genContract()});
          loadPending(); loadPre();
        }
        if(act==="del"){
          await updateDoc(doc(db,"loans",id),{status:"deleted",updatedAt:serverTimestamp()});
          loadPending();
        }
      };
    }

    async function loadPre(){
      $("#preBox").textContent="Cargando‚Ä¶";
      const snap = await getDocs(query(collection(db,"loans"),where("status","==","preapproved"),orderBy("createdAt","desc"),limit(50)));
      if(snap.empty){ $("#preBox").textContent="Sin preaprobados"; return;}
      $("#preBox").innerHTML=[...snap.docs].map(d=>cardPre(d.data(),d.id)).join("");
      $("#preBox").onclick = async ev=>{
        const b=ev.target.closest("button"); if(!b) return;
        const id=b.dataset.id, act=b.dataset.act;
        const l = (await getDoc(doc(db,"loans",id))).data();
        if(act==="contract"){ openContractPdf({id, ...l}); }
        if(act==="share"){
          const txt=`Contrato ${l.contractId}\n${l.borrower.name} ¬∑ DNI ${l.borrower.dni}\nMonto: ${money(l.amount)} ¬∑ ${l.months} cuotas\nLink: (compart√≠ el PDF desde "Contrato PDF")`;
          try{ await navigator.share({title:"Contrato EstimaPres",text:txt}); }catch{}
        }
        if(act==="otp"){ await updateDoc(doc(db,"loans",id),{contractSigned:true,updatedAt:serverTimestamp()}); loadPre();}
        if(act==="approve"){
          if(!l.contractSigned){ toast("Antes debe estar firmado."); return; }
          await updateDoc(doc(db,"loans",id),{status:"active",activeAt:serverTimestamp(),paidCount:0,updatedAt:serverTimestamp()});
          loadPre(); loadActive();
        }
      };
    }

    async function loadActive(){
      $("#activeBox").textContent="Cargando‚Ä¶";
      const snap = await getDocs(query(collection(db,"loans"),where("status","==","active"),orderBy("activeAt","desc"),limit(80)));
      if(snap.empty){ $("#activeBox").textContent="Sin activos"; return;}
      $("#activeBox").innerHTML=[...snap.docs].map(d=>cardActive(d.data(),d.id)).join("");
      $("#activeBox").onclick = async ev=>{
        const b=ev.target.closest("button"); if(!b) return;
        const id=b.dataset.id, act=b.dataset.act;
        const ref = doc(db,"loans",id); const l=(await getDoc(ref)).data();
        if(act==="view"){ showScheduleForAdmin(id,l); }
        if(act==="finish"){
          const allPaid = Number(l.paidCount||0)>=Number(l.months||0);
          if(!allPaid){ return toast("No pod√©s finalizar: quedan cuotas pendientes."); }
          await updateDoc(ref,{status:"finished",updatedAt:serverTimestamp()}); loadActive(); loadInactive("finished");
        }
        if(act==="chargeoff"){
          await updateDoc(ref,{status:"charged_off",updatedAt:serverTimestamp()}); loadActive(); loadInactive("charged_off");
        }
      };
    }

    async function loadInactive(kind){
      $("#inactiveBox").textContent="Cargando‚Ä¶";
      const snap = await getDocs(query(collection(db,"loans"),where("status","==",kind),orderBy("updatedAt","desc"),limit(80)));
      if(snap.empty){ $("#inactiveBox").textContent="Sin inactivos"; return;}
      $("#inactiveBox").innerHTML=[...snap.docs].map(d=>cardInactive(d.data(),d.id)).join("");
    }

    function showScheduleForAdmin(id,l){
      const paid=Number(l.paidCount||0), c=cuota(l.amount,l.tna,l.months);
      const dates = nextScheduleDates(SETTINGS.dueDay,l.months);
      const rows = dates.map((d,i)=> {
        const isPaid = i<paid;
        const btn = isPaid ? `<span class="pill ok">Pagada</span>` :
          `<button class="btn" data-act="pay" data-i="${i}" data-id="${id}">Marcar pagada</button>`;
        return `<tr>
          <td style="width:60px">${i+1}</td>
          <td>${d}</td>
          <td>${money(c)}</td>
          <td>${btn}</td>
        </tr>`;
      }).join("");
      // light modal reusing main modal
      $("#myLoanTitle").textContent=`Cuotas ‚Äî ${l.borrower.name} (admin)`;
      $("#myLoanInfo").innerHTML=`Contrato: <b>${l.contractId||"‚Äî"}</b> ¬∑ Progreso: <b>${paid}/${l.months}</b>`;
      $("#btnMyLoanPDF").onclick = ()=>openContractPdf(l);
      $("#myLoanTable").innerHTML=`<table>
        <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
      $("#myLoanModal").classList.add("open");
      $("#myLoanTable").onclick = async ev=>{
        const b=ev.target.closest("button"); if(!b) return;
        if(b.dataset.act==="pay"){
          const ref = doc(db,"loans",b.dataset.id);
          const cur = Number((await getDoc(ref)).data().paidCount||0);
          const idx = Number(b.dataset.i);
          if(idx!==cur) return toast("Pag√° en orden (1,2,3‚Ä¶)");
          await updateDoc(ref,{paidCount:cur+1,updatedAt:serverTimestamp()});
          $("#myLoanModal").classList.remove("open");
          loadActive();
        }
      };
    }

    // ---------- Ver mi pr√©stamo (usuario) ----------
    const myModal=$("#myLoanModal"); $("#btnCloseMyLoan").onclick=()=>myModal.classList.remove("open");
    $("#btnMyLoan").onclick = async()=>{
      const dni = prompt("Ingres√° tu DNI para ver tu pr√©stamo:");
      if(!dni) return;
      const snap = await getDocs(query(collection(db,"loans"),orderBy("createdAt","desc"),limit(80)));
      const list = []; snap.forEach(d=>{ const l=d.data(); if(l.borrower?.dni==dni) list.push({id:d.id,...l}); });
      if(!list.length){ alert("No encontramos pr√©stamos para ese DNI."); return; }
      // prefiero activo, sino el m√°s nuevo
      const loan = list.find(x=>x.status==="active") || list[0];
      renderMyLoan(loan);
    };

    function renderMyLoan(l){
      const c=cuota(l.amount,l.tna,l.months);
      const paid=Number(l.paidCount||0);
      const dates=nextScheduleDates(SETTINGS.dueDay,l.months);
      $("#myLoanTitle").textContent=`${l.borrower.name} ‚Äî DNI ${l.borrower.dni}`;
      $("#myLoanInfo").innerHTML=`Contrato: <b>${l.contractId||"‚Äî"}</b> ¬∑ Estado: <b>${l.status}</b>`;
      $("#myLoanProg").innerHTML=`<span class="pill">Pagadas ${paid}/${l.months}</span>`;
      const rows = dates.map((d,i)=>`<tr>
        <td style="width:60px">${i+1}</td>
        <td>${d}</td>
        <td>${money(c)}</td>
        <td>${i<paid?'<span class="pill ok">Pagada</span>':'<span class="badge">Pendiente</span>'}</td>
      </tr>`).join("");
      $("#myLoanTable").innerHTML=`<table>
        <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
      $("#btnMyLoanPDF").onclick = ()=>openContractPdf(l,true);
      myModal.classList.add("open");
    }

    // ---------- Contrato PDF (A4) ----------
    function genContract(){
      const abc="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let r=""; for(let i=0;i<8;i++) r+=abc[Math.floor(Math.random()*abc.length)];
      return r;
    }
    function openContractPdf(l,forUser=false){
      const today = new Date();
      const html = `
<!doctype html><html><head><meta charset="utf-8">
<style>
  @page { size: A4; margin: 18mm; }
  body{ font-family:Inter,Arial,Helvetica; color:#111; }
  h1{ font-size:22px; margin:0 0 16px; }
  h2{ font-size:16px; margin:16px 0 8px; }
  p,li{ font-size:13px; line-height:1.55; margin:8px 0; }
  .muted{ color:#555 }
  .block{ border:1px solid #ddd; padding:12px; border-radius:10px; }
  table{ width:100%; border-collapse:collapse; margin-top:8px }
  th,td{ text-align:left; padding:6px 8px; border-bottom:1px solid #eee; font-size:12px }
</style></head><body>
  <h1>Contrato de pr√©stamo ‚Äî EstimaPres</h1>
  <p class="muted">Contrato N¬∫ <b>${l.contractId||"‚Äî"}</b> ‚Äî Fecha ${pad(today.getDate())}/${pad(today.getMonth()+1)}/${today.getFullYear()}</p>
  <div class="block">
    <h2>Datos del solicitante</h2>
    <p>Nombre: <b>${l.borrower.name}</b></p>
    <p>DNI: <b>${l.borrower.dni}</b></p>
    <p>Email: <b>${l.borrower.email}</b> ¬∑ Tel: <b>${l.borrower.phone}</b></p>
    <p>Alias/CBU/CVU: <b>${l.borrower.cbu}</b></p>
  </div>

  <div class="block">
    <h2>Condiciones del pr√©stamo</h2>
    <p>Principal: <b>${money(l.amount)}</b></p>
    <p>Cuotas: <b>${l.months}</b></p>
    <p>TNA: <b>${l.tna}%</b></p>
    <p>Estado actual: <b>${l.status}</b></p>
  </div>

  <div class="block">
    <h2>Cronograma de pagos</h2>
    <table>
      <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th></tr></thead>
      <tbody>
        ${nextScheduleDates(SETTINGS.dueDay,l.months).map((d,i)=>`<tr><td>${i+1}</td><td>${d}</td><td>${money(cuota(l.amount,l.tna,l.months))}</td></tr>`).join("")}
      </tbody>
    </table>
  </div>

  <div class="block">
    <h2>Aceptaci√≥n</h2>
    <p>El solicitante declara haber le√≠do y aceptado los t√©rminos. ${forUser? "":"(Registro de firma almacenado en el sistema.)"}</p>
  </div>
</body></html>`;
      const w=window.open("about:blank","_blank"); w.document.write(html); w.document.close();
      w.focus(); try{ w.print(); }catch{}
    }

    // ---------- Toast ----------
    function toast(msg){
      const t=document.createElement("div");
      t.textContent=msg; t.style.position="fixed"; t.style.left="50%"; t.style.bottom="22px";
      t.style.transform="translateX(-50%)"; t.style.background="#111"; t.style.color="#fff";
      t.style.padding="10px 14px"; t.style.borderRadius="10px"; t.style.zIndex="1000";
      document.body.appendChild(t); setTimeout(()=>{t.remove()},2300);
    }

    // init
    loadSettings();
  </script>
</body>
</html>