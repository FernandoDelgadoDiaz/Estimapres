<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EstimaPres · Préstamos en ARS</title>
  <style>
    body {font-family: system-ui, sans-serif; margin:0; background:#f5f7fa;}
    header {background:#0a2f73; color:white; padding:12px 16px; display:flex; align-items:center; justify-content:space-between;}
    header h1 {margin:0; font-size:18px;}
    header button {background:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;}
    .container {padding:16px;}
    h2 {margin-top:24px; font-size:18px; color:#0a2f73;}
    input, button {font-size:14px; padding:8px; margin:4px 0; border-radius:6px; border:1px solid #ccc; width:100%;}
    button {background:#0a2f73; color:#fff; border:none; cursor:pointer;}
    button:hover {opacity:0.9;}
    .btn {padding:6px 10px; margin:2px; border-radius:6px; border:none; cursor:pointer;}
    .btn.primary {background:#0a2f73; color:white;}
    .btn.light {background:#ddd;}
    .btn.warn {background:#f0ad4e; color:white;}
    .btn.ok {background:#5cb85c; color:white;}
    .btn.bad {background:#d9534f; color:white;}
    .cardlet {background:white; padding:12px; margin:8px 0; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1);}
    .row {display:flex; justify-content:space-between; align-items:center;}
    .tag {font-size:12px; padding:2px 6px; border-radius:12px; background:#eee; margin-right:8px;}
    .dot {height:10px; width:10px; border-radius:50%; display:inline-block; margin-right:4px;}
    .dot.green{background:#5cb85c;} .dot.yellow{background:#f0ad4e;} .dot.red{background:#d9534f;}
    .badge-sm {font-size:12px; background:#eee; padding:2px 6px; border-radius:6px;}
    .actions-row {margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;}
    .hidden {display:none;}
    .hr {height:1px; background:#ddd; margin:12px 0;}
    .details {margin-top:8px; font-size:13px;}
    .small {font-size:12px; color:#555;}
    table {width:100%; border-collapse:collapse; margin-top:8px;}
    th,td {border:1px solid #ddd; padding:6px; font-size:13px;}
    th {background:#f0f0f0;}
  </style>
</head>
<body>
  <header>
    <h1>EstimaPres</h1>
    <div>
      <button id="btnMyLoan">Ver mi préstamo</button>
      <button id="btnAdmin">Ingresar</button>
      <button id="btnSignOut" hidden>Salir</button>
    </div>
  </header>
  <div class="container">
    <h2>Simulador (pesos argentinos)</h2>
    <input id="simAmount" type="number" placeholder="Monto (ARS)" />
    <input id="simMonths" type="number" placeholder="Cuotas (meses)" />
    <button id="btnSimulate">Simular</button>
    <div id="simResult" class="details"></div>
    <p class="small">TNA vigente: <span id="tnaLabel">--%</span> · Vencimiento: día <span id="dueDayLabel">10</span></p>

    <h2>Solicitar préstamo</h2>
    <form id="loanForm">
      <input id="rqName" placeholder="Nombre y apellido" />
      <input id="rqDni" placeholder="DNI" />
      <input id="rqEmail" placeholder="Email" />
      <input id="rqPhone" placeholder="Celular" />
      <input id="rqCbu" placeholder="CBU / CVU o Alias (depósito)" />
      <button id="btnSendRequest">Enviar solicitud</button>
    </form>

    <div id="adminPanel" hidden>
      <h2>Panel de administrador</h2>
      <p class="small">Gestión interna de EstimaPres</p>
      <h3>1) Tasa centralizada (TNA %)</h3>
      <input id="adminTna" type="number" />
      <button id="btnSaveTna">Guardar</button>
      <h3>2) Solicitudes pendientes</h3>
      <div id="pendingList">Cargando…</div>
      <h3>3) Preaprobados (Contrato / Firma OTP / Depósito)</h3>
      <div id="preList">Cargando…</div>
      <h3>4) Préstamos activos (agrupados por semáforo)</h3>
      <div id="activeList">Cargando…</div>
      <h3>5) Inactivos (finalizados / incobrables)</h3>
      <div><b>Finalizados</b></div>
      <div id="finishedList">Cargando…</div>
      <div><b>Incobrables</b></div>
      <div id="chargedList">Cargando…</div>
    </div>
  </div><!-- Firebase JS SDK (v10 módulos) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs,
      updateDoc, deleteDoc, query, where, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // === CONFIG FIREBASE REAL CORREGIDA ===
    const firebaseConfig = {
      apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
      authDomain: "estimapres.firebaseapp.com",
      projectId: "estimapres",
      storageBucket: "estimapres.appspot.com",   // ✅ corregido
      messagingSenderId: "578516597437",
      appId: "1:578516597437:web:f59994b87729aa1cd655d4"
    };

    // --- Inicialización Firebase ---
    let app, db, auth;
    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
    } catch (e) {
      alert("Error inicializando la app:\n" + e);
      throw e;
    }

    // --- Helpers/UI ---
    const $ = (id)=>document.getElementById(id);
    const money = (n)=> n.toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const dueDay = 10; $("dueDayLabel").textContent = String(dueDay);
    const allowedAdmins = ["fernandogastondelgado81@gmail.com"]; // lista de admins

    // --- TNA centralizada ---
    async function loadTna(){
      const ref = doc(db,"config","general");
      const snap = await getDoc(ref);
      let tna = 100;
      if(snap.exists()) tna = Number(snap.data().tna)||tna; else await setDoc(ref,{tna});
      $("tnaLabel").textContent = `${tna}%`;
      $("adminTna").value = tna;
    }
    async function saveTna(){
      const val = Number($("adminTna").value||0);
      await setDoc(doc(db,"config","general"), { tna: val }, { merge:true });
      $("tnaLabel").textContent = `${val}%`;
      alert("TNA guardada.");
    }
    $("btnSaveTna").onclick = saveTna;

    // --- Simulador ---
    const monthlyPayment = (P,tna,n)=>{
      const r=(tna/100)/12; return Math.round(P*(r/(1-Math.pow(1+r,-n))));
    };
    $("btnSimulate").onclick = ()=>{
      const P = Number($("simAmount").value||0);
      const n = Number($("simMonths").value||0);
      const tna = Number($("adminTna").value||$("tnaLabel").textContent.replace("%",""));
      if(!P||!n) return alert("Completá monto y cuotas.");
      const c = monthlyPayment(P,tna,n);
      $("simResult").innerHTML = `<div class="details"><b>Cuota estimada:</b> ${money(c)} · Total aprox: ${money(c*n)}</div>`;
    };

    // --- Enviar solicitud ---
    $("btnSendRequest").onclick = async (e)=>{
      e.preventDefault();
      const amount = Number($("simAmount").value||0);
      const months = Number($("simMonths").value||0);
      const borrower = {
        name:$("rqName").value.trim(),
        dni:$("rqDni").value.trim(),
        email:$("rqEmail").value.trim(),
        phone:$("rqPhone").value.trim(),
        cbu:$("rqCbu").value.trim()
      };
      if(!amount||!months||!borrower.name||!borrower.dni||!borrower.email||!borrower.phone||!borrower.cbu){
        return alert("Completá todos los campos y simulá primero.");
      }
      const tSnap = await getDoc(doc(db,"config","general"));
      const tna = tSnap.exists()? Number(tSnap.data().tna):100;
      await addDoc(collection(db,"loan_requests"),{
        borrower, amount, months, tna, createdAt: serverTimestamp()
      });
      alert("Solicitud enviada.");
    };// --- Auth + Admin ---
    const provider = new GoogleAuthProvider();
    $("btnAdmin").onclick = async ()=>{
      if(!auth.currentUser){
        await signInWithPopup(auth,provider).catch(err=>alert(err.message));
      }else{
        $("adminPanel").hidden = !$("adminPanel").hidden;
      }
    };
    $("btnSignOut").onclick = ()=>signOut(auth);

    onAuthStateChanged(auth, async (user)=>{
      const isAdmin = !!user && allowedAdmins.includes(user.email||"");
      $("btnSignOut").hidden = !user;
      $("btnAdmin").textContent = user? "Admin" : "Ingresar";
      $("adminPanel").hidden = !isAdmin;
      if(isAdmin){ await loadTna(); }
    });

    // --- “Ver mi préstamo” (cliente) ---
    $("btnMyLoan").onclick = async ()=>{
      const code = prompt("Ingresá tu código OTP:");
      if(!code) return;
      const snap = await getDocs(query(collection(db,"loans"), where("otp","==",code)));
      if(snap.empty) return alert("No se encontró un préstamo con ese OTP.");
      const d = snap.docs[0]; const l=d.data();
      const html = `<html><head><meta charset="utf-8"><title>Mi préstamo</title></head>
        <body><h2>Mi préstamo</h2><p>${l.borrower.name} · DNI ${l.borrower.dni}</p>
        <p>Monto: ${money(l.amount)} · Plazo: ${l.months} meses · TNA: ${l.tna}%</p></body></html>`;
      const w = window.open("about:blank","_blank"); w.document.write(html); w.document.close();
    };

    // --- Primera carga ---
    loadTna();
  </script>
</body>
</html>