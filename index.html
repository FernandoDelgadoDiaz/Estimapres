<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
    <title>Sistema de Gesti贸n de Cr茅ditos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --brand: #0e48c7; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --bg: #08215e; --text: #1e293b; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding-bottom: 50px; }
        .container { max-width: 550px; margin: 0 auto; padding: 15px; }
        .glass-card { background: white; border-radius: 28px; padding: 25px; margin-bottom: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2); position: relative; }
        h1, h3 { color: var(--brand); font-weight: 800; margin: 0 0 15px 0; letter-spacing: -0.5px; }
        label { display: block; font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 6px; }
        input, select { width: 100%; padding: 15px; border-radius: 16px; border: 1px solid #e2e8f0; font-size: 16px; margin-bottom: 14px; box-sizing: border-box; font-weight: 600; background: #f8fafc; }
        .btn-main { width: 100%; background: var(--brand); color: white; border: none; padding: 18px; border-radius: 20px; font-weight: 800; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn-tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding: 5px; }
        .tab { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 12px 20px; border-radius: 30px; font-size: 12px; cursor: pointer; white-space: nowrap; font-weight: 700; }
        .tab.active { background: white; color: var(--brand); }
        .loan-card { background: #f1f5f9; padding: 20px; border-radius: 22px; margin-bottom: 15px; border: 1px solid #e2e8f0; position: relative; }
        #sig-canvas { border: 2px dashed #cbd5e1; border-radius: 18px; background: #fff; touch-action: none; width: 100%; }
        .hidden { display: none !important; }
        .badge-vencido { color: var(--danger); font-weight: 800; font-size: 10px; }
    </style>
</head>
<body>

<header style="text-align: center; color: white; padding: 40px 0 20px;">
    <h1 id="brandHeader" style="color:white; margin:0; font-size: 34px;">Cargando...</h1>
    <p style="opacity: 0.8; font-weight: 600;">Gesti贸n de Cr茅ditos</p>
</header>

<div class="container">
    <div id="viewClient">
        <div class="glass-card">
            <h3> Simulador</h3>
            <label>Monto</label>
            <input type="number" id="sMonto" placeholder="Ej: 50000">
            <label>Cuotas</label>
            <select id="sCuotas">
                <option value="6">6 Meses</option>
                <option value="12">12 Meses</option>
                <option value="24">24 Meses</option>
            </select>
            <button id="btnSim" class="btn-main">Calcular</button>
            <div id="resSim" class="hidden" style="text-align:center; margin-top:15px;">
                <label>Cuota Mensual:</label>
                <div id="txtCuota" style="font-size:28px; font-weight:800; color:var(--brand);"></div>
            </div>
        </div>

        <div class="glass-card">
            <h3> Solicitud</h3>
            <input id="fName" placeholder="Nombre Completo">
            <input id="fDni" type="number" placeholder="DNI">
            <input id="fTel" placeholder="WhatsApp">
            <input id="fAliasClient" placeholder="Tu CBU/Alias para recibir">
            <button id="btnSend" class="btn-main" style="background:var(--success)">Enviar</button>
        </div>

        <div class="glass-card">
            <h3> Mi Estado</h3>
            <input id="searchDni" type="number" placeholder="DNI">
            <button id="btnSearch" class="btn-main">Consultar</button>
            <div id="searchRes" class="hidden" style="margin-top:20px;"></div>
        </div>
        <center><button id="btnStaff" style="background:none; border:none; color:white; opacity:0.3; margin-top:20px;">Acceso Staff</button></center>
    </div>

    <div id="viewAdmin" class="hidden">
        <div class="glass-card">
            <h3>锔 Configuraci贸n Global</h3>
            <label>Nombre Negocio</label><input id="cfgName">
            <label>Localidad (Para Contratos)</label><input id="cfgLoc">
            <label>CBU/Alias de Cobro</label><input id="cfgAlias">
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>Inter茅s %</label><input type="number" id="cfgTasa"></div>
                <div style="flex:1"><label>D铆a Vence</label><input type="number" id="cfgDia"></div>
            </div>
            <button id="btnSaveCfg" class="btn-main" style="background:var(--text)">Guardar Cambios</button>
        </div>

        <div class="btn-tabs">
            <div class="tab active" onclick="tabAdmin('pending')">Solicitudes</div>
            <div class="tab" onclick="tabAdmin('alerts')" style="color:var(--danger); border:1px solid var(--danger)">锔 ALERTAS</div>
            <div class="tab" onclick="tabAdmin('active')">Activos</div>
            <div class="tab" onclick="tabAdmin('bad_debt')">Mora</div>
        </div>
        <div id="adminContent"></div>
        <button id="btnLogout" class="btn-main" style="background:var(--danger); margin-top:20px;">Cerrar Sesi贸n</button>
    </div>
</div>

<div id="modalFirma" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; display:flex; align-items:center; justify-content:center;">
    <div class="glass-card" style="width:90%; max-width:400px;">
        <h3>FIRMA DIGITAL</h3>
        <canvas id="sig-canvas" height="150"></canvas>
        <button id="btnConfirmFirma" class="btn-main" style="margin-top:10px;">Confirmar Firma</button>
        <button onclick="$('modalFirma').classList.add('hidden')" style="width:100%; background:none; border:none; margin-top:10px;">Cancelar</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, doc, getDoc, getDocs, updateDoc, deleteDoc, collection, query, where, orderBy, setDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
        authDomain: "estimapres.firebaseapp.com",
        projectId: "estimapres",
        storageBucket: "estimapres.firebasestorage.app",
        messagingSenderId: "578516597437",
        appId: "1:578516597437:web:f59994b87729aa1cd655d4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const $ = id => document.getElementById(id);
    const fmt = n => "$ " + Number(n).toLocaleString("es-AR");

    let CONFIG = { name: "EstimaF", location: "R铆o Gallegos", alias: "pago.mp", tasa: 65, dia: 10 };
    let curTab = 'pending';
    let currentLoanId = null;

    // --- CARGAR CONFIGURACIN ---
    async function loadSettings() {
        const d = await getDoc(doc(db, "settings", "main"));
        if(d.exists()) {
            CONFIG = d.data();
            $("brandHeader").innerText = CONFIG.name;
            $("cfgName").value = CONFIG.name;
            $("cfgLoc").value = CONFIG.location;
            $("cfgAlias").value = CONFIG.alias;
            $("cfgTasa").value = CONFIG.tasa;
            $("cfgDia").value = CONFIG.dia;
        }
    }

    // --- SIMULADOR ---
    $("btnSim").onclick = () => {
        const m = Number($("sMonto").value);
        if(!m) return;
        const q = Math.round((m * (1 + (CONFIG.tasa/100))) / $("sCuotas").value);
        $("resSim").classList.remove("hidden");
        $("txtCuota").innerText = fmt(q);
    };

    // --- SOLICITUD ---
    $("btnSend").onclick = async () => {
        if(!$("fName").value || !$("sMonto").value) return alert("Faltan datos");
        const m = Number($("sMonto").value);
        await addDoc(collection(db, "loans"), {
            name: $("fName").value, dni: $("fDni").value, phone: $("fTel").value,
            alias: $("fAliasClient").value, amount: m, months: Number($("sCuotas").value),
            quota: Math.round((m * (1 + (CONFIG.tasa/100))) / $("sCuotas").value),
            status: "pending", paidCount: 0, createdAt: new Date()
        });
        alert("Solicitud enviada"); location.reload();
    };

    // --- PDF ---
    window.generarPDF = (d, tipo) => {
        const { jsPDF } = window.jspdf;
        const docPDF = new jsPDF();
        docPDF.text(tipo === 'contrato' ? "CONTRATO DE PRSTAMO" : "INTIMACIN DE PAGO", 20, 20);
        docPDF.text(`Lugar: ${CONFIG.location}`, 20, 30);
        docPDF.text(`Cliente: ${d.name} | DNI: ${d.dni}`, 20, 40);
        docPDF.text(`Monto Cuota: ${fmt(d.quota)}`, 20, 50);
        docPDF.text(`Jurisdicci贸n: Tribunales de ${CONFIG.location}`, 20, 60);
        docPDF.save(`${tipo}_${d.dni}.pdf`);
    };

    // --- ALERTAS DE MORA ---
    async function loadAlerts() {
        const snap = await getDocs(collection(db, "loans"));
        const cont = $("adminContent"); cont.innerHTML = "<h3>锔 Pagos Vencidos</h3>";
        const hoy = new Date();
        snap.forEach(docu => {
            const d = docu.data();
            if(d.status !== 'active' && d.status !== 'bad_debt') return;
            const fechaCrea = d.createdAt.toDate ? d.createdAt.toDate() : new Date(d.createdAt);
            for(let i=1; i<=d.months; i++) {
                let fV = new Date(fechaCrea); fV.setMonth(fV.getMonth() + i); fV.setDate(CONFIG.dia);
                if(hoy > fV && (d.paidCount || 0) < i) {
                    cont.innerHTML += `<div class="loan-card" style="border-left:5px solid red">
                        <b>${d.name}</b> DEBE CUOTA ${i}<br><small>Venci贸 el ${fV.toLocaleDateString()}</small><br>
                        <button onclick='window.generarPDF(${JSON.stringify(d)}, "mora")'>Intimar</button>
                    </div>`;
                    break;
                }
            }
        });
    }

    // --- ADMIN PANEL ---
    window.tabAdmin = (t) => {
        curTab = t;
        document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
        if(t === 'alerts') loadAlerts(); else loadAdmin();
    };

    async function loadAdmin() {
        const snap = await getDocs(collection(db, "loans"));
        const cont = $("adminContent"); cont.innerHTML = "";
        snap.forEach(docu => {
            const d = { id: docu.id, ...docu.data() };
            if(d.status !== curTab) return;
            const div = document.createElement("div"); div.className = "loan-card";
            div.innerHTML = `<b>${d.name}</b> (DNI: ${d.dni})<br>Monto: ${fmt(d.amount)}<br>
                <div style="margin-top:10px; font-size:11px;">Depositar en: ${d.alias || 'S/D'}</div>
                <button onclick="window.updateStatus('${d.id}', 'waiting_signature')">Aprobar</button>
                <button onclick="window.generarPDF(${JSON.stringify(d)}, 'contrato')">Contrato</button>
                <button onclick="window.deleteLoan('${d.id}')" style="color:red">Borrar</button>`;
            cont.appendChild(div);
        });
    }

    // --- ACCIONES ---
    window.updateStatus = async (id, s) => { await updateDoc(doc(db,"loans",id), {status:s}); loadAdmin(); };
    window.deleteLoan = async (id) => { if(confirm("驴Borrar?")) { await deleteDoc(doc(db,"loans",id)); loadAdmin(); } };
    $("btnSaveCfg").onclick = async () => {
        const n = { name: $("cfgName").value, location: $("cfgLoc").value, alias: $("cfgAlias").value, tasa: Number($("cfgTasa").value), dia: Number($("cfgDia").value) };
        await setDoc(doc(db, "settings", "main"), n); location.reload();
    };

    // --- FIRMA ---
    window.firmar = (id) => { currentLoanId = id; $("modalFirma").classList.remove("hidden"); };
    $("btnConfirmFirma").onclick = async () => {
        await updateDoc(doc(db, "loans", currentLoanId), { status: 'active' });
        alert("Contrato Firmado"); location.reload();
    };

    // --- AUTH ---
    $("btnStaff").onclick = () => { const p = prompt("Clave:"); if(p) signInWithEmailAndPassword(auth, "fernandogastondelgado81@gmail.com", p); };
    onAuthStateChanged(auth, u => { if(u){ $("viewClient").classList.add("hidden"); $("viewAdmin").classList.remove("hidden"); loadAdmin(); } });
    $("btnLogout").onclick = () => signOut(auth).then(()=>location.reload());

    loadSettings();
</script>
</body>
</html>
