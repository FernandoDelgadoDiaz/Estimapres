<!-- Al final del body, antes de cerrar </body> agregar: -->

<script>
/* =======================================================
   CONEXIÓN TOTAL - Funciones expuestas al window
   ======================================================= */
(function() {
  // Mapeo de funciones que los botones del HTML llaman directamente
  
  // Funciones del onboarding (3 pasos)
  window.nextStep = function(step) {
    console.log('nextStep called', step);
    if (typeof window.showOnboardingStep === 'function') {
      window.showOnboardingStep(step);
    } else {
      // Fallback - cambiar paso manualmente
      const steps = [1, 2, 3];
      steps.forEach(s => {
        const stepEl = document.getElementById(`obStep${s}`);
        const contentEl = document.getElementById(`obContent${s}`);
        if (stepEl && contentEl) {
          if (s === step) {
            stepEl.classList.add('active');
            contentEl.classList.add('active');
          } else if (s < step) {
            stepEl.classList.add('done');
            stepEl.classList.remove('active');
            contentEl.classList.remove('active');
          } else {
            stepEl.classList.remove('done', 'active');
            contentEl.classList.remove('active');
          }
        }
      });
    }
  };
  
  window.prevStep = function(step) {
    console.log('prevStep called', step);
    if (typeof window.showOnboardingStep === 'function') {
      window.showOnboardingStep(step);
    } else {
      // Fallback
      const prev = step - 1;
      if (prev >= 1) {
        window.nextStep(prev);
      }
    }
  };
  
  // Función de registro (signup)
  window.handleSignup = function() {
    console.log('handleSignup called');
    if (typeof window.showOnboarding === 'function') {
      window.showOnboarding();
    } else {
      // Mostrar onboarding manualmente
      const overlay = document.getElementById('onboardingOverlay');
      if (overlay) overlay.classList.add('show');
    }
  };
  
  // Función de cálculo de préstamo (sistema francés + gastos)
  window.calculateLoan = function() {
    console.log('calculateLoan called');
    
    // Obtener valores del DOM
    const amountInput = document.getElementById('simAmountInput') || 
                        document.getElementById('clientAmountSlider') ||
                        document.getElementById('simAmount');
    const monthsSelect = document.getElementById('simMonths');
    const monthsHidden = document.getElementById('simMonthsHidden');
    
    let amount = 0;
    let months = 0;
    
    if (amountInput) {
      if (amountInput.type === 'range') {
        amount = parseInt(amountInput.value) || 0;
      } else {
        const rawValue = amountInput.value || '';
        amount = parseInt(rawValue.replace(/\D/g, '')) || 0;
      }
    }
    
    if (monthsSelect && monthsSelect.value) {
      months = parseInt(monthsSelect.value) || 0;
    } else if (monthsHidden && monthsHidden.value) {
      months = parseInt(monthsHidden.value) || 0;
    }
    
    if (!amount || !months) {
      alert('Completá el monto y plazo primero');
      return;
    }
    
    // Obtener configuración global
    const tna = window.gSettings?.tna || 100;
    const gastoOtorgPct = 3; // 3% fijo
    const gastoOtorgAmt = Math.round(amount * gastoOtorgPct / 100);
    const capitalFinanciar = amount + gastoOtorgAmt;
    
    // Calcular cuota con sistema francés
    const i = (tna / 100) / 12;
    let cuota = 0;
    if (i === 0) {
      cuota = capitalFinanciar / months;
    } else {
      cuota = capitalFinanciar * i * Math.pow(1 + i, months) / (Math.pow(1 + i, months) - 1);
    }
    cuota = Math.round(cuota);
    
    const totalAPagar = cuota * months;
    
    // Mostrar resultado
    const simResult = document.getElementById('simResult');
    if (simResult) {
      simResult.innerHTML = `
        <div class="sim-result-box">
          <div class="sim-cuota-display">
            <span class="sim-cuota-label">Cuota mensual</span>
            <span class="sim-cuota-value">$${cuota.toLocaleString('es-AR')}</span>
          </div>
          <div class="breakdown-box">
            <div class="breakdown-row"><span class="bl">Monto solicitado</span><span class="bv">$${amount.toLocaleString('es-AR')}</span></div>
            <div class="breakdown-row warn-row"><span class="bl">Gasto de otorgamiento (${gastoOtorgPct}%)</span><span class="bv">+ $${gastoOtorgAmt.toLocaleString('es-AR')}</span></div>
            <div class="breakdown-row"><span class="bl">Capital a financiar</span><span class="bv">$${capitalFinanciar.toLocaleString('es-AR')}</span></div>
            <div class="breakdown-row accent"><span class="bl">Total a pagar</span><span class="bv">$${totalAPagar.toLocaleString('es-AR')}</span></div>
          </div>
        </div>
      `;
    }
    
    return { amount, months, cuota, totalAPagar, capitalFinanciar, gastoOtorgAmt };
  };
  
  // Función para cerrar modal demo
  window.closeDemoModal = function() {
    const modal = document.getElementById('demoModal');
    if (modal) modal.classList.remove('open');
  };
  
  // Función para seleccionar método de pago en onboarding
  window.selectPayMethod = function(method) {
    if (typeof window.gObPayMethod !== 'undefined') {
      window.gObPayMethod = method;
    }
    const mpOpt = document.getElementById('pmOptMP');
    const manualOpt = document.getElementById('pmOptManual');
    const mpFields = document.getElementById('obMpFields');
    const manualMsg = document.getElementById('obManualMsg');
    
    if (mpOpt) mpOpt.classList.toggle('selected', method === 'mp');
    if (manualOpt) manualOpt.classList.toggle('selected', method === 'manual');
    if (mpFields) mpFields.style.display = method === 'mp' ? 'block' : 'none';
    if (manualMsg) manualMsg.style.display = method === 'manual' ? 'block' : 'none';
  };
  
  // Función para actualizar slider en moniView
  window.moniUpdateSlider = function(slider) {
    if (typeof window.moniUpdateSlider === 'function') {
      // Ya definida en el script inline
    } else if (slider) {
      const val = parseInt(slider.value) || 50000;
      const display = document.getElementById('moniAmountDisplay');
      if (display) display.textContent = '$ ' + val.toLocaleString('es-AR');
      const pct = ((val - parseInt(slider.min)) / (parseInt(slider.max) - parseInt(slider.min))) * 100;
      slider.style.background = 'linear-gradient(to right, #10b981 0%, #10b981 ' + pct + '%, #e2e8f0 ' + pct + '%)';
    }
  };
  
  // Función para simular en moniView
  window.moniSimular = function() {
    if (typeof window.moniSimular === 'function') {
      // Ya definida en el script inline
    } else {
      alert('Función de simulación no disponible');
    }
  };
  
  // Función para mostrar formulario en moniView
  window.moniShowForm = function() {
    if (typeof window.moniShowForm === 'function') {
      // Ya definida en el script inline
    } else {
      const simResult = document.getElementById('moniSimResult');
      const formSection = document.getElementById('moniFormSection');
      if (simResult) simResult.style.display = 'none';
      if (formSection) {
        formSection.style.display = 'block';
        formSection.scrollIntoView({behavior: 'smooth', block: 'start'});
      }
    }
  };
  
  // Función para enviar solicitud en moniView
  window.moniEnviarSolicitud = function() {
    if (typeof window.moniEnviarSolicitud === 'function') {
      // Ya definida en el script inline
    } else {
      alert('Envío de solicitud no disponible');
    }
  };
  
  // Función para limpiar firma
  window.clearSignature = function(canvasId) {
    const canvas = document.getElementById(canvasId || 'sigCanvas');
    if (canvas) {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  };
  
  console.log('✅ Todas las funciones han sido expuestas al objeto window');
})();
</script>