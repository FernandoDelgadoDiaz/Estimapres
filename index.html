<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EstimaPres ¬∑ Pr√©stamos personales</title>
<link rel="icon" href="assets/ping.png"/>
<style>
  :root{
    --bg:#0d47a1; --bg2:#0b66d3; --card:#ffffff; --muted:#6b7280; --ink:#0f172a;
    --ok:#16a34a; --warn:#ef4444; --brand:#0b5bd3; --line:#e5e7eb; --soft:#f3f4f6;
    --pill:#0f172a; --pillfg:#fff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#f6f7fb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:980px;margin:0 auto;padding:0 16px}
  header{background:linear-gradient(120deg,var(--bg),var(--bg2));color:#fff;padding:28px 0 18px}
  .brand-line{display:flex;align-items:center;gap:12px}
  .brand-logo{width:56px;height:56px;border-radius:14px;object-fit:cover;flex:0 0 auto}
  .brand-title{font-size:48px;line-height:1;font-weight:900;letter-spacing:.3px}
  .tagline{margin-top:10px;display:inline-block;background:rgb(255 255 255 / .14);padding:10px 16px;border-radius:18px}
  .tagline em{font-style:italic;text-decoration:underline}
  .cta-row{margin-top:14px;display:flex;gap:14px;align-items:center;flex-wrap:nowrap;overflow-x:auto}
  .btn{display:inline-flex;align-items:center;gap:8px;border:2px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);
       color:#fff;padding:10px 16px;border-radius:14px;font-weight:700;backdrop-filter:blur(4px);white-space:nowrap}
  .btn:hover{background:rgba(255,255,255,.16)}
  .btn-danger{background:#ef4444;border-color:#ef4444}
  .btn-danger:hover{filter:brightness(.95)}
  .hidden{display:none !important}

  section.card{background:var(--card);border-radius:22px;box-shadow:0 10px 26px rgba(2,8,23,.06);
               padding:22px;margin:18px 0}
  h2{margin:0 0 16px;font-size:36px;letter-spacing:.2px;color:var(--ink)}
  label{display:block;font-weight:700;margin:14px 0 6px}
  input,select{width:100%;font-size:18px;padding:14px 14px;border-radius:12px;border:1px solid var(--line);background:#fff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:760px){ .row{grid-template-columns:1fr}}
  .btn-cta{background:var(--ok);color:#fff;border:none;border-radius:14px;padding:14px 20px;font-weight:800}
  .btn-ghost{background:#eef2ff;border:1px solid #e5e7eb}
  .muted{color:var(--muted)}
  .pill{background:var(--pill);color:var(--pillfg);padding:6px 10px;border-radius:999px;font-size:12px}
  .list .item{border:1px solid var(--line);border-radius:14px;padding:14px;margin:10px 0;background:#fff}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
  th,td{padding:12px 10px;border-bottom:1px solid var(--line);text-align:left}
  th{background:#f8fafc}
  .badge{padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
  .b-green{background:#eafff1;color:#138a3a}
  .b-amber{background:#fff7e6;color:#b26b00}
  .b-red{background:#ffe6e6;color:#b32525}
  .caps{font-weight:800;letter-spacing:.3px}
  .subtle{font-size:14px;color:var(--muted)}
  .stack{display:flex;flex-direction:column;gap:10px}
  .segmented{display:flex;gap:10px}
  .segmented .tab{flex:1;text-align:center;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff}
  .segmented .tab.active{background:#e8f5ff;border-color:#bfdbfe;font-weight:800}
  .center{text-align:center}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand-line">
      <img src="assets/ping.png" class="brand-logo" alt="EstimaPres"/>
      <div class="brand-title">EstimaPres</div>
    </div>
    <div class="tagline">Pr√©stamos personales ¬∑ <em>simple y claro</em></div>
    <nav class="cta-row">
      <a id="btnOpenMyLoan" class="btn">üîé Ver mi pr√©stamo</a>
      <a id="btnAdmin" class="btn">üõ°Ô∏è Admin</a>
      <a id="btnLogout" class="btn btn-danger hidden">‚Ü™ Salir</a>
    </nav>
  </div>
</header>

<main class="wrap">

  <!-- Simulador -->
  <section class="card" id="secSim">
    <h2>Simulador</h2>
    <div class="row">
      <div>
        <label>Monto</label>
        <input id="simAmount" inputmode="numeric" placeholder="$ 1.000.000">
      </div>
      <div>
        <label>Meses</label>
        <input id="simMonths" inputmode="numeric" placeholder="Ej: 12">
      </div>
    </div>
    <p class="muted" id="simMeta">TNA vigente: ‚Äî% ¬∑ Vencimiento: d√≠a ‚Äî</p>
    <button class="btn-cta" id="btnSimular">Simular</button>
    <div id="simOut" class="stack" style="margin-top:14px"></div>
  </section>

  <!-- Solicitud -->
  <section class="card" id="secReq">
    <h2>Solicitar pr√©stamo</h2>
    <div class="row">
      <div>
        <label>Tu nombre</label>
        <input id="rqName" placeholder="Juan P√©rez">
      </div>
      <div>
        <label>DNI</label>
        <input id="rqDni" inputmode="numeric" placeholder="30123456">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Email</label>
        <input id="rqMail" placeholder="tucorreo@mail.com">
      </div>
      <div>
        <label>Tel√©fono</label>
        <input id="rqPhone" placeholder="11 2345 6789">
      </div>
    </div>
    <div class="row">
      <div>
        <label>alias o CBU/CVU</label>
        <input id="rqCbu" placeholder="alias o CBU/CVU">
      </div>
      <div style="display:flex;align-items:flex-end;gap:10px">
        <button class="btn-cta" id="btnSubmitReq">Enviar solicitud</button>
      </div>
    </div>
    <p class="muted">Al enviar acept√°s ser contactado por EstimaPres.</p>
  </section>

  <!-- Admin -->
  <section class="card hidden" id="secAdmin">
    <h2>Panel administrador</h2>

    <details open class="card" style="margin:10px 0">
      <summary class="caps">Configuraci√≥n (TNA y vencimiento)</summary>
      <div class="row" style="margin-top:10px">
        <div>
          <label>TNA %</label>
          <input id="adTna" inputmode="numeric" placeholder="150">
        </div>
        <div>
          <label>Vencimiento (d√≠a del mes)</label>
          <input id="adDue" inputmode="numeric" placeholder="10">
        </div>
      </div>
      <div style="margin-top:12px">
        <button class="btn-cta" id="btnSaveCfg">Guardar</button>
      </div>
    </details>

    <details class="card" open>
      <summary class="caps">Solicitudes pendientes</summary>
      <div id="listPend" class="list subtle">Cargando‚Ä¶</div>
    </details>

    <details class="card" open>
      <summary class="caps">Preaprobados</summary>
      <div id="listPre" class="list subtle">Cargando‚Ä¶</div>
    </details>

    <details class="card" open>
      <summary class="caps">Activos</summary>
      <div id="listAct" class="list subtle">Cargando‚Ä¶</div>
    </details>

    <details class="card" open>
      <summary class="caps">Inactivos (finalizados / incobrables)</summary>
      <div class="segmented" style="margin-bottom:10px">
        <button id="tabPaid" class="tab active">Cancelados</button>
        <button id="tabBad" class="tab">Incobrables</button>
        <button id="btnReloadInact" class="tab">Recargar</button>
      </div>
      <div id="listInact" class="list subtle">Cargando‚Ä¶</div>
    </details>
  </section>

  <!-- Ver mi pr√©stamo -->
  <section class="card" id="secMine">
    <h2>Ver mi pr√©stamo</h2>
    <div class="row">
      <div>
        <label>Ingres√° tu DNI</label>
        <input id="myDni" placeholder="Ej: 30123456" inputmode="numeric">
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn-cta" id="btnFindMyLoan">Consultar</button>
      </div>
    </div>
    <div id="myLoanResult" style="margin-top:12px"></div>
  </section>

</main>

<!-- Firebase SDKs -->
<script type="module">
// ===== Firebase v10 (m√≥dulos) =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// === config real del proyecto ===
const firebaseConfig = {
  apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
  authDomain: "estimapres.firebaseapp.com",
  projectId: "estimapres",
  storageBucket: "estimapres.firebasestorage.app",
  messagingSenderId: "578516597437",
  appId: "1:578516597437:web:f59994b87729aa1cd655d4"
};

const ADMIN_EMAIL = "fernandogastondelgado81@gmail.com";

// init
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// ===== util =====
const $ = s => document.querySelector(s);
const fmtMoney = v => (Number(v)||0).toLocaleString('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0});
const onlyDigits = s => (s||"").replace(/[^\d]/g,"");
const nowTS = ()=>serverTimestamp();

// settings en /settings/app
const settingsRef = doc(db,'settings','app');
let settings = {tna:0,dueDay:10};

// calcula cuota (sistema franc√©s)
function cuota(principal,tna,months){
  principal = Number(principal)||0;
  const r = (Number(tna)||0)/100/12;
  if(!principal || !months || !r) return 0;
  const c = principal*r / (1 - Math.pow(1+r,-months));
  return Math.round(c);
}

// due date n (1..months)
function dueDateStr(startDay, n){
  const d = new Date();
  d.setDate(1);
  d.setMonth(d.getMonth()+n); // pr√≥xima(s) mensualidades
  d.setDate(Math.min(startDay, 28)); // para evitar meses cortos
  return d.toLocaleDateString('es-AR',{day:'2-digit',month:'2-digit',year:'numeric'});
}

// arma filas de cuotas (seg√∫n paidCount)
function scheduleRows(L){
  const rows=[];
  const q = cuota(L.amount,L.tna,L.months);
  for(let i=1;i<=L.months;i++){
    rows.push({
      n:i,
      due: dueDateStr(L.dueDay||settings.dueDay||10, i),
      amount:q,
      paid: (Number(L.paidCount)||0) >= i
    });
  }
  return rows;
}

// ========= Header actions =========
$('#btnOpenMyLoan').onclick = ()=> $('#secMine').scrollIntoView({behavior:'smooth'});
$('#btnLogout').onclick = async ()=>{ await signOut(auth); alert('Sesi√≥n cerrada.'); location.hash=''; $('#secAdmin').classList.add('hidden'); $('#btnLogout').classList.add('hidden');};

// ========= auth state =========
let isAdmin=false;
onAuthStateChanged(auth, async (u)=>{
  isAdmin = !!(u && u.email===ADMIN_EMAIL);
  $('#btnLogout').classList.toggle('hidden', !isAdmin);
  if(isAdmin){ await ensureSettings(); await paintSettingsMeta(); await loadAllAdmin(); $('#secAdmin').classList.remove('hidden'); }
});

// ========= cargar/guardar settings =========
async function ensureSettings(){
  const s = await getDoc(settingsRef);
  if(s.exists()){
    settings = s.data();
  }else{
    settings = {tna:150, dueDay:10};
    await setDoc(settingsRef, {...settings, updatedAt:nowTS()});
  }
  $('#adTna').value = settings.tna || '';
  $('#adDue').value = settings.dueDay || '';
}
async function paintSettingsMeta(){
  $('#simMeta').textContent = `TNA vigente: ${settings.tna||'‚Äî'}% ¬∑ Vencimiento: d√≠a ${settings.dueDay||'‚Äî'}`;
}

// ========= Admin login =========
$('#btnAdmin').onclick = async ()=>{
  try{
    const res = await signInWithPopup(auth, provider);
    if(res.user?.email !== ADMIN_EMAIL){
      await signOut(auth);
      alert('Tu cuenta no tiene permisos de administrador.');
      return;
    }
    await ensureSettings();
    await paintSettingsMeta();
    await loadAllAdmin();
    $('#secAdmin').classList.remove('hidden');
    $('#secAdmin').scrollIntoView({behavior:'smooth'});
  }catch(e){ alert('No se pudo iniciar sesi√≥n.'); console.error(e); }
};

// ========= Guardar settings =========
$('#btnSaveCfg').onclick = async ()=>{
  try{
    const tna = Number(onlyDigits($('#adTna').value));
    const due = Number(onlyDigits($('#adDue').value))||10;
    if(!tna){ alert('Ingres√° una TNA v√°lida.'); return; }
    settings.tna=tna; settings.dueDay=due;
    await setDoc(settingsRef, {...settings, updatedAt:nowTS()}, {merge:true});
    await paintSettingsMeta();
    alert('Configuraci√≥n guardada.');
  }catch(e){ alert('Error guardando configuraci√≥n.'); console.error(e); }
};

// ========= Simulador =========
$('#btnSimular').onclick = ()=>{
  if(!settings.tna){ alert('Configur√° la TNA desde Admin antes de simular.'); return; }
  const amount = Number(onlyDigits($('#simAmount').value));
  const months = Number(onlyDigits($('#simMonths').value));
  if(!amount || !months){ alert('Ingres√° monto y meses.'); return; }
  const q = cuota(amount, settings.tna, months);
  const rows = [];
  for(let i=1;i<=months;i++){
    rows.push(`<tr>
      <td>${i}</td>
      <td>${dueDateStr(settings.dueDay||10,i)}</td>
      <td>${fmtMoney(q)}</td>
      <td><span class="badge b-amber">Pendiente</span></td>
    </tr>`);
  }
  $('#simOut').innerHTML = `
    <table>
      <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead>
      <tbody>${rows.join('')}</tbody>
    </table>`;
};

// ========= Solicitud =========
$('#btnSubmitReq').onclick = async ()=>{
  try{
    const borrower = {
      name: $('#rqName').value.trim(),
      dni: onlyDigits($('#rqDni').value),
      email: $('#rqMail').value.trim(),
      phone: $('#rqPhone').value.trim(),
      cbu: $('#rqCbu').value.trim(),
    };
    if(!borrower.name || !borrower.dni){ alert('Complet√° nombre y DNI.'); return; }
    const amount = Number(onlyDigits($('#simAmount').value||""));
    const months = Number(onlyDigits($('#simMonths').value||""));
    if(!amount || !months){ alert('Ingres√° simulaci√≥n de Monto y Meses antes de solicitar.'); return; }

    const docRef = await addDoc(collection(db,'loans'), {
      status:'pending', amount, months,
      tna: settings.tna, dueDay: settings.dueDay,
      borrower, paidCount:0,
      createdAt: nowTS(), updatedAt: nowTS()
    });
    alert('Solicitud enviada. ID: '+docRef.id);
  }catch(e){ alert('No se pudo enviar la solicitud.'); console.error(e); }
};

// ========= ADMIN: listados =========
async function loadAllAdmin(){ await loadPend(); await loadPre(); await loadAct(); await loadInact('paid'); }
async function loadPend(){
  const box = $('#listPend'); box.innerHTML="";
  try{
    const q = await getDocs(query(collection(db,'loans'), where('status','==','pending'), orderBy('createdAt','desc'), limit(80)));
    if(q.empty){ box.innerHTML='Sin pendientes'; return; }
    q.forEach(docSnap=>{
      const d = docSnap.data(); d.id = docSnap.id;
      const el = document.createElement('div'); el.className='item';
      el.innerHTML = `
        <div class="flex">
          <strong>${d.borrower?.name||''}</strong> ¬∑ DNI ${d.borrower?.dni||''}
          <span class="right muted">Principal ${fmtMoney(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}%</span>
        </div>
        <div class="flex" style="margin-top:8px">
          <button class="btn-cta" data-act="pre">Preaprobar</button>
          <button class="btn btn-danger" data-act="del">Eliminar</button>
        </div>`;
      el.querySelector('[data-act="pre"]').onclick = async ()=>{
        if(!confirm('¬øPreaprobar y generar contrato?')) return;
        await updateDoc(doc(db,'loans',d.id), {
          status:'preapproved',
          contractId: Math.random().toString(36).slice(2,10).toUpperCase(),
          updatedAt: nowTS()
        });
        await loadAllAdmin();
      };
      el.querySelector('[data-act="del"]').onclick = async ()=>{
        if(!confirm('¬øEliminar solicitud?')) return;
        await updateDoc(doc(db,'loans',d.id), {status:'deleted', updatedAt: nowTS()});
        await loadAllAdmin();
      };
      box.appendChild(el);
    });
  }catch(e){ box.innerHTML = 'No se pudieron leer las solicitudes (revisa reglas/√≠ndices).'; console.error(e); }
}

async function loadPre(){
  const box = $('#listPre'); box.innerHTML="";
  try{
    const q = await getDocs(query(collection(db,'loans'), where('status','==','preapproved'), orderBy('createdAt','desc'), limit(80)));
    if(q.empty){ box.innerHTML='Sin preaprobados'; return; }
    q.forEach(s=>{
      const d = s.data(); d.id=s.id;
      const signed = !!d.signed;
      const el = document.createElement('div'); el.className='item';
      el.innerHTML = `
        <div class="flex">
          <strong>${d.borrower?.name||''}</strong> ¬∑ DNI ${d.borrower?.dni||''}
          <span class="pill ${signed?'b-green':'b-amber'}">${signed?'Firmado':'Esperando firma'}</span>
          <span class="right muted">Contrato ${d.contractId||'-'}</span>
        </div>
        <div class="flex" style="margin-top:8px">
          <button class="btn-cta" data-act="contract">Contrato PDF</button>
          <button class="btn-ghost" data-act="share">Compartir link</button>
          <button class="btn-cta" data-act="approve" ${signed?'':'disabled'}>Aprobar y activar</button>
        </div>`;
      // abrir contrato para firmar
      el.querySelector('[data-act="contract"]').onclick = ()=> openContract(d,true);
      el.querySelector('[data-act="share"]').onclick = ()=>{
        const url = location.origin+location.pathname+`#sign-${d.id}`;
        navigator.clipboard?.writeText(url);
        alert('Link copiado para WhatsApp:\n'+url);
      };
      el.querySelector('[data-act="approve"]').onclick = async ()=>{
        if(!d.signed){ alert('A√∫n sin firma.'); return; }
        await updateDoc(doc(db,'loans',d.id), { status:'active', activeAt: nowTS(), updatedAt: nowTS() });
        await loadAllAdmin();
      };
      box.appendChild(el);
    });
  }catch(e){ box.innerHTML='Error al cargar preaprobados.'; console.error(e); }
}

async function loadAct(){
  const box = $('#listAct'); box.innerHTML="";
  try{
    const q = await getDocs(query(collection(db,'loans'), where('status','==','active'), orderBy('activeAt','desc'), limit(80)));
    if(q.empty){ box.innerHTML='Sin activos'; return; }
    q.forEach(s=>{
      const d = s.data(); d.id=s.id;
      const el = document.createElement('div'); el.className='item';
      const progress = `${Number(d.paidCount||0)}/${d.months}`;
      el.innerHTML = `
        <div class="flex">
          <span class="badge b-green">Activo</span>
          <strong>${d.borrower?.name||''}</strong> ¬∑ DNI ${d.borrower?.dni||''}
          <span class="right muted">Principal ${fmtMoney(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}% ¬∑ Progreso ${progress}</span>
        </div>
        <div class="flex" style="margin-top:8px">
          <button class="btn-cta" data-act="rows">Ver cuotas</button>
          <button class="btn-ghost" data-act="paid" ${ (Number(d.paidCount)||0) >= Number(d.months) ? '' : 'disabled' }>Pagado total</button>
          <button class="btn btn-danger" data-act="bad">A incobrables</button>
        </div>
        <div class="stack" data-box style="display:none"></div>`;
      const boxRows = el.querySelector('[data-box]');
      el.querySelector('[data-act="rows"]').onclick = ()=>{
        boxRows.style.display = boxRows.style.display==='none' ? 'block':'none';
        if(boxRows.dataset.loaded) return;
        renderRows(d, boxRows);
        boxRows.dataset.loaded = "1";
      };
      el.querySelector('[data-act="paid"]').onclick = async ()=>{
        if((Number(d.paidCount)||0) < Number(d.months)){ alert('A√∫n hay cuotas pendientes.'); return; }
        if(!confirm('¬øMarcar pr√©stamo como pagado total (cancelado)?')) return;
        await updateDoc(doc(db,'loans',d.id), { status:'paid', updatedAt: nowTS() });
        await loadAllAdmin();
      };
      el.querySelector('[data-act="bad"]').onclick = async ()=>{
        if(!confirm('¬øEnviar a incobrables?')) return;
        await updateDoc(doc(db,'loans',d.id), { status:'charged_off', updatedAt: nowTS() });
        await loadAllAdmin();
      };
      box.appendChild(el);
    });
  }catch(e){ box.innerHTML='Error al cargar activos.'; console.error(e); }
}

function renderRows(L, mount){
  const rows = scheduleRows(L);
  const t = document.createElement('div');
  const body = rows.map(r=>{
    const btn = (!r.paid && (Number(L.paidCount||0)+1===r.n))
      ? `<button class="btn-cta" data-n="${r.n}">Marcar pagada</button>` : '';
    const chip = r.paid ? `<span class="badge b-green">Pagada</span>` : `<span class="badge b-amber">Pendiente</span>`;
    return `<tr>
      <td>${r.n}</td><td>${r.due}</td><td>${fmtMoney(r.amount)}</td><td>${chip} ${btn}</td>
    </tr>`;
  }).join('');
  t.innerHTML = `<table>
    <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead>
    <tbody>${body}</tbody>
  </table>`;
  mount.innerHTML = ""; mount.appendChild(t);
  // bind bot√≥n "Marcar pagada"
  mount.querySelectorAll('[data-n]').forEach(b=>{
    b.onclick = async ()=>{
      const next = Number(b.dataset.n);
      try{
        await updateDoc(doc(db,'loans',L.id), { paidCount: next, updatedAt: nowTS() });
        // refresco local
        L.paidCount = next;
        renderRows(L, mount);
        await loadAct(); // para habilitar "Pagado total"
      }catch(e){ alert('No se pudo marcar pagada.'); console.error(e); }
    };
  });
}

let inactFilter='paid';
$('#tabPaid').onclick = ()=>{ inactFilter='paid'; $('#tabPaid').classList.add('active'); $('#tabBad').classList.remove('active'); loadInact(inactFilter); };
$('#tabBad').onclick  = ()=>{ inactFilter='charged_off'; $('#tabBad').classList.add('active'); $('#tabPaid').classList.remove('active'); loadInact(inactFilter); };
$('#btnReloadInact').onclick = ()=> loadInact(inactFilter);

async function loadInact(kind){
  const box = $('#listInact'); box.innerHTML="";
  try{
    const q = await getDocs(query(collection(db,'loans'), where('status','==',kind), orderBy('updatedAt','desc'), limit(80)));
    if(q.empty){ box.innerHTML='Sin inactivos'; return; }
    q.forEach(s=>{
      const d=s.data(); d.id=s.id;
      const el = document.createElement('div'); el.className='item';
      el.innerHTML = `
        <div class="flex">
          <span class="badge ${kind==='paid'?'b-green':'b-red'}">${kind==='paid'?'Cancelado':'Incobrable'}</span>
          <strong>${d.borrower?.name||''}</strong> ¬∑ DNI ${d.borrower?.dni||''}
          <span class="right muted">Contrato ${d.contractId||'-'}</span>
        </div>
        <div class="subtle">Principal ${fmtMoney(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}%</div>`;
      box.appendChild(el);
    });
  }catch(e){ box.innerHTML='Error al cargar inactivos.'; console.error(e); }
}

// ========= Contrato (A4, firma por nombre) =========
function openContract(L, forAdmin){
  const title = `Contrato N¬∞ ${L.contractId} ‚Äî ${L.borrower?.name||''} ‚Äî DNI ${L.borrower?.dni||''}`;
  const quota = fmtMoney(cuota(L.amount,L.tna,L.months));
  const total = fmtMoney(cuota(L.amount,L.tna,L.months)*L.months);
  const w = window.open('about:blank','_blank');
  const html = `
<!doctype html><html lang="es"><head>
<meta charset="utf-8"/><title>${title}</title>
<style>
  @page { size: A4; margin: 18mm;}
  body{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto;margin:0;color:#111}
  h1{margin:0 0 8px;font-size:22px}
  .muted{color:#6b7280}
  .box{border:1px solid #e5e7eb;border-radius:10px;padding:14px;margin:10px 0}
  .actions{margin-top:16px}
  button{padding:10px 14px;border:none;border-radius:10px;background:#0b66d3;color:#fff;font-weight:800}
  input{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
</style>
</head><body>
  <h1>${title}</h1>
  <div class="muted">EstimaPres ¬∑ Pr√©stamos personales</div>
  <div class="box">
    <p><strong>CONDICIONES:</strong></p>
    <ul>
      <li>Monto principal: <strong>${fmtMoney(L.amount)}</strong></li>
      <li>TNA: <strong>${L.tna}%</strong> ¬∑ Cuotas: <strong>${L.months}</strong> ¬∑ D√≠a de vencimiento: <strong>${L.dueDay}</strong></li>
      <li>Cuota estimada: <strong>${quota}</strong> ¬∑ Importe total estimado: <strong>${total}</strong></li>
    </ul>
    <p class="muted">El detalle de cuotas y vencimientos estar√° disponible en la app. Este documento es v√°lido para su impresi√≥n en formato A4.</p>
  </div>
  <div class="box">
    <p>Para aceptar el contrato, escrib√≠ tu <strong>Nombre y Apellido</strong> y presion√° ‚ÄúAcepto el contrato‚Äù.</p>
    <label>Nombre y Apellido</label>
    <input id="signName" placeholder="${L.borrower?.name||''}"/>
    <div class="actions">
      <button id="btnAccept">Acepto el contrato</button>
      <button onclick="window.print()" style="background:#16a34a;margin-left:8px">Imprimir / PDF</button>
    </div>
  </div>
<script>
  document.getElementById('btnAccept').addEventListener('click', ()=>{
    const v = (document.getElementById('signName').value||'').trim();
    if(!v){ alert('Escrib√≠ tu nombre y apellido'); return; }
    // enviamos respuesta al opener
    if(window.opener){
      window.opener.postMessage({type:'signed', id:'${L.id}', value:v}, '*');
    }
    alert('¬°Contrato aceptado!');
  });
</script>
</body></html>`;
  w.document.write(html); w.document.close();
}

// recibir postMessage de firma
window.addEventListener('message', async (ev)=>{
  try{
    if(ev?.data?.type!=='signed') return;
    await updateDoc(doc(db,'loans',ev.data.id), { signed:true, signedName:ev.data.value, signedAt: nowTS(), updatedAt: nowTS() });
    alert('Firma registrada. Pod√©s aprobar desde el panel.');
    await loadAllAdmin();
  }catch(e){ alert('No se pudo registrar la firma.'); console.error(e); }
});

// abrir contrato si llega con hash #sign-ID (para solicitante)
(async function tryOpenSignFromHash(){
  if(!location.hash.startsWith('#sign-')) return;
  const id = location.hash.replace('#sign-','').trim();
  const snap = await getDoc(doc(db,'loans',id));
  if(!snap.exists()) return;
  const L = snap.data(); L.id=id;
  openContract(L,false);
})();

// ========= Mi pr√©stamo (usuario) =========
$('#btnFindMyLoan').onclick = async ()=>{
  const dni = onlyDigits($('#myDni').value);
  if(!dni){ $('#myLoanResult').textContent='Ingres√° un DNI.'; return; }
  $('#myLoanResult').textContent='Buscando‚Ä¶';
  try{
    const qs = await getDocs(query(collection(db,'loans'), orderBy('createdAt','desc'), limit(100)));
    const list=[];
    qs.forEach(d=>{ const L=d.data(); if((L?.borrower?.dni||'')===dni) list.push({id:d.id,...L}); });
    if(!list.length){ $('#myLoanResult').textContent='No encontramos pr√©stamos activos o preaprobados para ese DNI.'; return; }
    const L = list[0];
    const rows = scheduleRows(L);
    const paid = Number(L.paidCount||0);
    const table = rows.map(r=>`<tr><td>${r.n}</td><td>${r.due}</td><td>${fmtMoney(r.amount)}</td><td>${r.paid?'<span class="badge b-green">Pagada</span>':'<span class="badge b-amber">Pendiente</span>'}</td></tr>`).join('');
    $('#myLoanResult').innerHTML = `
      <div class="item">
        <div class="flex">
          <strong>Estado: ${L.status}</strong>
          <span class="right muted">Monto: ${fmtMoney(L.amount)} ¬∑ Cuotas: ${L.months} ¬∑ TNA: ${L.tna}% ¬∑ Progreso: <b>${paid}/${L.months}</b></span>
        </div>
        <div class="flex" style="margin-top:8px">
          ${L.contractId?`<button class="btn-cta" id="btnPDF">Contrato PDF</button>`:''}
        </div>
        <div style="margin-top:10px">
          <table>
            <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead>
            <tbody>${table}</tbody>
          </table>
        </div>
      </div>`;
    $('#btnPDF')?.addEventListener('click', ()=>openContract(L,false));
  }catch(e){ $('#myLoanResult').textContent='Error consultando.'; console.error(e); }
};

// ========= deep link de ‚ÄúVer mi pr√©stamo‚Äù en header =========
document.getElementById('btnOpenMyLoan').addEventListener('click', ()=> {
  document.getElementById('secMine').scrollIntoView({behavior:'smooth'});
});

// pintar meta al iniciar
ensureSettings().then(paintSettingsMeta);
</script>
</body>
</html>