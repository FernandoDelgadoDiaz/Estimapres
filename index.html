<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, interactive-widget=resizes-content" />
  <meta name="theme-color" content="#0a2f73" />
  <title>EstimaPres · Préstamos en ARS</title>
  <meta name="description" content="Simulá y solicitá préstamos en pesos argentinos. Panel admin con TNA centralizada, préstamos y control de cuotas." />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/icons/estimapres-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <style>
    :root{--brand:#0a2f73;--bg:#f6f8fc;--card:#fff;--text:#0f172a}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .app{display:flex;justify-content:center}
    .phone{width:100%;max-width:420px;min-height:100dvh;background:var(--bg)}
    header{position:sticky;top:0;background:var(--brand);color:#fff;padding:12px 14px;display:flex;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0;font-weight:700}
    button{cursor:pointer}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:12px 14px;font-weight:600}
    .btn.alt{background:#0ea5e9}
    .btn.ghost{background:#e2e8f0;color:#0f172a}
    .btn.danger{background:#dc2626;color:#fff}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,.06);padding:14px;margin:12px}
    .label{font-size:13px;color:#475569}
    .input{width:100%;padding:12px 12px;border:1px solid #e2e8f0;border-radius:10px;margin-top:6px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .muted{color:#64748b;font-size:12px}
    .result span{font-weight:700}
    .adminbar{display:flex;gap:8px;align-items:center}
    dialog{border:0;border-radius:12px;padding:0}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #e2e8f0;padding:6px;font-size:12px}
    thead th{background:#f1f5f9;text-align:left}
    .hidden{display:none}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:28px;height:28px;border-radius:8px;background:#fff;display:grid;place-items:center;color:var(--brand);font-weight:900}
    .ok{color:#047857}
    .err{color:#b91c1c}
    details>summary{list-style:none;cursor:pointer;font-weight:600}
    details>summary::-webkit-details-marker{display:none}
  </style>
</head>
<body>
  <div class="app">
    <div class="phone">
      <header>
        <div class="brand"><div class="logo">E</div><h1>EstimaPres</h1></div>
        <div class="adminbar">
          <span id="authStatus" class="muted">No admin</span>
          <button id="btnShowLogin" class="btn ghost" style="padding:8px 10px">Admin</button>
          <button id="btnLogout" class="btn ghost hidden" style="padding:8px 10px">Salir</button>
        </div>
      </header>

      <main>
        <!-- Simulador -->
        <section class="card">
          <h2 style="margin:0 0 8px 0;font-size:16px">Simulador (pesos argentinos)</h2>
          <div class="row">
            <label>
              <div class="label">Monto (ARS)</div>
              <input id="simAmount" type="number" min="1000" step="500" class="input" placeholder="Ej: 200000" />
            </label>
            <label>
              <div class="label">Cuotas (meses)</div>
              <input id="simMonths" type="number" min="1" max="60" class="input" placeholder="Ej: 12" />
            </label>
          </div>
          <div class="muted" style="margin-top:6px">TNA vigente: <b><span id="tnaSpan">—</span>%</b> · Vencimiento: día 10</div>
          <button id="btnSimulate" class="btn" style="width:100%;margin-top:10px">Simular</button>
        </section>

        <section class="card result">
          <h3 style="margin:0 0 8px 0;font-size:15px">Resultado</h3>
          <div>Monto: <span id="rMonto">—</span></div>
          <div>Cuotas: <span id="rCuotas">—</span></div>
          <div>Cuota estimada: <span id="rCuota">—</span></div>
          <div id="tablaCuotasWrap" class="hidden" style="margin-top:8px">
            <div class="muted" style="margin-bottom:6px">Detalle cuota por cuota</div>
            <div style="overflow:auto">
              <table>
                <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th></tr></thead>
                <tbody id="tablaCuotas"></tbody>
              </table>
            </div>
          </div>
          <div class="muted" style="margin-top:6px">Sistema francés. Valores orientativos. La tasa puede cambiar hasta la aprobación.</div>
        </section>

        <!-- Solicitud -->
        <section class="card">
          <h2 style="margin:0 0 8px 0;font-size:16px">Solicitar préstamo</h2>
          <div class="row">
            <label>
              <div class="label">Nombre y apellido</div>
              <input id="rqName" class="input" placeholder="Tu nombre" />
            </label>
            <label>
              <div class="label">DNI</div>
              <input id="rqDni" class="input" placeholder="30123456" />
            </label>
          </div>
          <div class="row">
            <label>
              <div class="label">Email</div>
              <input id="rqEmail" type="email" class="input" placeholder="tucorreo@dominio.com" />
            </label>
            <label>
              <div class="label">Teléfono</div>
              <input id="rqPhone" class="input" placeholder="Celular" />
            </label>
          </div>
          <label>
            <div class="label">CBU/CVU o alias (depósito)</div>
            <input id="rqAccount" class="input" placeholder="alias o CBU/CVU" />
          </label>
          <button id="btnSendRequest" class="btn alt" style="width:100%;margin-top:10px">Enviar solicitud</button>
          <div id="rqMsg" class="muted" style="margin-top:8px"></div>
        </section>

        <!-- Portal del cliente -->
        <section class="card" id="clientPortal">
          <h2 style="margin:0 0 8px 0;font-size:16px">Mi préstamo</h2>
          <div class="row">
            <label>
              <div class="label">DNI</div>
              <input id="cpDni" class="input" placeholder="30123456" />
            </label>
            <label>
              <div class="label">Email</div>
              <input id="cpEmail" type="email" class="input" placeholder="tucorreo@dominio.com" />
            </label>
          </div>
          <button id="btnClientView" class="btn ghost" style="width:100%;margin-top:10px">Ver mi préstamo</button>
          <div id="clientLoanBox" class="hidden" style="margin-top:10px"></div>
        </section>

        <!-- Panel Admin -->
        <section id="adminPanel" class="hidden">
          <div class="card">
            <h2 style="margin:0 0 8px 0;font-size:16px">Tasa centralizada (TNA %)</h2>
            <div class="row">
              <label>
                <div class="label">TNA actual (%)</div>
                <input id="tnaInput" type="number" step="0.01" class="input" />
              </label>
              <div style="display:flex;align-items:end"><button id="btnSaveTna" class="btn" style="width:100%">Guardar</button></div>
            </div>
            <div class="muted" style="margin-top:6px">Impacta inmediato en el simulador. Los préstamos aprobados conservan la tasa al momento de aprobación.</div>
          </div>

          <div class="card">
            <h2 style="margin:0 0 8px 0;font-size:16px">Solicitudes</h2>
            <div id="requestsList" class="muted"></div>
          </div>

          <div class="card">
            <h2 style="margin:0 0 8px 0;font-size:16px">Préstamos</h2>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
              <input id="searchDni" class="input" placeholder="Buscar por DNI" />
              <button id="btnSearchLoans" class="btn ghost">Buscar</button>
            </div>

            <details open>
              <summary>Activos (agrupados por semáforo)</summary>
              <div id="loansListActive" class="muted"></div>
            </details>

            <details>
              <summary>Finalizados</summary>
              <div id="loansListFinished" class="muted"></div>
            </details>

            <details>
              <summary>Incobrables</summary>
              <div id="loansListCharged" class="muted"></div>
            </details>

            <div id="loanDetail" class="card hidden" style="margin-top:8px"></div>
          </div><!-- Clientes (resumen amigable) -->
          <div class="card">
            <h2 style="margin:0 0 8px 0;font-size:16px">Clientes</h2>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
              <input id="searchClient" class="input" placeholder="Buscar por nombre / DNI / email" />
              <button id="btnReloadClients" class="btn ghost">Actualizar</button>
            </div>
            <div style="overflow:auto">
              <table>
                <thead>
                  <tr>
                    <th>DNI</th><th>Nombre</th><th>Email</th><th>Teléfono</th>
                    <th>Activos</th><th>Inactivos</th>
                    <th>Pagadas</th><th>Pendientes</th>
                    <th>Restante (ARS)</th><th>Mora máx (d)</th><th></th>
                  </tr>
                </thead>
                <tbody id="clientsTable"></tbody>
              </table>
            </div>
          </div>
          <!-- /Clientes -->
        </section>
      </main>
    </div>
  </div>

  <!-- Login Admin -->
  <dialog id="loginDlg">
    <form method="dialog" style="background:#fff;border-radius:12px;padding:16px;min-width:300px">
      <h3 style="margin:0 0 10px 0">Ingreso Admin</h3>
      <label class="label">Email
        <input id="lgEmail" type="email" class="input" />
      </label>
      <label class="label" style="display:block;margin-top:8px">Password
        <input id="lgPass" type="password" class="input" />
      </label>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="btnLogin" type="button" class="btn">Ingresar</button>
        <button class="btn ghost">Cerrar</button>
      </div>
      <div id="lgMsg" class="muted err"></div>
    </form>
  </dialog>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <script>
  // ===== PWA (opcional) =====
  if('serviceWorker' in navigator){ window.addEventListener('load',()=> navigator.serviceWorker.register('/sw.js').catch(()=>{})); }

  // ===== Firebase =====
  const firebaseConfig={apiKey:"AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",authDomain:"estimapres.firebaseapp.com",projectId:"estimapres",storageBucket:"estimapres.appspot.com",messagingSenderId:"578516597437",appId:"1:578516597437:web:f59994b87729aa1cd655d4"};
  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth(); const db=firebase.firestore();

  // ===== Utils =====
  const $=s=>document.querySelector(s);
  const fmtARS=n=> new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n||0);
  const TNA_FALLBACK = 120;
  const pct=(x)=> (x*100).toFixed(2);
  const toAR = (iso)=> new Date(iso).toLocaleDateString('es-AR');
  function calcTEA(tna){ const r=(tna/100)/12; return ((1+r)**12 - 1)*100; }  // %

  async function sha256Hex(str){
    const buf = new TextEncoder().encode(str);
    const hash = await crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  function genOtp(){ return (''+Math.floor(100000 + Math.random()*900000)); } // 6 dígitos

  function frenchSchedule(principal, months, tna){
    const r=(tna/100)/12; if(r<=0||months<=0) return {installment:0,total:0,schedule:[]};
    const A= principal*r / (1-Math.pow(1+r,-months));
    let balance=principal; const schedule=[];
    for(let k=1;k<=months;k++){
      const interest=balance*r; const capital=A-interest; balance=Math.max(0,balance-capital);
      const due=new Date(); due.setMonth(due.getMonth()+k); due.setDate(10);
      schedule.push({k,installment:+A.toFixed(2),capital:+capital.toFixed(2),interest:+interest.toFixed(2),dueDate:due.toISOString(),paid:false});
    }
    return {installment:+A.toFixed(2), total:+(A*months).toFixed(2), schedule};
  }

  function computeTotals(schedule){
    const total=schedule.reduce((a,b)=>a+(b.installment||0),0);
    const pagado=schedule.filter(x=>x.paid).reduce((a,b)=>a+(b.installment||0),0);
    return {total,pagado,restante: total-pagado};
  }

  function loanStatusColor(schedule){
    const today=new Date(); let maxDelay=0;
    (schedule||[]).forEach(c=>{ if(!c.paid){ const due=new Date(c.dueDate); const diff=Math.floor((today-due)/(1000*60*60*24)); if(diff>maxDelay) maxDelay=diff; } });
    if(maxDelay<=5) return '🟢'; if(maxDelay<=10) return '🟡'; return '🔴';
  }
  function statusKey(s){return s==='🟢'?'green':s==='🟡'?'yellow':'red';}
  function colorEmoji(k){return k==='green'?'🟢':k==='yellow'?'🟡':'🔴';}
  function colorTitle(k){return k==='green'?'Al día':k==='yellow'?'Mora 6–10 días':'Mora >10 días';}

  // ===== TNA realtime =====
  const tnaSpan=$('#tnaSpan'); const tnaInput=$('#tnaInput');
  db.doc('settings/global').onSnapshot(doc=>{
    const tna = doc.data()?.tna ?? TNA_FALLBACK; tnaSpan.textContent=tna; if(tnaInput) tnaInput.value=tna;
  }, _=>{ tnaSpan.textContent=TNA_FALLBACK; if(tnaInput) tnaInput.value=TNA_FALLBACK; });

  // ===== Simular =====
  $('#btnSimulate').addEventListener('click', async ()=>{
    const amount=+$('#simAmount').value; const months=+$('#simMonths').value;
    if(!amount||!months) return alert('Completá monto y cuotas');
    let tna=TNA_FALLBACK; try{ const d=await db.doc('settings/global').get(); tna=d.data()?.tna??TNA_FALLBACK; }catch(e){}
    const {installment, schedule}=frenchSchedule(amount,months,tna);
    $('#rMonto').textContent=fmtARS(amount); $('#rCuotas').textContent=months; $('#rCuota').textContent=installment?fmtARS(installment):'—';
    const tbody=$('#tablaCuotas'); tbody.innerHTML='';
    schedule.forEach(it=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.k}</td><td>${toAR(it.dueDate)}</td><td>${fmtARS(it.installment)}</td>`; tbody.appendChild(tr); });
    $('#tablaCuotasWrap').classList.remove('hidden');
  });

  // ===== Enviar solicitud =====
  $('#btnSendRequest').addEventListener('click', async ()=>{
    const name=$('#rqName').value.trim(), dni=$('#rqDni').value.trim(), email=$('#rqEmail').value.trim(), phone=$('#rqPhone').value.trim();
    const bankDest=$('#rqAccount').value.trim();
    const amount=+$('#simAmount').value, months=+$('#simMonths').value; const msg=$('#rqMsg'); msg.textContent='';
    if(!name||!dni||!email||!amount||!months){ msg.textContent='Completá datos y simulación.'; msg.className='muted err'; return; }
    let tna=TNA_FALLBACK; try{ const d=await db.doc('settings/global').get(); tna=d.data()?.tna??TNA_FALLBACK; }catch(e){}
    const {installment}=frenchSchedule(amount,months,tna);
    try{
      await db.collection('loan_requests').add({name,dni,email,phone,bankDest,amount,months,tnaSnapshot:tna,installment,status:'pending',createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      msg.textContent='Solicitud enviada. Un admin la revisará.'; msg.className='muted ok';
    }catch(e){ msg.textContent='No se pudo enviar: '+(e.message||e); msg.className='muted err'; }
  });

  // ===== Admin auth =====
  const loginDlg=$('#loginDlg');
  $('#btnShowLogin').addEventListener('click',()=>loginDlg.showModal());
  $('#btnLogin').addEventListener('click', async ()=>{ $('#lgMsg').textContent=''; try{ await auth.signInWithEmailAndPassword($('#lgEmail').value,$('#lgPass').value); loginDlg.close(); }catch(e){ $('#lgMsg').textContent=e.message; } });
  $('#btnLogout').addEventListener('click',()=> auth.signOut().then(()=>location.reload()));

  auth.onAuthStateChanged(user=>{
    const adminPanel=$('#adminPanel'); const authStatus=$('#authStatus'); const btnLogout=$('#btnLogout');
    if(user){ adminPanel.classList.remove('hidden'); authStatus.textContent='Admin'; btnLogout.classList.remove('hidden'); mountAdminData(); }
    else { adminPanel.classList.add('hidden'); authStatus.textContent='No admin'; btnLogout.classList.add('hidden'); }
  });

  // ===== Admin data =====
  function renderRequest(id,r){
    const div=document.createElement('div');
    div.style.cssText='display:flex;justify-content:space-between;align-items:center;border:1px solid #e2e8f0;border-radius:10px;padding:8px;margin:6px 0;';
    div.innerHTML=`<div>
      <div style="font-weight:700">${r.name} · DNI ${r.dni}</div>
      <div class="muted">${fmtARS(r.amount)} · ${r.months} cuotas · TNA ${r.tnaSnapshot}% · Cuota ${fmtARS(r.installment)}</div>
      <div class="muted">${r.email}${r.phone? ' · '+r.phone:''}</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button data-approve="${id}" class="btn" style="padding:8px 10px">Aprobar</button>
      <button data-reject="${id}" class="btn danger" style="padding:8px 10px">Rechazar</button>
    </div>`;
    return div;
  }

  async function approveRequest(id,r){
    const {schedule}=frenchSchedule(r.amount,r.months,r.tnaSnapshot);
    const loan={
      borrower:{name:r.name,dni:r.dni,email:r.email,phone:r.phone||'', bankDest:r.bankDest||''},
      principal:r.amount, months:r.months, tna:r.tnaSnapshot,
      status:'active', schedule,
      disbursed:false,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    };

    const batch=db.batch();
    const loanRef=db.collection('loans').doc();
    batch.set(loanRef,loan);
    batch.update(db.collection('loan_requests').doc(id),{status:'approved',approvedLoanId:loanRef.id,decidedAt:firebase.firestore.FieldValue.serverTimestamp()});

    // doc público (sanitizado) para portal de cliente
    const pubRef=db.collection('public_loans').doc();
    batch.set(pubRef,{
      loanId: loanRef.id,
      borrower:{dni:r.dni,email:r.email,name:r.name},
      principal:r.amount, months:r.months, tna:r.tnaSnapshot,
      status:'active', disbursed:false, accepted:false,
      schedule: schedule.map(c=>({k:c.k,dueDate:c.dueDate,installment:c.installment,paid:c.paid})),
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });

    await batch.commit();
    alert('Préstamo aprobado'); loadLoans(); loadClients();
  }
  async function rejectRequest(id){ await db.collection('loan_requests').doc(id).update({status:'rejected',decidedAt:firebase.firestore.FieldValue.serverTimestamp()}); }

  function renderLoanRow(it,loanId){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.k}</td>
      <td>${toAR(it.dueDate)}</td>
      <td>${fmtARS(it.installment)}</td>
      <td>${fmtARS(it.capital)}</td>
      <td>${fmtARS(it.interest)}</td>
      <td><label style="display:inline-flex;gap:6px;align-items:center"><input type="checkbox" data-loan="${loanId}" data-k="${it.k}" ${it.paid?'checked':''} /><span>${it.paid?'Pagada':'Pendiente'}</span></label></td>`;
    return tr;
  }

  // ===== PDF contrato =====
  function generateContractPdf(loanId, L){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'pt', format:'a4', compress:true});
    let y = 40;

    const TEA = calcTEA(L.tna); const CFT = TEA; // aproximación si no hay gastos extra

    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text('CONTRATO DE MUTUO — EstimaPres', 40, y); y+=18;
    doc.setFont('helvetica',''); doc.setFontSize(10);

    [
      `Prestatario: ${L.borrower.name} (DNI ${L.borrower.dni}) — Email ${L.borrower.email}`,
      `Capital: ${fmtARS(L.principal)} — Plazo: ${L.months} meses (francés)`,
      `TNA: ${L.tna}% — TEA aprox: ${pct(TEA/100)}% — CFT estimado: ${pct(CFT/100)}%`,
      `1er vencimiento: ${toAR(L.schedule[0].dueDate)} — Vencimientos: día 10`,
      `Aceptación electrónica por OTP`
    ].forEach(t=>{ doc.text(t, 40, y); y+=14; });

    y+=6; doc.setFont('helvetica','bold'); doc.text('Anexo — Cronograma', 40, y); y+=6;
    const rows = (L.schedule||[]).map(c=>[
      c.k, toAR(c.dueDate), fmtARS(c.installment), fmtARS(c.capital), fmtARS(c.interest), c.paid?'Pagada':'Pendiente'
    ]);

    doc.autoTable({startY:y, head:[['#','Vencimiento','Cuota','Capital','Interés','Estado']], body:rows, styles:{fontSize:9,cellPadding:3}, headStyles:{fillColor:[10,47,115]}});
    const y2 = doc.lastAutoTable.finalY||y;
    doc.setFont('helvetica',''); doc.text('La aceptación por OTP queda registrada en EstimaPres.', 40, y2+24);

    doc.save(`Contrato_EstimaPres_${loanId}.pdf`);
  }

  // ===== OTP (admin genera / cliente firma) =====
  async function startOtpForLoan(loanId, L){
    const q = await db.collection('public_loans').where('loanId','==',loanId).limit(1).get();
    if(q.empty){ alert('No hay doc público. Aprobá el préstamo primero.'); return; }
    const ref = q.docs[0].ref;
    const code = genOtp();
    const otpHash = await sha256Hex(code);
    const exp = Date.now() + 15*60*1000;
    await ref.set({ otpHash, otpExp: exp, accepted:false }, {merge:true});
    const texto = `Hola ${L.borrower.name}, tu código OTP para firmar el contrato es: ${code} (vence en 15 min).`;
    const wa = `https://wa.me/?text=${encodeURIComponent(texto)}`;
    if(confirm(`OTP generado: ${code}\n\n¿Abrir WhatsApp para enviar?`)){ window.open(wa,'_blank'); }
  }

  async function reflectPublicSchedule(loanId, schedule){
    const q=await db.collection('public_loans').where('loanId','==',loanId).limit(1).get();
    if(!q.empty){
      await q.docs[0].ref.update({schedule: schedule.map(c=>({k:c.k,dueDate:c.dueDate,installment:c.installment,paid:c.paid}))});
    }
  }function renderLoanDetail(loanId,L){
    const box=$('#loanDetail'); box.classList.remove('hidden');

    const head=`<div style="font-weight:700">${loanStatusColor(L.schedule||[])} ${L.borrower.name} · DNI ${L.borrower.dni} · Estado: ${L.status}</div>
      <div class="muted">Principal ${fmtARS(L.principal)} · ${L.months} cuotas · TNA ${L.tna}%</div>`;

    const {total,pagado,restante}=computeTotals(L.schedule||[]);
    const tot=`<div class="muted" style="margin:6px 0 10px 0">Total préstamo: ${fmtARS(total)} · Pagado: ${fmtARS(pagado)} · Restante: ${fmtARS(restante)}</div>`;

    const table=`<div style="overflow:auto"><table>
      <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Capital</th><th>Interés</th><th>Estado</th></tr></thead>
      <tbody id="loanRows"></tbody></table></div>`;

    const acreditBtn = (!L.disbursed && L.status==='active') ? `<button id="btnAcreditar" class="btn">Acreditar (depositar)</button>` : '';
    const actions = `<div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="btnContratoPdf" class="btn ghost">Contrato (PDF)</button>
      <button id="btnOtpStart" class="btn ghost">Iniciar firma OTP</button>
      ${acreditBtn}
      ${L.status==='active' ? '<button id="btnMarkChargedOff" class="btn danger">Marcar incobrable</button>' : ''}
      ${L.status==='active' ? '<button id="btnMarkInactive" class="btn ghost">Marcar como inactivo</button>' : ''}
    </div>`;

    box.innerHTML = head + tot + table + actions;

    // Render filas + toggle pago
    const tbody=box.querySelector('#loanRows'); tbody.innerHTML='';
    (L.schedule||[]).forEach(it=> tbody.appendChild(renderLoanRow(it,loanId)) );

    tbody.querySelectorAll('input[type="checkbox"]').forEach(chk=>{
      chk.onchange = async ()=>{
        const k=+chk.getAttribute('data-k'); const ref=db.collection('loans').doc(loanId);
        const snap=await ref.get(); const C=snap.data();
        const schedule=C.schedule.map(x=> x.k===k ? ({...x,paid:chk.checked,paidAt: chk.checked? new Date().toISOString(): null}) : x);
        await ref.update({schedule});
        const t=computeTotals(schedule);
        box.querySelectorAll('.muted')[1].textContent = `Total préstamo: ${fmtARS(t.total)} · Pagado: ${fmtARS(t.pagado)} · Restante: ${fmtARS(t.restante)}`;
        chk.nextElementSibling.textContent = chk.checked? 'Pagada' : 'Pendiente';
        await reflectPublicSchedule(loanId, schedule);
        loadClients();
      };
    });

    // Acciones
    document.getElementById('btnContratoPdf').onclick = ()=> generateContractPdf(loanId, L);
    document.getElementById('btnOtpStart').onclick   = ()=> startOtpForLoan(loanId, L);

    // Acreditación
    const btnAcred = box.querySelector('#btnAcreditar');
    if(btnAcred){
      btnAcred.onclick = async ()=>{
        const method = prompt('Método (MP, transferencia, etc.)','transferencia');
        const dest = L.borrower?.bankDest || prompt('Destino (CBU/CVU/alias)','');
        const refOp = prompt('Nº de operación / referencia','');
        await db.collection('loans').doc(loanId).update({
          disbursed:true, disbursedAt:firebase.firestore.FieldValue.serverTimestamp(),
          disbursement:{method,dest,ref:refOp}
        });
        const q=await db.collection('public_loans').where('loanId','==',loanId).limit(1).get();
        if(!q.empty){ await q.docs[0].ref.update({disbursed:true,disbursedAt:firebase.firestore.FieldValue.serverTimestamp()}); }
        alert('Acreditación registrada'); loadLoans();
      };
    }

    if(L.status==='active'){
      // Inactivar
      box.querySelector('#btnMarkInactive').onclick = async ()=>{
        await db.collection('loans').doc(loanId).update({status:'inactive',inactivatedAt:firebase.firestore.FieldValue.serverTimestamp()});
        const q=await db.collection('public_loans').where('loanId','==',loanId).limit(1).get();
        if(!q.empty){ await q.docs[0].ref.update({status:'inactive'}); }
        alert('Préstamo marcado como inactivo'); loadLoans(); loadClients(); box.classList.add('hidden');
      };
      // Incobrable
      box.querySelector('#btnMarkChargedOff').onclick = async ()=>{
        if(!confirm('¿Mover a INCobrables? No elimina el préstamo; lo saca de Activos.')) return;
        await db.collection('loans').doc(loanId).update({status:'charged_off',chargedAt:firebase.firestore.FieldValue.serverTimestamp()});
        const q=await db.collection('public_loans').where('loanId','==',loanId).limit(1).get();
        if(!q.empty){ await q.docs[0].ref.update({status:'charged_off'}); }
        alert('Préstamo marcado como INCobrable'); loadLoans(); loadClients(); box.classList.add('hidden');
      };
    }
  }

  // ===== Listas: activos / finalizados / incobrables =====
  async function deleteLoan(loanId){
    if(!confirm('¿Eliminar definitivamente el préstamo y su copia pública?')) return;
    // borrar public
    const q=await db.collection('public_loans').where('loanId','==',loanId).get();
    const batch=db.batch();
    q.forEach(d=> batch.delete(d.ref));
    batch.delete(db.collection('loans').doc(loanId));
    await batch.commit();
    alert('Eliminado');
    loadLoans(); loadClients();
    $('#loanDetail').classList.add('hidden'); $('#loanDetail').innerHTML='';
  }

  async function loadLoans(){
    const boxA=$('#loansListActive');
    const boxF=$('#loansListFinished');
    const boxC=$('#loansListCharged');
    const detail=$('#loanDetail');

    boxA.innerHTML='Cargando…'; boxF.innerHTML=''; boxC.innerHTML='';
    detail.classList.add('hidden'); detail.innerHTML='';

    const snap=await db.collection('loans').orderBy('createdAt','desc').get();
    const groups={green:[],yellow:[],red:[]};

    snap.docs.forEach(doc=>{
      const L=doc.data();
      if(L.status==='active'){
        const k=statusKey(loanStatusColor(L.schedule||[])); groups[k].push({id:doc.id,L});
      } else if(L.status==='charged_off'){
        const item=document.createElement('div'); item.className='card';
        item.innerHTML=`<div style="font-weight:700">🟥 ${L.borrower.name} · DNI ${L.borrower.dni}</div>
          <div class="muted">Incobrable · Principal ${fmtARS(L.principal)} · ${L.months} cuotas · TNA ${L.tna}%</div>
          <div style="display:flex;gap:8px"><button class="btn ghost" data-open="${doc.id}">Ver</button><button class="btn danger" data-del="${doc.id}">Eliminar</button></div>`;
        boxC.appendChild(item);
      } else { // inactive = finalizado
        const item=document.createElement('div'); item.className='card';
        item.innerHTML=`<div style="font-weight:700">🟦 ${L.borrower.name} · DNI ${L.borrower.dni}</div>
          <div class="muted">Finalizado · Principal ${fmtARS(L.principal)} · ${L.months} cuotas · TNA ${L.tna}%</div>
          <div style="display:flex;gap:8px"><button class="btn ghost" data-open="${doc.id}">Ver</button><button class="btn danger" data-del="${doc.id}">Eliminar</button></div>`;
        boxF.appendChild(item);
      }
    });

    boxA.innerHTML='';
    ['green','yellow','red'].forEach(k=>{
      const arr=groups[k]; if(!arr.length) return;
      const sec=document.createElement('div');
      sec.innerHTML=`<div style="font-weight:700;margin:6px 0">${colorEmoji(k)} ${colorTitle(k)}</div>`;
      arr.forEach(({id,L})=>{
        const item=document.createElement('div'); item.className='card';
        item.innerHTML=`<div style="font-weight:700">${colorEmoji(k)} ${L.borrower.name} · DNI ${L.borrower.dni}</div>
          <div class="muted">Principal ${fmtARS(L.principal)} · ${L.months} cuotas · TNA ${L.tna}%</div>
          <div><button class="btn ghost" data-open="${id}">Ver</button></div>`;
        sec.appendChild(item);
      });
      boxA.appendChild(sec);
    });

    if(!boxA.innerHTML) boxA.textContent='Sin préstamos activos';
    if(!boxF.innerHTML) boxF.textContent='Sin finalizados';
    if(!boxC.innerHTML) boxC.textContent='Sin incobrables';

    // abrir detalle y eliminar
    document.querySelectorAll('[data-open]').forEach(btn=>{
      btn.onclick = async ()=>{ const id=btn.getAttribute('data-open'); const d=await db.collection('loans').doc(id).get(); renderLoanDetail(id,d.data()); };
    });
    document.querySelectorAll('[data-del]').forEach(btn=>{
      btn.onclick = ()=> deleteLoan(btn.getAttribute('data-del'));
    });
  }

  // ===== Clientes (resumen) =====
  function maxMoraDias(schedule){
    let md=0, today=new Date();
    (schedule||[]).forEach(c=>{
      if(!c.paid){
        const dd=Math.floor((today - new Date(c.dueDate))/86400000);
        if(dd>md) md=dd;
      }
    });
    return Math.max(0, md);
  }

  async function loadClients(){
    const tbody = document.getElementById('clientsTable');
    if(!tbody) return;
    tbody.innerHTML = '<tr><td colspan="11">Cargando…</td></tr>';

    const snap = await db.collection('loans').get();
    const map = new Map();

    snap.docs.forEach(doc=>{
      const L = doc.data(), s=L.schedule||[];
      const key = L.borrower?.dni || 'sin_dni';
      const e = map.get(key) || {
        dni: key, name: L.borrower?.name||'', email: L.borrower?.email||'',
        phone: L.borrower?.phone||'', activos:0, inactivos:0,
        pagadas:0, pendientes:0, restante:0, moraMax:0
      };
      if (L.status==='active') e.activos++; else e.inactivos++;
      e.pagadas    += s.filter(x=>x.paid).length;
      e.pendientes += s.filter(x=>!x.paid).length;
      const t = computeTotals(s);
      e.restante   += t.restante||0;
      e.moraMax     = Math.max(e.moraMax, maxMoraDias(s));
      e.name   = e.name   || L.borrower?.name   || '';
      e.email  = e.email  || L.borrower?.email  || '';
      e.phone  = e.phone  || L.borrower?.phone  || '';
      map.set(key, e);
    });

    const rows = [...map.values()].sort((a,b)=> a.name.localeCompare(b.name));
    tbody.innerHTML='';
    rows.forEach(c=>{
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td>${c.dni}</td><td>${c.name}</td><td>${c.email}</td><td>${c.phone}</td>
         <td>${c.activos}</td><td>${c.inactivos}</td>
         <td>${c.pagadas}</td><td>${c.pendientes}</td>
         <td>${fmtARS(c.restante)}</td><td>${c.moraMax}</td>
         <td><button class="btn ghost" data-open-dni="${c.dni}">Ver</button></td>`;
      tbody.appendChild(tr);
    });

    // Ver último préstamo del DNI
    tbody.querySelectorAll('[data-open-dni]').forEach(btn=>{
      btn.onclick = async ()=>{
        const dni = btn.getAttribute('data-open-dni');
        const q = await db.collection('loans')
          .where('borrower.dni','==',dni)
          .orderBy('createdAt','desc').get();
        if (!q.empty){ const d=q.docs[0]; renderLoanDetail(d.id,d.data()); }
      };
    });

    // Filtro en vivo
    const inputClient = document.getElementById('searchClient');
    if (inputClient){
      inputClient.oninput = function(){
        const q = this.value.toLowerCase();
        document.querySelectorAll('#clientsTable tr').forEach(tr=>{
          tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
        });
      };
    }
  }

  // ===== Portal del cliente =====
  function renderClientLoan(container, pub){
    const {borrower,principal,months,tna,schedule,status,accepted,signedAt} = pub;
    const {total,pagado,restante}=computeTotals(schedule);
    container.classList.remove('hidden');
    container.innerHTML = `
      <div style="font-weight:700">${borrower.name||''} · DNI ${borrower.dni} · Estado: ${status}</div>
      <div class="muted">Capital ${fmtARS(principal)} · ${months} cuotas · TNA ${tna}%</div>
      <div class="muted" style="margin:6px 0 10px 0">Total: ${fmtARS(total)} · Pagado: ${fmtARS(pagado)} · Restante: ${fmtARS(restante)}</div>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead>
          <tbody>${schedule.map(c=>`
            <tr>
              <td>${c.k}</td>
              <td>${toAR(c.dueDate)}</td>
              <td>${fmtARS(c.installment)}</td>
              <td>${c.paid?'Pagada':'Pendiente'}</td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>
      <div style="margin-top:10px">
        ${accepted ? `<div class="ok">Contrato aceptado${signedAt? ' el '+(signedAt?.toDate?.()? signedAt.toDate().toLocaleString('es-AR'): new Date(signedAt).toLocaleString('es-AR')):''}</div>`
                   : `<label class="label">Ingresá tu código OTP para firmar
                        <input id="otpInput" class="input" placeholder="6 dígitos" />
                      </label>
                      <button id="btnFirmarOtp" class="btn" style="margin-top:8px">Firmar con OTP</button>`}
      </div>
      ${accepted ? `<button id="btnDescargarContrato" class="btn ghost" style="margin-top:8px">Descargar contrato (PDF)</button>` : '' }
    `;
    if(!accepted){
      document.getElementById('btnFirmarOtp').onclick = ()=> clientAcceptByOtp(pub);
    }else{
      document.getElementById('btnDescargarContrato').onclick = ()=> downloadClientContract(pub);
    }
  }

  async function clientAcceptByOtp(pub){
    const box = document.getElementById('clientLoanBox');
    const code = (document.getElementById('otpInput').value||'').trim();
    if(code.length!==6) return alert('Código inválido');
    const hash = await sha256Hex(code);
    const snap = await db.collection('public_loans').where('loanId','==',pub.loanId).limit(1).get();
    if(snap.empty){ alert('No encontrado'); return; }
    const ref = snap.docs[0].ref; const data = snap.docs[0].data();
    if(!data.otpHash || !data.otpExp) return alert('OTP no iniciado. Pedí un nuevo código.');
    if(Date.now() > data.otpExp)    return alert('OTP vencido. Pedí uno nuevo.');
    if(hash !== data.otpHash)       return alert('Código incorrecto.');
    await ref.update({ accepted:true, signedAt: firebase.firestore.FieldValue.serverTimestamp() });
    box.innerHTML = '<div class="ok">¡Contrato firmado! Actualizá para ver el PDF.</div>';
  }

  async function downloadClientContract(pub){
    const d = await db.collection('loans').doc(pub.loanId).get();
    if(!d.exists){ return alert('No se encontró el préstamo completo.'); }
    generateContractPdf(pub.loanId, d.data());
  }

  document.getElementById('btnClientView')?.addEventListener('click', async ()=>{
    const dni = ($('#cpDni').value||'').trim();
    const email = ($('#cpEmail').value||'').trim().toLowerCase();
    if(!dni || !email) return alert('Completá DNI y email');
    const snap = await db.collection('public_loans')
      .where('borrower.dni','==',dni)
      .where('borrower.email','==',email)
      .orderBy('createdAt','desc').limit(1).get();
    const box = document.getElementById('clientLoanBox');
    if(snap.empty){ box.classList.remove('hidden'); box.innerHTML='<div class="muted err">No se encontró un préstamo con esos datos.</div>'; return; }
    const pub = snap.docs[0].data(); renderClientLoan(box, pub);
  });

  function mountAdminData(){
    // Solicitudes pendientes
    db.collection('loan_requests').orderBy('createdAt','desc').onSnapshot(snap=>{
      const box=$('#requestsList'); box.innerHTML='';
      snap.docs.forEach(d=>{ const r=d.data(); if(r.status==='pending') box.appendChild(renderRequest(d.id,r)); });
      if(!box.innerHTML) box.textContent='Sin solicitudes pendientes';
      box.querySelectorAll('[data-approve]').forEach(b=>{ b.onclick=async()=>{ const id=b.getAttribute('data-approve'); const doc=await db.collection('loan_requests').doc(id).get(); await approveRequest(id,doc.data()); }; });
      box.querySelectorAll('[data-reject]').forEach(b=> b.onclick=()=>rejectRequest(b.getAttribute('data-reject')));
    });

    // Buscar por DNI (detalle directo)
    $('#btnSearchLoans').onclick = async ()=>{
      const dni=$('#searchDni').value.trim(); if(!dni) return;
      const snap=await db.collection('loans').where('borrower.dni','==',dni).get();
      if(snap.empty){ alert('Sin resultados'); return; }
      const doc=snap.docs[0]; renderLoanDetail(doc.id, doc.data());
    };

    loadLoans();
    loadClients();
  }

  // ===== Guardar TNA =====
  $('#btnSaveTna').addEventListener('click', async ()=>{
    const tna=+$('#tnaInput').value; if(isNaN(tna)||tna<0) return alert('TNA inválida');
    await db.doc('settings/global').set({tna,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
    alert('TNA actualizada');
  });
  </script>
</body>
</html>