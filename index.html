<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EstimaPres ¬∑ Pr√©stamos en ARS</title>
  <meta name="theme-color" content="#0b3b64" />
  <link rel="manifest" href="/manifest.json" />
  <style>
    :root{
      --brand:#0b3b64;--brand-2:#0e4f88;--bg:#f5f7fb;--card:#ffffff;--muted:#7a8797;
      --ok:#16a34a;--warn:#f59e0b;--danger:#dc2626;--ink:#0f172a;--soft:#e9eef6;
      --radius:16px;
    }
    *{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",Arial,"Apple Color Emoji","Segoe UI Emoji"}
    a{color:var(--brand-2);text-decoration:none}
    .app{max-width:980px;margin:0 auto;padding:16px}
    .nav{background:var(--brand);color:#fff;border-radius:14px;padding:14px 16px;display:flex;align-items:center;gap:12px;justify-content:space-between;margin:8px 0 18px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:36px;height:36px;border-radius:10px;background:#e8f1ff;color:var(--brand);display:grid;place-items:center;font-weight:800}
    .nav .actions{display:flex;gap:10px}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;background:var(--brand-2);color:#fff;font-weight:600;cursor:pointer}
    .btn.secondary{background:#1f2937}
    .btn.ghost{background:#ffffff1a;border:1px solid #ffffff33}
    .btn.warn{background:var(--warn)} .btn.ok{background:var(--ok)} .btn.danger{background:var(--danger)}
    .btn.sm{padding:8px 12px;border-radius:10px;font-size:.95rem}
    .grid{display:grid;gap:14px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 20px rgba(14,33,61,.06);padding:18px}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .field{display:grid;gap:6px}
    .label{font-size:.95rem;color:var(--muted)}
    .input{width:100%;padding:14px 12px;border-radius:12px;background:#fff;border:1px solid #dde5f1;outline:none}
    .input:focus{border-color:#98b9ff;box-shadow:0 0 0 4px #98b9ff33}
    .muted{color:var(--muted)} .right{display:flex;justify-content:flex-end}
    details.panel{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 20px rgba(14,33,61,.06)}
    details.panel>summary{cursor:pointer;list-style:none;padding:18px 18px;font-weight:800}
    details.panel[open] > summary{border-bottom:1px solid #eef2f7}
    .panel .content{padding:16px 18px}
    .hint{font-size:.9rem;color:var(--muted);margin-top:8px}
    .badge{display:inline-block;font-weight:700;border-radius:999px;padding:4px 10px;font-size:.8rem}
    .b-green{background:#dcfce7;color:#166534}.b-yellow{background:#fef9c3;color:#854d0e}.b-red{background:#fee2e2;color:#991b1b}
    .row{display:grid;gap:10px}
    .row.cols-2{grid-template-columns:1fr auto}
    .loan{border:1px solid #edf2f7;border-radius:14px;padding:14px;margin:10px 0;background:#fff}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid #eef2f7;font-size:.95rem;text-align:right}
    th:first-child,td:first-child{text-align:left}
    .sticky-actions{position:sticky;bottom:10px;display:flex;gap:10px;justify-content:flex-end}
    .center{display:grid;place-items:center}
    dialog{border:none;border-radius:18px;max-width:560px;width:92%}
    dialog::backdrop{background:rgba(15,23,42,.35)}
    @media (max-width:860px){ .split{grid-template-columns:1fr} .nav{border-radius:0} .sticky-actions{bottom:0} }
  </style>
</head>
<body>
  <div class="app">
    <nav class="nav">
      <div class="brand">
        <div class="logo">E</div>
        <div><strong>EstimaPres</strong></div>
      </div>
      <div class="actions">
        <button class="btn ghost sm" id="btnMyLoan">Ver mi pr√©stamo</button>
        <button class="btn ghost sm" id="btnAdmin">Admin</button>
        <button class="btn secondary sm" id="btnLogout" style="display:none">Salir</button>
      </div>
    </nav>

    <!-- SIMULADOR -->
    <section class="card grid" id="simulator">
      <h2>Simulador (pesos argentinos)</h2>
      <div class="split">
        <div class="field">
          <label class="label">Monto (ARS)</label>
          <input id="simAmount" class="input" type="number" placeholder="Ej: 200000" min="1">
        </div>
        <div class="field">
          <label class="label">Cuotas (meses)</label>
          <input id="simMonths" class="input" type="number" placeholder="Ej: 12" min="1">
        </div>
      </div>
      <div class="muted" id="simInfo">TNA vigente: ‚Äî% ¬∑ Vencimiento: d√≠a 10</div>
      <div class="right"><button class="btn" id="btnSim">Simular</button></div>
      <div id="simResult" class="hint">Resultado</div>
    </section>

    <!-- SOLICITUD -->
    <section class="card grid">
      <h2>Solicitar pr√©stamo</h2>
      <div class="split">
        <div class="field"><label class="label">Nombre y apellido</label><input id="fName" class="input" placeholder="Tu nombre"></div>
        <div class="field"><label class="label">DNI</label><input id="fDni" class="input" placeholder="30123456" inputmode="numeric"></div>
      </div>
      <div class="split">
        <div class="field"><label class="label">Email</label><input id="fEmail" class="input" placeholder="tucorreo@dominio.com" type="email"></div>
        <div class="field"><label class="label">Celular</label><input id="fPhone" class="input" placeholder="11 2345 6789" inputmode="tel"></div>
      </div>
      <div class="field"><label class="label">CBU / CVU o Alias (dep√≥sito)</label><input id="fCbu" class="input" placeholder="alias o CBU/CVU"></div>
      <div class="right"><button class="btn" id="btnRequest">Enviar solicitud</button></div>
      <div class="hint">Debes completar todos los campos para solicitar. El administrador revisar√° tu solicitud en <strong>&lt;48 hs</strong>.</div>
    </section>

    <!-- ADMIN -->
    <section class="grid" id="adminPanel" style="display:none">
      <h2>Panel de administrador</h2>

      <details class="panel" open>
        <summary>1) Tasa centralizada (TNA %)</summary>
        <div class="content grid">
          <div class="field"><label class="label">TNA actual (%)</label><input id="cfgTna" class="input" type="number" step="0.01"></div>
          <div><button class="btn" id="btnSaveTna">Guardar</button></div>
          <div class="hint">Impacta en el simulador; cada pr√©stamo conserva su TNA al aprobar.</div>
        </div>
      </details>

      <details class="panel">
        <summary>2) Solicitudes pendientes</summary>
        <div class="content" id="pendingList">Cargando‚Ä¶</div>
      </details>

      <details class="panel">
        <summary>3) Preaprobados (Contrato / Firma OTP / Dep√≥sito)</summary>
        <div class="content" id="preList">Cargando‚Ä¶</div>
      </details>

      <details class="panel" open>
        <summary>4) Pr√©stamos activos (agrupados por sem√°foro)</summary>
        <div class="content">
          <div class="hint">Verde: al d√≠a ¬∑ Amarillo: 6‚Äì10 d√≠as mora ¬∑ Rojo: &gt;10 d√≠as mora</div>
          <div id="activeList" style="margin-top:8px">Cargando‚Ä¶</div>
        </div>
      </details>

      <details class="panel">
        <summary>5) Inactivos (finalizados / incobrables)</summary>
        <div class="content grid">
          <h3 style="margin:0">Finalizados (pagados)</h3>
          <div id="finList">Cargando‚Ä¶</div>
          <h3 style="margin:10px 0 0">Incobrables</h3>
          <div id="badList">Cargando‚Ä¶</div>
        </div>
      </details>
    </section>

    <!-- MODAL: Ver mi pr√©stamo (DNI + OTP) -->
    <dialog id="dlgMyLoan">
      <form method="dialog" class="grid" id="formMyLoan">
        <h3>Ver mi pr√©stamo</h3>
        <div class="field"><label class="label">DNI</label><input id="mlDni" class="input" inputmode="numeric" required></div>
        <div class="field"><label class="label">C√≥digo de firma (OTP de 6 d√≠gitos)</label><input id="mlOtp" class="input" inputmode="numeric" maxlength="6" required></div>
        <div class="right" style="gap:8px">
          <button class="btn ghost" value="cancel">Cerrar</button>
          <button class="btn" id="btnOpenMyLoan" value="default">Abrir</button>
        </div>
        <div id="mlContent" class="grid"></div>
      </form>
    </dialog>

    <!-- MODAL: Detalle de pr√©stamo (admin) -->
    <dialog id="dlgLoan">
      <div class="grid" style="max-height:80dvh;overflow:auto">
        <div class="row cols-2">
          <h3 id="dlgTitle">Pr√©stamo</h3>
          <button class="btn ghost sm" id="btnCloseLoan">Cerrar</button>
        </div>
        <div id="dlgBody"></div>
      </div>
    </dialog><!-- Firebase SDK (compat para simplicidad) -->
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>

    <script>
      // ======= CONFIG =======
      // üëá Rellena con tu configuraci√≥n real de Firebase
      const firebaseConfig = {
        apiKey: "TU_API_KEY",
        authDomain: "TU_AUTH_DOMAIN",
        projectId: "TU_PROJECT_ID",
        storageBucket: "TU_STORAGE_BUCKET",
        messagingSenderId: "TU_SENDER_ID",
        appId: "TU_APP_ID"
      };
      // Admin permitido (fallback). Tambi√©n se puede tener en Firestore (config/admins)
      const ALLOWED_ADMIN_EMAILS = ["fernandogastondelgado81@gmail.com"];

      // ======= INIT =======
      let app, auth, db, settings = { tna: 100, dueDay: 10 };
      try{
        app = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth(); db = firebase.firestore();
      }catch(e){ alert("Error inicializando la app: "+e); }

      // ======= HELPERS =======
      const $ = sel => document.querySelector(sel);
      const money = n => n.toLocaleString('es-AR',{style:'currency', currency:'ARS', maximumFractionDigits:0});
      const fmt = d => new Date(d.seconds?d.seconds*1000:d).toLocaleDateString('es-AR');
      const sv = firebase.firestore.FieldValue;

      const nextDueFrom = (baseDate, dueDay=10) => {
        const d = new Date(baseDate||Date.now());
        d.setHours(0,0,0,0);
        const first = new Date(d.getFullYear(), d.getMonth(), dueDay);
        return d <= first ? first : new Date(d.getFullYear(), d.getMonth()+1, dueDay);
      };

      const calcFrench = (principal, months, tna, firstDueDate) => {
        const r = (tna/100)/12;
        const pmt = r===0 ? principal/months : principal * (r/(1-Math.pow(1+r,-months)));
        let balance = principal, schedule=[];
        let due = new Date(firstDueDate);
        for(let i=1;i<=months;i++){
          const interest = Math.round(balance*r);
          const capital = Math.round(pmt - interest);
          balance = Math.max(0, balance - capital);
          schedule.push({n:i, dueAt:sv.serverTimestamp(), dueMs:due.getTime(), amount:Math.round(pmt), interest, capital, paid:false});
          // siguiente mes mismo d√≠a:
          due = new Date(due.getFullYear(), due.getMonth()+1, due.getDate());
        }
        return {pmt:Math.round(pmt), schedule};
      };

      const dotByLoan = (loan)=>{
        // sem√°foro por d√≠as de mora del primer vencimiento impago
        const today = new Date(); today.setHours(0,0,0,0);
        const nextUnpaid = loan.schedule?.find(i=>!i.paid);
        if(!nextUnpaid) return 'green';
        const overdueDays = Math.floor((today - new Date(nextUnpaid.dueMs))/86400000);
        if(overdueDays>10) return 'red';
        if(overdueDays>=6) return 'yellow';
        return overdueDays>0 ? 'yellow' : 'green';
      };

      const whatsappShare = (text)=> {
        const url = "https://wa.me/?text=" + encodeURIComponent(text);
        window.open(url,'_blank');
      };

      // ======= AUTH/UI =======
      $("#btnAdmin").addEventListener('click', async ()=>{
        // Login simple con popup de correo (link m√°gico no requerido)
        const provider = new firebase.auth.GoogleAuthProvider();
        try{
          const {user} = await auth.signInWithPopup(provider);
          $("#btnLogout").style.display = 'inline-flex';
          $("#adminPanel").style.display = 'grid';
          loadSettings(); loadPending(); loadPre(); loadActive(); loadInactive();
        }catch(e){ alert("No se pudo iniciar sesi√≥n: "+e.message); }
      });
      $("#btnLogout").addEventListener('click', async ()=>{
        await auth.signOut(); location.reload();
      });

      auth.onAuthStateChanged(async (u)=>{
        if(u){ $("#btnLogout").style.display='inline-flex'; }
      });

      // ======= SETTINGS (TNA / INFO UI) =======
      async function loadSettings(){
        try{
          const s = await db.collection('config').doc('settings').get();
          if(s.exists) settings = Object.assign(settings, s.data());
        }catch{}
        $("#cfgTna").value = settings.tna ?? 100;
        $("#simInfo").textContent = `TNA vigente: ${settings.tna ?? '‚Äî'}% ¬∑ Vencimiento: d√≠a ${settings.dueDay ?? 10}`;
      }
      loadSettings();

      $("#btnSaveTna").addEventListener('click', async ()=>{
        const tna = parseFloat($("#cfgTna").value||"0");
        if(!(tna>=0)) return alert("Ingres√° una TNA v√°lida");
        await db.collection('config').doc('settings').set({tna},{merge:true});
        settings.tna = tna;
        loadSettings();
        alert("TNA actualizada");
      });

      // ======= SIMULADOR =======
      $("#btnSim").addEventListener('click', ()=>{
        const amount = parseInt($("#simAmount").value||"0",10);
        const months = parseInt($("#simMonths").value||"0",10);
        if(!(amount>0 && months>0)) return alert("Ingres√° monto y cuotas");
        const firstDue = nextDueFrom(new Date(), settings.dueDay||10);
        const {pmt, schedule} = calcFrench(amount, months, settings.tna||0, firstDue);
        const total = pmt*months;
        $("#simResult").innerHTML = `
          <div class="loan">
            <div><strong>Cuota estimada:</strong> ${money(pmt)} ¬∑ <span class="muted">Total estimado:</span> ${money(total)}</div>
            <div class="hint">Sistema franc√©s. La tasa puede cambiar hasta la aprobaci√≥n.</div>
          </div>`;
      });

      // ======= SOLICITUD =======
      $("#btnRequest").addEventListener('click', async ()=>{
        const amount = parseInt($("#simAmount").value||"0",10);
        const months = parseInt($("#simMonths").value||"0",10);
        if(!(amount>0 && months>0)) return alert("Primero simul√° el pr√©stamo (monto y cuotas).");

        const name = $("#fName").value.trim();
        const dni = $("#fDni").value.trim();
        const email = $("#fEmail").value.trim();
        const phone = $("#fPhone").value.trim();
        const cbu = $("#fCbu").value.trim();
        if(!name || !dni || !email || !phone || !cbu) return alert("Complet√° todos los campos.");

        const data = {
          amount, months, status:'pending', createdAt: sv.serverTimestamp(),
          tnaCurrent: settings.tna||0, dueDay: settings.dueDay||10,
          borrower:{ name, dni, email, phone, cbu },
          otpCode:null, contractAccepted:false, depositDone:false, schedule:[]
        };
        await db.collection('loans').add(data);
        alert("Solicitud enviada. Un administrador la revisar√° antes de 48 hs.");
        $("#fName").value=$("#fDni").value=$("#fEmail").value=$("#fPhone").value=$("#fCbu").value="";
      });

      // ======= VER MI PR√âSTAMO (DNI + OTP) =======
      $("#btnMyLoan").addEventListener('click', ()=>$("#dlgMyLoan").showModal());

      $("#btnOpenMyLoan").addEventListener('click', async (e)=>{
        e.preventDefault();
        const dni = $("#mlDni").value.trim(), otp = $("#mlOtp").value.trim();
        if(!dni || !otp) return;
        try{
          const q = await db.collection('loans')
            .where('borrower.dni','==',dni)
            .where('otpCode','==',otp)
            .limit(1).get();
          if(q.empty) return alert("No se encontr√≥ pr√©stamo con ese DNI + OTP.");
          const id = q.docs[0].id, l = q.docs[0].data();

          // marca aceptaci√≥n de contrato
          if(!l.contractAccepted){
            await db.collection('loans').doc(id).update({contractAccepted:true, contractAcceptedAt:sv.serverTimestamp()});
            l.contractAccepted = true;
          }

          // render detalle para el cliente
          const paid = (l.schedule||[]).filter(x=>x.paid).length;
          const dueRows = (l.schedule||[]).map(i=>`
            <tr>
              <td>#${i.n}</td>
              <td>${new Date(i.dueMs).toLocaleDateString('es-AR')}</td>
              <td>${money(i.amount)}</td>
              <td>${money(i.capital||0)}</td>
              <td>${money(i.interest||0)}</td>
              <td>${i.paid ? 'Pagada' : 'Pendiente'}</td>
            </tr>`).join("");
          $("#mlContent").innerHTML = `
            <div class="loan">
              <div><strong>${l.borrower.name}</strong> ¬∑ DNI ${l.borrower.dni}</div>
              <div class="muted">Principal ${money(l.amount)} ¬∑ ${l.months} cuotas ¬∑ TNA ${l.tnaCurrent}%</div>
              <div class="hint">Contrato aceptado ‚úîÔ∏è ‚Äî OTP ${otp}</div>
            </div>
            <div class="card">
              <table>
                <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Capital</th><th>Inter√©s</th><th>Estado</th></tr></thead>
                <tbody>${dueRows||'<tr><td colspan="6" class="center muted">A√∫n sin cronograma</td></tr>'}</tbody>
              </table>
            </div>`;
        }catch(err){ alert("Error al abrir tu pr√©stamo: "+err.message); }
      });// ======= ADMIN TOOLS =======
      const isAdmin = async (email)=>{
        if(ALLOWED_ADMIN_EMAILS.includes(email)) return true;
        try{
          const d = await db.collection('config').doc('admins').get();
          const list = d.exists && Array.isArray(d.data().emails) ? d.data().emails : [];
          return list.includes(email);
        }catch{ return false; }
      };

      // Carga de listas
      async function loadPending(){
        const target = $("#pendingList"); target.textContent = "Cargando‚Ä¶";
        try{
          const snap = await db.collection('loans')
            .where('status','==','pending')
            .orderBy('createdAt','desc').get();
          if(snap.empty){ target.textContent = "Sin solicitudes pendientes"; return; }
          target.innerHTML = snap.docs.map(d=>{
            const l=d.data();
            return `<div class="loan">
              <div><strong>${l.borrower.name}</strong> ¬∑ DNI ${l.borrower.dni}</div>
              <div class="muted">Principal ${money(l.amount)} ¬∑ ${l.months} cuotas ¬∑ TNA ${l.tnaCurrent}%</div>
              <div class="toolbar">
                <button class="btn ok sm" onclick="preapprove('${d.id}')">Preaprobar</button>
                <button class="btn danger sm" onclick="rejectLoan('${d.id}')">Rechazar</button>
              </div>
            </div>`;
          }).join("");
        }catch(e){ target.innerHTML = `<div class="muted">Error: ${e.message}</div>`; }
      }

      async function loadPre(){
        const target = $("#preList"); target.textContent = "Cargando‚Ä¶";
        try{
          const snap = await db.collection('loans')
            .where('status','==','preapproved')
            .orderBy('createdAt','desc').get();
          if(snap.empty){ target.textContent = "Sin preaprobados"; return; }
          target.innerHTML = snap.docs.map(d=>{
            const l=d.data();
            const dot = `<span class="badge ${l.depositDone && l.contractAccepted ? 'b-green':'b-yellow'}">${l.depositDone && l.contractAccepted ? 'Listo para aprobar':'Faltan pasos'}</span>`;
            return `<div class="loan">
              <div class="row cols-2"><div>
                <strong>${l.borrower.name}</strong> ¬∑ DNI ${l.borrower.dni} ${dot}
                <div class="muted">Principal ${money(l.amount)} ¬∑ ${l.months} cuotas ¬∑ TNA ${l.tnaCurrent}%</div>
                <div class="muted">OTP: <strong>${l.otpCode||'‚Äî'}</strong></div>
              </div>
              <div class="toolbar right">
                <button class="btn sm" onclick="openContract('${d.id}')">Ver contrato</button>
                <button class="btn sm" onclick="shareOtp('${d.id}')">Enviar OTP</button>
                <button class="btn sm ok" onclick="markDeposit('${d.id}')">Dep√≥sito hecho</button>
                <button class="btn sm ok" onclick="approveLoan('${d.id}')">Aprobar</button>
                <button class="btn sm danger" onclick="dropPre('${d.id}')">Eliminar</button>
              </div></div>
            </div>`;
          }).join("");
        }catch(e){ target.innerHTML = `<div class="muted">Error: ${e.message}</div>`; }
      }

      async function loadActive(){
        const target = $("#activeList"); target.textContent="Cargando‚Ä¶";
        try{
          const snap = await db.collection('loans').where('status','==','active').orderBy('createdAt','desc').get();
          if(snap.empty){ target.textContent="Sin activos"; return; }
          const groups = {green:[],yellow:[],red:[]};
          snap.docs.forEach(d=>{ const l=d.data(); l.id=d.id; groups[dotByLoan(l)].push(l); });

          const renderGroup = (arr, title, css)=>`
            <h4 style="margin:12px 0 6px">${title}</h4>
            ${arr.length?arr.map(l=>`
              <div class="loan">
                <div class="row cols-2">
                  <div>
                    <span class="badge ${css}"></span>
                    <strong>${l.borrower.name}</strong> ¬∑ DNI ${l.borrower.dni} ¬∑ <span class="muted">Estado: ${l.status}</span>
                    <div class="muted">Principal ${money(l.amount)} ¬∑ ${l.months} cuotas ¬∑ TNA ${l.tnaCurrent}%</div>
                  </div>
                  <div class="toolbar right">
                    <button class="btn sm" onclick="viewLoan('${l.id}')">Ver</button>
                    <button class="btn sm warn" onclick="toBad('${l.id}')">A incobrables</button>
                    <button class="btn sm ok" onclick="finishLoan('${l.id}')">Finalizar</button>
                  </div>
                </div>
              </div>`).join("") : `<div class="muted">‚Äî</div>`}
          `;
          target.innerHTML = renderGroup(groups.green,"Verde (al d√≠a)","b-green")
            + renderGroup(groups.yellow,"Amarillo (6‚Äì10 d√≠as mora)","b-yellow")
            + renderGroup(groups.red,"Rojo (>10 d√≠as mora)","b-red");
        }catch(e){ target.innerHTML = `<div class="muted">Error: ${e.message}</div>`; }
      }

      async function loadInactive(){
        // Finalizados
        const finT = $("#finList"), badT=$("#badList");
        finT.textContent=badT.textContent="Cargando‚Ä¶";
        try{
          const fin = await db.collection('loans').where('status','==','finished').orderBy('createdAt','desc').get();
          finT.innerHTML = fin.empty? "‚Äî" : fin.docs.map(d=>{
            const l=d.data();
            return `<div class="loan">
              <div><strong>${l.borrower.name}</strong> ¬∑ DNI ${l.borrower.dni}</div>
              <div class="muted">Principal ${money(l.amount)} ¬∑ ${l.months} cuotas ¬∑ TNA ${l.tnaCurrent}%</div>
              <div class="toolbar">
                <button class="btn sm" onclick="viewLoan('${d.id}')">Ver</button>
                <button class="btn sm danger" onclick="removeLoan('${d.id}')">Eliminar</button>
              </div>
            </div>`;
          }).join("");

          const bad = await db.collection('loans').where('status','==','charged_off').orderBy('createdAt','desc').get();
          badT.innerHTML = bad.empty? "‚Äî" : bad.docs.map(d=>{
            const l=d.data();
            return `<div class="loan">
              <div class="row cols-2">
                <div><strong>${l.borrower.name}</strong> ¬∑ DNI ${l.borrower.dni}</div>
                <div class="toolbar right">
                  <button class="btn sm" onclick="viewLoan('${d.id}')">Ver</button>
                  <button class="btn sm" onclick="legalPdf('${d.id}')">PDF legal</button>
                  <button class="btn sm danger" onclick="removeLoan('${d.id}')">Eliminar</button>
                </div>
              </div>
            </div>`;
          }).join("");
        }catch(e){
          finT.innerHTML = badT.innerHTML = `<div class="muted">Error: ${e.message}</div>`;
        }
      }

      // ======= ACCIONES ADMIN =======
      window.preapprove = async (id)=>{
        const otp = (""+Math.floor(Math.random()*1e6)).padStart(6,'0');
        await db.collection('loans').doc(id).update({status:'preapproved', preapprovedAt:sv.serverTimestamp(), otpCode:otp});
        loadPending(); loadPre();
        alert("Preaprobado creado");
      };
      window.rejectLoan = async (id)=>{
        if(!confirm("¬øRechazar solicitud?")) return;
        await db.collection('loans').doc(id).delete();
        loadPending();
      };
      window.shareOtp = async (id)=>{
        const l = (await db.collection('loans').doc(id).get()).data();
        const msg = `Hola ${l.borrower.name}!\nTu pr√©stamo fue PRE-APROBADO.\nMonto: ${money(l.amount)} ¬∑ Cuotas: ${l.months}\nTNA: ${l.tnaCurrent}%\nTu c√≥digo de firma (OTP) es: ${l.otpCode}\nIngresalo en ‚ÄúVer mi pr√©stamo‚Äù para aceptar el contrato.`;
        whatsappShare(msg);
      };
      window.openContract = async (id)=>{
        const l = (await db.collection('loans').doc(id).get()).data();
        const firstDue = nextDueFrom(new Date(), l.dueDay||10);
        const {pmt, schedule} = calcFrench(l.amount, l.months, l.tnaCurrent, firstDue);
        const w = window.open("","_blank");
        w.document.write(`<html><head><title>Contrato ‚Äî EstimaPres</title></head><body>
          <h3>CONTRATO DE MUTUO ‚Äî EstimaPres</h3>
          <div>Prestario: ${l.borrower.name} ¬∑ DNI ${l.borrower.dni} ¬∑ Email ${l.borrower.email}</div>
          <div>Capital: ${money(l.amount)} ¬∑ Plazo: ${l.months} meses (franc√©s)</div>
          <div>TNA: ${l.tnaCurrent}% ¬∑ Cuota estimada: ${money(pmt)}</div>
          <hr><h4>Cronograma</h4>
          <table border="1" cellpadding="6" cellspacing="0">
            <tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Capital</th><th>Inter√©s</th></tr>
            ${schedule.map(i=>`<tr><td>${i.n}</td><td>${new Date(i.dueMs).toLocaleDateString('es-AR')}</td><td style="text-align:right">${money(i.amount)}</td><td style="text-align:right">${money(i.capital)}</td><td style="text-align:right">${money(i.interest)}</td></tr>`).join("")}
          </table>
          <p>La aceptaci√≥n por OTP queda registrada en EstimaPres.</p></body></html>`);
        w.document.close();
      };
      window.markDeposit = async (id)=>{ await db.collection('loans').doc(id).update({depositDone:true}); loadPre(); };
      window.approveLoan = async (id)=>{
        const snap = await db.collection('loans').doc(id).get(); const l = snap.data();
        if(!l.contractAccepted){ alert("Falta firma OTP del cliente."); return; }
        if(!l.depositDone){ alert("Marc√° el dep√≥sito antes de aprobar."); return; }
        // generar cronograma definitivo si no existe
        if(!l.schedule || !l.schedule.length){
          const firstDue = nextDueFrom(new Date(), l.dueDay||10);
          const {schedule} = calcFrench(l.amount, l.months, l.tnaCurrent, firstDue);
          await db.collection('loans').doc(id).update({schedule});
        }
        await db.collection('loans').doc(id).update({status:'active', activeAt:sv.serverTimestamp()});
        loadPre(); loadActive();
      };
      window.dropPre = async (id)=>{ if(!confirm("¬øEliminar preaprobado?")) return; await db.collection('loans').doc(id).delete(); loadPre(); };

      // Detalle con marcado de pago
      window.viewLoan = async (id)=>{
        const snap = await db.collection('loans').doc(id).get(); const l = snap.data();
        $("#dlgTitle").textContent = `${l.borrower.name} ¬∑ DNI ${l.borrower.dni}`;
        const rows = (l.schedule||[]).map(i=>`
          <tr>
            <td>#${i.n}</td>
            <td>${new Date(i.dueMs).toLocaleDateString('es-AR')}</td>
            <td>${money(i.amount)}</td>
            <td>${i.paid?'Pagada':'Pendiente'}</td>
            <td><button class="btn sm ${i.paid?'secondary':'ok'}" onclick="togglePaid('${id}',${i.n},${i.paid?0:1})">${i.paid?'Desmarcar':'Marcar pagada'}</button></td>
          </tr>`).join("");
        $("#dlgBody").innerHTML = `
          <div class="card">
            <div class="muted">Estado: ${l.status} ¬∑ Principal ${money(l.amount)} ¬∑ ${l.months} cuotas ¬∑ TNA ${l.tnaCurrent}%</div>
            <table>
              <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th><th></th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
        $("#dlgLoan").showModal();
      };
      $("#btnCloseLoan").addEventListener('click', ()=>$("#dlgLoan").close());

      window.togglePaid = async (id, n, mark)=>{
        const ref = db.collection('loans').doc(id);
        const snap = await ref.get(); const l = snap.data();
        const copy = (l.schedule||[]).map(o=> ({...o}));
        const idx = copy.findIndex(x=>x.n===n);
        if(idx>=0){ copy[idx].paid = !!mark; copy[idx].paidAt = mark? sv.serverTimestamp():null; }
        await ref.update({schedule:copy});
        viewLoan(id);
      };

      window.toBad = async (id)=>{ if(!confirm("¬øMover a incobrables?")) return; await db.collection('loans').doc(id).update({status:'charged_off', chargedOffAt:sv.serverTimestamp()}); loadActive(); loadInactive(); };
      window.finishLoan = async (id)=>{ if(!confirm("¬øFinalizar (pagado total)?")) return; await db.collection('loans').doc(id).update({status:'finished', finishedAt:sv.serverTimestamp()}); loadActive(); loadInactive(); };
      window.removeLoan = async (id)=>{ if(!confirm("¬øEliminar definitivamente?")) return; await db.collection('loans').doc(id).delete(); loadInactive(); };

      window.legalPdf = async (id)=>{
        const l = (await db.collection('loans').doc(id).get()).data();
        const pending = (l.schedule||[]).filter(x=>!x.paid);
        const w = window.open("","_blank");
        w.document.write(`<html><head><title>Informe legal ‚Äî EstimaPres</title></head><body>
          <h3>INCORBRABLE ‚Äî EstimaPres</h3>
          <div><strong>${l.borrower.name}</strong> ¬∑ DNI ${l.borrower.dni}</div>
          <div>Email ${l.borrower.email} ¬∑ Tel ${l.borrower.phone}</div>
          <div>Principal ${money(l.amount)} ¬∑ TNA ${l.tnaCurrent}% ¬∑ Cuotas ${l.months}</div>
          <hr><h4>Detalle de cuotas pendientes</h4>
          <table border="1" cellpadding="6" cellspacing="0">
            <tr><th>#</th><th>Vencimiento</th><th>Importe</th></tr>
            ${pending.map(i=>`<tr><td>${i.n}</td><td>${new Date(i.dueMs).toLocaleDateString('es-AR')}</td><td style="text-align:right">${money(i.amount)}</td></tr>`).join("")}
          </table>
          <p>Total pendiente: <strong>${money(pending.reduce((a,b)=>a+b.amount,0))}</strong></p>
        </body></html>`);
        w.document.close();
      };

      // ======= PROTECCI√ìN ADMIN (solo si es admin) =======
      $("#adminPanel").addEventListener('toggle', async (ev)=>{
        // noop ‚Äî solo para mantener visible si ya est√° abierto
      });

      // Al abrir admin, chequear permisos
      $("#btnAdmin").addEventListener('click', async ()=>{
        const u = auth.currentUser;
        if(!u) return; // ya se maneja en el login
        if(!(await isAdmin(u.email))){
          alert("Tu usuario no tiene permisos de administrador.");
          $("#adminPanel").style.display = "none";
        }
      });

      // ======= SW (PWA opcional) =======
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('/sw.js').catch(()=>{});
      }
    </script>
  </div>
</body>
</html>