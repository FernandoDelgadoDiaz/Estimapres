<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>EstimaPres · Préstamos en ARS</title>
  <style>
    :root{
      --primary:#0b5ed7;--primary-700:#0949a6;--danger:#dc3545;--green:#2e7d32;
      --bg:#f6f7fb;--card:#ffffff;--muted:#6b7280;--ink:#111827;--ring:#e5e7eb;
      --pill:#eef2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    header{position:sticky;top:0;z-index:10;background:#0a4da1;color:#fff}
    .wrap{max-width:980px;margin:0 auto;padding:0 16px}
    .bar{display:flex;align-items:center;gap:12px;padding:14px 0}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:20px}
    .avatar{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;background:#244f9f}
    .nav{margin-left:auto;display:flex;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 16px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.primary:active{background:var(--primary-700)}
    .btn.ghost{background:#fff1;border:1px solid #fff5;color:#fff}
    .btn.danger{background:var(--danger);color:#fff}
    main{padding:24px 0}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:18px;margin:16px 0;box-shadow:0 2px 10px rgba(16,24,40,.04)}
    h1{font-size:28px;margin:6px 0 4px}
    h2{font-size:22px;margin:0 0 12px}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    @media (max-width:760px){.grid.cols-2{grid-template-columns:1fr}}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--ring);font-size:16px;background:#fff}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .note{font-size:13px;color:var(--muted)}
    .pill{background:var(--pill);padding:4px 10px;border-radius:999px;font-weight:600;font-size:12px}
    .list-empty{padding:14px;border:1px dashed var(--ring);border-radius:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;border:1px solid var(--ring);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--ring);font-size:14px}
    th{background:#f9fafb;text-align:left}
    .tag{font-size:12px;border-radius:8px;padding:4px 8px}
    .tag.green{background:#e8f5e9;color:#1b5e20}
    .tag.yellow{background:#fff8e1;color:#a07800}
    .tag.red{background:#ffebee;color:#b71c1c}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .hidden{display:none !important}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
      background:#111;color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;opacity:.95;z-index:50}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b0b0b10;border:1px solid var(--ring);padding:0 6px;border-radius:6px}
  </style>
</head>
<body>
  <header>
    <div class="wrap bar">
      <div class="brand">
        <div class="avatar">E</div> EstimaPres
      </div>
      <div class="nav">
        <button id="btnMyLoan" class="btn ghost">Ver mi préstamo</button>
        <button id="btnAdmin" class="btn ghost">Admin</button>
        <button id="btnAuth" class="btn danger hidden">Salir</button>
        <button id="btnLogin" class="btn primary">Ingresar</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Simulador -->
    <section class="card">
      <h1>Simulador (pesos argentinos)</h1>
      <div class="grid cols-2">
        <input id="simAmount" type="number" inputmode="numeric" placeholder="Ej: 200000" />
        <input id="simMonths" type="number" inputmode="numeric" placeholder="Ej: 12" />
      </div>
      <div class="row" style="margin:10px 0">
        <span class="muted">TNA vigente: <b id="lblTna">—%</b> · Vencimiento: día <b id="lblDueDay">10</b></span>
      </div>
      <div class="row">
        <button id="btnSim" class="btn" style="background:#25a244;color:#fff">Simular</button>
      </div>
      <div id="simOut" class="note" style="margin-top:8px">—</div>
      <div id="simSchedule" class="hidden" style="margin-top:10px"></div>
    </section>

    <!-- Solicitud -->
    <section class="card">
      <h2>Solicitar préstamo</h2>
      <div class="grid">
        <input id="rqName" placeholder="Tu nombre" />
        <input id="rqDni" placeholder="DNI" />
        <input id="rqEmail" placeholder="tucorreo@dominio.com" />
        <input id="rqPhone" placeholder="11 2345 6789" />
        <input id="rqCbu" placeholder="alias o CBU/CVU" />
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btnSendReq" class="btn primary">Enviar solicitud</button>
      </div>
      <div class="note">Al enviar aceptás ser contactado por EstimaPres.</div>
    </section>

    <!-- Panel admin -->
    <section id="adminPanel" class="card hidden">
      <h1>Panel de administrador</h1>

      <h2>1) Tasa (TNA %)</h2>
      <div class="row">
        <input id="inpTna" style="max-width:220px" />
        <button id="btnSaveTna" class="btn primary">Guardar</button>
      </div>

      <h2 style="margin-top:18px">2) Solicitudes pendientes</h2>
      <button id="btnReloadReq" class="btn">Recargar</button>
      <div id="reqList" style="margin-top:10px"></div>

      <h2 style="margin-top:18px">3) Preaprobados (Contrato / OTP / Depósito / Aprobar)</h2>
      <button id="btnReloadPre" class="btn">Recargar</button>
      <div id="preList" style="margin-top:10px"></div>

      <h2 style="margin-top:18px">4) Préstamos activos (agrupados por semáforo)</h2>
      <div class="note">Verde: al día · Amarillo: 6–10 días de mora · Rojo: &gt;10 días</div>
      <button id="btnReloadActive" class="btn">Recargar</button>
      <div id="activeList" style="margin-top:10px"></div>

      <h2 style="margin-top:18px">5) Inactivos (finalizados / incobrables)</h2>
      <button id="btnReloadInactive" class="btn">Recargar</button>
      <div id="inactiveList" style="margin-top:10px"></div>
    </section>
  </main>

  <div id="toast" class="toast hidden"></div>

  <!-- Firebase + App -->
  <script type="module">
    /******** Firebase *********/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, setDoc, addDoc,
      getDocs, query, where, orderBy, limit, updateDoc, deleteDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // === TU CONFIG: la que me pasaste del proyecto "estimapres"
    const firebaseConfig = {
      apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
      authDomain: "estimapres.firebaseapp.com",
      projectId: "estimapres",
      storageBucket: "estimapres.firebasestorage.app",
      messagingSenderId: "578516597437",
      appId: "1:578516597437:web:f59994b87729aa1cd655d4"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /******** Utils *********/
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>document.querySelectorAll(sel);
    const money = (n)=> new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0}).format(Number(n||0));
    const toast = (m)=>{const t=$("#toast"); t.textContent=m; t.classList.remove("hidden"); setTimeout(()=>t.classList.add("hidden"),2500);};
    const cuota = (P,tna,months)=>{ const i =(tna/100)/12; if(i===0) return Math.round(P/months);
      return Math.round(P * (i*Math.pow(1+i,months)) / (Math.pow(1+i,months)-1)); };

    const STATE = { tna:150, dueDay:10, user:null, isAdmin:false, lastSim:null };

    /******** Auth + Admin gating *********/
    async function isEmailAdmin(email){
      try{
        const snap = await getDoc(doc(db,"admins","admins"));
        const arr = snap.exists()? (snap.data().emails||[]) : [];
        return arr.includes(email);
      }catch(_){ return false; }
    }
    onAuthStateChanged(auth, async (user)=>{
      STATE.user = user||null;
      $("#btnLogin").classList.toggle("hidden", !!user);
      $("#btnAuth").classList.toggle("hidden", !user);
      $("#btnAdmin").classList.toggle("hidden", !user);
      $("#adminPanel").classList.add("hidden");

      STATE.isAdmin = !!(user && await isEmailAdmin(user.email));
      if(!STATE.isAdmin) $("#btnAdmin").classList.add("hidden");
    });

    $("#btnLogin").onclick = async ()=>{
      const email = prompt("Email de administrador:");
      const pass  = prompt("Contraseña:");
      if(!email || !pass) return;
      try{
        await signInWithEmailAndPassword(auth,email,pass);
        toast("Sesión iniciada.");
      }catch(e){ console.error(e); alert("Error de acceso: "+(e.code||e.message)); }
    };
    $("#btnAuth").onclick = async ()=>{ await signOut(auth); toast("Sesión cerrada."); };

    $("#btnAdmin").onclick = ()=>{
      if(!STATE.isAdmin){ alert("No tenés permisos de administrador."); return; }
      $("#adminPanel").classList.toggle("hidden");
    };

    /******** Config (TNA) desde settings/global *********/
    async function loadTna(){
      try{
        const s = await getDoc(doc(db,"settings","global"));
        if(s.exists()){
          STATE.tna = Number(s.data().tna||150);
        }
      }catch(e){ console.warn("settings/global:",e.code||e.message); }
      $("#lblTna").textContent = STATE.tna+"%";
      $("#lblDueDay").textContent = STATE.dueDay;
      $("#inpTna").value = STATE.tna;
    }
    $("#btnSaveTna").onclick = async ()=>{
      if(!STATE.isAdmin) return;
      const val = Number($("#inpTna").value||0);
      try{
        await setDoc(doc(db,"settings","global"),{tna:val, updatedAt:serverTimestamp()},{merge:true});
        STATE.tna = val;
        $("#lblTna").textContent = val+"%";
        toast("TNA actualizada.");
      }catch(e){ alert("No se pudo guardar TNA: "+(e.code||e.message)); }
    };

    /******** Simulador *********/
    $("#btnSim").onclick = ()=>{
      const amount = Number($("#simAmount").value||0);
      const months = Number($("#simMonths").value||0);
      if(!amount || !months){ toast("Completá monto y meses."); return; }
      const c = cuota(amount, STATE.tna, months);
      const total = money(c*months);
      $("#simOut").innerHTML = `Cuota: <b>${money(c)}</b> · <span class="muted">Total: ${total}</span><br>
      <a href="#" id="lnkSched">Ver detalle de cuotas</a>`;
      $("#simSchedule").classList.add("hidden");

      $("#lnkSched").onclick = (ev)=>{
        ev.preventDefault();
        const rows = Array.from({length:months},(_,i)=>{
          const n=i+1, mm=((new Date().getMonth()+i+1)%12)+1;
          return `<tr><td>#${n}</td><td>${String(STATE.dueDay).padStart(2,"0")}/${String(mm).padStart(2,"0")}</td><td>${money(c)}</td></tr>`;
        }).join("");
        $("#simSchedule").innerHTML = `<table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th></tr></thead><tbody>${rows}</tbody></table>`;
        $("#simSchedule").classList.remove("hidden");
      };

      STATE.lastSim = {amount, months, tna:STATE.tna};
    };

    /******** Solicitudes *********/
    $("#btnSendReq").onclick = async ()=>{
      const name = $("#rqName").value.trim();
      const dni = $("#rqDni").value.trim();
      const email = $("#rqEmail").value.trim();
      const phone = $("#rqPhone").value.trim();
      const cbu = $("#rqCbu").value.trim();

      if(!name || !dni || !email || !phone || !cbu){ toast("Completá todos los campos."); return; }
      if(!STATE.lastSim){ toast("Primero simulá tu préstamo."); return; }

      try{
        await addDoc(collection(db,"loan_requests"),{
          borrower:{name, dni, email, phone, cbu},
          amount: STATE.lastSim.amount,
          months: STATE.lastSim.months,
          tna: STATE.lastSim.tna,
          createdAt: serverTimestamp()
        });
        alert("Solicitud enviada. Un administrador la revisará en 48 hs.");
        $("#rqName").value=$("#rqDni").value=$("#rqEmail").value=$("#rqPhone").value=$("#rqCbu").value="";
      }catch(e){
        alert("No se pudo enviar la solicitud: "+(e.code||e.message));
      }
    };

    /******** Admin: Solicitudes pendientes *********/
    async function loadReq(){
      const box = $("#reqList"); box.innerHTML = "Cargando…";
      try{
        const qy = query(collection(db,"loan_requests"), orderBy("createdAt","desc"), limit(80));
        const snap = await getDocs(qy);
        if(snap.empty){ box.innerHTML = `<div class="list-empty">Sin solicitudes</div>`; return; }
        const items = [];
        snap.forEach(d=>items.push({id:d.id, ...d.data()}));
        box.innerHTML = items.map(l=>(
          `<div class="card" style="padding:12px">
            <div class="row" style="justify-content:space-between">
              <div>
                <b>${l.borrower.name}</b> · DNI ${l.borrower.dni}
                <div class="note">${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%</div>
              </div>
              <div class="actions">
                <button data-act="pre" data-id="${l.id}" class="btn primary">Preaprobar</button>
                <button data-act="delreq" data-id="${l.id}" class="btn">Eliminar</button>
              </div>
            </div>
          </div>`
        )).join("");
      }catch(e){
        box.innerHTML = `<div class="list-empty">No se pudieron leer las solicitudes (${e.code||"reglas/índices"}).</div>`;
      }
    }
    $("#btnReloadReq").onclick = loadReq;

    /******** Admin: Preaprobados *********/
    async function loadPre(){
      const box = $("#preList"); box.innerHTML = "Cargando…";
      try{
        const qy = query(collection(db,"loans"), where("status","==","preapproved"), orderBy("createdAt","desc"), limit(80));
        const snap = await getDocs(qy);
        if(snap.empty){ box.innerHTML = `<div class="list-empty">Sin preaprobados</div>`; return; }
        const items = []; snap.forEach(d=>items.push({id:d.id, ...d.data()}));
        box.innerHTML = items.map(l=>(
          `<div class="card" style="padding:12px">
            <div class="row" style="justify-content:space-between">
              <div>
                <span class="pill">Preaprobado</span> <b>${l.borrower.name}</b> · DNI ${l.borrower.dni}
                <div class="note">Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%</div>
              </div>
              <div class="actions">
                <button class="btn" data-act="contract" data-id="${l.id}">Contrato (PDF)</button>
                <button class="btn" data-act="otp" data-id="${l.id}">Enviar OTP</button>
                <button class="btn" data-act="dep" data-id="${l.id}">Depósito hecho</button>
                <button class="btn primary" data-act="approve" data-id="${l.id}">Aprobar</button>
                <button class="btn danger" data-act="del" data-id="${l.id}">Eliminar</button>
              </div>
            </div>
          </div>`
        )).join("");
      }catch(e){
        box.innerHTML = `<div class="list-empty">No se pudo leer (${e.code||"reglas/índices"}).</div>`;
      }
    }
    $("#btnReloadPre").onclick = loadPre;

    /******** Admin: Activos (semaforizados) *********/
    const dotByLoan = (l)=>{
      const today = new Date();
      const due = new Date(today.getFullYear(), today.getMonth(), STATE.dueDay);
      if(today.getDate()<=STATE.dueDay) due.setMonth(today.getMonth()); else due.setMonth(today.getMonth()+1);
      const diff = Math.floor((today-due)/(1000*60*60*24));
      if(diff<=0) return "green"; if(diff<=10) return "yellow"; return "red";
    };
    const scheduleHTML = (l)=>{
      const c = cuota(l.amount,l.tna,l.months);
      const paid = Number(l.paidCount||0);
      const rows = Array.from({length:l.months},(_,i)=>{
        const n=i+1, pag = n<=paid, mm=((new Date().getMonth()+i+1)%12)+1;
        return `<tr><td>#${n}</td><td>${String(STATE.dueDay).padStart(2,"0")}/${String(mm).padStart(2,"0")}</td>
                <td>${money(c)}</td><td>${pag?'Pagada ✅':`<button data-pay="${n}" data-id="${l.id}" class="btn">Marcar pagada</button>`}</td></tr>`;
      }).join("");
      return `<table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead><tbody>${rows}</tbody></table>`;
    };
    async function loadActive(){
      const box = $("#activeList"); box.innerHTML = "Cargando…";
      try{
        const qy = query(collection(db,"loans"), where("status","==","active"), orderBy("activeAt","desc"), limit(80));
        const snap = await getDocs(qy);
        if(snap.empty){ box.innerHTML = `<div class="list-empty">Sin activos</div>`; return; }
        const groups = {green:[],yellow:[],red:[]};
        snap.forEach(d=>{ const l={id:d.id,...d.data()}; groups[dotByLoan(l)].push(l); });
        const section = (title,color)=> groups[color].length?`
          <h3 style="margin:12px 0">${title}</h3>
          ${groups[color].map(l=>`
            <div class="card" style="padding:12px">
              <div class="row" style="justify-content:space-between">
                <div>
                  <span class="tag ${color}">Activo</span> <b>${l.borrower.name}</b> · DNI ${l.borrower.dni}
                  <div class="note">Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%</div>
                </div>
                <div class="actions">
                  <button class="btn" data-act="ver" data-id="${l.id}">Ver</button>
                  <button class="btn" data-act="inc" data-id="${l.id}">A incobrables</button>
                  <button class="btn primary" data-act="fin" data-id="${l.id}">Finalizar</button>
                </div>
              </div>
              <div id="det-${l.id}" class="hidden" style="margin-top:8px">${scheduleHTML(l)}</div>
            </div>`).join("")}
        `:"";
        box.innerHTML = section("Verde (al día)","green")+section("Amarillo (6–10 días)","yellow")+section("Rojo (&gt;10 días)","red");
      }catch(e){
        box.innerHTML = `<div class="list-empty">No se pudo leer activos (${e.code||"reglas/índices"}).</div>`;
      }
    }
    $("#btnReloadActive").onclick = loadActive;

    /******** Admin: Inactivos *********/
    async function loadInactive(){
      const box = $("#inactiveList"); box.innerHTML = "Cargando…";
      try{
        const get = async (st)=> {
          const qy = query(collection(db,"loans"), where("status","==",st), orderBy("createdAt","desc"), limit(80));
          const snap = await getDocs(qy);
          const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()})); return arr;
        };
        const finished = await get("finished");
        const charged = await get("charged_off");
        const render = (title,items)=> items.length?`
          <h3 style="margin:12px 0">${title}</h3>
          ${items.map(l=>`<div class="card" style="padding:12px">
            <b>${l.borrower.name}</b> · DNI ${l.borrower.dni} — <span class="note">${money(l.amount)} · ${l.months} cuotas</span>
          </div>`).join("")}`:"";
        box.innerHTML = render("Finalizados",finished)+render("Incobrables",charged) || `<div class="list-empty">Sin inactivos</div>`;
      }catch(e){ box.innerHTML = `<div class="list-empty">No se pudo leer (${e.code||"reglas/índices"}).</div>`; }
    }
    $("#btnReloadInactive").onclick = loadInactive;

    /******** Delegación de eventos (admin) *********/
    document.addEventListener("click", async (ev)=>{
      const b = ev.target.closest("button"); if(!b) return;

      // Ver mi préstamo
      if(b.id==="btnMyLoan"){
        const dni = prompt("Ingresá tu DNI para consultar tu préstamo:"); if(!dni) return;
        try{
          const res=[]; const snap=await getDocs(query(collection(db,"loans"), orderBy("createdAt","desc"), limit(80)));
          snap.forEach(d=>{ const l=d.data(); if(l?.borrower?.dni==dni) res.push({id:d.id,...l}); });
          if(!res.length){ alert("No encontramos préstamos activos o preaprobados para ese DNI."); return; }
          const l = res[0];
          alert(`Estado: ${l.status}\nMonto: ${money(l.amount)}\nCuotas: ${l.months}\nTNA: ${l.tna}%`);
        }catch(e){ alert("No se pudo consultar: "+(e.code||e.message)); }
        return;
      }

      // Admin only below
      if(!STATE.isAdmin) return;

      // Preaprobar solicitud
      if(b.dataset.act==="pre"){
        try{
          const r = await getDoc(doc(db,"loan_requests",b.dataset.id));
          if(!r.exists()) return;
          const data=r.data();
          await setDoc(doc(db,"loans", b.dataset.id), {
            status:"preapproved", createdAt: serverTimestamp(), paidCount:0,
            amount:data.amount, months:data.months, tna:data.tna, dueDay:STATE.dueDay,
            borrower:data.borrower
          });
          await deleteDoc(doc(db,"loan_requests",b.dataset.id));
          toast("Preaprobado.");
          loadReq(); loadPre();
        }catch(e){ alert("No se pudo preaprobar: "+(e.code||e.message)); }
        return;
      }
      // Eliminar solicitud
      if(b.dataset.act==="delreq"){
        if(!confirm("¿Eliminar solicitud?")) return;
        try{ await deleteDoc(doc(db,"loan_requests",b.dataset.id)); loadReq(); }
        catch(e){ alert("No se pudo eliminar: "+(e.code||e.message)); }
        return;
      }
      // Acciones sobre preaprobados
      if(b.dataset.act==="contract"){
        try{
          const l = (await getDoc(doc(db,"loans",b.dataset.id))).data();
          const html = `
            <html><head><meta charset="utf-8"><title>Contrato EstimaPres</title>
            <style>body{font-family:Arial,sans-serif;padding:24px;line-height:1.45}
            h2{margin:0 0 10px} .muted{color:#555}</style></head>
            <body>
              <h2>Contrato de préstamo — EstimaPres</h2>
              <p><b>Deudor:</b> ${l.borrower.name} — DNI ${l.borrower.dni}</p>
              <p><b>Monto:</b> ${money(l.amount)} — <b>Plazo:</b> ${l.months} cuotas — <b>TNA:</b> ${l.tna}%</p>
              <p class="muted">Vencimiento mensual: día ${STATE.dueDay}. Este documento es emitido automáticamente para revisión.</p>
            </body></html>`;
          const w = window.open("about:blank","_blank"); w.document.write(html); w.document.close(); w.onload=()=>w.print();
        }catch(e){ console.error(e); toast("No se pudo generar el contrato."); }
        return;
      }
      if(b.dataset.act==="otp"){ toast("OTP enviado (simulado)."); return; }
      if(b.dataset.act==="dep"){ toast("Depósito marcado (simulado)."); return; }
      if(b.dataset.act==="approve"){
        if(!confirm("¿Aprobar y activar?")) return;
        try{
          await updateDoc(doc(db,"loans",b.dataset.id),{status:"active", activeAt:serverTimestamp()});
          loadPre(); loadActive();
        }catch(e){ alert("No se pudo aprobar: "+(e.code||e.message)); }
        return;
      }
      if(b.dataset.act==="del"){
        if(!confirm("¿Eliminar preaprobado?")) return;
        try{ await deleteDoc(doc(db,"loans",b.dataset.id)); loadPre(); }
        catch(e){ alert("No se pudo eliminar: "+(e.code||e.message)); }
        return;
      }

      // Activos
      if(b.dataset.act==="ver"){ $("#det-"+b.dataset.id).classList.toggle("hidden"); return; }
      if(b.dataset.act==="inc"){
        if(!confirm("¿Pasar a incobrables?"))return;
        try{ await updateDoc(doc(db,"loans",b.dataset.id),{status:"charged_off"}); loadActive(); loadInactive(); }
        catch(e){ alert("No se pudo mover: "+(e.code||e.message)); }
        return;
      }
      if(b.dataset.act==="fin"){
        if(!confirm("¿Finalizar (pagado total)?"))return;
        try{ await updateDoc(doc(db,"loans",b.dataset.id),{status:"finished"}); loadActive(); loadInactive(); }
        catch(e){ alert("No se pudo finalizar: "+(e.code||e.message)); }
        return;
      }
      if(b.dataset.pay){
        try{
          const ref = doc(db,"loans",b.dataset.id);
          const cur = await getDoc(ref);
          if(!cur.exists()) return;
          const paid = Number(cur.data().paidCount||0)+1;
          await updateDoc(ref,{paidCount:paid});
          loadActive();
        }catch(e){ alert("No se pudo marcar la cuota: "+(e.code||e.message)); }
        return;
      }
    });

    // Carga inicial
    await loadTna();
  </script>
</body>
</html>