<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EstimaPres · Préstamos en ARS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f172a;--card:#fff;--muted:#64748b;--brand:#0b4a6e;--ok:#16a34a;--warn:#f59e0b;--bad:#ef4444}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:#f6f7fb;color:#0f172a}
    .appbar{background:#0b3b66;color:#fff;padding:16px 20px;position:sticky;top:0;z-index:50;box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .appbar .wrap{max-width:940px;margin:0 auto;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .badge{width:36px;height:36px;border-radius:10px;background:#e8eef7;display:grid;place-items:center;color:#0b3b66;font-weight:700}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.primary{background:#0b4a6e;color:#fff} .btn.ghost{background:#e6eef7;color:#0b3b66}
    .btn.green{background:var(--ok);color:#fff} .btn.yellow{background:var(--warn);color:#fff} .btn.red{background:var(--bad);color:#fff}
    .container{max-width:940px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 6px 20px rgba(12,39,79,.08);padding:18px;margin:14px 0}
    h2{margin:0 0 10px 0;font-size:20px} h3{margin:0 0 8px 0;font-size:16px;color:#111827}
    .muted{color:#64748b;font-size:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .input{padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;font-size:16px;width:100%}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#f1f5f9;color:#0f172a;padding:8px 12px;border-radius:999px;font-size:12px}
    .dot{width:10px;height:10px;border-radius:999px;background:#d1d5db}
    .dot.green{background:var(--ok)} .dot.yellow{background:var(--warn)} .dot.red{background:var(--bad)}
    details{background:#fff;border-radius:16px;box-shadow:0 6px 20px rgba(12,39,79,.06);margin:14px 0;overflow:hidden}
    details summary{list-style:none;padding:16px 18px;cursor:pointer;font-weight:700}
    details[open] summary{border-bottom:1px solid #eef2f7}
    .list{display:flex;flex-direction:column;gap:12px}
    .loan{border:1px solid #eef2f7;padding:14px;border-radius:14px}
    .loan .hdr{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .loan .actions{gap:8px}
    @media (max-width:720px){ .grid{grid-template-columns:1fr} .actions{width:100%;justify-content:flex-end} .btn{padding:10px 12px}}
  </style>
</head>
<body>
  <header class="appbar">
    <div class="wrap">
      <div class="brand"><div class="badge">E</div> EstimaPres</div>
      <div class="actions">
        <button id="btnMyLoan" class="btn ghost">Ver mi préstamo</button>
        <button id="btnAdmin" class="btn primary">Admin</button>
      </div>
    </div>
  </header>
  <main class="container">

    <!-- Simulador -->
    <section class="card" id="simu">
      <h2>Simulador (pesos argentinos)</h2>
      <div class="grid">
        <div class="field">
          <label>Monto (ARS)</label>
          <input id="amount" class="input" type="number" placeholder="Ej: 200000" />
        </div>
        <div class="field">
          <label>Cuotas (meses)</label>
          <input id="months" class="input" type="number" placeholder="Ej: 12" />
        </div>
      </div>
      <p class="muted">TNA vigente: <span id="tnaLabel">—%</span> · Vencimiento: día 10</p>
      <button id="btnSim" class="btn primary">Simular</button>

      <div id="simResult" class="card" style="display:none;margin-top:14px">
        <h3>Resultado</h3>
        <div id="simText" class="muted"></div>
      </div>
    </section>

    <!-- Solicitud -->
    <section class="card">
      <h2>Solicitar préstamo</h2>
      <div class="grid">
        <div class="field"><label>Nombre y apellido</label><input id="f_name" class="input" placeholder="Tu nombre" /></div>
        <div class="field"><label>DNI</label><input id="f_dni" class="input" placeholder="30123456" /></div>
        <div class="field"><label>Email</label><input id="f_email" class="input" placeholder="tucorreo@dominio.com" /></div>
        <div class="field"><label>Celular</label><input id="f_phone" class="input" placeholder="11 2345 6789" /></div>
        <div class="field" style="grid-column:1/-1"><label>CBU / CVU o Alias (depósito)</label><input id="f_cbu" class="input" placeholder="alias o CBU/CVU" /></div>
      </div>
      <button id="btnRequest" class="btn primary" style="margin-top:10px">Enviar solicitud</button>
      <p class="muted" id="reqHint" style="margin-top:8px"></p>
    </section>

    <!-- Panel admin -->
    <h2 style="margin-top:28px">Panel de administrador</h2>
    <p class="muted">Gestión interna de EstimaPres</p>

    <details id="secRate" open>
      <summary>1) Tasa centralizada (TNA %)</summary>
      <div class="card" style="margin:0">
        <div class="field" style="max-width:260px">
          <label>TNA actual (%)</label>
          <input id="inpTna" class="input" />
        </div>
        <button id="btnSaveTna" class="btn primary" style="margin-top:10px">Guardar</button>
        <p class="muted" style="margin-top:8px">Impacta en el simulador; cada préstamo conserva su TNA al aprobar.</p>
      </div>
    </details>

    <details id="secPending">
      <summary>2) Solicitudes pendientes</summary>
      <div id="pendingList" class="list card" style="margin:0">Cargando…</div>
    </details>

    <details id="secPre">
      <summary>3) Preaprobados (Contrato / Firma OTP / Depósito)</summary>
      <div id="preList" class="list card" style="margin:0">Cargando…</div>
    </details>

    <details id="secActive">
      <summary>4) Préstamos activos (agrupados por semáforo)</summary>
      <div class="muted card" style="margin:0">Verde: al día · Amarillo: 6–10 días mora · Rojo: >10 días mora</div>
      <div id="activeList" class="list card" style="margin:12px 0 0">Cargando…</div>
    </details>

    <details id="secInactive">
      <summary>5) Inactivos (finalizados / incobrables)</summary>
      <div class="card" style="margin:0">
        <h3>Finalizados (pagados)</h3>
        <div id="doneList" class="list">Cargando…</div>
        <h3 style="margin-top:12px">Incobrables</h3>
        <div id="badList" class="list">Cargando…</div>
      </div>
    </details>

  </main>

  <!-- Modal “Ver mi préstamo” -->
  <dialog id="dlgMyLoan">
    <form method="dialog" style="padding:6px 16px 16px">
      <h3>Ver mi préstamo</h3>
      <div class="grid">
        <div class="field"><label>DNI</label><input id="q_dni" class="input" placeholder="30123456" /></div>
        <div class="field"><label>OTP (6 dígitos)</label><input id="q_otp" class="input" placeholder="123456" maxlength="6" /></div>
      </div>
      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button class="btn ghost" value="cancel">Cancelar</button>
        <button id="btnFindLoan" class="btn primary" value="default">Buscar</button>
      </div>
      <div id="mine" class="card" style="display:none;margin-top:10px"></div>
    </form>
  </dialog><script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

let app, db, auth;
const $ = (id)=>document.getElementById(id);
const money = n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n||0);
const STATE = { tna:100, adminOpen:false };

function calcFrench(amount, months, tna){
  const i=(tna/100)/12; if(!amount||!months||!i) return {installment:0,total:0};
  const q=Math.pow(1+i,months); const installment=amount*i*q/(q-1);
  return {installment,total:installment*months};
}
function buildSchedule(amount, months, tna){
  const {installment}=calcFrench(amount,months,tna); const out=[]; let rem=amount;
  for(let i=0;i<months;i++){ const d=new Date(); d.setMonth(d.getMonth()+i+1); d.setDate(10);
    const interest=rem*((tna/100)/12); const capital=Math.max(0,installment-interest); rem=Math.max(0,rem-capital);
    out.push({due:d.toLocaleDateString('es-AR'),installment:Math.round(installment),capital:Math.round(capital),interest:Math.round(interest),paid:false});
  } return out;
}
function contractHTML(l){
  const rows=(l.schedule||[]).map((r,i)=>`<tr><td>${i+1}</td><td>${r.due}</td><td>${money(r.installment)}</td><td>${money(r.capital)}</td><td>${money(r.interest)}</td><td>${r.paid?'Pagada':'Pendiente'}</td></tr>`).join("");
  return `<h2 style="margin:0 0 6px 0">CONTRATO DE MUTUO — EstimaPres</h2>
  <div style="font-size:13px;line-height:1.5">Prestatario: ${l.borrower.name} (DNI ${l.borrower.dni}) — Email ${l.borrower.email}<br/>
  Capital: ${money(l.amount)} — Plazo: ${l.months} meses · TNA ${l.tna}% · Vencimientos día 10</div>
  <h3>Anexo — Cronograma</h3>
  <table border="1" cellspacing="0" cellpadding="6" style="border-collapse:collapse;font-size:13px">
  <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Capital</th><th>Interés</th><th>Estado</th></tr></thead><tbody>${rows}</tbody></table>`;
}
function openContract(l,title="Contrato_EstimaPres"){
  const w=window.open('','_blank','noopener'); w.document.write(`<html><head><meta charset="utf-8"><title>${title}</title></head><body style="font-family:Inter,Arial,sans-serif;padding:18px">${contractHTML(l)}</body></html>`); w.document.close(); try{w.print()}catch{}
}
async function shareOtp(otp){
  const text=`Tu código OTP para aceptar el contrato de EstimaPres es ${otp}`;
  if(navigator.share){ try{await navigator.share({text})}catch{} } else { window.open(`https://wa.me/?text=${encodeURIComponent(text)}`,'_blank'); }
}
function dotByLoan(l){
  const first=l.schedule?.[0]?.due; let color='green';
  if(first){ const [d,m,y]=first.split('/'); const due=new Date(+y,+m-1,+d); const diff=Math.floor((Date.now()-due)/86400000);
    color=diff>10?'red':(diff>=6?'yellow':'green'); }
  return color;
}// ========= Handlers UI =========
$('btnSim').onclick = ()=>{
  const amount=Number($('amount').value||0), months=Number($('months').value||0);
  if(!amount||!months) return alert('Ingresá monto y cuotas');
  const r=calcFrench(amount,months,STATE.tna);
  $('simText').innerHTML=`Monto: <b>${money(amount)}</b> · Cuotas: <b>${months}</b> · Cuota estimada: <b>${money(Math.round(r.installment))}</b>`;
  $('simResult').style.display='block';
};
$('btnRequest').onclick = async ()=>{
  try{
    const name=$('f_name').value.trim(), dni=$('f_dni').value.trim(), email=$('f_email').value.trim(), phone=$('f_phone').value.trim(), cbu=$('f_cbu').value.trim();
    const amount=Number($('amount').value||0), months=Number($('months').value||0);
    if(!name||!dni||!email||!phone||!cbu||!amount||!months) return alert('Completá todos los campos y simulá antes de enviar.');
    const otp=(''+Math.floor(100000+Math.random()*900000)); const schedule=buildSchedule(amount,months,STATE.tna);
    await addDoc(collection(db,'loans'),{createdAt:serverTimestamp(),status:'requested',amount,months,tna:STATE.tna,borrower:{name,dni,email,phone,cbu},otp,contractAccepted:false,depositDone:false,payments:[],schedule});
    $('reqHint').textContent='Listo. Un administrador revisará tu solicitud en 48 horas.'; alert('Solicitud enviada.'); loadPending();
  }catch(e){ alert('Error al enviar: '+e.message); }
};
$('btnMyLoan').onclick = ()=> $('dlgMyLoan').showModal();
$('btnFindLoan').onclick = async (ev)=>{
  ev.preventDefault();
  try{
    const dni=$('q_dni').value.trim(), otp=$('q_otp').value.trim(); if(!dni||!otp) return;
    const snap=await getDocs(query(collection(db,'loans'), where('borrower.dni','==',dni))); let found=null;
    snap.forEach(d=>{const l=d.data(); if(l.otp===otp) found={id:d.id,...l};});
    const box=$('mine');
    if(!found){ box.style.display='block'; box.innerHTML=`<div class="muted">No se encontró préstamo con ese DNI/OTP.</div>`; return; }
    if(!found.contractAccepted) await updateDoc(doc(db,'loans',found.id), {contractAccepted:true});
    const rows=(found.schedule||[]).map((r,i)=>`<tr><td>${i+1}</td><td>${r.due}</td><td>${money(r.installment)}</td><td>${r.paid?'Pagada':'Pendiente'}</td></tr>`).join('');
    box.style.display='block';
    box.innerHTML=`<div class="loan"><div class="hdr"><div><b>${found.borrower.name}</b> · Principal ${money(found.amount)} · ${found.months} cuotas · TNA ${found.tna}%</div>
      <div class="actions"><button class="btn ghost" onclick="viewLoan('${found.id}')">Contrato</button></div></div>
      <table border="1" cellspacing="0" cellpadding="6" style="border-collapse:collapse;width:100%;font-size:13px;margin-top:8px">
      <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead><tbody>${rows}</tbody></table></div>`;
  }catch(e){ alert('Error: '+e.message); }
};
$('btnAdmin').onclick = ()=>{
  STATE.adminOpen=!STATE.adminOpen;
  ['secRate','secPending','secPre','secActive','secInactive'].forEach(id=>{ const el=$(id); if(STATE.adminOpen) el.setAttribute('open',''); else el.removeAttribute('open'); });
};

// ========= Admin helpers =========
window.viewContract = async (id)=>{ const l=(await getDoc(doc(db,'loans',id))).data(); openContract(l); };
window.sendOtp = async (id)=>{ const l=(await getDoc(doc(db,'loans',id))).data(); await shareOtp(l.otp); alert('OTP compartido.'); };
window.markDeposit = async (id)=>{ await updateDoc(doc(db,'loans',id), {depositDone:true}); loadPre(); };
window.drop = async (id)=>{ if(!confirm('¿Rechazar solicitud?'))return; await deleteDoc(doc(db,'loans',id)); loadPending(); };
window.preapprove = async (id)=>{ await updateDoc(doc(db,'loans',id), {status:'preapproved'}); alert('Preaprobado creado'); loadPending(); loadPre(); };
window.approveLoan = async (id)=>{ const snap=await getDoc(doc(db,'loans',id)); const l=snap.data();
  if(!l.contractAccepted) return alert('Falta aceptación por OTP del cliente.'); if(!l.depositDone) return alert('Marcá el depósito antes de aprobar.');
  await updateDoc(doc(db,'loans',id), {status:'active',activeAt:serverTimestamp()}); loadPre(); loadActive();
};
window.viewLoan = async (id)=>{ const l=(await getDoc(doc(db,'loans',id))).data(); openContract(l,`Prestamo_${l.borrower?.dni}`); };
window.toBad = async (id)=>{ if(!confirm('¿Mover a incobrables?'))return; await updateDoc(doc(db,'loans',id), {status:'charged_off'}); loadActive(); loadInactive(); };
window.toDone = async (id)=>{ if(!confirm('¿Marcar como finalizado/pagado?'))return; await updateDoc(doc(db,'loans',id), {status:'finalized'}); loadActive(); loadInactive(); };
window.delLoan = async (id)=>{ if(!confirm('¿Eliminar definitivamente?'))return; await deleteDoc(doc(db,'loans',id)); loadInactive(); };

// ========= Listados (sin orderBy ⇒ no requiere índices) =========
async function loadTna(){
  const ref=doc(db,'settings','tna'); const snap=await getDoc(ref);
  if(snap.exists()){ STATE.tna=snap.data().value||100; } else { await setDoc(ref,{value:100,updatedAt:serverTimestamp()}); STATE.tna=100; }
  $('tnaLabel').textContent=STATE.tna+'%'; $('inpTna').value=STATE.tna;
}
$('btnSaveTna').onclick = async ()=>{
  const val=Number($('inpTna').value||0); if(!val||val<1) return alert('Ingresá una TNA válida');
  await setDoc(doc(db,'settings','tna'),{value:val,updatedAt:serverTimestamp()}); STATE.tna=val; $('tnaLabel').textContent=val+'%'; alert('TNA actualizada');
};
async function loadPending(){
  const t=$('pendingList'); t.textContent='Cargando…';
  try{ const qy=query(collection(db,'loans'), where('status','==','requested')); const snap=await getDocs(qy); const arr=[];
    snap.forEach(d=>arr.push({id:d.id,...d.data()}));
    t.innerHTML=arr.length? arr.map(l=>`<div class="loan"><div class="hdr">
      <div><b>${l.borrower?.name||'-'}</b> · DNI ${l.borrower?.dni||'-'} · ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%</div>
      <div class="actions"><button class="btn primary" onclick="preapprove('${l.id}')">Preaprobar</button><button class="btn red" onclick="drop('${l.id}')">Rechazar</button></div>
    </div><div class="muted">${l.borrower?.email||''} · ${l.borrower?.phone||''}</div></div>`).join('') : 'Sin solicitudes pendientes';
  }catch(e){ t.innerHTML=`<span class="muted">Error: ${e.message}</span>`; }
}
async function loadPre(){
  const t=$('preList'); t.textContent='Cargando…';
  try{ const s=await getDocs(query(collection(db,'loans'), where('status','==','preapproved'))); const arr=[]; s.forEach(d=>arr.push({id:d.id,...d.data()}));
    t.innerHTML=arr.length? arr.map(l=>`<div class="loan"><div class="hdr">
      <div><b>${l.borrower?.name}</b> · DNI ${l.borrower?.dni} · ${money(l.amount)} · ${l.months} cuotas</div>
      <div class="actions"><button class="btn ghost" onclick="viewContract('${l.id}')">Contrato</button><button class="btn" onclick="sendOtp('${l.id}')">Enviar OTP</button><button class="btn" onclick="markDeposit('${l.id}')">Depósito</button><button class="btn green" onclick="approveLoan('${l.id}')">Aprobar</button></div>
    </div><div class="muted">${l.borrower?.email} · ${l.borrower?.phone}</div></div>`).join('') : 'Sin preaprobados';
  }catch(e){ t.innerHTML=`<span class="muted">Error: ${e.message}</span>`; }
}
async function loadActive(){
  const t=$('activeList'); t.textContent='Cargando…';
  try{ const s=await getDocs(query(collection(db,'loans'), where('status','==','active'))); const arr=[]; s.forEach(d=>arr.push({id:d.id,...d.data()}));
    if(!arr.length){ t.textContent='Sin activos'; return; }
    const groups={green:[],yellow:[],red:[]}; arr.forEach(l=>groups[dotByLoan(l)].push(l));
    const grp=(a,title)=> a.length? `<div class="muted" style="margin:8px 0">${title}</div>`+a.map(l=>`
      <div class="loan"><div class="hdr"><div><span class="pill"><span class="dot ${dotByLoan(l)}"></span> ${dotByLoan(l)}</span>
      <b>${l.borrower?.name||''}</b> · DNI ${l.borrower?.dni||''} · Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%</div>
      <div class="actions"><button class="btn ghost" onclick="viewLoan('${l.id}')">Ver</button><button class="btn yellow" onclick="toBad('${l.id}')">A incobrables</button><button class="btn green" onclick="toDone('${l.id}')">Finalizar</button></div></div></div>`).join('') : '';
    t.innerHTML = grp(groups.green,'Verde') + grp(groups.yellow,'Amarillo') + grp(groups.red,'Rojo');
  }catch(e){ t.innerHTML=`<span class="muted">Error: ${e.message}</span>`; }
}
async function loadInactive(){
  const d1=$('doneList'), d2=$('badList'); d1.textContent=d2.textContent='Cargando…';
  try{ const s1=await getDocs(query(collection(db,'loans'), where('status','==','finalized'))); const a1=[]; s1.forEach(d=>a1.push({id:d.id,...d.data()}));
    d1.innerHTML=a1.length? a1.map(l=>`<div class="loan"><div class="hdr"><div><b>${l.borrower?.name}</b> · DNI ${l.borrower?.dni} · ${money(l.amount)} · ${l.months} cuotas</div>
    <div class="actions"><button class="btn ghost" onclick="viewLoan('${l.id}')">Ver</button><button class="btn red" onclick="delLoan('${l.id}')">Eliminar</button></div></div></div>`).join('') : 'Sin finalizados';
  }catch(e){ d1.innerHTML=`<span class="muted">Error: ${e.message}</span>`; }
  try{ const s2=await getDocs(query(collection(db,'loans'), where('status','==','charged_off'))); const a2=[]; s2.forEach(d=>a2.push({id:d.id,...d.data()}));
    d2.innerHTML=a2.length? a2.map(l=>`<div class="loan"><div class="hdr"><div><span class="dot red" style="display:inline-block"></span> <b>${l.borrower?.name}</b> · DNI ${l.borrower?.dni}</div>
    <div class="actions"><button class="btn ghost" onclick="viewContract('${l.id}')">PDF legal</button><button class="btn red" onclick="delLoan('${l.id}')">Eliminar</button></div></div></div>`).join('') : 'Sin incobrables';
  }catch(e){ d2.innerHTML=`<span class="muted">Error: ${e.message}</span>`; }
}

// ========= INIT =========
async function init(){
  try{
    const cfg = window.firebaseConfig || {
      apiKey: "TU_API_KEY",
      authDomain: "TU_AUTH_DOMAIN",
      projectId: "TU_PROJECT_ID",
      storageBucket: "TU_BUCKET",
      messagingSenderId: "TU_SENDER",
      appId: "TU_APP_ID"
    };
    if(!cfg.apiKey){ alert('Falta la configuración de Firebase (apiKey, projectId, etc.).'); return; }
    app=initializeApp(cfg); auth=getAuth(app); db=getFirestore(app);
    await signInAnonymously(auth);      // asegura request.auth != null
    await loadTna();
    await Promise.all([loadPending(),loadPre(),loadActive(),loadInactive()]);
  }catch(e){
    alert('Error inicializando la app: '+e.message);
    console.error(e);
  }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>