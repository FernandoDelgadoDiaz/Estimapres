<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EstimaPres ¬∑ Pr√©stamos personales</title>
<link rel="icon" href="assets/ping.png">
<link rel="apple-touch-icon" href="assets/ping.png">
<style>
  :root{
    --bg1:#0b5bd3;--bg2:#0a49a5;--brand:#0f1b2d;
    --panel:#ffffff;--muted:#6b7280;--ok:#16a34a;--warn:#d97706;--bad:#dc2626;
    --btn:#0f172a;--btn-text:#fff;--soft:#eef2ff;--chip:#0ea5e9;
    --shadow:0 10px 25px rgba(2,6,23,.08),0 4px 10px rgba(2,6,23,.06);
    --radius:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#f6f7fb;color:#0f172a}
  .wrap{max-width:980px;margin:0 auto;padding:0 16px}
  /* ====== HEADER (VALIDADO) ====== */
  .hero{
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    color:#fff; padding:28px 0 20px; box-shadow:var(--shadow); margin-bottom:26px;
  }
  .brand-row{display:flex;align-items:center;gap:14px;margin-bottom:10px}
  .brand-logo{width:56px;height:56px;border-radius:14px;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow)}
  .brand-logo img{width:48px;height:48px;object-fit:contain}
  .brand-title{font-weight:800;font-size:44px;letter-spacing:.4px}
  .slogan{display:inline-block;background:rgba(255,255,255,.14);backdrop-filter:blur(4px);padding:10px 18px;border-radius:14px;color:#e6ecff}
  .slogan em{font-style:normal;text-decoration:underline}
  .cta-row{display:flex;gap:14px;flex-wrap:wrap;margin-top:14px}
  .btn{border:0;border-radius:14px;padding:14px 18px;font-weight:700;cursor:pointer;box-shadow:var(--shadow);display:inline-flex;align-items:center;gap:10px}
  .btn-primary{background:#e6f0ff;color:#0b3aa5}
  .btn-ghost{background:#eaf1ff;color:#0b3aa5}
  .btn-danger{background:#ef4444;color:#fff}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  /* ====== TARJETAS ====== */
  .card{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;margin:18px 0}
  .h1{font-size:40px;font-weight:800;margin:4px 0 18px}
  .h2{font-size:28px;font-weight:800;margin:0 0 14px}
  label{display:block;margin:12px 0 6px;color:#1f2937;font-weight:600}
  input[type="text"], input[type="number"], input[type="email"], input[type="tel"]{
    width:100%;padding:16px 14px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;font-size:18px
  }
  .muted{color:var(--muted)}
  .btn-green{background:var(--ok);color:#fff;border-radius:14px;padding:14px 18px;border:0;font-weight:800;box-shadow:var(--shadow)}
  .btn-dark{background:var(--btn);color:var(--btn-text)}
  .list{display:flex;flex-direction:column;gap:12px}
  .item{background:#fff;border:1px solid #eef2ff;border-radius:14px;padding:14px 16px}
  .chip{display:inline-block;background:#eef2ff;color:#0b3aa5;padding:4px 10px;border-radius:999px;font-weight:700;font-size:13px}
  .chip-ok{background:#dcfce7;color:#166534}
  .chip-warn{background:#fef3c7;color:#92400e}
  .chip-bad{background:#fee2e2;color:#991b1b}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:14px;overflow:hidden}
  th,td{padding:12px 14px;border-bottom:1px solid #f1f5f9}
  th{text-align:left;background:#f8fafc;font-weight:800}
  .right{text-align:right}
  .center{text-align:center}
  @media (max-width:680px){
    .brand-title{font-size:38px}
    .btn{padding:12px 14px}
  }
</style>
</head>
<body>
  <header class="hero">
    <div class="wrap">
      <div class="brand-row">
        <!-- ICONO PING A LA IZQUIERDA DE 'EstimaPres' -->
        <div class="brand-logo"><img src="assets/ping.png" alt="EstimaPres"></div>
        <div class="brand-title">EstimaPres</div>
      </div>
      <div class="slogan">Pr√©stamos personales ¬∑ <em>simple y claro</em></div>
      <div class="cta-row">
        <button id="btnOpenMyLoan" class="btn btn-primary">üîé Ver mi pr√©stamo</button>
        <button id="btnAdmin" class="btn btn-ghost">üõ°Ô∏è Admin</button>
        <button id="btnLogout" class="btn btn-danger">‚Ü™ Salir</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- SIMULADOR -->
    <section class="card">
      <div class="h1">Simulador</div>
      <label>Monto</label>
      <input id="simAmount" inputmode="numeric" placeholder="$ 1.000.000">
      <label>Meses</label>
      <input id="simMonths" inputmode="numeric" placeholder="Ej: 12">
      <div class="muted" id="lblTnaInfo">TNA vigente: ‚Äî% ¬∑ Vencimiento: d√≠a 10</div>
      <div style="margin-top:14px"><button id="btnSim" class="btn-green">Simular</button></div>
      <div id="simTable" style="margin-top:16px"></div>
    </section>

    <!-- FORM SOLICITUD -->
    <section class="card">
      <div class="h1">Solicitar pr√©stamo</div>
      <label>Tu nombre</label><input id="fName" placeholder="Juan P√©rez">
      <label>DNI</label><input id="fDni" placeholder="30123456" inputmode="numeric">
      <label>Email</label><input id="fEmail" type="email" placeholder="tucorreo@mail.com">
      <label>Tel√©fono</label><input id="fPhone" type="tel" placeholder="11 2345 6789">
      <label>alias o CBU/CVU</label><input id="fCbu" placeholder="alias o CBU/CVU">
      <div style="margin-top:14px"><button id="btnSend" class="btn-green">Enviar solicitud</button></div>
      <div class="muted" style="margin-top:8px">Al enviar acept√°s ser contactado por EstimaPres.</div>
    </section>

    <!-- ADMIN -->
    <section id="adminPanel" class="card" style="display:none">
      <div class="h2">Panel administrador</div>

      <div class="card" style="margin:10px 0">
        <div class="h2" style="margin:0 0 8px">TNA</div>
        <input id="inpTna" inputmode="numeric" placeholder="150">
        <div style="margin-top:12px"><button id="btnSaveTna" class="btn btn-dark">Guardar</button></div>
      </div>

      <div class="card" style="margin:10px 0">
        <div class="h2" style="margin:0 0 12px">Solicitudes pendientes</div>
        <button id="btnReloadPend" class="btn">Recargar</button>
        <div id="listPend" class="list" style="margin-top:12px"></div>
      </div>

      <div class="card" style="margin:10px 0">
        <div class="h2" style="margin:0 0 12px">Preaprobados</div>
        <button id="btnReloadPre" class="btn">Recargar</button>
        <div id="listPre" class="list" style="margin-top:12px"></div>
      </div>

      <div class="card" style="margin:10px 0">
        <div class="h2" style="margin:0 0 12px">Activos</div>
        <button id="btnReloadAct" class="btn">Recargar</button>
        <div id="listAct" class="list" style="margin-top:12px"></div>
      </div>

      <div class="card" style="margin:10px 0">
        <div class="h2" style="margin:0 0 12px">Inactivos (finalizados / incobrables)</div>
        <div class="row">
          <button id="tabFinished" class="btn">Cancelados</button>
          <button id="tabCharged" class="btn">Incobrables</button>
          <button id="btnReloadInac" class="btn">Recargar</button>
        </div>
        <div id="listInac" class="list" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- VER MI PR√âSTAMO (USUARIO) -->
    <section class="card" id="myloanCard">
      <div class="h1">Ver mi pr√©stamo</div>
      <label>Ingres√° tu DNI</label>
      <input id="myDni" placeholder="Ej: 30123456" inputmode="numeric">
      <div style="margin-top:12px"><button id="btnFindMyLoan" class="btn btn-dark">Consultar</button></div>
      <div id="myLoanResult" style="margin-top:14px"></div>
    </section>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <script>
  /***** CONFIG FIREBASE (pegar tu config real) *****/
  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_AUTH_DOMAIN",
    projectId: "TU_PROJECT_ID",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /************ HELPERS ************/
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const onlyDigits = v => (v||"").replace(/\D+/g,"");
  const nowTS = () => firebase.firestore.Timestamp.now();
  const money = n => new Intl.NumberFormat("es-AR",{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Number(n||0));
  const shortDate = ts => {
    const d = (ts?.toDate?.() || new Date());
    return d.toLocaleDateString('es-AR',{day:'2-digit',month:'2-digit',year:'numeric'});
  };

  // calcula cuota simple (amortizaci√≥n + inter√©s simple por TNA/12)
  function scheduleRows(loan){
    const amount = Number(loan.amount);
    const months = Number(loan.months);
    const tna = Number(loan.tna);
    const vencDay = 10; // fijo como en versi√≥n validada
    const list = [];
    const monthlyInterest = tna/100/12;
    const cuota = Math.round(amount/months + amount*monthlyInterest);
    for(let i=1;i<=months;i++){
      const due = new Date();
      due.setMonth(due.getMonth()+i);
      due.setDate(vencDay);
      list.push({ n:i, due, amount:cuota, paid: (loan.paidCount||0) >= i });
    }
    return list;
  }

  function tableFromRows(rows){
    const tr = rows.map(r=>`
      <tr>
        <td class="center">${r.n}</td>
        <td>${r.due.toLocaleDateString('es-AR',{day:'2-digit',month:'2-digit',year:'numeric'})}</td>
        <td class="right">${money(r.amount)}</td>
        <td class="center">
          ${r.paid ? '<span class="chip chip-ok">Pagada</span>' : '<span class="chip chip-warn">Pendiente</span>'}
        </td>
      </tr>
    `).join("");
    return `<table>
      <thead><tr><th class="center">#</th><th>Vencimiento</th><th class="right">Cuota</th><th class="center">Estado</th></tr></thead>
      <tbody>${tr}</tbody>
    </table>`;
  }

  /************ HEADER actions ************/
  $("#btnLogout").onclick = ()=> location.reload();
  $("#btnAdmin").onclick = ()=> { $("#adminPanel").style.display="block"; window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); };
  $("#btnOpenMyLoan").onclick = ()=> { $("#myloanCard").scrollIntoView({behavior:'smooth'}); $("#myDni").focus(); };

  /************ SETTINGS (TNA) ************/
  async function loadSettings(){
    try{
      const s = await db.collection('settings').doc('global').get();
      const tna = Number(s.data()?.tna||0);
      $("#lblTnaInfo").textContent = `TNA vigente: ${tna}% ¬∑ Vencimiento: d√≠a 10`;
      $("#inpTna").value = tna || '';
    }catch(e){
      $("#lblTnaInfo").textContent = `TNA vigente: ‚Äî% ¬∑ Vencimiento: d√≠a 10`;
    }
  }
  $("#btnSaveTna").onclick = async ()=>{
    const tna = Number(onlyDigits($("#inpTna").value));
    if(!tna){ alert("Ingres√° TNA num√©rica"); return; }
    await db.collection('settings').doc('global').set({tna,updatedAt:nowTS()},{merge:true});
    await loadSettings();
    alert("TNA guardada");
  };

  /************ SIMULADOR ************/
  $("#btnSim").onclick = async ()=>{
    const a = Number(onlyDigits($("#simAmount").value));
    const m = Number(onlyDigits($("#simMonths").value));
    if(!a || !m){ alert("Complet√° Monto y Meses"); return; }
    const s = await db.collection('settings').doc('global').get();
    const tna = Number(s.data()?.tna||0);
    $("#lblTnaInfo").textContent = `TNA vigente: ${tna}% ¬∑ Vencimiento: d√≠a 10`;
    const rows = scheduleRows({amount:a, months:m, tna, paidCount:0});
    $("#simTable").innerHTML = tableFromRows(rows);
  };

  /************ SOLICITUD ************/
  $("#btnSend").onclick = async ()=>{
    const name = $("#fName").value.trim();
    const dni = onlyDigits($("#fDni").value);
    const email = $("#fEmail").value.trim();
    const phone = $("#fPhone").value.trim();
    const cbu = $("#fCbu").value.trim();
    if(!name||!dni||!email||!phone||!cbu){ alert("Complet√° todos los campos"); return; }
    const s = await db.collection('settings').doc('global').get();
    const tna = Number(s.data()?.tna||0);
    const amount = Number(onlyDigits($("#simAmount").value))||0;
    const months = Number(onlyDigits($("#simMonths").value))||0;
    if(!amount||!months){ alert("Antes de enviar, simul√° monto y meses"); return; }
    await db.collection('loans').add({
      amount, months, tna,
      borrower:{name, dni, email, phone, cbu},
      status:'pending',
      createdAt: nowTS(), updatedAt: nowTS()
    });
    alert("Solicitud enviada");
  };

  /************ ADMIN LISTADOS ************/
  async function loadPend(){
    const box = $("#listPend"); box.innerHTML="";
    try{
      const q = await db.collection('loans').where('status','==','pending').orderBy('createdAt','desc').limit(100).get();
      if(q.empty){ box.innerHTML = '<div class="muted">Sin pendientes</div>'; return; }
      q.forEach(doc=>{
        const d=doc.data(); d.id=doc.id;
        const el=document.createElement('div'); el.className='item';
        el.innerHTML = `
          <div style="font-weight:800">${d.borrower?.name||''} ¬∑ DNI ${d.borrower?.dni||''}</div>
          <div class="muted">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}%</div>
          <div class="row" style="margin-top:8px">
            <button class="btn btn-green" data-act="pre">Preaprobar</button>
            <button class="btn btn-danger" data-act="del">Eliminar</button>
          </div>
        `;
        el.querySelector('[data-act="pre"]').onclick = async ()=>{
          if(!confirm("¬øPreaprobar y generar contrato?")) return;
          const contractId = Math.random().toString(36).slice(2,10).toUpperCase();
          await db.collection('loans').doc(d.id).set({status:'preapproved', contractId, updatedAt:nowTS()},{merge:true});
          await loadAllAdmin();
          // Link para enviar por WhatsApp
          const link = location.origin + location.pathname + '#sign-' + d.id;
          navigator.clipboard.writeText(link).catch(()=>{});
          alert("Preaprobado. Envi√° este enlace para firma: " + link);
        };
        el.querySelector('[data-act="del"]').onclick = async ()=>{
          if(!confirm("¬øEliminar solicitud?")) return;
          await db.collection('loans').doc(d.id).set({status:'deleted',updatedAt:nowTS()},{merge:true});
          await loadAllAdmin();
        };
        box.appendChild(el);
      });
    }catch(e){ box.innerHTML='<div class="muted">No se pudieron leer las solicitudes (reglas/√≠ndices).</div>'; }
  }
  async function loadPre(){
    const box = $("#listPre"); box.innerHTML="";
    try{
      const q = await db.collection('loans').where('status','==','preapproved').orderBy('updatedAt','desc').limit(100).get();
      if(q.empty){ box.innerHTML = '<div class="muted">Sin preaprobados</div>'; return; }
      q.forEach(doc=>{
        const d=doc.data(); d.id=doc.id;
        const signed = d.signed ? '<span class="chip chip-ok">Firmado</span>' : '<span class="chip chip-warn">Esperando firma</span>';
        const el=document.createElement('div'); el.className='item';
        el.innerHTML=`
          <div style="font-weight:800">${d.borrower?.name||''} ¬∑ DNI ${d.borrower?.dni||''} ${signed}</div>
          <div class="muted">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}% ¬∑ Contrato ${d.contractId||''}</div>
          <div class="row" style="margin-top:8px">
            <button class="btn" data-act="pdf">Contrato PDF</button>
            <button class="btn btn-green" data-act="ok"${d.signed?'':' disabled'}>Aprobar y depositar</button>
            <button class="btn btn-danger" data-act="del">Eliminar</button>
          </div>
        `;
        el.querySelector('[data-act="pdf"]').onclick = ()=> openContract(d,true);
        el.querySelector('[data-act="ok"]').onclick = async ()=>{
          if(!confirm("¬øAprobar y pasar a Activo?")) return;
          await db.collection('loans').doc(d.id).set({status:'active', activeAt:nowTS(), updatedAt:nowTS(), paidCount:d.paidCount||0},{merge:true});
          await loadAllAdmin();
        };
        el.querySelector('[data-act="del"]').onclick = async ()=>{
          if(!confirm("¬øEliminar?")) return;
          await db.collection('loans').doc(d.id).set({status:'deleted',updatedAt:nowTS()},{merge:true});
          await loadAllAdmin();
        };
        box.appendChild(el);
      });
    }catch(e){ box.innerHTML='<div class="muted">No se pudieron leer (reglas/√≠ndices).</div>'; }
  }
  async function loadAct(){
    const box = $("#listAct"); box.innerHTML="";
    try{
      const q = await db.collection('loans').where('status','==','active').orderBy('activeAt','desc').limit(100).get();
      if(q.empty){ box.innerHTML='<div class="muted">Sin activos</div>'; return; }
      q.forEach(doc=>{
        const d=doc.data(); d.id=doc.id;
        const el = document.createElement('div'); el.className='item';
        const rows = scheduleRows(d);
        const paid = Number(d.paidCount||0);
        const progress = `${paid}/${d.months}`;
        el.innerHTML = `
          <div style="font-weight:800">${d.borrower?.name||''} ¬∑ DNI ${d.borrower?.dni||''}</div>
          <div class="muted">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}% ¬∑ Progreso <b>${progress}</b></div>
          <div style="margin:8px 0">${tableFromRows(rows)}</div>
          <div class="row" style="margin-top:8px">
            <button class="btn btn-green" data-act="payall"${paid<d.months?' disabled':''}>Pagado total</button>
            <button class="btn btn-danger" data-act="bad">A incobrables</button>
          </div>
        `;
        // Marcar cuotas una por una
        el.querySelectorAll('tbody tr').forEach((tr,idx)=>{
          const i = idx+1;
          if(i<=paid) return; // ya pagada
          const cell = tr.lastElementChild;
          const btn = document.createElement('button');
          btn.className='btn'; btn.textContent='Marcar pagada';
          btn.onclick = async ()=>{
            await db.collection('loans').doc(d.id).set({paidCount:i, updatedAt:nowTS()},{merge:true});
            await loadAct();
          };
          cell.innerHTML=''; cell.appendChild(btn);
        });
        el.querySelector('[data-act="payall"]').onclick = async ()=>{
          if(paid<d.months){ alert("No pod√©s finalizar si faltan cuotas"); return; }
          if(!confirm("¬øFinalizar (pagado total)?")) return;
          await db.collection('loans').doc(d.id).set({status:'finished', updatedAt:nowTS()},{merge:true});
          await loadAllAdmin();
        };
        el.querySelector('[data-act="bad"]').onclick = async ()=>{
          if(!confirm("¬øPasar a incobrables?")) return;
          await db.collection('loans').doc(d.id).set({status:'charged_off', updatedAt:nowTS()},{merge:true});
          await loadAllAdmin();
        };
        box.appendChild(el);
      });
    }catch(e){ box.innerHTML='<div class="muted">No se pudieron leer (reglas/√≠ndices).</div>'; }
  }
  let inactiveTab = 'finished';
  async function loadInac(){
    const box = $("#listInac"); box.innerHTML="";
    try{
      const q = await db.collection('loans').where('status','==',inactiveTab).orderBy('updatedAt','desc').limit(100).get();
      if(q.empty){ box.innerHTML='<div class="muted">Sin inactivos</div>'; return; }
      q.forEach(doc=>{
        const d=doc.data(); d.id=doc.id;
        const el=document.createElement('div'); el.className='item';
        const badge = d.status==='charged_off' ? '<span class="chip chip-bad">incobrable</span>' : '<span class="chip chip-ok">cancelado</span>';
        el.innerHTML = `
          <div style="font-weight:800">${d.borrower?.name||''} ¬∑ DNI ${d.borrower?.dni||''} ¬∑ ${badge}</div>
          <div class="muted">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}% ¬∑ Contrato ${d.contractId||''}</div>
        `;
        box.appendChild(el);
      });
    }catch(e){ box.innerHTML='<div class="muted">No se pudieron leer.</div>'; }
  }
  async function loadAllAdmin(){ await Promise.all([loadPend(),loadPre(),loadAct(),loadInac()]); }

  $("#btnReloadPend").onclick = loadPend;
  $("#btnReloadPre").onclick  = loadPre;
  $("#btnReloadAct").onclick  = loadAct;
  $("#btnReloadInac").onclick = loadInac;
  $("#tabFinished").onclick = ()=>{inactiveTab='finished'; loadInac();};
  $("#tabCharged").onclick  = ()=>{inactiveTab='charged_off'; loadInac();};

  /************ CONTRATO / FIRMA ************/
  function openContract(loan, onlyPdf){
    // HTML A4 simple (el tama√±o A4 lo maneja el print del navegador)
    const pdfHTML = `
      <html>
      <head><meta charset="utf-8"><title>Contrato</title>
      <style>
        body{font-family:Arial,Helvetica,sans-serif;padding:30px;line-height:1.45}
        h1{margin:0 0 10px;font-size:22px}
        .muted{color:#555}
        .btn{padding:10px 14px;border:0;border-radius:8px;background:#0f172a;color:#fff;font-weight:700}
        .box{margin-top:18px;padding:14px;border:1px solid #e5e7eb;border-radius:10px}
      </style></head>
      <body>
        <h1>Contrato N¬∞ ${loan.contractId||'-'}</h1>
        <div class="muted">${loan.borrower?.name} ‚Äî DNI ${loan.borrower?.dni}</div>
        <div class="box">
          Monto: <b>${money(loan.amount)}</b><br>
          Cuotas: <b>${loan.months}</b><br>
          TNA: <b>${loan.tna}%</b>
        </div>
        ${onlyPdf ? '' : `
        <div class="box">
          <label>Escrib√≠ tu nombre y apellido para aceptar</label><br>
          <input id="signName" style="padding:10px 12px;border:1px solid #ddd;border-radius:8px;width:100%" placeholder="Tu nombre completo">
          <div style="margin-top:12px"><button id="btnAccept" class="btn">Contrato aceptado</button></div>
        </div>`}
        <script>
          ${onlyPdf ? '' : `
          document.getElementById('btnAccept').onclick = ()=>{
            const v = (document.getElementById('signName').value||'').trim();
            if(!v){ alert('Escrib√≠ tu nombre y apellido'); return; }
            window.opener?.postMessage({type:'signed', id:'${loan.id}', value:v}, '*');
            alert('¬°Contrato aceptado!');
            window.close();
          };`}
        <\/script>
      </body></html>`;
    const w = window.open('about:blank','_blank');
    w.document.write(pdfHTML); w.document.close();
  }

  // recibir firma desde popup
  window.addEventListener('message', async (ev)=>{
    if(ev.data?.type==='signed' && ev.data.id){
      try{
        await db.collection('loans').doc(ev.data.id).set({
          signed:true, signedName:ev.data.value, signedAt:nowTS(), updatedAt:nowTS()
        },{merge:true});
        alert('Firma registrada. Pod√©s aprobar desde el panel.');
        loadAllAdmin();
      }catch(e){ alert('No se pudo guardar la firma.'); }
    }
  });

  // abrir ventana de firma si viene con hash #sign-{id}
  async function tryOpenSignFromHash(){
    if(!location.hash.startsWith('#sign-')) return;
    const id = location.hash.replace('#sign-','').trim();
    const snap = await db.collection('loans').doc(id).get();
    if(!snap.exists) return;
    const L = snap.data(); L.id = id;
    openContract(L,false);
  }

  /************ VER MI PR√âSTAMO (USUARIO) ************/
  $("#btnFindMyLoan").onclick = async ()=>{
    const dni = onlyDigits($("#myDni").value);
    if(!dni){ $("#myLoanResult").innerHTML='<div class="muted">Ingres√° un DNI.</div>'; return; }
    $("#myLoanResult").innerHTML='<div class="muted">Buscando...</div>';
    const s = await db.collection('loans').orderBy('createdAt','desc').limit(80).get();
    const results = [];
    s.forEach(d=>{
      const L = d.data();
      if((L?.borrower?.dni||'')===dni) results.push({id:d.id,...L});
    });
    if(!results.length){ $("#myLoanResult").innerHTML='<div class="muted">No encontramos pr√©stamos activos o preaprobados para ese DNI.</div>'; return; }
    const L = results[0];
    const rows = scheduleRows(L);
    const paid = Number(L.paidCount||0);
    const progress = `${paid}/${L.months}`;
    $("#myLoanResult").innerHTML = `
      <div class="item">
        <div style="font-weight:800">Estado: ${L.status}</div>
        <div class="muted">Monto: ${money(L.amount)} ¬∑ Cuotas: ${L.months} ¬∑ TNA: ${L.tna}% ¬∑ Progreso <b>${progress}</b></div>
        <button id="btnMyPdf" class="btn" style="margin:10px 0">Contrato PDF</button>
        ${tableFromRows(rows)}
      </div>
    `;
    $("#btnMyPdf").onclick = ()=> openContract({id:L.id, ...L}, true);
  };

  /************ INIT ************/
  (async function init(){
    await loadSettings();
    await tryOpenSignFromHash();
  })();
  </script>
</body>
</html>