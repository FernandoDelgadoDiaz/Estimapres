<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>EstimaPres · Préstamos en ARS</title>
  <meta name="theme-color" content="#0b1f3a" />
  <style>
    :root{
      --bg:#0b1f3a; --brand:#1b4b91; --fg:#0f172a; --muted:#6b7280;
      --primary:#0b4ea2; --primary-ink:#fff; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
      --card:#ffffff; --edge:#e5e7eb; --radius:16px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:#f6f8fb;color:var(--fg);font:16px/1.45 system-ui,Segoe UI,Inter,Roboto,Arial}
    .topbar{position:sticky;top:0;z-index:30;display:flex;gap:12px;align-items:center;justify-content:space-between;background:var(--bg);color:#fff;padding:12px 16px;box-shadow:0 2px 10px rgba(0,0,0,.12)}
    .brand{display:flex;align-items:center;gap:12px}
    .badge{width:36px;height:36px;border-radius:10px;background:var(--brand);display:grid;place-items:center;color:#fff;font-weight:700}
    .title{font-weight:800;font-size:18px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{height:42px;border-radius:12px;padding:0 16px;border:1px solid transparent;background:#e5e7eb;color:#111;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--primary);color:var(--primary-ink)}
    .btn.outline{background:transparent;border-color:#90caf9;color:#e3f2fd}
    .btn.light{background:#e3f2fd;color:#0b4ea2;border-color:#b6e0fe}
    .btn.danger{background:#ffe5e5;color:#9d0b0b;border-color:#ffc7c7}
    .btn.ok{background:var(--ok);color:#fff}
    .btn.warn{background:var(--warn);color:#111}
    .btn.bad{background:var(--bad);color:#fff}
    .container{max-width:960px;margin:24px auto;padding:0 16px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid var(--edge);border-radius:var(--radius);box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .card>h2{margin:0;padding:16px 16px 0}
    .grid{display:grid;gap:12px;padding:12px 16px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    .form{display:grid;gap:12px;padding:12px 16px}
    label{display:grid;gap:6px;font-weight:600}
    input{height:44px;border-radius:12px;border:1px solid var(--edge);padding:0 12px;font:inherit}
    input:focus{outline:2px solid #c7ddff;border-color:#9ec5ff}
    .result{padding:12px 16px;color:var(--muted)}
    .muted{color:var(--muted)}
    details.fold{border-top:1px solid var(--edge)}
    .fold>summary{list-style:none;padding:16px 16px;font-weight:800;cursor:pointer;display:flex;align-items:center;gap:8px}
    .fold>summary::before{content:"▸";transition:transform .2s}
    .fold[open]>summary::before{transform:rotate(90deg)}
    .pad{padding:12px 16px}
    .small{color:var(--muted);font-size:14px}
    .stack{display:grid;gap:12px}
    .cardlet{border:1px solid var(--edge);border-radius:14px;padding:12px;background:#fff;display:grid;gap:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .tag{display:inline-flex;gap:8px;align-items:center;border-radius:999px;padding:4px 10px;background:#eef2ff;color:#111;font-weight:700}
    .dot{width:10px;height:10px;border-radius:999px;background:#bbb}
    .dot.green{background:#16a34a}.dot.yellow{background:#f59e0b}.dot.red{background:#ef4444}
    .actions-row{display:flex;gap:10px;flex-wrap:wrap}
    .hr{height:1px;background:var(--edge);margin:4px 0}
    .details{background:#fafafa;border-radius:12px;border:1px dashed var(--edge);padding:8px 10px}
    .table{width:100%;border-collapse:collapse;font-size:14px}
    .table th,.table td{border-bottom:1px solid var(--edge);padding:6px 8px;text-align:right}
    .table th:first-child,.table td:first-child{text-align:left}
    .badge-sm{padding:4px 8px;border-radius:999px;background:#f3f4f6;color:#111}
    .hidden{display:none}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand"><div class="badge">E</div><div class="title">EstimaPres</div></div>
    <div class="actions">
      <button id="btnMyLoan" class="btn outline">Ver mi préstamo</button>
      <button id="btnAdmin" class="btn light">Admin</button>
      <button id="btnSignOut" class="btn danger" hidden>Salir</button>
    </div>
  </header>

  <main class="container">
    <!-- Simulador -->
    <section class="card">
      <h2>Simulador (pesos argentinos)</h2>
      <div class="grid">
        <label>Monto (ARS)
          <input id="simAmount" type="number" min="10000" step="1000" placeholder="Ej: 200000" />
        </label>
        <label>Cuotas (meses)
          <input id="simMonths" type="number" min="3" max="36" step="1" placeholder="Ej: 12" />
        </label>
      </div>
      <p class="muted">TNA vigente: <span id="tnaLabel">—</span> · Vencimiento: día <span id="dueDayLabel">10</span></p>
      <button id="btnSimulate" class="btn primary">Simular</button>
      <div id="simResult" class="result">—</div>
    </section>

    <!-- Solicitud -->
    <section class="card">
      <h2>Solicitar préstamo</h2>
      <form id="requestForm" class="form">
        <label>Nombre y apellido
          <input id="rqName" placeholder="Tu nombre" required />
        </label>
        <label>DNI
          <input id="rqDni" inputmode="numeric" placeholder="30123456" required />
        </label>
        <label>Email
          <input id="rqEmail" type="email" placeholder="tucorreo@dominio.com" required />
        </label>
        <label>Celular
          <input id="rqPhone" inputmode="tel" placeholder="11 2345 6789" required />
        </label>
        <label>CBU / CVU o Alias (depósito)
          <input id="rqCbu" placeholder="alias o CBU/CVU" required />
        </label>
        <button class="btn primary" id="btnSendRequest">Enviar solicitud</button>
      </form>
    </section>

    <!-- Panel de administrador -->
    <section class="card" id="adminPanel" hidden>
      <h2>Panel de administrador</h2>

      <details class="fold" open>
        <summary>1) Tasa centralizada (TNA %)</summary>
        <div class="pad">
          <label>TNA actual (%)
            <input id="adminTna" type="number" step="0.01" />
          </label>
          <button id="btnSaveTna" class="btn primary">Guardar</button>
          <p class="small">Impacta en el simulador; cada préstamo conserva su TNA al aprobar.</p>
        </div>
      </details>

      <details class="fold">
        <summary>2) Solicitudes pendientes</summary>
        <div class="pad" id="pendingList">Cargando…</div>
      </details>

      <details class="fold">
        <summary>3) Preaprobados (Contrato / Firma OTP / Depósito)</summary>
        <div class="pad" id="preList">Cargando…</div>
      </details>

      <details class="fold">
        <summary>4) Préstamos activos (agrupados por semáforo)</summary>
        <div class="pad small">Verde: al día · Amarillo: 6–10 días mora · Rojo: &gt;10 días mora</div>
        <div class="pad" id="activeList">Cargando…</div>
      </details>

      <details class="fold">
        <summary>5) Inactivos (finalizados / incobrables)</summary>
        <div class="pad">
          <h3>Finalizados (pagados)</h3>
          <div id="finishedList" class="stack">Cargando…</div>
          <h3>Incobrables</h3>
          <div id="chargedList" class="stack">Cargando…</div>
        </div>
      </details>
    </section>
  </main><!-- Firebase JS SDK (v10 módulos) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs,
      updateDoc, deleteDoc, query, where, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // === CONFIG FIREBASE REAL CORREGIDA ===
    const firebaseConfig = {
      apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
      authDomain: "estimapres.firebaseapp.com",
      projectId: "estimapres",
      storageBucket: "estimapres.appspot.com",
      messagingSenderId: "578516597437",
      appId: "1:578516597437:web:f59994b87729aa1cd655d4"
    };

    // --- Inicialización Firebase ---
    let app, db, auth;
    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
    } catch (e) {
      alert("Error inicializando la app:\n" + e);
      throw e;
    }

    // --- Helpers/UI ---
    const $ = (id)=>document.getElementById(id);
    const money = (n)=> n.toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const dueDay = 10; $("dueDayLabel").textContent = String(dueDay);
    const allowedAdmins = ["fernandogastondelgado81@gmail.com"]; // podés agregar más

    // --- TNA centralizada (config/general) ---
    async function loadTna(){
      const ref = doc(db,"config","general");
      const snap = await getDoc(ref);
      let tna = 100;
      if(snap.exists()) tna = Number(snap.data().tna)||tna; else await setDoc(ref,{tna});
      $("tnaLabel").textContent = `${tna}%`;
      $("adminTna").value = tna;
    }
    async function saveTna(){
      const val = Number($("adminTna").value||0);
      await setDoc(doc(db,"config","general"), { tna: val }, { merge:true });
      $("tnaLabel").textContent = `${val}%`;
      alert("TNA guardada.");
    }
    $("btnSaveTna").onclick = saveTna;

    // --- Simulador (sistema francés) ---
    const monthlyPayment = (P,tna,n)=>{
      const r=(tna/100)/12; return Math.round(P*(r/(1-Math.pow(1+r,-n))));
    };
    $("btnSimulate").onclick = ()=>{
      const P = Number($("simAmount").value||0);
      const n = Number($("simMonths").value||0);
      const tna = Number($("adminTna").value||$("tnaLabel").textContent.replace("%",""));
      if(!P||!n) return alert("Completá monto y cuotas.");
      const c = monthlyPayment(P,tna,n);
      $("simResult").innerHTML = `<div class="details"><b>Cuota estimada:</b> ${money(c)} · Total aprox: ${money(c*n)}<br><span class="small">Sistema francés. La tasa puede cambiar hasta la aprobación.</span></div>`;
    };

    // --- Enviar solicitud (loan_requests) ---
    $("btnSendRequest").onclick = async (e)=>{
      e.preventDefault();
      const amount = Number($("simAmount").value||0);
      const months = Number($("simMonths").value||0);
      const borrower = {
        name:$("rqName").value.trim(),
        dni:$("rqDni").value.trim(),
        email:$("rqEmail").value.trim(),
        phone:$("rqPhone").value.trim(),
        cbu:$("rqCbu").value.trim()
      };
      if(!amount||!months||!borrower.name||!borrower.dni||!borrower.email||!borrower.phone||!borrower.cbu){
        return alert("Completá todos los campos y simulá primero.");
      }
      const tSnap = await getDoc(doc(db,"config","general"));
      const tna = tSnap.exists()? Number(tSnap.data().tna):100;
      await addDoc(collection(db,"loan_requests"),{
        borrower, amount, months, tna, createdAt: serverTimestamp()
      });
      alert("Solicitud enviada. Un admin la revisará (hasta 48 hs).");
    };

    // --- Auth + Admin ---
    const provider = new GoogleAuthProvider();
    $("btnAdmin").onclick = async ()=>{
      if(!auth.currentUser){
        await signInWithPopup(auth,provider).catch(err=>alert(err.message));
      }else{
        $("adminPanel").hidden = !$("adminPanel").hidden;
      }
    };
    $("btnSignOut").onclick = ()=>signOut(auth);

    onAuthStateChanged(auth, async (user)=>{
      const isAdmin = !!user && allowedAdmins.includes(user.email||"");
      $("btnSignOut").hidden = !user;
      $("btnAdmin").textContent = user? "Admin" : "Ingresar";
      $("adminPanel").hidden = !isAdmin;
      if(isAdmin){ await loadTna(); loadPending(); loadPre(); loadActive(); loadInactive(); }
    });

    // --- Utilidades ---
    const otp6 = ()=>String(Math.floor(100000+Math.random()*900000));
    const shareWhats = (text)=> window.open(`https://wa.me/?text=${encodeURIComponent(text)}`,'_blank');

    // ================================
    // 2) SOLICITUDES PENDIENTES (ADMIN)
    // ================================
    async function loadPending(){
      const box = $("pendingList"); box.textContent = "Cargando…";
      const snap = await getDocs(query(collection(db,"loan_requests")));
      if(snap.empty){ box.textContent="Sin solicitudes pendientes"; return; }
      box.innerHTML = "";
      snap.forEach(d=>{
        const v=d.data();
        const el=document.createElement("div");
        el.className="cardlet";
        el.innerHTML=`
          <div class="row"><span class="tag"><span class="dot yellow"></span>Pendiente</span>
            <span class="badge-sm">${v.borrower.name} · DNI ${v.borrower.dni}</span>
          </div>
          <div>Principal ${money(v.amount)} · ${v.months} cuotas · TNA ${v.tna}%</div>
          <div class="actions-row">
            <button class="btn primary">Preaprobar</button>
            <button class="btn bad">Rechazar</button>
          </div>`;
        el.querySelector(".btn.primary").onclick = ()=> preapprove(d.id,v);
        el.querySelector(".btn.bad").onclick = async ()=>{
          if(!confirm("¿Rechazar solicitud?")) return;
          await deleteDoc(doc(db,"loan_requests",d.id));
          loadPending();
        };
        box.appendChild(el);
      });
    }
    async function preapprove(id,v){
      const code = otp6();
      await addDoc(collection(db,"loans"),{
        ...v, status:"preapproved", otp:code,
        contractAccepted:false, depositDone:false,
        paidCount:0, dueDay, createdAt: serverTimestamp()
      });
      await deleteDoc(doc(db,"loan_requests",id));
      alert("Preaprobado creado.");
      shareWhats(`Hola ${v.borrower.name}, tu préstamo fue PRE-APROBADO.\nOTP/Firma: ${code}\nIngresá a EstimaPres y usá ese código para aceptar el contrato.`);
      loadPending(); loadPre();
    }// ===========================
    // 3) PREAPROBADOS (ADMIN)
    // ===========================
    async function loadPre(){
      const box = $("preList"); box.textContent = "Cargando…";
      const snap = await getDocs(query(collection(db,"loans"), where("status","==","preapproved")));
      if(snap.empty){ box.textContent="Sin preaprobados"; return; }
      box.innerHTML = "";
      snap.forEach(d=>{
        const l=d.data(), id=d.id;
        const el=document.createElement("div");
        el.className="cardlet";
        el.innerHTML=`
          <div class="row"><span class="tag"><span class="dot yellow"></span>Preaprobado</span> <b>${l.borrower.name}</b> · DNI ${l.borrower.dni}</div>
          <div>Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%</div>
          <div class="actions-row">
            <button class="btn">Contrato (PDF)</button>
            <button class="btn light">Enviar OTP</button>
            <button class="btn warn">Depósito hecho</button>
            <button class="btn ok">Aprobar</button>
            <button class="btn bad">Eliminar</button>
          </div>
          <div class="small">Contrato: ${l.contractAccepted?"ACEPTADO ✅":"Pendiente"} · Depósito: ${l.depositDone?"Hecho ✅":"Pendiente"}</div>`;
        el.querySelectorAll("button")[0].onclick = ()=> openContract(id,l);
        el.querySelectorAll("button")[1].onclick = ()=> shareWhats(`OTP/Firma para EstimaPres: ${l.otp}`);
        el.querySelectorAll("button")[2].onclick = async ()=>{ await updateDoc(doc(db,"loans",id),{depositDone:true}); loadPre(); };
        el.querySelectorAll("button")[3].onclick = async ()=>{
          const s=await getDoc(doc(db,"loans",id)); const L=s.data();
          if(!L.contractAccepted) return alert("Falta firma OTP del cliente.");
          if(!L.depositDone) return alert("Marcá el depósito antes de aprobar.");
          await updateDoc(doc(db,"loans",id),{status:"active",activeAt:serverTimestamp()});
          loadPre(); loadActive();
        };
        el.querySelectorAll("button")[4].onclick = async ()=>{
          if(!confirm("¿Eliminar preaprobado?")) return;
          await deleteDoc(doc(db,"loans",id)); loadPre();
        };
        box.appendChild(el);
      });
    }
    function openContract(id,l){
      const html = `
        <html><head><meta charset="utf-8"><title>Contrato ${id}</title>
        <style>body{font:14px/1.5 system-ui;padding:24px} h1{font-size:20px} .muted{color:#666}</style></head>
        <body>
          <h1>Contrato de Préstamo — EstimaPres</h1>
          <p class="muted">ID: ${id}</p>
          <p>Entre EstimaPres (prestamista) y <b>${l.borrower.name}</b> (DNI ${l.borrower.dni}).</p>
          <ul>
            <li>Monto: <b>${money(l.amount)}</b></li>
            <li>Plazo: <b>${l.months} cuotas</b></li>
            <li>TNA: <b>${l.tna}%</b></li>
            <li>Vencimiento mensual: día <b>${l.dueDay||10}</b></li>
          </ul>
          <p>Para aceptar el contrato el cliente debe ingresar el código OTP: <b>${l.otp}</b>.</p>
          <script>window.onload=()=>{window.print();}</script>
        </body></html>`;
      const w = window.open("about:blank","_blank"); w.document.write(html); w.document.close();
    }

    // ===========================
    // 4) ACTIVOS (ADMIN)
    // ===========================
    const cuotaMensual = (P,tna,n)=>Math.round(P*((tna/100)/12)/(1-Math.pow(1+(tna/100)/12,-n)));
    function dotByLoan(l){
      const today=new Date();
      const nextDue = new Date(today.getFullYear(), today.getMonth(), l.dueDay||10);
      if(today.getDate()<= (l.dueDay||10)) nextDue.setMonth(today.getMonth()); else nextDue.setMonth(today.getMonth()+1);
      const diff = Math.floor((today - nextDue)/(1000*60*60*24));
      if(diff<=0) return "green"; if(diff<=10) return "yellow"; return "red";
    }
    function renderSchedule(l){
      const cuota = cuotaMensual(l.amount,l.tna,l.months);
      const paid = Number(l.paidCount||0);
      const rows = Array.from({length:l.months},(_,i)=>{
        const n=i+1, pagada = n<=paid;
        return `<tr>
          <td>#${n}</td>
          <td>${(l.dueDay||10).toString().padStart(2,"0")}/${((new Date().getMonth()+n)%12+1).toString().padStart(2,"0")}</td>
          <td>${money(cuota)}</td>
          <td>${pagada?"Pagada ✅":`<button class="btn light" data-pay="${n}" data-id="${l.id}">Marcar pagada</button>`}</td>
        </tr>`;
      }).join("");
      return `<table class="table"><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead><tbody>${rows}</tbody></table>`;
    }
    function renderActive(l){
      return `
      <div class="cardlet" id="card-${l.id}">
        <div class="row">
          <span class="tag"><span class="dot ${dotByLoan(l)}"></span>Activo</span>
          <b>${l.borrower.name}</b> · DNI ${l.borrower.dni}
          <span class="badge-sm">Estado: ${l.status}</span>
        </div>
        <div>Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%</div>
        <div class="actions-row">
          <button class="btn" data-act="ver" data-id="${l.id}">Ver</button>
          <button class="btn warn" data-act="inc" data-id="${l.id}">A incobrables</button>
          <button class="btn ok" data-act="fin" data-id="${l.id}">Finalizar</button>
        </div>
        <div class="details hidden" id="det-${l.id}">
          ${renderSchedule(l)}
        </div>
      </div>`;
    }
    async function loadActive(){
      const box=$("activeList"); box.textContent="Cargando…";
      const snap=await getDocs(query(collection(db,"loans"), where("status","==","active")));
      if(snap.empty){ box.textContent="Sin activos"; return; }
      const items=[]; snap.forEach(d=>items.push({id:d.id,...d.data()}));
      const groups={green:[],yellow:[],red:[]};
      items.forEach(l=>groups[dotByLoan(l)].push(l));
      box.innerHTML = ["green","yellow","red"].map(color=>{
        if(!groups[color].length) return "";
        const title = color==="green"?"Verde (al día)":color==="yellow"?"Amarillo (6–10 días)":"Rojo (>10 días)";
        return `
          <div class="hr"></div>
          <div class="row"><span class="dot ${color}"></span><b>${title}</b></div>
          <div class="stack">${groups[color].map(renderActive).join("")}</div>`;
      }).join("");
    }
    // Acciones sobre activos (delegación)
    document.addEventListener("click", async (ev)=>{
      const b=ev.target.closest("button"); if(!b) return;
      if(b.dataset.act==="ver"){ $("det-"+b.dataset.id).classList.toggle("hidden"); }
      if(b.dataset.act==="inc"){
        if(!confirm("¿Pasar a incobrables?"))return;
        await updateDoc(doc(db,"loans",b.dataset.id),{status:"charged_off"}); loadActive(); loadInactive();
      }
      if(b.dataset.act==="fin"){
        if(!confirm("¿Marcar como finalizado (pagado total)?"))return;
        await updateDoc(doc(db,"loans",b.dataset.id),{status:"finished"}); loadActive(); loadInactive();
      }
      if(b.dataset.pay){
        const id=b.dataset.id; const s=await getDoc(doc(db,"loans",id));
        const paid=Number(s.data().paidCount||0);
        await updateDoc(doc(db,"loans",id),{paidCount:paid+1});
        const l={...s.data(),id,paidCount:paid+1};
        $("det-"+id).innerHTML=renderSchedule(l);
      }
    });

    // ===========================
    // 5) INACTIVOS (ADMIN)
    // ===========================
    async function loadInactive(){
      const fin=$("finishedList"), chg=$("chargedList");
      fin.textContent=chg.textContent="Cargando…";

      const s1=await getDocs(query(collection(db,"loans"), where("status","==","finished")));
      fin.innerHTML = s1.empty? "Sin finalizados" : "";
      s1.forEach(d=>{
        const l=d.data(); const el=document.createElement("div"); el.className="cardlet";
        el.innerHTML=`<div class="row"><span class="tag"><span class="dot green"></span>Finalizado</span> <b>${l.borrower.name}</b> · DNI ${l.borrower.dni}</div>
                      <div>Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%</div>
                      <div class="actions-row"><button class="btn bad" data-del="${d.id}">Eliminar</button></div>`;
        el.querySelector("[data-del]").onclick = async ()=>{
          if(!confirm("¿Eliminar préstamo finalizado?")) return;
          await deleteDoc(doc(db,"loans",d.id)); loadInactive();
        };
        fin.appendChild(el);
      });

      const s2=await getDocs(query(collection(db,"loans"), where("status","==","charged_off")));
      chg.innerHTML = s2.empty? "Sin incobrables" : "";
      s2.forEach(d=>{
        const l=d.data(); const el=document.createElement("div"); el.className="cardlet";
        el.innerHTML=`<div class="row"><span class="tag"><span class="dot red"></span>Incobrable</span> <b>${l.borrower.name}</b> · DNI ${l.borrower.dni}</div>
                      <div>Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%</div>
                      <div class="actions-row">
                        <button class="btn" data-legal="${d.id}">PDF legal</button>
                        <button class="btn bad" data-del="${d.id}">Eliminar</button>
                      </div>`;
        el.querySelector("[data-legal]").onclick = ()=> openLegal(d.id,l);
        el.querySelector("[data-del]").onclick = async ()=>{
          if(!confirm("¿Eliminar incobrable?")) return;
          await deleteDoc(doc(db,"loans",d.id)); loadInactive();
        };
        chg.appendChild(el);
      });
    }
    function openLegal(id,l){
      const html = `
      <html><head><meta charset="utf-8"><title>Incobrable ${id}</title>
      <style>body{font:14px/1.5 system-ui;padding:24px} h1{font-size:20px}</style></head>
      <body>
        <h1>Resumen Legal — EstimaPres</h1>
        <p>Cliente: <b>${l.borrower.name}</b> · DNI ${l.borrower.dni}</p>
        <p>Monto original: ${money(l.amount)} · Plazo: ${l.months} meses · TNA: ${l.tna}%</p>
        <p>Contrato aceptado vía OTP: <b>${l.otp}</b></p>
        <p>Adjuntar este PDF al estudio de cobranzas.</p>
        <script>window.onload=()=>{window.print();}</script>
      </body></html>`;
      const w=window.open("about:blank","_blank"); w.document.write(html); w.document.close();
    }

    // ===========================
    // “VER MI PRÉSTAMO” (CLIENTE)
    // ===========================
    $("btnMyLoan").onclick = async ()=>{
      const code = prompt("Ingresá tu código de 6 dígitos (OTP/firma):");
      if(!code) return;
      const snap = await getDocs(query(collection(db,"loans"), where("otp","==",code)));
      if(snap.empty) return alert("No se encontró un préstamo con ese OTP.");
      const d = snap.docs[0]; const l=d.data();
      // Marca aceptación si venía de preaprobado
      if(l.status==="preapproved" && !l.contractAccepted){ await updateDoc(doc(db,"loans",d.id),{contractAccepted:true}); }

      const html = `
      <html><head><meta charset="utf-8"><title>Mi préstamo</title>
      <style>body{font:14px/1.5 system-ui;padding:16px} table{border-collapse:collapse;width:100%} td,th{border:1px solid #ddd;padding:6px;text-align:right} th:first-child,td:first-child{text-align:left}</style></head>
      <body>
        <h2>Mi préstamo</h2>
        <p>${l.borrower.name} · DNI ${l.borrower.dni}</p>
        <p>Monto: ${money(l.amount)} · Plazo: ${l.months} meses · TNA: ${l.tna}%</p>
        <p>Próximo vencimiento: día ${l.dueDay||10} de cada mes.</p>
        ${renderSchedule({...l,id:d.id})}
        <p style="color:#666">* Marcar cuotas pagadas lo realiza un administrador.</p>
      </body></html>`;
      const w = window.open("about:blank","_blank"); w.document.write(html); w.document.close();
      loadPre(); // refresca estado si aceptó contrato
    };

    // ===========================
    // Carga inicial
    // ===========================
    loadTna();
  </script>
</body>
</html>
