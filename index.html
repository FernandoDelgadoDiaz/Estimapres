<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EstimaPres ¬∑ Pr√©stamos personales</title>
  <meta name="theme-color" content="#0b57d0" />
  <link rel="icon" href="assets/ping.png" />
  <link rel="apple-touch-icon" href="assets/ping.png" />

  <style>
    :root{
      --bg:#0f172a; --brand:#0b57d0; --brand2:#1675ff;
      --text:#0b1220; --muted:#667085; --card:#ffffff; --line:#e5e7eb; --ok:#16a34a; --warn:#eab308; --bad:#ef4444;
      --chip:#0b57d015;
    }
    *{box-sizing:border-box}
    html,body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif; color:var(--text); background:#f5f7fb}
    a{color:#0b57d0; text-decoration:none}
    .wrap{max-width:980px; margin:0 auto; padding:0 16px}
    /* HERO */
    .hero{background:linear-gradient(135deg,var(--brand) 0%, var(--brand2) 100%); color:#fff; padding:28px 0 20px}
    .brand-row{display:flex; align-items:center; gap:14px; margin-bottom:10px}
    .brand-row img{width:54px; height:54px; border-radius:12px; background:#fff; padding:6px; box-shadow:0 8px 24px #0002}
    .brand-title{font-weight:800; font-size:44px; letter-spacing:.3px}
    .slogan{display:inline-block; margin:8px 0 12px; padding:10px 18px; border-radius:14px; background:#ffffff1a; backdrop-filter: blur(4px);}
    .slogan em{font-style:italic; text-decoration:underline}
    .hero-actions{display:flex; gap:16px; flex-wrap:wrap}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 18px; border-radius:14px; font-weight:600; border:1px solid #ffffff3a; color:#fff; background:#ffffff14}
    .btn:hover{background:#ffffff22}
    .btn.red{background:#ef4444; border-color:#ef4444}
    .btn.red:hover{filter:brightness(0.95)}
    .btn.dark{background:#0b1220; border-color:#0b1220}
    /* CARDS */
    .card{background:var(--card); border:1px solid var(--line); border-radius:18px; padding:22px; margin:16px 0; box-shadow:0 8px 24px #0b122005}
    .card h2{margin:0 0 14px; font-size:34px}
    label{display:block; font-weight:600; margin:10px 0 6px}
    input[type=text], input[type=number], input[type=email], input[type=tel]{width:100%; padding:14px 16px; border-radius:12px; border:1px solid var(--line); outline:none; font-size:16px; background:#fff}
    .hint{color:var(--muted); font-size:14px; margin-top:6px}
    .btn.primary{background:var(--ok); border-color:var(--ok); color:#fff; padding:12px 20px; border-radius:14px; font-weight:700}
    .btn.gray{background:#e5e7eb; color:#111827; border-color:#e5e7eb}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    @media (max-width:720px){ .row{grid-template-columns:1fr} .brand-title{font-size:36px} .hero-actions{gap:10px} }
    /* Tables */
    table{width:100%; border-collapse:collapse; margin-top:12px; font-size:15px}
    th,td{padding:12px 10px; border-bottom:1px solid var(--line); text-align:left}
    th{font-size:13px; text-transform:uppercase; letter-spacing:.04em; color:#475569}
    .chip{display:inline-flex; align-items:center; padding:4px 10px; border-radius:999px; font-weight:700; font-size:13px}
    .chip.ok{background:#16a34a22; color:#166534}
    .chip.warn{background:#eab30822; color:#854d0e}
    .chip.bad{background:#ef444422; color:#991b1b}
    .chip.muted{background:var(--chip); color:#154}
    .list .item{border:1px solid var(--line); border-radius:16px; padding:14px; margin-top:10px; background:#fff}
    .item .title{font-weight:800}
    .item .muted{color:#64748b}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .actions .btn{color:#111; border-color:#e5e7eb; background:#f8fafc}
    .actions .btn.ok{background:#16a34a; color:#fff; border-color:#16a34a}
    .actions .btn.bad{background:#ef4444; color:#fff; border-color:#ef4444}
    .section-title{font-size:26px; font-weight:800; margin:18px 0 6px}
    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0}
    .tabs .btn{color:#111}
    .right{justify-self:end}
    .hidden{display:none !important}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body>

  <!-- HERO -->
  <header class="hero">
    <div class="wrap">
      <div class="brand-row">
        <img src="assets/ping.png" alt="EstimaPres" />
        <div class="brand-title">EstimaPres</div>
      </div>
      <div class="slogan">Pr√©stamos personales ¬∑ <em>simple y claro</em></div>
      <div class="hero-actions">
        <button id="btnOpenMyLoan" class="btn">üîé&nbsp;Ver mi pr√©stamo</button>
        <button id="btnAdmin" class="btn">üõ°Ô∏è&nbsp;Admin</button>
        <button id="btnLogout" class="btn red hidden">‚Ü™&nbsp;Salir</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- SIMULADOR -->
    <section class="card" id="simulator">
      <h2>Simulador</h2>
      <div class="row">
        <div>
          <label>Monto</label>
          <input id="simAmount" type="text" inputmode="numeric" placeholder="$ 1.000.000" />
        </div>
        <div>
          <label>Meses</label>
          <input id="simMonths" type="text" inputmode="numeric" placeholder="Ej: 12" />
        </div>
      </div>
      <div class="hint">TNA vigente: <b id="lblTna">‚Äî%</b> ¬∑ Vencimiento: d√≠a <b id="lblDue">‚Äî</b></div>
      <div style="margin-top:12px">
        <button id="btnSim" class="btn primary">Simular</button>
      </div>
      <div id="simResult"></div>
    </section>

    <!-- SOLICITAR -->
    <section class="card">
      <h2>Solicitar pr√©stamo</h2>
      <div class="row">
        <div>
          <label>Tu nombre</label>
          <input id="inpName" type="text" placeholder="Juan P√©rez" />
        </div>
        <div>
          <label>DNI</label>
          <input id="inpDni" type="text" inputmode="numeric" placeholder="30123456"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Email</label>
          <input id="inpEmail" type="email" placeholder="tucorreo@mail.com"/>
        </div>
        <div>
          <label>Tel√©fono</label>
          <input id="inpPhone" type="tel" placeholder="11 2345 6789"/>
        </div>
      </div>
      <div>
        <label>alias o CBU/CVU</label>
        <input id="inpCbu" type="text" placeholder="alias o CBU/CVU"/>
      </div>
      <div style="margin-top:14px">
        <button id="btnApply" class="btn primary">Enviar solicitud</button>
      </div>
      <div class="hint">Al enviar acept√°s ser contactado por EstimaPres.</div>
    </section>

    <!-- ADMIN -->
    <section class="card hidden" id="adminArea">
      <h2>Panel administrador</h2>

      <div class="section-title">TNA</div>
      <div class="row">
        <div><input id="inpTna" type="number" step="1" min="0" placeholder="150" /></div>
        <div class="right"><button id="btnSaveTna" class="btn dark">Guardar</button></div>
      </div>

      <div class="section-title">Solicitudes pendientes</div>
      <div class="actions"><button id="btnReloadPend" class="btn gray">Recargar</button></div>
      <div id="listPend" class="list">Cargando‚Ä¶</div>

      <div class="section-title">Preaprobados</div>
      <div class="actions"><button id="btnReloadPre" class="btn gray">Recargar</button></div>
      <div id="listPre" class="list">Cargando‚Ä¶</div>

      <div class="section-title">Activos</div>
      <div class="actions"><button id="btnReloadActive" class="btn gray">Recargar</button></div>
      <div id="listActive" class="list">Cargando‚Ä¶</div>

      <div class="section-title">Inactivos (finalizados / incobrables)</div>
      <div class="tabs">
        <button id="tabFinished" class="btn gray">Cancelados</button>
        <button id="tabCharged" class="btn gray">Incobrables</button>
        <button id="btnReloadInactive" class="btn gray right">Recargar</button>
      </div>
      <div id="listInactive" class="list">Cargando‚Ä¶</div>
    </section>

    <!-- MI PR√âSTAMO -->
    <section class="card" id="myloanCard">
      <h2>Ver mi pr√©stamo</h2>
      <div class="row">
        <div>
          <label>Ingres√° tu DNI</label>
          <input id="myDni" type="text" inputmode="numeric" placeholder="Ej: 30123456"/>
        </div>
        <div class="right" style="align-self:end">
          <button id="btnFindMyLoan" class="btn dark">Consultar</button>
        </div>
      </div>
      <div id="myLoanResult"></div>
    </section>
  </main>

  <!-- Firebase + App -->
  <script type="module">
    /* ===================== Firebase SDK ===================== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import {
      getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc,
      query, where, orderBy, limit, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signInWithPopup, signInWithRedirect,
      getRedirectResult, GoogleAuthProvider, signOut
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

    /* ============ Configura tu proyecto Firebase aqu√≠ ============ */
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_AUTH_DOMAIN",
      projectId: "TU_PROJECT_ID",
      storageBucket: "TU_BUCKET",
      messagingSenderId: "TU_SENDER_ID",
      appId: "TU_APP_ID"
    };
    /* ============================================================ */

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    /* ==================== Estado global ==================== */
    const ADMIN_EMAILS = [
      "fernandogastondelgado81@gmail.com" // agrega m√°s si quer√©s
    ];
    const state = { user:null, isAdmin:false, tna:null, dueDay:null };

    /* ==================== Helpers UI/format ==================== */
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const onlyDigits = s => (s+"").replace(/\D+/g,"");
    const nowTS = ()=> new Date().toISOString();
    const money = n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Math.round(n||0));

    // Formatea campo $ con puntitos
    function attachMoneyMask(el){
      el.addEventListener('input', ()=>{
        const v = onlyDigits(el.value);
        el.value = v ? ('$ '+Number(v).toLocaleString('es-AR')) : '';
      });
    }
    attachMoneyMask($('#simAmount'));

    // Calcula tabla de cuotas (sistema franc√©s)
    function buildSchedule(amount, months, tna, startDay){
      const i = (tna/100)/12;
      const A = i===0 ? amount/months : amount * ( i / (1 - Math.pow(1+i,-months)) );
      const today = new Date();
      const rows = [];
      let d = new Date(today.getFullYear(), today.getMonth(), startDay||today.getDate());
      if (d < today) d.setMonth(d.getMonth()+1);

      for(let k=1;k<=months;k++){
        const due = new Date(d.getFullYear(), d.getMonth()+(k-1), d.getDate());
        rows.push({
          n:k, due: due, amount: A, paid:false
        });
      }
      return rows;
    }
    const scheduleRowsHTML = (rows, paidCount=0) => {
      const fmt = d => d.toLocaleDateString('es-AR',{day:'2-digit',month:'2-digit',year:'numeric'});
      return `
        <table>
          <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th><th></th></tr></thead>
          <tbody>
            ${rows.map((r,idx)=>{
              const paid = idx < paidCount;
              return `<tr>
                <td class="mono">${r.n}</td>
                <td>${fmt(r.due)}</td>
                <td>${money(r.amount)}</td>
                <td>${paid ? '<span class="chip ok">Pagada</span>' : '<span class="chip warn">Pendiente</span>'}</td>
                <td data-idx="${idx}"></td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      `;
    };

    function toast(msg){ alert(msg); }

    /* ==================== Settings (TNA/Due) ==================== */
    async function loadSettings(){
      try{
        const snap = await getDoc(doc(db,'settings','global'));
        if (snap.exists()){
          const s = snap.data();
          state.tna = Number(s.tna||0);
          state.dueDay = Number(s.dueDay||10);
        } else {
          state.tna = null; state.dueDay = null;
        }
      }catch(e){ state.tna=null; state.dueDay=null; }
      $('#lblTna').textContent = state.tna!=null? state.tna+'%':'‚Äî%';
      $('#lblDue').textContent = state.dueDay!=null? state.dueDay:'‚Äî';
      if (state.isAdmin){
        $('#inpTna').value = state.tna!=null? state.tna : '';
      }
    }
    async function saveTna(){
      try{
        const tna = Number($('#inpTna').value);
        if (isNaN(tna) || tna<=0) return toast('Ingres√° una TNA v√°lida.');
        await setDoc(doc(db,'settings','global'), { tna, dueDay: state.dueDay||10, updatedAt: nowTS() }, { merge:true });
        toast('TNA guardada.');
        loadSettings();
      }catch(e){ toast('No se pudo guardar la TNA.'); }
    }

    /* ==================== Simulador ==================== */
    $('#btnSim').onclick = ()=>{
      if (state.tna==null || state.dueDay==null){ toast('Configur√° la TNA desde Admin antes de simular.'); return; }
      const amount = Number(onlyDigits($('#simAmount').value)||0);
      const months = Number(onlyDigits($('#simMonths').value)||0);
      if (!amount || !months) return toast('Complet√° monto y meses.');
      const rows = buildSchedule(amount, months, state.tna, state.dueDay);
      $('#simResult').innerHTML = scheduleRowsHTML(rows);
    };

    /* ==================== Solicitud ==================== */
    async function sendApplication(){
      try{
        const amount = Number(onlyDigits($('#simAmount').value)||0);
        const months = Number(onlyDigits($('#simMonths').value)||0);
        if (!amount || !months) return toast('Primero simul√° el pr√©stamo (monto y meses).');
        const name = $('#inpName').value.trim();
        const dni  = onlyDigits($('#inpDni').value);
        const email= $('#inpEmail').value.trim();
        const phone= $('#inpPhone').value.trim();
        const cbu  = $('#inpCbu').value.trim();
        if (!name || !dni || !email || !phone || !cbu) return toast('Complet√° todos los campos del formulario.');

        const L = {
          amount, months, tna: state.tna, dueDay: state.dueDay,
          status:'pending',
          createdAt: nowTS(), updatedAt: nowTS(),
          borrower:{name, dni, email, phone, cbu}
        };
        await addDoc(collection(db,'loans'), L);
        toast('Solicitud enviada. Te contactaremos pronto.');
        $('#inpName').value=$('#inpDni').value=$('#inpEmail').value=$('#inpPhone').value=$('#inpCbu').value='';
      }catch(e){ toast('No se pudo enviar la solicitud.'); }
    }
    $('#btnApply').onclick = sendApplication;

    /* ==================== Admin: login/logout ==================== */
    async function openAdmin(){
      if (auth.currentUser && state.isAdmin){
        $('#adminArea').classList.remove('hidden');
        return;
      }
      try{
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        if (isMobile) await signInWithRedirect(auth, provider);
        else await signInWithPopup(auth, provider);
      }catch(e){ toast('No se pudo iniciar sesi√≥n.'); }
    }
    $('#btnAdmin').onclick = openAdmin;
    $('#btnLogout').onclick = ()=> signOut(auth).catch(()=>{});

    getRedirectResult(auth).catch(()=>{});

    onAuthStateChanged(auth, (u)=>{
      state.user = u || null;
      state.isAdmin = !!(u && ADMIN_EMAILS.includes((u.email||'').toLowerCase()));
      $('#btnLogout').classList.toggle('hidden', !u);
      $('#adminArea').classList.toggle('hidden', !state.isAdmin);
      if (state.isAdmin){ loadSettings(); loadAllAdmin(); }
    });

    /* ==================== Admin: lists ==================== */
    async function loadPend(){
      const box = $('#listPend'); box.textContent='';
      try{
        const q = await getDocs(query(collection(db,'loans'), where('status','==','pending'), orderBy('createdAt','desc'), limit(80)));
        if (q.empty){ box.textContent='Sin pendientes'; return; }
        q.forEach(docSnap=>{
          const d = docSnap.data(); d.id = docSnap.id;
          const el = document.createElement('div'); el.className='item';
          el.innerHTML = `
            <div class="title">${d.borrower?.name||''} ¬∑ DNI ${d.borrower?.dni||''}</div>
            <div class="muted">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}%</div>
            <div class="actions">
              <button class="btn ok" data-act="pre">Preaprobar</button>
              <button class="btn bad" data-act="del">Eliminar</button>
            </div>`;
          el.querySelector('[data-act="pre"]').onclick = async ()=>{
            if(!confirm('¬øPreaprobar y generar contrato?')) return;
            await updateDoc(doc(db,'loans',d.id), {
              status:'preapproved', contractId: Math.random().toString(36).slice(2,10).toUpperCase(),
              updatedAt: nowTS()
            });
            await loadAllAdmin();
          };
          el.querySelector('[data-act="del"]').onclick = async ()=>{
            if(!confirm('¬øEliminar solicitud?')) return;
            await updateDoc(doc(db,'loans',d.id), { status:'deleted', updatedAt: nowTS() });
            await loadAllAdmin();
          };
          box.appendChild(el);
        });
      }catch(e){ box.textContent='No se pudieron leer las solicitudes (revisa reglas/√≠ndices).'; }
    }

    function contractHTML(L, forSign){
      const rows = buildSchedule(L.amount, L.months, L.tna, L.dueDay);
      const rowsHtml = rows.map(r=>{
        const dd = r.due.toLocaleDateString('es-AR',{day:'2-digit',month:'2-digit',year:'numeric'});
        return `<tr><td>${r.n}</td><td>${dd}</td><td>${money(r.amount)}</td></tr>`;
      }).join('');
      const css = `
        <style>
          @page{size:A4;margin:20mm}
          body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; margin:0; color:#111827}
          h1{font-size:22px;margin:0 0 8px}
          .muted{color:#6b7280}
          .box{padding:18px}
          table{width:100%;border-collapse:collapse;margin-top:10px}
          th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:left}
          th{font-size:12px;text-transform:uppercase;letter-spacing:.04em;color:#64748b}
          .bar{display:flex;gap:12px;margin-top:14px}
          .btn{padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb;background:#f8fafc;cursor:pointer}
          .btn.ok{background:#16a34a;color:#fff;border-color:#16a34a}
        </style>`;
      return `
        <!doctype html><html><head><meta charset="utf-8"><title>Contrato</title>${css}</head>
        <body>
          <div class="box">
            <h1>Contrato N¬∞ ${L.contractId} ‚Äî ${L.borrower?.name||''} ‚Äî DNI ${L.borrower?.dni||''}</h1>
            <div class="muted">Emitido: ${new Date().toLocaleString('es-AR')}</div>
            <p>Monto otorgado: <b>${money(L.amount)}</b> ‚Äî Plazo: <b>${L.months} meses</b> ‚Äî TNA: <b>${L.tna}%</b> ‚Äî Vencimiento: d√≠a <b>${L.dueDay}</b></p>
            <h3>Detalle de cuotas</h3>
            <table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th></tr></thead><tbody>${rowsHtml}</tbody></table>
            ${forSign ? `
              <div class="bar">
                <input id="signName" placeholder="Nombre y apellido" style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px" />
                <button id="btnAccept" class="btn ok">Acepto contrato</button>
                <button id="btnPrint" class="btn" onclick="window.print()">Imprimir / PDF</button>
              </div>
              <p class="muted">Al presionar ‚ÄúAcepto contrato‚Äù se registrar√° la aceptaci√≥n digital.</p>
            `:`
              <div class="bar">
                <button class="btn" onclick="window.print()">Imprimir / PDF</button>
              </div>
            `}
          </div>
          <script>
            ${forSign ? `
            document.getElementById('btnAccept').addEventListener('click', ()=>{
              const v = (document.getElementById('signName').value||'').trim();
              if(!v){ alert('Escrib√≠ tu nombre y apellido'); return; }
              window.opener && window.opener.postMessage({type:'signed', id:'${L.id}', value:v}, '*');
              alert('Contrato aceptado!');
              window.close();
            });
            `:''}
          <\/script>
        </body></html>`;
    }
    function openContract(L, forSign=true){
      const w = window.open('about:blank','_blank');
      const html = contractHTML(L, forSign);
      w.document.write(html); w.document.close();
    }

    async function loadPre(){
      const box = $('#listPre'); box.textContent='';
      try{
        const q = await getDocs(query(collection(db,'loans'), where('status','==','preapproved'), orderBy('updatedAt','desc'), limit(80)));
        if (q.empty){ box.textContent='Sin preaprobados'; return; }
        q.forEach(s=>{
          const d = s.data(); d.id=s.id;
          const signed = !!d.signed;
          const el = document.createElement('div'); el.className='item';
          el.innerHTML = `
            <div class="title">${d.borrower?.name||''} ¬∑ DNI ${d.borrower?.dni||''} ${signed?'<span class="chip ok" style="margin-left:8px">Firmado</span>':'<span class="chip warn" style="margin-left:8px">Esperando firma</span>'}</div>
            <div class="muted">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}% ¬∑ Contrato ${d.contractId||'-'}</div>
            <div class="actions">
              <button class="btn" data-act="pdf">Abrir contrato</button>
              <button class="btn" data-act="share">Compartir</button>
              <button class="btn ok" data-act="approve" ${signed?'':'disabled'}>Aprobar y depositar</button>
            </div>`;
          el.querySelector('[data-act="pdf"]').onclick = ()=> openContract(d,false);
          el.querySelector('[data-act="share"]').onclick = async ()=>{
            const url = location.origin + location.pathname + '#sign-' + d.id;
            try{
              await navigator.share({ title:'Contrato EstimaPres', text:`Contrato ${d.contractId} - ${d.borrower?.name}`, url });
            }catch(_){ navigator.clipboard.writeText(url); toast('Enlace copiado'); }
          };
          el.querySelector('[data-act="approve"]').onclick = async ()=>{
            if(!d.signed){ toast('A√∫n no se firm√≥.'); return; }
            await updateDoc(doc(db,'loans',d.id), { status:'active', activeAt: nowTS(), updatedAt: nowTS(), paidCount: Number(d.paidCount||0) });
            await loadAllAdmin();
          };
          box.appendChild(el);
        });
      }catch(e){ box.textContent='Error al leer preaprobados (reglas/√≠ndices).'; }
    }

    async function loadActive(){
      const box = $('#listActive'); box.textContent='';
      try{
        const q = await getDocs(query(collection(db,'loans'), where('status','==','active'), orderBy('activeAt','desc'), limit(80)));
        if (q.empty){ box.textContent='Sin activos'; return; }
        q.forEach(s=>{
          const d = s.data(); d.id=s.id;
          const el = document.createElement('div'); el.className='item';
          el.innerHTML = `
            <div class="title">${d.borrower?.name} ¬∑ DNI ${d.borrower?.dni}</div>
            <div class="muted">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}%</div>
            <div class="actions">
              <button class="btn" data-act="rows">Ver cuotas</button>
              <button class="btn ok" data-act="finish">Pagado total</button>
              <button class="btn bad" data-act="bad">A incobrables</button>
            </div>
            <div class="rows hidden"></div>
          `;
          const rowsBox = el.querySelector('.rows');

          const renderRows = ()=>{
            const rows = buildSchedule(d.amount, d.months, d.tna, d.dueDay);
            rowsBox.innerHTML = scheduleRowsHTML(rows, Number(d.paidCount||0));
            // Poner botones "Marcar pagada"
            $$('#listActive .item .rows table tbody tr', el).forEach((tr,idx)=>{
              const btnCell = tr.querySelector('td:last-child');
              if (idx < Number(d.paidCount||0)) return; // ya pagada
              const b = document.createElement('button');
              b.className='btn'; b.textContent='Marcar pagada';
              b.onclick = async ()=>{
                const next = Number(d.paidCount||0)+1;
                await updateDoc(doc(db,'loans',d.id), { paidCount: next, updatedAt: nowTS() });
                d.paidCount = next;
                renderRows();
              };
              btnCell.appendChild(b);
            });
            // Habilitar / deshabilitar "Pagado total"
            const allPaid = Number(d.paidCount||0) >= Number(d.months||0);
            el.querySelector('[data-act="finish"]').disabled = !allPaid;
          };

          el.querySelector('[data-act="rows"]').onclick = ()=>{
            rowsBox.classList.toggle('hidden');
            if (!rowsBox.dataset.rendered){ renderRows(); rowsBox.dataset.rendered='1'; }
          };
          el.querySelector('[data-act="finish"]').onclick = async ()=>{
            if (Number(d.paidCount||0) < Number(d.months||0)) return toast('Marc√° todas las cuotas como pagadas primero.');
            await updateDoc(doc(db,'loans',d.id), { status:'finished', updatedAt: nowTS() });
            await loadAllAdmin();
          };
          el.querySelector('[data-act="bad"]').onclick = async ()=>{
            if(!confirm('¬øMover a incobrables?')) return;
            await updateDoc(doc(db,'loans',d.id), { status:'charged_off', updatedAt: nowTS() });
            await loadAllAdmin();
          };

          box.appendChild(el);
        });
      }catch(e){ box.textContent='Error al leer activos (reglas/√≠ndices).'; }
    }

    let inactiveMode = 'finished'; // o 'charged_off'
    async function loadInactive(){
      const box = $('#listInactive'); box.textContent='';
      try{
        const q = await getDocs(query(collection(db,'loans'), where('status','==', inactiveMode), orderBy('updatedAt','desc'), limit(80)));
        if (q.empty){ box.textContent='Sin inactivos'; return; }
        q.forEach(s=>{
          const d = s.data(); d.id=s.id;
          const el = document.createElement('div'); el.className='item';
          el.innerHTML = `
            <div class="title">${inactiveMode==='finished' ? '<span class="chip ok">cancelado</span>' : '<span class="chip bad">charged_off</span>'} &nbsp; ${d.borrower?.name} ¬∑ DNI ${d.borrower?.dni}</div>
            <div class="muted">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}% ¬∑ Contrato ${d.contractId||'-'}</div>
          `;
          box.appendChild(el);
        });
      }catch(e){ box.textContent='Error al leer inactivos.'; }
    }

    async function loadAllAdmin(){ await Promise.all([loadPend(), loadPre(), loadActive(), loadInactive()]); }

    $('#btnReloadPend').onclick = loadPend;
    $('#btnReloadPre').onclick = loadPre;
    $('#btnReloadActive').onclick = loadActive;
    $('#btnReloadInactive').onclick = loadInactive;
    $('#tabFinished').onclick = ()=>{ inactiveMode='finished'; loadInactive(); };
    $('#tabCharged').onclick  = ()=>{ inactiveMode='charged_off'; loadInactive(); };
    $('#btnSaveTna').onclick = saveTna;

    // Recibir firma desde ventana contrato
    window.addEventListener('message', async (ev)=>{
      if (ev?.data?.type==='signed' && ev.data.id){
        try{
          await updateDoc(doc(db,'loans',ev.data.id), { signed:true, signedName: ev.data.value, signedAt: nowTS(), updatedAt: nowTS() });
          toast('Firma registrada. Ya pod√©s aprobar desde el panel.');
          await loadAllAdmin();
        }catch(e){ toast('No se pudo registrar la firma.'); }
      }
    });

    // Si vino con #sign-<id> desde link compartido, abrir contrato para firmar
    async function tryOpenSignFromHash(){
      if(!location.hash.startsWith('#sign-')) return;
      const id = location.hash.replace('#sign-','').trim();
      try{
        const s = await getDoc(doc(db,'loans',id));
        if (!s.exists()) return;
        const L = s.data(); L.id=id;
        openContract(L,true);
      }catch(_){}
    }

    /* ==================== Mi pr√©stamo (usuario) ==================== */
    $('#btnOpenMyLoan').onclick = ()=> $('#myloanCard').scrollIntoView({behavior:'smooth'});

    $('#btnFindMyLoan').onclick = async ()=>{
      const dni = onlyDigits($('#myDni').value);
      if(!dni){ $('#myLoanResult').textContent='Ingres√° un DNI.'; return; }
      $('#myLoanResult').textContent='Buscando‚Ä¶';
      try{
        const s = await getDocs(query(collection(db,'loans'), orderBy('createdAt','desc'), limit(80)));
        const list=[];
        s.forEach(d=>{ const L=d.data(); if((L?.borrower?.dni||'')===dni) list.push({id:d.id, ...L}); });
        if(!list.length){ $('#myLoanResult').textContent='No encontramos pr√©stamos activos o preaprobados para ese DNI.'; return; }
        const L = list[0]; // el m√°s reciente
        const paid = Number(L.paidCount||0);
        const rows = buildSchedule(L.amount, L.months, L.tna, L.dueDay);
        const html = `
          <div class="item">
            <div class="title">Estado: ${L.status}</div>
            <div class="muted">Monto: ${money(L.amount)} ¬∑ Cuotas: ${L.months} ¬∑ TNA: ${L.tna}% ¬∑ Progreso: <b class="chip ok">${paid}/${L.months}</b></div>
            <div class="actions">
              <button class="btn" id="btnMyPdf">Contrato PDF</button>
            </div>
            ${scheduleRowsHTML(rows, paid)}
          </div>`;
        $('#myLoanResult').innerHTML = html;
        $('#btnMyPdf').onclick = ()=> openContract(L,false);
      }catch(e){ $('#myLoanResult').textContent='No se pudo consultar.'; }
    };

    /* ==================== Inicial ==================== */
    await loadSettings();
    tryOpenSignFromHash();
  </script>
</body>
</html>