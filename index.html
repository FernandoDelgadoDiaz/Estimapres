<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
    <title>EstimaPres ¬∑ Gesti√≥n Financiera Profesional</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --brand: #0e48c7; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --bg: #08215e; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: #1e293b; min-height: 100vh; padding-bottom: 50px; }
        .container { max-width: 550px; margin: 0 auto; padding: 15px; }
        .glass-card { background: white; border-radius: 24px; padding: 25px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); position: relative; }
        h1, h3 { color: var(--brand); font-weight: 800; margin: 0 0 15px 0; }
        label { display: block; font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 5px; }
        input, select { width: 100%; padding: 14px; border-radius: 15px; border: 1px solid #e2e8f0; font-size: 16px; margin-bottom: 15px; box-sizing: border-box; background: #f8fafc; font-weight: 600; color: #1e293b; }
        .btn-main { width: 100%; background: var(--brand); color: white; border: none; padding: 16px; border-radius: 18px; font-weight: 800; cursor: pointer; font-size: 15px; transition: 0.3s; }
        .btn-main:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-tabs { display: flex; gap: 6px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 18px; border-radius: 25px; font-size: 12px; cursor: pointer; white-space: nowrap; font-weight: 700; }
        .tab.active { background: white; color: var(--brand); border: 1px solid white; }
        .loan-card { background: #f8fafc; padding: 18px; border-radius: 20px; margin-bottom: 12px; border: 1px solid #e2e8f0; position: relative; }
        .status-badge { font-size: 10px; padding: 4px 10px; border-radius: 8px; font-weight: 800; text-transform: uppercase; margin-bottom: 8px; display: inline-block; }
        .quota-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #edf2f7; font-size: 13px; font-weight: 600; }
        .hidden { display: none !important; }
        .btn-del { position: absolute; top: 15px; right: 15px; background: #fee2e2; color: var(--danger); border: none; padding: 6px 10px; border-radius: 8px; font-size: 10px; font-weight: 800; cursor: pointer; }
        header { text-align: center; color: white; padding: 40px 0 20px; }
    </style>
</head>
<body>

<header>
    <h1 style="color:white; margin:0; font-size: 32px;">EstimaPres</h1>
    <button id="btnStaff" style="background:none; border:1px solid rgba(255,255,255,0.4); color:white; padding:8px 20px; border-radius:20px; margin-top:15px; cursor:pointer; font-weight:700;">Panel de Control</button>
</header>

<div class="container">
    <div id="viewClient">
        <div class="glass-card">
            <h3>üìä Simulador</h3>
            <label>Monto a solicitar</label>
            <input type="number" id="sMonto" placeholder="Ej: 200000">
            <label>Plazo</label>
            <select id="sCuotas"><option value="12">12 Meses</option><option value="18">18 Meses</option><option value="24">24 Meses</option></select>
            <button id="btnSim" class="btn-main">Calcular Cuota</button>
            <div id="resSim" class="hidden" style="text-align:center; margin-top:20px; background:#eff6ff; padding:15px; border-radius:20px; border: 2px dashed var(--brand);">
                <label>Tu cuota mensual ser√°:</label>
                <div id="txtCuota" style="font-size:32px; font-weight:800; color:var(--brand);"></div>
            </div>
        </div>

        <div class="glass-card">
            <h3>üìù Solicitud</h3>
            <input id="fName" placeholder="Nombre y Apellido">
            <input id="fDni" type="number" placeholder="DNI (Sin puntos)">
            <input id="fTel" type="tel" placeholder="WhatsApp">
            <input id="fAlias" placeholder="CBU / CVU o Alias para recibir dinero">
            <button id="btnSend" class="btn-main" style="background:var(--success)">Enviar Solicitud</button>
        </div>

        <div class="glass-card">
            <h3>üîç Consultar Mi Estado</h3>
            <div style="display:flex; gap:8px;">
                <input id="searchDni" type="number" placeholder="DNI">
                <button id="btnSearch" class="btn-main" style="width:120px;">Buscar</button>
            </div>
            <div id="searchRes" class="hidden" style="margin-top:20px;"></div>
        </div>
    </div>

    <div id="viewAdmin" class="hidden">
        <div class="glass-card" style="padding:15px; margin-bottom:15px; background: #f1f5f9; border:none;">
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>Tasa Inter√©s %</label><input type="number" id="cfgInt" value="65" style="margin:0"></div>
                <div style="flex:1"><label>D√≠a Vence</label><input type="number" id="cfgDia" value="10" style="margin:0"></div>
            </div>
            <div style="margin-top:10px;"><label>Mi Alias/CBU Cobranza</label><input id="cfgAliasCobro" value="TU.ALIAS.PAGO" style="margin:0"></div>
        </div>

        <div class="btn-tabs">
            <div class="tab active" onclick="tabAdmin('pending')">Nuevos</div>
            <div class="tab" onclick="tabAdmin('waiting_signature')">Por Firmar</div>
            <div class="tab" onclick="tabAdmin('active')">Activos</div>
            <div class="tab" onclick="tabAdmin('bad_debt')">Incobrables</div>
            <div class="tab" onclick="tabAdmin('finished')">Finalizados</div>
            <div id="btnLogout" class="tab" style="background:var(--danger); border:none;">Cerrar</div>
        </div>
        <div id="adminContent"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, doc, getDoc, getDocs, updateDoc, deleteDoc, collection, query, where, orderBy, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
        authDomain: "estimapres.firebaseapp.com",
        projectId: "estimapres",
        storageBucket: "estimapres.firebasestorage.app",
        messagingSenderId: "578516597437",
        appId: "1:578516597437:web:f59994b87729aa1cd655d4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const $ = s => document.querySelector(s);
    const fmt = n => "$ " + (Number(n) || 0).toLocaleString("es-AR", {minimumFractionDigits: 0, maximumFractionDigits: 0});
    
    const getVence = (offset, dia) => { 
        let d = new Date();
        d.setMonth(d.getMonth() + offset);
        return `${dia}/${d.getMonth() + 1}/${d.getFullYear()}`;
    };

    // --- CLIENTE: SIMULADOR ---
    $("#btnSim").onclick = () => {
        const m = Number($("#sMonto").value);
        if(!m) return;
        const tasa = Number($("#cfgInt").value) / 100;
        const q = Math.round((m * (1 + tasa)) / $("#sCuotas").value);
        $("#resSim").classList.remove("hidden");
        $("#txtCuota").innerText = fmt(q);
    };

    // --- CLIENTE: ENVIAR ---
    $("#btnSend").onclick = async () => {
        const m = Number($("#sMonto").value);
        if(!m || !$("#fName").value || !$("#fDni").value) return alert("Faltan datos");
        const tasa = Number($("#cfgInt").value);
        await addDoc(collection(db, "loans"), {
            name: $("#fName").value, dni: $("#fDni").value, phone: $("#fTel").value, alias: $("#fAlias").value,
            amount: m, months: Number($("#sCuotas").value), rate: tasa, diaVence: Number($("#cfgDia").value),
            quota: Math.round((m * (1 + (tasa/100))) / $("#sCuotas").value),
            status: "pending", paidCount: 0, createdAt: serverTimestamp()
        });
        alert("Solicitud enviada correctamente."); location.reload();
    };

    // --- CLIENTE: BUSCAR Y FIRMAR ---
    $("#btnSearch").onclick = async () => {
        const snap = await getDocs(query(collection(db, "loans"), where("dni", "==", $("#searchDni").value)));
        const res = $("#searchRes"); res.classList.remove("hidden");
        if(snap.empty) return res.innerHTML = "No se encontr√≥ registro para ese DNI.";
        const d = snap.docs[0].data(); const id = snap.docs[0].id;
        
        let h = `<div class="loan-card">
            <span class="status-badge" style="background:var(--brand); color:white">${d.status.replace('_', ' ')}</span>
            <div style="font-size:18px; font-weight:800;">${d.name}</div>
            <div style="margin:10px 0; font-size:14px;">Monto: <b>${fmt(d.amount)}</b> | Cuotas: <b>${d.months} de ${fmt(d.quota)}</b></div>`;
        
        if(d.status === 'waiting_signature') {
            h += `<div style="background:#fffbeb; padding:15px; border-radius:15px; border:1px solid #fef3c7; margin-top:10px;">
                <p style="font-size:12px; color:#92400e;"><b>LEER CONTRATO:</b> Acepto pr√©stamo por ${fmt(d.amount)} a devolver en ${d.months} cuotas de ${fmt(d.quota)} (Tasa ${d.rate}%). Vencimiento d√≠a ${d.diaVence} de cada mes. Lugar de pago: R√≠o Gallegos, Santa Cruz.</p>
                <button class="btn-main" style="background:var(--warning)" onclick="window.firmar('${id}')">FIRMAR CONTRATO DIGITAL</button>
            </div>`;
        } else if(d.status === 'active') {
            h += `<p style="font-size:13px; color:var(--success); border-top:1px solid #ddd; padding-top:10px;"><b>Transferir cuotas a:</b><br>${$("#cfgAliasCobro").value}</p>`;
        }
        res.innerHTML = h + `</div>`;
    };

    window.firmar = async id => {
        if(confirm("¬øFirma digitalmente el contrato en R√≠o Gallegos?")) {
            await updateDoc(doc(db,"loans",id), {status:"active", fechaFirma: new Date().toLocaleDateString()});
            alert("Contrato firmado. Cr√©dito ACTIVO."); location.reload();
        }
    };

    // --- ADMIN: NAVEGACI√ìN ---
    let currentTab = 'pending';
    window.tabAdmin = (t) => {
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active'); currentTab = t; loadAdmin();
    };

    async function loadAdmin() {
        const snap = await getDocs(query(collection(db, "loans"), orderBy("createdAt", "desc")));
        const cont = $("#adminContent"); cont.innerHTML = "";
        snap.forEach(docu => {
            const d = { id: docu.id, ...docu.data() };
            if(d.status !== currentTab) return;
            const card = document.createElement("div"); card.className = "loan-card";
            card.innerHTML = `
                <button class="btn-del" onclick="window.borrar('${d.id}')">BORRAR</button>
                <div style="font-weight:800; font-size:16px;">${d.name}</div>
                <div style="font-size:12px; color:#64748b;">DNI: ${d.dni} | Alias: ${d.alias || 'N/D'}</div>
                <div style="margin:10px 0; font-weight:700;">${fmt(d.amount)} @ ${d.rate}%</div>
                <div>
                    ${d.status === 'pending' ? `<button class="btn-main" style="padding:10px; background:var(--success)" onclick="window.toFirma('${d.id}')">APROBAR PARA FIRMA</button>` : renderAdminQuotas(d)}
                </div>
            `;
            cont.appendChild(card);
        });
    }

    function renderAdminQuotas(d) {
        if(d.status === 'waiting_signature') return `<center><small style="color:orange">Esperando firma del Prestatario...</small></center>`;
        let h = `<div style="margin-top:10px; border-top:1px solid #eee;">`;
        for(let i=1; i<=d.months; i++){
            const p = d.paidCount >= i;
            h += `<div class="quota-row"><span>Cuota ${i} (${getVence(i, d.diaVence)})</span><span>${fmt(d.quota)}</span>${p ? '<b style="color:green">PAGADO</b>' : `<button onclick="window.cobrar('${d.id}',${i})" style="font-size:10px; padding:4px 8px;">Cobrar</button>`}</div>`;
        }
        h += `</div><div style="display:flex; gap:5px; margin-top:12px;">
            <button class="btn-main" style="padding:10px; font-size:11px; flex:1;" onclick="window.pdf('${d.id}', 'contrato')">PDF CONTRATO</button>
            <button class="btn-main" style="padding:10px; font-size:11px; flex:1; background:var(--warning);" onclick="window.pdf('${d.id}', 'legal')">GESTI√ìN LEGAL</button>
            ${d.status !== 'bad_debt' ? `<button class="btn-main" style="padding:10px; font-size:11px; flex:0.5; background:#64748b;" onclick="window.toBad('${d.id}')">MORA</button>` : ''}
        </div>`;
        return h;
    }

    // --- ACCIONES ---
    window.borrar = async id => { if(confirm("¬øEliminar registro?")) { await deleteDoc(doc(db,"loans",id)); loadAdmin(); } };
    window.toFirma = async id => { await updateDoc(doc(db,"loans",id), {status:"waiting_signature"}); loadAdmin(); };
    window.toBad = async id => { await updateDoc(doc(db,"loans",id), {status:"bad_debt"}); loadAdmin(); };
    window.cobrar = async (id, n) => {
        const s = await getDoc(doc(db,"loans",id));
        const st = n >= s.data().months ? "finished" : "active";
        await updateDoc(doc(db,"loans",id), {paidCount: n, status: st}); loadAdmin();
    };

    window.pdf = async (id, tipo) => {
        const s = await getDoc(doc(db,"loans",id)); const d = s.data();
        const docPDF = new jspdf.jsPDF();
        const fecha = new Date().toLocaleDateString();

        if(tipo === 'contrato') {
            docPDF.setFontSize(18); docPDF.setTextColor(14, 72, 199);
            docPDF.text("CONTRATO DE PR√âSTAMO - EstimaPres", 105, 20, {align:"center"});
            docPDF.setFontSize(11); docPDF.setTextColor(0);
            let txt = `En R√≠o Gallegos, Santa Cruz, a los ${fecha}, el PRESTATARIO ${d.name} (DNI ${d.dni}) recibe del PRESTAMISTA EstimaPres la suma de ${fmt(d.amount)}. \n\nSe pactan ${d.months} cuotas de ${fmt(d.quota)} con un inter√©s total del ${d.rate}%.\nLos pagos vencen el d√≠a ${d.diaVence} de cada mes. Firma Digital: ${d.fechaFirma || 'Pendiente'}`;
            docPDF.text(docPDF.splitTextToSize(txt, 170), 20, 40);
        } else {
            const cuotasPend = d.months - d.paidCount;
            const cap = cuotasPend * d.quota;
            const hoy = new Date();
            const venc = new Date(hoy.getFullYear(), hoy.getMonth(), d.diaVence);
            const diasMora = hoy > venc ? Math.floor((hoy - venc) / 86400000) : 0;
            const punitorios = Math.round(cap * (0.015 * diasMora));
            
            docPDF.setFontSize(18); docPDF.setTextColor(200, 0, 0);
            docPDF.text("CERTIFICADO DE DEUDA Y GESTI√ìN LEGAL", 105, 20, {align:"center"});
            docPDF.setFontSize(12); docPDF.setTextColor(0);
            let txt = `Se certifica que ${d.name} (DNI ${d.dni}) adeuda la suma total de ${fmt(cap + punitorios)} en concepto de pr√©stamo e intereses en R√≠o Gallegos.\n\nDETALLE:\n- Capital adeudado (${cuotasPend} cuotas): ${fmt(cap)}\n- Intereses punitorios (${diasMora} d√≠as mora 1.5% diario): ${fmt(punitorios)}\n\nDocumento emitido para reclamo judicial.`;
            docPDF.text(docPDF.splitTextToSize(txt, 170), 20, 50);
        }
        docPDF.save(`${tipo.toUpperCase()}_${d.dni}.pdf`);
    };

    // --- ACCESO Y SESI√ìN ---
    $("#btnStaff").onclick = () => { const p = prompt("Clave:"); if(p) signInWithEmailAndPassword(auth, "fernandogastondelgado81@gmail.com", p); };
    onAuthStateChanged(auth, user => { if(user) { $("#viewClient").classList.add("hidden"); $("#viewAdmin").classList.remove("hidden"); loadAdmin(); } });
    $("#btnLogout").onclick = () => signOut(auth).then(() => location.reload());
</script>
</body>
</html>
