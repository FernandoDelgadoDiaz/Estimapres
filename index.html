<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, interactive-widget=resizes-content" />
  <meta name="theme-color" content="#0a2f73" />
  <title>EstimaPres Â· PrÃ©stamos en ARS</title>
  <meta name="description" content="SimulÃ¡ y solicitÃ¡ prÃ©stamos en pesos argentinos. Panel admin con TNA centralizada y ciclo completo de prÃ©stamos." />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/icons/estimapres-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <style>
    :root{--brand:#0a2f73;--bg:#f6f8fc;--card:#fff;--text:#0f172a}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .app{display:flex;justify-content:center}.phone{width:100%;max-width:420px;min-height:100dvh;background:var(--bg)}
    header{position:sticky;top:0;background:var(--brand);color:#fff;padding:12px 14px;display:flex;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0;font-weight:700}.brand{display:flex;gap:10px;align-items:center}.logo{width:28px;height:28px;border-radius:8px;background:#fff;display:grid;place-items:center;color:var(--brand);font-weight:900}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,.06);padding:14px;margin:12px}
    .label{font-size:13px;color:#475569}.muted{color:#64748b;font-size:12px}.hidden{display:none}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .input{width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:10px;margin-top:6px}
    button{cursor:pointer}.btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:12px 14px;font-weight:600}
    .btn.alt{background:#0ea5e9}.btn.ghost{background:#e2e8f0;color:#0f172a}.btn.danger{background:#dc2626}
    table{width:100%;border-collapse:collapse}th,td{border:1px solid #e2e8f0;padding:6px;font-size:12px}thead th{background:#f1f5f9;text-align:left}
    details>summary{list-style:none;cursor:pointer;font-weight:700}
  </style>
</head>
<body>
<div class="app"><div class="phone">
  <header>
    <div class="brand"><div class="logo">E</div><h1>EstimaPres</h1></div>
    <div style="display:flex;gap:8px;align-items:center">
      <span id="authStatus" class="muted">No admin</span>
      <button id="btnShowLogin" class="btn ghost" style="padding:8px 10px">Admin</button>
      <button id="btnLogout" class="btn ghost hidden" style="padding:8px 10px">Salir</button>
    </div>
  </header>

  <main>
    <!-- Simulador -->
    <section class="card">
      <h2 style="margin:0 0 8px 0;font-size:16px">Simulador (pesos argentinos)</h2>
      <div class="row">
        <label><div class="label">Monto (ARS)</div><input id="simAmount" type="number" min="1000" step="500" class="input" placeholder="Ej: 200000" /></label>
        <label><div class="label">Cuotas (meses)</div><input id="simMonths" type="number" min="1" max="60" class="input" placeholder="Ej: 12" /></label>
      </div>
      <div class="muted" style="margin-top:6px">TNA vigente: <b><span id="tnaSpan">â€”</span>%</b> Â· Vencimiento: dÃ­a 10</div>
      <button id="btnSimulate" class="btn" style="width:100%;margin-top:10px">Simular</button>
      <button id="btnClear" class="btn ghost" style="width:100%;margin-top:8px">Limpiar</button>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px 0;font-size:15px">Resultado</h3>
      <div>Monto: <span id="rMonto">â€”</span></div>
      <div>Cuotas: <span id="rCuotas">â€”</span></div>
      <div>Cuota estimada: <span id="rCuota">â€”</span></div>
      <div id="tablaCuotasWrap" class="hidden" style="margin-top:8px">
        <div class="muted" style="margin-bottom:6px">Detalle cuota por cuota</div>
        <div style="overflow:auto">
          <table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th></tr></thead><tbody id="tablaCuotas"></tbody></table>
        </div>
      </div>
      <div class="muted" style="margin-top:6px">Sistema francÃ©s. La tasa puede cambiar hasta la aprobaciÃ³n.</div>
    </section>

    <!-- Solicitud -->
    <section class="card">
      <h2 style="margin:0 0 8px 0;font-size:16px">Solicitar prÃ©stamo</h2>
      <div class="row">
        <label><div class="label">Nombre y apellido</div><input id="rqName" class="input" placeholder="Tu nombre" /></label>
        <label><div class="label">DNI</div><input id="rqDni" class="input" placeholder="30123456" /></label>
      </div>
      <div class="row">
        <label><div class="label">Email</div><input id="rqEmail" type="email" class="input" placeholder="tucorreo@dominio.com" /></label>
        <label><div class="label">TelÃ©fono</div><input id="rqPhone" class="input" placeholder="Celular" /></label>
      </div>
      <label><div class="label">CBU/CVU o alias (depÃ³sito)</div><input id="rqAccount" class="input" placeholder="alias o CBU/CVU" /></label>
      <button id="btnSendRequest" class="btn alt" style="width:100%;margin-top:10px">Enviar solicitud</button>
      <div id="rqMsg" class="muted" style="margin-top:8px"></div>
    </section>

    <!-- Portal del cliente -->
    <section class="card" id="clientPortal">
      <h2 style="margin:0 0 8px 0;font-size:16px">Mi prÃ©stamo</h2>
      <div class="row">
        <label><div class="label">DNI</div><input id="cpDni" class="input" placeholder="30123456" /></label>
        <label><div class="label">Email</div><input id="cpEmail" type="email" class="input" placeholder="tucorreo@dominio.com" /></label>
      </div>
      <button id="btnClientView" class="btn ghost" style="width:100%;margin-top:10px">Ver mi prÃ©stamo</button>
      <div id="clientLoanBox" class="hidden" style="margin-top:10px"></div>
    </section>

    <!-- Panel Admin -->
    <section id="adminPanel" class="hidden">
      <div class="card">
        <h2 style="margin:0 0 8px 0;font-size:16px">1) Tasa centralizada (TNA %)</h2>
        <div class="row">
          <label><div class="label">TNA actual (%)</div><input id="tnaInput" type="number" step="0.01" class="input" /></label>
          <div style="display:flex;align-items:end"><button id="btnSaveTna" class="btn" style="width:100%">Guardar</button></div>
        </div>
        <div class="muted" style="margin-top:6px">Impacta en el simulador; los prÃ©stamos conservan la TNA capturada al aprobar.</div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px 0;font-size:16px">2) Solicitudes pendientes</h2>
        <div id="requestsList" class="muted"></div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px 0;font-size:16px">3) Preaprobados (contrato / OTP / depÃ³sito)</h2>
        <div id="preList" class="muted"></div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px 0;font-size:16px">4) PrÃ©stamos</h2>
        <details open><summary>Activos (agrupados por semÃ¡foro)</summary><div id="loansListActive" class="muted"></div></details>
        <details><summary>Inactivos (terminados/incobrables)</summary><div id="loansListInactive" class="muted"></div></details>
        <div id="loanDetail" class="card hidden" style="margin-top:8px"></div>
      </div>

      <!-- Clientes (resumen amigable) -->
      <div class="card">
        <h2 style="margin:0 0 8px 0;font-size:16px">Clientes</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <input id="searchDni" class="input" placeholder="Buscar por DNI" />
          <button id="btnSearchLoans" class="btn ghost">Buscar</button>
        </div>
        <div style="overflow:auto">
          <table>
            <thead><tr><th>DNI</th><th>Nombre</th><th>Email</th><th>TelÃ©fono</th><th>Activos</th><th>Inactivos</th><th>Pagadas</th><th>Pendientes</th><th>Restante</th><th>Mora mÃ¡x (d)</th><th></th></tr></thead>
            <tbody id="clientsTable"></tbody>
          </table>
        </div>
      </div>
      <!-- /Clientes -->
    </section>
  </main>
</div></div>

<!-- Login Admin -->
<dialog id="loginDlg">
  <form method="dialog" style="background:#fff;border-radius:12px;padding:16px;min-width:300px">
    <h3 style="margin:0 0 10px 0">Ingreso Admin</h3>
    <label class="label">Email<input id="lgEmail" type="email" class="input" /></label>
    <label class="label" style="display:block;margin-top:8px">Password<input id="lgPass" type="password" class="input" /></label>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="btnLogin" type="button" class="btn">Ingresar</button>
      <button class="btn ghost">Cerrar</button>
    </div>
    <div id="lgMsg" class="muted err"></div>
  </form>
</dialog><!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<!-- PDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script>
// PWA (sin cachÃ© agresivo)
if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('/sw.js').catch(()=>{}));}

// Firebase
const firebaseConfig={apiKey:"AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",authDomain:"estimapres.firebaseapp.com",projectId:"estimapres",storageBucket:"estimapres.appspot.com",messagingSenderId:"578516597437",appId:"1:578516597437:web:f59994b87729aa1cd655d4"};
firebase.initializeApp(firebaseConfig); const auth=firebase.auth(); const db=firebase.firestore();

// Utils
const $=s=>document.querySelector(s);
const fmtARS=n=>new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n||0);
const toAR=iso=>new Date(iso).toLocaleDateString('es-AR'); const pct=x=>(x*100).toFixed(2);
const TNA_FALLBACK=120;
function calcTEA(tna){const r=(tna/100)/12;return ((1+r)**12-1)*100;}
async function sha256Hex(str){const buf=new TextEncoder().encode(str);const h=await crypto.subtle.digest('SHA-256',buf);return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('');}
const genOtp=()=>''+Math.floor(100000+Math.random()*900000);

function frenchSchedule(P,m,tna){const r=(tna/100)/12;if(r<=0||m<=0)return{installment:0,total:0,schedule:[]};const A=P*r/(1-(1+r)**(-m));let bal=P;const s=[];for(let k=1;k<=m;k++){const i=bal*r,c=A-i;bal=Math.max(0,bal-c);const d=new Date();d.setMonth(d.getMonth()+k);d.setDate(10);s.push({k,installment:+A.toFixed(2),capital:+c.toFixed(2),interest:+i.toFixed(2),dueDate:d.toISOString(),paid:false});}return{installment:+A.toFixed(2),total:+(A*m).toFixed(2),schedule:s};}
function computeTotals(s){const tot=s.reduce((a,b)=>a+(b.installment||0),0);const pag=s.filter(x=>x.paid).reduce((a,b)=>a+(b.installment||0),0);return{total:tot,pagado:pag,restante:tot-pag};}
function loanStatusColor(s){const t=new Date();let md=0;s.forEach(c=>{if(!c.paid){const d=Math.floor((t-new Date(c.dueDate))/86400000);if(d>md)md=d;}});if(md<=5)return'ðŸŸ¢';if(md<=10)return'ðŸŸ¡';return'ðŸ”´';}
const statusKey=s=>s==='ðŸŸ¢'?'green':s==='ðŸŸ¡'?'yellow':'red', colorEmoji=k=>k==='green'?'ðŸŸ¢':k==='yellow'?'ðŸŸ¡':'ðŸ”´', colorTitle=k=>k==='green'?'Al dÃ­a':k==='yellow'?'Mora 6â€“10 dÃ­as':'Mora >10 dÃ­as';

// TNA realtime
const tnaSpan=$('#tnaSpan'), tnaInput=$('#tnaInput');
db.doc('settings/global').onSnapshot(d=>{const t=d.data()?.tna??TNA_FALLBACK;tnaSpan.textContent=t;if(tnaInput)tnaInput.value=t;},_=>{tnaSpan.textContent=TNA_FALLBACK;if(tnaInput)tnaInput.value=TNA_FALLBACK;});

// Simulador
$('#btnSimulate').onclick=async()=>{const amount=+$('#simAmount').value,months=+$('#simMonths').value;if(!amount||!months)return alert('CompletÃ¡ monto y cuotas');let tna=TNA_FALLBACK;try{tna=(await db.doc('settings/global').get()).data()?.tna??TNA_FALLBACK;}catch{}const {installment,schedule}=frenchSchedule(amount,months,tna);$('#rMonto').textContent=fmtARS(amount);$('#rCuotas').textContent=months;$('#rCuota').textContent=installment?fmtARS(installment):'â€”';const tb=$('#tablaCuotas');tb.innerHTML='';schedule.forEach(it=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${it.k}</td><td>${toAR(it.dueDate)}</td><td>${fmtARS(it.installment)}</td>`;tb.appendChild(tr);});$('#tablaCuotasWrap').classList.remove('hidden');};
$('#btnClear').onclick=()=>{$('#simAmount').value='';$('#simMonths').value='';$('#rMonto').textContent='â€”';$('#rCuotas').textContent='â€”';$('#rCuota').textContent='â€”';$('#tablaCuotas').innerHTML='';$('#tablaCuotasWrap').classList.add('hidden');};

// Enviar solicitud
$('#btnSendRequest').onclick=async()=>{const name=$('#rqName').value.trim(),dni=$('#rqDni').value.trim(),email=$('#rqEmail').value.trim(),phone=$('#rqPhone').value.trim(),bankDest=$('#rqAccount').value.trim();const amount=+$('#simAmount').value,months=+$('#simMonths').value;const msg=$('#rqMsg');msg.textContent='';if(!name||!dni||!email||!amount||!months){msg.textContent='CompletÃ¡ datos y simulaciÃ³n.';msg.className='muted err';return;}let tna=TNA_FALLBACK;try{tna=(await db.doc('settings/global').get()).data()?.tna??TNA_FALLBACK;}catch{}const {installment}=frenchSchedule(amount,months,tna);try{await db.collection('loan_requests').add({name,dni,email,phone,bankDest,amount,months,tnaSnapshot:tna,installment,status:'pending',createdAt:firebase.firestore.FieldValue.serverTimestamp()});msg.textContent='Solicitud enviada.';msg.className='muted ok';}catch(e){msg.textContent='No se pudo enviar: '+(e.message||e);msg.className='muted err';}};

// Auth admin
const loginDlg=$('#loginDlg');$('#btnShowLogin').onclick=()=>loginDlg.showModal();$('#btnLogin').onclick=async()=>{try{await auth.signInWithEmailAndPassword($('#lgEmail').value,$('#lgPass').value);loginDlg.close();}catch(e){$('#lgMsg').textContent=e.message;}};$('#btnLogout').onclick=()=>auth.signOut().then(()=>location.reload());
auth.onAuthStateChanged(u=>{const p=$('#adminPanel');const t=$('#authStatus');const lo=$('#btnLogout');if(u){p.classList.remove('hidden');t.textContent='Admin';lo.classList.remove('hidden');mountAdmin();}else{p.classList.add('hidden');t.textContent='No admin';lo.classList.add('hidden');}});

// Portal del cliente
function renderClientLoan(container,pub){const {borrower,principal,months,tna,schedule,status,accepted,signedAt}=pub;const {total,pagado,restante}=computeTotals(schedule);container.classList.remove('hidden');container.innerHTML=`<div style="font-weight:700">${borrower.name||''} Â· DNI ${borrower.dni} Â· Estado: ${status}</div><div class="muted">Capital ${fmtARS(principal)} Â· ${months} cuotas Â· TNA ${tna}%</div><div class="muted" style="margin:6px 0 10px 0">Total: ${fmtARS(total)} Â· Pagado: ${fmtARS(pagado)} Â· Restante: ${fmtARS(restante)}</div><div style="overflow:auto"><table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead><tbody>${schedule.map(c=>`<tr><td>${c.k}</td><td>${toAR(c.dueDate)}</td><td>${fmtARS(c.installment)}</td><td>${c.paid?'Pagada':'Pendiente'}</td></tr>`).join('')}</tbody></table></div><div style="margin-top:10px">${accepted?`<div class="ok">Contrato aceptado${signedAt?' el '+(signedAt?.toDate?.()?signedAt.toDate().toLocaleString('es-AR'):new Date(signedAt).toLocaleString('es-AR')):''}</div>`:`<label class="label">IngresÃ¡ tu cÃ³digo OTP<input id="otpInput" class="input" placeholder="6 dÃ­gitos" /></label><button id="btnFirmarOtp" class="btn" style="margin-top:8px">Firmar con OTP</button>`}</div>${accepted?`<button id="btnDescargarContrato" class="btn ghost" style="margin-top:8px">Descargar contrato (PDF)</button>`:''}`;if(!accepted){document.getElementById('btnFirmarOtp').onclick=()=>clientAcceptByOtp(pub);}else{document.getElementById('btnDescargarContrato').onclick=()=>downloadClientContract(pub);}}
document.getElementById('btnClientView')?.addEventListener('click',async()=>{const dni=$('#cpDni').value.trim(),email=($('#cpEmail').value||'').trim().toLowerCase();if(!dni||!email)return alert('CompletÃ¡ DNI y email');const snap=await db.collection('public_loans').where('borrower.dni','==',dni).where('borrower.email','==',email).orderBy('createdAt','desc').limit(1).get();const box=$('#clientLoanBox');if(snap.empty){box.classList.remove('hidden');box.innerHTML='<div class="muted err">No se encontrÃ³ un prÃ©stamo con esos datos.</div>';return;}renderClientLoan(box,snap.docs[0].data());});
async function clientAcceptByOtp(pub){const box=$('#clientLoanBox');const code=($('#otpInput').value||'').trim();if(code.length!==6)return alert('CÃ³digo invÃ¡lido');const hash=await sha256Hex(code);const snap=await db.collection('public_loans').where('loanId','==',pub.loanId).limit(1).get();if(snap.empty){alert('No encontrado');return;}const ref=snap.docs[0].ref;const data=snap.docs[0].data();if(!data.otpHash||!data.otpExp)return alert('OTP no iniciado.');if(Date.now()>data.otpExp)return alert('OTP vencido.');if(hash!==data.otpHash)return alert('CÃ³digo incorrecto.');await ref.update({accepted:true,signedAt:firebase.firestore.FieldValue.serverTimestamp()});box.innerHTML='<div class="ok">Â¡Contrato firmado! ActualizÃ¡ para ver el PDF.</div>';}

// Mostrar errores silenciosos
window.addEventListener('unhandledrejection', ev=>alert('Error de datos: '+(ev.reason?.message||ev.reason||'desconocido')));
</script><script>
// ===== PDF contrato =====
function generateContractPdf(loanId,L){const{jsPDF}=window.jspdf;const doc=new jsPDF({unit:'pt',format:'a4',compress:true});let y=40;const TEA=calcTEA(L.tna),CFT=TEA;doc.setFont('helvetica','bold').setFontSize(14).text('CONTRATO DE MUTUO â€” EstimaPres',40,y);y+=18;doc.setFont('helvetica','').setFontSize(10);[ `Prestatario: ${L.borrower.name} (DNI ${L.borrower.dni}) â€” Email ${L.borrower.email}`, `Capital: ${fmtARS(L.principal)} â€” Plazo: ${L.months} meses (francÃ©s)`, `TNA: ${L.tna}% â€” TEA aprox: ${pct(TEA/100)}% â€” CFT estimado: ${pct(CFT/100)}%`, `1er vencimiento: ${toAR(L.schedule[0].dueDate)} â€” Vencimientos: dÃ­a 10`, `AceptaciÃ³n electrÃ³nica por OTP`].forEach(t=>{doc.text(t,40,y);y+=14;});y+=6;doc.setFont('helvetica','bold').text('Anexo â€” Cronograma',40,y);y+=6;const rows=(L.schedule||[]).map(c=>[c.k,toAR(c.dueDate),fmtARS(c.installment),fmtARS(c.capital),fmtARS(c.interest),c.paid?'Pagada':'Pendiente']);doc.autoTable({startY:y,head:[['#','Vencimiento','Cuota','Capital','InterÃ©s','Estado']],body:rows,styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:[10,47,115]}});doc.text('La aceptaciÃ³n por OTP queda registrada en EstimaPres.',40,(doc.lastAutoTable.finalY||y)+24);doc.save(`Contrato_EstimaPres_${loanId}.pdf`);}

// ===== Helpers admin =====
async function ensurePublicDoc(loanId,L){const q=await db.collection('public_loans').where('loanId','==',loanId).limit(1).get();if(!q.empty)return;await db.collection('public_loans').add({loanId,borrower:{dni:(L.borrower?.dni||''),email:(L.borrower?.email||'').toLowerCase(),name:L.borrower?.name||''},principal:L.principal,months:L.months,tna:L.tna,status:(L.status||'preapproved'),disbursed:!!L.disbursed,accepted:false,schedule:(L.schedule||[]).map(c=>({k:c.k,dueDate:c.dueDate,installment:c.installment,paid:c.paid})),createdAt:firebase.firestore.FieldValue.serverTimestamp()});}
async function startOtpForLoan(loanId,L){await ensurePublicDoc(loanId,L);const q=await db.collection('public_loans').where('loanId','==',loanId).limit(1).get();const ref=q.docs[0].ref;const code=genOtp();const otpHash=await sha256Hex(code);await ref.set({otpHash,otpExp:Date.now()+15*60*1000,accepted:false},{merge:true});const txt=`Hola ${L.borrower.name}, tu cÃ³digo OTP es ${code} (vence en 15 min).`;const wa=`https://wa.me/?text=${encodeURIComponent(txt)}`;if(confirm(`OTP generado: ${code}\n\nÂ¿Abrir WhatsApp para enviar?`))window.open(wa,'_blank');}
async function reflectPublicSchedule(loanId,s){const q=await db.collection('public_loans').where('loanId','==',loanId).limit(1).get();if(!q.empty){await q.docs[0].ref.update({schedule:s.map(c=>({k:c.k,dueDate:c.dueDate,installment:c.installment,paid:c.paid}))});}}

// ===== Renderers =====
function cardReq(id,r){const d=document.createElement('div');d.className='card';d.innerHTML=`<div style="font-weight:700">${r.name} Â· DNI ${r.dni}</div><div class="muted">${fmtARS(r.amount)} Â· ${r.months} cuotas Â· TNA ${r.tnaSnapshot}% Â· Cuota ${fmtARS(r.installment)}</div><div class="muted">${r.email}${r.phone?' Â· '+r.phone:''}</div><div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap"><button class="btn" data-ok="${id}">Preaprobar</button><button class="btn danger" data-ko="${id}">Rechazar</button></div>`;return d;}
function cardPre(id,L){const d=document.createElement('div');d.className='card';d.innerHTML=`<div style="font-weight:700">ðŸŸ¦ ${L.borrower.name} Â· DNI ${L.borrower.dni}</div><div class="muted">Principal ${fmtARS(L.principal)} Â· ${L.months} cuotas Â· TNA ${L.tna}%</div><div class="muted">DepÃ³sito: ${L.disbursed?'Realizado':'Pendiente'}</div><div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap"><button class="btn ghost" data-contrato="${id}">Contrato (PDF)</button><button class="btn ghost" data-otp="${id}">Iniciar OTP</button><button class="btn" data-dep="${id}">Acreditar</button><button class="btn ghost" data-aprobar="${id}">Mover a Activo</button></div>`;return d;}
function listItem(id,L,before=''){const d=document.createElement('div');d.className='card';d.innerHTML=`${before}<div style="font-weight:700">${L.borrower.name} Â· DNI ${L.borrower.dni}</div><div class="muted">Principal ${fmtARS(L.principal)} Â· ${L.months} cuotas Â· TNA ${L.tna}%</div><div><button class="btn ghost" data-open="${id}">Ver</button></div>`;return d;}
function rowCuota(it,loanId){const tr=document.createElement('tr');tr.innerHTML=`<td>${it.k}</td><td>${toAR(it.dueDate)}</td><td>${fmtARS(it.installment)}</td><td>${fmtARS(it.capital)}</td><td>${fmtARS(it.interest)}</td><td><label style="display:inline-flex;gap:6px;align-items:center"><input type="checkbox" data-loan="${loanId}" data-k="${it.k}" ${it.paid?'checked':''}/><span>${it.paid?'Pagada':'Pendiente'}</span></label></td>`;return tr;}

// ===== Aprobar (PRE) =====
async function approveRequest(id,r){
  try{
    const { schedule } = frenchSchedule(r.amount, r.months, r.tnaSnapshot);
    const dni=(r.dni||'').trim(); const email=((r.email||'')+'').trim().toLowerCase();

    const loan = {
      borrower:{ name:r.name, dni, email, phone:r.phone||'', bankDest:r.bankDest||'' },
      principal:r.amount, months:r.months, tna:r.tnaSnapshot,
      status:'preapproved', schedule, disbursed:false,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    };

    const batch = db.batch();
    const loanRef = db.collection('loans').doc();
    batch.set(loanRef, loan);

    // PodÃ©s borrar la solicitud para que salga de "pendientes"
    batch.delete(db.collection('loan_requests').doc(id));

    // Espejo pÃºblico (portal cliente) en estado preaprobado
    const pubRef = db.collection('public_loans').doc();
    batch.set(pubRef,{
      loanId: loanRef.id,
      borrower:{ dni, email, name:r.name },
      principal:r.amount, months:r.months, tna:r.tnaSnapshot,
      status:'preapproved', disbursed:false, accepted:false,
      schedule: schedule.map(c=>({k:c.k,dueDate:c.dueDate,installment:c.installment,paid:c.paid})),
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });

    await batch.commit();
    alert('Preaprobado creado');
    loadAll();
  }catch(e){
    alert('Error al preaprobar: ' + (e.message || e));
  }
}

// ===== Detalle de prÃ©stamo =====
async function renderDetail(loanId){
  const box=$('#loanDetail'); box.classList.remove('hidden');
  const snap=await db.collection('loans').doc(loanId).get(); const L=snap.data();
  await ensurePublicDoc(loanId,L);
  const {total,pagado,restante}=computeTotals(L.schedule);
  box.innerHTML=`<div style="font-weight:700">${loanStatusColor(L.schedule)} ${L.borrower.name} Â· DNI ${L.borrower.dni} Â· <span class="muted">Estado: ${L.status}</span></div><div class="muted">Principal ${fmtARS(L.principal)} Â· ${L.months} cuotas Â· TNA ${L.tna}%</div><div class="muted" style="margin:6px 0 10px">Total ${fmtARS(total)} Â· Pagado ${fmtARS(pagado)} Â· Restante ${fmtARS(restante)}</div><div style="overflow:auto"><table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Capital</th><th>InterÃ©s</th><th>Estado</th></tr></thead><tbody id="loanRows"></tbody></table></div><div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px"><button class="btn ghost" id="dContrato">Contrato (PDF)</button><button class="btn ghost" id="dOtp">Iniciar OTP</button>${(!L.disbursed && (L.status==='preapproved'||L.status==='active'))?'<button class="btn" id="dDep">Acreditar</button>':''}${L.status==='preapproved'?'<button class="btn" id="dActivar">Mover a Activo</button>':''}<button class="btn ghost" id="dInac">Marcar inactivo</button></div>`;
  const tb=box.querySelector('#loanRows');tb.innerHTML='';(L.schedule||[]).forEach(it=>tb.appendChild(rowCuota(it,loanId)));
  tb.querySelectorAll('input[type="checkbox"]').forEach(chk=>{chk.onchange=async()=>{const k=+chk.getAttribute('data-k');const ref=db.collection('loans').doc(loanId);const C=(await ref.get()).data();const s=C.schedule.map(x=>x.k===k?({...x,paid:chk.checked,paidAt:chk.checked?new Date().toISOString():null}):x);await ref.update({schedule:s});const t=computeTotals(s);box.querySelectorAll('.muted')[1].textContent=`Total ${fmtARS(t.total)} Â· Pagado ${fmtARS(t.pagado)} Â· Restante ${fmtARS(t.restante)}`;chk.nextElementSibling.textContent=chk.checked?'Pagada':'Pendiente';await reflectPublicSchedule(loanId,s);loadClients();};});
  box.querySelector('#dContrato').onclick=()=>generateContractPdf(loanId,L);
  box.querySelector('#dOtp').onclick=()=>startOtpForLoan(loanId,L);
  const dep=box.querySelector('#dDep'); if(dep){dep.onclick=async()=>{const method=prompt('MÃ©todo (transferencia/MP/etc.)','transferencia');const dest=L.borrower?.bankDest||prompt('Destino (CBU/CVU/alias)','');const refOp=prompt('NÂº operaciÃ³n/ref','');await db.collection('loans').doc(loanId).update({disbursed:true,disbursedAt:firebase.firestore.FieldValue.serverTimestamp(),disbursement:{method,dest,ref:refOp}});await db.collection('public_loans').where('loanId','==',loanId).limit(1).get().then(q=>{if(!q.empty)q.docs[0].ref.update({disbursed:true,disbursedAt:firebase.firestore.FieldValue.serverTimestamp()});});alert('AcreditaciÃ³n registrada');loadAll();box.classList.add('hidden');};}
  const act=box.querySelector('#dActivar'); if(act){act.onclick=async()=>{await db.collection('loans').doc(loanId).update({status:'active'});await db.collection('public_loans').where('loanId','==',loanId).limit(1).get().then(q=>{if(!q.empty)q.docs[0].ref.update({status:'active'});});alert('Movido a Activo');loadAll();box.classList.add('hidden');};}
  box.querySelector('#dInac').onclick=async()=>{await db.collection('loans').doc(loanId).update({status:'inactive',inactivatedAt:firebase.firestore.FieldValue.serverTimestamp()});await db.collection('public_loans').where('loanId','==',loanId).limit(1).get().then(q=>{if(!q.empty)q.docs[0].ref.update({status:'inactive'});});alert('Marcado como inactivo');loadAll();box.classList.add('hidden');};
}

// ===== Listados =====
async function loadRequests(){const box=$('#requestsList');box.innerHTML='Cargandoâ€¦';const q=await db.collection('loan_requests').orderBy('createdAt','desc').get();box.innerHTML='';q.docs.forEach(d=>{const r=d.data();if((r.status||'pending')==='pending')box.appendChild(cardReq(d.id,r));});if(!box.innerHTML)box.textContent='Sin solicitudes pendientes';box.querySelectorAll('[data-ok]').forEach(b=>b.onclick=async()=>{const id=b.getAttribute('data-ok');const r=(await db.collection('loan_requests').doc(id).get()).data();await approveRequest(id,r);});box.querySelectorAll('[data-ko]').forEach(b=>b.onclick=async()=>{const id=b.getAttribute('data-ko');await db.collection('loan_requests').doc(id).delete();loadRequests();});}
async function loadPreapproved(){const box=$('#preList');box.innerHTML='Cargandoâ€¦';const q=await db.collection('loans').where('status','==','preapproved').get();box.innerHTML='';const arr=q.docs.map(d=>({id:d.id,L:d.data()}));arr.sort((a,b)=>{const ta=a.L.createdAt?.toMillis?.()||0,tb=b.L.createdAt?.toMillis?.()||0;return tb-ta;});arr.forEach(({id,L})=>box.appendChild(cardPre(id,L)));if(!box.innerHTML)box.textContent='Sin preaprobados';box.querySelectorAll('[data-contrato]').forEach(b=>b.onclick=async()=>{const id=b.getAttribute('data-contrato');const L=(await db.collection('loans').doc(id).get()).data();generateContractPdf(id,L);});box.querySelectorAll('[data-otp]').forEach(b=>b.onclick=async()=>{const id=b.getAttribute('data-otp');const L=(await db.collection('loans').doc(id).get()).data();startOtpForLoan(id,L);});box.querySelectorAll('[data-dep]').forEach(b=>b.onclick=async()=>{const id=b.getAttribute('data-dep');const snap=await db.collection('loans').doc(id).get();const L=snap.data();const method=prompt('MÃ©todo (transferencia/MP/etc.)','transferencia');const dest=L.borrower?.bankDest||prompt('Destino (CBU/CVU/alias)','');const refOp=prompt('NÂº operaciÃ³n/ref','');await db.collection('loans').doc(id).update({disbursed:true,disbursedAt:firebase.firestore.FieldValue.serverTimestamp(),disbursement:{method,dest,ref:refOp}});await db.collection('public_loans').where('loanId','==',id).limit(1).get().then(q=>{if(!q.empty)q.docs[0].ref.update({disbursed:true,disbursedAt:firebase.firestore.FieldValue.serverTimestamp()});});alert('AcreditaciÃ³n registrada');loadAll();});box.querySelectorAll('[data-aprobar]').forEach(b=>b.onclick=async()=>{const id=b.getAttribute('data-aprobar');await db.collection('loans').doc(id).update({status:'active'});await db.collection('public_loans').where('loanId','==',id).limit(1).get().then(q=>{if(!q.empty)q.docs[0].ref.update({status:'active'});});alert('Movido a Activo');loadAll();});}
async function loadLoans(){const activeBox=$('#loansListActive'),inactiveBox=$('#loansListInactive');activeBox.innerHTML='Cargandoâ€¦';inactiveBox.innerHTML='';const snap=await db.collection('loans').orderBy('createdAt','desc').get();activeBox.innerHTML='';const groups={green:[],yellow:[],red:[]};snap.docs.forEach(d=>{const L=d.data();if(L.status==='active'){groups[statusKey(loanStatusColor(L.schedule))].push({id:d.id,L});}else if(L.status!=='preapproved'){const item=listItem(d.id,L,'ðŸŸ¦ ');inactiveBox.appendChild(item);}});['green','yellow','red'].forEach(k=>{const arr=groups[k];if(!arr.length)return;const sec=document.createElement('div');sec.innerHTML=`<div style="font-weight:700;margin:6px 0">${colorEmoji(k)} ${colorTitle(k)}</div>`;arr.forEach(({id,L})=>sec.appendChild(listItem(id,L)));activeBox.appendChild(sec);});if(!activeBox.innerHTML)activeBox.textContent='Sin prÃ©stamos activos';if(!inactiveBox.innerHTML)inactiveBox.textContent='Sin prÃ©stamos inactivos';document.querySelectorAll('[data-open]').forEach(b=>b.onclick=()=>renderDetail(b.getAttribute('data-open')));}
async function loadClients(){const tbody=$('#clientsTable');if(!tbody)return;tbody.innerHTML='<tr><td colspan="11">Cargandoâ€¦</td></tr>';const snap=await db.collection('loans').get();const map=new Map();snap.docs.forEach(doc=>{const L=doc.data(),s=L.schedule||[];const key=L.borrower?.dni||'sin_dni';const e=map.get(key)||{dni:key,name:L.borrower?.name||'',email:L.borrower?.email||'',phone:L.borrower?.phone||'',activos:0,inactivos:0,pagadas:0,pendientes:0,restante:0,moraMax:0};if(L.status==='active')e.activos++;else if(L.status!=='preapproved')e.inactivos++;e.pagadas+=s.filter(x=>x.paid).length;e.pendientes+=s.filter(x=>!x.paid).length;const t=computeTotals(s);e.restante+=t.restante||0;e.moraMax=Math.max(e.moraMax,(function(){let md=0,today=new Date();(s||[]).forEach(c=>{if(!c.paid){const dd=Math.floor((today-new Date(c.dueDate))/86400000);if(dd>md)md=dd;}});return Math.max(0,md);})());e.name=e.name||L.borrower?.name||'';e.email=e.email||L.borrower?.email||'';e.phone=e.phone||L.borrower?.phone||'';map.set(key,e);});const rows=[...map.values()].sort((a,b)=>a.name.localeCompare(b.name));tbody.innerHTML='';rows.forEach(c=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${c.dni}</td><td>${c.name}</td><td>${c.email}</td><td>${c.phone}</td><td>${c.activos}</td><td>${c.inactivos}</td><td>${c.pagadas}</td><td>${c.pendientes}</td><td>${fmtARS(c.restante)}</td><td>${c.moraMax}</td><td><button class="btn ghost" data-open-dni="${c.dni}">Ver</button></td>`;tbody.appendChild(tr);});tbody.querySelectorAll('[data-open-dni]').forEach(btn=>{btn.onclick=async()=>{const dni=btn.getAttribute('data-open-dni');const q=await db.collection('loans').where('borrower.dni','==',dni).get();if(q.empty){alert('Sin resultados');return;}let newest=q.docs[0];let maxTs=newest.data().createdAt?.toMillis?.()||0;q.docs.forEach(d=>{const t=d.data().createdAt?.toMillis?.()||0;if(t>maxTs){newest=d;maxTs=t;}});renderDetail(newest.id,newest.data());};});}

// ===== Montaje admin =====
function mountAdmin(){loadAll();$('#btnSaveTna').onclick=async()=>{const tna=+$('#tnaInput').value;if(isNaN(tna)||tna<0)return alert('TNA invÃ¡lida');await db.doc('settings/global').set({tna,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});alert('TNA actualizada');};$('#btnSearchLoans').onclick=async()=>{const dni=$('#searchDni').value.trim();if(!dni)return;const q=await db.collection('loans').where('borrower.dni','==',dni).limit(1).get();if(q.empty){alert('Sin resultados');return;}renderDetail(q.docs[0].id,q.docs[0].data());};}
function loadAll(){loadRequests();loadPreapproved();loadLoans();loadClients();}
</script>
</body>
</html>