<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EstimaPres ¬∑ Pr√©stamos personales</title>

<link rel="icon" type="image/png" href="assets/ping.png"/>
<link rel="manifest" href="manifest.webmanifest"/>

<style>
  :root{
    --brand:#0b5cff; --brand-dark:#073ea7; --ok:#28a745; --bad:#dc3545; --ink:#0b1324;
    --muted:#667085; --bg:#f6f7fb; --card:#ffffff; --shadow:0 6px 18px rgba(16,24,40,.08);
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  /* ---------- HEADER ---------- */
  header{
    background:linear-gradient(90deg,#0b5cff,#4aa3ff);
    color:#fff; padding:28px 16px 20px;
    box-shadow:var(--shadow);
  }
  .hdr-wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr auto;gap:16px;align-items:center}
  .brand{
    display:flex; align-items:center; gap:14px; flex-wrap:wrap;
  }
  .brand h1{
    margin:0; font-size:42px; line-height:1; letter-spacing:.4px; font-weight:800;
    display:flex; align-items:center; gap:12px;
  }
  .brand h1 img{height:46px; width:auto; display:inline-block; vertical-align:middle}
  .slogan{
    margin:10px 0 0; display:inline-block; background:rgba(255,255,255,.15);
    padding:10px 16px; border-radius:999px; font-weight:600
  }
  .slogan em{font-style:italic; opacity:.95}
  .actions{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .btn{border:2px solid transparent; border-radius:12px; padding:10px 16px; font-weight:700; cursor:pointer}
  .btn-ghost{background:#fff;color:var(--brand);border-color:var(--brand)}
  .btn-admin{background:#0b1f4f;color:#fff}
  .btn-exit{background:var(--bad); color:#fff}
  .icon{opacity:.9}
  /* ---------- LAYOUT ---------- */
  main{max-width:1100px;margin:20px auto;padding:0 16px 48px}
  section.card{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:18px; margin:16px 0
  }
  h2{margin:0 0 12px;font-size:28px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:760px){ .row{grid-template-columns:1fr} }
  label{font-size:14px;color:var(--muted);display:block;margin:.25rem 0}
  input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #d0d5dd;font-size:16px}
  .hint{color:var(--muted);font-size:14px;margin:6px 0 10px}
  .btn-wide{width:100%;padding:14px 16px;border-radius:12px;background:var(--ok);color:#fff;border:none;font-weight:800}
  .btn-primary{background:var(--brand);color:#fff;border:none}
  .btn-danger{background:var(--bad);color:#fff;border:none}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700}
  .pill-green{background:#e9fbe9;color:#1f7a39}
  .pill-yellow{background:#fff6e5;color:#8a5a00}
  .pill-red{background:#ffe8ea;color:#9d2130}
  .list{display:flex;flex-direction:column;gap:12px}
  .item{border:1px solid #e9eaee;border-radius:14px;padding:12px}
  .item h4{margin:0 0 6px}
  .item .meta{color:var(--muted);font-size:14px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid #eef0f4;text-align:left}
  th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.6px}
  .right{text-align:right}
  .muted{color:var(--muted)}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media (max-width:820px){ .grid-3{grid-template-columns:1fr} }
  .badge{padding:4px 8px;border-radius:8px;background:#eef2ff;color:#2c3e94;font-weight:700}
  .btn-sm{padding:8px 10px;border-radius:10px;border:none;font-weight:700}
  .btn-outline{background:#fff;border:1px solid #d0d5dd;color:#111827}
  .section-title{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .nowrap{white-space:nowrap}
  .divider{height:1px;background:#eef0f4;margin:8px 0}
  .success{color:#1f7a39;font-weight:800}
  .danger{color:#9d2130;font-weight:800}
</style>
</head>
<body>

<!-- =================== HEADER =================== -->
<header>
  <div class="hdr-wrap">
    <div class="brand">
      <!-- Icono EXACTAMENTE antes de la E -->
      <h1><img src="assets/ping.png" alt="logo">EstimaPres</h1>
      <span class="slogan">Pr√©stamos personales ¬∑ <em>simple y claro</em></span>
    </div>
    <div class="actions">
      <button id="btnMyLoanTop" class="btn btn-ghost">üîç Ver mi pr√©stamo</button>
      <button id="btnAdminTop" class="btn btn-admin">üë§ Admin</button>
      <button id="btnLogout" class="btn btn-exit">‚Ü© Salir</button>
    </div>
  </div>
</header>

<main>

  <!-- =================== SIMULADOR =================== -->
  <section class="card" id="secSim">
    <h2>Simulador</h2>
    <div class="row">
      <div>
        <label>Monto</label>
        <input id="simAmount" inputmode="numeric" placeholder="$ 1.000.000"/>
      </div>
      <div>
        <label>Meses</label>
        <input id="simMonths" inputmode="numeric" placeholder="Ej: 12"/>
      </div>
    </div>
    <div class="hint">TNA vigente: <span id="lblTNA">‚Äî%</span> ¬∑ Vencimiento: d√≠a <b id="lblDue">10</b></div>
    <button id="btnSim" class="btn-wide">Simular</button>
    <div id="simResult"></div>
  </section>

  <!-- =================== SOLICITAR =================== -->
  <section class="card" id="secRequest">
    <h2>Solicitar pr√©stamo</h2>
    <div class="row">
      <div>
        <label>Tu nombre</label>
        <input id="rqName" placeholder="Juan P√©rez"/>
      </div>
      <div>
        <label>DNI</label>
        <input id="rqDni" inputmode="numeric" placeholder="30123456"/>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Email</label>
        <input id="rqEmail" type="email" placeholder="tucorreo@mail.com"/>
      </div>
      <div>
        <label>Tel√©fono</label>
        <input id="rqPhone" inputmode="tel" placeholder="11 2345 6789"/>
      </div>
    </div>
    <div>
      <label>Alias o CBU/CVU</label>
      <input id="rqCbu" placeholder="alias o CBU/CVU"/>
    </div>
    <button id="btnSendReq" class="btn-wide btn-primary" style="margin-top:8px">Enviar solicitud</button>
    <div class="hint">Al enviar acept√°s ser contactado por EstimaPres.</div>
  </section>

  <!-- =================== ADMIN =================== -->
  <section class="card" id="secAdmin" style="display:none">
    <div class="section-title">
      <h2>Panel administrador</h2>
      <span id="adminBadge" class="badge">Modo admin</span>
    </div>

    <!-- TNA -->
    <div class="row">
      <div>
        <label>TNA</label>
        <input id="admTna" inputmode="numeric" />
      </div>
      <div style="display:flex;align-items:flex-end">
        <button id="btnSaveTna" class="btn-wide">Guardar</button>
      </div>
    </div>

    <!-- Solicitudes pendientes -->
    <div class="divider"></div>
    <div class="section-title">
      <h2>Solicitudes pendientes</h2>
      <button id="btnReloadPend" class="btn-sm btn-outline">Recargar</button>
    </div>
    <div id="listPend" class="list"><div class="muted">Sin pendientes</div></div>

    <!-- Preaprobados -->
    <div class="divider"></div>
    <div class="section-title">
      <h2>Preaprobados</h2>
      <button id="btnReloadPre" class="btn-sm btn-outline">Recargar</button>
    </div>
    <div id="listPre" class="list"><div class="muted">Sin preaprobados</div></div>

    <!-- Activos -->
    <div class="divider"></div>
    <div class="section-title">
      <h2>Activos</h2>
      <button id="btnReloadAct" class="btn-sm btn-outline">Recargar</button>
    </div>
    <div id="listAct" class="list"><div class="muted">Sin activos</div></div>

    <!-- Inactivos -->
    <div class="divider"></div>
    <div class="section-title">
      <h2>Inactivos (finalizados / incobrables)</h2>
      <div class="grid-3">
        <button id="tabFinished" class="btn-sm btn-outline">Cancelados</button>
        <button id="tabCharged" class="btn-sm btn-outline">Incobrables</button>
        <button id="btnReloadInact" class="btn-sm btn-outline">Recargar</button>
      </div>
    </div>
    <div id="listInact" class="list"><div class="muted">Sin inactivos</div></div>
  </section>

  <!-- =================== VER MI PR√âSTAMO =================== -->
  <section class="card" id="secMyLoan">
    <h2>Ver mi pr√©stamo</h2>
    <div class="row">
      <div>
        <label>Ingres√° tu DNI</label>
        <input id="myDni" inputmode="numeric" placeholder="30123456"/>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button id="btnFindMyLoan" class="btn-wide btn-primary">Consultar</button>
      </div>
    </div>
    <div id="myLoanResult" style="margin-top:10px"></div>
  </section>

</main>

<!-- =================== SCRIPTS (Firebase + App) =================== -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
/*** UTIL ***/
const $ = sel => document.querySelector(sel);
const fmt = n => n.toLocaleString('es-AR');
const money = n => '$ ' + fmt(Math.round(n));
const onlyDigits = s => (s||'').toString().replace(/\D+/g,'');
const nowTS = () => firebase.firestore.FieldValue.serverTimestamp();

/* Formatea campo moneda mientras escriben */
const wireCurrency = (input)=> {
  input.addEventListener('input',()=>{
    const raw = onlyDigits(input.value);
    if(!raw){ input.value=''; return; }
    input.value = '$ ' + Number(raw).toLocaleString('es-AR');
  });
};

/*** FIREBASE ***/
// ‚¨áÔ∏è MANTEN√â TU CONFIG DE FIREBASE YA FUNCIONANDO (NO CAMBIAR)
const firebaseConfig = {/* TU CONFIG EXISTENTE AQU√ç */};
// ‚¨ÜÔ∏è MANTEN√â TU CONFIG DE FIREBASE YA FUNCIONANDO (NO CAMBIAR)

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/*** ESTADO GLOBAL ***/
let settings = { tna: 150, dueDay: 10 };
let isAdmin = false;
let inactTab = 'finished'; // o 'charged_off'

/*** HEADER BTNS ***/
$('#btnMyLoanTop').onclick = ()=> document.getElementById('secMyLoan').scrollIntoView({behavior:'smooth'});
$('#btnLogout').onclick = ()=>{ isAdmin=false; $('#secAdmin').style.display='none'; alert('Sesi√≥n cerrada.'); };
$('#btnAdminTop').onclick = async ()=>{
  const email = prompt('Ingres√° tu email de administrador:');
  if(!email) return;
  try{
    const snap = await db.collection('admins').doc('admins').get();
    const allowed = (snap.exists && Array.isArray(snap.data().emails)) ? snap.data().emails : [];
    if(allowed.map(e=>e.toLowerCase().trim()).includes(email.toLowerCase().trim())){
      isAdmin = true;
      $('#secAdmin').style.display='block';
      await loadAllAdmin();
      alert('Sesi√≥n iniciada como administrador.');
    }else{
      alert('Ese email no est√° habilitado como administrador.');
    }
  }catch(e){ alert('No se pudo validar administrador.'); console.error(e); }
};

/*** SETTINGS (TNA) ***/
async function loadSettings(){
  try{
    const doc = await db.collection('settings').doc('global').get();
    if(doc.exists){
      const d = doc.data();
      settings.tna = Number(d.tna||settings.tna);
      settings.dueDay = Number(d.dueDay||settings.dueDay);
    }
  }catch(e){ console.warn('settings default'); }
  $('#lblTNA').textContent = settings.tna + '%';
  $('#lblDue').textContent = settings.dueDay;
  $('#admTna').value = settings.tna;
}
$('#btnSaveTna').onclick = async ()=>{
  if(!isAdmin) return;
  const n = Number(onlyDigits($('#admTna').value));
  if(!n){ alert('TNA inv√°lida'); return; }
  try{
    await db.collection('settings').doc('global').set({tna:n, updatedAt:nowTS()}, {merge:true});
    settings.tna = n; $('#lblTNA').textContent = n + '%';
    alert('TNA guardada.');
  }catch(e){ alert('No se pudo guardar.'); }
};

/*** SIMULADOR ***/
wireCurrency($('#simAmount'));
$('#btnSim').onclick = ()=>{
  const amount = Number(onlyDigits($('#simAmount').value));
  const months = Number(onlyDigits($('#simMonths').value));
  if(!amount || !months){ alert('Complet√° monto y meses.'); return; }
  const r = (settings.tna/100)/12;
  const q = Math.pow(1+r, months);
  const cuota = r ? amount * r * q / (q-1) : amount / months;
  // NO mostramos total, solo detalle de cuotas:
  let rows = '';
  const today = new Date();
  for(let i=1;i<=months;i++){
    const v = new Date(today.getFullYear(), today.getMonth()+i, settings.dueDay);
    rows += `<tr><td>${i}</td><td>${v.toLocaleDateString('es-AR')}</td><td class="right">${money(cuota)}</td><td class="muted">Pendiente</td></tr>`;
  }
  $('#simResult').innerHTML = `
    <div class="divider"></div>
    <table>
      <thead><tr><th>#</th><th>Vencimiento</th><th class="right">Cuota</th><th>Estado</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
};

/*** SOLICITUD ***/
$('#btnSendReq').onclick = async ()=>{
  const name = $('#rqName').value.trim();
  const dni  = onlyDigits($('#rqDni').value);
  const email= $('#rqEmail').value.trim();
  const phone= $('#rqPhone').value.trim();
  const cbu  = $('#rqCbu').value.trim();
  const amount = Number(onlyDigits($('#simAmount').value));
  const months = Number(onlyDigits($('#simMonths').value));
  if(!name||!dni||!email||!phone||!cbu||!amount||!months){ alert('Complet√° todos los datos y la simulaci√≥n.'); return; }
  try{
    await db.collection('loans').add({
      amount, months, tna: settings.tna, status:'pending',
      borrower:{name,dni,email,phone,cbu},
      createdAt: nowTS(), updatedAt: nowTS(), paidCount:0, paidMap:{}
    });
    alert('Solicitud enviada. En 48 hs un administrador la revisar√°.');
  }catch(e){ alert('No se pudo enviar.'); console.error(e); }
};

/*** CONTRATO (PDF + firma) ***/
function openContractWindow(L){
  const id = L.id;
  const borrower = L.borrower||{};
  const monto = money(L.amount);
  const cuotas = L.months;
  const tna = L.tna;
  const contractId = L.contractId || (Math.random().toString(36).slice(2,10)).toUpperCase();
  const html = `
  <html><head><meta charset="utf-8">
  <title>Contrato ${contractId}</title>
  <style>
    @page{ size:A4; margin:20mm }
    body{ font-family:Arial,Helvetica,sans-serif; color:#111827 }
    .wrap{ max-width:720px; margin:0 auto }
    h1{ font-size:22px; margin:0 0 8px }
    .muted{color:#6b7280}
    .box{border:1px solid #d1d5db; border-radius:10px; padding:12px; margin:10px 0}
    label{font-size:14px;color:#374151}
    input{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px}
    .btn{padding:12px 16px;border-radius:10px;background:#0b5cff;color:#fff;border:none;font-weight:800;cursor:pointer}
  </style></head>
  <body>
    <div class="wrap">
      <h1>Firma de contrato</h1>
      <div class="muted">Contrato N¬∞ <b>${contractId}</b> ‚Äî ${borrower.name||''} ‚Äî DNI ${borrower.dni||''}</div>
      <div class="box">
        <p>Entre <b>EstimaPres</b> y el/la Sr./Sra. <b>${borrower.name||''}</b>, DNI <b>${borrower.dni||''}</b>, se acuerda un pr√©stamo por <b>${monto}</b>, a devolver en <b>${cuotas}</b> cuotas iguales y consecutivas. TNA <b>${tna}%</b>. Vencimientos el d√≠a <b>${settings.dueDay}</b> de cada mes.</p>
        <p>El/la solicitante declara haber le√≠do y aceptado las condiciones. Al firmar digitalmente, autoriza el dep√≥sito en la cuenta informada y el d√©bito de cuotas seg√∫n cronograma.</p>
      </div>
      <div class="box">
        <label>Escrib√≠ tu nombre y apellido para firmar</label>
        <input id="signName" placeholder="${borrower.name||'Nombre y apellido'}"/>
      </div>
      <button id="btnAccept" class="btn">Aceptar contrato</button>
      <div class="muted" style="margin-top:8px">Luego pod√©s imprimir en tama√±o A4 desde el di√°logo del navegador.</div>
    </div>
    <script>
      const id='${id}', contractId='${contractId}';
      window.addEventListener('load', ()=>{
        document.getElementById('btnAccept').addEventListener('click', async ()=>{
          const v = (document.getElementById('signName').value||'').trim();
          if(!v){ alert('Escrib√≠ tu nombre y apellido'); return; }
          try{
            const app = firebase.initializeApp(${JSON.stringify(firebaseConfig)}, 'child-'+Date.now());
            const db = app.firestore();
            await db.collection('loans').doc(id).set(
              { signed:true, signedName:v, signedAt:firebase.firestore.FieldValue.serverTimestamp(), contractId, updatedAt:firebase.firestore.FieldValue.serverTimestamp() },
              { merge:true }
            );
            alert('¬°Contrato aceptado!');
          }catch(e){ alert('No se pudo registrar la firma'); console.error(e); }
        });
      });
    </script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  </body></html>`;
  const w = window.open('about:blank','_blank'); w.document.write(html); w.document.close();
}

/*** ADMIN LISTADOS ***/
async function loadPend(){
  const box = $('#listPend'); box.innerHTML='';
  try{
    const q = await db.collection('loans').where('status','==','pending').orderBy('createdAt','desc').limit(50).get();
    if(q.empty){ box.innerHTML='<div class="muted">Sin pendientes</div>'; return; }
    q.forEach(doc=>{
      const d = doc.data(); d.id=doc.id;
      const el = document.createElement('div');
      el.className='item';
      el.innerHTML = `
        <h4>${d.borrower?.name||''} ¬∑ DNI ${d.borrower?.dni||''}</h4>
        <div class="meta">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}%</div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button data-act="pre" class="btn-sm btn-outline">Preaprobar</button>
          <button data-act="del" class="btn-sm btn-danger">Eliminar</button>
        </div>`;
      el.querySelector('[data-act="pre"]').onclick = async ()=>{
        if(!confirm('¬øPreaprobar y generar contrato?')) return;
        await db.collection('loans').doc(d.id).set({ status:'preapproved', contractId:(Math.random().toString(36).slice(2,10)).toUpperCase(), updatedAt:nowTS() },{merge:true});
        await loadAllAdmin();
      };
      el.querySelector('[data-act="del"]').onclick = async ()=>{
        if(!confirm('¬øEliminar solicitud?')) return;
        await db.collection('loans').doc(d.id).set({ status:'deleted', updatedAt:nowTS() },{merge:true});
        await loadAllAdmin();
      };
      box.appendChild(el);
    });
  }catch(e){ box.innerHTML='<div class="muted">No se pudieron leer las solicitudes (reglas/√≠ndices).</div>'; }
}
async function loadPre(){
  const box = $('#listPre'); box.innerHTML='';
  try{
    const q = await db.collection('loans').where('status','==','preapproved').orderBy('createdAt','desc').limit(50).get();
    if(q.empty){ box.innerHTML='<div class="muted">Sin preaprobados</div>'; return; }
    q.forEach(doc=>{
      const d = doc.data(); d.id=doc.id;
      const el = document.createElement('div');
      el.className='item';
      const signed = d.signed ? '<span class="pill pill-green">Firmado</span>' : '<span class="pill pill-yellow">Esperando firma</span>';
      el.innerHTML = `
        <h4>${d.borrower?.name||''} ¬∑ DNI ${d.borrower?.dni||''} ${signed}</h4>
        <div class="meta">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}% ¬∑ Contrato ${d.contractId||'-'}</div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button data-act="pdf" class="btn-sm btn-outline">Contrato PDF</button>
          <button data-act="share" class="btn-sm btn-outline">Compartir WhatsApp</button>
          <button data-act="ok" class="btn-sm btn-primary" ${d.signed? '':'disabled'}>Aprobar & dep√≥sito</button>
        </div>`;
      el.querySelector('[data-act="pdf"]').onclick = ()=> openContractWindow({id:d.id, ...d});
      el.querySelector('[data-act="share"]').onclick = ()=>{
        const url = location.origin + location.pathname + '#contrato-'+d.id;
        const msg = `Hola ${d.borrower?.name||''}, revis√° y firm√° tu contrato de EstimaPres: ${url}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
      };
      el.querySelector('[data-act="ok"]').onclick = async ()=>{
        if(!d.signed){ alert('Todav√≠a no firm√≥.'); return; }
        if(!confirm('¬øAprobar y registrar dep√≥sito?')) return;
        await db.collection('loans').doc(d.id).set({ status:'active', activeAt:nowTS(), disbursed:true, updatedAt:nowTS() },{merge:true});
        await loadAllAdmin();
      };
      box.appendChild(el);
    });
  }catch(e){ box.innerHTML='<div class="muted">No se pudieron leer los preaprobados.</div>'; }
}
function scheduleRows(L){
  const r = (L.tna/100)/12;
  const q = Math.pow(1+r, L.months);
  const cuota = r ? L.amount * r * q / (q-1) : L.amount / L.months;
  let rows = '';
  const paidMap = L.paidMap||{};
  for(let i=1;i<=L.months;i++){
    const v = new Date(); v.setMonth(v.getMonth()+i); v.setDate(settings.dueDay);
    const paid = !!paidMap[i];
    rows += `<tr>
      <td>${i}</td>
      <td>${v.toLocaleDateString('es-AR')}</td>
      <td class="right">${money(cuota)}</td>
      <td>${paid?'<span class="pill pill-green">Pagada</span>':'<span class="pill pill-yellow">Pendiente</span>'}</td>
      <td class="right">${paid?'‚Äî':`<button data-cuota="${i}" class="btn-sm btn-outline">Marcar pagada</button>`}</td>
    </tr>`;
  }
  return {rows, cuota};
}
async function loadAct(){
  const box = $('#listAct'); box.innerHTML='';
  try{
    const q = await db.collection('loans').where('status','==','active').orderBy('activeAt','desc').limit(50).get();
    if(q.empty){ box.innerHTML='<div class="muted">Sin activos</div>'; return; }
    q.forEach(doc=>{
      const d = doc.data(); d.id=doc.id;
      const el = document.createElement('div'); el.className='item';
      const paid = Number(d.paidCount||0);
      el.innerHTML = `
        <h4><span class="pill pill-green">Activo</span> ${d.borrower?.name||''} ¬∑ DNI ${d.borrower?.dni||''}</h4>
        <div class="meta">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}% ¬∑ <b>Progreso ${paid}/${d.months}</b></div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button data-act="ver" class="btn-sm btn-outline">Ver cuotas</button>
          <button data-act="fin" class="btn-sm btn-primary" ${paid===d.months?'':'disabled'}>Pagado total</button>
          <button data-act="inc" class="btn-sm btn-danger">A incobrables</button>
        </div>
        <div class="card" style="margin-top:10px;display:none"></div>`;
      const boxDet = el.querySelector('.card');
      el.querySelector('[data-act="ver"]').onclick = ()=>{
        const {rows} = scheduleRows(d);
        boxDet.style.display='block';
        boxDet.innerHTML = `<table>
          <thead><tr><th>#</th><th>Vencimiento</th><th class="right">Cuota</th><th>Estado</th><th class="right">Acci√≥n</th></tr></thead>
          <tbody>${rows}</tbody></table>`;
        boxDet.querySelectorAll('button[data-cuota]').forEach(btn=>{
          btn.onclick = async ()=>{
            const n = Number(btn.getAttribute('data-cuota'));
            if(!confirm('¬øMarcar cuota '+n+' como pagada?')) return;
            const upd = {}; upd['paidMap.'+n] = true;
            const newCount = Math.min(d.months, (Number(d.paidCount||0)+1));
            upd.paidCount = newCount; upd.updatedAt = nowTS();
            await db.collection('loans').doc(d.id).set(upd,{merge:true});
            await loadAllAdmin();
          };
        });
      };
      el.querySelector('[data-act="fin"]').onclick = async ()=>{
        if(Number(d.paidCount||0)!==d.months){ alert('A√∫n quedan cuotas sin pagar.'); return; }
        if(!confirm('¬øFinalizar pr√©stamo (pagado total)?')) return;
        await db.collection('loans').doc(d.id).set({ status:'finished', updatedAt:nowTS() },{merge:true});
        await loadAllAdmin();
      };
      el.querySelector('[data-act="inc"]').onclick = async ()=>{
        if(!confirm('¬øPasar a incobrables?')) return;
        await db.collection('loans').doc(d.id).set({ status:'charged_off', updatedAt:nowTS() },{merge:true});
        await loadAllAdmin();
      };
      box.appendChild(el);
    });
  }catch(e){ box.innerHTML='<div class="muted">No se pudieron leer activos.</div>'; }
}
async function loadInact(){
  const box = $('#listInact'); box.innerHTML='';
  try{
    const status = inactTab==='charged_off'?'charged_off':'finished';
    const q = await db.collection('loans').where('status','==',status).orderBy('updatedAt','desc').limit(50).get();
    if(q.empty){ box.innerHTML='<div class="muted">Sin inactivos</div>'; return; }
    q.forEach(doc=>{
      const d = doc.data(); d.id=doc.id;
      const el = document.createElement('div'); el.className='item';
      const chip = status==='finished'
        ? '<span class="pill pill-green">Cancelado</span>'
        : '<span class="pill pill-red">Incobrable</span>';
      el.innerHTML = `
        <h4>${chip} ${d.borrower?.name||''} ¬∑ DNI ${d.borrower?.dni||''}</h4>
        <div class="meta">Principal ${money(d.amount)} ¬∑ ${d.months} cuotas ¬∑ TNA ${d.tna}% ¬∑ Contrato ${d.contractId||'-'}</div>`;
      box.appendChild(el);
    });
  }catch(e){ box.innerHTML='<div class="muted">No se pudieron leer inactivos.</div>'; }
}
async function loadAllAdmin(){
  await loadSettings();
  await Promise.all([loadPend(), loadPre(), loadAct(), loadInact()]);
}
$('#btnReloadPend').onclick = loadPend;
$('#btnReloadPre').onclick = loadPre;
$('#btnReloadAct').onclick = loadAct;
$('#btnReloadInact').onclick = loadInact;
$('#tabFinished').onclick = ()=>{ inactTab='finished'; loadInact(); };
$('#tabCharged').onclick = ()=>{ inactTab='charged_off'; loadInact(); };

/*** VER MI PR√âSTAMO (usuario) ***/
$('#btnFindMyLoan').onclick = async ()=>{
  const dni = onlyDigits($('#myDni').value);
  if(!dni){ $('#myLoanResult').innerHTML='<div class="muted">Ingres√° un DNI.</div>'; return; }
  $('#myLoanResult').innerHTML='<div class="muted">Buscando...</div>';
  try{
    const s = await db.collection('loans').orderBy('createdAt','desc').limit(80).get();
    const list = [];
    s.forEach(d=>{ const L=d.data(); if(L?.borrower?.dni===dni) list.push({id:d.id,...L}); });
    if(!list.length){ $('#myLoanResult').innerHTML='<div class="muted">No encontramos pr√©stamos activos o preaprobados para ese DNI.</div>'; return; }
    const L = list[0];
    const c = scheduleRows(L);
    const paid = Number(L.paidCount||0);
    const html = `
      <div class="item">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <div class="pill ${L.status==='active'?'pill-green':L.status==='preapproved'?'pill-yellow':'pill-red'}">${L.status}</div>
          <div class="meta">Monto: ${money(L.amount)} ¬∑ Cuotas: ${L.months} ¬∑ TNA: ${L.tna}% ¬∑ <b>Progreso ${paid}/${L.months}</b></div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnMyPdf" class="btn-sm btn-outline">Contrato PDF</button>
        </div>
        <div class="card" style="margin-top:10px">
          <table>
            <thead><tr><th>#</th><th>Vencimiento</th><th class="right">Cuota</th><th>Estado</th></tr></thead>
            <tbody>${c.rows.replace(/<td class="right">.*Acci√≥n.*<\/td>/g,'<td></td>')}</tbody>
          </table>
        </div>
      </div>`;
    $('#myLoanResult').innerHTML = html;
    $('#btnMyPdf').onclick = ()=> openContractWindow(L);
  }catch(e){
    $('#myLoanResult').innerHTML='<div class="muted">No se pudo consultar.</div>';
  }
};

/*** BOOT ***/
(async function init(){
  await loadSettings();
  // Formateo inicial del monto sugerido
  $('#simAmount').value = '$ ' + (1_000_000).toLocaleString('es-AR');
})();
</script>
</body>
</html>