<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=yes"/>
<title id="pageTitle">Prestify ¬∑ Tu financiera, digitalizada</title>
<link rel="icon" href="assets/ping.png"/>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --navy:#050d1f;--navy-card:#0c1e3d;--navy-input:#071428;--navy-row:#091630;
  --blue:#1a56db;--blue-light:#2f6ef5;--blue-glow:#3b7cf6;--sky:#60a5fa;--ice:#bfdbfe;
  --white:#ffffff;--text:#e8f0fe;--muted:#94b4d6;
  --border:rgba(96,165,250,.14);--border-hi:rgba(96,165,250,.38);
  --ok:#10b981;--ok-dim:rgba(16,185,129,.14);
  --warn:#f59e0b;--warn-dim:rgba(245,158,11,.14);
  --danger:#ef4444;--danger-dim:rgba(239,68,68,.14);
  --purple:#a78bfa;--purple-dim:rgba(167,139,250,.14);
  --teal:#06b6d4;--teal-dim:rgba(6,182,212,.14);
  --r:20px;--ri:12px;
  --sc:0 8px 32px rgba(5,13,31,.65),0 1px 0 rgba(96,165,250,.07) inset;
  --sb:0 4px 20px rgba(26,86,219,.45);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:'Sora',sans-serif;background:var(--navy);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse 80% 60% at 70% -10%,rgba(26,86,219,.17) 0%,transparent 65%),
             radial-gradient(ellipse 50% 40% at 0% 100%,rgba(26,86,219,.11) 0%,transparent 60%),
             repeating-linear-gradient(0deg,transparent,transparent 39px,rgba(96,165,250,.025) 40px),
             repeating-linear-gradient(90deg,transparent,transparent 39px,rgba(96,165,250,.025) 40px)}

/* ===== ANIMACIONES SCROLL ===== */
.fade-up { opacity: 0; transform: translateY(30px); transition: opacity 0.8s ease, transform 0.8s ease; }
.fade-left { opacity: 0; transform: translateX(-30px); transition: opacity 0.8s ease, transform 0.8s ease; }
.fade-right { opacity: 0; transform: translateX(30px); transition: opacity 0.8s ease, transform 0.8s ease; }
.fade-in { opacity: 0; transition: opacity 1s ease; }
.show { opacity: 1; transform: translate(0,0); }

/* ‚ïê‚ïê‚ïê SUSPENDED OVERLAY ‚ïê‚ïê‚ïê */
.suspended-overlay{display:none;position:fixed;inset:0;z-index:9999;background:rgba(5,13,31,.97);backdrop-filter:blur(16px);align-items:center;justify-content:center;flex-direction:column;gap:20px;text-align:center;padding:30px}
.suspended-overlay.show{display:flex}
.suspended-icon{width:80px;height:80px;border-radius:20px;background:var(--danger-dim);border:2px solid rgba(239,68,68,.4);display:flex;align-items:center;justify-content:center;animation:pulse-danger 2s ease infinite}
.suspended-icon svg{width:36px;height:36px;stroke:#f87171;fill:none;stroke-width:1.5}
@keyframes pulse-danger{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.4)}60%{box-shadow:0 0 0 16px rgba(239,68,68,0)}}
.suspended-title{font-size:24px;font-weight:800;color:#f87171;letter-spacing:-.5px}
.suspended-msg{font-size:15px;color:var(--muted);line-height:1.65;max-width:460px}
.suspended-msg strong{color:var(--ice)}

/* ‚ïê‚ïê‚ïê ONBOARDING ‚ïê‚ïê‚ïê */
.onboarding-overlay{display:none;position:fixed;inset:0;z-index:600;background:rgba(5,13,31,.97);backdrop-filter:blur(20px);align-items:center;justify-content:center;padding:20px;overflow-y:auto}
.onboarding-overlay.show{display:flex}
.onboarding-box{background:var(--navy-card);border:1px solid var(--border-hi);border-radius:24px;padding:36px;width:100%;max-width:540px;box-shadow:0 32px 80px rgba(5,13,31,.9);animation:fadeUp .4s ease both}
.ob-steps{display:flex;gap:0;margin-bottom:32px;position:relative}
.ob-steps::before{content:'';position:absolute;top:16px;left:16px;right:16px;height:2px;background:var(--border);z-index:0}
.ob-step{display:flex;flex-direction:column;align-items:center;flex:1;position:relative;z-index:1}
.ob-step-dot{width:32px;height:32px;border-radius:50%;border:2px solid var(--border);background:var(--navy);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:var(--muted);transition:all .3s;flex-shrink:0}
.ob-step.active .ob-step-dot{border-color:var(--sky);background:rgba(96,165,250,.15);color:var(--sky)}
.ob-step.done .ob-step-dot{border-color:var(--ok);background:rgba(16,185,129,.15);color:var(--ok)}
.ob-step-label{font-size:10px;font-weight:600;color:var(--muted);margin-top:6px;text-align:center;letter-spacing:.5px;text-transform:uppercase}
.ob-step.active .ob-step-label{color:var(--sky)}
.ob-step.done .ob-step-label{color:var(--ok)}
.ob-content{display:none}
.ob-content.active{display:block;animation:fadeUp .3s ease both}
.ob-title{font-size:20px;font-weight:800;color:var(--white);margin-bottom:6px;letter-spacing:-.4px}
.ob-subtitle{font-size:13px;color:var(--muted);margin-bottom:24px;line-height:1.6}
.ob-consent-box{background:rgba(5,13,31,.6);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:20px;max-height:140px;overflow-y:auto}
.ob-consent-box p{font-size:11px;color:var(--muted);line-height:1.7;margin-bottom:6px}
.ob-consent-box strong{color:var(--ice)}
.ob-consent-check{display:flex;align-items:flex-start;gap:10px;padding:12px 14px;background:rgba(26,86,219,.08);border:1px solid var(--border-hi);border-radius:10px;cursor:pointer;margin-bottom:20px}
.ob-consent-check input[type=checkbox]{width:16px;height:16px;margin-top:1px;flex-shrink:0;accent-color:var(--sky);cursor:pointer}
.ob-consent-check label{font-size:12px;color:var(--ice);line-height:1.5;cursor:pointer}
.ob-sig-wrap{border:2px dashed var(--border-hi);border-radius:14px;overflow:hidden;background:rgba(5,13,31,.6);touch-action:none;margin-bottom:16px}
#obSigCanvas{display:block;width:100%;height:150px;cursor:crosshair}
.ob-nav{display:flex;gap:10px;margin-top:20px}
.payment-method-selector{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.pm-option{padding:16px;border:2px solid var(--border);border-radius:14px;cursor:pointer;transition:all .2s;text-align:center}
.pm-option:hover{border-color:var(--border-hi)}
.pm-option.selected{border-color:var(--sky);background:rgba(96,165,250,.08)}
.pm-option .pm-icon{font-size:24px;margin-bottom:8px}
.pm-option .pm-name{font-size:13px;font-weight:700;color:var(--white)}
.pm-option .pm-desc{font-size:11px;color:var(--muted);margin-top:3px;line-height:1.4}

/* TOPBAR */
.topbar{position:sticky;top:0;z-index:200;background:rgba(5,13,31,.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--border)}
.topbar-inner{max-width:1200px;margin:0 auto;padding:0 28px;height:66px;display:flex;align-items:center;gap:24px}
.logo{display:flex;align-items:center;gap:10px;text-decoration:none;flex-shrink:0;cursor:pointer}
.logo-mark{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,var(--blue-light),var(--sky));display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:#fff;box-shadow:0 0 18px rgba(47,110,245,.5);overflow:hidden}
.logo-mark img{width:100%;height:100%;object-fit:cover;border-radius:10px}
.logo-name{font-size:18px;font-weight:700;color:var(--white);letter-spacing:-.4px}
.logo-name span{color:var(--sky)}
.topbar-nav{display:flex;align-items:center;gap:4px;margin-left:auto}
.nav-btn{display:inline-flex;align-items:center;gap:7px;padding:8px 13px;border-radius:10px;border:1px solid transparent;background:transparent;color:var(--muted);font-family:inherit;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s;white-space:nowrap}
.nav-btn svg{width:15px;height:15px;stroke:currentColor;fill:none;stroke-width:2;flex-shrink:0}
.nav-btn:hover{background:rgba(96,165,250,.08);border-color:var(--border);color:var(--white)}
.nav-btn.active{background:rgba(26,86,219,.15);border-color:var(--border-hi);color:var(--sky)}
.nav-btn.danger{color:#f87171}
.nav-btn.danger:hover{background:var(--danger-dim);border-color:rgba(239,68,68,.3)}
.nav-sep{width:1px;height:24px;background:var(--border);margin:0 4px}
.notif-wrap{position:relative}
.notif-bell{position:relative;display:inline-flex;align-items:center;justify-content:center;width:38px;height:38px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;transition:all .2s}
.notif-bell:hover{background:rgba(96,165,250,.08);border-color:var(--border-hi);color:var(--white)}
.notif-bell svg{width:17px;height:17px;stroke:currentColor;fill:none;stroke-width:2}
.notif-badge{position:absolute;top:-5px;right:-5px;min-width:18px;height:18px;padding:0 4px;background:var(--danger);border-radius:9px;border:2px solid var(--navy);font-size:10px;font-weight:800;color:#fff;display:flex;align-items:center;justify-content:center;animation:pulse-badge 1.5s ease infinite}
@keyframes pulse-badge{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.6)}60%{box-shadow:0 0 0 6px rgba(239,68,68,0)}}
.notif-dropdown{display:none;position:absolute;top:calc(100% + 10px);right:0;width:340px;background:var(--navy-card);border:1px solid var(--border-hi);border-radius:16px;box-shadow:0 16px 48px rgba(5,13,31,.8);z-index:500;overflow:hidden}
.notif-dropdown.open{display:block;animation:fadeUp .2s ease}
.notif-header{padding:14px 16px;border-bottom:1px solid var(--border);font-size:12px;font-weight:700;color:var(--sky);text-transform:uppercase;letter-spacing:1px;display:flex;justify-content:space-between}
.notif-list{max-height:300px;overflow-y:auto}
.notif-item{padding:12px 16px;border-bottom:1px solid rgba(96,165,250,.06);cursor:pointer}
.notif-item:hover{background:rgba(96,165,250,.05)}
.notif-item.unread{border-left:3px solid var(--sky)}
.notif-item-title{font-size:13px;font-weight:700;color:var(--white);margin-bottom:2px}
.notif-item-sub{font-size:11px;color:var(--muted)}
.notif-empty{padding:24px;text-align:center;color:var(--muted);font-size:13px}
.alert-banner{display:none;position:fixed;top:72px;left:50%;transform:translateX(-50%);z-index:400;padding:14px 20px 14px 18px;background:linear-gradient(135deg,rgba(26,86,219,.97),rgba(47,110,245,.97));border:1px solid rgba(96,165,250,.5);border-radius:14px;color:#fff;font-size:14px;font-weight:700;box-shadow:0 10px 40px rgba(26,86,219,.6);align-items:center;gap:12px;max-width:90vw}
.alert-banner.show{display:flex;animation:slideDown .35s ease}
@keyframes slideDown{from{opacity:0;transform:translateX(-50%) translateY(-16px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.alert-banner-close{background:rgba(255,255,255,.18);border:none;color:#fff;width:22px;height:22px;border-radius:6px;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center}
.hero-section{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:56px 28px 44px;display:grid;grid-template-columns:1fr auto;gap:40px;align-items:center}
.hero-eyebrow{display:inline-flex;align-items:center;gap:8px;padding:5px 12px;border-radius:999px;margin-bottom:18px;background:rgba(26,86,219,.18);border:1px solid var(--border-hi);font-size:11px;font-weight:600;color:var(--sky);letter-spacing:1.2px;text-transform:uppercase}
.hero-eyebrow::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--sky)}
.hero-title{font-size:clamp(30px,4vw,50px);font-weight:800;line-height:1.1;letter-spacing:-1.5px;color:var(--white);margin-bottom:14px}
.hero-title em{font-style:normal;background:linear-gradient(90deg,var(--sky),var(--blue-glow));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hero-sub{font-size:15px;color:var(--muted);line-height:1.65;max-width:460px}
.hero-badges{display:flex;gap:10px;margin-top:28px;flex-wrap:wrap}
.badge{display:flex;align-items:center;gap:7px;padding:8px 13px;background:var(--navy-card);border:1px solid var(--border);border-radius:11px;font-size:12px;font-weight:600;color:var(--ice)}
.badge svg{width:13px;height:13px;stroke:var(--sky);fill:none;stroke-width:2}
.hero-kpis{display:grid;gap:10px}
.kpi-box{background:var(--navy-card);border:1px solid var(--border);border-radius:16px;padding:18px 22px;text-align:right;min-width:170px}
.kpi-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:600}
.kpi-value{font-size:26px;font-weight:800;color:var(--white);letter-spacing:-1px;margin-top:4px;font-family:'DM Mono',monospace}
.kpi-value small{font-size:13px;color:var(--sky);margin-left:3px}
.main-wrap{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:0 28px 80px}
.client-grid{display:grid;grid-template-columns:1fr 1fr;gap:22px}
.full-width{grid-column:1/-1}
.admin-wrap{display:none}
.admin-wrap.visible{display:block}
.card{background:var(--navy-card);border:1px solid var(--border);border-radius:var(--r);padding:26px;box-shadow:var(--sc);position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(96,165,250,.35),transparent)}
.card-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--sky);margin-bottom:20px;display:flex;align-items:center;gap:8px}
.card-title svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2.5}
.sep{height:1px;background:var(--border);margin:18px 0}
.dashboard-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:24px}
.dash-card{background:var(--navy-card);border:1px solid var(--border);border-radius:16px;padding:20px}
.dash-card:hover{border-color:var(--border-hi)}
.dash-icon{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:14px}
.dash-icon svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2}
.dash-icon.blue{background:rgba(26,86,219,.2);color:var(--sky)}
.dash-icon.green{background:rgba(16,185,129,.2);color:var(--ok)}
.dash-icon.red{background:var(--danger-dim);color:#f87171}
.dash-label{font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.dash-value{font-family:'DM Mono',monospace;font-size:22px;font-weight:700;color:var(--white)}
.field{margin-bottom:16px}
.field label{display:block;font-size:11px;font-weight:700;color:var(--ice);text-transform:uppercase;letter-spacing:.9px;margin-bottom:7px}
.field input,.field select,.field textarea{width:100%;background:rgba(7,20,40,.85);border:1px solid rgba(96,165,250,.28);border-radius:var(--ri);padding:12px 15px;color:#f0f6ff;font-family:'Sora',sans-serif;font-size:14px;font-weight:500;outline:none}
.field input:focus,.field select:focus{border-color:var(--blue-glow);box-shadow:0 0 0 3px rgba(59,124,246,.18)}
.input-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.btn-primary{width:100%;padding:13px 20px;border:none;border-radius:var(--ri);background:linear-gradient(135deg,var(--blue-light),var(--blue));color:#fff;font-family:'Sora',sans-serif;font-size:14px;font-weight:700;cursor:pointer;box-shadow:var(--sb);display:flex;align-items:center;justify-content:center;gap:8px}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 28px rgba(26,86,219,.55)}
.btn-success{padding:10px 16px;background:var(--ok-dim);border:1px solid rgba(16,185,129,.3);border-radius:10px;color:var(--ok);font-weight:700;cursor:pointer}
.btn-danger{padding:10px 16px;background:var(--danger-dim);border:1px solid rgba(239,68,68,.25);border-radius:10px;color:#f87171;cursor:pointer}
.btn-outline{padding:10px 16px;background:transparent;border:1px solid var(--border);border-radius:10px;color:var(--ice);cursor:pointer}
.btn-sm{padding:6px 11px!important;font-size:11px!important}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.pill{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:999px;font-size:11px;font-weight:700}
.pill::before{content:'';width:5px;height:5px;border-radius:50%}
.pill.ok{background:var(--ok-dim);color:#34d399}.pill.ok::before{background:var(--ok)}
.pill.warn{background:var(--warn-dim);color:#fbbf24}.pill.warn::before{background:var(--warn)}
.pill.bad{background:var(--danger-dim);color:#f87171}.pill.bad::before{background:var(--danger)}
.schedule-wrap{border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-top:14px}
.schedule-header{display:grid;grid-template-columns:38px 1fr 110px 1fr;gap:8px;padding:9px 14px;background:rgba(5,13,31,.65);border-bottom:1px solid var(--border)}
.schedule-header span{font-size:10px;font-weight:700;text-transform:uppercase;color:var(--muted)}
.schedule-row{display:grid;grid-template-columns:38px 1fr 110px 1fr;gap:8px;align-items:center;padding:11px 14px;border-bottom:1px solid rgba(96,165,250,.05)}
.schedule-row .num{font-family:'DM Mono',monospace;font-size:12px;color:var(--muted)}
.schedule-row .date{font-size:13px;color:var(--ice)}
.schedule-row .amount{font-family:'DM Mono',monospace;font-size:13px;color:var(--white)}
.sim-result-box{margin-top:18px;padding:18px;background:rgba(5,13,31,.5);border:1px solid var(--border-hi);border-radius:16px}
.sim-cuota-value{font-family:'DM Mono',monospace;font-size:30px;color:var(--sky)}
.admin-tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:20px}
.tab-btn{padding:9px 16px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:13px;font-weight:600;cursor:pointer}
.tab-btn.active{background:rgba(26,86,219,.18);border-color:var(--border-hi);color:var(--sky)}
.tab-content{display:none}
.tab-content.visible{display:block}
.modal-overlay{display:none;position:fixed;inset:0;z-index:300;background:rgba(5,13,31,.92);backdrop-filter:blur(10px);align-items:center;justify-content:center;padding:20px}
.modal-overlay.open{display:flex}
.modal-box{background:var(--navy-card);border:1px solid var(--border-hi);border-radius:22px;padding:26px;width:100%;max-width:460px}
.sig-canvas-wrap{border:2px dashed var(--border-hi);border-radius:14px;overflow:hidden;background:rgba(5,13,31,.6);touch-action:none}
#sigCanvas{display:block;width:100%;height:170px;cursor:crosshair}
.pending-overlay{display:none;position:fixed;inset:0;z-index:8000;background:rgba(5,13,31,.98);backdrop-filter:blur(20px);align-items:center;justify-content:center;flex-direction:column;gap:22px;text-align:center;padding:30px}
.pending-overlay.show{display:flex}
.pending-logo-mark{width:72px;height:72px;border-radius:18px;background:linear-gradient(135deg,var(--blue-light),var(--sky));display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:800;color:#fff}
.pending-badge{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;background:var(--warn-dim);border:1px solid rgba(245,158,11,.3);border-radius:999px;font-size:12px;font-weight:700;color:var(--warn)}
.plazo-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:6px;margin-top:8px}
.plazo-check{display:none}
.plazo-label{display:flex;align-items:center;justify-content:center;height:34px;border:1px solid var(--border);border-radius:8px;font-size:12px;font-weight:700;color:var(--muted);cursor:pointer}
.plazo-check:checked+.plazo-label{background:rgba(26,86,219,.2);border-color:var(--sky);color:var(--sky)}
.breakdown-box{background:rgba(5,13,31,.5);border:1px solid var(--border-hi);border-radius:12px;padding:14px;margin-bottom:12px}
.breakdown-row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(96,165,250,.06);font-size:12px}
.breakdown-row:last-child{border-bottom:none;font-weight:700}
.superadmin-view{display:none;position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:32px 28px 80px}
.superadmin-view.show{display:block}
.sa-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;flex-wrap:wrap;gap:16px}
.sa-title{font-size:26px;font-weight:800;color:var(--white);display:flex;align-items:center;gap:12px}
.sa-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.35);border-radius:999px;font-size:11px;font-weight:700;color:#f87171}
.sa-metrics{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:28px}
.sa-metric-card{background:var(--navy-card);border:1px solid var(--border);border-radius:16px;padding:20px}
.sa-metric-label{font-size:10px;color:var(--muted);text-transform:uppercase;font-weight:700;margin-bottom:8px}
.sa-metric-val{font-family:'DM Mono',monospace;font-size:28px;font-weight:800;color:var(--white)}
.sa-lenders-table{background:var(--navy-card);border:1px solid var(--border);border-radius:20px;overflow:hidden}
.sa-table-header{padding:18px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.sa-table-title{font-size:13px;font-weight:700;color:var(--sky);text-transform:uppercase}
.sa-row{display:grid;grid-template-columns:1fr 200px 120px 140px;gap:16px;align-items:center;padding:16px 24px;border-bottom:1px solid rgba(96,165,250,.06)}
.sa-row-head{background:rgba(5,13,31,.5);font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase}
.sa-lender-name{font-size:14px;font-weight:700;color:var(--white)}
.sa-lender-email{font-size:11px;color:var(--muted)}
.sa-status-pill{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:700}
.sa-status-pill.activo{background:var(--ok-dim);color:var(--ok)}
.sa-status-pill.pendiente{background:var(--warn-dim);color:var(--warn)}
.sa-status-pill.pausado{background:var(--danger-dim);color:#f87171}
.sa-action-btn{padding:7px 14px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;border:1px solid;background:transparent}
.sa-btn-activate{background:var(--ok-dim);border-color:rgba(16,185,129,.3);color:var(--ok)}
.sa-btn-activate:hover{background:rgba(16,185,129,.22)}
.sa-btn-suspend{background:var(--danger-dim);border-color:rgba(239,68,68,.25);color:#f87171}
.sa-btn-suspend:hover{background:rgba(239,68,68,.22)}
.toast-container{position:fixed;bottom:24px;right:24px;z-index:999;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 18px;border-radius:12px;font-size:13px;font-weight:600;display:flex;align-items:center;gap:10px}
.toast.ok{background:#0c2e1f;border:1px solid rgba(16,185,129,.3);color:#34d399}
.toast.err{background:#2a0c0c;border:1px solid rgba(239,68,68,.3);color:#f87171}
.empty{padding:28px 20px;text-align:center;color:var(--muted);font-size:13px}
.spinner{width:20px;height:20px;border:2px solid rgba(96,165,250,.2);border-top-color:var(--sky);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}

/* ===== LANDING PAGE DE ALTO IMPACTO ===== */
.landing-view{display:none;position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:60px 28px 80px}
.landing-view.show{display:block}
.landing-hero{text-align:center;margin-bottom:64px}
.landing-eyebrow{display:inline-flex;align-items:center;gap:8px;padding:6px 16px;border-radius:999px;background:rgba(26,86,219,.18);border:1px solid var(--border-hi);font-size:11px;font-weight:700;color:var(--sky);margin-bottom:28px}
.landing-eyebrow::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--sky)}
.landing-title{font-size:clamp(36px,5vw,64px);font-weight:800;line-height:1.08;letter-spacing:-2px;color:var(--white);margin-bottom:20px}
.landing-title em{font-style:normal;background:linear-gradient(90deg,var(--sky),#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.landing-sub{font-size:17px;color:var(--muted);line-height:1.7;max-width:560px;margin:0 auto 36px}
.landing-cta{display:inline-flex;align-items:center;gap:12px;padding:18px 36px;background:linear-gradient(135deg,var(--blue-light),var(--sky));border:none;border-radius:16px;color:#fff;font-weight:800;cursor:pointer}
.landing-cta:hover{transform:translateY(-3px);box-shadow:0 14px 44px rgba(47,110,245,.65)}
.landing-cta svg{width:20px;height:20px;stroke:currentColor;fill:none}
.trust-metrics {
  display: grid;
  grid-template-columns: repeat(4,1fr);
  gap: 24px;
  margin: 60px 0;
}
.trust-card {
  background: linear-gradient(145deg, #132237, #0e1a2b);
  border: 1px solid #2d4055;
  border-radius: 24px;
  padding: 32px 20px;
  text-align: center;
  box-shadow: 0 12px 30px rgba(0,0,0,0.5);
}
.trust-number {
  font-size: 42px;
  font-weight: 800;
  background: linear-gradient(135deg, #fff, #a0c0ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  line-height: 1.2;
}
.trust-label {
  font-size: 14px;
  color: #8ba0c0;
  margin-top: 8px;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.features-grid {
  display: grid;
  grid-template-columns: repeat(3,1fr);
  gap: 24px;
  margin: 60px 0;
}
.feature-card {
  background: #132237;
  border: 1px solid #2d4055;
  border-radius: 24px;
  padding: 28px;
  transition: transform 0.2s;
}
.feature-card:hover {
  transform: translateY(-5px);
  border-color: #4f7df3;
}
.feature-card img {
  width: 100%;
  border-radius: 16px;
  margin-bottom: 16px;
}
.feature-card h3 {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 12px;
  color: white;
}
.feature-card p {
  color: #b0c4de;
  line-height: 1.6;
}
.testimonials-section {
  margin: 80px 0;
  text-align: center;
}
.section-title {
  font-size: 32px;
  font-weight: 800;
  margin-bottom: 40px;
  background: linear-gradient(135deg, #fff, #c0d0ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.testimonials-grid {
  display: grid;
  grid-template-columns: repeat(3,1fr);
  gap: 24px;
}
.testimonial-card {
  background: #132237;
  border: 1px solid #2d4055;
  border-radius: 24px;
  padding: 28px;
  text-align: left;
}
.testimonial-stars {
  color: #fbbf24;
  font-size: 18px;
  margin-bottom: 12px;
}
.testimonial-text {
  color: #e0e8f0;
  font-style: italic;
  line-height: 1.6;
  margin-bottom: 16px;
}
.testimonial-author {
  color: #8ba0c0;
  font-weight: 600;
}
.landing-cta.large {
  padding: 20px 48px;
  font-size: 18px;
}
@media (max-width: 768px) {
  .trust-metrics, .features-grid, .testimonials-grid {
    grid-template-columns: 1fr;
  }
}

/* ===== SUPERADMIN PROFESIONAL ===== */
.superadmin-view {
  background: var(--navy);
  min-height: 100vh;
}
.sa-header {
  background: linear-gradient(145deg, #0b1a33, #0a1424);
  border-bottom: 1px solid #2a3a5a;
  padding: 20px 28px;
  border-radius: 0 0 20px 20px;
  margin-bottom: 30px;
}
.sa-title {
  font-size: 28px;
  background: linear-gradient(135deg, #fff, #a0c0ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.sa-badge {
  background: rgba(239,68,68,0.2);
  color: #ff8a8a;
  border: 1px solid #ff4d4d;
}
.sa-metrics {
  grid-template-columns: repeat(5,1fr);
  gap: 20px;
  margin: 0 28px 30px;
}
.sa-metric-card {
  background: #132237;
  border: 1px solid #2d4055;
  border-radius: 20px;
  padding: 24px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  transition: transform 0.2s;
}
.sa-metric-card:hover {
  transform: translateY(-4px);
  border-color: #4f7df3;
}
.sa-metric-label {
  color: #8ba0c0;
  font-size: 12px;
  letter-spacing: 1px;
}
.sa-metric-val {
  font-size: 32px;
  color: #fff;
}
.sa-lenders-table {
  margin: 0 28px;
  background: #0f1a2b;
  border: 1px solid #25344a;
  border-radius: 24px;
  overflow: hidden;
}
.sa-table-header {
  background: #1c2a3f;
  padding: 18px 24px;
}
.sa-table-title {
  color: #7aa5ff;
  font-size: 14px;
}
.sa-row {
  padding: 18px 24px;
  border-bottom: 1px solid #1e2c40;
  display: grid;
  grid-template-columns: 1fr 200px 120px 140px;
  align-items: center;
  gap: 16px;
}
.sa-row:hover {
  background: #162233;
}
.sa-lender-name {
  font-size: 16px;
  font-weight: 600;
  color: white;
}
.sa-lender-email {
  font-size: 12px;
  color: #8ba0c0;
}
.sa-status-pill {
  padding: 6px 14px;
  border-radius: 40px;
  font-size: 12px;
  font-weight: 600;
  display: inline-block;
}
.sa-status-pill.activo {
  background: rgba(16,185,129,0.15);
  color: #6fe7b5;
}
.sa-status-pill.pendiente {
  background: rgba(245,158,11,0.15);
  color: #fcd34d;
}
.sa-status-pill.pausado {
  background: rgba(239,68,68,0.15);
  color: #fca5a5;
}
.sa-action-btn {
  padding: 8px 16px;
  border-radius: 30px;
  font-weight: 600;
  font-size: 12px;
  transition: all 0.2s;
  border: none;
  cursor: pointer;
}
.sa-btn-activate {
  background: #10b981;
  color: white;
}
.sa-btn-activate:hover {
  background: #059669;
}
.sa-btn-suspend {
  background: #ef4444;
  color: white;
}
.sa-btn-suspend:hover {
  background: #dc2626;
}
@media (max-width: 768px) {
  .sa-row {
    grid-template-columns: 1fr;
    gap: 10px;
  }
  .sa-row-head {
    display: none;
  }
}

/* ===== CLIENTE ESTILO MONI ===== */
body.client-mode {
  background: #F5F7FA;
}
body.client-mode::before { display:none; }
body.client-mode .topbar {
  background: rgba(255,255,255,0.95);
  border-bottom: 1px solid rgba(0,0,0,0.08);
  box-shadow: 0 2px 12px rgba(0,0,0,0.06);
}
body.client-mode .logo-name { color: #111; }
body.client-mode .nav-btn { color: #666; }
body.client-mode .nav-btn:hover { background: rgba(0,0,0,0.05); color: #111; border-color: rgba(0,0,0,0.1); }
body.client-mode .nav-btn.active { background: rgba(0,0,0,0.07); color: #111; border-color: rgba(0,0,0,0.15); }
body.client-mode .hero-section { display: none; }
body.client-mode .card {
  background: #fff;
  border: 1px solid rgba(0,0,0,0.07);
  box-shadow: 0 4px 24px rgba(0,0,0,0.06), 0 1px 4px rgba(0,0,0,0.04);
  border-radius: 20px;
}
body.client-mode .card::before { display:none; }
body.client-mode .card-title { color: #555; letter-spacing: 1px; }
body.client-mode .lender-brand-header {
  text-align: center;
  padding: 28px 20px 8px;
}
body.client-mode .lender-brand-name {
  font-size: clamp(26px, 5vw, 38px);
  font-weight: 800;
  color: #111;
  letter-spacing: -1px;
  margin-bottom: 6px;
}
body.client-mode .field label {
  color: #444;
  text-transform: none;
  font-size: 13px;
  font-weight: 600;
}
body.client-mode .field input,
body.client-mode .field select {
  background: #F5F7FA;
  border: 1.5px solid #E2E8F0;
  color: #111;
  border-radius: 14px;
}
body.client-mode .client-amount-slider {
  -webkit-appearance: none;
  width: 100%;
  height: 6px;
  background: #E2E8F0;
  border-radius: 999px;
  margin: 12px 0;
}
body.client-mode .client-amount-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--brand-color, #1a56db);
  box-shadow: 0 2px 8px rgba(26,86,219,0.4);
  cursor: pointer;
  border: 3px solid #fff;
}
body.client-mode .client-amount-display {
  font-size: 42px;
  font-weight: 800;
  color: var(--brand-color, #1a56db);
  text-align: center;
}
body.client-mode .client-pill {
  flex: 1;
  padding: 12px 8px;
  border: 2px solid #E2E8F0;
  border-radius: 40px;
  background: white;
  color: #64748b;
  font-weight: 600;
  cursor: pointer;
  text-align: center;
}
body.client-mode .client-pill.active {
  background: var(--brand-color, #1a56db);
  color: white;
  border-color: var(--brand-color, #1a56db);
}
body.client-mode .btn-primary {
  background: var(--brand-color, #1a56db) !important;
  border-radius: 40px;
  padding: 16px;
  font-size: 16px;
}

/* Responsive general */
@media (max-width: 768px) {
  .topbar-inner { padding: 0 12px; flex-wrap: wrap; }
  .topbar-nav { order: 3; width: 100%; justify-content: space-around; }
  .nav-btn .nav-label { font-size: 10px; }
  .hero-section { padding: 30px 16px; }
  .hero-title { font-size: 28px; }
  .hero-kpis { grid-template-columns: 1fr; }
  .dashboard-grid { grid-template-columns: 1fr 1fr; }
  .client-grid { grid-template-columns: 1fr; }
  .schedule-header { display: none; }
  .schedule-row {
    grid-template-columns: 1fr 1fr;
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 8px;
    padding: 10px;
  }
  .schedule-row .num { grid-column: 1; grid-row: 1; }
  .schedule-row .date { grid-column: 2; grid-row: 1; text-align: right; }
  .schedule-row .amount { grid-column: 1; grid-row: 2; font-size: 16px; }
  .schedule-row .action-col { grid-column: 2; grid-row: 2; justify-content: flex-end; }
}
</style>
</head>
<body>

<!-- LANDING PAGE DE ALTO IMPACTO -->
<div class="landing-view" id="landingView">
  <div class="landing-hero fade-up">
    <div class="landing-eyebrow">‚ú® Plataforma #1 para prestamistas</div>
    <h1 class="landing-title">Digitaliz√° tu negocio<br><em>de pr√©stamos en minutos</em></h1>
    <p class="landing-sub">La soluci√≥n todo-en-uno para administrar pr√©stamos, clientes y cobranzas. Sin c√≥digo, sin papeles, sin complicaciones.</p>
    <button class="landing-cta" id="btnLandingRegister">
      <svg viewBox="0 0 24 24" width="20" height="20" stroke="white" fill="none"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
      Crear mi financiera gratis
    </button>
    <p class="landing-demo">¬øYa ten√©s cuenta? <a href="#" id="btnLandingLogin">Iniciar sesi√≥n</a></p>
  </div>

  <!-- Im√°genes del repo -->
  <div class="features-grid">
    <div class="feature-card fade-left">
      <img src="assets/1772058249023.png" alt="Dashboard" loading="lazy">
      <h3>Dashboard potente</h3>
      <p>Visualiz√° toda tu operaci√≥n en tiempo real.</p>
    </div>
    <div class="feature-card fade-up">
      <img src="assets/1772058267760.png" alt="Mobile" loading="lazy">
      <h3>Desde el celular</h3>
      <p>Tus clientes solicitan pr√©stamos desde su tel√©fono.</p>
    </div>
    <div class="feature-card fade-right">
      <img src="assets/1772058471896.png" alt="Confianza" loading="lazy">
      <h3>Confianza y respaldo</h3>
      <p>M√°s de 200 prestamistas ya conf√≠an en nosotros.</p>
    </div>
  </div>

  <!-- M√©tricas de confianza -->
  <div class="trust-metrics">
    <div class="trust-card fade-up"><div class="trust-number">+200</div><div class="trust-label">prestamistas activos</div></div>
    <div class="trust-card fade-up"><div class="trust-number">4.9</div><div class="trust-label">satisfacci√≥n ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div></div>
    <div class="trust-card fade-up"><div class="trust-number">$2.5B</div><div class="trust-label">prestados en 2024</div></div>
    <div class="trust-card fade-up"><div class="trust-number">0%</div><div class="trust-label">costo de instalaci√≥n</div></div>
  </div>

  <!-- Testimonios -->
  <div class="testimonials-section">
    <h2 class="section-title fade-in">Clientes satisfechos</h2>
    <div class="testimonials-grid">
      <div class="testimonial-card fade-left">
        <div class="testimonial-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
        <p class="testimonial-text">"En un mes ya ten√≠a mi primera financiera funcionando. Mis clientes pueden solicitar pr√©stamos desde su celular y yo gestiono todo desde el panel."</p>
        <div class="testimonial-author">‚Äî Carlos G., C√≥rdoba</div>
      </div>
      <div class="testimonial-card fade-up">
        <div class="testimonial-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
        <p class="testimonial-text">"La firma digital me ahorr√≥ horas de papeleo. Los contratos son v√°lidos y los clientes los firman en segundos."</p>
        <div class="testimonial-author">‚Äî Marta L., Buenos Aires</div>
      </div>
      <div class="testimonial-card fade-right">
        <div class="testimonial-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
        <p class="testimonial-text">"El soporte es incre√≠ble. Me ayudaron a configurar todo y ahora tengo un negocio profesional que crece solo."</p>
        <div class="testimonial-author">‚Äî Javier R., Mendoza</div>
      </div>
    </div>
  </div>

  <!-- CTA Final -->
  <div class="landing-cta-section fade-up">
    <h2>Empez√° hoy, es gratis</h2>
    <p>Cre√° tu cuenta en menos de 3 minutos y comenz√° a ofrecer pr√©stamos digitales.</p>
    <button class="landing-cta large" id="btnLandingRegister2">
      <svg viewBox="0 0 24 24" width="20" height="20" stroke="white" fill="none"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
      Crear mi cuenta gratis
    </button>
  </div>
</div>

<!-- SUPERADMIN PANEL MEJORADO -->
<div class="superadmin-view" id="superadminView">
  <div class="sa-header">
    <div class="sa-title">üõ°Ô∏è Panel SuperAdmin <span class="sa-badge">Due√±o</span></div>
    <button class="btn-outline btn-sm" id="btnSaLogout">Cerrar sesi√≥n</button>
  </div>
  <div class="sa-metrics" id="saMetrics">
    <div class="sa-metric-card"><div class="sa-metric-label">Prestamistas</div><div class="sa-metric-val" id="saCountLenders">‚Äî</div></div>
    <div class="sa-metric-card"><div class="sa-metric-label">Activos</div><div class="sa-metric-val" id="saCountActive">‚Äî</div></div>
    <div class="sa-metric-card"><div class="sa-metric-label">Pendientes</div><div class="sa-metric-val" id="saCountPending">‚Äî</div></div>
    <div class="sa-metric-card"><div class="sa-metric-label">Pr√©stamos totales</div><div class="sa-metric-val" id="saCountLoans">‚Äî</div></div>
    <div class="sa-metric-card"><div class="sa-metric-label">Volumen operado</div><div class="sa-metric-val" id="saVolume">‚Äî</div></div>
  </div>
  <div class="sa-lenders-table">
    <div class="sa-table-header">
      <span class="sa-table-title">üìã Solicitudes y prestamistas</span>
      <button class="btn-outline btn-sm" onclick="window.loadSuperAdmin()">‚Üª Actualizar</button>
    </div>
    <div id="saLendersList"><div class="sa-loading"><div class="spinner"></div></div></div>
  </div>
</div>

<!-- PENDING OVERLAY -->
<div class="pending-overlay" id="pendingOverlay">
  <div class="pending-logo-wrap">
    <div class="pending-logo-mark" id="pendingLogoMark">P</div>
    <div class="pending-logo-name">Presti<span>fy</span></div>
  </div>
  <div class="pending-badge">‚è≥ Validaci√≥n pendiente</div>
  <div class="pending-title">Tu financiera est√° siendo validada</div>
  <div class="pending-msg">Estamos revisando tu registro para activar tu cuenta.<br><strong>Te contactaremos a la brevedad</strong> para confirmar la activaci√≥n de tu financiera digital.</div>
  <a href="https://wa.me/542966678029?text=Hola%2C+quiero+activar+mi+cuenta+en+Prestify" target="_blank" style="padding:14px 28px;background:rgba(37,211,102,.15);border:1px solid rgba(37,211,102,.35);border-radius:12px;color:#25d366;font-weight:700;font-size:14px;text-decoration:none;display:flex;align-items:center;gap:10px;margin-top:4px">
    <svg viewBox="0 0 24 24" style="width:18px;height:18px;fill:currentColor"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
    Contactar para activar mi cuenta
  </a>
  <button id="btnPendingLogout" style="padding:9px 20px;background:transparent;border:1px solid var(--border);border-radius:10px;color:var(--muted);font-family:inherit;font-size:13px;cursor:pointer;margin-top:4px">Cerrar sesi√≥n</button>
</div>

<!-- SUSPENDED OVERLAY -->
<div class="suspended-overlay" id="suspendedOverlay">
  <div class="suspended-icon">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
  </div>
  <div class="suspended-title">Cuenta suspendida</div>
  <div class="suspended-msg">Tu cuenta ha sido <strong>pausada por falta de pago</strong> o incumplimiento de los t√©rminos del servicio.<br><br>Para reactivarla, contact√° al soporte de la plataforma.</div>
  <a href="mailto:soporte@dineroya.com" style="padding:13px 28px;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.35);border-radius:12px;color:#f87171;font-weight:700;font-size:14px;text-decoration:none;margin-top:8px">Contactar soporte</a>
</div>

<!-- MODAL REGISTRO NUEVO PRESTAMISTA -->
<div class="register-modal-overlay" id="registerModalOverlay">
  <div class="register-modal-box">
    <button class="register-modal-close" id="btnCloseRegisterModal">‚úï</button>
    <div class="register-modal-logo">
      <div class="logo-mark">P</div>
      <div class="logo-name">Prestify</div>
    </div>
    <div class="register-modal-title">Cre√° tu financiera digital</div>
    <div class="register-modal-sub">Ingres√° tu email y eleg√≠ una contrase√±a segura. En 3 pasos simples ten√©s tu financiera lista.</div>
    <div class="register-modal-error" id="registerModalError"></div>
    <div class="field">
      <label>Email</label>
      <input type="email" id="regEmail" placeholder="tucorreo@ejemplo.com" autocomplete="email"/>
    </div>
    <div class="field">
      <label>Contrase√±a</label>
      <input type="password" id="regPassword" placeholder="M√≠nimo 6 caracteres" autocomplete="new-password"/>
    </div>
    <div class="field">
      <label>Confirm√° la contrase√±a</label>
      <input type="password" id="regPasswordConfirm" placeholder="Repet√≠ tu contrase√±a" autocomplete="new-password"/>
    </div>
    <button class="register-modal-btn" id="btnDoRegister">Crear cuenta y continuar ‚Üí</button>
    <div class="register-modal-switch">¬øYa ten√©s cuenta? <a id="btnSwitchToLogin">Inici√° sesi√≥n</a></div>
  </div>
</div>

<!-- ONBOARDING OVERLAY (3 pasos) -->
<div class="onboarding-overlay" id="onboardingOverlay">
  <div class="onboarding-box">
    <div class="ob-steps">
      <div class="ob-step active" id="obStep1">
        <div class="ob-step-dot">1</div>
        <div class="ob-step-label">Datos personales</div>
      </div>
      <div class="ob-step" id="obStep2">
        <div class="ob-step-dot">2</div>
        <div class="ob-step-label">Tu financiera</div>
      </div>
      <div class="ob-step" id="obStep3">
        <div class="ob-step-dot">3</div>
        <div class="ob-step-label">Montos y TNA</div>
      </div>
    </div>

    <!-- PASO 1: Datos personales -->
    <div class="ob-content active" id="obContent1">
      <div class="ob-title">Tus datos personales</div>
      <div class="ob-subtitle">Necesitamos verificar tu identidad para crear tu cuenta de prestamista.</div>
      <div class="input-row" style="margin-bottom:16px">
        <div class="field" style="margin-bottom:0"><label>Nombre completo</label><input id="obName" placeholder="Juan P√©rez"/></div>
        <div class="field" style="margin-bottom:0"><label>DNI</label><input id="obDni" inputmode="numeric" placeholder="30123456"/></div>
      </div>
      <div class="field" style="margin-bottom:16px"><label>Email</label><input id="obEmail" type="email" placeholder="correo@mail.com"/></div>

      <div class="ob-consent-box">
        <p><strong>T√©rminos de Uso de la Plataforma DineroYa</strong></p>
        <p>Al registrarte y utilizar esta plataforma, acept√°s los siguientes t√©rminos:</p>
        <p>1. El uso de la plataforma est√° sujeto al pago de las suscripciones o tarifas vigentes seg√∫n el plan contratado.</p>
        <p>2. <strong>El administrador de la plataforma se reserva el derecho de pausar o eliminar la cuenta en caso de incumplimiento de pagos, uso indebido del servicio, o incumplimiento de cualquier t√©rmino y condici√≥n aqu√≠ establecido.</strong></p>
        <p>3. El prestador es el √∫nico responsable del cumplimiento de las normativas locales vigentes relacionadas con la actividad de pr√©stamo de dinero.</p>
        <p>4. Los datos almacenados se tratar√°n conforme a la Ley 25.326 de Protecci√≥n de Datos Personales.</p>
        <p>5. El uso de la firma electr√≥nica tiene plena validez seg√∫n la Ley 25.506.</p>
        <p>6. La plataforma act√∫a √∫nicamente como herramienta de gesti√≥n y no es parte de los contratos de pr√©stamo entre el prestador y sus clientes.</p>
      </div>

      <label class="ob-consent-check">
        <input type="checkbox" id="obConsentCheck"/>
        <span>Le√≠ y acepto los T√©rminos de Uso, incluyendo que la plataforma puede pausar o eliminar mi cuenta por incumplimiento de pagos o t√©rminos del servicio.</span>
      </label>

      <div style="margin-bottom:10px">
        <div style="font-size:11px;font-weight:700;color:var(--ice);text-transform:uppercase;letter-spacing:.9px;margin-bottom:8px">Firma digital (Ley 25.506)</div>
        <div class="ob-sig-wrap"><canvas id="obSigCanvas"></canvas></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnObClearSig" class="btn-outline btn-sm">Borrar firma</button>
          <span style="font-size:11px;color:var(--muted);align-self:center">Firm√° con el dedo o el mouse</span>
        </div>
      </div>

      <div class="ob-nav">
        <button id="btnObStep1" class="btn-primary" style="flex:1">Continuar al paso 2 ‚Üí</button>
      </div>
    </div>

    <!-- PASO 2: Nombre de tu financiera -->
    <div class="ob-content" id="obContent2">
      <div class="ob-title">Nombre de tu financiera</div>
      <div class="ob-subtitle">Estos datos aparecer√°n en el portal de clientes y en los contratos.</div>
      <div class="field"><label>Nombre de la financiera</label><input id="obAppName" placeholder="FinancieraYa / Pr√©stamos P√©rez"/></div>
      <div class="field"><label>Ciudad de operaci√≥n</label><input id="obCity" placeholder="R√≠o Gallegos, Santa Cruz"/></div>
      <div class="field"><label>WhatsApp de contacto (ej: 5492966123456)</label><input id="obWa" inputmode="tel" placeholder="5492966123456"/></div>
      <div class="ob-nav">
        <button id="btnObBack1" class="btn-outline" style="flex:0 0 auto">‚Üê Atr√°s</button>
        <button id="btnObStep2" class="btn-primary" style="flex:1">Continuar al paso 3 ‚Üí</button>
      </div>
    </div>

    <!-- PASO 3: Montos y TNA -->
    <div class="ob-content" id="obContent3">
      <div class="ob-title">Configuraci√≥n de montos y TNA</div>
      <div class="ob-subtitle">Configur√° los par√°metros financieros de tu financiera. Pod√©s cambiarlos despu√©s desde Configuraci√≥n.</div>
      <div class="input-row">
        <div class="field"><label>TNA % (tasa nominal anual)</label><input id="obTna" inputmode="numeric" class="mono" placeholder="90"/></div>
        <div class="field"><label>D√≠a de vencimiento (1-28)</label><input id="obDueDay" inputmode="numeric" placeholder="10"/></div>
      </div>
      <div class="input-row">
        <div class="field"><label>Monto m√≠nimo ($)</label><input id="obMinAmount" inputmode="numeric" class="mono" placeholder="10000"/></div>
        <div class="field"><label>Monto m√°ximo ($)</label><input id="obMaxAmount" inputmode="numeric" class="mono" placeholder="5000000"/></div>
      </div>
      <div class="field"><label>% Gasto de otorgamiento (por defecto 3%)</label><input id="obExpenses" inputmode="numeric" class="mono" placeholder="3"/><p class="field-hint">Se descuenta del capital al momento de entregar el pr√©stamo (Sistema Franc√©s).</p></div>
      <div class="payment-method-selector">
        <div class="pm-option selected" id="pmOptMP" onclick="selectPayMethod('mp')">
          <div class="pm-icon">üí≥</div>
          <div class="pm-name">Mercado Pago</div>
          <div class="pm-desc">Cobro autom√°tico online. Requiere Access Token.</div>
        </div>
        <div class="pm-option" id="pmOptManual" onclick="selectPayMethod('manual')">
          <div class="pm-icon">üè¶</div>
          <div class="pm-name">Transferencia manual</div>
          <div class="pm-desc">El cliente transfiere y sube comprobante. Vos lo verific√°s.</div>
        </div>
      </div>
      <div id="obMpFields">
        <div class="field"><label>Access Token de producci√≥n</label><input id="obMpToken" type="password" placeholder="APP_USR-xxxxxxxxxxxx"/><p class="field-hint">Obtenelo en Mercado Pago ‚Üí Tu negocio ‚Üí Credenciales.</p></div>
        <div class="field"><label>Public Key</label><input id="obMpPublicKey" placeholder="APP_USR-xxxxxxxxxxxx"/></div>
      </div>
      <div id="obManualMsg" style="display:none;padding:14px;background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.2);border-radius:12px;margin-bottom:16px">
        <p style="font-size:13px;color:#fbbf24;font-weight:700;margin-bottom:4px">üìã Modo transferencia manual activo</p>
        <p style="font-size:12px;color:var(--muted);line-height:1.55">Tus clientes ver√°n instrucciones para transferir y subir comprobante. Vos los aprob√°s desde el panel de Comprobantes.</p>
      </div>
      <div class="ob-nav">
        <button id="btnObBack2" class="btn-outline" style="flex:0 0 auto">‚Üê Atr√°s</button>
        <button id="btnObFinish" class="btn-primary" style="flex:1;background:linear-gradient(135deg,#059669,var(--ok))">‚úì Crear mi cuenta</button>
      </div>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<!-- BANNER NUEVA SOLICITUD EN TIEMPO REAL -->
<div class="alert-banner" id="alertBanner">
  <span style="font-size:20px;flex-shrink:0">üîî</span>
  <span id="alertBannerText">Nueva solicitud recibida</span>
  <button class="alert-banner-close" id="alertBannerClose" title="Cerrar">‚úï</button>
</div>

<!-- TOPBAR -->
<header class="topbar">
  <div class="topbar-inner">
    <a href="#" class="logo" id="logoLink">
      <div class="logo-mark" id="logoMark">P</div>
      <span class="logo-name" id="logoName">Presti<span>fy</span></span>
    </a>
    <nav class="topbar-nav">
      <button id="btnViewClient" class="nav-btn active">
        <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <span class="nav-label">Cliente</span>
      </button>
      <button id="btnViewAdmin" class="nav-btn">
        <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        <span class="nav-label">Admin</span>
      </button>
      <button id="btnViewSuperAdmin" class="nav-btn" style="display:none">
        <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><circle cx="12" cy="12" r="3" fill="currentColor" stroke="none"/></svg>
        <span class="nav-label">SuperAdmin</span>
      </button>
      <div class="nav-sep"></div>
      <div class="notif-wrap" id="notifWrap" style="display:none">
        <button class="notif-bell" id="notifBell" title="Notificaciones">
          <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
          <span class="notif-badge" id="notifBadge" style="display:none">0</span>
        </button>
        <div class="notif-dropdown" id="notifDropdown">
          <div class="notif-header">
            <span>Alertas en tiempo real</span>
            <button id="btnClearNotifs" class="btn-outline btn-sm">Limpiar</button>
          </div>
          <div class="notif-list" id="notifList"><div class="notif-empty">Sin notificaciones</div></div>
        </div>
      </div>
      <button id="btnResetPass" class="nav-btn">
        <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        <span class="nav-label">Llave</span>
      </button>
      <button id="btnLogout" class="nav-btn danger" style="display:none">
        <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        <span class="nav-label">Salir</span>
      </button>
    </nav>
  </div>
</header>

<!-- HERO -->
<section class="hero-section" id="heroSection">
  <div>
    <div class="hero-eyebrow" id="heroEyebrow">Prestify ¬∑ Tu financiera, digitalizada</div>
    <h1 class="hero-title">Pr√©stamos personales<br><em>r√°pidos y seguros</em></h1>
    <p class="hero-sub">Simul√°, solicit√° y gestion√° tu pr√©stamo en minutos. Sin papeles ni filas.</p>
    <div class="hero-badges">
      <div class="badge"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>SSL Seguro</div>
      <div class="badge"><svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Datos protegidos</div>
      <div class="badge"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Sin burocracia</div>
    </div>
  </div>
  <div class="hero-kpis">
    <div class="kpi-box"><div class="kpi-label">TNA vigente</div><div class="kpi-value" id="heroTna">&#8212;<small>%</small></div></div>
    <div class="kpi-box"><div class="kpi-label">D√≠a de pago</div><div class="kpi-value" id="heroDue">&#8212;<small>del mes</small></div></div>
  </div>
</section>

<!-- MAIN -->
<main class="main-wrap">

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ VISTA CLIENTE ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div id="clientView">
    <div class="lender-brand-header" id="lenderBrandHeader" style="display:none">
      <div class="lender-brand-name" id="lenderBrandName">Mi Financiera</div>
      <div class="lender-brand-tagline">Pr√©stamos r√°pidos y seguros</div>
    </div>

    <div class="client-grid">
      <!-- Simulador -->
      <div class="card">
        <div class="card-title"><svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>Simulador de cuotas</div>
        <div class="sim-meta">
          <div class="sim-meta-item">TNA <strong id="lblTna">--%</strong></div>
          <div class="sim-meta-item">Vence d√≠a <strong id="lblDue">--</strong></div>
          <div class="sim-meta-item">Gasto otorg. <strong id="lblGastoOtorg">3%</strong></div>
          <div class="sim-meta-item" id="lblExpMeta" style="display:none">Gastos admin <strong id="lblExp">--%</strong></div>
        </div>
        <!-- Client mode: amount slider -->
        <div id="clientAmountWrap" style="display:none">
          <div class="client-amount-label">¬øCu√°nto necesit√°s?</div>
          <div class="client-amount-display" id="clientAmountDisplay">$ 50.000</div>
          <input type="range" id="clientAmountSlider" class="client-amount-slider"
            min="5000" max="1000000" step="5000" value="50000"/>
          <div style="display:flex;justify-content:space-between;font-size:11px;color:#aaa;margin-bottom:10px">
            <span id="sliderMinLabel">$ 5.000</span><span id="sliderMaxLabel">$ 1.000.000</span>
          </div>
          <div class="field" style="margin-bottom:14px">
            <label style="font-size:11px;color:#888;text-transform:uppercase;letter-spacing:.8px;font-weight:600;margin-bottom:5px;display:block">O ingres√° el monto manualmente</label>
            <input id="clientAmountManual" inputmode="numeric" placeholder="Ej: 2.500.000"
              style="background:#F5F7FA;border:1.5px solid #E2E8F0;border-radius:14px;padding:11px 15px;width:100%;font-family:'Sora',sans-serif;font-size:15px;font-weight:700;color:#111;outline:none;transition:border-color .2s"/>
          </div>
          <input type="hidden" id="simAmount" value="50000"/>
        </div>
        <!-- Admin mode: text input -->
        <div id="adminAmountWrap">
          <div class="input-row">
            <div class="field"><label>Monto solicitado por el cliente</label><input id="simAmountInput" class="mono" inputmode="numeric" placeholder="$ 500.000"/></div>
          </div>
        </div>
        <!-- Plazo selector: admin uses <select>, client uses pills -->
        <div id="adminPlazoWrap">
          <div class="field"><label>Plazo en meses</label><select id="simMonths"><option value="">‚Äî Seleccion√° un plazo ‚Äî</option></select></div>
        </div>
        <div id="clientPillsWrap" style="display:none">
          <div style="font-size:13px;font-weight:600;color:#444;margin-bottom:10px">Eleg√≠ el plazo</div>
          <div class="client-pills-wrap" id="clientPillsContainer"></div>
          <input type="hidden" id="simMonthsHidden" value=""/>
        </div>

        <div id="simDeductionBadge" style="display:none" class="sim-deduction-badge">
          <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          Se descontar√°n <strong id="simExpAmt">$0</strong> en gastos administrativos al acreditar.
        </div>
        <button id="btnSim" class="btn-primary"><svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>Calcular cuotas</button>
        <div id="simResult"></div>
      </div>

      <!-- Solicitud -->
      <div class="card">
        <div class="card-title"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Nueva solicitud</div>
        <div class="input-row">
          <div class="field"><label>Nombre y apellido</label><input id="bName" placeholder="Juan P√©rez"/></div>
          <div class="field"><label>DNI</label><input id="bDni" inputmode="numeric" placeholder="30123456"/></div>
        </div>
        <div class="input-row">
          <div class="field"><label>Email</label><input id="bEmail" type="email" placeholder="correo@mail.com"/></div>
          <div class="field"><label>Tel√©fono (WhatsApp)</label><input id="bPhone" inputmode="tel" placeholder="2966 123456"/></div>
        </div>
        <div class="field"><label>Alias o CBU / CVU</label><input id="bAlias" placeholder="alias.banco o 22 d√≠gitos"/></div>
        <div class="sep"></div>
        <p id="simHintText" style="font-size:12px;color:var(--muted);margin-bottom:14px;line-height:1.55">El monto y plazo se toman del Simulador. Completalo primero.</p>
        <button id="btnSendReq" class="btn-primary" style="background:linear-gradient(135deg,#0f766e,#0d9488)"><svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>Enviar solicitud</button>
      </div>

      <!-- Mi pr√©stamo -->
      <div class="card full-width" id="myloan">
        <div class="card-title"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>Consultar mi pr√©stamo</div>
        <div style="display:grid;grid-template-columns:1fr auto;gap:12px;align-items:end;max-width:420px">
          <div class="field" style="margin-bottom:0"><label>Ingres√° tu DNI</label><input id="myDni" inputmode="numeric" placeholder="Ej: 30123456"/></div>
          <button id="btnFindMyLoan" class="btn-primary" style="width:auto;padding:12px 22px">Buscar</button>
        </div>
        <div id="myLoanResult"></div>
      </div>
    </div>

    <!-- Prestify footer (only in client mode) -->
    <div class="prestify-footer" id="prestifyFooter" style="display:none">
      Potenciado por <strong>Prestify</strong> | Tu financiera, digitalizada
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ VISTA ADMIN ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div id="adminView" class="admin-wrap">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px">
      <div>
        <h2 style="font-size:20px;font-weight:800;color:var(--white);margin-bottom:2px">Panel de Administraci√≥n ‚Äî <span id="adminDashTitle" style="color:var(--sky)">Mi Financiera</span></h2>
        <p style="font-size:13px;color:var(--muted)" id="adminUserLabel"></p>
      </div>
      <button id="btnAdminLogin" class="btn-outline">Iniciar sesi√≥n de admin</button>
    </div>

    <div id="adminGate">
      <div class="auth-gate-box">
        <div class="auth-gate-icon"><svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div>
        <div class="auth-gate-title">Acceso restringido</div>
        <div class="auth-gate-sub">Inici√° sesi√≥n con tus credenciales de administrador para acceder al panel.</div>
        <button id="btnAdminLogin2" class="btn-primary">Iniciar sesi√≥n</button>
      </div>
    </div>

    <div id="adminContent" style="display:none">
      <!-- KPIs -->
      <div class="dashboard-grid">
        <div class="dash-card blue">
          <div class="dash-icon blue"><svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg></div>
          <div class="dash-label">Capital total prestado</div>
          <div class="dash-value" id="kpiInvested">$ 0</div>
          <div class="dash-sub" id="kpiActiveCount">0 pr√©stamos activos</div>
        </div>
        <div class="dash-card green">
          <div class="dash-icon green"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
          <div class="dash-label">Total recuperado</div>
          <div class="dash-value" id="kpiRecovered">$ 0</div>
          <div class="dash-sub" id="kpiPaidCount">0 cuotas cobradas</div>
        </div>
        <div class="dash-card red">
          <div class="dash-icon red"><svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
          <div class="dash-label">Capital en mora</div>
          <div class="dash-value" id="kpiMora">$ 0</div>
          <div class="dash-sub" id="kpiMoraCount">0 cuotas vencidas</div>
        </div>
        <div class="dash-card orange">
          <div class="dash-icon orange"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div>
          <div class="dash-label">Tasa de mora</div>
          <div class="dash-value" id="kpiMoraRate">0%</div>
          <div class="mora-rate-bar"><div class="mora-rate-fill" id="kpiMoraBar" style="width:0%"></div></div>
        </div>
        <div class="dash-card purple">
          <div class="dash-icon purple"><svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
          <div class="dash-label">Rentabilidad proyectada</div>
          <div class="dash-value" id="kpiProfit">$ 0</div>
          <div class="dash-sub">Intereses sistema franc√©s</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="admin-tabs">
        <button class="tab-btn active" data-tab="Cfg">‚öôÔ∏è Configuraci√≥n</button>
        <button class="tab-btn" data-tab="Pending">Pendientes <span class="tab-badge" id="badgePend">0</span></button>
        <button class="tab-btn" data-tab="Pre">Preaprobados <span class="tab-badge" id="badgePre">0</span></button>
        <button class="tab-btn" data-tab="Active">Activos <span class="tab-badge" id="badgeAct">0</span></button>
        <button class="tab-btn" data-tab="Mora">‚ö†Ô∏è Mora <span class="tab-badge warn" id="badgeMora">0</span></button>
        <button class="tab-btn" data-tab="Comprobantes">üßæ Comprobantes <span class="tab-badge warn" id="badgeComp">0</span></button>
        <button class="tab-btn" data-tab="History">Hist√≥rico</button>
      </div>

      <!-- CFG -->
      <div class="tab-content visible" id="tabCfg">
        <div class="card">
          <div class="card-title">Configuraci√≥n del sistema</div>
          <div class="cfg-section">
            <div class="cfg-section-title"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="3"/><path d="M3 9h18M9 21V9"/></svg>Identidad del negocio</div>
            <div class="logo-upload-wrap">
              <div class="logo-preview-box" id="cfgLogoPreview">DY</div>
              <div class="logo-upload-info"><h4>Logo del negocio</h4><p>PNG o JPG. Aparece en topbar y contratos.</p></div>
              <div>
                <label for="cfgLogoFile" class="btn-outline btn-sm" style="cursor:pointer;display:inline-flex">
                  <svg viewBox="0 0 24 24" style="width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Subir</label>
                <input type="file" id="cfgLogoFile" accept="image/*" style="display:none"/>
              </div>
            </div>
            <div class="input-row">
              <div class="field"><label>Nombre del negocio</label><input id="cfgAppName" placeholder="DineroYa"/></div>
              <div class="field"><label>Ciudad de operaci√≥n</label><input id="cfgCity" placeholder="R√≠o Gallegos, Santa Cruz"/></div>
            </div>
            <div class="field">
              <label>Color de tu Marca</label>
              <div style="display:flex;align-items:center;gap:12px">
                <input type="color" id="cfgBrandColor" value="#1a56db" style="width:48px;height:40px;border:none;background:none;cursor:pointer;border-radius:8px;padding:2px"/>
                <span style="font-size:12px;color:var(--muted)">Este color se aplica al portal de clientes (slider, botones, CTA).</span>
              </div>
            </div>
          </div>
          <div class="cfg-section">
            <div class="cfg-section-title"><svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>Tasas y condiciones</div>
            <div class="input-row">
              <div class="field"><label>TNA %</label><input id="cfgTna" inputmode="numeric" class="mono" placeholder="100"/></div>
              <div class="field"><label>D√≠a de vencimiento (1-28)</label><input id="cfgDue" inputmode="numeric" placeholder="10"/></div>
            </div>
            <div class="field">
              <label>Plazos disponibles (meses)</label>
              <p class="field-hint" style="margin-bottom:10px">Seleccion√° los plazos que ofrec√©s a tus clientes. Solo estos aparecer√°n en el simulador.</p>
              <div class="plazo-grid" id="plazoGrid">
                  <input type="checkbox" class="plazo-check" id="plazo1" value="1"/>
                  <label class="plazo-label" for="plazo1">1</label>
                  <input type="checkbox" class="plazo-check" id="plazo2" value="2"/>
                  <label class="plazo-label" for="plazo2">2</label>
                  <input type="checkbox" class="plazo-check" id="plazo3" value="3"/>
                  <label class="plazo-label" for="plazo3">3</label>
                  <input type="checkbox" class="plazo-check" id="plazo4" value="4"/>
                  <label class="plazo-label" for="plazo4">4</label>
                  <input type="checkbox" class="plazo-check" id="plazo5" value="5"/>
                  <label class="plazo-label" for="plazo5">5</label>
                  <input type="checkbox" class="plazo-check" id="plazo6" value="6"/>
                  <label class="plazo-label" for="plazo6">6</label>
                  <input type="checkbox" class="plazo-check" id="plazo7" value="7"/>
                  <label class="plazo-label" for="plazo7">7</label>
                  <input type="checkbox" class="plazo-check" id="plazo8" value="8"/>
                  <label class="plazo-label" for="plazo8">8</label>
                  <input type="checkbox" class="plazo-check" id="plazo9" value="9"/>
                  <label class="plazo-label" for="plazo9">9</label>
                  <input type="checkbox" class="plazo-check" id="plazo10" value="10"/>
                  <label class="plazo-label" for="plazo10">10</label>
                  <input type="checkbox" class="plazo-check" id="plazo11" value="11"/>
                  <label class="plazo-label" for="plazo11">11</label>
                  <input type="checkbox" class="plazo-check" id="plazo12" value="12"/>
                  <label class="plazo-label" for="plazo12">12</label>
                  <input type="checkbox" class="plazo-check" id="plazo13" value="13"/>
                  <label class="plazo-label" for="plazo13">13</label>
                  <input type="checkbox" class="plazo-check" id="plazo14" value="14"/>
                  <label class="plazo-label" for="plazo14">14</label>
                  <input type="checkbox" class="plazo-check" id="plazo15" value="15"/>
                  <label class="plazo-label" for="plazo15">15</label>
                  <input type="checkbox" class="plazo-check" id="plazo16" value="16"/>
                  <label class="plazo-label" for="plazo16">16</label>
                  <input type="checkbox" class="plazo-check" id="plazo17" value="17"/>
                  <label class="plazo-label" for="plazo17">17</label>
                  <input type="checkbox" class="plazo-check" id="plazo18" value="18"/>
                  <label class="plazo-label" for="plazo18">18</label>
                  <input type="checkbox" class="plazo-check" id="plazo19" value="19"/>
                  <label class="plazo-label" for="plazo19">19</label>
                  <input type="checkbox" class="plazo-check" id="plazo20" value="20"/>
                  <label class="plazo-label" for="plazo20">20</label>
                  <input type="checkbox" class="plazo-check" id="plazo21" value="21"/>
                  <label class="plazo-label" for="plazo21">21</label>
                  <input type="checkbox" class="plazo-check" id="plazo22" value="22"/>
                  <label class="plazo-label" for="plazo22">22</label>
                  <input type="checkbox" class="plazo-check" id="plazo23" value="23"/>
                  <label class="plazo-label" for="plazo23">23</label>
                  <input type="checkbox" class="plazo-check" id="plazo24" value="24"/>
                  <label class="plazo-label" for="plazo24">24</label>
              </div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button type="button" id="btnSelAllPlazos" class="btn-outline btn-sm">Seleccionar todos</button>
                <button type="button" id="btnClearPlazos" class="btn-outline btn-sm">Limpiar</button>
              </div>
            </div>
            <div class="input-row">
              <div class="field">
                <label>% Gastos administrativos</label>
                <input id="cfgExpenses" inputmode="numeric" placeholder="0" class="mono"/>
                <p class="field-hint">Se descuenta del capital a entregar. Ej: 5% de $100.000 = $5.000 menos.</p>
              </div>
              <div class="field"><label>WhatsApp del prestamista</label><input id="cfgWa" inputmode="tel" placeholder="5492966123456"/></div>
            </div>
            <div class="field">
              <label>Monto M√°ximo a Prestar</label>
              <input id="cfgMaxAmount" inputmode="numeric" class="mono" placeholder="1.000.000"/>
              <p class="field-hint">Este valor define el m√°ximo del slider en el portal de clientes. Por defecto: $ 1.000.000.</p>
            </div>
          </div>
          <div class="cfg-section">
            <div class="cfg-section-title"><svg viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>Mi Link Prestify</div>
            <p style="font-size:12px;color:var(--muted);margin-bottom:12px;line-height:1.6">Compart√≠ este link con tus clientes. Sus solicitudes llegar√°n directamente a tu panel.</p>
            <div id="myLinkPreview" style="font-family:'DM Mono',monospace;font-size:12px;color:var(--sky);padding:10px 14px;background:rgba(26,86,219,.08);border:1px solid var(--border);border-radius:10px;margin-bottom:12px;word-break:break-all"></div>
            <button id="btnCopyMyLink" class="btn-copy-link">
              <svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
              Copiar mi Link Prestify
            </button>
          </div>
          <div class="cfg-section">
            <div class="cfg-section-title"><svg viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>Mercado Pago (cobro autom√°tico)</div>
            <div id="mpStatusBadge"></div>
            <div class="input-row">
              <div class="field">
                <label>Access Token de producci√≥n</label>
                <input id="cfgMpToken" type="password" placeholder="APP_USR-xxxxxxxxxxxx"/>
                <p class="field-hint">Obtenelo en tu cuenta MP ‚Üí Credenciales. Sin token, los clientes pagar√°n por transferencia + comprobante.</p>
              </div>
              <div class="field">
                <label>Public Key</label>
                <input id="cfgMpPublicKey" placeholder="APP_USR-xxxxxxxxxxxx"/>
                <p class="field-hint">Requerida para el bot√≥n de pago en el portal del cliente.</p>
              </div>
            </div>
            <p style="font-size:11px;color:var(--muted);margin-top:4px">üí° Para cambiar a <strong style="color:var(--ice)">transferencia manual</strong>, dej√° el Access Token en blanco y guard√°.</p>
          </div>
          <button id="btnSaveCfg" class="btn-success" style="padding:13px 32px;font-size:14px">Guardar configuraci√≥n</button>
        </div>
      </div>

      <!-- PENDIENTES -->
      <div class="tab-content" id="tabPending">
        <div class="card">
          <div class="card-title">Solicitudes pendientes</div>
          <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap">
            <input class="search-input" id="searchPend" placeholder="Buscar por nombre o DNI..." style="max-width:300px"/>
            <button id="btnReloadPend" class="btn-outline btn-sm">‚Ü∫ Recargar</button>
          </div>
          <div id="listPend"><div class="empty"><div class="spinner"></div></div></div>
        </div>
      </div>

      <!-- PREAPROBADOS -->
      <div class="tab-content" id="tabPre">
        <div class="card">
          <div class="card-title">Preaprobados</div>
          <div class="toolbar" style="margin-bottom:14px"><button id="btnReloadPre" class="btn-outline btn-sm">‚Ü∫ Recargar</button></div>
          <div id="listPre"><div class="empty">Sin preaprobados</div></div>
        </div>
      </div>

      <!-- ACTIVOS -->
      <div class="tab-content" id="tabActive">
        <div class="card">
          <div class="card-title">Cartera activa</div>
          <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap">
            <input class="search-input" id="searchAct" placeholder="Buscar pr√©stamo..." style="max-width:300px"/>
            <button id="btnReloadAct" class="btn-outline btn-sm">‚Ü∫ Recargar</button>
          </div>
          <div id="listAct"><div class="empty">Sin activos</div></div>
        </div>
      </div>

      <!-- MORA -->
      <div class="tab-content" id="tabMora">
        <div class="card">
          <div class="card-title">‚ö†Ô∏è Reporte de mora</div>
          <div class="toolbar" style="margin-bottom:14px"><button id="btnReloadMora" class="btn-outline btn-sm">‚Ü∫ Recargar</button></div>
          <div class="mora-summary" id="moraSummary" style="display:none">
            <div class="mora-sum-box"><div class="mora-sum-value" id="moraTotal">$ 0</div><div class="mora-sum-label">Capital en mora</div></div>
            <div class="mora-sum-box"><div class="mora-sum-value" id="moraDeudores">0</div><div class="mora-sum-label">Deudores</div></div>
            <div class="mora-sum-box"><div class="mora-sum-value" id="moraMaxDias">0</div><div class="mora-sum-label">D√≠as m√°x. atraso</div></div>
          </div>
          <div class="mora-table" id="listMora"><div class="empty"><div class="spinner"></div></div></div>
        </div>
      </div>

      <!-- COMPROBANTES -->
      <div class="tab-content" id="tabComprobantes">
        <div class="card">
          <div class="card-title">üßæ Comprobantes pendientes de verificaci√≥n</div>
          <p style="font-size:12px;color:var(--muted);margin-bottom:14px;line-height:1.55">Clientes en modo pago manual que subieron capturas de transferencia. Verific√° y aprob√° cada cuota.</p>
          <div class="toolbar" style="margin-bottom:14px"><button id="btnReloadComp" class="btn-outline btn-sm">‚Ü∫ Recargar</button></div>
          <div id="listComp"><div class="empty"><div class="spinner"></div></div></div>
        </div>
      </div>

      <!-- HISTORICO -->
      <div class="tab-content" id="tabHistory">
        <div class="card">
          <div class="card-title">Hist√≥rico</div>
          <div class="toolbar" style="margin-bottom:14px">
            <button class="btn-outline btn-sm" id="btnTabPaid">Saldados</button>
            <button class="btn-danger btn-sm" id="btnTabCharged">Incobrables</button>
            <button class="btn-outline btn-sm" id="btnReloadInact">‚Ü∫ Recargar</button>
          </div>
          <div id="listInact"><div class="empty">Sin registros</div></div>
        </div>
      </div>
    </div><!-- /adminContent -->
  </div><!-- /adminView -->

</main>

<!-- MODAL FIRMA -->
<div class="modal-overlay" id="sigModal">
  <div class="modal-box">
    <div class="modal-title">Firma digital del contrato</div>
    <div class="modal-sub">Firm√° con el dedo en el recuadro. Tiene validez legal seg√∫n la <strong style="color:var(--sky)">Ley 25.506</strong>.</div>
    <div class="sig-canvas-wrap"><canvas id="sigCanvas"></canvas></div>
    <div class="sig-actions">
      <button id="btnClearSig" class="btn-outline">Borrar</button>
      <button id="btnConfirmSig" class="btn-success" style="flex:2">Confirmar firma</button>
    </div>
    <button id="btnCancelSig" class="btn-outline" style="width:100%;margin-top:8px">Cancelar</button>
    <p class="modal-note">Al confirmar declar√°s que esta firma electr√≥nica tiene la misma validez que la firma ol√≥grafa (Ley 25.506).</p>
  </div>
</div>

<!-- MODAL ACTIVAR -->
<div class="modal-overlay" id="activateModal">
  <div class="modal-box">
    <div class="modal-title">Activar pr√©stamo</div>
    <div class="modal-sub">Revis√° el resumen antes de activar. Este paso genera el calendario de pagos.</div>
    <div class="activate-summary" id="activateSummary"></div>
    <div style="display:flex;gap:10px">
      <button id="btnCancelActivate" class="btn-outline" style="flex:1">Cancelar</button>
      <button id="btnConfirmActivate" class="btn-success" style="flex:2">Confirmar activaci√≥n</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp }   from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail }
  from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc,
         serverTimestamp, query, where, orderBy, limit, onSnapshot, writeBatch }
  from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import { getStorage, ref as sRef, uploadString, getDownloadURL }
  from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

/* ‚ïê‚ïê FIREBASE CONFIG ‚ïê‚ïê */
const firebaseConfig = {
  apiKey:"AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
  authDomain:"estimapres.firebaseapp.com",
  projectId:"estimapres",
  storageBucket:"estimapres.firebasestorage.app",
  messagingSenderId:"578516597437",
  appId:"1:578516597437:web:f59994b87729aa1cd655d4"
};
const app     = initializeApp(firebaseConfig);
const auth    = getAuth(app);
const db      = getFirestore(app);
const storage = getStorage(app);

/* ‚ïê‚ïê UTILS ‚ïê‚ïê */
const fmtMoney = n => isNaN(n)||n==null ? "$ 0" : "$ "+Number(Math.round(n)).toLocaleString("es-AR");
const digits   = v => (v||"").replace(/\D+/g,"");
const nowTS    = () => serverTimestamp();
const daysLate = iso => Math.max(0,Math.floor((Date.now()-new Date(iso).getTime())/86400000));
const el       = id => document.getElementById(id);

function toast(msg,type="info",dur=3800){
  const c=el("toastContainer");
  const t=document.createElement("div"); t.className=`toast ${type}`; t.textContent=msg;
  c.appendChild(t); setTimeout(()=>t.remove(),dur);
}
function annuity(P,rate,m){
  const i=(rate/100)/12; if(i===0) return P/m;
  return P*i*Math.pow(1+i,m)/(Math.pow(1+i,m)-1);
}
function scheduleRows(L){
  const due=L.dueDay||10;
  const base=L.activeAt?.toDate?L.activeAt.toDate():new Date();
  const gastoOtorg=L.gastoOtorgAmt||Math.round((L.amount||0)*GASTO_OTORGAMIENTO/100);
  const capFin=L.capitalFinanciar||(L.amount||0)+gastoOtorg;
  const inst=(L.installment&&L.installment>0)?L.installment:Math.round(annuity(capFin,L.tna,L.months));
  return Array.from({length:L.months},(_,k)=>{
    const d=new Date(base.getFullYear(),base.getMonth()+k+1,1);
    d.setDate(Math.min(due,28));
    return{n:k+1,due:d.toISOString().slice(0,10),amount:inst,paid:(L.paidCount||0)>k};
  });
}

/* ‚ïê‚ïê ESTADO ‚ïê‚ïê */
let gUser=null, gLenderId=null, gRefLenderId=null;
let gSettings={tna:null,dueDay:null,appName:"Prestify",city:"R√≠o Gallegos, Santa Cruz",expenses:0,wa:"",logoBase64:"",mpToken:"",mpPublicKey:"",status:"activo",plazos:[3,6,9,12,18,24],brandColor:"#1a56db",maxAmount:1000000};
const GASTO_OTORGAMIENTO=3;
const SUPER_ADMIN_UID="CuQqbuHWkTWdFPdknVTUAkx5Xri2";
const OWNER_EMAIL = "fernandogastondelgado81@gmail.com";
let gActivateLoan=null, inactTab="paid";
let gNotifications=[], gSnapshotUnsub=null, gStatusUnsub=null, knownPendingIds=new Set();
let gObSigData=null, gObPayMethod="mp";

/* ‚ïê‚ïê ?ref= MULTITENANT ‚ïê‚ïê */
(()=>{
  const params=new URLSearchParams(location.search);
  gRefLenderId=params.get("ref")||null;
  if(gRefLenderId){
    sessionStorage.setItem("prestify_ref",gRefLenderId);
  } else {
    const stored=sessionStorage.getItem("prestify_ref");
    if(stored) gRefLenderId=stored;
  }
})();

/* ‚ïê‚ïê ROUTING INICIAL ‚ïê‚ïê */
function showLandingPage(){
  el("landingView")?.classList.add("show");
  el("heroSection").style.display="none";
  el("clientView").style.display="none";
  el("adminView").className="admin-wrap";
  el("superadminView")?.classList.remove("show");
  el("btnViewClient").style.display="none";
  el("btnViewAdmin").style.display="none";
}

function hideLandingPage(){
  el("landingView")?.classList.remove("show");
  el("btnViewClient").style.display="";
  el("btnViewAdmin").style.display="";
}

if(!gRefLenderId){
  el("landingView")?.classList.add("show");
  el("heroSection").style.display="none";
  el("clientView").style.display="none";
  el("btnViewClient").style.display="none";
  el("btnViewAdmin").style.display="none";
}

function openRegisterFlow(){
  el("registerModalOverlay").classList.add("show");
  el("regEmail").value="";
  el("regPassword").value="";
  el("regPasswordConfirm").value="";
  el("registerModalError").classList.remove("show");
  setTimeout(()=>el("regEmail").focus(),100);
}
el("btnLandingRegister")?.addEventListener("click",openRegisterFlow);
el("btnLandingRegister2")?.addEventListener("click",openRegisterFlow);
el("btnLandingLogin")?.addEventListener("click",(e)=>{
  e.preventDefault();
  hideLandingPage();
  el("heroSection").style.display="none";
  el("clientView").style.display="none";
  el("adminView").className="admin-wrap visible";
  el("adminGate")?.scrollIntoView({behavior:"smooth"});
});

el("btnCloseRegisterModal")?.addEventListener("click",()=>{
  el("registerModalOverlay").classList.remove("show");
});

el("btnSwitchToLogin")?.addEventListener("click",()=>{
  el("registerModalOverlay").classList.remove("show");
  hideLandingPage();
  el("heroSection").style.display="none";
  el("clientView").style.display="none";
  el("adminView").className="admin-wrap visible";
  setTimeout(()=>el("adminGate")?.scrollIntoView({behavior:"smooth"}),100);
});

el("btnDoRegister")?.addEventListener("click", async ()=>{
  const email=(el("regEmail").value||"").trim();
  const pass=(el("regPassword").value||"").trim();
  const passC=(el("regPasswordConfirm").value||"").trim();
  const errEl=el("registerModalError");
  errEl.classList.remove("show");

  if(!email||!pass){ errEl.textContent="Complet√° email y contrase√±a."; errEl.classList.add("show"); return; }
  if(pass.length<6){ errEl.textContent="La contrase√±a debe tener al menos 6 caracteres."; errEl.classList.add("show"); return; }
  if(pass!==passC){ errEl.textContent="Las contrase√±as no coinciden."; errEl.classList.add("show"); return; }

  const btn=el("btnDoRegister");
  btn.disabled=true; btn.textContent="Creando cuenta...";
  try{
    await createUserWithEmailAndPassword(auth, email, pass);
    el("registerModalOverlay").classList.remove("show");
    toast("‚úÖ Cuenta creada. Complet√° los datos de tu financiera.","ok",4000);
  }catch(e){
    let msg="Error al crear la cuenta.";
    if(e.code==="auth/email-already-in-use") msg="Ese email ya est√° registrado. Us√° el enlace para iniciar sesi√≥n.";
    else if(e.code==="auth/invalid-email") msg="El email no es v√°lido.";
    else if(e.code==="auth/weak-password") msg="La contrase√±a es muy d√©bil. Us√° al menos 6 caracteres.";
    errEl.textContent=msg; errEl.classList.add("show");
    btn.disabled=false; btn.textContent="Crear cuenta y continuar ‚Üí";
  }
});

const effectiveLid = () => gLenderId||gRefLenderId;
const loanQ        = (...c) => query(collection(db,"loans"),where("lenderId","==",effectiveLid()),...c);
const settRef      = ()     => doc(db,"settings",effectiveLid());
const lenderRef    = id     => doc(db,"lenders",id);
const hasMpToken   = ()     => !!(gSettings.mpToken && gSettings.mpToken.length > 10);

function checkSuspended(){
  if(gSettings.status==="pausado"){
    el("suspendedOverlay").classList.add("show");
    el("pendingOverlay").classList.remove("show");
    const adminC=el("adminContent"); if(adminC) adminC.style.display="none";
    return true;
  }
  el("suspendedOverlay").classList.remove("show");
  return false;
}

function checkPending(){
  if(gSettings.status==="pendiente"){
    el("pendingOverlay").classList.add("show");
    const adminC=el("adminContent"); if(adminC) adminC.style.display="none";
    return true;
  }
  el("pendingOverlay").classList.remove("show");
  return false;
}

async function loadLenderBranding(lid){
  try{
    const snap=await getDoc(lenderRef(lid)); if(!snap.exists()) return;
    const d=snap.data();
    if(d.primaryColor) document.documentElement.style.setProperty("--blue",d.primaryColor);
    if(d.accentColor)  document.documentElement.style.setProperty("--sky",d.accentColor);
    Object.assign(gSettings,{
      appName:d.appName||gSettings.appName, city:d.city||gSettings.city,
      tna:d.tna||gSettings.tna, dueDay:d.dueDay||gSettings.dueDay,
      expenses:d.expenses||gSettings.expenses, logoBase64:d.logoBase64||gSettings.logoBase64,
      wa:d.wa||gSettings.wa, mpToken:d.mpToken||"", mpPublicKey:d.mpPublicKey||"",
      status:d.status||"activo",
      plazos:d.plazos||gSettings.plazos,
      brandColor:d.brandColor||gSettings.brandColor||"#1a56db",
      maxAmount:d.maxAmount||gSettings.maxAmount||1000000
    });
    applyBranding(); refreshSimMeta();
  }catch(e){ console.warn("Branding:",e); }
}

async function loadSettings(){
  if(!effectiveLid()) return;
  try{ const s=await getDoc(settRef()); if(s.exists()) gSettings={...gSettings,...s.data()}; }catch{}
  if(gRefLenderId&&!gLenderId) await loadLenderBranding(gRefLenderId);
  applyBranding(); refreshSimMeta();
  const sv=(id,v)=>{const e=el(id);if(e)e.value=v||"";};
  sv("cfgTna",gSettings.tna||""); sv("cfgDue",gSettings.dueDay||"");
  sv("cfgAppName",gSettings.appName||""); sv("cfgCity",gSettings.city||"");
  sv("cfgExpenses",gSettings.expenses||0); sv("cfgWa",gSettings.wa||"");
  sv("cfgMaxAmount",gSettings.maxAmount||1000000);
  const mpTok=el("cfgMpToken"); if(mpTok) mpTok.placeholder=gSettings.mpToken?"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢":"APP_USR-xxxxxxxxxxxx";
  const mpPub=el("cfgMpPublicKey"); if(mpPub) mpPub.value=gSettings.mpPublicKey||"";
  const prev=el("cfgLogoPreview");
  if(prev){ if(gSettings.logoBase64) prev.innerHTML=`<img src="${gSettings.logoBase64}" alt="logo"/>`;
            else prev.textContent=(gSettings.appName||"P").replace(/\s+/g,"").slice(0,2).toUpperCase(); }
  const bcEl=el("cfgBrandColor"); if(bcEl&&gSettings.brandColor) bcEl.value=gSettings.brandColor;
  const mpB=el("mpStatusBadge");
  if(mpB) mpB.innerHTML=gSettings.mpToken
    ?`<span class="mp-connected">Mercado Pago conectado y activo</span>`
    :`<span class="mp-disconnected">Sin token MP ‚Äî modo transferencia manual activo</span>`;

  const plazosActivos=Array.isArray(gSettings.plazos)&&gSettings.plazos.length>0?gSettings.plazos:[3,6,9,12,18,24];
  for(let n=1;n<=24;n++){
    const cb=el(`plazo${n}`); if(cb) cb.checked=plazosActivos.includes(n);
  }
  refreshPlazoSelector();

  const linkEl=el("myLinkPreview");
  if(linkEl&&gLenderId) linkEl.textContent=location.origin+location.pathname+"?ref="+gLenderId;

  if(gLenderId){ checkSuspended(); checkPending(); }
}

function refreshSimMeta(){
  const s=(id,v)=>{const e=el(id);if(e)e.textContent=v;};
  s("lblTna",(gSettings.tna||"--")+"%");
  s("lblDue",gSettings.dueDay||"--");
  const h=el("heroTna"); if(h) h.innerHTML=gSettings.tna?`${gSettings.tna}<small>%</small>`:`&#8212;<small>%</small>`;
  const d=el("heroDue"); if(d) d.innerHTML=gSettings.dueDay?`${gSettings.dueDay}<small>del mes</small>`:`&#8212;<small>del mes</small>`;
  if(gSettings.expenses>0){ const m=el("lblExpMeta"); if(m) m.style.display=""; const le=el("lblExp"); if(le) le.textContent=gSettings.expenses+"%"; }
  refreshPlazoSelector();
}

function refreshPlazoSelector(){
  const sel=el("simMonths"); if(sel){
    const plazos=Array.isArray(gSettings.plazos)&&gSettings.plazos.length>0
      ?[...gSettings.plazos].sort((a,b)=>a-b):[3,6,9,12,18,24];
    const cur=sel.value;
    sel.innerHTML=`<option value="">‚Äî Seleccion√° un plazo ‚Äî</option>`;
    plazos.forEach(n=>{
      const opt=document.createElement("option");
      opt.value=n; opt.textContent=n+(n===1?" mes":" meses");
      if(String(n)===String(cur)) opt.selected=true;
      sel.appendChild(opt);
    });
  }
  const pillsContainer=el("clientPillsContainer");
  if(pillsContainer){
    const plazos=Array.isArray(gSettings.plazos)&&gSettings.plazos.length>0
      ?[...gSettings.plazos].sort((a,b)=>a-b):[3,6,9,12,18,24];
    const currentVal=el("simMonthsHidden")?.value||"";
    pillsContainer.innerHTML=plazos.map(n=>
      `<button type="button" class="client-pill${String(n)===String(currentVal)?" active":""}" data-months="${n}">${n} ${n===1?"mes":"m"}</button>`
    ).join("");
    pillsContainer.querySelectorAll(".client-pill").forEach(pill=>{
      pill.addEventListener("click",()=>{
        pillsContainer.querySelectorAll(".client-pill").forEach(p=>p.classList.remove("active"));
        pill.classList.add("active");
        const mh=el("simMonthsHidden"); if(mh) mh.value=pill.dataset.months;
        autoSimClient();
      });
    });
  }
}

function getSimMonths(){
  if(gRefLenderId && !gLenderId){
    return Number(el("simMonthsHidden")?.value||0);
  }
  return Number(el("simMonths")?.value||0);
}

function getSimAmount(){
  if(gRefLenderId && !gLenderId){
    const manualEl=el("clientAmountManual");
    const manualVal=manualEl?Number(digits(manualEl.value)):0;
    if(manualVal>0) return manualVal;
    return Number(el("clientAmountSlider")?.value||el("simAmount")?.value||0);
  }
  return Number(digits(el("simAmountInput")?.value||el("simAmount")?.value||""));
}

function autoSimClient(){
  const amt=getSimAmount(), m=getSimMonths();
  if(!amt || !m || !gSettings.tna) return;
  const gastoOtorgAmt=Math.round(amt*GASTO_OTORGAMIENTO/100);
  const capitalFinanciar=amt+gastoOtorgAmt;
  const cuota=Math.round(annuity(capitalFinanciar,gSettings.tna,m));
  let hero=el("clientCuotaHero");
  if(!hero){
    hero=document.createElement("div");
    hero.id="clientCuotaHero";
    hero.className="client-cuota-hero";
    const simResult=el("simResult");
    if(simResult) simResult.parentNode.insertBefore(hero,simResult);
  }
  hero.innerHTML=`<div class="client-cuota-label">Tu cuota mensual</div>
    <div class="client-cuota-value">${fmtMoney(cuota)}</div>
    <div class="client-cuota-months">${m} cuotas ¬∑ TNA ${gSettings.tna}%</div>`;
}

function applyBranding(){
  const name=gSettings.appName||"Prestify";
  document.title=name+" ¬∑ Tu financiera, digitalizada";
  const mark=el("logoMark");
  if(mark){ if(gSettings.logoBase64) mark.innerHTML=`<img src="${gSettings.logoBase64}" alt="logo"/>`;
            else mark.textContent=name.replace(/\s+/g,"").slice(0,1).toUpperCase(); }
  const mid=Math.ceil(name.length/2);
  const ln=el("logoName"); if(ln) ln.innerHTML=`${name.slice(0,mid)}<span>${name.slice(mid)}</span>`;

  const bc=gSettings.brandColor||"#1a56db";
  document.documentElement.style.setProperty("--brand-color", bc);
  document.documentElement.style.setProperty("--blue", bc);

  const adminTitle=el("adminDashTitle");
  if(adminTitle) adminTitle.textContent=name;

  if(gRefLenderId && !gLenderId){
    document.body.classList.add("client-mode");
    const maxAmt=gSettings.maxAmount||1000000;
    const sliderEl=el("clientAmountSlider");
    if(sliderEl){
      sliderEl.max=maxAmt;
      if(Number(sliderEl.value)>maxAmt) sliderEl.value=Math.round(maxAmt*0.05);
      const disp=el("clientAmountDisplay");
      if(disp) disp.textContent="$ "+Number(sliderEl.value).toLocaleString("es-AR");
      const sa=el("simAmount"); if(sa) sa.value=sliderEl.value;
    }
    const maxLbl=el("sliderMaxLabel"); if(maxLbl) maxLbl.textContent="$ "+maxAmt.toLocaleString("es-AR");
    const minLbl=el("sliderMinLabel"); if(minLbl) minLbl.textContent="$ 5.000";
    const bh=el("lenderBrandHeader"); if(bh) bh.style.display="";
    const bn=el("lenderBrandName"); if(bn) bn.textContent=name;
    const ft=el("prestifyFooter"); if(ft) ft.style.display="";
    const caw=el("clientAmountWrap"); if(caw) caw.style.display="";
    const aaw=el("adminAmountWrap"); if(aaw) aaw.style.display="none";
    const apw=el("adminPlazoWrap"); if(apw) apw.style.display="none";
    const cpw=el("clientPillsWrap"); if(cpw) cpw.style.display="";
    const hs=el("heroSection"); if(hs) hs.style.display="none";
    const ht=el("simHintText");
    if(ht) ht.textContent="Us√° el simulador para ver tu cuota, luego complet√° el formulario.";
    const btnSim=el("btnSim");
    if(btnSim) btnSim.innerHTML=`<svg viewBox="0 0 24 24" style="width:15px;height:15px;stroke:#fff;fill:none;stroke-width:2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg> Ver mi cuota`;
    const cardTitles=document.querySelectorAll(".card-title");
    if(cardTitles.length > 0) cardTitles[0].innerHTML=`<svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2.5"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>Calcul√° tu cuota`;
    if(cardTitles.length > 1) cardTitles[1].innerHTML=`<svg viewBox="0 0 24 24" style="width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Solicit√° tu pr√©stamo`;
  }
}

let gObStep=1;

function initObSigCanvas(){
  const canvas=el("obSigCanvas");
  if(!canvas) return;
  canvas.width=canvas.parentElement.clientWidth||460; canvas.height=150;
  const ctx=canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle="#60a5fa"; ctx.lineWidth=2.5; ctx.lineCap="round"; ctx.lineJoin="round";
  let drawing=false,lx=0,ly=0;
  const pos=e=>{const r=canvas.getBoundingClientRect();const s=e.touches?e.touches[0]:e;return{x:s.clientX-r.left,y:s.clientY-r.top};};
  canvas.onmousedown =e=>{drawing=true;const p=pos(e);lx=p.x;ly=p.y;};
  canvas.onmousemove =e=>{if(!drawing)return;const p=pos(e);ctx.beginPath();ctx.moveTo(lx,ly);ctx.lineTo(p.x,p.y);ctx.stroke();lx=p.x;ly=p.y;};
  canvas.onmouseup=canvas.onmouseleave=()=>drawing=false;
  canvas.ontouchstart=e=>{e.preventDefault();drawing=true;const p=pos(e);lx=p.x;ly=p.y;};
  canvas.ontouchmove =e=>{e.preventDefault();if(!drawing)return;const p=pos(e);ctx.beginPath();ctx.moveTo(lx,ly);ctx.lineTo(p.x,p.y);ctx.stroke();lx=p.x;ly=p.y;};
  canvas.ontouchend  =e=>{e.preventDefault();drawing=false;};
}

function setObStep(step){
  gObStep=step;
  [1,2,3].forEach(i=>{
    el(`obStep${i}`).className="ob-step"+(i<step?" done":i===step?" active":"");
    el(`obContent${i}`).className="ob-content"+(i===step?" active":"");
  });
}

window.selectPayMethod=function(method){
  gObPayMethod=method;
  el("pmOptMP").classList.toggle("selected",method==="mp");
  el("pmOptManual").classList.toggle("selected",method==="manual");
  el("obMpFields").style.display=method==="mp"?"":"none";
  el("obManualMsg").style.display=method==="manual"?"":"none";
};

async function showOnboarding(){
  el("onboardingOverlay").classList.add("show");
  if(gUser?.email){
    const obEmailEl=el("obEmail");
    if(obEmailEl && !obEmailEl.value) obEmailEl.value=gUser.email;
  }
  setTimeout(initObSigCanvas,200);
}

el("btnObClearSig")?.addEventListener("click",()=>{
  const c=el("obSigCanvas"); if(!c) return;
  c.getContext("2d").clearRect(0,0,c.width,c.height);
  gObSigData=null;
});

el("btnObStep1")?.addEventListener("click",()=>{
  const name=(el("obName").value||"").trim();
  const dni=digits(el("obDni").value);
  const email=(el("obEmail").value||"").trim();
  if(!name||!dni||!email){ toast("Complet√° nombre, DNI y email.","err"); return; }
  if(!el("obConsentCheck").checked){ toast("Deb√©s aceptar los t√©rminos de uso.","err"); return; }
  const canvas=el("obSigCanvas");
  const data=canvas.getContext("2d").getImageData(0,0,canvas.width,canvas.height).data;
  if(!Array.from(data).some((v,i)=>i%4===3&&v>0)){ toast("Dibuj√° tu firma para continuar.","err"); return; }
  gObSigData=canvas.toDataURL("image/png");
  setObStep(2);
});

el("btnObBack1")?.addEventListener("click",()=>setObStep(1));
el("btnObStep2")?.addEventListener("click",()=>{
  const appName=(el("obAppName").value||"").trim();
  if(!appName){ toast("Ingres√° el nombre de tu financiera.","err"); return; }
  setObStep(3);
});

el("btnObBack2")?.addEventListener("click",()=>setObStep(2));

el("btnObFinish")?.addEventListener("click",async()=>{
  if(!gLenderId){ toast("Error de sesi√≥n. Recarg√° la p√°gina.","err"); return; }
  el("btnObFinish").disabled=true; el("btnObFinish").textContent="Guardando...";
  try{
    const cfg={
      lenderId:gLenderId,
      appName:(el("obAppName").value||"Prestify").trim(),
      city:(el("obCity").value||"R√≠o Gallegos, Santa Cruz").trim(),
      tna:Number(digits(el("obTna").value)),
      dueDay:Math.min(28,Math.max(1,Number(digits(el("obDueDay").value)))),
      expenses:Number(el("obExpenses").value||3),
      minAmount:Number(digits(el("obMinAmount")?.value||"10000"))||10000,
      maxAmount:Number(digits(el("obMaxAmount")?.value||"5000000"))||5000000,
      wa:(el("obWa").value||"").trim(),
      status:"pendiente",
      plazos:[3,6,9,12,18,24],
      onboardingDone:true,
      onboardingAt:nowTS(),
      operator:{
        name:(el("obName").value||"").trim(),
        dni:digits(el("obDni").value),
        email:(el("obEmail").value||"").trim(),
        consentSignedAt:new Date().toISOString(),
        signatureImg:gObSigData||""
      },
      updatedAt:nowTS()
    };
    if(gObPayMethod==="mp"){
      const tok=(el("obMpToken").value||"").trim();
      const pub=(el("obMpPublicKey").value||"").trim();
      if(tok) cfg.mpToken=tok;
      if(pub) cfg.mpPublicKey=pub;
    }
    await Promise.all([
      setDoc(settRef(),cfg,{merge:true}),
      setDoc(lenderRef(gLenderId),cfg,{merge:true})
    ]);
    Object.assign(gSettings,cfg);
    applyBranding(); refreshSimMeta();
    el("onboardingOverlay").classList.remove("show");
    toast("‚úÖ Cuenta registrada. Aguard√° la activaci√≥n de tu financiera.","ok",6000);
    checkPending();
  }catch(e){
    toast("Error al guardar. Intent√° de nuevo.","err");
    el("btnObFinish").disabled=false; el("btnObFinish").textContent="‚úì Crear mi cuenta";
    console.error(e);
  }
});

// ===== INTERSECTION OBSERVER PARA ANIMACIONES =====
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      entry.target.classList.add('show');
    }
  });
}, { threshold: 0.1 });
setTimeout(() => {
  document.querySelectorAll('.fade-up, .fade-left, .fade-right, .fade-in').forEach(el => observer.observe(el));
}, 500);

onAuthStateChanged(auth,async u=>{
  gUser=u; gLenderId=u?u.uid:null;
  const ok=!!u;
  el("adminGate").style.display    =ok?"none":"";
  el("adminContent").style.display =ok?""    :"none";
  el("btnAdminLogin").style.display=ok?"none":"";
  el("btnLogout").style.display    =ok?""    :"none";
  el("notifWrap").style.display    =ok?""    :"none";

  if(ok){
    const saBtn=el("btnViewSuperAdmin");
    if(saBtn) saBtn.style.display=(u.uid===SUPER_ADMIN_UID || u.email===OWNER_EMAIL)?"":"none";

    el("adminUserLabel").textContent="Sesi√≥n: "+u.email+" ¬∑ Lender ID: "+u.uid.slice(0,8)+"...";

    hideLandingPage();

    if(u.uid===SUPER_ADMIN_UID || u.email===OWNER_EMAIL){
      el("heroSection").style.display="none";
      el("clientView").style.display="none";
      el("adminView").className="admin-wrap";
      el("superadminView")?.classList.add("show");
      loadSuperAdmin();
      return;
    }

    await loadSettings();

    if(checkSuspended()) return;

    if(checkPending()) {
      startStatusListener();
      return;
    }

    const lenderSnap=await getDoc(lenderRef(gLenderId));
    if(!lenderSnap.exists()||!lenderSnap.data().onboardingDone){
      showOnboarding();
    } else {
      showView("admin");
      await loadAllAdmin();
    }
    startRealtimeListener();
    startStatusListener();
  } else {
    const saBtn=el("btnViewSuperAdmin");
    if(saBtn) saBtn.style.display="none";
    if(gSnapshotUnsub){ gSnapshotUnsub(); gSnapshotUnsub=null; }

    if(!gRefLenderId){
      showLandingPage();
    } else {
      el("landingView")?.classList.remove("show");
      el("btnViewClient").style.display="";
      el("btnViewAdmin").style.display="";
      showView("client");
      await loadSettings();
    }
  }
});

function startStatusListener(){
  if(!gLenderId||gStatusUnsub) return;
  gStatusUnsub=onSnapshot(lenderRef(gLenderId),snap=>{
    if(!snap.exists()) return;
    const data=snap.data();
    const prevStatus=gSettings.status;
    gSettings.status=data.status||"activo";
    if(data.plazos) gSettings.plazos=data.plazos;

    if(checkSuspended()){
      if(gSnapshotUnsub){ gSnapshotUnsub(); gSnapshotUnsub=null; }
      return;
    }
    if(checkPending()){
      if(gSnapshotUnsub){ gSnapshotUnsub(); gSnapshotUnsub=null; }
      return;
    }
    if(prevStatus!=="activo" && gSettings.status==="activo"){
      el("pendingOverlay").classList.remove("show");
      el("adminContent").style.display=gUser?"":"none";
      toast("üéâ Tu cuenta fue activada. ¬°Bienvenido a Prestify!","ok",6000);
      loadAllAdmin(); startRealtimeListener();
      return;
    }
    el("adminContent").style.display=gUser?"":"none";
  },err=>console.error("StatusListener:",err));
}

async function doLogin(){
  const email=prompt("Email de administrador:")||"";
  const pass=prompt("Contrase√±a:")||"";
  if(!email||!pass) return;
  try{ await signInWithEmailAndPassword(auth,email,pass); toast("Sesi√≥n iniciada","ok"); }
  catch{ toast("Credenciales incorrectas","err"); }
}
el("btnAdminLogin").onclick =doLogin;
el("btnAdminLogin2").onclick=doLogin;
el("btnLogout").onclick=()=>{
  if(gStatusUnsub){ gStatusUnsub(); gStatusUnsub=null; }
  signOut(auth).then(()=>toast("Sesi√≥n cerrada","info")).catch(()=>{});
};
el("btnPendingLogout").onclick=()=>{
  if(gStatusUnsub){ gStatusUnsub(); gStatusUnsub=null; }
  signOut(auth).then(()=>{ el("pendingOverlay").classList.remove("show"); toast("Sesi√≥n cerrada","info"); }).catch(()=>{});
};
el("btnResetPass").onclick=async()=>{
  const email=prompt("Ingres√° tu email:"); if(!email) return;
  try{ await sendPasswordResetEmail(auth,email); toast("Email de recuperaci√≥n enviado","ok"); }
  catch{ toast("No se pudo enviar","err"); }
};

function startRealtimeListener(){
  if(!gLenderId||gSnapshotUnsub) return;
  const q=query(
    collection(db,"loans"),
    where("lenderId","==",gLenderId),
    where("status","==","pending"),
    orderBy("createdAt","desc"),
    limit(50)
  );
  getDocs(q).then(snap=>snap.forEach(d=>knownPendingIds.add(d.id)));
  gSnapshotUnsub=onSnapshot(q, snapshot=>{
    snapshot.docChanges().forEach(change=>{
      if(change.type==="added"){
        const id=change.doc.id;
        if(!knownPendingIds.has(id)){
          knownPendingIds.add(id);
          const data=change.doc.data();
          fireNewRequestAlert(data.borrower?.name||"Cliente", fmtMoney(data.amount), id);
        }
      }
    });
  }, err=>console.error("onSnapshot error:",err));
}

function fireNewRequestAlert(name, amt, id){
  gNotifications.unshift({id,name,amt,time:new Date().toLocaleTimeString("es-AR"),unread:true});
  renderNotifDropdown(); updateNotifBadge();
  const t=document.createElement("div");
  t.className="toast new-req";
  t.innerHTML=`<span style="font-size:22px">üîî</span>
    <div><div style="font-weight:800;font-size:14px">${name} solicit√≥ ${amt}</div>
    <div style="font-size:11px;opacity:.7;margin-top:2px">Click para ir a Pendientes ‚Üí</div></div>`;
  t.onclick=()=>{ showView("admin"); switchTab("Pending"); t.remove(); };
  el("toastContainer").appendChild(t);
  setTimeout(()=>t.remove(), 9000);
  el("alertBannerText").textContent=`Nueva solicitud de ${name} ¬∑ ${amt}`;
  const banner=el("alertBanner");
  banner.classList.add("show");
  setTimeout(()=>banner.classList.remove("show"), 7000);
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    [880,1100].forEach((freq,i)=>{
      const osc=ctx.createOscillator(), gain=ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.frequency.value=freq; osc.type="sine";
      const t0=ctx.currentTime+(i*0.18);
      gain.gain.setValueAtTime(0,t0);
      gain.gain.linearRampToValueAtTime(0.22,t0+0.04);
      gain.gain.exponentialRampToValueAtTime(0.001,t0+0.35);
      osc.start(t0); osc.stop(t0+0.35);
    });
  }catch{}
  loadPend(); computeDashboard();
}

function renderNotifDropdown(){
  const list=el("notifList");
  if(!gNotifications.length){ list.innerHTML=`<div class="notif-empty">Sin notificaciones nuevas</div>`; return; }
  list.innerHTML=gNotifications.slice(0,20).map(n=>`
    <div class="notif-item ${n.unread?'unread':''}" data-notif-id="${n.id}">
      <div class="notif-item-title">üîî Nueva solicitud ¬∑ ${n.name}</div>
      <div class="notif-item-sub">${n.amt} ¬∑ ${n.time}</div>
    </div>`).join("");
  list.querySelectorAll(".notif-item").forEach(item=>{
    item.onclick=()=>{ showView("admin"); switchTab("Pending"); el("notifDropdown").classList.remove("open"); };
  });
}
function updateNotifBadge(){
  const count=gNotifications.filter(n=>n.unread).length;
  const badge=el("notifBadge");
  badge.style.display=count>0?"flex":"none";
  badge.textContent=count>9?"9+":count;
}
el("notifBell").onclick=()=>{
  el("notifDropdown").classList.toggle("open");
  gNotifications.forEach(n=>n.unread=false);
  updateNotifBadge(); renderNotifDropdown();
};
el("btnClearNotifs").onclick=()=>{
  gNotifications=[]; renderNotifDropdown(); updateNotifBadge();
  el("notifDropdown").classList.remove("open");
};
el("alertBannerClose").onclick=()=>el("alertBanner").classList.remove("show");
document.addEventListener("click",e=>{
  if(!el("notifWrap").contains(e.target)) el("notifDropdown").classList.remove("open");
});

function showView(v){
  el("landingView")?.classList.remove("show");
  el("superadminView")?.classList.remove("show");
  const a=v==="admin";
  const sa=v==="superadmin";
  el("clientView").style.display  =(a||sa)?"none":"";
  el("heroSection").style.display =(a||sa)?"none":"";
  el("adminView").className       ="admin-wrap"+((a&&!sa)?" visible":"");
  el("btnViewClient").className   ="nav-btn"+((!a&&!sa)?" active":"");
  el("btnViewAdmin").className    ="nav-btn"+((a&&!sa)?" active":"");
  const saBtn=el("btnViewSuperAdmin");
  if(saBtn) saBtn.className="nav-btn"+(sa?" active":"");
  if(sa) el("superadminView")?.classList.add("show");
}
el("btnViewClient").onclick=()=>showView("client");
el("btnViewAdmin").onclick =()=>showView("admin");
el("btnViewSuperAdmin")?.addEventListener("click",()=>{ showView("superadmin"); loadSuperAdmin(); });

function switchTab(tabName){
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("visible"));
  const btn=document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
  if(btn) btn.classList.add("active");
  const cnt=el("tab"+tabName); if(cnt) cnt.classList.add("visible");
}
document.querySelectorAll(".tab-btn[data-tab]").forEach(btn=>{
  btn.onclick=()=>switchTab(btn.dataset.tab);
});

el("btnSim").onclick=()=>{
  const montoSolicitado=getSimAmount();
  const m=getSimMonths();
  if(!gSettings.tna||!gSettings.dueDay){ toast("El admin a√∫n no configur√≥ la TNA.","err"); return; }
  if(!montoSolicitado||!m){ el("simResult").innerHTML=""; return; }

  const gastoOtorgAmt=Math.round(montoSolicitado*GASTO_OTORGAMIENTO/100);
  const capitalFinanciar=montoSolicitado+gastoOtorgAmt;
  const cuota=Math.round(annuity(capitalFinanciar,gSettings.tna,m));
  const totalAPagar=cuota*m;
  const interesesProyectados=totalAPagar-capitalFinanciar;

  const expP=gSettings.expenses||0;
  const expA=Math.round(montoSolicitado*expP/100);
  const netoAEntregar=montoSolicitado-expA;

  const badge=el("simDeductionBadge");
  if(expP>0){ badge.style.display="flex"; el("simExpAmt").textContent=fmtMoney(expA); } else badge.style.display="none";

  let rows="";
  for(let i=1;i<=m;i++){
    const d=new Date(); d.setMonth(d.getMonth()+i); d.setDate(Math.min(gSettings.dueDay,28));
    rows+=`<div class="schedule-row"><span class="num">${String(i).padStart(2,"0")}</span><span class="date">${d.toLocaleDateString("es-AR")}</span><span class="amount">${fmtMoney(cuota)}</span><span class="action-col"><span class="pill warn">Pendiente</span></span></div>`;
  }

  if(gRefLenderId && !gLenderId){
    let hero=el("clientCuotaHero");
    if(!hero){
      hero=document.createElement("div");
      hero.id="clientCuotaHero";
      hero.className="client-cuota-hero";
      el("simResult").parentNode.insertBefore(hero,el("simResult"));
    }
    hero.innerHTML=`<div class="client-cuota-label">Tu cuota mensual</div>
      <div class="client-cuota-value">${fmtMoney(cuota)}</div>
      <div class="client-cuota-months">${m} cuotas ¬∑ TNA ${gSettings.tna}%</div>`;
  }
  el("simResult").innerHTML=`<div class="sim-result-box">
    <div class="sim-cuota-display">
      <span class="sim-cuota-label">Cuota mensual</span>
      <span class="sim-cuota-value">${fmtMoney(cuota)}</span>
    </div>
    <div class="breakdown-box">
      <div class="breakdown-row"><span class="bl">Monto solicitado</span><span class="bv">${fmtMoney(montoSolicitado)}</span></div>
      <div class="breakdown-row warn-row"><span class="bl">Gasto de otorgamiento (${GASTO_OTORGAMIENTO}%)</span><span class="bv">+ ${fmtMoney(gastoOtorgAmt)}</span></div>
      <div class="breakdown-row"><span class="bl">Capital a financiar</span><span class="bv">${fmtMoney(capitalFinanciar)}</span></div>
      ${expP>0?`<div class="breakdown-row warn-row"><span class="bl">Gastos administrativos (${expP}%)</span><span class="bv">- ${fmtMoney(expA)}</span></div>`:""}
      <div class="breakdown-row"><span class="bl">Neto a recibir</span><span class="bv" style="color:var(--ok)">${fmtMoney(netoAEntregar)}</span></div>
      <div class="breakdown-row"><span class="bl">Intereses proyectados</span><span class="bv" style="color:var(--purple)">${fmtMoney(interesesProyectados)}</span></div>
      <div class="breakdown-row accent"><span class="bl">Total a pagar</span><span class="bv">${fmtMoney(totalAPagar)}</span></div>
    </div>
    <div class="schedule-wrap"><div class="schedule-header"><span>#</span><span>Vencimiento</span><span>Importe</span><span>Estado</span></div>${rows}</div>
  </div>`;
};

el("btnSendReq").onclick=async()=>{
  const montoSolicitado=getSimAmount();
  const months=getSimMonths();
  if(!montoSolicitado||!months){ toast("Complet√° el Simulador primero.","err"); return; }
  const borrower={
    name:(el("bName").value||"").trim(), dni:digits(el("bDni").value),
    email:(el("bEmail").value||"").trim(), phone:(el("bPhone").value||"").trim(),
    alias:(el("bAlias").value||"").trim()
  };
  if(!borrower.name||!borrower.dni){ toast("Complet√° nombre y DNI.","err"); return; }

  const urlParams = new URLSearchParams(window.location.search);
  const urlRef = urlParams.get("ref") || gRefLenderId || sessionStorage.getItem("prestify_ref");
  const lid = urlRef || gLenderId;
  if(!lid){
    toast("Error: no se detect√≥ el prestamista. Verific√° que la URL tenga ?ref=ID.","err");
    console.error("lenderId faltante. URL:",location.href,"gRefLenderId:",gRefLenderId,"gLenderId:",gLenderId);
    return;
  }
  if(!gSettings.tna){ toast("Error: no se pudo cargar la configuraci√≥n del prestamista.","err"); return; }

  const gastoOtorgAmt=Math.round(montoSolicitado*GASTO_OTORGAMIENTO/100);
  const capitalFinanciar=montoSolicitado+gastoOtorgAmt;
  const cuota=Math.round(annuity(capitalFinanciar, gSettings.tna||100, months));

  try{
    const loanDoc={
      status:"pending",
      lenderId:lid,
      amount:montoSolicitado,
      gastoOtorgPct:GASTO_OTORGAMIENTO,
      gastoOtorgAmt,
      capitalFinanciar,
      months,
      tna:gSettings.tna||0, dueDay:gSettings.dueDay||10,
      installment:cuota,
      borrower,
      createdAt:nowTS(), updatedAt:nowTS()
    };
    console.log("Guardando pr√©stamo con lenderId:",lid,loanDoc);
    await addDoc(collection(db,"loans"),loanDoc);
    const sendBtn=el("btnSendReq");
    const originalHtml=sendBtn.innerHTML;
    sendBtn.innerHTML=`<svg viewBox="0 0 24 24" style="width:20px;height:20px;stroke:#fff;fill:none;stroke-width:2.5"><polyline points="20 6 9 17 4 12"/></svg> ¬°Solicitud enviada con √©xito!`;
    sendBtn.style.background="linear-gradient(135deg,#059669,#10b981)";
    sendBtn.disabled=true;
    ["bName","bDni","bEmail","bPhone","bAlias"].forEach(id=>{const e=el(id);if(e)e.value="";});
    toast("‚úÖ Solicitud enviada. Te contactaremos pronto.","ok",5000);
    const successCard=document.createElement("div");
    successCard.className="req-success-card";
    successCard.innerHTML=`<div class="req-success-icon">‚úì</div><div><div class="req-success-title">¬°Solicitud recibida!</div><div class="req-success-sub">El prestamista revisar√° tu solicitud y se pondr√° en contacto con vos.</div></div>`;
    sendBtn.parentNode.insertBefore(successCard,sendBtn.nextSibling);
    setTimeout(()=>{successCard.remove();sendBtn.innerHTML=originalHtml;sendBtn.style.background="";sendBtn.disabled=false;},6000);
  }catch(e){ toast("Error al enviar. Intent√° de nuevo.","err"); console.error("Error saving loan:",e); }
};

function waButton(phone,name){
  if(!phone) return "";
  return `<a href="https://wa.me/${digits(phone)}?text=Hola+${encodeURIComponent(name||"")}" target="_blank" class="btn-wa btn-sm"><svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>WA</a>`;
}
function loanItem(d,actions=""){
  const b=d.borrower||{};
  const notesHtml=d.notes?`<div class="loan-notes"><strong>Nota:</strong> ${d.notes}</div>`:"";
  const gastoOtorg=d.gastoOtorgAmt||Math.round((d.amount||0)*GASTO_OTORGAMIENTO/100);
  const capFin=d.capitalFinanciar||(d.amount||0)+gastoOtorg;
  const cuota=d.installment||Math.round(annuity(capFin,d.tna||100,d.months||1));
  const breakdownHtml=`<div class="breakdown-box" style="margin-top:10px;margin-bottom:0">
    <div class="breakdown-row"><span class="bl">Monto solicitado</span><span class="bv">${fmtMoney(d.amount)}</span></div>
    <div class="breakdown-row warn-row"><span class="bl">Gasto otorgamiento (${d.gastoOtorgPct||GASTO_OTORGAMIENTO}%)</span><span class="bv">+ ${fmtMoney(gastoOtorg)}</span></div>
    <div class="breakdown-row"><span class="bl">Capital a financiar</span><span class="bv">${fmtMoney(capFin)}</span></div>
    <div class="breakdown-row accent"><span class="bl">Cuota mensual ¬∑ ${d.months}m ¬∑ TNA ${d.tna}%</span><span class="bv">${fmtMoney(cuota)}</span></div>
  </div>`;
  return `<div class="loan-item">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div><div class="loan-name">${b.name||"--"}</div>
        <div class="loan-meta"><span>DNI <strong>${b.dni||"--"}</strong></span><span>Solicitado <strong>${fmtMoney(d.amount)}</strong></span><span><strong>${d.months}</strong> cuotas</span><span>TNA <strong>${d.tna}%</strong></span>${d.contractId?`<span>Contrato <strong>${d.contractId}</strong></span>`:""}</div>
      </div>
      ${waButton(b.phone,b.name)}
    </div>${breakdownHtml}${notesHtml}<div class="toolbar">${actions}</div></div>`;
}
function attachNotes(box){
  box.querySelectorAll("[data-note]").forEach(btn=>btn.onclick=async()=>{
    const id=btn.getAttribute("data-note");
    const s=await getDoc(doc(db,"loans",id)); if(!s.exists()) return;
    const txt=prompt("Nota de seguimiento:",s.data().notes||""); if(txt===null) return;
    await updateDoc(doc(db,"loans",id),{notes:txt,updatedAt:nowTS()});
    toast("Nota guardada","ok"); await loadAllAdmin();
  });
}
function applySearch(inputId,container){
  const q=(el(inputId)?.value||"").toLowerCase();
  container.querySelectorAll(".loan-item").forEach(item=>item.style.display=item.textContent.toLowerCase().includes(q)?"":"none");
}
el("searchPend")?.addEventListener("input",()=>applySearch("searchPend",el("listPend")));
el("searchAct")?.addEventListener("input",()=>applySearch("searchAct",el("listAct")));

async function loadPend(){
  if(!gLenderId) return;
  const box=el("listPend"); box.innerHTML="";
  try{
    const qs=await getDocs(loanQ(where("status","==","pending"),orderBy("createdAt","desc"),limit(100)));
    el("badgePend").textContent=qs.size;
    if(qs.empty){box.innerHTML=`<div class="empty">Sin solicitudes pendientes</div>`;return;}
    qs.forEach(docu=>{
      const d={...docu.data(),id:docu.id};
      box.insertAdjacentHTML("beforeend",loanItem(d,
        `<button class="btn-success btn-sm" data-pre="${d.id}">Preaprobar</button>
         <button class="btn-outline btn-sm" data-note="${d.id}">Nota</button>
         <button class="btn-danger btn-sm" data-del="${d.id}">Eliminar</button>`));
    });
    attachNotes(box);
    box.querySelectorAll("[data-pre]").forEach(btn=>btn.onclick=async()=>{
      if(!confirm("¬øPreaprobar?")) return;
      const contractId=Math.random().toString(36).slice(2,10).toUpperCase();
      await updateDoc(doc(db,"loans",btn.getAttribute("data-pre")),{status:"preapproved",contractId,updatedAt:nowTS()});
      toast("Preaprobado","ok"); await loadAllAdmin();
    });
    box.querySelectorAll("[data-del]").forEach(btn=>btn.onclick=async()=>{
      if(!confirm("¬øEliminar?")) return;
      await updateDoc(doc(db,"loans",btn.getAttribute("data-del")),{status:"deleted",updatedAt:nowTS()});
      toast("Eliminado","info"); await loadAllAdmin();
    });
  }catch(e){box.innerHTML=`<div class="empty">Error al cargar.</div>`;console.error(e);}
}

async function loadPre(){
  if(!gLenderId) return;
  const box=el("listPre"); box.innerHTML="";
  try{
    const qs=await getDocs(loanQ(where("status","==","preapproved"),orderBy("createdAt","desc"),limit(100)));
    el("badgePre").textContent=qs.size;
    if(qs.empty){box.innerHTML=`<div class="empty">Sin preaprobados</div>`;return;}
    qs.forEach(docu=>{
      const d={...docu.data(),id:docu.id};
      const badge=d.signed?`<span class="pill ok">Firmado</span>`:`<span class="pill warn">Sin firma</span>`;
      const acts=[
        `<button class="btn-outline btn-sm" data-share="${d.id}">Compartir link</button>`,
        d.signed?`<button class="btn-success btn-sm" data-approve="${d.id}">Activar</button>`:"",
        `<button class="btn-outline btn-sm" data-open="${d.id}">Ver contrato</button>`,
        `<button class="btn-outline btn-sm" data-note="${d.id}">Nota</button>`,
        `<button class="btn-danger btn-sm" data-del="${d.id}">‚úï</button>`
      ].join(" ");
      box.insertAdjacentHTML("beforeend",loanItem(d,badge+" "+acts));
    });
    attachNotes(box);
    box.querySelectorAll("[data-open]").forEach(b=>b.onclick=async()=>{
      const s=await getDoc(doc(db,"loans",b.getAttribute("data-open"))); if(!s.exists()) return;
      openContractWindow({...s.data(),id:b.getAttribute("data-open")});
    });
    box.querySelectorAll("[data-share]").forEach(b=>b.onclick=async()=>{
      const id=b.getAttribute("data-share");
      const s=await getDoc(doc(db,"loans",id)); if(!s.exists()) return;
      const L={...s.data(),id};
      const link=location.origin+location.pathname+"?ref="+gLenderId+"#sign-"+id;
      const msg=`Hola ${L.borrower?.name}, tu contrato ${gSettings.appName||"DineroYa"} (${L.contractId}) est√° listo. Firmalo ac√°: ${link}`;
      if(navigator.share){try{await navigator.share({title:"Contrato",text:msg});}catch{}}
      else prompt("Copi√° el enlace:",link);
    });
    box.querySelectorAll("[data-approve]").forEach(b=>b.onclick=async()=>{
      const id=b.getAttribute("data-approve");
      const s=await getDoc(doc(db,"loans",id)); if(!s.exists()) return;
      const L=s.data(); if(!L.signed){toast("Todav√≠a no firm√≥.","err");return;}
      showActivateModal({...L,id});
    });
    box.querySelectorAll("[data-del]").forEach(b=>b.onclick=async()=>{
      if(!confirm("¬øEliminar?")) return;
      await updateDoc(doc(db,"loans",b.getAttribute("data-del")),{status:"deleted",updatedAt:nowTS()});
      toast("Eliminado","info"); await loadAllAdmin();
    });
  }catch(e){box.innerHTML=`<div class="empty">Error al cargar.</div>`;console.error(e);}
}

async function loadAct(){
  if(!gLenderId) return;
  const box=el("listAct"); box.innerHTML="";
  try{
    const qs=await getDocs(loanQ(where("status","==","active"),orderBy("activeAt","desc"),limit(100)));
    el("badgeAct").textContent=qs.size;
    if(qs.empty){box.innerHTML=`<div class="empty">Sin pr√©stamos activos</div>`;return;}
    qs.forEach(docu=>{
      const d={...docu.data(),id:docu.id};
      const allPaid=(d.paidCount||0)>=d.months;
      const pct=d.months?Math.round((d.paidCount||0)/d.months*100):0;
      box.insertAdjacentHTML("beforeend",`<div class="loan-item" id="li-${d.id}">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div><div class="loan-name">${d.borrower?.name||"--"}</div>
            <div class="loan-meta"><span>DNI <strong>${d.borrower?.dni||"--"}</strong></span><span><strong>${fmtMoney(d.amount)}</strong></span><span><strong>${d.months}</strong> cuotas</span><span>TNA <strong>${d.tna}%</strong></span>${d.contractId?`<span><strong>${d.contractId}</strong></span>`:""}</div>
            <div style="margin:8px 0 4px"><div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:4px"><span>Progreso</span><span style="color:var(--sky)">${d.paidCount||0}/${d.months} cuotas</span></div><div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:${pct}%"></div></div></div>
          </div>
          ${waButton(d.borrower?.phone,d.borrower?.name)}
        </div>
        ${d.notes?`<div class="loan-notes"><strong>Nota:</strong> ${d.notes}</div>`:""}
        <div class="toolbar">
          <button class="btn-outline btn-sm" data-cuotas="${d.id}">üìÖ Ver cuotas</button>
          <button class="btn-success btn-sm" data-paid="${d.id}" ${allPaid?"":"disabled"}>‚úì Cerrar saldado</button>
          <button class="btn-outline btn-sm" data-note="${d.id}">Nota</button>
          <button class="btn-danger btn-sm" data-charge="${d.id}">Incobrable</button>
        </div>
        <div id="sch-${d.id}"></div></div>`);
    });
    attachNotes(box);
    box.querySelectorAll("[data-cuotas]").forEach(b=>b.onclick=async()=>{
      const id=b.getAttribute("data-cuotas");
      const schEl=el(`sch-${id}`);
      if(schEl.innerHTML){schEl.innerHTML="";return;}
      const s=await getDoc(doc(db,"loans",id)); if(!s.exists()) return;
      const L={...s.data(),id};
      const rowsHtml=scheduleRows(L).map(r=>{
        const late=daysLate(r.due);
        const badge=r.paid?`<span class="pill ok">Pagada</span>`:late>10?`<span class="pill bad">Mora +${late}d</span>`:late>0?`<span class="pill warn">Mora ${late}d</span>`:`<span class="pill teal">Pendiente</span>`;
        const btnPagar=r.paid?"":`<button class="btn-pay btn-sm" data-mark="${L.id}:${r.n}"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Pagar</button>`;
        const rc=r.paid?"schedule-row is-paid":late>0?"schedule-row is-late":"schedule-row";
        return `<div class="${rc}"><span class="num">${String(r.n).padStart(2,"0")}</span><span class="date">${new Date(r.due).toLocaleDateString("es-AR")}</span><span class="amount">${fmtMoney(r.amount)}</span><span class="action-col">${badge}${btnPagar}</span></div>`;
      }).join("");
      schEl.innerHTML=`<div class="schedule-wrap" style="margin-top:12px"><div class="schedule-header"><span>#</span><span>Vencimiento</span><span>Importe</span><span>Acci√≥n</span></div>${rowsHtml}</div>`;
      schEl.querySelectorAll("[data-mark]").forEach(btn=>btn.onclick=async()=>{
        const [loanId]=btn.getAttribute("data-mark").split(":");
        const s2=await getDoc(doc(db,"loans",loanId)); if(!s2.exists()) return;
        const cur=s2.data();
        await updateDoc(doc(db,"loans",loanId),{paidCount:Math.min((cur.paidCount||0)+1,cur.months),updatedAt:nowTS()});
        toast("Cuota registrada como pagada","ok");
        await loadAct(); await computeDashboard(); await loadMora();
      });
    });
    box.querySelectorAll("[data-paid]").forEach(b=>b.onclick=async()=>{
      const id=b.getAttribute("data-paid");
      const s=await getDoc(doc(db,"loans",id)); if(!s.exists()) return;
      if((s.data().paidCount||0)<s.data().months){toast("Faltan cuotas.","err");return;}
      await updateDoc(doc(db,"loans",id),{status:"paid",updatedAt:nowTS()});
      toast("Pr√©stamo cerrado como saldado","ok"); await loadAllAdmin();
    });
    box.querySelectorAll("[data-charge]").forEach(b=>b.onclick=async()=>{
      if(!confirm("¬øMover a incobrables?")) return;
      await updateDoc(doc(db,"loans",b.getAttribute("data-charge")),{status:"charged_off",chargedOffAt:nowTS(),updatedAt:nowTS()});
      toast("Movido a incobrables","info"); await loadAllAdmin();
    });
  }catch(e){box.innerHTML=`<div class="empty">Error al cargar activos.</div>`;console.error(e);}
}

async function loadMora(){
  if(!gLenderId) return;
  const box=el("listMora"); box.innerHTML="";
  try{
    const qs=await getDocs(loanQ(where("status","==","active"),orderBy("activeAt","desc"),limit(200)));
    const items=[], deudoresSet=new Set();
    qs.forEach(docu=>{
      const d={...docu.data(),id:docu.id};
      scheduleRows(d).forEach(r=>{const dl=daysLate(r.due);if(!r.paid&&dl>0){items.push({loan:d,row:r,days:dl});deudoresSet.add(d.id);}});
    });
    items.sort((a,b)=>b.days-a.days);
    el("badgeMora").textContent=items.length;
    if(!items.length){
      el("moraSummary").style.display="none";
      box.innerHTML=`<div class="empty">‚úÖ Sin cuotas en mora. ¬°Todo al d√≠a!</div>`; return;
    }
    const totalAmt=items.reduce((s,i)=>s+(i.row.amount||0),0);
    el("moraSummary").style.display="grid";
    el("moraTotal").textContent=fmtMoney(totalAmt);
    el("moraDeudores").textContent=deudoresSet.size;
    el("moraMaxDias").textContent=(items[0]?.days||0)+"d";
    items.forEach(({loan:L,row:r,days})=>{
      const b=L.borrower||{}; const phone=digits(b.phone||"");
      const msg=encodeURIComponent(`Hola ${b.name}, te contactamos de ${gSettings.appName||"DineroYa"}. Tu cuota N¬∞${r.n} de ${fmtMoney(r.amount)} tiene ${days} d√≠as de atraso. Por favor informanos el estado del pago. ¬°Gracias!`);
      const waLink=phone?`https://wa.me/${phone}?text=${msg}`:"";
      const sev=days>30?"grave":days>10?"media":"leve";
      const pillClass=sev==="grave"?"bad":sev==="media"?"warn":"teal";
      const label=sev==="grave"?"üî¥ Mora grave":sev==="media"?"üü° Mora media":"üîµ Mora leve";
      box.insertAdjacentHTML("beforeend",`<div class="mora-row ${sev}">
        <div><div class="mora-name">${b.name||"--"}</div><div class="mora-sub">DNI ${b.dni||"--"} ¬∑ Cuota ${r.n}/${L.months} ¬∑ ${L.contractId||""}</div></div>
        <div><div class="mora-dias ${sev}">${days}</div><div class="mora-dias-label ${sev}">d√≠as</div></div>
        <div><div class="mora-amount">${fmtMoney(r.amount)}</div><div class="mora-amount-label">monto cuota</div></div>
        <div><span class="pill ${pillClass}">${label}</span></div>
        <div>${waLink?`<a href="${waLink}" target="_blank" class="btn-wa"><svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>Cobrar por WhatsApp</a>`:`<span style="font-size:11px;color:var(--muted)">Sin tel√©fono</span>`}</div>
      </div>`);
    });
  }catch(e){box.innerHTML=`<div class="empty">Error al cargar mora.</div>`;console.error(e);}
}

async function loadComprobantes(){
  if(!gLenderId) return;
  const box=el("listComp"); box.innerHTML="";
  try{
    const qs=await getDocs(loanQ(where("status","==","active"),where("hasComprobantePendiente","==",true),limit(100)));
    el("badgeComp").textContent=qs.size;
    if(qs.empty){box.innerHTML=`<div class="empty">‚úÖ Sin comprobantes pendientes de verificaci√≥n</div>`;return;}
    qs.forEach(docu=>{
      const d={...docu.data(),id:docu.id};
      const b=d.borrower||{};
      const comps=d.comprobantesPendientes||[];
      comps.forEach((comp,idx)=>{
        const imgHtml=comp.url
          ?`<img src="${comp.url}" style="max-width:100%;max-height:200px;border-radius:10px;border:1px solid var(--border-hi);margin-top:10px;display:block" alt="comprobante"/>`
          :`<p style="font-size:12px;color:var(--muted);margin-top:6px">Sin imagen adjunta</p>`;
        box.insertAdjacentHTML("beforeend",`<div class="loan-item">
          <div class="loan-name">${b.name||"--"} ‚Äî <span style="color:var(--sky)">Cuota N¬∞${comp.cuota}</span></div>
          <div class="loan-meta">
            <span>DNI <strong>${b.dni||"--"}</strong></span>
            <span>Importe cuota <strong>${fmtMoney(d.installment||0)}</strong></span>
            <span>Enviado <strong>${comp.sentAt||"--"}</strong></span>
          </div>
          ${imgHtml}
          <div class="toolbar" style="margin-top:12px">
            <button class="btn-success btn-sm" data-approve-comp="${d.id}" data-idx="${idx}" data-cuota="${comp.cuota}">‚úì Aprobar y marcar cuota como pagada</button>
            <button class="btn-danger btn-sm" data-reject-comp="${d.id}" data-idx="${idx}">‚úï Rechazar comprobante</button>
          </div>
        </div>`);
      });
    });
    box.querySelectorAll("[data-approve-comp]").forEach(btn=>btn.onclick=async()=>{
      const loanId=btn.getAttribute("data-approve-comp");
      const idx=Number(btn.getAttribute("data-idx"));
      const s=await getDoc(doc(db,"loans",loanId)); if(!s.exists()) return;
      const cur=s.data();
      const newComps=(cur.comprobantesPendientes||[]).filter((_,i)=>i!==idx);
      await updateDoc(doc(db,"loans",loanId),{
        paidCount:Math.min((cur.paidCount||0)+1,cur.months),
        comprobantesPendientes:newComps,
        hasComprobantePendiente:newComps.length>0,
        updatedAt:nowTS()
      });
      toast("‚úÖ Cuota aprobada y marcada como pagada","ok");
      await loadComprobantes(); await computeDashboard(); await loadAct();
    });
    box.querySelectorAll("[data-reject-comp]").forEach(btn=>btn.onclick=async()=>{
      if(!confirm("¬øRechazar este comprobante?")) return;
      const loanId=btn.getAttribute("data-reject-comp");
      const idx=Number(btn.getAttribute("data-idx"));
      const s=await getDoc(doc(db,"loans",loanId)); if(!s.exists()) return;
      const cur=s.data();
      const newComps=(cur.comprobantesPendientes||[]).filter((_,i)=>i!==idx);
      await updateDoc(doc(db,"loans",loanId),{
        comprobantesPendientes:newComps,
        hasComprobantePendiente:newComps.length>0,
        updatedAt:nowTS()
      });
      toast("Comprobante rechazado.","info"); await loadComprobantes();
    });
  }catch(e){box.innerHTML=`<div class="empty">Error al cargar comprobantes.</div>`;console.error(e);}
}

async function loadInact(){
  if(!gLenderId) return;
  const box=el("listInact"); box.innerHTML="";
  try{
    const status=inactTab==="paid"?"paid":"charged_off";
    const qs=await getDocs(loanQ(where("status","==",status),orderBy("updatedAt","desc"),limit(100)));
    if(qs.empty){box.innerHTML=`<div class="empty">Sin registros</div>`;return;}
    qs.forEach(docu=>{
      const d={...docu.data(),id:docu.id};
      let acts=`<button class="btn-outline btn-sm" data-open="${d.id}">Contrato</button>`;
      if(inactTab==="charged_off") acts+=` <button class="btn-danger btn-sm" data-debt="${d.id}">Certificado</button>`;
      acts+=` <button class="btn-danger btn-sm" data-del="${d.id}">‚úï</button>`;
      box.insertAdjacentHTML("beforeend",loanItem(d,acts));
    });
    box.querySelectorAll("[data-open]").forEach(b=>b.onclick=async()=>{const s=await getDoc(doc(db,"loans",b.getAttribute("data-open")));if(!s.exists())return;openContractWindow({...s.data(),id:b.getAttribute("data-open")});});
    box.querySelectorAll("[data-debt]").forEach(b=>b.onclick=async()=>{const s=await getDoc(doc(db,"loans",b.getAttribute("data-debt")));if(!s.exists())return;openDebtCertificate({...s.data(),id:b.getAttribute("data-debt")});});
    box.querySelectorAll("[data-del]").forEach(b=>b.onclick=async()=>{if(!confirm("¬øEliminar definitivamente?"))return;await deleteDoc(doc(db,"loans",b.getAttribute("data-del")));toast("Eliminado","info");await loadInact();});
  }catch(e){box.innerHTML=`<div class="empty">Error al cargar.</div>`;}
}
el("btnTabPaid").onclick    =()=>{inactTab="paid";        loadInact();};
el("btnTabCharged").onclick =()=>{inactTab="charged_off"; loadInact();};
el("btnReloadPend").onclick =loadPend;
el("btnReloadPre").onclick  =loadPre;
el("btnReloadAct").onclick  =loadAct;
el("btnReloadMora").onclick =loadMora;
el("btnReloadComp").onclick =loadComprobantes;
el("btnReloadInact").onclick=loadInact;

async function computeDashboard(){
  if(!gLenderId) return;
  try{
    const qs=await getDocs(loanQ(where("status","==","active"),limit(500)));
    let invested=0,recovered=0,mora=0,profit=0,moraCount=0,paidCount=0,totalInst=0;
    qs.forEach(docu=>{
      const L=docu.data(); invested+=(L.amount||0);
      const inst=(L.installment&&L.installment>0)?L.installment:Math.round(annuity(L.amount,L.tna,L.months));
      const paid=(L.paidCount||0); recovered+=inst*paid; paidCount+=paid;
      totalInst+=L.months; profit+=(inst*L.months)-(L.amount||0);
      scheduleRows(L).forEach(r=>{if(!r.paid&&daysLate(r.due)>0){mora+=(r.amount||0);moraCount++;}});
    });
    const moraRate=totalInst>0?Math.round((moraCount/totalInst)*100):0;
    el("kpiInvested").textContent   =fmtMoney(invested);
    el("kpiActiveCount").textContent=qs.size+" pr√©stamos activos";
    el("kpiRecovered").textContent  =fmtMoney(recovered);
    el("kpiPaidCount").textContent  =paidCount+" cuotas cobradas";
    el("kpiMora").textContent       =fmtMoney(mora);
    el("kpiMoraCount").textContent  =moraCount+" cuotas vencidas";
    el("kpiMoraRate").textContent   =moraRate+"%";
    el("kpiMoraBar").style.width    =Math.min(moraRate,100)+"%";
    el("kpiProfit").textContent     =fmtMoney(profit);
  }catch(e){console.error("Dashboard:",e);}
}

el("cfgLogoFile").onchange=async(e)=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=(ev)=>{
    gSettings.logoBase64=ev.target.result;
    el("cfgLogoPreview").innerHTML=`<img src="${ev.target.result}" alt="logo"/>`;
    applyBranding();
  };
  reader.readAsDataURL(file);
};

el("btnSelAllPlazos")?.addEventListener("click",()=>{
  for(let n=1;n<=24;n++){const cb=el(`plazo${n}`);if(cb)cb.checked=true;}
});
el("btnClearPlazos")?.addEventListener("click",()=>{
  for(let n=1;n<=24;n++){const cb=el(`plazo${n}`);if(cb)cb.checked=false;}
});

el("btnCopyMyLink")?.addEventListener("click",()=>{
  if(!gLenderId){ toast("Inici√° sesi√≥n primero.","err"); return; }
  const link=location.origin+location.pathname+"?ref="+gLenderId;
  navigator.clipboard?.writeText(link).then(()=>toast("‚úÖ Link copiado al portapapeles","ok"))
    .catch(()=>{ prompt("Copi√° tu link Prestify:",link); });
});

el("btnSaveCfg").onclick=async()=>{
  if(!gLenderId){toast("Necesit√°s iniciar sesi√≥n primero.","err");return;}
  const tna      =Number(digits(el("cfgTna").value));
  const due      =Math.min(28,Math.max(1,Number(digits(el("cfgDue").value))));
  const appName  =(el("cfgAppName").value||"Prestify").trim();
  const city     =(el("cfgCity").value||"R√≠o Gallegos").trim();
  const expenses =Number(el("cfgExpenses").value||"0");
  const wa       =(el("cfgWa").value||"").trim();
  const brandColor=(el("cfgBrandColor")?.value||"#1a56db");
  const maxAmount=Number(digits(el("cfgMaxAmount")?.value||"1000000"))||1000000;
  const mpTokInput=(el("cfgMpToken").value||"").trim();
  const mpPubKey =(el("cfgMpPublicKey").value||"").trim();
  const mpToken  = mpTokInput&&mpTokInput!=="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" ? mpTokInput : (mpTokInput===""?"":gSettings.mpToken||"");

  const plazos=[];
  for(let n=1;n<=24;n++){const cb=el(`plazo${n}`);if(cb&&cb.checked)plazos.push(n);}
  if(plazos.length===0){ toast("Seleccion√° al menos un plazo.","err"); return; }

  const data={tna,dueDay:due,appName,city,expenses,wa,plazos,brandColor,maxAmount,lenderId:gLenderId,updatedAt:nowTS()};
  if(gSettings.logoBase64) data.logoBase64=gSettings.logoBase64;
  data.mpToken=mpToken; gSettings.mpToken=mpToken;
  if(mpPubKey){ data.mpPublicKey=mpPubKey; gSettings.mpPublicKey=mpPubKey; }
  await Promise.all([
    setDoc(settRef(),data,{merge:true}),
    setDoc(lenderRef(gLenderId),data,{merge:true})
  ]);
  gSettings.plazos=plazos; gSettings.maxAmount=maxAmount;
  await loadSettings(); refreshPlazoSelector(); toast("Configuraci√≥n guardada","ok");
};

window.deleteLenderCascade = async function(lenderId){
  if(!lenderId){ console.error("deleteLenderCascade: falta lenderId"); return; }
  if(!confirm(`¬øEliminar PERMANENTEMENTE el lender ${lenderId} y TODOS sus pr√©stamos? Esta acci√≥n no se puede deshacer.`)) return;
  try{
    const loansSnap=await getDocs(query(collection(db,"loans"),where("lenderId","==",lenderId)));
    const BATCH_SIZE=499;
    let batch=writeBatch(db); let ops=0;
    for(const d of loansSnap.docs){
      batch.delete(d.ref); ops++;
      if(ops>=BATCH_SIZE){ await batch.commit(); batch=writeBatch(db); ops=0; }
    }
    if(ops>0) await batch.commit();

    await deleteDoc(doc(db,"settings",lenderId));
    await deleteDoc(doc(db,"lenders",lenderId));

    console.log(`‚úÖ Lender ${lenderId} y sus ${loansSnap.size} pr√©stamos eliminados.`);
    toast(`Lender eliminado. ${loansSnap.size} pr√©stamos borrados.`,"ok",6000);
  }catch(e){
    console.error("deleteLenderCascade error:",e);
    toast("Error en eliminaci√≥n cascada. Ver consola.","err");
  }
};

function showActivateModal(L){
  gActivateLoan=L;
  const gastoOtorg=L.gastoOtorgAmt||Math.round((L.amount||0)*GASTO_OTORGAMIENTO/100);
  const capFin=L.capitalFinanciar||(L.amount||0)+gastoOtorg;
  const inst=L.installment||Math.round(annuity(capFin,L.tna,L.months));
  const expPct=gSettings.expenses||0, expAmt=Math.round(L.amount*expPct/100), neto=L.amount-expAmt;
  el("activateSummary").innerHTML=`
    <div class="activate-row"><span class="l">Monto solicitado</span><span class="v">${fmtMoney(L.amount)}</span></div>
    <div class="activate-row"><span class="l">Gasto de otorgamiento (${L.gastoOtorgPct||GASTO_OTORGAMIENTO}%)</span><span class="v" style="color:var(--warn)">+ ${fmtMoney(gastoOtorg)}</span></div>
    <div class="activate-row"><span class="l">Capital a financiar</span><span class="v" style="color:var(--sky)">${fmtMoney(capFin)}</span></div>
    ${expPct>0?`<div class="activate-row"><span class="l">Gastos admin (${expPct}%)</span><span class="v" style="color:#f87171">‚Äì ${fmtMoney(expAmt)}</span></div>`:""}
    <div class="activate-row"><span class="l">Neto a entregar al cliente</span><span class="v" style="color:var(--ok)">${fmtMoney(neto)}</span></div>
    <div class="activate-row"><span class="l">Cuota mensual (franc√©s)</span><span class="v">${fmtMoney(inst)}</span></div>
    <div class="activate-row"><span class="l">Plazo</span><span class="v">${L.months} meses</span></div>
    <div class="activate-row"><span class="l">Intereses proyectados</span><span class="v" style="color:var(--purple)">${fmtMoney((inst*L.months)-capFin)}</span></div>
    <div class="activate-row"><span class="l">TOTAL A RECUPERAR</span><span class="v">${fmtMoney(inst*L.months)}</span></div>`;
  el("activateModal").classList.add("open");
}
el("btnCancelActivate").onclick=()=>{el("activateModal").classList.remove("open");gActivateLoan=null;};
el("btnConfirmActivate").onclick=async()=>{
  const L=gActivateLoan; if(!L) return;
  const gastoOtorg=L.gastoOtorgAmt||Math.round((L.amount||0)*GASTO_OTORGAMIENTO/100);
  const capFin=L.capitalFinanciar||(L.amount||0)+gastoOtorg;
  const inst=L.installment||Math.round(annuity(capFin,L.tna,L.months));
  await updateDoc(doc(db,"loans",L.id),{
    status:"active",activeAt:nowTS(),updatedAt:nowTS(),
    installment:inst,
    capitalFinanciar:capFin,
    gastoOtorgAmt:gastoOtorg,
    gastoOtorgPct:L.gastoOtorgPct||GASTO_OTORGAMIENTO,
    paidCount:0
  });
  el("activateModal").classList.remove("open"); gActivateLoan=null;
  toast("Pr√©stamo activado","ok"); await loadAllAdmin();
};

async function loadAllAdmin(){
  await loadSettings();
  if(checkSuspended()) return;
  await Promise.all([loadPend(),loadPre(),loadAct(),loadMora(),loadComprobantes(),loadInact()]);
  await computeDashboard();
}

el("btnFindMyLoan").onclick=async()=>{
  const dni=digits(el("myDni").value);
  if(!dni){el("myLoanResult").innerHTML=`<div class="empty">Ingres√° un DNI v√°lido.</div>`;return;}
  el("myLoanResult").innerHTML=`<div class="empty"><div class="spinner"></div></div>`;
  try{
    const lid=effectiveLid();
    const baseQ=lid
      ?query(collection(db,"loans"),where("lenderId","==",lid),orderBy("createdAt","desc"),limit(500))
      :query(collection(db,"loans"),orderBy("createdAt","desc"),limit(500));
    const qs=await getDocs(baseQ);
    const list=[]; qs.forEach(d=>{if((d.data().borrower?.dni||"")===dni)list.push({id:d.id,...d.data()});});
    if(!list.length){el("myLoanResult").innerHTML=`<div class="empty">No encontramos pr√©stamos para ese DNI.</div>`;return;}
    const L=list[0];
    const paid=Number(L.paidCount||0), pct=L.months?Math.round((paid/L.months)*100):0;
    const sLabels={pending:"Pendiente",preapproved:"Preaprobado",active:"Activo",paid:"Saldado",charged_off:"Incobrable"};
    const sClass={active:"ok",paid:"ok",charged_off:"bad"};
    const mpEnabled=hasMpToken();
    const manualBox=!mpEnabled&&L.status==="active"
      ?`<div style="margin-bottom:16px;padding:14px;background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.2);border-radius:12px">
          <div style="font-size:12px;font-weight:700;color:#fbbf24;text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px">üìã Instrucciones de pago</div>
          <p style="font-size:12px;color:var(--muted);line-height:1.65">Realiz√° tu transferencia al alias o CBU que te indic√≥ el prestamista.<br>Luego us√° el bot√≥n <strong style="color:var(--ice)">"Enviar comprobante"</strong> en la cuota correspondiente para adjuntar la captura. El prestamista lo verificar√° y marcar√° el pago.</p>
        </div>`
      :"";
    const rows=scheduleRows(L).map(r=>{
      const late=daysLate(r.due);
      const badge=r.paid?`<span class="pill ok">Pagada</span>`:late>0?`<span class="pill bad">Mora ${late}d</span>`:`<span class="pill teal">Pendiente</span>`;
      let payAction="";
      if(!r.paid && L.status==="active"){
        if(mpEnabled){
          const mpUrl=`https://www.mercadopago.com.ar/checkout/v1/redirect?pref_id=DEMO_${L.id}_${r.n}`;
          payAction=`<a href="${mpUrl}" target="_blank" style="padding:6px 12px;background:rgba(0,168,90,.15);border:1px solid rgba(0,168,90,.35);border-radius:8px;color:#00c878;font-size:11px;font-weight:700;text-decoration:none;display:inline-flex;align-items:center;gap:5px">üí≥ Pagar con MP</a>`;
        } else {
          payAction=`<button class="btn-comp btn-sm" data-upload="${L.id}:${r.n}">üìé Enviar comprobante</button>`;
        }
      }
      const rc=r.paid?"schedule-row is-paid":late>0?"schedule-row is-late":"schedule-row";
      return `<div class="${rc}"><span class="num">${String(r.n).padStart(2,"0")}</span><span class="date">${new Date(r.due).toLocaleDateString("es-AR")}</span><span class="amount">${fmtMoney(r.amount)}</span><span class="action-col">${badge}${payAction}</span></div>`;
    }).join("");
    let actionBtn="";
    if(L.contractId&&L.status==="preapproved"&&!L.signed) actionBtn=`<button id="btnPDF" class="btn-primary" style="width:auto;padding:12px 22px">‚úçÔ∏è Firmar contrato</button>`;
    else if(L.contractId&&L.status==="preapproved"&&L.signed) actionBtn=`<span class="pill ok" style="padding:9px 14px;font-size:13px">Contrato firmado ‚Äî Aguardando activaci√≥n</span>`;
    else if(L.contractId) actionBtn=`<button id="btnPDF" class="btn-outline">Ver contrato PDF</button>`;
    el("myLoanResult").innerHTML=`
      <div class="myloan-status">
        <div><div class="myloan-name">${L.borrower?.name||"--"}</div><div class="myloan-meta">${fmtMoney(L.amount)} ¬∑ ${L.months} cuotas ¬∑ TNA ${L.tna}%</div></div>
        <span class="pill ${sClass[L.status]||"warn"}">${sLabels[L.status]||L.status}</span>
      </div>
      <div style="margin-bottom:18px">
        <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px"><span>Progreso de pago</span><span style="color:var(--sky);font-weight:700">${paid}/${L.months} cuotas ¬∑ ${pct}%</span></div>
        <div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:${pct}%"></div></div>
      </div>
      ${actionBtn?`<div style="margin-bottom:16px">${actionBtn}</div>`:""}
      ${manualBox}
      <div class="schedule-wrap"><div class="schedule-header"><span>#</span><span>Vencimiento</span><span>Importe</span><span>Estado / Acci√≥n</span></div>${rows}</div>`;
    const pdfBtn=el("btnPDF");
    if(pdfBtn) pdfBtn.addEventListener("click",()=>{
      if(L.status==="preapproved"&&!L.signed) openSignModal(L); else openContractWindow(L);
    });
    el("myLoanResult").querySelectorAll("[data-upload]").forEach(btn=>{
      btn.onclick=()=>{
        const [loanId,cuota]=btn.getAttribute("data-upload").split(":");
        openComprobanteUpload(loanId,Number(cuota),btn);
      };
    });
  }catch(e){el("myLoanResult").innerHTML=`<div class="empty">Error al buscar.</div>`;console.error(e);}
};

function openComprobanteUpload(loanId,cuota,triggerBtn){
  const input=document.createElement("input");
  input.type="file"; input.accept="image/*,application/pdf";
  input.onchange=async()=>{
    const file=input.files[0]; if(!file) return;
    triggerBtn.textContent="‚è≥ Subiendo..."; triggerBtn.disabled=true;
    const reader=new FileReader();
    reader.onload=async ev=>{
      try{
        const path=`comprobantes/${loanId}/cuota_${cuota}_${Date.now()}`;
        const storRef=sRef(storage,path);
        await uploadString(storRef,ev.target.result,"data_url");
        const url=await getDownloadURL(storRef);
        const snap=await getDoc(doc(db,"loans",loanId)); if(!snap.exists()) return;
        const cur=snap.data();
        const pendientes=[...(cur.comprobantesPendientes||[]),{
          cuota, url,
          sentAt:new Date().toLocaleDateString("es-AR"),
          fileName:file.name
        }];
        await updateDoc(doc(db,"loans",loanId),{
          comprobantesPendientes:pendientes,
          hasComprobantePendiente:true,
          updatedAt:nowTS()
        });
        triggerBtn.outerHTML=`<span class="pill warn" style="padding:5px 10px">‚è≥ En revisi√≥n por el prestamista</span>`;
        toast("‚úÖ Comprobante enviado. El prestamista lo verificar√° pronto.","ok",5000);
      }catch(err){
        triggerBtn.textContent="üìé Enviar comprobante"; triggerBtn.disabled=false;
        toast("Error al subir el archivo. Intent√° de nuevo.","err");
        console.error(err);
      }
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

let gSignLoan=null;
function openSignModal(L){
  gSignLoan=L;
  const canvas=el("sigCanvas");
  canvas.width=canvas.parentElement.clientWidth||400; canvas.height=170;
  const ctx=canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle="#60a5fa"; ctx.lineWidth=2.5; ctx.lineCap="round"; ctx.lineJoin="round";
  let drawing=false,lx=0,ly=0;
  const pos=e=>{const r=canvas.getBoundingClientRect();const s=e.touches?e.touches[0]:e;return{x:s.clientX-r.left,y:s.clientY-r.top};};
  canvas.onmousedown =e=>{drawing=true;const p=pos(e);lx=p.x;ly=p.y;};
  canvas.onmousemove =e=>{if(!drawing)return;const p=pos(e);ctx.beginPath();ctx.moveTo(lx,ly);ctx.lineTo(p.x,p.y);ctx.stroke();lx=p.x;ly=p.y;};
  canvas.onmouseup=canvas.onmouseleave=()=>drawing=false;
  canvas.ontouchstart=e=>{e.preventDefault();drawing=true;const p=pos(e);lx=p.x;ly=p.y;};
  canvas.ontouchmove =e=>{e.preventDefault();if(!drawing)return;const p=pos(e);ctx.beginPath();ctx.moveTo(lx,ly);ctx.lineTo(p.x,p.y);ctx.stroke();lx=p.x;ly=p.y;};
  canvas.ontouchend  =e=>{e.preventDefault();drawing=false;};
  el("sigModal").classList.add("open");
}
function closeSignModal(){el("sigModal").classList.remove("open");gSignLoan=null;}
el("btnCancelSig").onclick=closeSignModal;
el("btnClearSig").onclick=()=>{const c=el("sigCanvas");c.getContext("2d").clearRect(0,0,c.width,c.height);};
el("btnConfirmSig").onclick=async()=>{
  const canvas=el("sigCanvas");
  const data=canvas.getContext("2d").getImageData(0,0,canvas.width,canvas.height).data;
  if(!Array.from(data).some((v,i)=>i%4===3&&v>0)){toast("Dibuj√° tu firma primero.","err");return;}
  const sigImg=canvas.toDataURL("image/png"); const L=gSignLoan; if(!L) return;
  try{
    await updateDoc(doc(db,"loans",L.id),{signed:true,signedAt:nowTS(),updatedAt:nowTS(),signatureImg:sigImg});
    closeSignModal(); toast("Firma registrada. El admin activar√° tu pr√©stamo en breve.","ok");
    el("btnFindMyLoan").click();
  }catch(e){toast("Error al guardar firma.","err");console.error(e);}
};

function contractHtml(L){
  const today=new Date().toLocaleDateString("es-AR");
  const name=gSettings.appName||"Prestify"; const city=gSettings.city||"R√≠o Gallegos";
  const gastoOtorg=L.gastoOtorgAmt||Math.round((L.amount||0)*GASTO_OTORGAMIENTO/100);
  const capFin=L.capitalFinanciar||(L.amount||0)+gastoOtorg;
  const inst=(L.installment&&L.installment>0)?L.installment:Math.round(annuity(capFin,L.tna,L.months));
  const expPct=gSettings.expenses||0, expAmt=Math.round(L.amount*expPct/100), neto=L.amount-expAmt;
  const rows=scheduleRows(L).map(r=>`<tr><td style="text-align:center">${r.n}</td><td>${new Date(r.due).toLocaleDateString("es-AR")}</td><td style="text-align:right">${fmtMoney(r.amount)}</td><td style="text-align:center">${r.paid?"Pagada":"Pendiente"}</td></tr>`).join("");
  const sigImg=L.signatureImg?`<div style="border:1px solid #ccc;border-radius:6px;padding:6px;max-width:260px;margin-top:6px"><img src="${L.signatureImg}" style="width:100%;max-height:70px;object-fit:contain"/><div style="font-size:9pt;color:#666;margin-top:3px">Firma digital ‚Äì Ley 25.506</div></div>`:`<div style="border-bottom:1px solid #666;width:200px;margin-top:28px;margin-bottom:4px"></div><div style="font-size:9pt;color:#888">Pendiente de firma</div>`;
  const logoHtml=gSettings.logoBase64?`<img src="${gSettings.logoBase64}" style="height:40px;margin-bottom:4px;"/>`:`<strong style="font-size:16pt">${name}</strong>`;
  return`<!DOCTYPE html><html lang="es"><head><meta charset="utf-8"><title>Contrato ${L.contractId||""}</title>
<style>@page{size:A4;margin:25mm 20mm}body{font-family:'Times New Roman',serif;color:#111;font-size:11pt;line-height:1.6}.header{text-align:center;margin-bottom:12px}h1{font-size:14pt;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}h2{font-size:11pt;text-transform:uppercase;border-bottom:1px solid #bbb;padding-bottom:3px;margin:16px 0 8px}p{margin-bottom:8px}.parties{background:#f5f5f5;border:1px solid #ddd;padding:12px;margin:12px 0;font-size:10.5pt}ol{padding-left:20px}ol li{margin-bottom:9px}table{width:100%;border-collapse:collapse;font-size:10pt;margin-top:8px}th{background:#1a56db;color:#fff;padding:7px 10px;text-align:left}td{border:1px solid #ddd;padding:6px 8px}.sign-block{display:flex;gap:60px;margin-top:30px}</style>
</head><body>
<div class="header">${logoHtml}<h1>Contrato de Pr√©stamo Personal</h1><p style="color:#555">${name} ‚Äì N.¬∞ <strong>${L.contractId||"--"}</strong> ‚Äì Fecha: <strong>${today}</strong></p></div>
<div class="parties"><strong>PRESTAMISTA:</strong> ${name}, ${city}.<br><strong>PRESTATARIO:</strong> ${L.borrower?.name||"--"}, DNI ${L.borrower?.dni||"--"}, Email: ${L.borrower?.email||"--"}, Tel: ${L.borrower?.phone||"--"}.</div>
<h2>Condiciones financieras</h2><table><tbody>
<tr><td>Monto solicitado</td><td style="text-align:right">${fmtMoney(L.amount)}</td></tr>
<tr style="color:#c60"><td>Gasto de otorgamiento (${L.gastoOtorgPct||GASTO_OTORGAMIENTO}%)</td><td style="text-align:right">+ ${fmtMoney(gastoOtorg)}</td></tr>
<tr><td><strong>Capital a financiar</strong></td><td style="text-align:right"><strong>${fmtMoney(capFin)}</strong></td></tr>
${expPct>0?`<tr style="color:#c00"><td>Gastos administrativos (${expPct}%)</td><td style="text-align:right">‚Äì ${fmtMoney(expAmt)}</td></tr><tr><td><strong>Neto a entregar</strong></td><td style="text-align:right"><strong>${fmtMoney(neto)}</strong></td></tr>`:""}
<tr><td>Cuota mensual (sistema franc√©s)</td><td style="text-align:right">${fmtMoney(inst)}</td></tr>
<tr><td>Plazo</td><td style="text-align:right">${L.months} meses</td></tr>
<tr><td>TNA</td><td style="text-align:right">${L.tna}%</td></tr>
<tr><td>D√≠a de vencimiento</td><td style="text-align:right">D√≠a ${L.dueDay}</td></tr>
</tbody></table>
<h2>Cl√°usulas</h2><ol>
<li><strong>Objeto.</strong> El PRESTAMISTA otorga la suma de <strong>${fmtMoney(neto)}</strong> (neto de gastos).</li>
<li><strong>Plazo y cuotas.</strong> ${L.months} cuotas mensuales sistema franc√©s, vencimiento d√≠a ${L.dueDay}. Cuota fija: <strong>${fmtMoney(inst)}</strong>.</li>
<li><strong>Tasa.</strong> TNA <strong>${L.tna}%</strong>.</li>
<li><strong>Mora autom√°tica.</strong> Opera de pleno derecho (art. 509 CCyCN). Intereses punitorios al doble de la tasa pactada.</li>
<li><strong>T√≠tulo ejecutivo.</strong> Constituye t√≠tulo ejecutivo h√°bil (arts. 520 y cc. CPCCN).</li>
<li><strong>Incumplimiento.</strong> Dos cuotas impagas habilita acciones judiciales e informe a centrales de riesgo.</li>
<li><strong>Firma digital ‚Äì Ley 25.506.</strong> El PRESTATARIO declara plena validez jur√≠dica de la firma electr√≥nica.</li>
<li><strong>Datos personales.</strong> Tratamiento conforme Ley 25.326.</li>
<li><strong>Jurisdicci√≥n.</strong> Tribunales Ordinarios de ${city}.</li>
</ol>
<h2>Calendario de Pagos</h2>
<table><thead><tr><th>#</th><th>Vencimiento</th><th>Importe</th><th>Estado</th></tr></thead><tbody>${rows}</tbody></table>
<h2>Firmas</h2>
<div class="sign-block">
  <div><div style="border-bottom:1px solid #555;width:200px;margin-top:30px;margin-bottom:4px"></div><div style="font-size:9.5pt"><strong>PRESTAMISTA ‚Äì ${name}</strong><br>${city}</div></div>
  <div>${sigImg}<div style="font-size:9.5pt;margin-top:4px"><strong>PRESTATARIO ‚Äì ${L.borrower?.name}</strong><br>DNI: ${L.borrower?.dni}</div></div>
</div>
<p style="margin-top:22px;font-size:9pt;color:#999;text-align:center">Generado por ${name} ‚Äì ${today} ‚Äì Ley 25.506 / Ley 25.326</p>
</body></html>`;
}
function openContractWindow(L){const w=window.open("about:blank","_blank");w.document.open();w.document.write(contractHtml(L));w.document.close();}

function openDebtCertificate(L){
  const today=new Date().toLocaleDateString("es-AR"); const name=gSettings.appName||"Prestify"; const city=gSettings.city||"R√≠o Gallegos";
  const gastoOtorg=L.gastoOtorgAmt||Math.round((L.amount||0)*GASTO_OTORGAMIENTO/100);
  const capFin=L.capitalFinanciar||(L.amount||0)+gastoOtorg;
  const late=scheduleRows(L).filter(r=>!r.paid); const capital=late.reduce((a,r)=>a+(r.amount||0),0);
  const dMax=late.length>0?daysLate(late[0].due):0; const tasaP=((L.tna||100)/100/12)*2;
  const interes=Math.round(capital*tasaP*(dMax/30)); const total=capital+interes;
  const rowsH=late.map(r=>`<tr><td style="text-align:center">${r.n}</td><td>${new Date(r.due).toLocaleDateString("es-AR")}</td><td style="text-align:right">${fmtMoney(r.amount)}</td><td style="text-align:center">${daysLate(r.due)}d</td></tr>`).join("");
  const html=`<!DOCTYPE html><html lang="es"><head><meta charset="utf-8"><title>Certificado de Deuda</title>
<style>@page{size:A4;margin:25mm 20mm}body{font-family:'Times New Roman',serif;color:#111;font-size:11pt;line-height:1.6}h1{font-size:14pt;text-align:center;color:#8b0000;text-transform:uppercase}h2{font-size:11pt;text-transform:uppercase;border-bottom:1px solid #ddd;padding-bottom:3px;margin:14px 0 8px}.alert{background:#fff0f0;border:2px solid #c00;padding:12px;margin:14px 0;color:#8b0000;font-weight:700;text-align:center}table{width:100%;border-collapse:collapse;font-size:10pt}th{background:#8b0000;color:#fff;padding:7px 10px}td{border:1px solid #ddd;padding:6px 8px}.total-row td{font-weight:700;font-size:13pt;color:#8b0000;border-top:2px solid #8b0000}</style>
</head><body>
<h1>Certificado de Deuda Exigible</h1><p style="text-align:center;color:#555">${name} ‚Äì Emitido: <strong>${today}</strong></p>
<div class="alert">DOCUMENTO LEGAL ‚Äì APTO PARA GESTI√ìN JUDICIAL / EXTRAJUDICIAL</div>
<h2>Deudor</h2><table><tbody>
<tr><td><strong>Nombre</strong></td><td>${L.borrower?.name||"--"}</td></tr>
<tr><td><strong>DNI</strong></td><td>${L.borrower?.dni||"--"}</td></tr>
<tr><td><strong>N.¬∞ Contrato</strong></td><td>${L.contractId||"--"}</td></tr>
</tbody></table>
<h2>Cuotas Impagas</h2><table><thead><tr><th>#</th><th>Vencimiento</th><th>Capital</th><th>D√≠as mora</th></tr></thead><tbody>${rowsH}</tbody></table>
<h2>Liquidaci√≥n</h2><table><tbody>
<tr><td>Capital adeudado</td><td style="text-align:right">${fmtMoney(capital)}</td></tr>
<tr><td>Intereses punitorios (${(tasaP*12*100).toFixed(0)}% anual ‚Äì ${dMax} d√≠as)</td><td style="text-align:right">${fmtMoney(interes)}</td></tr>
<tr class="total-row"><td>TOTAL EXIGIBLE al ${today}</td><td style="text-align:right">${fmtMoney(total)}</td></tr>
</tbody></table>
<p style="font-size:10pt;color:#555">Intereses estimativos. Se recalcular√°n en liquidaci√≥n judicial.</p>
<h2>Fundamento Legal</h2><p style="font-size:10pt">Contrato N.¬∞ <strong>${L.contractId||"--"}</strong> ‚Äì T√≠tulo ejecutivo (art. 523 CPCCN) ‚Äì Mora de pleno derecho (art. 509 CCyCN) ‚Äì Firma digital v√°lida (Ley 25.506).</p>
<div style="border-bottom:1px solid #555;width:200px;margin-top:40px;margin-bottom:5px"></div>
<p style="font-size:10pt"><strong>${name}</strong> ‚Äì Acreedor ‚Äì ${city}</p>
</body></html>`;
  const w=window.open("about:blank","_blank"); w.document.open(); w.document.write(html); w.document.close();
}

(async function trySignFromHash(){
  if(!location.hash.startsWith("#sign-")) return;
  const id=location.hash.replace("#sign-","").trim();
  try{
    const snap=await getDoc(doc(db,"loans",id)); if(!snap.exists()) return;
    const L={...snap.data(),id};
    if(L.signed){toast("Este contrato ya fue firmado.","info");return;}
    showView("client");
    el("myDni").value=L.borrower?.dni||"";
    el("myloan").scrollIntoView({behavior:"smooth"});
    await new Promise(r=>setTimeout(r,700));
    el("btnFindMyLoan").click();
    await new Promise(r=>setTimeout(r,1200));
    openSignModal(L);
  }catch(e){console.error(e);}
})();

const simAmountInput=el("simAmountInput");
if(simAmountInput) simAmountInput.addEventListener("input",e=>{
  const n=digits(e.target.value);
  e.target.value=n?"$ "+Number(n).toLocaleString("es-AR"):"";
  const sa=el("simAmount"); if(sa) sa.value=n;
});

const legacySimAmount=el("simAmount");
if(legacySimAmount && legacySimAmount.type!=="hidden"){
  legacySimAmount.addEventListener("input",e=>{const n=digits(e.target.value);e.target.value=n?"$ "+Number(n).toLocaleString("es-AR"):"";});
}

const slider=el("clientAmountSlider");
if(slider){
  function updateSlider(){
    const v=Number(slider.value);
    const disp=el("clientAmountDisplay");
    if(disp) disp.textContent="$ "+v.toLocaleString("es-AR");
    const sa=el("simAmount"); if(sa) sa.value=v;
    const mi=el("clientAmountManual"); if(mi) mi.value="$ "+v.toLocaleString("es-AR");
    autoSimClient();
  }
  slider.addEventListener("input",updateSlider);
  updateSlider();
}

const clientManualInput=el("clientAmountManual");
if(clientManualInput){
  clientManualInput.addEventListener("input",e=>{
    const raw=digits(e.target.value);
    if(raw) e.target.value="$ "+Number(raw).toLocaleString("es-AR");
    const numVal=Number(raw)||0;
    const sa=el("simAmount"); if(sa) sa.value=numVal;
    const sl=el("clientAmountSlider");
    if(sl){
      const currentMax=Number(sl.max)||1000000;
      if(numVal>currentMax) sl.max=numVal;
      sl.value=numVal;
    }
    const disp=el("clientAmountDisplay");
    if(disp&&numVal) disp.textContent="$ "+numVal.toLocaleString("es-AR");
    autoSimClient();
  });
  clientManualInput.addEventListener("focus",e=>{
    const raw=digits(e.target.value);
    if(raw) e.target.value=raw;
  });
  clientManualInput.addEventListener("blur",e=>{
    const raw=digits(e.target.value);
    if(raw) e.target.value="$ "+Number(raw).toLocaleString("es-AR");
  });
}
["cfgTna","cfgDue"].forEach(id=>{const e=el(id);if(e)e.addEventListener("input",ev=>ev.target.value=digits(ev.target.value));});

async function loadSuperAdmin(){
  const listEl=el("saLendersList");
  if(!listEl) return;
  listEl.innerHTML=`<div class="sa-loading"><div class="spinner"></div><p style="margin-top:12px;font-size:13px">Cargando prestamistas...</p></div>`;

  try{
    const lendersSnap=await getDocs(collection(db,"lenders"));
    const lenders=[];
    lendersSnap.forEach(d=>lenders.push({id:d.id,...d.data()}));

    const loansSnap=await getDocs(collection(db,"loans"));
    const totalLoans=loansSnap.size;
    let totalVolume = 0;
    loansSnap.forEach(d => totalVolume += d.data().amount || 0);

    const total=lenders.length;
    const activos=lenders.filter(l=>l.status==="activo").length;
    const pendientes=lenders.filter(l=>l.status==="pendiente").length;
    const pausados=lenders.filter(l=>l.status==="pausado").length;
    el("saCountLenders").textContent=total;
    el("saCountActive").textContent=activos;
    el("saCountPending").textContent=pendientes;
    el("saCountLoans").textContent=totalLoans;
    el("saVolume").textContent=fmtMoney(totalVolume);

    if(!lenders.length){
      listEl.innerHTML=`<div class="empty">No hay prestamistas registrados a√∫n.</div>`;
      return;
    }

    lenders.sort((a,b)=>{
      const order={pendiente:0,activo:1,pausado:2};
      return (order[a.status]??1)-(order[b.status]??1);
    });

    listEl.innerHTML=lenders.map(l=>{
      const status=l.status||"activo";
      const pillClass=status==="activo"?"activo":status==="pendiente"?"pendiente":"pausado";
      const pillLabel=status==="activo"?"‚úì Activo":status==="pendiente"?"‚è≥ Pendiente":"‚õî Pausado";
      const canActivate=status!=="activo";
      const canSuspend=status==="activo";
      return `<div class="sa-row" id="sarow-${l.id}">
        <div>
          <div class="sa-lender-name">${l.appName||"Sin nombre"}</div>
          <div class="sa-lender-email">${l.operator?.name||""} ${l.operator?.email?"¬∑ "+l.operator.email:""}</div>
          <div class="sa-lender-id">${l.id}</div>
        </div>
        <div>${l.operator?.email||l.city||"‚Äî"}</div>
        <div><span class="sa-status-pill ${pillClass}">${pillLabel}</span></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          ${canActivate?`<button class="sa-action-btn sa-btn-activate" onclick="saSetStatus('${l.id}','activo')">‚úì Activar</button>`:""}
          ${canSuspend?`<button class="sa-action-btn sa-btn-suspend" onclick="saSetStatus('${l.id}','pausado')">‚õî Suspender</button>`:""}
          ${status==="pausado"?`<button class="sa-action-btn sa-btn-activate" onclick="saSetStatus('${l.id}','activo')">‚Ü© Reactivar</button>`:""}
        </div>
      </div>`;
    }).join("");
  }catch(e){
    listEl.innerHTML=`<div class="empty" style="color:#f87171">Error al cargar: ${e.message}</div>`;
    console.error("SA Load error:",e);
  }
}

window.saSetStatus=async function(lenderId,newStatus){
  try{
    await setDoc(doc(db,"lenders",lenderId),{status:newStatus,updatedAt:nowTS()},{merge:true});
    await setDoc(doc(db,"settings",lenderId),{status:newStatus,updatedAt:nowTS()},{merge:true});
    toast(`Prestamista ${newStatus==="activo"?"activado":"suspendido"} correctamente.`,newStatus==="activo"?"ok":"err",4000);
    await loadSuperAdmin();
  }catch(e){
    toast("Error al cambiar estado: "+e.message,"err");
  }
};

el("btnSaLogout")?.addEventListener("click",()=>{
  if(gStatusUnsub){ gStatusUnsub(); gStatusUnsub=null; }
  signOut(auth).then(()=>toast("Sesi√≥n cerrada","info")).catch(()=>{});
});

await loadSettings();

</script>
</body>
</html>