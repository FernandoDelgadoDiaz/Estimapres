<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EstimaPres ¬∑ Pr√©stamos Personales</title>
<link rel="icon" href="assets/ping.png" />
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ============================================================ TOKENS */
:root {
  --navy:       #050d1f;
  --navy-mid:   #0b1a35;
  --navy-card:  #0f2245;
  --blue:       #1a56db;
  --blue-light: #2f6ef5;
  --blue-glow:  #3b7cf6;
  --sky:        #60a5fa;
  --ice:        #bfdbfe;
  --white:      #f8faff;
  --muted:      #7a9cc6;
  --border:     rgba(96,165,250,0.15);
  --border-hi:  rgba(96,165,250,0.4);
  --ok:         #10b981;
  --ok-dim:     rgba(16,185,129,0.12);
  --warn:       #f59e0b;
  --warn-dim:   rgba(245,158,11,0.12);
  --danger:     #ef4444;
  --danger-dim: rgba(239,68,68,0.12);
  --radius-card: 20px;
  --radius-input: 12px;
  --shadow-card: 0 8px 32px rgba(5,13,31,0.6), 0 1px 0 rgba(96,165,250,0.08) inset;
  --shadow-btn:  0 4px 20px rgba(26,86,219,0.45);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  font-family: 'Sora', sans-serif;
  background: var(--navy);
  color: var(--white);
  min-height: 100vh;
  overflow-x: hidden;
}
body::before {
  content: '';
  position: fixed; inset: 0;
  background:
    radial-gradient(ellipse 80% 60% at 70% -10%, rgba(26,86,219,0.18) 0%, transparent 65%),
    radial-gradient(ellipse 50% 40% at 0% 100%, rgba(26,86,219,0.12) 0%, transparent 60%),
    repeating-linear-gradient(0deg, transparent, transparent 39px, rgba(96,165,250,0.03) 40px),
    repeating-linear-gradient(90deg, transparent, transparent 39px, rgba(96,165,250,0.03) 40px);
  pointer-events: none; z-index: 0;
}

/* TOPBAR */
.topbar {
  position: sticky; top: 0; z-index: 100;
  background: rgba(5,13,31,0.85);
  backdrop-filter: blur(18px); -webkit-backdrop-filter: blur(18px);
  border-bottom: 1px solid var(--border);
}
.topbar-inner {
  max-width: 1160px; margin: 0 auto; padding: 0 28px;
  height: 68px; display: flex; align-items: center; gap: 32px;
}
.logo { display: flex; align-items: center; gap: 10px; text-decoration: none; flex-shrink: 0; }
.logo-mark {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--blue-light), var(--sky));
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  font-size: 15px; font-weight: 800; color: #fff;
  box-shadow: 0 0 18px rgba(47,110,245,0.5);
}
.logo-name { font-size: 18px; font-weight: 700; color: var(--white); letter-spacing: -0.4px; }
.logo-name span { color: var(--sky); }
.topbar-nav { display: flex; align-items: center; gap: 4px; margin-left: auto; }
.nav-btn {
  display: inline-flex; align-items: center; gap: 7px;
  padding: 8px 14px; border-radius: 10px;
  background: transparent; border: 1px solid transparent;
  color: var(--muted); font-family: inherit; font-size: 13px; font-weight: 500;
  cursor: pointer; transition: all 0.2s; white-space: nowrap;
}
.nav-btn svg { width: 15px; height: 15px; stroke: currentColor; fill: none; stroke-width: 2; flex-shrink: 0; }
.nav-btn:hover { background: rgba(96,165,250,0.08); border-color: var(--border); color: var(--white); }
.nav-btn.danger { color: #f87171; }
.nav-btn.danger:hover { background: var(--danger-dim); border-color: rgba(239,68,68,0.3); }

/* HERO */
.hero-section {
  position: relative; z-index: 1;
  max-width: 1160px; margin: 0 auto; padding: 64px 28px 48px;
  display: grid; grid-template-columns: 1fr auto; gap: 40px; align-items: center;
}
.hero-eyebrow {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 5px 12px; background: rgba(26,86,219,0.18);
  border: 1px solid var(--border-hi); border-radius: 999px;
  font-size: 11px; font-weight: 600; color: var(--sky);
  letter-spacing: 1.2px; text-transform: uppercase; margin-bottom: 20px;
}
.hero-eyebrow::before { content:''; width:6px; height:6px; border-radius:50%; background:var(--sky); box-shadow:0 0 8px var(--sky); }
.hero-title { font-size: clamp(32px,4vw,52px); font-weight:800; line-height:1.1; letter-spacing:-1.5px; color:var(--white); margin-bottom:16px; }
.hero-title em { font-style:normal; background:linear-gradient(90deg,var(--sky),var(--blue-glow)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.hero-sub { font-size:16px; color:var(--muted); line-height:1.6; max-width:480px; }
.hero-badges { display:flex; gap:12px; margin-top:32px; flex-wrap:wrap; }
.badge { display:flex; align-items:center; gap:7px; padding:9px 14px; background:var(--navy-card); border:1px solid var(--border); border-radius:12px; font-size:12px; font-weight:600; color:var(--ice); }
.badge svg { width:14px; height:14px; stroke:var(--sky); fill:none; stroke-width:2; }
.hero-kpis { display:grid; gap:12px; }
.kpi-box { background:var(--navy-card); border:1px solid var(--border); border-radius:16px; padding:20px 24px; text-align:right; min-width:180px; }
.kpi-box .kpi-label { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; font-weight:600; }
.kpi-box .kpi-value { font-size:28px; font-weight:800; color:var(--white); letter-spacing:-1px; margin-top:4px; font-family:'DM Mono',monospace; }
.kpi-box .kpi-value span { font-size:14px; color:var(--sky); margin-left:4px; font-family:'Sora',sans-serif; font-weight:600; }

/* LAYOUT */
.main-layout { position:relative; z-index:1; max-width:1160px; margin:0 auto; padding:0 28px 80px; display:grid; grid-template-columns:1fr 1fr; gap:24px; }
.full-width { grid-column: 1 / -1; }

/* CARD */
.card { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius-card); padding:28px; box-shadow:var(--shadow-card); position:relative; overflow:hidden; animation:fadeUp 0.4s ease both; }
.card::before { content:''; position:absolute; top:0; left:0; right:0; height:1px; background:linear-gradient(90deg,transparent,rgba(96,165,250,0.4),transparent); }
.card:nth-child(1){animation-delay:.05s}.card:nth-child(2){animation-delay:.1s}.card:nth-child(3){animation-delay:.15s}.card:nth-child(4){animation-delay:.2s}
.card-title { font-size:13px; font-weight:700; text-transform:uppercase; letter-spacing:1.4px; color:var(--sky); margin-bottom:22px; display:flex; align-items:center; gap:8px; }
.card-title svg { width:15px; height:15px; stroke:currentColor; fill:none; stroke-width:2; }
.section-divider { height:1px; background:var(--border); margin:20px 0; }

/* INPUTS */
.field { margin-bottom:18px; }
.field label { display:block; font-size:11px; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:7px; }
.field input { width:100%; background:rgba(5,13,31,0.7); border:1px solid var(--border); border-radius:var(--radius-input); padding:13px 16px; color:var(--white); font-family:'Sora',sans-serif; font-size:15px; font-weight:500; transition:border-color 0.2s,box-shadow 0.2s; outline:none; }
.field input::placeholder { color:rgba(122,156,198,0.5); font-weight:400; }
.field input:focus { border-color:var(--blue-glow); box-shadow:0 0 0 3px rgba(59,124,246,0.15); }
.field input.mono { font-family:'DM Mono',monospace; font-size:17px; }
.input-row { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.sim-meta { display:flex; gap:20px; padding:10px 14px; background:rgba(5,13,31,0.5); border:1px solid var(--border); border-radius:10px; margin-bottom:20px; }
.sim-meta-item { font-size:12px; font-weight:600; color:var(--muted); }
.sim-meta-item strong { color:var(--sky); font-family:'DM Mono',monospace; }

/* BUTTONS */
.btn-primary { width:100%; padding:14px 20px; background:linear-gradient(135deg,var(--blue-light),var(--blue)); border:none; border-radius:var(--radius-input); color:#fff; font-family:'Sora',sans-serif; font-size:14px; font-weight:700; cursor:pointer; box-shadow:var(--shadow-btn); transition:transform 0.15s,box-shadow 0.15s; display:flex; align-items:center; justify-content:center; gap:8px; }
.btn-primary:hover { transform:translateY(-1px); box-shadow:0 6px 28px rgba(26,86,219,0.55); }
.btn-primary svg { width:16px; height:16px; stroke:currentColor; fill:none; stroke-width:2.5; }
.btn-secondary { padding:10px 16px; background:transparent; border:1px solid var(--border-hi); border-radius:10px; color:var(--sky); font-family:'Sora',sans-serif; font-size:13px; font-weight:600; cursor:pointer; transition:all 0.2s; display:inline-flex; align-items:center; gap:6px; }
.btn-secondary:hover { background:rgba(96,165,250,0.08); }
.btn-success { padding:10px 16px; background:var(--ok-dim); border:1px solid rgba(16,185,129,0.3); border-radius:10px; color:var(--ok); font-family:'Sora',sans-serif; font-size:13px; font-weight:700; cursor:pointer; transition:all 0.2s; }
.btn-success:hover { background:rgba(16,185,129,0.2); }
.btn-success:disabled { opacity:0.35; cursor:not-allowed; }
.btn-danger { padding:10px 16px; background:var(--danger-dim); border:1px solid rgba(239,68,68,0.25); border-radius:10px; color:#f87171; font-family:'Sora',sans-serif; font-size:13px; font-weight:700; cursor:pointer; transition:all 0.2s; }
.btn-danger:hover { background:rgba(239,68,68,0.2); }
.btn-outline { padding:10px 16px; background:transparent; border:1px solid var(--border); border-radius:10px; color:var(--ice); font-family:'Sora',sans-serif; font-size:13px; font-weight:600; cursor:pointer; transition:all 0.2s; }
.btn-outline:hover { border-color:var(--border-hi); color:var(--white); }
.toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }

/* PILLS */
.pill { display:inline-flex; align-items:center; gap:5px; padding:4px 10px; border-radius:999px; font-size:11px; font-weight:700; }
.pill::before { content:''; width:5px; height:5px; border-radius:50%; }
.pill.ok   { background:var(--ok-dim);     color:#34d399; border:1px solid rgba(16,185,129,0.25); }
.pill.ok::before   { background:var(--ok); }
.pill.warn { background:var(--warn-dim);   color:#fbbf24; border:1px solid rgba(245,158,11,0.25); }
.pill.warn::before { background:var(--warn); }
.pill.bad  { background:var(--danger-dim); color:#f87171; border:1px solid rgba(239,68,68,0.25); }
.pill.bad::before  { background:var(--danger); }

/* SCHEDULE */
.schedule-wrap { border:1px solid var(--border); border-radius:14px; overflow:hidden; margin-top:16px; }
.schedule-header { display:grid; grid-template-columns:40px 1fr 110px 130px; gap:8px; padding:10px 16px; background:rgba(5,13,31,0.6); border-bottom:1px solid var(--border); }
.schedule-header span { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1.2px; color:var(--muted); }
.schedule-row { display:grid; grid-template-columns:40px 1fr 110px 130px; gap:8px; align-items:center; padding:12px 16px; border-bottom:1px solid rgba(96,165,250,0.06); transition:background 0.15s; }
.schedule-row:last-child { border-bottom:none; }
.schedule-row:hover { background:rgba(96,165,250,0.04); }
.schedule-row .num    { font-family:'DM Mono',monospace; font-size:13px; color:var(--muted); }
.schedule-row .date   { font-size:13px; color:var(--ice); font-weight:500; }
.schedule-row .amount { font-family:'DM Mono',monospace; font-size:14px; color:var(--white); font-weight:600; }

/* SIM RESULT */
.sim-result-box { margin-top:20px; padding:20px; background:rgba(5,13,31,0.5); border:1px solid var(--border-hi); border-radius:16px; }
.sim-cuota-display { display:flex; align-items:baseline; gap:10px; margin-bottom:16px; }
.sim-cuota-display .label { font-size:12px; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:1px; }
.sim-cuota-display .value { font-family:'DM Mono',monospace; font-size:32px; font-weight:500; color:var(--sky); letter-spacing:-1px; }

/* LOAN ITEM */
.loan-item { padding:16px; background:rgba(5,13,31,0.5); border:1px solid var(--border); border-radius:14px; margin-bottom:10px; transition:border-color 0.2s; }
.loan-item:hover { border-color:var(--border-hi); }
.loan-item:last-child { margin-bottom:0; }
.loan-name { font-size:15px; font-weight:700; color:var(--white); margin-bottom:4px; }
.loan-meta { font-size:12px; color:var(--muted); font-weight:500; display:flex; flex-wrap:wrap; gap:10px; }
.loan-meta strong { color:var(--ice); }

/* DETAILS */
details { margin-bottom:16px; }
details summary { cursor:pointer; padding:16px 20px; background:rgba(5,13,31,0.4); border:1px solid var(--border); border-radius:14px; font-size:13px; font-weight:700; color:var(--ice); list-style:none; display:flex; align-items:center; justify-content:space-between; transition:all 0.2s; user-select:none; }
details summary::-webkit-details-marker { display:none; }
details summary::after { content:''; width:8px; height:8px; border-right:2px solid var(--muted); border-bottom:2px solid var(--muted); transform:rotate(45deg); transition:transform 0.2s; flex-shrink:0; }
details[open] summary { background:rgba(26,86,219,0.1); border-color:var(--border-hi); border-radius:14px 14px 0 0; color:var(--sky); }
details[open] summary::after { transform:rotate(-135deg); }
.details-body { padding:20px; background:rgba(5,13,31,0.3); border:1px solid var(--border); border-top:none; border-radius:0 0 14px 14px; }

/* MY LOAN */
.myloan-status { display:flex; align-items:center; justify-content:space-between; padding:16px 20px; background:rgba(26,86,219,0.08); border:1px solid var(--border-hi); border-radius:14px; margin-bottom:16px; flex-wrap:wrap; gap:10px; }
.myloan-status-left .name { font-size:16px; font-weight:800; color:var(--white); margin-bottom:4px; }
.myloan-status-left .meta { font-size:13px; color:var(--muted); }
.progress-bar-wrap { height:6px; background:rgba(96,165,250,0.12); border-radius:999px; overflow:hidden; margin-top:12px; }
.progress-bar-fill { height:100%; background:linear-gradient(90deg,var(--blue),var(--sky)); border-radius:999px; transition:width 0.6s ease; }

/* MODAL FIRMA */
.modal-overlay { display:none; position:fixed; inset:0; z-index:200; background:rgba(5,13,31,0.92); backdrop-filter:blur(8px); align-items:center; justify-content:center; padding:20px; }
.modal-overlay.open { display:flex; }
.modal-box { background:var(--navy-card); border:1px solid var(--border-hi); border-radius:24px; padding:28px; width:100%; max-width:480px; box-shadow:0 24px 60px rgba(5,13,31,0.8); }
.modal-title { font-size:18px; font-weight:800; color:var(--white); margin-bottom:6px; }
.modal-sub { font-size:13px; color:var(--muted); margin-bottom:20px; line-height:1.5; }
.sig-canvas-wrap { border:2px dashed var(--border-hi); border-radius:16px; overflow:hidden; background:rgba(5,13,31,0.6); touch-action:none; }
#sigCanvas { display:block; width:100%; height:180px; cursor:crosshair; }
.sig-actions { display:flex; gap:10px; margin-top:14px; }
.modal-note { font-size:11px; color:var(--muted); margin-top:14px; line-height:1.5; padding:10px 12px; background:rgba(26,86,219,0.08); border-radius:10px; border-left:3px solid var(--border-hi); }

/* EMPTY */
.empty { padding:32px 20px; text-align:center; color:var(--muted); font-size:13px; font-weight:500; }

/* ANIMATIONS */
@keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }

/* SCROLLBAR */
::-webkit-scrollbar { width:6px; background:var(--navy); }
::-webkit-scrollbar-thumb { background:rgba(96,165,250,0.2); border-radius:999px; }

/* RESPONSIVE */
@media (max-width:900px) {
  .main-layout { grid-template-columns:1fr; }
  .hero-section { grid-template-columns:1fr; }
  .hero-kpis { grid-template-columns:1fr 1fr; }
  .topbar-inner,.hero-section,.main-layout { padding-left:16px; padding-right:16px; }
}
@media (max-width:600px) {
  .input-row { grid-template-columns:1fr; }
  .nav-btn .nav-label { display:none; }
  .schedule-header,.schedule-row { grid-template-columns:32px 1fr 90px 100px; gap:4px; padding:10px; }
  .schedule-row .amount { font-size:12px; }
  .hero-kpis { grid-template-columns:1fr 1fr; gap:8px; }
  .kpi-box { padding:14px 16px; }
  .kpi-box .kpi-value { font-size:22px; }
}
</style>
</head>
<body>

<!-- TOPBAR -->
<header class="topbar">
  <div class="topbar-inner">
    <a href="#" class="logo">
      <div class="logo-mark" id="logoMark">EP</div>
      <span class="logo-name" id="logoName">Estima<span>Pres</span></span>
    </a>
    <nav class="topbar-nav">
      <button id="btnOpenMyLoan" class="nav-btn">
        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <span class="nav-label">Mi pr√©stamo</span>
      </button>
      <button id="btnAdmin" class="nav-btn">
        <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        <span class="nav-label">Admin</span>
      </button>
      <button id="btnResetPass" class="nav-btn">
        <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        <span class="nav-label">Llave</span>
      </button>
      <button id="btnLogout" class="nav-btn danger">
        <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        <span class="nav-label">Salir</span>
      </button>
    </nav>
  </div>
</header>

<!-- HERO -->
<section class="hero-section">
  <div>
    <div class="hero-eyebrow">Plataforma Fintech ¬∑ Argentina</div>
    <h1 class="hero-title">Gesti√≥n de pr√©stamos<br><em>simple y transparente</em></h1>
    <p class="hero-sub">Simul√°, solicit√° y gestion√° pr√©stamos personales desde un solo lugar. Sin papeles, sin filas.</p>
    <div class="hero-badges">
      <div class="badge"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>SSL Seguro</div>
      <div class="badge"><svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Datos encriptados</div>
      <div class="badge"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Sin burocracia</div>
    </div>
  </div>
  <div class="hero-kpis">
    <div class="kpi-box">
      <div class="kpi-label">TNA vigente</div>
      <div class="kpi-value" id="heroTna">‚Äî<span>%</span></div>
    </div>
    <div class="kpi-box">
      <div class="kpi-label">D√≠a de pago</div>
      <div class="kpi-value" id="heroDue">‚Äî<span>del mes</span></div>
    </div>
  </div>
</section>

<!-- MAIN -->
<main class="main-layout">

  <!-- SIMULADOR -->
  <div class="card">
    <div class="card-title">
      <svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
      Simulador de cuotas
    </div>
    <div class="sim-meta">
      <div class="sim-meta-item">TNA <strong id="lblTna">‚Äî%</strong></div>
      <div class="sim-meta-item">Vence d√≠a <strong id="lblDue">‚Äî</strong></div>
    </div>
    <div class="input-row">
      <div class="field"><label>Monto del cr√©dito</label><input id="simAmount" class="mono" inputmode="numeric" placeholder="$ 500.000" /></div>
      <div class="field"><label>Plazo en meses (m√°x. 24)</label><input id="simMonths" inputmode="numeric" placeholder="12" /></div>
    </div>
    <button id="btnSim" class="btn-primary">
      <svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Calcular cuotas
    </button>
    <div id="simResult"></div>
  </div>

  <!-- SOLICITUD -->
  <div class="card">
    <div class="card-title">
      <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      Nueva solicitud
    </div>
    <div class="input-row">
      <div class="field"><label>Nombre y apellido</label><input id="bName" placeholder="Juan P√©rez" /></div>
      <div class="field"><label>DNI</label><input id="bDni" inputmode="numeric" placeholder="30123456" /></div>
    </div>
    <div class="input-row">
      <div class="field"><label>Email</label><input id="bEmail" type="email" placeholder="correo@mail.com" /></div>
      <div class="field"><label>Tel√©fono</label><input id="bPhone" inputmode="tel" placeholder="11 2345 6789" /></div>
    </div>
    <div class="field"><label>Alias o CBU / CVU</label><input id="bAlias" placeholder="alias.banco o 22 d√≠gitos" /></div>
    <div class="section-divider"></div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:16px;line-height:1.5">El monto y plazo se toman del Simulador. Completalo primero.</p>
    <button id="btnSendReq" class="btn-primary" style="background:linear-gradient(135deg,#0f766e,#0d9488)">
      <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      Enviar solicitud
    </button>
  </div>

  <!-- MI PR√âSTAMO -->
  <div class="card full-width" id="myloan">
    <div class="card-title">
      <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      Consultar mi pr√©stamo
    </div>
    <div style="display:grid;grid-template-columns:1fr auto;gap:12px;align-items:end;max-width:440px">
      <div class="field" style="margin-bottom:0"><label>Ingres√° tu DNI</label><input id="myDni" inputmode="numeric" placeholder="Ej: 30123456" /></div>
      <button id="btnFindMyLoan" class="btn-primary" style="width:auto;padding:13px 24px">Buscar</button>
    </div>
    <div id="myLoanResult"></div>
  </div>

  <!-- ADMIN -->
  <div class="card full-width" id="admin" style="display:none">
    <div class="card-title">
      <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      Panel de administraci√≥n
    </div>

    <details open>
      <summary>‚öôÔ∏è Configuraci√≥n del sistema</summary>
      <div class="details-body">
        <div class="input-row">
          <div class="field"><label>TNA %</label><input id="cfgTna" inputmode="numeric" class="mono" /></div>
          <div class="field"><label>D√≠a de vencimiento</label><input id="cfgDue" inputmode="numeric" /></div>
        </div>
        <div class="input-row">
          <div class="field"><label>Nombre de la App</label><input id="cfgAppName" placeholder="EstimaPres" /></div>
          <div class="field"><label>Ciudad de operaci√≥n</label><input id="cfgCity" placeholder="R√≠o Gallegos" /></div>
        </div>
        <button id="btnSaveCfg" class="btn-success" style="padding:12px 28px">Guardar configuraci√≥n</button>
      </div>
    </details>

    <details>
      <summary>üïê Solicitudes pendientes</summary>
      <div class="details-body">
        <div class="toolbar"><button id="btnReloadPend" class="btn-outline">‚Üª Recargar</button></div>
        <div id="listPend"><div class="empty">Cargando...</div></div>
      </div>
    </details>

    <details>
      <summary>üìã Preaprobados</summary>
      <div class="details-body">
        <div class="toolbar"><button id="btnReloadPre" class="btn-outline">‚Üª Recargar</button></div>
        <div id="listPre"><div class="empty">Sin preaprobados</div></div>
      </div>
    </details>

    <details open>
      <summary>üöÄ Cartera activa</summary>
      <div class="details-body">
        <div class="toolbar"><button id="btnReloadAct" class="btn-outline">‚Üª Recargar</button></div>
        <div id="listAct"><div class="empty">Sin activos</div></div>
      </div>
    </details>

    <details>
      <summary>üìÇ Hist√≥rico</summary>
      <div class="details-body">
        <div class="toolbar">
          <button id="btnTabPaid" class="btn-outline">Saldados</button>
          <button id="btnTabCharged" class="btn-danger">Incobrables</button>
          <button id="btnReloadInact" class="btn-outline">‚Üª Recargar</button>
        </div>
        <div id="listInact"><div class="empty">Sin registros</div></div>
      </div>
    </details>
  </div>

</main>

<!-- MODAL FIRMA T√ÅCTIL -->
<div class="modal-overlay" id="sigModal">
  <div class="modal-box">
    <div class="modal-title">‚úçÔ∏è Firma digital del contrato</div>
    <div class="modal-sub">Firm√° con el dedo en el recuadro. Esta firma tiene validez legal seg√∫n la <strong style="color:var(--sky)">Ley 25.506</strong> de Firma Digital de la Rep√∫blica Argentina.</div>
    <div class="sig-canvas-wrap">
      <canvas id="sigCanvas"></canvas>
    </div>
    <div class="sig-actions">
      <button id="btnClearSig" class="btn-outline">üóë Borrar</button>
      <button id="btnConfirmSig" class="btn-success" style="flex:2">‚úÖ Confirmar firma</button>
    </div>
    <button id="btnCancelSig" class="btn-outline" style="width:100%;margin-top:8px">Cancelar</button>
    <p class="modal-note">Al confirmar, declar√°s que la firma electr√≥nica realizada en este dispositivo tiene la misma validez jur√≠dica que la firma ol√≥grafa (Ley 25.506) y que acept√°s todas las cl√°usulas del contrato.</p>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
  authDomain: "estimapres.firebaseapp.com",
  projectId: "estimapres",
  storageBucket: "estimapres.firebasestorage.app",
  messagingSenderId: "578516597437",
  appId: "1:578516597437:web:f59994b87729aa1cd655d4"
};
const ADMIN_EMAIL = "fernandogastondelgado81@gmail.com";
const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

const $ = s => document.querySelector(s);
const fmtMoney   = n => isNaN(n) ? "$ 0" : "$ " + Number(n).toLocaleString("es-AR");
const onlyDigits = v => (v || "").replace(/\D+/g, "");
const nowTS = () => serverTimestamp();

function annuityPayment(P, rate, m) {
  const i = (rate / 100) / 12;
  if (i === 0) return P / m;
  return P * i * Math.pow(1+i, m) / (Math.pow(1+i, m) - 1);
}

function scheduleRows(L) {
  const due  = L.dueDay || 10;
  const base = L.activeAt?.toDate ? L.activeAt.toDate() : new Date();
  const inst = (L.installment && L.installment > 0)
    ? L.installment
    : Math.round(annuityPayment(L.amount, L.tna, L.months));
  const rows = [];
  for (let k = 1; k <= L.months; k++) {
    const d = new Date(base.getFullYear(), base.getMonth() + k, 1);
    d.setDate(Math.min(due, 28));
    rows.push({ n: k, due: d.toISOString().slice(0,10), amount: inst, paid: (L.paidCount||0) >= k });
  }
  return rows;
}

const daysLate = iso => Math.max(0, Math.floor((new Date() - new Date(iso)) / 86400000));

/* ===== Settings / Brand ===== */
let gSettings = { tna: null, dueDay: null, appName: "EstimaPres", city: "R√≠o Gallegos" };

async function loadSettings() {
  const snap = await getDoc(doc(db, "settings", "app"));
  if (snap.exists()) gSettings = { ...gSettings, ...snap.data() };
  const name = gSettings.appName || "EstimaPres";
  const mid  = Math.ceil(name.length / 2);
  $("#logoMark").textContent = name.replace(/\s/g,"").slice(0,2).toUpperCase();
  $("#logoName").innerHTML   = `${name.slice(0,mid)}<span>${name.slice(mid)}</span>`;
  document.title = name + " ¬∑ Pr√©stamos Personales";
  $("#lblTna").textContent  = (gSettings.tna ?? "‚Äî") + "%";
  $("#lblDue").textContent  = gSettings.dueDay ?? "‚Äî";
  $("#heroTna").innerHTML   = gSettings.tna    ? `${gSettings.tna}<span>%</span>`        : `‚Äî<span>%</span>`;
  $("#heroDue").innerHTML   = gSettings.dueDay ? `${gSettings.dueDay}<span>del mes</span>` : `‚Äî<span>del mes</span>`;
  $("#cfgTna").value     = gSettings.tna     ?? "";
  $("#cfgDue").value     = gSettings.dueDay  ?? "";
  $("#cfgAppName").value = gSettings.appName ?? "";
  $("#cfgCity").value    = gSettings.city    ?? "";
}

/* ===== Auth ===== */
onAuthStateChanged(auth, u => {
  $("#admin").style.display = (u && u.email === ADMIN_EMAIL) ? "" : "none";
  if (u && u.email === ADMIN_EMAIL) loadAllAdmin();
});
$("#btnAdmin").onclick = async () => {
  if (!auth.currentUser) {
    const email = prompt("Email de administrador:", ADMIN_EMAIL) || "";
    const pass  = prompt("Contrase√±a:") || "";
    try {
      const { user } = await signInWithEmailAndPassword(auth, email, pass);
      if (user.email !== ADMIN_EMAIL) { alert("Sin permisos."); await signOut(auth); return; }
      $("#admin").scrollIntoView({ behavior:"smooth" });
    } catch { alert("No se pudo iniciar sesi√≥n."); }
  } else { $("#admin").scrollIntoView({ behavior:"smooth" }); }
};
$("#btnLogout").onclick    = () => signOut(auth).catch(()=>{});
$("#btnOpenMyLoan").onclick = () => $("#myloan").scrollIntoView({ behavior:"smooth" });
$("#btnResetPass").onclick  = async () => {
  const email = prompt("Ingres√° tu email:");
  if (!email) return;
  try { await sendPasswordResetEmail(auth, email); alert("Email enviado."); }
  catch { alert("No se pudo enviar. Verific√° el correo."); }
};

/* ===== Simulador ===== */
$("#btnSim").onclick = () => {
  const P = Number(onlyDigits($("#simAmount").value));
  const m = Math.min(24, Number(onlyDigits($("#simMonths").value)));
  if (!gSettings.tna || !gSettings.dueDay) { alert("El administrador a√∫n no configur√≥ la TNA."); return; }
  if (!P || !m) { $("#simResult").innerHTML = ""; return; }
  const c = Math.round(annuityPayment(P, gSettings.tna, m));
  let rows = "";
  for (let i = 1; i <= m; i++) {
    const d = new Date(); d.setMonth(d.getMonth()+i); d.setDate(Math.min(gSettings.dueDay, 28));
    rows += `<div class="schedule-row"><span class="num">${String(i).padStart(2,"0")}</span><span class="date">${d.toLocaleDateString("es-AR")}</span><span class="amount">${fmtMoney(c)}</span><span><span class="pill warn">Pendiente</span></span></div>`;
  }
  $("#simResult").innerHTML = `<div class="sim-result-box"><div class="sim-cuota-display"><span class="label">Cuota estimada</span><span class="value">${fmtMoney(c)}</span></div><div class="schedule-wrap"><div class="schedule-header"><span>#</span><span>Vencimiento</span><span>Importe</span><span>Estado</span></div>${rows}</div></div>`;
};

/* ===== Solicitud ===== */
$("#btnSendReq").onclick = async () => {
  const amount = Number(onlyDigits($("#simAmount").value));
  const months = Math.min(24, Number(onlyDigits($("#simMonths").value)));
  if (!amount || !months) { alert("Complet√° el Simulador primero."); return; }
  const borrower = {
    name:  ($("#bName").value  || "").trim(),
    dni:   onlyDigits($("#bDni").value),
    email: ($("#bEmail").value || "").trim(),
    phone: ($("#bPhone").value || "").trim(),
    alias: ($("#bAlias").value || "").trim()
  };
  if (!borrower.name || !borrower.dni) { alert("Complet√° nombre y DNI."); return; }
  await addDoc(collection(db, "loans"), { status:"pending", amount, months, tna:gSettings.tna||0, dueDay:gSettings.dueDay||10, borrower, createdAt:nowTS(), updatedAt:nowTS() });
  alert("¬°Solicitud enviada! Te contactaremos pronto.");
};

/* ===== Render helpers ===== */
const STATUS_LABELS = { pending:"Pendiente", preapproved:"Preaprobado", active:"Activo", paid:"Saldado", charged_off:"Incobrable", deleted:"Eliminado" };
const STATUS_CLASS  = { active:"ok", paid:"ok", charged_off:"bad" };

function loanItem(d, actions="") {
  const b = d.borrower || {};
  return `<div class="loan-item">
    <div class="loan-name">${b.name||"‚Äî"}</div>
    <div class="loan-meta">
      <span>DNI <strong>${b.dni||"‚Äî"}</strong></span>
      <span>Capital <strong>${fmtMoney(d.amount)}</strong></span>
      <span><strong>${d.months}</strong> cuotas</span>
      <span>TNA <strong>${d.tna}%</strong></span>
      ${d.contractId ? `<span>Contrato <strong>${d.contractId}</strong></span>` : ""}
    </div>
    <div class="toolbar">${actions}</div>
  </div>`;
}

/* ===== Admin loaders ===== */
async function loadPend() {
  const box = $("#listPend"); box.innerHTML = "";
  try {
    const qs = await getDocs(query(collection(db,"loans"), where("status","==","pending"), orderBy("createdAt","desc"), limit(80)));
    if (qs.empty) { box.innerHTML=`<div class="empty">Sin solicitudes pendientes</div>`; return; }
    qs.forEach(docu => {
      const d = {...docu.data(), id:docu.id};
      box.insertAdjacentHTML("beforeend", loanItem(d,`<button class="btn-success" data-pre="${d.id}">Preaprobar</button><button class="btn-danger" data-del="${d.id}">Eliminar</button>`));
    });
    box.querySelectorAll("[data-pre]").forEach(btn => btn.onclick = async () => {
      if (!confirm("¬øPreaprobar?")) return;
      const contractId = Math.random().toString(36).slice(2,10).toUpperCase();
      await updateDoc(doc(db,"loans",btn.getAttribute("data-pre")), { status:"preapproved", contractId, updatedAt:nowTS() });
      await loadAllAdmin();
    });
    box.querySelectorAll("[data-del]").forEach(btn => btn.onclick = async () => {
      if (!confirm("¬øEliminar?")) return;
      await updateDoc(doc(db,"loans",btn.getAttribute("data-del")), { status:"deleted", updatedAt:nowTS() });
      await loadAllAdmin();
    });
  } catch { box.innerHTML=`<div class="empty">Error al cargar.</div>`; }
}

async function loadPre() {
  const box = $("#listPre"); box.innerHTML = "";
  try {
    const qs = await getDocs(query(collection(db,"loans"), where("status","==","preapproved"), orderBy("createdAt","desc"), limit(100)));
    if (qs.empty) { box.innerHTML=`<div class="empty">Sin preaprobados</div>`; return; }
    qs.forEach(docu => {
      const d = {...docu.data(), id:docu.id};
      const badge = d.signed ? `<span class="pill ok">Firmado</span>` : `<span class="pill warn">Esperando firma</span>`;
      const acts  = [
        `<button class="btn-outline" data-share="${d.id}">üì§ Compartir</button>`,
        d.signed ? `<button class="btn-success" data-approve="${d.id}">‚úÖ Activar</button>` : "",
        `<button class="btn-outline" data-open="${d.id}">üìÑ Ver contrato</button>`,
        `<button class="btn-danger" data-del="${d.id}">Eliminar</button>`
      ].join(" ");
      box.insertAdjacentHTML("beforeend", loanItem(d, badge+" "+acts));
    });
    box.querySelectorAll("[data-open]").forEach(b => b.onclick = async () => {
      const s = await getDoc(doc(db,"loans",b.getAttribute("data-open"))); if(!s.exists()) return;
      openContract({...s.data(), id:b.getAttribute("data-open")}, false);
    });
    box.querySelectorAll("[data-share]").forEach(b => b.onclick = async () => {
      const id=b.getAttribute("data-share"); const s=await getDoc(doc(db,"loans",id)); if(!s.exists()) return;
      const L={...s.data(),id};
      const link = location.origin+location.pathname+"#sign-"+id;
      const msg  = `Hola ${L.borrower?.name}, tu contrato ${gSettings.appName||"EstimaPres"} (${L.contractId}) est√° listo. Firmalo ac√°: ${link}`;
      if(navigator.share){try{await navigator.share({title:"Contrato",text:msg});}catch{}}
      else prompt("Copi√° el enlace:", link);
    });
    box.querySelectorAll("[data-approve]").forEach(b => b.onclick = async () => {
      const id=b.getAttribute("data-approve"); const s=await getDoc(doc(db,"loans",id)); if(!s.exists()) return;
      const L=s.data(); if(!L.signed){alert("Todav√≠a no est√° firmado.");return;}
      const installment=Math.round(annuityPayment(L.amount,L.tna,L.months));
      await updateDoc(doc(db,"loans",id),{status:"active",activeAt:nowTS(),updatedAt:nowTS(),installment,paidCount:0});
      await loadAllAdmin(); alert("Pr√©stamo activado.");
    });
    box.querySelectorAll("[data-del]").forEach(b => b.onclick = async () => {
      if(!confirm("¬øEliminar?")) return;
      await updateDoc(doc(db,"loans",b.getAttribute("data-del")),{status:"deleted",updatedAt:nowTS()});
      await loadAllAdmin();
    });
  } catch { box.innerHTML=`<div class="empty">Error al cargar.</div>`; }
}

async function loadAct() {
  const box = $("#listAct"); box.innerHTML = "";
  try {
    const qs = await getDocs(query(collection(db,"loans"), where("status","==","active"), orderBy("activeAt","desc"), limit(100)));
    if (qs.empty) { box.innerHTML=`<div class="empty">Sin activos</div>`; return; }
    qs.forEach(docu => {
      const d = {...docu.data(), id:docu.id};
      const allPaid = (d.paidCount||0) >= d.months;
      box.insertAdjacentHTML("beforeend",
        loanItem(d,`<button class="btn-outline" data-cuotas="${d.id}">Ver cuotas</button><button class="btn-success" data-paid="${d.id}" ${allPaid?"":"disabled"}>Cerrar saldado</button><button class="btn-danger" data-charge="${d.id}">A incobrables</button>`) +
        `<div id="sch-${d.id}"></div>`);
    });
    box.querySelectorAll("[data-cuotas]").forEach(b => b.onclick = async () => {
      const id=b.getAttribute("data-cuotas"); const schEl=$(`#sch-${id}`);
      if(schEl.innerHTML){schEl.innerHTML="";return;}
      const s=await getDoc(doc(db,"loans",id)); if(!s.exists()) return;
      const L={...s.data(),id};
      const rows=scheduleRows(L).map(r=>{
        const late=daysLate(r.due);
        const badge=r.paid?`<span class="pill ok">Pagada</span>`:late>10?`<span class="pill bad">Mora +10d</span>`:late>5?`<span class="pill warn">Mora</span>`:`<span class="pill warn">Pendiente</span>`;
        const btn=r.paid?"":`<button class="btn-outline" style="padding:5px 10px;font-size:11px" data-mark="${L.id}:${r.n}">‚úì Pagar</button>`;
        return `<div class="schedule-row"><span class="num">${String(r.n).padStart(2,"0")}</span><span class="date">${new Date(r.due).toLocaleDateString("es-AR")}</span><span class="amount">${fmtMoney(r.amount)}</span><span>${badge} ${btn}</span></div>`;
      }).join("");
      schEl.innerHTML=`<div class="schedule-wrap" style="margin-top:12px"><div class="schedule-header"><span>#</span><span>Vencimiento</span><span>Importe</span><span>Estado</span></div>${rows}</div>`;
      schEl.querySelectorAll("[data-mark]").forEach(btn=>btn.onclick=async()=>{
        const [loanId]=btn.getAttribute("data-mark").split(":");
        const s2=await getDoc(doc(db,"loans",loanId)); if(!s2.exists()) return;
        const L2=s2.data();
        await updateDoc(doc(db,"loans",loanId),{paidCount:Math.min((L2.paidCount||0)+1,L2.months),updatedAt:nowTS()});
        await loadAct();
      });
    });
    box.querySelectorAll("[data-paid]").forEach(b=>b.onclick=async()=>{
      const id=b.getAttribute("data-paid"); const s=await getDoc(doc(db,"loans",id)); if(!s.exists()) return;
      if((s.data().paidCount||0)<s.data().months){alert("Faltan cuotas.");return;}
      await updateDoc(doc(db,"loans",id),{status:"paid",updatedAt:nowTS()});
      await loadAllAdmin();
    });
    box.querySelectorAll("[data-charge]").forEach(b=>b.onclick=async()=>{
      if(!confirm("¬øMover a incobrables?")) return;
      await updateDoc(doc(db,"loans",b.getAttribute("data-charge")),{status:"charged_off",updatedAt:nowTS()});
      await loadAllAdmin();
    });
  } catch(e) { box.innerHTML=`<div class="empty">Error al cargar.</div>`; console.error(e); }
}

let inactTab = "paid";
async function loadInact() {
  const box = $("#listInact"); box.innerHTML="";
  try {
    const status = inactTab==="paid" ? "paid" : "charged_off";
    const qs = await getDocs(query(collection(db,"loans"), where("status","==",status), orderBy("updatedAt","desc"), limit(100)));
    if(qs.empty){box.innerHTML=`<div class="empty">Sin registros</div>`;return;}
    qs.forEach(docu=>{
      const d={...docu.data(),id:docu.id};
      let acts=`<button class="btn-outline" data-open="${d.id}">üìÑ Contrato</button>`;
      if(inactTab==="charged_off") acts+=` <button class="btn-danger" data-debt="${d.id}">üìã Certificado de deuda</button> <button class="btn-outline" data-share="${d.id}">üì§ Compartir</button>`;
      acts+=` <button class="btn-danger" data-del="${d.id}">üóë Eliminar</button>`;
      box.insertAdjacentHTML("beforeend",loanItem(d,acts));
    });
    box.querySelectorAll("[data-open]").forEach(b=>b.onclick=async()=>{
      const s=await getDoc(doc(db,"loans",b.getAttribute("data-open"))); if(!s.exists()) return;
      openContract({...s.data(),id:b.getAttribute("data-open")},false);
    });
    box.querySelectorAll("[data-debt]").forEach(b=>b.onclick=async()=>{
      const s=await getDoc(doc(db,"loans",b.getAttribute("data-debt"))); if(!s.exists()) return;
      openDebtCertificate({...s.data(),id:b.getAttribute("data-debt")});
    });
    box.querySelectorAll("[data-share]").forEach(b=>b.onclick=async()=>{
      const s=await getDoc(doc(db,"loans",b.getAttribute("data-share"))); if(!s.exists()) return;
      const L={...s.data(),id:b.getAttribute("data-share")};
      const msg=`Deuda en gesti√≥n - ${gSettings.appName||"EstimaPres"}\n${L.borrower?.name} DNI ${L.borrower?.dni}\nMonto: ${fmtMoney(L.amount)}\nContrato: ${L.contractId}`;
      if(navigator.share){try{await navigator.share({title:"Deuda",text:msg});}catch{}}
      else prompt("Copi√°:",msg);
    });
    box.querySelectorAll("[data-del]").forEach(b=>b.onclick=async()=>{
      if(!confirm("¬øEliminar definitivamente?")) return;
      await deleteDoc(doc(db,"loans",b.getAttribute("data-del")));
      await loadInact();
    });
  } catch { box.innerHTML=`<div class="empty">Error al cargar.</div>`; }
}

$("#btnTabPaid").onclick    = ()=>{ inactTab="paid";        loadInact(); };
$("#btnTabCharged").onclick = ()=>{ inactTab="charged_off"; loadInact(); };

async function loadAllAdmin() {
  await Promise.all([loadSettings(),loadPend(),loadPre(),loadAct(),loadInact()]);
}
$("#btnReloadPend").onclick  = loadPend;
$("#btnReloadPre").onclick   = loadPre;
$("#btnReloadAct").onclick   = loadAct;
$("#btnReloadInact").onclick = loadInact;

$("#btnSaveCfg").onclick = async () => {
  const tna  = Number(onlyDigits($("#cfgTna").value));
  const due  = Math.min(28, Math.max(1, Number(onlyDigits($("#cfgDue").value))));
  const name = ($("#cfgAppName").value||"EstimaPres").trim();
  const city = ($("#cfgCity").value||"R√≠o Gallegos").trim();
  await setDoc(doc(db,"settings","app"),{tna,dueDay:due,appName:name,city,updatedAt:nowTS()},{merge:true});
  await loadSettings(); alert("Configuraci√≥n guardada.");
};

/* ===== Mi Pr√©stamo ‚Äî b√∫squeda UNIVERSAL ===== */
$("#btnFindMyLoan").onclick = async () => {
  const dni = onlyDigits($("#myDni").value);
  if(!dni){$("#myLoanResult").innerHTML=`<div class="empty">Ingres√° un DNI.</div>`;return;}
  $("#myLoanResult").innerHTML=`<div class="empty">Buscando...</div>`;
  // Sin filtro de status: muestra cualquier estado
  const qs = await getDocs(query(collection(db,"loans"), orderBy("createdAt","desc"), limit(200)));
  const list=[];
  qs.forEach(d=>{ if((d.data().borrower?.dni||"")===dni) list.push({id:d.id,...d.data()}); });
  if(!list.length){$("#myLoanResult").innerHTML=`<div class="empty">No encontramos pr√©stamos para ese DNI.</div>`;return;}

  const L     = list[0];
  const paid  = Number(L.paidCount||0);
  const pct   = L.months ? Math.round((paid/L.months)*100) : 0;
  const sLabel= STATUS_LABELS[L.status]||L.status;
  const sClass= STATUS_CLASS[L.status]||"warn";

  const rows = scheduleRows(L).map(r=>
    `<div class="schedule-row"><span class="num">${String(r.n).padStart(2,"0")}</span><span class="date">${new Date(r.due).toLocaleDateString("es-AR")}</span><span class="amount">${fmtMoney(r.amount)}</span><span>${r.paid?`<span class="pill ok">Pagada</span>`:`<span class="pill warn">Pendiente</span>`}</span></div>`
  ).join("");

  let actionBtn="";
  if(L.contractId && L.status==="preapproved" && !L.signed){
    actionBtn=`<button id="btnPDF" class="btn-primary" style="width:auto;padding:12px 24px">‚úçÔ∏è Firmar contrato</button>`;
  } else if(L.contractId && L.status==="preapproved" && L.signed){
    actionBtn=`<span class="pill ok" style="padding:10px 16px;font-size:13px">‚úì Contrato firmado ¬∑ Aguardando aprobaci√≥n</span>`;
  } else if(L.contractId){
    actionBtn=`<button id="btnPDF" class="btn-secondary">üìÑ Ver contrato PDF</button>`;
  }

  $("#myLoanResult").innerHTML=`
    <div class="myloan-status">
      <div class="myloan-status-left">
        <div class="name">${L.borrower?.name||"‚Äî"}</div>
        <div class="meta">${fmtMoney(L.amount)} ¬∑ ${L.months} cuotas ¬∑ TNA ${L.tna}%</div>
      </div>
      <span class="pill ${sClass}">${sLabel}</span>
    </div>
    <div style="margin-bottom:20px">
      <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px">
        <span>Progreso de pago</span>
        <span style="color:var(--sky);font-weight:700">${paid}/${L.months} cuotas</span>
      </div>
      <div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:${pct}%"></div></div>
    </div>
    ${actionBtn?`<div style="margin-bottom:16px">${actionBtn}</div>`:""}
    <div class="schedule-wrap">
      <div class="schedule-header"><span>#</span><span>Vencimiento</span><span>Importe</span><span>Estado</span></div>
      ${rows}
    </div>`;

  const pdfBtn=document.getElementById("btnPDF");
  if(pdfBtn){
    pdfBtn.addEventListener("click",()=>{
      if(L.status==="preapproved"&&!L.signed) openSignModal(L);
      else openContract(L,false);
    });
  }
};

/* ===== Modal firma t√°ctil ===== */
let gSignLoan=null;

function openSignModal(L){
  gSignLoan=L;
  const modal=$("#sigModal"); modal.classList.add("open");
  const canvas=$("#sigCanvas");
  const wrap=canvas.parentElement;
  canvas.width=wrap.clientWidth||380; canvas.height=180;
  const ctx=canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle="#60a5fa"; ctx.lineWidth=2.5; ctx.lineCap="round"; ctx.lineJoin="round";
  let drawing=false;
  function getPos(e){ const rect=canvas.getBoundingClientRect(); const src=e.touches?e.touches[0]:e; return{x:src.clientX-rect.left,y:src.clientY-rect.top}; }
  function onStart(e){ e.preventDefault(); drawing=true; const p=getPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); }
  function onMove(e){ e.preventDefault(); if(!drawing) return; const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); }
  function onEnd(e){ e.preventDefault(); drawing=false; }
  canvas.onmousedown=onStart; canvas.onmousemove=onMove; canvas.onmouseup=onEnd; canvas.onmouseleave=onEnd;
  canvas.ontouchstart=onStart; canvas.ontouchmove=onMove; canvas.ontouchend=onEnd;
  $("#btnClearSig").onclick=()=>ctx.clearRect(0,0,canvas.width,canvas.height);
}

function closeSignModal(){ $("#sigModal").classList.remove("open"); gSignLoan=null; }
$("#btnCancelSig").onclick=closeSignModal;

$("#btnConfirmSig").onclick=async()=>{
  const canvas=$("#sigCanvas");
  const ctx=canvas.getContext("2d");
  const px=ctx.getImageData(0,0,canvas.width,canvas.height).data;
  const hasDrawing=Array.from(px).some((v,i)=>i%4===3&&v>0);
  if(!hasDrawing){alert("Por favor firm√° en el recuadro antes de confirmar.");return;}
  const sigImg=canvas.toDataURL("image/png");
  const L=gSignLoan; if(!L) return;
  try{
    await updateDoc(doc(db,"loans",L.id),{signed:true,signedAt:nowTS(),updatedAt:nowTS(),signatureImg:sigImg});
    closeSignModal();
    alert("¬°Firma registrada! El administrador aprobar√° tu pr√©stamo en breve.");
    $("#btnFindMyLoan").click();
  } catch(e){alert("No se pudo guardar. Intent√° de nuevo.");console.error(e);}
};

/* ===== Contrato legal s√≥lido ===== */
function contractHtml(L){
  const today  =new Date().toLocaleDateString("es-AR");
  const appName=gSettings.appName||"EstimaPres";
  const city   =gSettings.city||"R√≠o Gallegos";
  const inst   =(L.installment&&L.installment>0)?L.installment:Math.round(annuityPayment(L.amount,L.tna,L.months));
  const rows=scheduleRows(L).map(r=>`<tr><td style="text-align:center">${r.n}</td><td>${new Date(r.due).toLocaleDateString("es-AR")}</td><td style="text-align:right">${fmtMoney(r.amount)}</td><td style="text-align:center">${r.paid?"‚úì Pagada":"Pendiente"}</td></tr>`).join("");
  const sigImg=L.signatureImg?`<div style="border:1px solid #ccc;border-radius:8px;padding:8px;max-width:280px;margin-top:8px"><img src="${L.signatureImg}" style="width:100%;max-height:70px;object-fit:contain"/><div style="font-size:9pt;color:#555;margin-top:4px">Firma electr√≥nica ‚Äî Ley 25.506</div></div>`:`<div style="border-bottom:1px solid #333;width:200px;margin-top:30px;margin-bottom:4px"></div><div style="font-size:9pt;color:#888">Pendiente de firma</div>`;
  return`<!DOCTYPE html><html lang="es"><head><meta charset="utf-8"><title>Contrato ${L.contractId||""} ¬∑ ${appName}</title>
<style>@page{size:A4;margin:25mm 20mm}body{font-family:'Times New Roman',serif;color:#111;font-size:11pt;line-height:1.6}h1{font-size:15pt;text-align:center;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}h2{font-size:11pt;text-transform:uppercase;border-bottom:1px solid #ccc;padding-bottom:3px;margin:18px 0 8px}p{margin-bottom:8px}.parties{background:#f8f8f8;border:1px solid #ddd;padding:12px;margin:12px 0;border-radius:4px}ol{padding-left:20px}ol li{margin-bottom:10px}table{width:100%;border-collapse:collapse;font-size:10pt;margin-top:8px}th{background:#1a56db;color:#fff;padding:8px;text-align:left}td{border:1px solid #ddd;padding:7px 8px}tr:nth-child(even){background:#f5f8ff}.sign-block{display:flex;gap:60px;margin-top:30px}</style>
</head><body>
<h1>Contrato de Pr√©stamo Personal</h1>
<p style="text-align:center;color:#555;margin-bottom:20px">${appName} ¬∑ Contrato N¬∞ <strong>${L.contractId||"‚Äî"}</strong> ¬∑ Fecha: <strong>${today}</strong></p>
<div class="parties"><strong>PRESTAMISTA:</strong> ${appName}, domicilio en ${city}, Provincia de Santa Cruz, Rep√∫blica Argentina.<br><strong>PRESTATARIO:</strong> ${L.borrower?.name||"‚Äî"}, DNI ${L.borrower?.dni||"‚Äî"}, Email: ${L.borrower?.email||"‚Äî"}, Tel: ${L.borrower?.phone||"‚Äî"}.</div>
<h2>CL√ÅUSULAS</h2><ol>
<li><strong>Objeto:</strong> El PRESTAMISTA otorga al PRESTATARIO un pr√©stamo personal de <strong>${fmtMoney(L.amount)}</strong> de libre disponibilidad, transferido al alias/CBU informado por el PRESTATARIO.</li>
<li><strong>Plazo y amortizaci√≥n:</strong> El pr√©stamo ser√° devuelto en <strong>${L.months}</strong> cuotas mensuales calculadas bajo el sistema franc√©s, con vencimiento el d√≠a <strong>${L.dueDay}</strong> de cada mes. Cuota: <strong>${fmtMoney(inst)}</strong>.</li>
<li><strong>Tasa de inter√©s:</strong> TNA de <strong>${L.tna}%</strong> (tasa mensual: ${((L.tna/12).toFixed(4))}%).</li>
<li><strong>Mora autom√°tica:</strong> La mora operar√° de pleno derecho, autom√°ticamente y sin necesidad de interpelaci√≥n judicial ni extrajudicial alguna, por el solo vencimiento de los plazos (art. 509 CCyCN). Desde la fecha de vencimiento, el saldo adeudado devengar√° intereses punitorios equivalentes al doble de la tasa pactada.</li>
<li><strong>T√≠tulo ejecutivo:</strong> El presente contrato, junto con el saldo certificado por el PRESTAMISTA, constituye t√≠tulo ejecutivo h√°bil para el cobro judicial por v√≠a del proceso ejecutivo (arts. 520 y cc. CPCCN), sin necesidad de reconocimiento previo de firma.</li>
<li><strong>Autorizaci√≥n de ejecuci√≥n:</strong> El PRESTATARIO autoriza expresamente al PRESTAMISTA a iniciar las acciones judiciales y/o extrajudiciales que correspondan ante el incumplimiento, incluyendo el reporte a centrales de riesgo crediticio.</li>
<li><strong>Firma digital ‚Äî Ley 25.506:</strong> El PRESTATARIO declara expresamente que la firma electr√≥nica realizada mediante dispositivo t√°ctil en la plataforma ${appName} tiene plena validez jur√≠dica conforme a la Ley 25.506 de Firma Digital y sus normas reglamentarias, equivaliendo a la firma ol√≥grafa a todos los efectos legales. El PRESTATARIO declara haber le√≠do y comprendido la totalidad del presente contrato, prestando su consentimiento libre e informado.</li>
<li><strong>Datos personales:</strong> El PRESTATARIO consiente el tratamiento de sus datos conforme Ley 25.326 de Protecci√≥n de Datos Personales.</li>
<li><strong>Jurisdicci√≥n:</strong> Las partes se someten a los Tribunales Ordinarios de ${city}, Provincia de Santa Cruz, con renuncia a cualquier otro fuero.</li>
</ol>
<h2>CALENDARIO DE PAGOS</h2>
<table><thead><tr><th>#</th><th>Vencimiento</th><th>Importe</th><th>Estado</th></tr></thead><tbody>${rows}</tbody></table>
<h2>FIRMAS</h2>
<div class="sign-block">
  <div><div style="border-bottom:1px solid #333;width:200px;margin-top:30px;margin-bottom:4px"></div><div style="font-size:9pt"><strong>PRESTAMISTA</strong><br>${appName}<br>${city}</div></div>
  <div>${sigImg}<div style="font-size:9pt;margin-top:4px"><strong>PRESTATARIO</strong><br>${L.borrower?.name}<br>DNI: ${L.borrower?.dni}</div></div>
</div>
<p style="margin-top:24px;font-size:9pt;color:#888;text-align:center">Documento generado por ${appName} ¬∑ ${today} ¬∑ V√°lido conforme Ley 25.506</p>
</body></html>`;
}

function openContract(L){ const w=window.open("about:blank","_blank"); w.document.open(); w.document.write(contractHtml(L)); w.document.close(); }

/* ===== Certificado de Deuda Exigible ===== */
function openDebtCertificate(L){
  const today  =new Date().toLocaleDateString("es-AR");
  const appName=gSettings.appName||"EstimaPres";
  const city   =gSettings.city||"R√≠o Gallegos";
  const late   =scheduleRows(L).filter(r=>!r.paid);
  const capital=late.reduce((a,r)=>a+Number(r.amount||0),0);
  const diasMora=late.length>0?daysLate(late[0].due):0;
  const tasaMensual=(L.tna/100)/12;
  const tasaPunit  =tasaMensual*2;
  const intereses  =Math.round(capital*tasaPunit*(diasMora/30));
  const total      =capital+intereses;
  let rowsHtml="";
  late.forEach(r=>{rowsHtml+=`<tr><td style="text-align:center">${r.n}</td><td>${new Date(r.due).toLocaleDateString("es-AR")}</td><td style="text-align:right">${fmtMoney(r.amount)}</td><td style="text-align:center">${daysLate(r.due)} d√≠as</td></tr>`;});
  const html=`<!DOCTYPE html><html lang="es"><head><meta charset="utf-8"><title>Certificado de Deuda ¬∑ ${L.contractId||""}</title>
<style>@page{size:A4;margin:25mm 20mm}body{font-family:'Times New Roman',serif;color:#111;font-size:11pt;line-height:1.6}h1{font-size:15pt;text-align:center;text-transform:uppercase}h2{font-size:11pt;text-transform:uppercase;border-bottom:1px solid #ccc;padding-bottom:3px;margin:16px 0 8px}.alert{background:#fff0f0;border:2px solid #c00;border-radius:4px;padding:12px;margin:14px 0;color:#900;font-weight:bold;text-align:center;font-size:12pt}table{width:100%;border-collapse:collapse;font-size:10pt;margin-top:8px}th{background:#8b0000;color:#fff;padding:8px;text-align:left}td{border:1px solid #ddd;padding:7px 8px}tr:nth-child(even){background:#fff5f5}.total-row td{font-weight:bold;font-size:13pt;color:#8b0000;border-top:2px solid #8b0000}</style>
</head><body>
<h1>Certificado de Deuda Exigible</h1>
<p style="text-align:center;color:#555;margin-bottom:16px">${appName} ¬∑ Emitido el <strong>${today}</strong></p>
<div class="alert">‚ö† DOCUMENTO LEGAL ‚Äî APTO PARA GESTI√ìN JUDICIAL O EXTRAJUDICIAL DE COBRO</div>
<h2>Datos del deudor</h2>
<table><tbody>
<tr><td><strong>Apellido y Nombre</strong></td><td>${L.borrower?.name||"‚Äî"}</td></tr>
<tr><td><strong>DNI</strong></td><td>${L.borrower?.dni||"‚Äî"}</td></tr>
<tr><td><strong>Email</strong></td><td>${L.borrower?.email||"‚Äî"}</td></tr>
<tr><td><strong>Tel√©fono</strong></td><td>${L.borrower?.phone||"‚Äî"}</td></tr>
<tr><td><strong>N¬∞ de Contrato</strong></td><td>${L.contractId||"‚Äî"}</td></tr>
</tbody></table>
<h2>Condiciones del pr√©stamo</h2>
<table><tbody>
<tr><td><strong>Capital otorgado</strong></td><td>${fmtMoney(L.amount)}</td></tr>
<tr><td><strong>Plazo</strong></td><td>${L.months} cuotas</td></tr>
<tr><td><strong>TNA pactada</strong></td><td>${L.tna}%</td></tr>
<tr><td><strong>Cuotas abonadas</strong></td><td>${L.paidCount||0} de ${L.months}</td></tr>
<tr><td><strong>Cuotas impagas</strong></td><td><strong style="color:#c00">${late.length}</strong></td></tr>
</tbody></table>
<h2>Cuotas impagas en mora</h2>
<table><thead><tr><th>#</th><th>Vencimiento</th><th>Capital de cuota</th><th>D√≠as en mora</th></tr></thead><tbody>${rowsHtml}</tbody></table>
<h2>Liquidaci√≥n de deuda exigible</h2>
<table><tbody>
<tr><td>Capital adeudado</td><td style="text-align:right">${fmtMoney(capital)}</td></tr>
<tr><td>Tasa punitoria (doble TNA = ${(tasaPunit*12*100).toFixed(1)}% anual) ¬∑ ${diasMora} d√≠as</td><td style="text-align:right">${fmtMoney(intereses)}</td></tr>
<tr class="total-row"><td>TOTAL EXIGIBLE AL ${today}</td><td style="text-align:right">${fmtMoney(total)}</td></tr>
</tbody></table>
<p style="font-size:10pt;color:#555;margin-top:8px">* Intereses calculados a tasa punitoria conforme cl√°usula de mora del contrato y art. 509 CCyCN. El total se incrementa diariamente hasta cancelaci√≥n.</p>
<h2>Fundamento legal</h2>
<p style="font-size:10pt">El Contrato N¬∞ <strong>${L.contractId||"‚Äî"}</strong> constituye t√≠tulo ejecutivo (arts. 520 y cc. CPCCN). La mora oper√≥ de pleno derecho (art. 509 CCyCN). Firma digital v√°lida conforme Ley 25.506.</p>
<div style="border-bottom:1px solid #333;width:200px;margin-top:40px;margin-bottom:6px"></div>
<p style="font-size:10pt"><strong>${appName}</strong> ‚Äî Acreedor ¬∑ ${city}, Santa Cruz, Argentina</p>
<p style="margin-top:30px;font-size:9pt;color:#888;text-align:center">Emitido por ${appName} ¬∑ ${today} ¬∑ Uso legal y gesti√≥n de cobro</p>
</body></html>`;
  const w=window.open("about:blank","_blank"); w.document.open(); w.document.write(html); w.document.close();
}

/* ===== Hash firma desde enlace ===== */
(async function trySignFromHash(){
  if(!location.hash.startsWith("#sign-")) return;
  const id=location.hash.replace("#sign-","").trim();
  const snap=await getDoc(doc(db,"loans",id)); if(!snap.exists()) return;
  const L={...snap.data(),id};
  $("#myDni").value=L.borrower?.dni||"";
  $("#myloan").scrollIntoView({behavior:"smooth"});
  await new Promise(r=>setTimeout(r,600));
  $("#btnFindMyLoan").click();
})();

/* ===== Input formatters ===== */
$("#simAmount").addEventListener("input",e=>{ const n=onlyDigits(e.target.value); e.target.value=n?"$ "+Number(n).toLocaleString("es-AR"):""; });
$("#simMonths").addEventListener("input",e=>{ const n=Math.min(24,Number(onlyDigits(e.target.value)||"")); e.target.value=n?n:""; });
$("#cfgTna").addEventListener("input",e=>e.target.value=onlyDigits(e.target.value));
$("#cfgDue").addEventListener("input",e=>e.target.value=onlyDigits(e.target.value));

/* ===== Init ===== */
await loadSettings();
await loadInact();
</script>
</body>
</html>