<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EstimaPres · Préstamos en ARS</title>
  <meta name="theme-color" content="#0b5ed7" />
  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--ink:#0b1220;--muted:#5b6575;
      --brand:#0b5ed7;--brand-ink:#fff;--ok:#16a34a;--warn:#f59e0b;--bad:#ef4444;
      --ring:rgba(11,94,215,.25);--radius:14px;
    }
    *{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol",sans-serif}
    a{color:var(--brand);text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .nav{position:sticky;top:0;z-index:20;background:#0b5ed7;color:#fff}
    .nav .wrap{display:flex;align-items:center;gap:12px;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .brand .logo{width:32px;height:32px;border-radius:50%;background:#fff1;border:2px solid #fff4;display:grid;place-items:center;font-weight:800}
    .nav .sp{flex:1}
    .btn{appearance:none;border:none;border-radius:999px;padding:10px 16px;font-weight:700;cursor:pointer;transition:.15s;box-shadow:inset 0 -2px 0 #0001}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.ghost{background:#fff2;color:#fff}
    .btn.danger{background:var(--bad);color:#fff}
    .btn.ok{background:var(--ok);color:#fff}
    .btn.warn{background:var(--warn);color:#111}
    .grid{display:grid;gap:16px}
    .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 6px 20px #0000000f}
    h1,h2,h3{margin:0 0 10px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1 1 240px}
    input,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #d9deea;background:#fff;font-size:16px;outline:none}
    input:focus{border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#1e3a8a;font-weight:700}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #eef0f4;text-align:left}
    .table th{font-size:12px;text-transform:uppercase;letter-spacing:.06em;color:#64748b}
    details{border-radius:12px;background:#f8fafc;padding:10px}
    details>summary{cursor:pointer;font-weight:700}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Roboto Mono",monospace;background:#1111;border-radius:6px;padding:2px 6px}
    .hidden{display:none!important}
    .tag{display:inline-block;border-radius:999px;padding:4px 8px;font-size:12px;font-weight:700}
    .tag.ok{background:#dcfce7;color:#166534}
    .tag.warn{background:#fef9c3;color:#854d0e}
    .tag.bad{background:#fee2e2;color:#7f1d1d}
  </style>
</head>
<body>
  <header class="nav">
    <div class="wrap">
      <div class="brand"><div class="logo">E</div> EstimaPres</div>
      <div class="sp"></div>
      <button id="btnMyLoan" class="btn ghost">Ver mi préstamo</button>
      <button id="btnAdmin" class="btn ghost">Admin</button>
      <button id="btnLogout" class="btn danger hidden">Salir</button>
    </div>
  </header>

  <main class="wrap grid" style="padding-top:18px">
    <!-- SIMULADOR -->
    <section class="card">
      <h1>Simulador (pesos argentinos)</h1>
      <div class="row">
        <input id="simAmount" type="number" min="10000" step="1000" placeholder="Ej: 200000" />
        <input id="simMonths" type="number" min="1" max="36" placeholder="Ej: 12" />
      </div>
      <p class="muted">
        TNA vigente: <b id="lblTna">—%</b> · Vencimiento: día <b id="lblDue">10</b>
      </p>
      <div class="row">
        <button id="btnSimular" class="btn ok" style="max-width:160px">Simular</button>
      </div>
      <div id="simOut" class="muted" style="margin-top:8px">—</div>
      <details id="detSchedule" class="hidden" style="margin-top:10px">
        <summary>Ver detalle de cuotas</summary>
        <table class="table" id="tblSchedule">
          <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Saldo</th></tr></thead>
          <tbody></tbody>
        </table>
      </details>
    </section>

    <!-- SOLICITAR -->
    <section class="card">
      <h2>Solicitar préstamo</h2>
      <div class="row">
        <input id="rqName" placeholder="Tu nombre" />
        <input id="rqDni" inputmode="numeric" placeholder="DNI" />
      </div>
      <div class="row">
        <input id="rqEmail" type="email" placeholder="tucorreo@dominio.com" />
        <input id="rqPhone" inputmode="tel" placeholder="11 2345 6789" />
      </div>
      <input id="rqCbu" placeholder="alias o CBU/CVU" />
      <div class="row" style="margin-top:12px">
        <button id="btnRequest" class="btn primary" style="max-width:220px">Enviar solicitud</button>
      </div>
      <small class="muted">Al enviar aceptás ser contactado por EstimaPres.</small>
    </section>

    <!-- PANEL ADMIN -->
    <section class="card hidden" id="adminPanel">
      <h1>Panel de administrador</h1>

      <h3 style="margin-top:8px;">1) Tasa (TNA %)</h3>
      <div class="row">
        <input id="admTna" type="number" min="1" max="999" />
        <button id="btnSaveTna" class="btn primary" style="max-width:160px">Guardar</button>
      </div>

      <h3 style="margin-top:22px;">2) Solicitudes pendientes</h3>
      <button id="btnReloadPending" class="btn ghost" style="max-width:160px">Recargar</button>
      <div id="pendingBox" class="muted" style="margin-top:10px">—</div>

      <h3 style="margin-top:22px;">3) Preaprobados</h3>
      <button id="btnReloadPre" class="btn ghost" style="max-width:160px">Recargar</button>
      <div id="preBox" class="muted" style="margin-top:10px">—</div>

      <h3 style="margin-top:22px;">4) Préstamos activos</h3>
      <button id="btnReloadActive" class="btn ghost" style="max-width:160px">Recargar</button>
      <div class="muted" style="margin:8px 0">Verde: al día · Amarillo: 6–10 días de mora · Rojo: &gt;10 días</div>
      <div id="activeBox" class="muted">—</div>
    </section>
  </main>

  <!-- MODAL LOGIN ADMIN -->
  <dialog id="dlgLogin" style="border:none;border-radius:16px;max-width:380px;width:calc(100% - 32px);padding:18px;box-shadow:0 20px 80px #0003">
    <form method="dialog">
      <h3 style="margin:0 0 12px">Ingresar como administrador</h3>
      <input id="lgEmail" type="email" placeholder="admin@tuempresa.com" style="margin-bottom:10px" />
      <input id="lgPass" type="password" placeholder="Contraseña" />
      <div class="row" style="margin-top:12px">
        <button id="btnDoLogin" class="btn primary">Ingresar</button>
        <button id="btnCloseLogin" class="btn">Cancelar</button>
      </div>
      <small class="muted">Solo emails listados en <span class="kbd">/admins/admins.emails</span>.</small>
    </form>
  </dialog>

  <!-- Firebase + App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp,
      collection, addDoc, getDocs, orderBy, query, limit
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // === 0) Helpers UI =======================================================
    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs={}, ...kids) => {
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if(k==="class") n.className=v;
        else if(k==="dataset") Object.assign(n.dataset, v);
        else n.setAttribute(k,v);
      });
      kids.forEach(k=> n.append(k));
      return n;
    };
    const money = n => n.toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

    function toast(msg){ alert(msg); }

    // === 1) Firebase init ====================================================
    const firebaseConfig = {
      apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
      authDomain: "estimapres.firebaseapp.com",
      projectId: "estimapres",
      storageBucket: "estimapres.firebasestorage.app",
      messagingSenderId: "578516597437",
      appId: "1:578516597437:web:f59994b87729aa1cd655d4"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // === 2) Estado global ====================================================
    let STATE = {
      tna: null,
      dueDay: 10,
      user: null,
      isAdmin: false
    };

    // === 3) Auth Admin =======================================================
    async function checkIsAdmin(user){
      if(!user) return false;
      try {
        const snap = await getDoc(doc(db,"admins","admins"));
        const arr = snap.exists() ? (snap.data().emails||[]) : [];
        return arr.includes(user.email);
      } catch(e){ console.error(e); return false; }
    }

    $("#btnAdmin").onclick = ()=> $("#dlgLogin").showModal();
    $("#btnCloseLogin").onclick = (ev)=> { ev.preventDefault(); $("#dlgLogin").close(); };
    $("#btnDoLogin").onclick = async (ev)=>{
      ev.preventDefault();
      try{
        const email=$("#lgEmail").value.trim(); const pass=$("#lgPass").value;
        const c = await signInWithEmailAndPassword(auth,email,pass);
        $("#dlgLogin").close();
      }catch(e){ console.error(e); toast("No se pudo iniciar sesión: "+(e.code||e.message)); }
    };
    $("#btnLogout").onclick = async ()=>{
      try{ await signOut(auth); }catch(e){/* ignore */}
    };

    onAuthStateChanged(auth, async (user)=>{
      STATE.user = user||null;
      STATE.isAdmin = await checkIsAdmin(user);
      $("#btnLogout").classList.toggle("hidden", !user);
      if(STATE.isAdmin){
        $("#adminPanel").classList.remove("hidden");
        await syncTna();
      }else{
        $("#adminPanel").classList.add("hidden");
      }
    });

    // === 4) Config (TNA en /settings/global) ================================
    async function syncTna(){
      try{
        const snap = await getDoc(doc(db,"settings","global"));
        const tna = snap.exists() ? (Number(snap.data().tna)||0) : 0;
        STATE.tna = tna>0 ? tna : 100;
        $("#lblTna").textContent = STATE.tna.toFixed(0)+"%";
        $("#admTna").value = STATE.tna;
      }catch(e){
        console.error(e);
        STATE.tna = 100;
        $("#lblTna").textContent = "100%";
      }
    }
    $("#btnSaveTna").onclick = async ()=>{
      if(!STATE.isAdmin){ toast("Solo admin."); return; }
      try{
        const t = Number($("#admTna").value||0);
        if(!t || t<1) throw new Error("TNA inválida");
        await setDoc(doc(db,"settings","global"), { tna: t, updatedAt: serverTimestamp() }, { merge:true });
        await syncTna();
        toast("TNA guardada.");
      }catch(e){ console.error(e); toast("No se pudo guardar TNA."); }
    };

    // Sincronizar TNA al cargar para el simulador (aunque no sea admin)
    syncTna();

    // === 5) Simulador ========================================================
    function cuota(P, tna, n){
      const i = (tna/100)/12;
      if(!i) return 0;
      return Math.round(P * i / (1 - Math.pow(1+i, -n)));
    }
    function buildSchedule(P, tna, n, startDay){
      const q = cuota(P,tna,n);
      let saldo = P;
      const rows=[];
      const today = new Date();
      const baseDay = startDay || STATE.dueDay || 10;
      for(let k=1;k<=n;k++){
        const inter = Math.round(saldo*(tna/100)/12);
        const amort = q - inter;
        saldo = Math.max(0, saldo - amort);
        const d = new Date(today.getFullYear(), today.getMonth()+k, 1);
        // set due date
        const due = new Date(d.getFullYear(), d.getMonth(), Math.min(baseDay, new Date(d.getFullYear(), d.getMonth()+1, 0).getDate()));
        rows.push({k, due, q, saldo});
      }
      return rows;
    }

    $("#btnSimular").onclick = ()=>{
      const P = Number($("#simAmount").value||0);
      const n = Number($("#simMonths").value||0);
      if(P<=0 || n<=0){ toast("Completá monto y meses"); return; }
      const c = cuota(P, STATE.tna, n);
      const tot = c*n;
      $("#simOut").innerHTML = `Cuota: <b>${money(c)}</b> · Total: <b>${money(tot)}</b><br/><span class="muted">La tasa se fija al aprobar.</span>`;
      // Detalle
      const rows = buildSchedule(P, STATE.tna, n, STATE.dueDay);
      const tbody = $("#tblSchedule tbody");
      tbody.innerHTML = "";
      rows.forEach(r=>{
        const tr = el("tr",{},
          el("td",{}, r.k),
          el("td",{}, r.due.toLocaleDateString("es-AR")),
          el("td",{}, money(r.q)),
          el("td",{}, money(r.saldo))
        );
        tbody.append(tr);
      });
      $("#detSchedule").classList.remove("hidden");
    };

    // === 6) Solicitud de préstamo ===========================================
    $("#btnRequest").onclick = async ()=>{
      try{
        const name = $("#rqName").value.trim();
        const dni  = $("#rqDni").value.trim();
        const email= $("#rqEmail").value.trim();
        const phone= $("#rqPhone").value.trim();
        const cbu  = $("#rqCbu").value.trim();
        const P    = Number($("#simAmount").value||0);
        const n    = Number($("#simMonths").value||0);
        if(!name||!dni||!email||!phone||!cbu||!P||!n){ toast("Completá todos los campos y la simulación."); return; }
        await addDoc(collection(db,"loan_requests"),{
          amount:P, months:n, tna: STATE.tna, createdAt: serverTimestamp(), status:"pending",
          borrower:{ name, dni, email, phone, cbu }
        });
        toast("Solicitud enviada. Un administrador la revisará en 48 h.");
        // Limpio campos
        ["rqName","rqDni","rqEmail","rqPhone","rqCbu"].forEach(id=>$( "#"+id ).value="");
      }catch(e){ console.error(e); toast("No se pudo enviar la solicitud."); }
    };

    // === 7) Admin: Pending / Pre / Active ===================================
    function cardRequest(r,id){
      const b = el("div",{class:"card"}, 
        el("div",{}, el("span",{class:"tag warn"},"PENDIENTE")),
        el("h3",{}, `${r.borrower?.name||"-"} · DNI ${r.borrower?.dni||"-"}`),
        el("div",{class:"muted"}, `${r.borrower?.email||""} · ${r.borrower?.phone||""}`),
        el("p",{}, `Importe: ${money(r.amount)} · Plazo: ${r.months} meses · TNA: ${r.tna}%`),
        el("div",{class:"row"},
          el("button",{class:"btn ok",dataset:{id}}, "Preaprobar"),
          el("button",{class:"btn danger",dataset:{id,act:"rej"}}, "Rechazar")
        )
      );
      return b;
    }
    function cardPre(l,id){
      return el("div",{class:"card"}, 
        el("div",{}, el("span",{class:"tag"},"PREAPROBADO")),
        el("h3",{}, `${l.borrower?.name||"-"} · DNI ${l.borrower?.dni||"-"}`),
        el("p",{}, `Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%`),
        el("div",{class:"row"},
          el("button",{class:"btn ok",dataset:{id,act:"activate"}},"Aprobar"),
          el("button",{class:"btn",dataset:{id,act:"contract"}}, "Contrato (PDF)"),
          el("button",{class:"btn danger",dataset:{id,act:"del"}}, "Eliminar")
        )
      );
    }
    function cardActive(l,id){
      const nextColor = (()=>{ // semáforo por días de atraso
        const today = new Date();
        const dd = l.dueDay||STATE.dueDay||10;
        const next = new Date(today.getFullYear(), today.getMonth(), dd);
        if(today.getDate()>dd) next.setMonth(today.getMonth()+1);
        const diff = Math.floor((today-next)/(1000*60*60*24));
        if(diff<=0) return "ok";
        if(diff<=10) return "warn";
        return "bad";
      })();
      const tag = el("span",{class:"tag "+nextColor}, nextColor==="ok"?"Al día":nextColor==="warn"?"Mora 6–10":"Mora >10");
      const box = el("div",{class:"card"},
        el("div",{}, tag),
        el("h3",{}, `${l.borrower?.name||"-"} · DNI ${l.borrower?.dni||"-"}`),
        el("div",{class:"muted"}, `Estado: ${l.status}`),
        el("p",{}, `Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%`),
        el("div",{class:"row"},
          el("button",{class:"btn",dataset:{id,act:"ver"}}, "Ver"),
          el("button",{class:"btn warn",dataset:{id,act:"inc"}}, "A incobrables"),
          el("button",{class:"btn ok",dataset:{id,act:"fin"}}, "Finalizar")
        ),
        el("div",{id:"det-"+id,class:"hidden"},
          (()=>{ // tabla simple de cuotas
            const q = cuota(l.amount,l.tna,l.months);
            const paid = Number(l.paidCount||0);
            const wrap = el("div");
            const table = el("table",{class:"table"});
            table.append(el("thead",{}, el("tr",{}, el("th",{},"#"),el("th",{},"Vencimiento"),el("th",{},"Cuota"),el("th",{},"Estado"))));
            const tb = el("tbody");
            for(let i=1;i<=l.months;i++){
              const due = new Date(new Date().getFullYear(), new Date().getMonth()+i, (l.dueDay||STATE.dueDay||10));
              tb.append(el("tr",{},
                el("td",{}, i),
                el("td",{}, due.toLocaleDateString("es-AR")),
                el("td",{}, money(q)),
                el("td",{}, i<=paid? "Pagada ✔️" : el("button",{class:"btn",dataset:{id,act:"pay",n:i}}, "Marcar pagada"))
              ));
            }
            table.append(tb); wrap.append(table); return wrap;
          })()
        )
      );
      return box;
    }

    async function loadPending(){
      const box = $("#pendingBox");
      box.textContent = "Cargando…";
      try{
        // Para evitar índice compuesto: ordenamos por createdAt y filtramos en memoria
        const snap = await getDocs(query(collection(db,"loan_requests"), orderBy("createdAt","desc"), limit(80)));
        if(snap.empty){ box.textContent = "Sin solicitudes"; return; }
        box.innerHTML = "";
        snap.forEach(d=>{
          const data = d.data();
          if((data.status||"pending")==="pending"){
            const c = cardRequest(data,d.id);
            box.append(c);
          }
        });
        if(!box.children.length) box.textContent = "Sin pendientes";
      }catch(e){ console.error(e); box.textContent = "No se pudieron leer las solicitudes (revisá reglas/índices)."; }
    }
    async function loadPre(){
      const box = $("#preBox");
      box.textContent = "Cargando…";
      try{
        const snap = await getDocs(query(collection(db,"loans"), orderBy("createdAt","desc"), limit(80)));
        box.innerHTML = "";
        snap.forEach(d=>{
          const l=d.data();
          if(l.status==="preapproved") box.append(cardPre(l,d.id));
        });
        if(!box.children.length) box.textContent = "Sin preaprobados";
      }catch(e){ console.error(e); box.textContent = "No se pudo leer (revisá reglas/índices)."; }
    }
    async function loadActive(){
      const box = $("#activeBox");
      box.textContent = "Cargando…";
      try{
        const snap = await getDocs(query(collection(db,"loans"), orderBy("activeAt","desc"), limit(80)));
        box.innerHTML = "";
        snap.forEach(d=>{
          const l=d.data();
          if(l.status==="active") box.append(cardActive(l,d.id));
        });
        if(!box.children.length) box.textContent = "Sin activos";
      }catch(e){ console.error(e); box.textContent = "No se pudo leer (revisá reglas/índices)."; }
    }

    $("#btnReloadPending").onclick = loadPending;
    $("#btnReloadPre").onclick = loadPre;
    $("#btnReloadActive").onclick = loadActive;

    // Acciones admin (delegación)
    document.addEventListener("click", async (ev)=>{
      const b = ev.target.closest("button"); if(!b) return;
      // Pre-conditions
      if(b.closest("#adminPanel") && !STATE.isAdmin){ toast("Solo admin."); return; }

      // Cards pending
      if(b.textContent==="Preaprobar"){
        const id=b.dataset.id;
        try{
          const d = await getDoc(doc(db,"loan_requests",id));
          if(!d.exists()) return;
          const r=d.data();
          // creo loan preapproved
          await addDoc(collection(db,"loans"),{
            amount:r.amount, months:r.months, tna:r.tna, createdAt: serverTimestamp(),
            status:"preapproved", borrower:r.borrower, paidCount:0, dueDay: STATE.dueDay
          });
          // marco request como movida
          await updateDoc(doc(db,"loan_requests",id),{ status:"preapproved" });
          await loadPending(); await loadPre();
          toast("Solicitud preaprobada.");
        }catch(e){ console.error(e); toast("Error al preaprobar."); }
      }
      if(b.dataset.act==="rej"){
        try{ await updateDoc(doc(db,"loan_requests",b.dataset.id),{status:"rejected"}); await loadPending(); }catch(e){}
      }

      // Cards pre
      if(b.dataset.act==="activate"){
        try{
          const dId = b.dataset.id;
          const lSnap = await getDoc(doc(db,"loans",dId));
          if(!lSnap.exists()) return;
          const l = lSnap.data();
          await updateDoc(doc(db,"loans",dId),{ status:"active", activeAt: serverTimestamp(), paidCount:0, dueDay: l.dueDay||STATE.dueDay });
          await loadPre(); await loadActive();
          toast("Préstamo activado.");
        }catch(e){ console.error(e); toast("No se pudo activar."); }
      }
      if(b.dataset.act==="contract"){
        // No se abre nada automáticamente jamás: solo al hacer clic
        try{
          const dId = b.dataset.id;
          const l = (await getDoc(doc(db,"loans",dId))).data();
          const html = `
            <html><head><meta charset="utf-8"><title>Contrato EstimaPres</title></head>
            <body>
              <h2>Contrato de préstamo — EstimaPres</h2>
              <p>Deudor: ${l.borrower?.name||""} · DNI ${l.borrower?.dni||""}</p>
              <p>Monto: ${money(l.amount)} · Plazo: ${l.months} cuotas · TNA: ${l.tna}%</p>
              <p>Vencimiento mensual: día ${l.dueDay||STATE.dueDay}</p>
              <hr/>
              <p>Este documento es emitido automáticamente para revisión.</p>
              <script>window.print()</script>
            </body></html>`;
          const w= window.open("about:blank","_blank");
          w.document.write(html); w.document.close();
        }catch(e){ console.error(e); toast("No se pudo generar el contrato."); }
      }
      if(b.dataset.act==="del"){
        try{ await updateDoc(doc(db,"loans",b.dataset.id),{status:"deleted"}); await loadPre(); }catch(e){}
      }

      // Cards active
      if(b.dataset.act==="ver"){
        $("#det-"+b.dataset.id).classList.toggle("hidden");
      }
      if(b.dataset.act==="inc"){
        if(!confirm("¿Pasar a incobrables?")) return;
        try{ await updateDoc(doc(db,"loans",b.dataset.id),{status:"charged_off"}); await loadActive(); }catch(e){}
      }
      if(b.dataset.act==="fin"){
        if(!confirm("¿Finalizar (pagado total)?")) return;
        try{ await updateDoc(doc(db,"loans",b.dataset.id),{status:"finished"}); await loadActive(); }catch(e){}
      }
      if(b.dataset.act==="pay"){
        const n = Number(b.dataset.n||0);
        try{
          const ref = doc(db,"loans",b.dataset.id);
          const l = (await getDoc(ref)).data();
          const cur = Number(l.paidCount||0);
          if(n<=cur) return;
          await updateDoc(ref,{ paidCount: n });
          await loadActive();
        }catch(e){}
      }
    });

    // === 8) Ver mi préstamo (simple por DNI) ================================
    $("#btnMyLoan").onclick = async ()=>{
      const dni = prompt("Ingresá tu DNI para consultar tu préstamo:");
      if(!dni) return;
      try{
        const results = [];
        const snap = await getDocs(query(collection(db,"loans"), orderBy("createdAt","desc"), limit(80)));
        snap.forEach(d=>{ const l=d.data(); if(l?.borrower?.dni==dni) results.push({id:d.id,...l}); });
        if(!results.length){ alert("No encontramos prestamos activos o preaprobados para ese DNI."); return; }
        const l = results[0];
        alert(`Estado: ${l.status}\nMonto: ${money(l.amount)}\nCuotas: ${l.months} · TNA ${l.tna}%`);
      }catch(e){ alert("No se pudo consultar."); }
    };

  </script>
</body>
</html>