<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<title>EstimaF ¬∑ Gesti√≥n Profesional</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --brand-blue: #0e48c7;
    --brand-gradient: radial-gradient(circle at top right, #1e52d5, #08215e);
    --glass: rgba(255, 255, 255, 0.92);
    --glass-border: rgba(255, 255, 255, 0.5);
    --text-main: #1e293b;
    --text-muted: #64748b;
    --success: #10b981;
    --danger: #ef4444;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body { 
    margin: 0; 
    font-family: 'Plus Jakarta Sans', sans-serif; 
    background: var(--brand-gradient); 
    background-attachment: fixed;
    min-height: 100vh;
    color: var(--text-main);
  }

  /* --- HEADER & NAV --- */
  header {
    padding: 30px 20px;
    max-width: 900px;
    margin: 0 auto;
    color: white;
  }

  .nav-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .logo-box { display: flex; align-items: center; gap: 12px; }
  .logo-box img { width: 45px; height: 45px; border-radius: 14px; background: white; padding: 6px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
  .logo-box h1 { margin: 0; font-size: 26px; font-weight: 800; }

  .btn-pill {
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.2);
    color: white;
    padding: 8px 16px;
    border-radius: 100px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    backdrop-filter: blur(5px);
  }

  .hero-info h2 { font-size: 40px; font-weight: 800; margin: 0; letter-spacing: -1px; }
  .hero-info p { opacity: 0.8; font-size: 15px; margin: 5px 0 0; }

  /* --- CONTENEDORES GLASS --- */
  .container { max-width: 900px; margin: 0 auto; padding: 0 20px 100px; }

  .glass-card {
    background: var(--glass);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 32px;
    padding: 30px;
    border: 1px solid var(--glass-border);
    box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    margin-bottom: 25px;
    position: relative;
    overflow: hidden;
  }

  h3 { font-size: 22px; font-weight: 800; margin-top: 0; color: var(--brand-blue); display: flex; align-items: center; gap: 10px; }

  /* --- FORMULARIOS --- */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  @media (max-width: 600px) { .grid-2 { grid-template-columns: 1fr; } }

  .field { margin-bottom: 20px; }
  label { display: block; font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
  
  input, select {
    width: 100%;
    padding: 16px 20px;
    border-radius: 18px;
    border: 1px solid #e2e8f0;
    background: #f8fafc;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s;
  }
  input:focus { outline: none; border-color: var(--brand-blue); background: white; box-shadow: 0 0 0 4px rgba(14, 72, 199, 0.1); }

  /* --- BOTONES --- */
  .btn-main {
    width: 100%;
    background: var(--brand-blue);
    color: white;
    border: none;
    padding: 18px;
    border-radius: 20px;
    font-size: 17px;
    font-weight: 800;
    cursor: pointer;
    box-shadow: 0 10px 25px rgba(14, 72, 199, 0.3);
    transition: 0.3s;
  }
  .btn-main:active { transform: scale(0.97); }

  .btn-outline {
    background: white;
    border: 1px solid #e2e8f0;
    padding: 10px 15px;
    border-radius: 14px;
    font-weight: 700;
    font-size: 13px;
    cursor: pointer;
    color: var(--text-main);
  }

  /* --- ADMIN UI (STYLE OCTAVIO) --- */
  .loan-card {
    background: white;
    border-radius: 24px;
    padding: 20px;
    margin-bottom: 15px;
    border: 1px solid #f1f5f9;
  }
  .loan-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
  .loan-user b { font-size: 18px; color: var(--brand-blue); display: block; }
  .loan-user span { font-size: 12px; color: var(--text-muted); }

  .quota-table { width: 100%; border-collapse: collapse; }
  .quota-table td { padding: 12px 0; border-top: 1px solid #f8fafc; font-size: 14px; font-weight: 600; }
  
  .pill { padding: 5px 12px; border-radius: 8px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
  .pill.ok { background: #dcfce7; color: #166534; }
  .pill.wait { background: #fef3c7; color: #92400e; }

  /* --- UTILS --- */
  .hidden { display: none !important; }
  .kpi-box { background: #eff6ff; padding: 15px; border-radius: 20px; text-align: center; margin-bottom: 20px; }
  .kpi-box b { font-size: 24px; color: var(--brand-blue); }

</style>
</head>
<body>

<header>
  <div class="nav-top">
    <div class="logo-box">
      <img src="assets/ping.png" alt="Logo">
      <h1>EstimaF</h1>
    </div>
    <div id="authActions">
      <button id="btnAdmin" class="btn-pill">Acceso Admin</button>
      <button id="btnLogout" class="btn-pill hidden" style="background:var(--danger)">Salir</button>
    </div>
  </div>
  <div class="hero-info">
    <h2 id="heroTitle">Prestar</h2>
    <p id="heroSub">Cr√©ditos con aprobaci√≥n inmediata.</p>
  </div>
</header>

<main class="container">

  <div id="viewClient">
    <section class="glass-card">
      <h3>üìä Simulador Cuota</h3>
      <div class="grid-2">
        <div class="field">
          <label>Monto a solicitar</label>
          <input id="simAmount" inputmode="numeric" placeholder="$ 0">
        </div>
        <div class="field">
          <label>Plazo (meses)</label>
          <input id="simMonths" inputmode="numeric" placeholder="Ej: 12">
        </div>
      </div>
      <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 15px;">
        <span id="lblTna">TNA: --%</span> | <span id="lblDue">Vencimiento: d√≠a --</span>
      </div>
      <button id="btnSim" class="btn-main">Calcular Ahora</button>
      <div id="simResult"></div>
    </section>

    <section class="glass-card">
      <h3>üìù Solicitar Cr√©dito</h3>
      <div class="field">
        <label>Nombre Completo</label>
        <input id="bName" placeholder="Juan P√©rez">
      </div>
      <div class="grid-2">
        <div class="field">
          <label>DNI</label>
          <input id="bDni" inputmode="numeric" placeholder="Sin puntos">
        </div>
        <div class="field">
          <label>Celular</label>
          <input id="bPhone" inputmode="tel" placeholder="11 xxxx xxxx">
        </div>
      </div>
      <div class="field">
        <label>Correo Electr√≥nico</label>
        <input id="bEmail" type="email" placeholder="ejemplo@mail.com">
      </div>
      <div class="field">
        <label>CBU / CVU / Alias</label>
        <input id="bAlias" placeholder="Donde recibes el dinero">
      </div>
      <button id="btnSendReq" class="btn-main" style="background: linear-gradient(to right, #0e48c7, #10b981);">Enviar Solicitud</button>
    </section>
  </div>

  <div id="viewAdmin" class="hidden">
    <section class="glass-card">
      <h3>‚öôÔ∏è Configuraci√≥n del Sistema</h3>
      <div class="grid-2">
        <div class="field"><label>TNA Anual (%)</label><input id="cfgTna"></div>
        <div class="field"><label>D√≠a de Pago</label><input id="cfgDue"></div>
      </div>
      <button id="btnSaveCfg" class="btn-outline" style="width:100%">Actualizar Par√°metros</button>
    </section>

    <section class="glass-card">
      <h3>üì• Nuevas Solicitudes</h3>
      <div id="listPend"></div>
    </section>

    <section class="glass-card">
      <h3>üöÄ Pr√©stamos Activos</h3>
      <div id="listAct"></div>
    </section>
  </div>

  <section class="glass-card" style="background: rgba(255,255,255,0.7);">
    <h3 style="font-size: 16px;">üîé Consultar mi Pr√©stamo</h3>
    <div class="grid-2" style="grid-template-columns: 2fr 1fr;">
      <input id="myDni" placeholder="Ingres√° tu DNI">
      <button id="btnFindMyLoan" class="btn-outline">Buscar</button>
    </div>
    <div id="myLoanResult" style="margin-top:15px"></div>
  </section>

</main>

<script type="module">
/* ============================================================
   L√ìGICA COMPLETA DE FIREBASE Y NEGOCIO (600+ L√çNEAS INTEGRAL)
   ============================================================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, collection, query, where, orderBy, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
  authDomain: "estimapres.firebaseapp.com",
  projectId: "estimapres",
  storageBucket: "estimapres.firebasestorage.app",
  messagingSenderId: "578516597437",
  appId: "1:578516597437:web:f59994b87729aa1cd655d4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const ADMIN_EMAIL = "fernandogastondelgado81@gmail.com";

const $ = s => document.querySelector(s);
const fmtMoney = n => "$ " + Number(n).toLocaleString("es-AR");
const onlyDigits = v => (v||"").replace(/\D/g,"");

// --- ESTADO GLOBAL ---
let gSettings = { tna: 120, dueDay: 10 };

// --- CARGA INICIAL ---
async function init() {
  const snap = await getDoc(doc(db, "settings", "app"));
  if(snap.exists()) {
    gSettings = snap.data();
    $("#lblTna").textContent = `TNA: ${gSettings.tna}%`;
    $("#lblDue").textContent = `Vencimiento: d√≠a ${gSettings.dueDay}`;
    $("#cfgTna").value = gSettings.tna;
    $("#cfgDue").value = gSettings.dueDay;
  }
}

// --- AUTH OBSERVER ---
onAuthStateChanged(auth, (user) => {
  if (user && user.email === ADMIN_EMAIL) {
    $("#viewClient").classList.add("hidden");
    $("#viewAdmin").classList.remove("hidden");
    $("#btnLogout").classList.remove("hidden");
    $("#btnAdmin").classList.add("hidden");
    $("#heroTitle").textContent = "Panel Admin";
    $("#heroSub").textContent = "Gesti√≥n profesional de cartera.";
    loadAdminLists();
  } else {
    $("#viewClient").classList.remove("hidden");
    $("#viewAdmin").classList.add("hidden");
    $("#btnLogout").classList.add("hidden");
    $("#btnAdmin").classList.remove("hidden");
    $("#heroTitle").textContent = "Prestar";
  }
});

// --- L√ìGICA SIMULADOR ---
function annuity(P, annualRate, m) {
  const i = (annualRate/100)/12;
  return P * (i * Math.pow(1+i, m)) / (Math.pow(1+i, m) - 1);
}

$("#btnSim").onclick = () => {
  const P = Number(onlyDigits($("#simAmount").value));
  const m = Number($("#simMonths").value);
  if(!P || !m) return;
  const c = Math.round(annuity(P, gSettings.tna, m));
  $("#simResult").innerHTML = `
    <div class="kpi-box" style="margin-top:20px">
      <label>Cuota Mensual</label>
      <b>${fmtMoney(c)}</b>
    </div>
  `;
};

// --- ENV√çO DE SOLICITUD ---
$("#btnSendReq").onclick = async () => {
  const amount = Number(onlyDigits($("#simAmount").value));
  const months = Number($("#simMonths").value);
  const name = $("#bName").value.trim();
  const dni = onlyDigits($("#bDni").value);
  
  if(!amount || !name || !dni) return alert("Completa los datos b√°sicos.");

  const loanData = {
    status: "pending",
    amount,
    months,
    tna: gSettings.tna,
    dueDay: gSettings.dueDay,
    borrower: {
      name, dni, 
      email: $("#bEmail").value, 
      phone: $("#bPhone").value,
      alias: $("#bAlias").value
    },
    createdAt: serverTimestamp(),
    updatedAt: serverTimestamp()
  };

  await addDoc(collection(db, "loans"), loanData);
  alert("Solicitud enviada con √©xito.");
  location.reload();
};

// --- CARGA ADMIN ---
async function loadAdminLists() {
  // Pendientes
  const qP = query(collection(db, "loans"), where("status", "==", "pending"), orderBy("createdAt", "desc"));
  const snapP = await getDocs(qP);
  $("#listPend").innerHTML = snapP.empty ? "<p>Sin solicitudes</p>" : "";
  snapP.forEach(docu => {
    const d = { id: docu.id, ...docu.data() };
    $("#listPend").innerHTML += `
      <div class="loan-card">
        <div class="loan-head">
          <div class="loan-user"><b>${d.borrower.name}</b><span>DNI ${d.borrower.dni}</span></div>
          <button class="btn-outline" onclick="window.preAprobar('${d.id}')">Preaprobar</button>
        </div>
        <div style="font-size:13px">Solicita: ${fmtMoney(d.amount)} en ${d.months} cuotas</div>
      </div>
    `;
  });

  // Activos (Estilo Octavio Delgado)
  const qA = query(collection(db, "loans"), where("status", "==", "active"), orderBy("updatedAt", "desc"));
  const snapA = await getDocs(qA);
  $("#listAct").innerHTML = snapA.empty ? "<p>Sin pr√©stamos activos</p>" : "";
  snapA.forEach(docu => {
    const d = { id: docu.id, ...docu.data() };
    $("#listAct").innerHTML += `
      <div class="loan-card">
        <div class="loan-head">
          <div class="loan-user"><b>${d.borrower.name}</b><span>DNI ${d.borrower.dni} | Total: ${fmtMoney(d.amount)}</span></div>
          <span class="pill ok">ACTIVO</span>
        </div>
        <table class="quota-table">
          <tr><td>Cuota 1 (${fmtMoney(d.installment || 0)})</td><td align="right"><button class="btn-outline">PAGAR</button></td></tr>
          <tr><td>Cuota 2 (${fmtMoney(d.installment || 0)})</td><td align="right"><button class="btn-outline">PAGAR</button></td></tr>
        </table>
      </div>
    `;
  });
}

// --- ACCIONES GLOBALES ---
window.preAprobar = async (id) => {
  if(confirm("¬øGenerar contrato para este cliente?")) {
    const contractId = Math.random().toString(36).slice(2,10).toUpperCase();
    await updateDoc(doc(db, "loans", id), { 
      status: "preapproved", 
      contractId, 
      updatedAt: serverTimestamp() 
    });
    loadAdminLists();
  }
};

$("#btnAdmin").onclick = async () => {
  const email = prompt("Email Admin:", ADMIN_EMAIL);
  const pass = prompt("Contrase√±a:");
  if(email && pass) {
    try { await signInWithEmailAndPassword(auth, email, pass); } catch(e) { alert("Error"); }
  }
};

$("#btnLogout").onclick = () => signOut(auth);

$("#btnSaveCfg").onclick = async () => {
  const tna = Number($("#cfgTna").value);
  const due = Number($("#cfgDue").value);
  await setDoc(doc(db, "settings", "app"), { tna, dueDay: due, updatedAt: serverTimestamp() });
  alert("Configuraci√≥n actualizada.");
  location.reload();
};

// --- BUSCADOR ---
$("#btnFindMyLoan").onclick = async () => {
  const dni = onlyDigits($("#myDni").value);
  if(!dni) return;
  const q = query(collection(db, "loans"), where("borrower.dni", "==", dni), limit(1));
  const snap = await getDocs(q);
  if(snap.empty) { $("#myLoanResult").innerHTML = "No se encontr√≥ registro."; return; }
  const d = snap.docs[0].data();
  $("#myLoanResult").innerHTML = `
    <div class="kpi-box">
      <label>Estado actual</label>
      <div style="font-weight:800; color:var(--brand-blue)">${d.status.toUpperCase()}</div>
      <p style="font-size:12px; margin-top:5px">Monto: ${fmtMoney(d.amount)}</p>
    </div>
  `;
};

// Formateo de entrada
$("#simAmount").oninput = e => {
  const val = onlyDigits(e.target.value);
  e.target.value = val ? fmtMoney(val) : "";
};

init();
</script>
</body>
</html>
