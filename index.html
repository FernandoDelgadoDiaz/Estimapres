<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>EstimaPres</title>
  <style>
    :root{
      --pri:#0b5ed7; --pri2:#0949a6; --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;
      --ink:#111827; --mut:#6b7280; --ring:#e5e7eb; --bg:#f6f7fb; --card:#fff
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    header{position:sticky;top:0;z-index:10;background:#0a4da1;color:#fff}
    .wrap{max-width:980px;margin:0 auto;padding:0 16px}
    .bar{display:flex;gap:12px;align-items:center;padding:14px 0}
    .brand{font-weight:800;letter-spacing:.2px}
    .pill{border:0;border-radius:28px;padding:10px 16px;background:#ffffff1a;color:#fff;cursor:pointer}
    .btn{border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--pri);color:#fff}
    .btn.green{background:var(--ok);color:#fff}
    .btn.gray{background:#e2e8f0}
    .btn.red{background:var(--bad);color:#fff}
    main{padding:20px 0}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:18px;margin:14px 0;box-shadow:0 2px 10px #0001}
    h1{margin:0 0 10px}
    h2{margin:0 0 8px}
    .muted{color:var(--mut)}
    .grid2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media(max-width:760px){.grid2{grid-template-columns:1fr}}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--ring);font-size:16px}
    .hidden{display:none!important}
    .tag{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .tag.g{background:#dcfce7;color:#065f46}
    .tag.y{background:#fef9c3;color:#854d0e}
    .tag.r{background:#fee2e2;color:#7f1d1d}
    table{width:100%;border-collapse:collapse;border:1px solid var(--ring);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--ring);font-size:14px}
    th{background:#f9fafb;text-align:left}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px}
  </style>
</head>
<body>
  <header>
    <div class="wrap bar">
      <div class="brand">EstimaPres</div>
      <button id="btnMyLoan" class="pill">Ver mi préstamo</button>
      <button id="btnAdmin" class="pill hidden">Admin</button>
      <div style="flex:1"></div>
      <button id="btnLogin" class="pill">Ingresar</button>
      <button id="btnLogout" class="pill hidden">Salir</button>
    </div>
  </header>

  <main class="wrap">
    <!-- SIMULADOR -->
    <section class="card">
      <h1>Simulador (ARS)</h1>
      <div class="grid2">
        <input id="simAmount" type="number" inputmode="numeric" placeholder="Monto (ej: 200000)" />
        <input id="simMonths" type="number" inputmode="numeric" placeholder="Meses (ej: 12)" />
      </div>
      <div class="muted" style="margin-top:6px">TNA vigente: <b id="lblTna">—%</b> · Vencimiento día <b>10</b></div>
      <div style="margin-top:10px"><button id="btnSim" class="btn green">Simular</button></div>
      <div id="simOut" class="muted" style="margin-top:8px">—</div>
      <div id="simSchedule" class="hidden" style="margin-top:8px"></div>
    </section>

    <!-- SOLICITUD -->
    <section class="card">
      <h1>Solicitar préstamo</h1>
      <div class="grid2">
        <input id="rqName" placeholder="Nombre y apellido" />
        <input id="rqDni" placeholder="DNI" />
        <input id="rqEmail" placeholder="Email" />
        <input id="rqPhone" placeholder="Teléfono" />
        <input id="rqCbu" placeholder="Alias o CBU/CVU" />
      </div>
      <div style="margin-top:10px"><button id="btnSendReq" class="btn primary">Enviar solicitud</button></div>
      <div class="muted" style="margin-top:6px">Al enviar aceptás ser contactado por EstimaPres.</div>
    </section>

    <!-- ADMIN -->
    <section id="adminPanel" class="card hidden">
      <h1>Panel administrador</h1>

      <h2>TNA</h2>
      <div class="grid2">
        <input id="inpTna" />
        <button id="btnSaveTna" class="btn primary">Guardar</button>
      </div>

      <h2 style="margin-top:14px">Solicitudes pendientes</h2>
      <button id="btnReloadReq" class="btn gray">Recargar</button>
      <div id="reqList" style="margin-top:8px"></div>

      <h2 style="margin-top:14px">Preaprobados</h2>
      <button id="btnReloadPre" class="btn gray">Recargar</button>
      <div id="preList" style="margin-top:8px"></div>

      <h2 style="margin-top:14px">Activos</h2>
      <button id="btnReloadActive" class="btn gray">Recargar</button>
      <div id="activeList" style="margin-top:8px"></div>
    </section>
  </main>

  <div id="toast" class="toast hidden"></div>

  <script type="module">
    // ===== Utils =====
    const $ = s => document.querySelector(s);
    const money = n => new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0}).format(Number(n||0));
    const toast = (m)=>{const t=$("#toast"); t.textContent=m; t.classList.remove("hidden"); clearTimeout(toast._t); toast._t=setTimeout(()=>t.classList.add("hidden"),2200);};

    // ===== Firebase =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc,
      collection, getDocs, query, where, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // === Config real (estimapres)
    const firebaseConfig = {
      apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
      authDomain: "estimapres.firebaseapp.com",
      projectId: "estimapres",
      storageBucket: "estimapres.firebasestorage.app",
      messagingSenderId: "578516597437",
      appId: "1:578516597437:web:f59994b87729aa1cd655d4"
    };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ===== Estado =====
    const STATE = { tna: 150, user:null, isAdmin:false, dueDay:10 };

    // ===== Admin check =====
    async function isEmailAdmin(email){
      try{
        const s = await getDoc(doc(db,"admins","admins"));
        const list = s.exists() ? (s.data().emails||[]) : [];
        const norm = x => String(x||'').trim().toLowerCase();
        return list.map(norm).includes(norm(email));
      }catch(e){ return false; }
    }

    // ===== TNA =====
    async function loadTna(){
      try{
        const s = await getDoc(doc(db,"settings","global"));
        if(s.exists()) STATE.tna = Number(s.data().tna||STATE.tna);
      }catch{}
      $("#lblTna").textContent = STATE.tna+"%";
      $("#inpTna").value = STATE.tna;
    }
    async function saveTna(){
      try{
        const val = Number($("#inpTna").value||0);
        await setDoc(doc(db,"settings","global"), { tna: val, updatedAt: serverTimestamp() }, { merge:true });
        STATE.tna = val; $("#lblTna").textContent = val+"%"; toast("TNA actualizada");
      }catch(e){ toast("No se pudo guardar TNA"); }
    }

    // ===== Simulador =====
    const cuota = (P,tna,n)=>{ const r=(tna/100)/12; if(!r||!n) return 0; return Math.round(P*(r/(1-Math.pow(1+r,-n)))); };
    $("#btnSim").onclick = ()=>{
      const P = Number($("#simAmount").value||0);
      const n = Number($("#simMonths").value||0);
      if(!P||!n){ toast("Completá monto y meses"); return; }
      const c = cuota(P,STATE.tna,n); const tot = c*n;
      $("#simOut").innerHTML = `Cuota: <b>${money(c)}</b> · <span class="muted">Total: ${money(tot)}</span>`;
      const rows = Array.from({length:n},(_,i)=>`<tr><td>${i+1}</td><td>${String(STATE.dueDay).padStart(2,"0")}/${String(((new Date().getMonth()+i+1)%12)+1).padStart(2,"0")}</td><td>${money(c)}</td></tr>`).join("");
      $("#simSchedule").innerHTML = `<table><thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th></tr></thead><tbody>${rows}</tbody></table>`;
      $("#simSchedule").classList.remove("hidden");
    };

    // ===== Solicitud => SIEMPRE a 'loans' con status: pending =====
    $("#btnSendReq").onclick = async ()=>{
      const name=$("#rqName").value.trim(), dni=$("#rqDni").value.trim(), email=$("#rqEmail").value.trim(),
            phone=$("#rqPhone").value.trim(), cbu=$("#rqCbu").value.trim();
      const amount=Number($("#simAmount").value||0), months=Number($("#simMonths").value||0);
      if(!name||!dni||!email||!phone||!cbu||!amount||!months){ toast("Completá simulación y datos"); return; }
      try{
        await addDoc(collection(db,"loans"),{
          status:"pending", createdAt: serverTimestamp(),
          borrower:{name,dni,email,phone,cbu}, amount, months, tna: STATE.tna
        });
        alert("Solicitud enviada. Un administrador la revisará.");
        ["rqName","rqDni","rqEmail","rqPhone","rqCbu"].forEach(id=>$("#"+id).value="");
      }catch(e){ alert("No se pudo enviar: "+(e.code||e.message)); }
    };

    // ===== Admin panel =====
    function openAdmin(){ $("#adminPanel").classList.remove("hidden"); loadTna(); loadPending(); loadPre(); loadActive(); }

    // Listas admin (SIN índices compuestos: sólo where status; ordenamos en cliente)
    async function loadPending(){
      const box=$("#reqList"); box.innerHTML="Cargando…";
      try{
        const snap = await getDocs(query(collection(db,"loans"), where("status","==","pending")));
        if(snap.empty){ box.innerHTML='<div class="muted">Sin pendientes</div>'; return; }
        const items=[]; snap.forEach(d=>items.push({id:d.id,...d.data()}));
        items.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
        box.innerHTML = items.map(l=>`
          <div class="card" style="padding:12px">
            <b>${l.borrower.name}</b> · DNI ${l.borrower.dni}
            <div class="muted">${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%</div>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn green" data-act="pre" data-id="${l.id}">Preaprobar</button>
              <button class="btn red" data-act="delreq" data-id="${l.id}">Eliminar</button>
            </div>
          </div>`).join("");
      }catch(e){ box.innerHTML = `<div class="muted">Error: ${e.code||e.message}</div>`; }
    }
    async function loadPre(){
      const box=$("#preList"); box.innerHTML="Cargando…";
      try{
        const snap = await getDocs(query(collection(db,"loans"), where("status","==","preapproved")));
        if(snap.empty){ box.innerHTML='<div class="muted">Sin preaprobados</div>'; return; }
        const items=[]; snap.forEach(d=>items.push({id:d.id,...d.data()}));
        items.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
        box.innerHTML = items.map(l=>`
          <div class="card" style="padding:12px">
            <b>${l.borrower.name}</b> · DNI ${l.borrower.dni}
            <div class="muted">Monto ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%</div>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn green" data-act="approve" data-id="${l.id}">Aprobar</button>
              <button class="btn red" data-act="delloan" data-id="${l.id}">Eliminar</button>
            </div>
          </div>`).join("");
      }catch(e){ box.innerHTML = `<div class="muted">Error: ${e.code||e.message}</div>`; }
    }
    async function loadActive(){
      const box=$("#activeList"); box.innerHTML="Cargando…";
      try{
        const snap = await getDocs(query(collection(db,"loans"), where("status","==","active")));
        if(snap.empty){ box.innerHTML='<div class="muted">Sin activos</div>'; return; }
        const items=[]; snap.forEach(d=>items.push({id:d.id,...d.data()}));
        items.sort((a,b)=> (b.activeAt?.seconds||0)-(a.activeAt?.seconds||0));
        box.innerHTML = items.map(l=>`
          <div class="card" style="padding:12px">
            <span class="tag g">Activo</span> <b>${l.borrower.name}</b> · DNI ${l.borrower.dni}
            <div class="muted">Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%</div>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn gray" data-act="fin" data-id="${l.id}">Finalizar</button>
              <button class="btn red" data-act="inc" data-id="${l.id}">A incobrables</button>
            </div>
          </div>`).join("");
      }catch(e){ box.innerHTML = `<div class="muted">Error: ${e.code||e.message}</div>`; }
    }

    // Acciones admin
    document.addEventListener("click", async (ev)=>{
      const b=ev.target.closest("button"); if(!b) return;
      const act=b.dataset.act, id=b.dataset.id;

      // Navegación / auth
      if(b.id==="btnLogin"){
        const email = prompt("Email admin:"); if(!email) return;
        const pass  = prompt("Contraseña:"); if(!pass) return;
        try{ await signInWithEmailAndPassword(auth,email,pass); toast("Sesión iniciada"); }catch(e){ alert(e.code||e.message); }
        return;
      }
      if(b.id==="btnLogout"){ try{ await signOut(auth); toast("Sesión cerrada"); }catch{} return; }
      if(b.id==="btnAdmin"){
        if(!STATE.user){ alert("Iniciá sesión"); return; }
        if(!STATE.isAdmin){ alert("No sos admin"); return; }
        openAdmin(); return;
      }
      if(b.id==="btnSaveTna"){ await saveTna(); return; }
      if(b.id==="btnReloadReq"){ await loadPending(); return; }
      if(b.id==="btnReloadPre"){ await loadPre(); return; }
      if(b.id==="btnReloadActive"){ await loadActive(); return; }
      if(b.id==="btnMyLoan"){
        const dni = prompt("DNI:"); if(!dni) return;
        try{
          const snap = await getDocs(query(collection(db,"loans"), where("status","in",["active","preapproved","pending"])));
          let found=null; snap.forEach(d=>{ const l=d.data(); if(l?.borrower?.dni==dni) found=l; });
          if(!found) return alert("No encontramos préstamos para ese DNI.");
          alert(`Estado: ${found.status}\nMonto: ${money(found.amount)}\nCuotas: ${found.months}\nTNA: ${found.tna}%`);
        }catch(e){ alert(e.code||e.message); }
        return;
      }

      // Admin actions
      if(act==="pre"){
        try{ await updateDoc(doc(db,"loans",id),{status:"preapproved"}); toast("Preaprobado"); loadPending(); loadPre(); }
        catch(e){ alert(e.code||e.message); }
        return;
      }
      if(act==="delreq"){
        if(!confirm("Eliminar solicitud?"))return;
        try{ await deleteDoc(doc(db,"loans",id)); toast("Eliminada"); loadPending(); }
        catch(e){ alert(e.code||e.message); }
        return;
      }
      if(act==="approve"){
        try{ await updateDoc(doc(db,"loans",id),{status:"active", activeAt: serverTimestamp()});
             toast("Aprobado"); loadPre(); loadActive(); }
        catch(e){ alert(e.code||e.message); }
        return;
      }
      if(act==="delloan"){
        if(!confirm("Eliminar?"))return;
        try{ await deleteDoc(doc(db,"loans",id)); toast("Eliminado"); loadPre(); }
        catch(e){ alert(e.code||e.message); }
        return;
      }
      if(act==="fin"){
        try{ await updateDoc(doc(db,"loans",id),{status:"finished"}); toast("Finalizado"); loadActive(); }
        catch(e){ alert(e.code||e.message); }
        return;
      }
      if(act==="inc"){
        try{ await updateDoc(doc(db,"loans",id),{status:"charged_off"}); toast("A incobrables"); loadActive(); }
        catch(e){ alert(e.code||e.message); }
        return;
      }
    });

    // Auth state
    onAuthStateChanged(auth, async (user)=>{
      STATE.user=user||null;
      $("#btnLogin").classList.toggle("hidden", !!user);
      $("#btnLogout").classList.toggle("hidden", !user);
      $("#btnAdmin").classList.toggle("hidden", !user);
      $("#adminPanel").classList.add("hidden");

      STATE.isAdmin = !!(user && await isEmailAdmin(user.email));
      if(STATE.isAdmin) openAdmin();
    });

    // Init
    await loadTna();
  </script>
</body>
</html>