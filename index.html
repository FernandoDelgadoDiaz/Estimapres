<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>EstimaPres</title>
<style>
  :root{--blue:#0b63f3;--green:#12b886;--amber:#f59f00;--red:#e03131;--bg:#f7f8fb;--card:#fff;--muted:#6b7280}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
  .navbar{position:sticky;top:0;z-index:10;background:var(--blue);color:#fff}
  .wrap{max-width:980px;margin:0 auto;padding:12px 16px}
  .brand{font-weight:700}
  .navbtn{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .navbtn:hover{background:rgba(0,0,0,.08)}
  main{background:var(--bg);min-height:100vh}
  .grid{display:grid;gap:16px;margin:16px auto;max-width:980px;padding:0 16px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 8px 24px rgba(15,23,42,.06);padding:18px}
  h1{font-size:28px;margin:4px 0 14px} h2{font-size:20px;margin:0 0 12px}
  label{display:block;font-size:14px;color:var(--muted);margin:10px 0 6px}
  input,button,select{font:inherit}
  .in{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
  .btn{display:inline-flex;align-items:center;gap:8px;border:0;border-radius:10px;padding:12px 16px;cursor:pointer}
  .btn-primary{background:var(--blue);color:#fff} .btn-ghost{background:#eef2ff;color:#1e3a8a}
  .btn-green{background:var(--green);color:#fff} .btn-red{background:var(--red);color:#fff}
  .btn-gray{background:#e9ecef;color:#111827}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;color:#111}
  .chip-dot{width:8px;height:8px;border-radius:50%}
  .dot-green{background:var(--green)} .dot-amber{background:var(--amber)} .dot-red{background:var(--red)}
  .muted{color:var(--muted)} .right{margin-left:auto}
  .table{width:100%;border-collapse:collapse} .table th,.table td{padding:10px 8px;border-top:1px solid #eef2f7;font-size:14px;white-space:nowrap}
  .table th{font-size:12px;text-transform:uppercase;color:var(--muted);letter-spacing:.02em}
  .scroll-x{overflow-x:auto}
  @media (max-width:520px){ .row > *{flex:1 1 100%} .btn{width:100%} }
</style>
</head>
<body>
  <!-- NAV -->
  <div class="navbar">
    <div class="wrap row" style="align-items:center">
      <div class="brand">EstimaPres</div>
      <div class="right row">
        <button id="btnMyLoan" class="navbtn">Ver mi préstamo</button>
        <button id="btnAdmin" class="navbtn">Admin</button>
        <button id="btnLogout" class="navbtn" style="display:none">Salir</button>
      </div>
    </div>
  </div>

  <main>
    <div class="grid">

      <!-- SIMULADOR -->
      <section class="card" id="cardSim">
        <h1>Simulador</h1>
        <div class="row">
          <div style="flex:1 1 240px">
            <label>Monto</label>
            <input id="simAmount" class="in" inputmode="numeric" placeholder="$ 1.000.000">
          </div>
          <div style="flex:1 1 180px">
            <label>Meses</label>
            <input id="simMonths" class="in" inputmode="numeric" placeholder="Ej: 12">
          </div>
        </div>
        <p class="muted" id="simMeta">TNA vigente: — · Vencimiento: día 10</p>
        <div class="row">
          <button id="btnSim" class="btn btn-green">Simular</button>
          <div id="simSummary" class="chip" style="display:none"></div>
        </div>
        <div id="simResult" class="scroll-x" style="margin-top:12px;display:none"></div>
      </section>

      <!-- SOLICITAR -->
      <section class="card" id="cardReq">
        <h1>Solicitar préstamo</h1>
        <div class="row">
          <div style="flex:1 1 220px">
            <label>Tu nombre</label>
            <input id="rqName" class="in" placeholder="Juan Pérez">
          </div>
          <div style="flex:1 1 140px">
            <label>DNI</label>
            <input id="rqDni" class="in" inputmode="numeric" placeholder="30123456">
          </div>
        </div>
        <div class="row">
          <div style="flex:1 1 260px">
            <label>Email</label>
            <input id="rqEmail" class="in" placeholder="tucorreo@dominio.com">
          </div>
          <div style="flex:1 1 180px">
            <label>Teléfono</label>
            <input id="rqPhone" class="in" inputmode="tel" placeholder="11 2345 6789">
          </div>
        </div>
        <div>
          <label>Alias o CBU/CVU</label>
          <input id="rqCbu" class="in" placeholder="mi.alias o 0000000000000000000000">
        </div>
        <div class="row" style="margin-top:12px">
          <button id="btnSend" class="btn btn-primary">Enviar solicitud</button>
        </div>
        <p class="muted">Al enviar aceptás ser contactado por EstimaPres.</p>
      </section>

      <!-- PANEL ADMIN -->
      <section class="card" id="adminPanel" style="display:none">
        <h1>Panel administrador</h1>

        <!-- TNA -->
        <div class="card" style="padding:14px;margin-bottom:12px">
          <h2>TNA</h2>
          <div class="row">
            <input id="adminTna" class="in" style="max-width:220px">
            <button id="btnSaveTna" class="btn btn-primary">Guardar</button>
          </div>
        </div>

        <!-- PENDIENTES -->
        <div class="card" style="padding:14px;margin-bottom:12px">
          <h2>Solicitudes pendientes</h2>
          <div class="row"><button id="btnReloadPending" class="btn btn-gray">Recargar</button></div>
          <div id="pendingList" class="muted" style="margin-top:8px">Sin pendientes</div>
        </div>

        <!-- PREAPROBADOS -->
        <div class="card" style="padding:14px;margin-bottom:12px">
          <h2>Preaprobados</h2>
          <div class="row"><button id="btnReloadPre" class="btn btn-gray">Recargar</button></div>
          <div id="preList" class="muted" style="margin-top:8px">Sin preaprobados</div>
        </div>

        <!-- ACTIVOS -->
        <div class="card" style="padding:14px;margin-bottom:12px">
          <h2>Activos</h2>
          <div class="row"><button id="btnReloadActive" class="btn btn-gray">Recargar</button></div>
          <div id="activeList" style="margin-top:8px"></div>
        </div>

        <!-- INACTIVOS -->
        <div class="card" style="padding:14px">
          <h2>Inactivos (finalizados / incobrables)</h2>
          <div class="row">
            <button id="btnFilterFin" class="btn btn-green">Cancelados</button>
            <button id="btnFilterBad" class="btn btn-red">Incobrables</button>
            <button id="btnReloadInactive" class="btn btn-gray">Recargar</button>
          </div>
          <div id="inactiveList" class="muted" style="margin-top:8px">Sin inactivos</div>
        </div>
      </section>
    </div>
  </main>

<!-- Firebase CDN (v10+) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, query, where, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
  authDomain: "estimapres.firebaseapp.com",
  projectId: "estimapres",
  storageBucket: "estimapres.firebasestorage.app",
  messagingSenderId: "578516597437",
  appId: "1:578516597437:web:f59994b87729aa1cd655d4"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------- helpers ---------- */
const $ = (sel,root=document)=>root.querySelector(sel);
const $$= (sel,root=document)=>[...root.querySelectorAll(sel)];
const fmtMoney = n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Number(n)||0);
const money = n => fmtMoney(n).replace(/\s/g,' '); // keep thin space
const parseMasked = v => Number((v||'').toString().replace(/[^\d]/g,''))||0;
const toast = m => alert(m);

/* mask $ ####.### */
const amountInput = $("#simAmount");
amountInput.addEventListener('input', e=>{
  const raw = parseMasked(e.target.value);
  e.target.dataset.num = raw;
  e.target.value = raw ? `$ ${raw.toLocaleString('es-AR')}` : '';
});

/* globals */
let GLOBAL = { tna: 100, dueDay: 10 };
let ADMIN_EMAILS = [];
let currentUser = null;

/* ---------- load settings & admin list ---------- */
async function loadSettings(){
  const snap = await getDoc(doc(db,"settings","global"));
  if (snap.exists()){
    const d = snap.data();
    GLOBAL.tna = Number(d.tna)||GLOBAL.tna;
    GLOBAL.dueDay = Number(d.dueDay||GLOBAL.dueDay);
  }
  $("#adminTna").value = GLOBAL.tna;
  $("#simMeta").textContent = `TNA vigente: ${GLOBAL.tna}% · Vencimiento: día ${GLOBAL.dueDay}`;
}
async function loadAdmins(){
  const s = await getDoc(doc(db,"admins","admins"));
  ADMIN_EMAILS = s.exists() ? (s.data().emails||[]) : [];
}

/* ---------- simulator ---------- */
const cuota = (P,tna, n) => {
  const i = (Number(tna)||0)/100/12;
  if(!i) return Math.round(P/n);
  const c = P * i / (1 - Math.pow(1+i, -n));
  return Math.round(c);
};
$("#btnSim").onclick = ()=>{
  const amount = amountInput.dataset.num ? Number(amountInput.dataset.num) : parseMasked(amountInput.value);
  const months = Number($("#simMonths").value||0);
  if(!amount || !months) return toast("Ingresá monto y meses.");
  const c = cuota(amount, GLOBAL.tna, months);
  $("#simSummary").style.display='inline-flex';
  $("#simSummary").textContent = `Cuota estimada: ${money(c)}`;
  renderSchedule({amount, months, tna:GLOBAL.tna, dueDay:GLOBAL.dueDay}, $("#simResult"));
};

function renderSchedule(l, host){
  const rows = Array.from({length:l.months}, (_,i)=>{
    const n=i+1;
    const due = dueDate(n,l.dueDay);
    const paid = (Number(l.paidCount||0) >= n);
    return `<tr>
      <td>${n}</td>
      <td>${fmtDate(due)}</td>
      <td>${money(cuota(l.amount,l.tna,l.months))}</td>
      <td>${paid?'<span class="chip" style="background:#e6fcf5;color:#087f5b">Pagada</span>':'Pendiente'}</td>
    </tr>`;
  }).join("");
  host.style.display='block';
  host.innerHTML = `<div class="scroll-x">
    <table class="table">
      <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  </div>`;
}
const fmtDate = d => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
function dueDate(n, day){
  const base = new Date();
  const d = new Date(base.getFullYear(), base.getMonth()+n, 1);
  const maxDay = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
  d.setDate(Math.min(day||10, maxDay));
  return d;
}

/* ---------- request (create pending loan) ---------- */
$("#btnSend").onclick = async ()=>{
  const borrower = {
    name: $("#rqName").value.trim(),
    dni: $("#rqDni").value.trim(),
    email: $("#rqEmail").value.trim(),
    phone: $("#rqPhone").value.trim(),
    cbu: $("#rqCbu").value.trim()
  };
  const amount = amountInput.dataset.num ? Number(amountInput.dataset.num) : parseMasked(amountInput.value);
  const months = Number($("#simMonths").value||0);
  if(!borrower.name||!borrower.dni||!borrower.email||!borrower.phone||!borrower.cbu||!amount||!months)
    return toast("Completá todos los campos y simulá monto/meses.");
  try{
    await addDoc(collection(db,"loans"),{
      amount, months, tna: GLOBAL.tna, status:"pending",
      borrower, createdAt: serverTimestamp(), updatedAt: serverTimestamp()
    });
    toast("¡Listo! En 48 hs un administrador lo revisará.");
    $("#rqName").value=$("#rqDni").value=$("#rqEmail").value=$("#rqPhone").value=$("#rqCbu").value="";
  }catch(e){ toast("No se pudo enviar la solicitud."); }
};

/* ---------- admin auth ---------- */
$("#btnAdmin").onclick = async ()=>{
  if(currentUser && ADMIN_EMAILS.includes(currentUser.email)){
    // ya soy admin → mostrar panel
    $("#adminPanel").style.display='block'; window.scrollTo(0,$("#adminPanel").offsetTop-8);
  }else{
    const email = prompt("Email admin:");
    if(!email) return;
    const pass = prompt("Contraseña:");
    if(!pass) return;
    try{
      await signInWithEmailAndPassword(auth,email,pass);
    }catch(e){ toast("Login inválido."); }
  }
};
$("#btnLogout").onclick = ()=>signOut(auth);

onAuthStateChanged(auth, async (u)=>{
  currentUser = u||null;
  $("#btnLogout").style.display = currentUser ? "inline-flex" : "none";
  if(currentUser){
    if(!ADMIN_EMAILS.length) await loadAdmins();
    if(ADMIN_EMAILS.includes(currentUser.email)){
      $("#adminPanel").style.display='block';
      await Promise.all([loadTNA(), loadPending(), loadPre(), loadActive(), loadInactive()]);
    }else{
      $("#adminPanel").style.display='none';
    }
  }else{
    $("#adminPanel").style.display='none';
  }
});

/* ---------- admin: TNA ---------- */
async function loadTNA(){ await loadSettings(); }
$("#btnSaveTna").onclick = async ()=>{
  const t = Number($("#adminTna").value||0);
  if(!t) return toast("Ingresá TNA válido.");
  await setDoc(doc(db,"settings","global"),{tna:t,dueDay:GLOBAL.dueDay},{merge:true});
  GLOBAL.tna=t; $("#simMeta").textContent=`TNA vigente: ${GLOBAL.tna}% · Vencimiento: día ${GLOBAL.dueDay}`;
  toast("TNA actualizado.");
};

/* ---------- admin: Pending ---------- */
$("#btnReloadPending").onclick = ()=>loadPending();
async function loadPending(){
  const box = $("#pendingList"); box.textContent="Cargando...";
  try{
    const snap = await getDocs(query(collection(db,"loans"), where("status","==","pending"), orderBy("createdAt","desc"), limit(50)));
    if(snap.empty){ box.textContent="Sin pendientes"; return; }
    box.innerHTML = [...snap.docs].map(d=>{
      const l = d.data();
      return cardLoan(d.id,l, {showApprove:true, showReject:true});
    }).join("");
    wireButtons(box);
  }catch(e){ box.textContent="No se pudieron leer las solicitudes (reglas/índices)."; }
}

/* ---------- admin: Preapproved ---------- */
$("#btnReloadPre").onclick = ()=>loadPre();
async function loadPre(){
  const box = $("#preList"); box.textContent="Cargando...";
  const snap = await getDocs(query(collection(db,"loans"), where("status","==","preapproved"), orderBy("updatedAt","desc"), limit(50)));
  if(snap.empty){ box.textContent="Sin preaprobados"; return; }
  box.innerHTML = [...snap.docs].map(d=>{
    const l=d.data();
    return cardLoan(d.id,l,{showSendContract:true, showActivate:true, showCancel:true});
  }).join(""); wireButtons(box);
}

/* ---------- admin: Active ---------- */
$("#btnReloadActive").onclick = ()=>loadActive();
function colorByLoan(l){
  // verde si al día; amarillo si la próxima vence en <=10 días; rojo si vencida
  const today = new Date();
  const next = dueDate((l.paidCount||0)+1, l.dueDay||GLOBAL.dueDay);
  const diffDays = Math.floor((next - today)/(1000*60*60*24));
  if(diffDays < 0) return "red"; if(diffDays<=10) return "amber"; return "green";
}
function progress(l){ return `${Number(l.paidCount||0)}/${l.months}`; }

async function loadActive(){
  const box = $("#activeList"); box.textContent="Cargando...";
  const snap = await getDocs(query(collection(db,"loans"), where("status","==","active"), orderBy("updatedAt","desc"), limit(100)));
  if(snap.empty){ box.textContent="Sin activos"; return; }
  box.innerHTML = [...snap.docs].map(d=>{
    const l=d.data(); const clr=colorByLoan(l);
    const dot = clr==='green'?'dot-green':(clr==='amber'?'dot-amber':'dot-red');
    const canFinish = Number(l.paidCount||0) >= Number(l.months||0);
    return `<div class="card" style="margin-bottom:10px;padding:12px" data-id="${d.id}">
      <div class="row" style="align-items:center;gap:8px">
        <span class="chip"><span class="chip-dot ${dot}"></span>Activo</span>
        <strong>${l.borrower?.name||'-'}</strong> · DNI ${l.borrower?.dni||'-'}
        <span class="muted right">Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}% · <b>${progress(l)}</b></span>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn btn-ghost" data-act="view">Ver cuotas</button>
        <button class="btn btn-green" data-act="finish" ${canFinish?'':'disabled style="opacity:.5;cursor:not-allowed"'}>Pagado total</button>
        <button class="btn btn-red" data-act="chargeoff">A incobrables</button>
      </div>
      <div class="scroll-x" data-sched style="display:none;margin-top:8px"></div>
    </div>`;
  }).join(""); wireButtons(box);
}

/* ---------- admin: Inactives ---------- */
let inactiveFilter="finished"; // or charged_off
$("#btnFilterFin").onclick = ()=>{ inactiveFilter="finished"; loadInactive(); };
$("#btnFilterBad").onclick = ()=>{ inactiveFilter="charged_off"; loadInactive(); };
$("#btnReloadInactive").onclick = ()=>loadInactive();
async function loadInactive(){
  const box = $("#inactiveList"); box.textContent="Cargando...";
  const snap = await getDocs(query(collection(db,"loans"), where("status","==",inactiveFilter), orderBy("updatedAt","desc"), limit(100)));
  if(snap.empty){ box.textContent="Sin inactivos"; return; }
  box.innerHTML = [...snap.docs].map(d=>{
    const l=d.data();
    const badge = inactiveFilter==="finished" ? `<span class="chip" style="background:#e6fcf5;color:#087f5b">cancelado</span>` :
                                                `<span class="chip" style="background:#ffe3e3;color:#c92a2a">incobrable</span>`;
    return `<div class="card" style="margin-bottom:10px;padding:12px">
      ${badge} <strong>${l.borrower?.name||'-'}</strong> · DNI ${l.borrower?.dni||'-'}
      <div class="muted">Principal ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}% ${l.contractId?`· Contrato ${l.contractId}`:''}</div>
    </div>`;
  }).join("");
}

/* ---------- cards + actions wiring ---------- */
function cardLoan(id,l,opts={}){
  const base = `<div class="card" style="margin-bottom:10px;padding:12px" data-id="${id}">
    <div><strong>${l.borrower?.name||'-'}</strong> · DNI ${l.borrower?.dni||'-'}</div>
    <div class="muted">Solicitado ${money(l.amount)} · ${l.months} cuotas · TNA ${l.tna}%</div>
    <div class="row" style="margin-top:8px">`;
  const end = `</div><div class="scroll-x" data-sched style="display:none;margin-top:8px"></div></div>`;
  const btns = [
    opts.showApprove?`<button class="btn btn-green" data-act="approve">Preaprobar</button>`:'',
    opts.showReject?`<button class="btn btn-red" data-act="reject">Rechazar</button>`:'',
    opts.showSendContract?`<button class="btn btn-ghost" data-act="contract">Enviar contrato</button>`:'',
    opts.showActivate?`<button class="btn btn-green" data-act="activate">Aprobar y activar</button>`:'',
    opts.showCancel?`<button class="btn btn-red" data-act="cancel">Cancelar</button>`:''
  ].join("");
  return base+btns+end;
}

function wireButtons(root=document){
  root.addEventListener('click', async (ev)=>{
    const b = ev.target.closest('button'); if(!b) return;
    const card = ev.target.closest('[data-id]'); if(!card) return;
    const id = card.dataset.id;
    const act = b.dataset.act;

    if(act==="approve"){ await updateDoc(doc(db,"loans",id),{status:"preapproved",updatedAt:serverTimestamp()}); loadPending(); loadPre(); }
    if(act==="reject"){ if(!confirm("¿Rechazar solicitud?")) return; await updateDoc(doc(db,"loans",id),{status:"deleted",updatedAt:serverTimestamp()}); loadPending(); }
    if(act==="cancel"){ if(!confirm("¿Cancelar preaprobado?")) return; await updateDoc(doc(db,"loans",id),{status:"deleted",updatedAt:serverTimestamp()}); loadPre(); }
    if(act==="contract"){
      // aquí podrías generar/compartir PDF; por ahora sólo mostramos aviso
      toast("Compartí el contrato al solicitante para firma.");
    }
    if(act==="activate"){
      await updateDoc(doc(db,"loans",id),{
        status:"active", activeAt:serverTimestamp(), paidCount: Number(0), updatedAt:serverTimestamp(), dueDay: GLOBAL.dueDay
      });
      loadPre(); loadActive();
    }
    if(act==="chargeoff"){ if(!confirm("¿Pasar a incobrables?")) return; await updateDoc(doc(db,"loans",id),{status:"charged_off",updatedAt:serverTimestamp()}); loadActive(); loadInactive(); }
    if(act==="finish"){ if(!confirm("¿Marcar como pagado total?")) return; await updateDoc(doc(db,"loans",id),{status:"finished",updatedAt:serverTimestamp(), paidCount:Number(card.dataset.nl||0)}); loadActive(); loadInactive(); }
    if(act==="view"){
      const ref = await getDoc(doc(db,"loans",id)); const l=ref.data();
      card.dataset.nl = l.months; // total
      renderLoanScheduleAdmin(id,l, card.querySelector('[data-sched]'));
    }
    if(act==="pay"){ // marcar una cuota más como pagada
      const ref = await getDoc(doc(db,"loans",id)); const l=ref.data();
      const cur = Number(l.paidCount||0)+1;
      await updateDoc(doc(db,"loans",id),{paidCount:cur, updatedAt:serverTimestamp()});
      renderLoanScheduleAdmin(id,{...l,paidCount:cur}, card.querySelector('[data-sched]'));
      loadActive();
    }
  });
}

/* schedule admin con botón MARCAR PAGADA y progreso X/Y, sin totales */
function renderLoanScheduleAdmin(id,l, host){
  const cta = cuota(l.amount,l.tna,l.months);
  const rows = Array.from({length:l.months},(_,i)=>{
    const n=i+1; const due=dueDate(n,l.dueDay||GLOBAL.dueDay);
    const paid = Number(l.paidCount||0)>=n;
    const btn = paid ? '<span class="chip" style="background:#e6fcf5;color:#087f5b">Pagada</span>'
                     : `<button class="btn btn-gray" data-act="pay">Marcar pagada</button>`;
    return `<tr>
      <td>${n}</td><td>${fmtDate(due)}</td><td>${money(cta)}</td><td>${btn}</td>
    </tr>`;
  }).join("");
  host.style.display='block';
  host.innerHTML = `
    <div class="row" style="margin:6px 0"><span class="chip" style="background:#edf2ff;color:#364fc7">Progreso: <b>${progress(l)}</b></span></div>
    <div class="scroll-x">
      <table class="table">
        <thead><tr><th>#</th><th>Vencimiento</th><th>Cuota</th><th>Estado</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
  // habilitar/deshabilitar “Pagado total”
  const canFinish = Number(l.paidCount||0) >= Number(l.months||0);
  const btnFinish = host.parentElement.querySelector('[data-act="finish"]');
  if(btnFinish){
    if(canFinish){ btnFinish.removeAttribute('disabled'); btnFinish.style.opacity='1'; btnFinish.style.cursor='pointer'; }
    else { btnFinish.setAttribute('disabled',''); btnFinish.style.opacity='.5'; btnFinish.style.cursor='not-allowed'; }
  }
}

/* ---------- My loan (by DNI) ---------- */
$("#btnMyLoan").onclick = async ()=>{
  const dni = prompt("Ingresá tu DNI para consultar tu préstamo:");
  if(!dni) return;
  const snap = await getDocs(query(collection(db,"loans"), orderBy("createdAt","desc"), limit(80)));
  const found = [];
  snap.forEach(d=>{ const l=d.data(); if((l.borrower?.dni||'')===dni) found.push({id:d.id, ...l}); });
  if(!found.length) return toast("No encontramos préstamos para ese DNI.");
  const l = found[0];
  const summary = `Estado: ${l.status}\nMonto: ${money(l.amount)}\nCuotas: ${l.months}\nTNA ${l.tna}%${l.contractId?`\nContrato: ${l.contractId}`:''}`;
  alert(summary);
  const modal = document.createElement('div');
  renderSchedule(l, modal);
  $("#cardSim").appendChild(modal);
};

/* ---------- boot ---------- */
await loadSettings(); await loadAdmins();
</script>
</body>
</html>